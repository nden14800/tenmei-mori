<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>運勢・天命乃杜 | 本格・今日の運勢</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- フォント -->
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500;600;800&family=Zen+Old+Mincho:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root {
            /* ライトモード変数 */
            --bg-pattern: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4d4d4' fill-opacity='0.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            --bg-color: #fdfbf7;
            --text-main: #2b2b2b;
            --text-sub: #555555;
            --card-bg: #ffffff;
            --card-border: #e6e6e6;
            --accent-red: #b91c1c;
            --accent-gold: #c5a059;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.3);
            --sidebar-bg: rgba(255, 255, 255, 0.95);
            --input-bg: #ffffff;
            --omi-paper: #fffcf2; 
            --sidebar-width: 80px;
            --sidebar-width-expanded: 240px;
        }

        /* ダークモード変数 (自動検知) */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-pattern: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23444444' fill-opacity='0.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
                --bg-color: #1a1a1a;
                --text-main: #e0e0e0;
                --text-sub: #b0b0b0;
                --card-bg: #2c2c2c;
                --card-border: #444444;
                --accent-red: #ff6b6b;
                --accent-gold: #e5c07b;
                --glass-bg: rgba(30, 30, 30, 0.9);
                --glass-border: rgba(255, 255, 255, 0.1);
                --sidebar-bg: rgba(30, 30, 30, 0.95);
                --input-bg: #333333;
                --omi-paper: #fffcf2; 
            }
        }

        body {
            font-family: 'Zen Old Mincho', 'Shippori Mincho', serif;
            background-color: var(--bg-color);
            background-image: var(--bg-pattern);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- 汎用テーマクラス --- */
        .themed-card {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-main);
        }
        .themed-text-sub { color: var(--text-sub); }
        .themed-input {
            background-color: var(--input-bg);
            color: var(--text-main);
            border: 1px solid var(--card-border);
        }

        /* --- サイドバー --- */
        #sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--glass-border);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 100;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding-top: 20px;
            overflow: hidden;
        }
        #sidebar:hover {
            width: var(--sidebar-width-expanded);
        }
        .nav-btn {
            width: 100%;
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--text-main);
            background: none;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
            text-decoration: none;
            height: 60px;
        }
        .nav-btn:hover {
            background-color: rgba(128,128,128,0.1);
        }
        .nav-btn i {
            font-size: 1.5rem;
            min-width: 40px;
            text-align: center;
        }
        .nav-text {
            opacity: 0;
            transform: translateX(-10px);
            transition: all 0.3s;
            font-weight: bold;
            font-family: 'Zen Old Mincho', serif;
            margin-left: 10px;
        }
        #sidebar:hover .nav-text {
            opacity: 1;
            transform: translateX(0);
        }

        /* --- メインコンテンツ --- */
        #main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
            width: calc(100% - var(--sidebar-width));
            transition: margin-left 0.3s;
        }

        /* --- 共通コンポーネント --- */
        .btn-primary {
            background-color: var(--accent-red);
            color: white;
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .btn-primary:disabled {
            background-color: #999;
            cursor: not-allowed;
            transform: none;
        }

        /* --- ローディングスピナー --- */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); /* 少し暗く */
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--accent-red); /* 回転部分だけ色付け */
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- ホーム画面 --- */
        .home-circle-container {
            width: 300px;
            height: 300px;
            border: 2px solid var(--accent-red);
            border-radius: 50%;
            margin: 20px auto;
            position: relative;
            overflow: hidden;
            background: rgba(128,128,128,0.1);
        }
        .flying-paper {
            position: absolute;
            width: 30px;
            height: 60px;
            background: var(--omi-paper);
            border: 1px solid #ccc;
            opacity: 0;
            animation: paperFly 4s infinite linear;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            writing-mode: vertical-rl;
            color: #b91c1c;
        }
        @keyframes paperFly {
            0% { transform: translateY(350px) rotate(0deg); opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translateY(-50px) rotate(360deg); opacity: 0; }
        }

        /* --- おみくじ選択画面 --- */
        .omikuji-pool {
            position: relative;
            width: 100%;
            min-height: 100vh;
            overflow-y: visible;
            perspective: 1000px;
            padding-bottom: 200px;
        }
        .omikuji-stick {
            position: absolute;
            width: 50px;
            height: 140px;
            background-color: var(--omi-paper);
            border: 1px solid #ccc;
            box-shadow: 3px 3px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
            font-family: 'Zen Old Mincho', serif;
            writing-mode: vertical-rl;
            color: var(--accent-red);
            user-select: none;
            border-radius: 4px;
        }
        .omikuji-stick:hover {
            transform: scale(1.15) !important;
            z-index: 50;
            box-shadow: 0 15px 30px rgba(0,0,0,0.4);
            background-color: #fff;
        }
        @keyframes slideInRandom {
            from { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            to { opacity: 1; }
        }

        /* --- カウントダウン --- */
        #countdown-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 999;
            display: none;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 8rem;
            font-family: 'Zen Old Mincho', serif;
        }

        /* --- おみくじ結果カード --- */
        #result-capture-container {
            width: 600px;
            margin: 0 auto;
            position: relative;
        }
        /* 新デザイン：Omikuji-do風 */
        .result-card-outer {
            width: 600px;
            min-height: 1100px;
            background-color: #b91c1c; /* ベースの赤 */
            padding: 40px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            color: white;
        }
        .result-title-name {
            font-family: 'Zen Old Mincho', serif;
            font-size: 1.5rem;
            margin-bottom: 5px;
            letter-spacing: 0.1em;
            text-align: center;
        }
        .result-subtitle {
            font-family: sans-serif;
            font-size: 0.7rem;
            letter-spacing: 0.2em;
            opacity: 0.8;
            margin-bottom: 30px;
            text-align: center;
        }

        .result-card-paper {
            width: 100%;
            /* 白い紙部分 */
            background-color: #fffcf2; 
            border: 4px double #b91c1c;
            padding: 40px 30px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Shippori Mincho', serif;
            color: #b91c1c;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* 大吉：金でザラザラ */
        .is-daikichi .result-card-outer {
            background-color: #b91c1c; 
        }
        .is-daikichi .result-card-paper {
            background-color: #d4af37;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.3'/%3E%3C/svg%3E");
            color: #b91c1c;
            border-color: #b91c1c;
        }
        .is-daikichi .result-circle {
            background-color: #fff !important;
            border: 3px solid #b91c1c !important;
        }

        /* 大凶：黒 */
        .is-daikyo .result-card-outer {
            background-color: #000000;
        }
        .is-daikyo .result-card-paper {
            background-color: #1a1a1a;
            color: #e0e0e0;
            border-color: #555;
        }
        .is-daikyo .result-circle {
            border-color: #fff !important;
            background-color: #000 !important;
            color: #fff !important;
        }
        
        .result-header {
            width: 100%; display: flex; justify-content: center; align-items: center; gap: 10px;
            border-bottom: 1px solid currentColor; padding-bottom: 20px; margin-bottom: 20px;
        }
        .result-shrine-logo { font-size: 2rem; font-weight: 900; display: flex; align-items: center; gap: 8px; }
        .result-num { font-size: 1rem; margin-top: 10px; font-weight: bold; text-align: center; }
        
        .result-circle {
            width: 140px; height: 140px; border-radius: 50%; border: 2px solid currentColor;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin: 20px 0 40px 0; background-color: #fff; color: #b91c1c;
        }
        .result-label { font-size: 0.9rem; margin-bottom: 0px; font-weight: bold; }
        .result-kanji { font-size: 4.5rem; font-weight: 900; line-height: 1; }

        .result-body { display: flex; flex-direction: row-reverse; width: 100%; flex: 1; justify-content: space-between; gap: 30px; }
        
        /* 助言（縦書き詩） */
        .result-poem-box {
            border: 1px solid currentColor;
            padding: 15px 10px;
            writing-mode: vertical-rl;
            text-orientation: upright;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .result-poem-title { font-size: 0.8rem; border-bottom: 1px solid currentColor; padding-bottom: 5px; margin-left: 10px; }
        .result-poem-content { font-size: 1.3rem; font-weight: bold; letter-spacing: 0.2em; line-height: 1.8; }

        .result-details-col { flex: 1; display: flex; flex-direction: column; gap: 8px; justify-content: flex-start; writing-mode: vertical-rl; height: 450px; flex-wrap: wrap; align-content: flex-end; }
        .detail-row { font-size: 0.95rem; margin-left: 10px; padding: 5px 0; border-left: 1px dashed currentColor; padding-left: 5px; height: 100%; max-height: 450px; display: flex; flex-direction: column; }
        .detail-title { font-weight: 900; margin-bottom: 8px; font-size: 0.9rem; color: currentColor; }
        .detail-content { font-weight: 500; }

        .result-qr-box {
            background: #fff;
            padding: 8px;
            border-radius: 4px;
            margin-top: 30px;
            margin-bottom: 10px;
        }
        .result-footer-link { font-size: 0.8rem; margin-top: 5px; font-family: sans-serif; letter-spacing: 0.05em; }
        .result-date {
            margin-top: 20px;
            font-size: 0.9rem;
            border-top: 1px solid currentColor;
            padding-top: 10px;
            width: 100%;
            text-align: right;
        }

        /* シェア画面 */
        #generated-image-container img { max-width: 100%; box-shadow: 0 10px 25px rgba(0,0,0,0.3); border-radius: 8px; }

        /* 記事詳細 */
        .article-container {
            max-width: 800px; margin: 0 auto; padding: 40px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: left; line-height: 2;
        }
        .article-header { border-bottom: 2px solid var(--card-border); padding-bottom: 20px; margin-bottom: 30px; }
        .article-title { font-size: 1.8rem; font-weight: bold; margin-bottom: 10px; }
        .article-meta { color: var(--text-sub); font-size: 0.9rem; display: flex; gap: 15px; }
        .article-tag { background: rgba(128,128,128,0.2); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
        .article-content h3 { font-size: 1.4rem; font-weight: bold; margin: 30px 0 15px; border-left: 4px solid var(--accent-red); padding-left: 10px; }
        .article-content p { margin-bottom: 20px; }

        /* 12星座カード */
        .ranking-card {
            border-radius: 16px; box-shadow: 0 4px 6px var(--shadow); padding: 20px;
            margin-bottom: 20px; transition: transform 0.2s, box-shadow 0.2s; position: relative;
        }
        .ranking-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px var(--shadow); }
        .rank-badge-lg { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.5rem; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); flex-shrink: 0; }
        .rank-1 { background: linear-gradient(135deg, #FFD700, #FDB931); border: 2px solid #fff; }
        .rank-2 { background: linear-gradient(135deg, #E0E0E0, #BDBDBD); }
        .rank-3 { background: linear-gradient(135deg, #CD7F32, #A0522D); }
        .rank-other { background-color: var(--card-border); color: var(--text-sub); font-size: 1.2rem; width: 50px; height: 50px; }
        .param-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--card-border); }
        .param-item { text-align: center; }
        .param-label { font-size: 0.75rem; color: var(--text-main); margin-bottom: 4px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 2px; flex-wrap: wrap; }
        .param-score-text { font-size: 0.9rem; font-weight: 900; color: var(--accent-red); }
        .param-value { font-size: 0.75rem; color: var(--text-sub); margin-bottom: 2px; }
        .score-bar-bg { width: 100%; height: 8px; background-color: var(--card-border); border-radius: 4px; margin-top: 4px; overflow: hidden; }
        .score-bar-fill { height: 100%; border-radius: 4px; }
        .fav-btn {
            position: absolute; top: 15px; right: 15px; background: none; border: none;
            font-size: 1.5rem; color: #ccc; cursor: pointer; transition: color 0.2s, transform 0.2s;
        }
        .fav-btn.active { color: #FFD700; transform: scale(1.1); }
        .fav-btn:hover { transform: scale(1.15); }
        .calendar-wrapper { margin-top: 15px; border-top: 1px dashed var(--card-border); padding-top: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 8px; }
        .calendar-cell { background-color: var(--bg-color); border-radius: 8px; padding: 4px 2px; text-align: center; min-height: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid var(--card-border); }
        .cal-date { font-size: 0.7rem; font-weight: bold; color: var(--text-sub); }
        .cal-mark { font-size: 0.7rem; margin-top: 2px; line-height: 1; }
        .calendar-legend { display: flex; justify-content: center; gap: 10px; margin-top: 8px; font-size: 0.7rem; color: var(--text-sub); flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 2px; }

        /* ビュー制御 */
        .view-section { display: none; opacity: 0; transition: opacity 0.5s; }
        .view-section.active { display: block; opacity: 1; }

        /* おみくじの轍 ぼかし制御 */
        .history-blurred {
            position: relative;
            filter: blur(8px);
            pointer-events: none;
            user-select: none;
            overflow: hidden;
            opacity: 0.7;
        }
        .history-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            text-align: center;
            border: 1px solid var(--card-border);
            width: 80%;
            max-width: 400px;
        }

        /* 詳細モーダル */
        #history-detail-modal, #profile-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000;
            display: none; align-items: center; justify-content: center;
            overflow-y: auto;
        }
        #history-detail-content, #profile-content {
            background: transparent;
            width: 100%; max-width: 600px; margin: 20px;
            position: relative;
        }
        #profile-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
        }

    </style>
</head>
<body>

    <!-- ローディングオーバーレイ -->
    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- サイドバー -->
    <nav id="sidebar">
        <button class="nav-btn" onclick="showView('home')">
            <i class="bi bi-house-door"></i>
            <span class="nav-text">ホーム</span>
        </button>
        <button class="nav-btn" onclick="showView('zodiac')">
            <i class="bi bi-stars"></i>
            <span class="nav-text">12星座・血液型</span>
        </button>
        <button class="nav-btn" onclick="showView('history')">
            <i class="bi bi-clock-history"></i>
            <span class="nav-text">おみくじの轍</span>
        </button>
        <button class="nav-btn" onclick="showView('news')">
            <i class="bi bi-bell"></i>
            <span class="nav-text">社務所だより</span>
        </button>
        <button class="nav-btn" onclick="showView('column')">
            <i class="bi bi-book"></i>
            <span class="nav-text">神籤草子</span>
        </button>
        <button class="nav-btn" onclick="showView('auth')" id="nav-login-btn">
            <i class="bi bi-person-circle"></i>
            <span class="nav-text">ログイン/登録</span>
        </button>
        
        <div style="margin-top: auto; width: 100%;">
            <button class="nav-btn" onclick="showView('about')">
                <i class="bi bi-info-circle"></i>
                <span class="nav-text">当サイトについて</span>
            </button>
            <button class="nav-btn" onclick="showView('privacy')">
                <i class="bi bi-shield-lock"></i>
                <span class="nav-text">プライバシー</span>
            </button>
        </div>
    </nav>

    <!-- メインエリア -->
    <main id="main-content">
        
        <!-- ビュー: ホーム -->
        <section id="view-home" class="view-section active text-center max-w-4xl mx-auto">
            <h1 class="text-4xl font-black mb-2 tracking-widest" style="font-family: 'Zen Old Mincho'">運勢・天命乃杜</h1>
            <p class="text-sm font-serif mb-4 tracking-widest uppercase">FORTUNE TENMEI-NO-MORI</p>
            <p class="text-lg font-serif mb-8 themed-text-sub">天命を知る道標  無料神籤<br>困難を乗り越え福となす</p>

            <div class="home-circle-container" id="home-anim-container">
                <!-- JSで紙を生成 -->
            </div>

            <button onclick="startOmikuji()" class="btn-primary text-xl px-12 py-4 mb-8">
                <i class="bi bi-box-seam-fill"></i> おみくじを引く
            </button>

            <!-- カウンター -->
            <div id="home-counter-area" class="themed-card p-4 rounded-lg mb-2">
                <p class="text-sm themed-text-sub">累計発行本数</p>
                <div class="text-3xl font-bold font-mono text-red-700" id="live-counter">---</div>
                <p class="text-xs themed-text-sub mt-1">最終更新: <span id="counter-time">--:--:--</span> (1秒毎更新)</p>
                <p class="text-[10px] themed-text-sub mt-1">※会員様の祈りの数のみがリアルタイムで反映されます</p>
            </div>

            <!-- ダッシュボード風グリッド -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-12 text-left">
                <!-- 轍 (統計) -->
                <div class="themed-card p-6 rounded-xl shadow-sm">
                    <h3 class="font-bold text-lg mb-2 border-b border-gray-300 dark:border-gray-600 pb-2"><i class="bi bi-balloon-heart text-red-500"></i> おみくじの轍 (統計)</h3>
                    <div class="text-xs text-right mb-2 themed-text-sub">更新: <span id="stats-update-time">--:--:--</span></div>
                    <div class="space-y-3 mb-4 text-sm" id="home-history-stats">
                         <div class="flex justify-between"><span>大吉</span><span><span id="cnt-daikichi" class="mr-2 font-mono">0</span><span id="stat-daikichi">0.00%</span></span></div>
                         <div class="w-full bg-gray-200 dark:bg-gray-600 h-2 rounded"><div id="bar-daikichi" class="bg-yellow-400 h-2 rounded" style="width: 0%"></div></div>
                         
                         <div class="flex justify-between"><span>吉</span><span><span id="cnt-kichi" class="mr-2 font-mono">0</span><span id="stat-kichi">0.00%</span></span></div>
                         <div class="w-full bg-gray-200 dark:bg-gray-600 h-2 rounded"><div id="bar-kichi" class="bg-red-400 h-2 rounded" style="width: 0%"></div></div>

                         <div class="flex justify-between"><span>中吉</span><span><span id="cnt-chukichi" class="mr-2 font-mono">0</span><span id="stat-chukichi">0.00%</span></span></div>
                         <div class="w-full bg-gray-200 dark:bg-gray-600 h-2 rounded"><div id="bar-chukichi" class="bg-orange-400 h-2 rounded" style="width: 0%"></div></div>

                         <div class="flex justify-between"><span>小吉</span><span><span id="cnt-shokichi" class="mr-2 font-mono">0</span><span id="stat-shokichi">0.00%</span></span></div>
                         <div class="w-full bg-gray-200 dark:bg-gray-600 h-2 rounded"><div id="bar-shokichi" class="bg-green-400 h-2 rounded" style="width: 0%"></div></div>
                         
                         <div class="flex justify-between"><span>末吉</span><span><span id="cnt-suekichi" class="mr-2 font-mono">0</span><span id="stat-suekichi">0.00%</span></span></div>
                         <div class="w-full bg-gray-200 dark:bg-gray-600 h-2 rounded"><div id="bar-suekichi" class="bg-blue-400 h-2 rounded" style="width: 0%"></div></div>

                         <div class="flex justify-between"><span>凶</span><span><span id="cnt-kyo" class="mr-2 font-mono">0</span><span id="stat-kyo">0.00%</span></span></div>
                         <div class="w-full bg-gray-200 dark:bg-gray-600 h-2 rounded"><div id="bar-kyo" class="bg-gray-400 h-2 rounded" style="width: 0%"></div></div>

                         <div class="flex justify-between"><span>大凶</span><span><span id="cnt-daikyo" class="mr-2 font-mono">0</span><span id="stat-daikyo">0.00%</span></span></div>
                         <div class="w-full bg-gray-200 dark:bg-gray-600 h-2 rounded"><div id="bar-daikyo" class="bg-black h-2 rounded" style="width: 0%"></div></div>
                    </div>
                    <button onclick="showView('history')" class="text-sm text-red-600 hover:underline">おみくじの轍をもっと見る</button>
                </div>

                <!-- お知らせ (最大5件) -->
                <div class="themed-card p-6 rounded-xl shadow-sm">
                    <h3 class="font-bold text-lg mb-2 border-b border-gray-300 dark:border-gray-600 pb-2"><i class="bi bi-megaphone text-blue-500"></i> 社務所だより</h3>
                    <ul class="text-sm space-y-2 mb-4">
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('news', 2)"><span class="truncate">「運勢・天命乃杜」を公開いたしました。</span><span class="themed-text-sub">2026/1/2</span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('news', 1)"><span class="truncate">あけましておめでとうごさいます</span><span class="themed-text-sub">2026/1/1</span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('news', 3)"><span class="truncate">プレオープンのお知らせ</span><span class="themed-text-sub">2025/12/25</span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('news', 4)"><span class="truncate">サーバーメンテナンス完了</span><span class="themed-text-sub">2025/12/20</span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('news', 5)"><span class="truncate">サイト開設準備室より</span><span class="themed-text-sub">2025/12/10</span></li>
                    </ul>
                    <button onclick="showView('news')" class="text-sm text-blue-600 hover:underline">社務所だよりをもっと見る</button>
                </div>

                <!-- コラム (最大5件リスト化) -->
                <div class="themed-card p-6 rounded-xl shadow-sm">
                    <h3 class="font-bold text-lg mb-2 border-b border-gray-300 dark:border-gray-600 pb-2"><i class="bi bi-book text-green-500"></i> 神籤草子 (コラム)</h3>
                    <ul class="text-sm space-y-2 mb-4">
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('column', 1)"><span class="truncate">おみくじの順番（正しい吉凶の順）</span><span class="themed-text-sub"><i class="bi bi-journal-text"></i></span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('column', 2)"><span class="truncate">悪い結果が出ても実は大丈夫？</span><span class="themed-text-sub"><i class="bi bi-journal-text"></i></span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('column', 3)"><span class="truncate">神社での正しい参拝マナー</span><span class="themed-text-sub"><i class="bi bi-journal-text"></i></span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('column', 4)"><span class="truncate">「失せ物」の本当の意味</span><span class="themed-text-sub"><i class="bi bi-journal-text"></i></span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('column', 5)"><span class="truncate">「待ち人」は恋愛だけじゃない</span><span class="themed-text-sub"><i class="bi bi-journal-text"></i></span></li>
                    </ul>
                    <button onclick="showView('column')" class="text-sm text-green-600 hover:underline">神籤草子をもっと見る</button>
                </div>
            </div>
        </section>

        <!-- ビュー: おみくじ選択 -->
        <section id="view-draw" class="view-section relative min-h-screen w-full overflow-hidden" style="overflow-y: auto !important;">
            <h2 class="text-center text-2xl font-bold mb-4 z-10 relative mt-10">直感で一枚お選びください</h2>
            <div id="omikuji-pool" class="omikuji-pool">
                <!-- JSで大量の札をランダム配置 -->
            </div>
            <div class="fixed bottom-10 left-0 w-full text-center z-50 pointer-events-none">
                <button onclick="addOmikuji()" class="btn-primary pointer-events-auto shadow-xl">
                    <i class="bi bi-plus-lg"></i> もっとおみくじを探す
                </button>
            </div>
        </section>

        <!-- ビュー: おみくじ結果 -->
        <section id="view-result" class="view-section text-center">
            <div id="result-display-area" class="py-10">
                
                <div style="display: flex; justify-content: center; overflow: hidden;">
                    <div id="result-capture-container">
                        <div class="result-card-outer" id="result-card-outer">
                            <div class="result-title-name" id="result-title-name"></div>
                            <div class="result-subtitle">KNOTTING THE FORTUNE</div>
                            
                            <div class="result-card-paper" id="result-card-paper">
                                <!-- ヘッダー -->
                                <div class="result-header">
                                    <div class="result-shrine-logo">
                                        <i class="bi bi-moon-stars-fill"></i> 天命乃杜
                                    </div>
                                    <div class="result-num" id="result-num">第123456番</div>
                                </div>

                                <!-- 結果の円 -->
                                <div class="result-circle">
                                    <div class="result-label">運勢</div>
                                    <div class="result-kanji" id="result-kanji">大吉</div>
                                </div>

                                <!-- 本文 -->
                                <div class="result-body">
                                    <!-- 詩 (右) -->
                                    <div class="result-poem-box">
                                        <div class="result-poem-content" id="result-poem"></div>
                                        <div class="result-poem-title">助言</div>
                                    </div>
                                    <!-- 詳細 (左) -->
                                    <div class="result-details-col" id="result-details">
                                        <!-- JSで挿入 -->
                                    </div>
                                </div>

                                <!-- フッター (QR) -->
                                <div class="result-qr-box">
                                    <div id="qrcode"></div>
                                </div>
                                <div class="result-footer-link">fortune-telling-at-tenmei-no-mori.pages.dev</div>
                                <div class="result-date" id="result-date">2026/01/01 12:00</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- アクションボタンエリア -->
                <div class="max-w-xl mx-auto mt-8 p-4 themed-card rounded-lg shadow space-y-4">
                    <p class="font-bold">結果をシェアする</p>
                    
                    <div id="gen-img-status" class="text-sm themed-text-sub"></div>
                    <div id="generated-image-container" class="hidden">
                        <p class="text-green-600 font-bold mb-2">画像の生成完了</p>
                        <!-- 生成画像がここに入る -->
                    </div>

                    <div class="flex flex-col gap-3 mt-4">
                        <button onclick="shareToX()" class="bg-black text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:opacity-80">
                            <i class="bi bi-twitter-x"></i> Xでシェア (手動で保存して添付)
                        </button>
                        <button onclick="shareToFB()" class="bg-blue-600 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:opacity-80">
                            <i class="bi bi-facebook"></i> Facebookでシェア
                        </button>
                        <button onclick="shareToLine()" class="bg-green-500 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:opacity-80">
                            <i class="bi bi-line"></i> LINEでシェア
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ビュー: 12星座占い -->
        <section id="view-zodiac" class="view-section">
             <div class="text-center mb-8">
                <h2 class="text-2xl font-bold mb-2 flex items-center justify-center gap-2">
                    <i class="bi bi-trophy-fill text-yellow-500"></i> 最強運勢ランキング
                </h2>
                <p class="text-lg font-serif" id="current-date-display"></p>
            </div>
    
            <!-- お気に入りセクション -->
            <div id="favorites-section" class="hidden w-full mb-8 max-w-3xl mx-auto">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i class="bi bi-star-fill text-yellow-400"></i> お気に入り (最大5件)
                    <span id="fav-status-badge" class="text-xs ml-2 px-2 py-1 rounded bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                        <!-- 保存先ステータス -->
                    </span>
                </h3>
                <div id="favorites-list" class="space-y-4">
                    <!-- お気に入りカード -->
                </div>
                <hr class="my-6 border-gray-300 dark:border-gray-600">
            </div>
    
            <div class="themed-card backdrop-blur-sm p-6 rounded-xl shadow-sm border mb-8 max-w-xl mx-auto">
                <h3 class="font-bold text-lg mb-4 text-center">あなたの順位をチェック</h3>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <select id="user-sign" class="p-2 border rounded-md themed-input">
                        <option value="aries">牡羊座 (3/21-4/19)</option>
                        <option value="taurus">牡牛座 (4/20-5/20)</option>
                        <option value="gemini">双子座 (5/21-6/21)</option>
                        <option value="cancer">蟹座 (6/22-7/22)</option>
                        <option value="leo">獅子座 (7/23-8/22)</option>
                        <option value="virgo">乙女座 (8/23-9/22)</option>
                        <option value="libra">天秤座 (9/23-10/23)</option>
                        <option value="scorpio">蠍座 (10/24-11/22)</option>
                        <option value="sagittarius">射手座 (11/23-12/21)</option>
                        <option value="capricorn">山羊座 (12/22-1/19)</option>
                        <option value="aquarius">水瓶座 (1/20-2/18)</option>
                        <option value="pisces">魚座 (2/19-3/20)</option>
                    </select>
                    <select id="user-blood" class="p-2 border rounded-md themed-input">
                        <option value="A">A型</option>
                        <option value="B">B型</option>
                        <option value="O">O型</option>
                        <option value="AB">AB型</option>
                    </select>
                    <button onclick="findMyRank()" class="btn-primary text-sm py-2 px-6">
                        <i class="bi bi-search"></i> 判定
                    </button>
                </div>
                <div id="my-rank-result" class="mt-6 hidden pt-4 border-t border-gray-300 dark:border-gray-600"></div>
            </div>
    
            <div id="ranking-list" class="space-y-4 max-w-3xl mx-auto"></div>
            
            <div class="text-center mt-6 mb-10">
                <button onclick="showFullRanking()" class="text-sm underline hover:opacity-80 flex items-center justify-center gap-1 mx-auto themed-text-sub">
                    <i class="bi bi-list-ol"></i> <span id="show-ranking-text">4位以下を見る</span>
                </button>
            </div>
            <div id="full-ranking-list" class="space-y-4 mt-4 hidden max-w-3xl mx-auto"></div>
        </section>

        <!-- ビュー: ログイン/登録 -->
        <section id="view-auth" class="view-section max-w-md mx-auto themed-card p-8 rounded-xl shadow-lg mt-10">
            <h2 class="text-2xl font-bold mb-6 text-center">アカウント認証</h2>
            
            <!-- タブ切り替え -->
            <div class="flex justify-center mb-6 border-b">
                <button class="px-4 py-2 border-b-2 border-red-500 font-bold" id="tab-login" onclick="toggleAuthTab('login')">ログイン</button>
                <button class="px-4 py-2 border-b-2 border-transparent text-gray-500" id="tab-register" onclick="toggleAuthTab('register')">新規登録</button>
            </div>

            <!-- ログインフォーム -->
            <div id="form-login">
                <label class="block mb-2 font-bold text-sm">メールアドレス</label>
                <input type="email" id="login-email" placeholder="example@email.com" class="w-full p-3 border rounded mb-4 themed-input">
                <label class="block mb-2 font-bold text-sm">パスワード</label>
                <input type="password" id="login-password" placeholder="********" class="w-full p-3 border rounded mb-4 themed-input">
                <label class="block mb-2 font-bold text-sm">認証コード (6桁)</label>
                <input type="text" id="login-code" placeholder="123456" class="w-full p-3 border rounded mb-4 themed-input">
                <button onclick="performLogin()" class="btn-primary w-full justify-center">ログイン</button>
            </div>

            <!-- 登録フォーム -->
            <div id="form-register" class="hidden">
                <label class="block mb-2 font-bold text-sm">ユーザー名</label>
                <input type="text" id="reg-username" placeholder="天命 太郎" class="w-full p-3 border rounded mb-4 themed-input">
                <label class="block mb-2 font-bold text-sm">メールアドレス</label>
                <input type="email" id="reg-email" placeholder="example@email.com" class="w-full p-3 border rounded mb-4 themed-input">
                <label class="block mb-2 font-bold text-sm">パスワード</label>
                <input type="password" id="reg-password" placeholder="********" class="w-full p-3 border rounded mb-4 themed-input">
                <label class="block mb-2 font-bold text-sm">認証コード (6桁)</label>
                <input type="text" id="reg-code" placeholder="123456" class="w-full p-3 border rounded mb-4 themed-input">
                <button onclick="performRegister()" class="btn-primary w-full justify-center">登録</button>
            </div>

            <div class="mt-4 text-center">
                <button onclick="sendAuthCode()" class="text-xs text-blue-500 underline font-bold px-4 py-2 hover:text-blue-700">
                    <i class="bi bi-send"></i> 認証コードを送信する
                </button>
            </div>

            <div id="auth-user-info" class="hidden text-center mt-6">
                <div class="mb-4">
                    <p class="text-lg">ようこそ、<span id="user-display-name" class="font-bold cursor-pointer hover:underline" onclick="openProfileModal()"></span> 様</p>
                    <button onclick="openProfileModal()" class="text-sm bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded mt-2"><i class="bi bi-gear-fill"></i> プロフィール設定</button>
                </div>
                <button onclick="logout()" class="text-red-500 underline text-sm">ログアウト</button>
            </div>
        </section>

        <!-- ビュー: おみくじの轍 (履歴) -->
        <section id="view-history" class="view-section max-w-4xl mx-auto relative">
            <h2 class="text-3xl font-bold mb-6 text-center text-red-800 dark:text-red-400">おみくじの轍</h2>
            
            <div class="text-center mb-6">
                <p class="text-sm themed-text-sub">ログインすると、ご自身の軌跡と、杜を訪れた参拝者様の軌跡を閲覧できます。</p>
            </div>

            <!-- 履歴コンテナ (ぼかし対象) -->
            <div id="history-container" class="">
                <div class="themed-card p-6 rounded shadow mb-6">
                    <div class="flex justify-between items-center border-b border-gray-300 dark:border-gray-600 pb-2 mb-4">
                        <h3 class="font-bold">軌跡一覧</h3>
                        <div class="text-xs text-gray-500" id="history-view-mode"></div>
                    </div>
                    <div id="history-summary" class="flex gap-4 mb-4 text-sm hidden">
                        <div class="bg-red-50 dark:bg-red-900/20 p-2 rounded flex-1 text-center border border-red-200">
                            <div class="font-bold text-red-700 dark:text-red-400">あなたの結び</div>
                            <div class="font-mono text-xl" id="my-history-count">0</div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded flex-1 text-center border border-gray-200">
                            <div class="font-bold text-gray-700 dark:text-gray-400">みんなの結び</div>
                            <div class="font-mono text-xl" id="global-history-count">0</div>
                        </div>
                    </div>
                    <div id="history-list" class="space-y-3">
                        <!-- JSで挿入 -->
                    </div>
                </div>
            </div>

            <!-- 非ログイン時のオーバーレイ -->
            <div id="history-login-overlay" class="history-overlay hidden">
                <i class="bi bi-lock-fill text-4xl text-gray-400 mb-4 block"></i>
                <p class="text-lg font-bold mb-2">轍を見るには会員証が必要です</p>
                <p class="text-sm themed-text-sub mb-4">ログインすると、過去の結果を振り返ることができます。</p>
                <button onclick="showView('auth')" class="btn-primary">ログイン / 登録</button>
            </div>
        </section>

        <!-- ビュー: 社務所だより -->
        <section id="view-news" class="view-section max-w-3xl mx-auto">
            <h2 class="text-2xl font-bold mb-6">社務所だより</h2>
            <div class="space-y-4">
                <article class="themed-card p-4 rounded shadow border-l-4 border-blue-500 cursor-pointer hover:opacity-80 transition" onclick="openArticle('news', 2)">
                    <div class="text-sm themed-text-sub">2026年1月2日 16:00</div>
                    <h3 class="font-bold text-lg">「運勢・天命乃杜」を公開いたしました。</h3>
                    <p class="text-sm mt-2 truncate themed-text-sub">本サービスを正式にリリースいたしました。</p>
                </article>
                <article class="themed-card p-4 rounded shadow border-l-4 border-gray-500 cursor-pointer hover:opacity-80 transition" onclick="openArticle('news', 1)">
                    <div class="text-sm themed-text-sub">2026年1月1日 0:00</div>
                    <h3 class="font-bold text-lg">あけましておめでとうごさいます</h3>
                    <p class="text-sm mt-2 truncate themed-text-sub">謹んで新年のご祝詞を申し上げます。</p>
                </article>
                <article class="themed-card p-4 rounded shadow border-l-4 border-gray-400 cursor-pointer hover:opacity-80 transition" onclick="openArticle('news', 3)">
                    <div class="text-sm themed-text-sub">2025年12月25日 10:00</div>
                    <h3 class="font-bold text-lg">プレオープンのお知らせ</h3>
                    <p class="text-sm mt-2 truncate themed-text-sub">一部機能を先行公開いたしました。</p>
                </article>
                <article class="themed-card p-4 rounded shadow border-l-4 border-green-500 cursor-pointer hover:opacity-80 transition" onclick="openArticle('news', 4)">
                    <div class="text-sm themed-text-sub">2025年12月20日 18:00</div>
                    <h3 class="font-bold text-lg">サーバーメンテナンス完了</h3>
                    <p class="text-sm mt-2 truncate themed-text-sub">予定されていたメンテナンスは無事終了しました。</p>
                </article>
                <article class="themed-card p-4 rounded shadow border-l-4 border-gray-400 cursor-pointer hover:opacity-80 transition" onclick="openArticle('news', 5)">
                    <div class="text-sm themed-text-sub">2025年12月10日 12:00</div>
                    <h3 class="font-bold text-lg">サイト開設準備室より</h3>
                    <p class="text-sm mt-2 truncate themed-text-sub">現在、正式公開に向けて最終調整を行っております。</p>
                </article>
            </div>
        </section>

        <!-- ビュー: 神籤草子 -->
        <section id="view-column" class="view-section max-w-3xl mx-auto">
            <h2 class="text-2xl font-bold mb-6">神籤草子</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <article class="themed-card rounded overflow-hidden shadow cursor-pointer hover:shadow-lg transition" onclick="openArticle('column', 1)">
                    <div class="h-32 bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-800 dark:text-green-200 font-bold">
                        <i class="bi bi-list-ol text-3xl"></i>
                    </div>
                    <div class="p-4">
                        <div class="text-xs themed-text-sub mb-1">
                            <span class="bg-gray-200 dark:bg-zinc-700 px-2 py-0.5 rounded text-[10px] mr-2">雑学</span>2026/01/01
                        </div>
                        <h3 class="font-bold">おみくじの順番（正しい吉凶の順）</h3>
                    </div>
                </article>
                <article class="themed-card rounded overflow-hidden shadow cursor-pointer hover:shadow-lg transition" onclick="openArticle('column', 2)">
                    <div class="h-32 bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-800 dark:text-green-200 font-bold">
                        <i class="bi bi-cloud-sun text-3xl"></i>
                    </div>
                    <div class="p-4">
                        <div class="text-xs themed-text-sub mb-1">
                             <span class="bg-gray-200 dark:bg-zinc-700 px-2 py-0.5 rounded text-[10px] mr-2">豆知識</span>2026/01/01
                        </div>
                        <h3 class="font-bold">悪い結果が出ても実は大丈夫？</h3>
                    </div>
                </article>
                <article class="themed-card rounded overflow-hidden shadow cursor-pointer hover:shadow-lg transition" onclick="openArticle('column', 3)">
                    <div class="h-32 bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-800 dark:text-green-200 font-bold">
                        <i class="bi bi-person-praying text-3xl"></i>
                    </div>
                    <div class="p-4">
                        <div class="text-xs themed-text-sub mb-1">
                             <span class="bg-gray-200 dark:bg-zinc-700 px-2 py-0.5 rounded text-[10px] mr-2">作法</span>2025/12/30
                        </div>
                        <h3 class="font-bold">神社での正しい参拝マナー</h3>
                    </div>
                </article>
                <article class="themed-card rounded overflow-hidden shadow cursor-pointer hover:shadow-lg transition" onclick="openArticle('column', 4)">
                    <div class="h-32 bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-800 dark:text-green-200 font-bold">
                        <i class="bi bi-search text-3xl"></i>
                    </div>
                    <div class="p-4">
                        <div class="text-xs themed-text-sub mb-1">
                             <span class="bg-gray-200 dark:bg-zinc-700 px-2 py-0.5 rounded text-[10px] mr-2">豆知識</span>2025/12/28
                        </div>
                        <h3 class="font-bold">「失せ物」の本当の意味</h3>
                    </div>
                </article>
                <article class="themed-card rounded overflow-hidden shadow cursor-pointer hover:shadow-lg transition" onclick="openArticle('column', 5)">
                    <div class="h-32 bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-800 dark:text-green-200 font-bold">
                        <i class="bi bi-heart text-3xl"></i>
                    </div>
                    <div class="p-4">
                        <div class="text-xs themed-text-sub mb-1">
                             <span class="bg-gray-200 dark:bg-zinc-700 px-2 py-0.5 rounded text-[10px] mr-2">開運</span>2025/12/25
                        </div>
                        <h3 class="font-bold">「待ち人」は恋愛だけじゃない</h3>
                    </div>
                </article>
            </div>
        </section>

        <!-- ビュー: 記事詳細 -->
        <section id="view-article-detail" class="view-section">
            <div class="max-w-3xl mx-auto mb-4">
                <button onclick="backToArticleList()" class="text-sm themed-text-sub hover:text-red-500 flex items-center gap-1">
                    <i class="bi bi-arrow-left"></i> 一覧に戻る
                </button>
            </div>
            <div id="article-detail-content" class="article-container themed-card">
                <!-- JSでコンテンツ挿入 -->
            </div>
        </section>

        <!-- ビュー: 当サイトについて・詳細 (超長文版) -->
        <section id="view-about" class="view-section max-w-4xl mx-auto themed-card p-10 rounded shadow-lg text-justify leading-loose">
            <h2 class="text-3xl font-bold mb-8 text-center border-b border-gray-300 dark:border-gray-600 pb-4">当サイトについて・利用規約・詳細解説</h2>
            <div class="text-right text-sm themed-text-sub mb-8">
                最終改定日: 2026年1月2日<br>
                運営: 天命乃杜運営事務局
            </div>

            <h3 class="text-xl font-bold mt-8 mb-4 border-l-4 border-red-500 pl-3">第1章 はじめに：当サイトの理念と目的</h3>
            <p class="mb-4">
                ようこそ、「運勢・天命乃杜（てんめいのもり）」（以下、「当サイト」といいます）へお越しくださいました。当サイトは、古来より日本に伝わる神道の伝統的な「おみくじ」の精神性と、西洋占星術および血液型性格診断という統計学的な要素を融合させ、現代を生きる人々の迷いや不安を少しでも和らげ、日々の生活における指針や活力の源となることを目的として開設された、デジタルプラットフォーム上の仮想社殿です。
            </p>
            <p class="mb-4">
                我々は、インターネットという広大な情報の海において、心の平穏と自己省察の機会を提供する「鎮守の杜」のような存在でありたいと願っています。忙しない日常の中で、ふと立ち止まり、天命に耳を傾ける時間を持つこと。それが、より豊かな人生への第一歩であると信じているからです。利用者の皆様には、以下の詳細な規約と解説を熟読し、十分に理解・同意された上で、当サイトの各機能をご利用いただけますようお願い申し上げます。
            </p>
            <p class="mb-4">
                本サービスを利用することによって、利用者は本規約に全面的に同意したものとみなされます。もし本規約に同意されない場合は、直ちに本サービスの利用を中止してください。当サイトは、利用者に事前の通知なく、本規約を変更する権利を留保します。変更後の規約は、当サイト上に掲示された時点から効力を生じるものとし、利用者が変更後に本サービスを利用し続けた場合、変更後の規約に同意したものとみなされます。
            </p>

            <h3 class="text-xl font-bold mt-8 mb-4 border-l-4 border-red-500 pl-3">第2章 おみくじ機能の仕様とアルゴリズムの透明性</h3>
            <p class="mb-4">
                当サイトで提供する「おみくじ」機能は、完全なランダム性を保証するために高度な乱数生成アルゴリズム（暗号論的擬似乱数生成器に準ずるロジック）を使用しています。おみくじを引く際のアニメーション演出では、画面上に散らばる多数の神籤札の中から、利用者が直感に基づいて一枚を選択するプロセスを採用しています。ユーザーが札をクリックした瞬間、サーバーサイド（またはクライアントサイドのセキュアなロジック）において即座に抽選が行われ、結果が確定します。これにより、作為的な操作が介入する余地を排除し、純粋な運勢診断を提供しています。
            </p>
            <p class="mb-4">
                おみくじの結果には、「大吉」「吉」「中吉」「小吉」「末吉」「凶」「大凶」などの等級が含まれます。当サイトでは特に「大吉」の場合には金色を基調とした特別なテクスチャデザインを、「大凶」の場合には黒色を基調とした厳粛なデザインを表示する仕様となっております。これは単なる視覚効果にとどまらず、利用者の心理状態に働きかけ、大吉であれば高揚感を、大凶であれば身を引き締める緊張感を与えることを意図しています。さらに、当サイト独自の12段階評価（大吉から大凶まで）を採用しており、一般的なおみくじよりも詳細な運勢判断が可能となっております。
            </p>
            <p class="mb-4">
                なお、当サイトの占いは科学的根拠に基づくものではなく、あくまでエンターテインメントおよび精神的な示唆を提供するものです。結果がいかなるものであれ、それによって生じた現実の損害や利益について、当サイトは一切の責任を負いません。占いの結果をどのように受け止め、どのように行動するかは、すべて利用者ご自身の判断に委ねられています。神託とは、それを受け取る者の心の在り方によって、その意味を大きく変えるものなのです。
            </p>

            <h3 class="text-xl font-bold mt-8 mb-4 border-l-4 border-red-500 pl-3">第3章 アカウント認証・セキュリティ・会員特典</h3>
            <p class="mb-4">
                当サイトでは、ユーザーの利便性とセキュリティを両立させるため、メールアドレス、パスワード、およびユーザー名を用いた認証システムを導入しています。新規登録時には、真正性を確認するための認証コード（OTP）がメールアドレス宛に送信されます。これにより、なりすまし登録や不正アクセスを未然に防ぐ体制を整えています。
            </p>
            <p class="mb-4">
                会員登録を行い、ログインした状態で本サービスを利用することで、以下の特別な機能（会員特典）を享受することができます。
                <br>1. **おみくじの轍（履歴）の完全閲覧権:** ご自身の過去の履歴に加え、他の参拝者様が引いたおみくじの結果（匿名化されたデータ）を「おみくじの轍」として閲覧することが可能になります。これにより、世の中の運気の流れを感じ取ることができます。
                <br>2. **詳細結果の再確認:** 履歴リストから過去の結果をクリックすることで、おみくじを引いた直後の詳細な結果画面（和歌や各項目の助言）をいつでも再表示・アニメーション再生することができます。
                <br>3. **累計発行本数への貢献:** ログインユーザーがおみくじを引いた場合のみ、サイトトップに表示される「累計発行本数」のカウンターがインクリメント（加算）されます。これは、会員様の祈りが「杜」の歴史の一部として刻まれることを意味します。
                <br>4. **クラウド同期:** お気に入り設定や履歴データがサーバー上に保存されるため、スマートフォンやPCなど、異なるデバイスからアクセスしても常に同じ環境でご利用いただけます。
            </p>
            <p class="mb-4">
                非ログイン状態（ゲストユーザー）の場合、これらの機能は制限されます。履歴は表示されず（ぼかし表示）、カウンターの数値にも影響を与えません。また、データはブラウザの「localStorage」に一時保存されるのみであり、キャッシュクリア等により消失する可能性があります。恒久的なデータの保存を希望される場合は、会員登録を強く推奨いたします。
            </p>

            <h3 class="text-xl font-bold mt-8 mb-4 border-l-4 border-red-500 pl-3">第4章 コンテンツの著作権とシェア機能</h3>
            <p class="mb-4">
                当サイトに掲載されている全てのコンテンツ（文章、画像、プログラムコード、デザイン、ロゴマーク、アルゴリズム等）の著作権は、運営者または正当な権利を有する第三者に帰属します。これらは、日本の著作権法、国際条約、およびその他の知的財産権に関する法律によって保護されています。私的な利用の範囲を超えて、これらを無断で複製、転載、改変、再配布、公衆送信することは法律で固く禁じられており、違反した場合は民事上の損害賠償請求や刑事罰の対象となる可能性があります。
            </p>
            <p class="mb-4">
                ただし、当サイトが提供する「シェア機能」を通じて生成されたおみくじ結果画像に関しては、利用者が個人のソーシャルメディア（SNS）等で共有する目的に限り、自由にご利用いただけます。この画像には当サイトのURLやQRコードが含まれており、これらを削除・隠蔽せずにそのままの状態で共有していただくことが利用の条件となります。公序良俗に反する投稿や、当サイトの名誉を毀損するような文脈での利用は禁止します。
            </p>

            <h3 class="text-xl font-bold mt-8 mb-4 border-l-4 border-red-500 pl-3">第5章 免責事項</h3>
            <p class="mb-4">
                当サイトは、本サービスの提供において万全を期しておりますが、その完全性、正確性、確実性、有用性等についてはいかなる保証も行いません。システム障害、通信回線の不具合、サーバーのダウン、第三者による不正アクセス、天災地変等により本サービスの提供が中断・遅延・停止した結果、利用者に生じたいかなる損害についても、当サイトは一切の責任を負わないものとします。また、当サイトからリンクされている外部サイトの内容やサービスについても、当サイトは関知せず、一切の責任を負いません。利用者は、自己の責任において本サービスを利用するものとします。
            </p>
        </section>

        <!-- ビュー: プライバシーポリシー (超長文版) -->
        <section id="view-privacy" class="view-section max-w-4xl mx-auto themed-card p-10 rounded shadow-lg text-justify leading-loose">
            <h2 class="text-3xl font-bold mb-6 text-center">プライバシーポリシー</h2>
            <p class="mb-4">
                運勢・天命乃杜運営事務局（以下「当事務局」といいます。）は、本ウェブサイト上で提供するサービス（以下、「本サービス」といいます。）における、ユーザーの個人情報の取扱いについて、以下のとおりプライバシーポリシー（以下、「本ポリシー」といいます。）を定めます。本ポリシーは、ユーザーが本サービスを利用する際に適用され、当事務局は個人情報の重要性を深く認識し、その保護の徹底を図るため、個人情報の保護に関する法律（平成15年法律第57号。以下「個人情報保護法」といいます。）等の関係法令を遵守するとともに、以下のプライバシーポリシーに従って厳重に管理いたします。
            </p>

            <h4 class="font-bold mt-4 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第1条（個人情報の定義）</h4>
            <p class="mb-4">
                本ポリシーにおいて、「個人情報」とは、個人情報保護法第2条第1項に規定される「個人情報」を指すものとします。具体的には、生存する個人に関する情報であって、当該情報に含まれる氏名、生年月日、住所、電話番号、連絡先、その他の記述等により特定の個人を識別できる情報（個人識別情報）、および容貌、指紋、声紋にかかるデータ、健康保険証の保険者番号などの当該情報単体から特定の個人を識別できる情報（個人識別符号）を指します。本サービスにおいては、ユーザー登録時に入力いただくメールアドレス、ユーザー名、パスワード（暗号化されたハッシュ値）などがこれに該当します。
            </p>

            <h4 class="font-bold mt-4 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第2条（個人情報の収集方法）</h4>
            <p class="mb-4">
                当事務局は、ユーザーが利用登録をする際に、氏名（ユーザー名）、メールアドレス、パスワード等の個人情報をお尋ねすることがあります。また、ユーザーと提携先などとの間でなされたユーザーの個人情報を含む取引記録や決済に関する情報を、当事務局の提携先（情報提供元、広告主、広告配信先などを含みます。以下、｢提携先｣といいます。）などから収集することがあります。
                <br>さらに、ユーザーが本サービスを利用するにあたり、端末情報、ログ情報、Cookie（クッキー）、IPアドレス、位置情報などのインフォマティブデータを自動的に取得する場合があります。これらは、サービスの品質向上、不正利用の防止、およびユーザーごとに最適化されたコンテンツを提供するために利用されます。
            </p>

            <h4 class="font-bold mt-4 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第3条（個人情報を収集・利用する目的）</h4>
            <p class="mb-4">当事務局が個人情報を収集・利用する目的は、以下のとおりです。</p>
            <ul class="list-disc pl-5 mb-4 space-y-2">
                <li>本サービスの提供・運営のため（認証コードの送信、ログイン状態の維持、ユーザー設定の保存など）</li>
                <li>ユーザーからのお問い合わせに回答するため（本人確認を行うことを含む）</li>
                <li>ユーザーが利用中のサービスの新機能、更新情報、キャンペーン等及び当事務局が提供する他のサービスの案内のメールを送付するため</li>
                <li>メンテナンス、重要なお知らせなど必要に応じたご連絡のため</li>
                <li>利用規約に違反したユーザーや、不正・不当な目的でサービスを利用しようとするユーザーの特定をし、ご利用をお断りするため</li>
                <li>ユーザーにご自身の登録情報の閲覧や変更、削除、ご利用状況の閲覧を行っていただくため</li>
                <li>有料サービスにおいて、ユーザーに利用料金を請求するため（将来的な実装を含む）</li>
                <li>上記の利用目的に付随する目的</li>
            </ul>

            <h4 class="font-bold mt-4 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第4条（利用目的の変更）</h4>
            <p class="mb-4">
                当事務局は、利用目的が変更前と関連性を有すると合理的に認められる場合に限り、個人情報の利用目的を変更するものとします。利用目的の変更を行った場合には、変更後の目的について、当事務局所定の方法により、ユーザーに通知し、または本ウェブサイト上に公表するものとします。変更後のプライバシーポリシーは、本ウェブサイトに掲載したときから効力を生じるものとします。
            </p>

            <h4 class="font-bold mt-4 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第5条（個人情報の第三者提供）</h4>
            <p class="mb-4">
                当事務局は、次に掲げる場合を除いて、あらかじめユーザーの同意を得ることなく、第三者に個人情報を提供することはありません。ただし、個人情報保護法その他の法令で認められる場合を除きます。
                <br>1. 人の生命、身体または財産の保護のために必要がある場合であって、本人の同意を得ることが困難であるとき
                <br>2. 公衆衛生の向上または児童の健全な育成の推進のために特に必要がある場合であって、本人の同意を得ることが困難であるとき
                <br>3. 国の機関もしくは地方公共団体またはその委託を受けた者が法令の定める事務を遂行することに対して協力する必要がある場合であって、本人の同意を得ることにより当該事務の遂行に支障を及ぼすおそれがあるとき
                <br>4. 予め次の事項を告知あるいは公表し、かつ当事務局が個人情報保護委員会に届出をしたとき
                <br>   (1) 利用目的に第三者への提供を含むこと
                <br>   (2) 第三者に提供されるデータの項目
                <br>   (3) 第三者への提供の手段または方法
                <br>   (4) 本人の求めに応じて個人情報の第三者への提供を停止すること
                <br>   (5) 本人の求めを受け付ける方法
            </p>

            <h4 class="font-bold mt-4 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第6条（個人情報の開示・訂正・削除）</h4>
            <p class="mb-4">
                当事務局は、本人から個人情報の開示を求められたときは、本人に対し、遅滞なくこれを開示します。ただし、開示することにより次のいずれかに該当する場合は、その全部または一部を開示しないこともあり、開示しない決定をした場合には、その旨を遅滞なく通知します。
                <br>1. 本人または第三者の生命、身体、財産その他の権利利益を害するおそれがある場合
                <br>2. 当事務局の業務の適正な実施に著しい支障を及ぼすおそれがある場合
                <br>3. その他法令に違反することとなる場合
                <br>ユーザーは、当事務局の保有する自己の個人情報が誤った情報である場合には、当事務局が定める手続きにより、当事務局に対して個人情報の訂正、追加または削除（以下、「訂正等」といいます。）を請求することができます。当事務局は、ユーザーから前項の請求を受けてその請求に応じる必要があると判断した場合には、遅滞なく、当該個人情報の訂正等を行うものとします。
            </p>

            <h4 class="font-bold mt-4 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第7条（お問い合わせ窓口）</h4>
            <p class="mb-4">
                本ポリシーに関するお問い合わせは、当サイトのお問い合わせフォーム、または運営者までご連絡ください。当事務局は、個人情報の取扱いに関する苦情や相談に対し、適切かつ迅速に対応するよう努めます。
            </p>
        </section>

    </main>

    <!-- カウントダウンオーバーレイ -->
    <div id="countdown-overlay">
        <div id="countdown-number">3</div>
    </div>

    <!-- 詳細モーダル (おみくじの轍用) -->
    <div id="history-detail-modal" onclick="closeHistoryDetail(event)">
        <div id="history-detail-content" onclick="event.stopPropagation()">
            <!-- ここに結果カードを複製表示 -->
        </div>
        <button onclick="closeHistoryDetail(null)" class="fixed top-5 right-5 text-white text-4xl hover:text-gray-300 z-[2100]">
            <i class="bi bi-x-circle"></i>
        </button>
    </div>

    <!-- プロフィール設定モーダル -->
    <div id="profile-modal" onclick="closeProfileModal(event)">
        <div id="profile-content" onclick="event.stopPropagation()">
            <h2 class="text-xl font-bold mb-4">プロフィール設定</h2>
            
            <div class="mb-6">
                <h3 class="font-bold text-sm mb-2 border-b pb-1">ユーザー名変更</h3>
                <input type="text" id="update-username" placeholder="新しいユーザー名" class="w-full p-2 border rounded mb-2 themed-input">
                <button onclick="updateProfile('username')" class="btn-primary py-1 px-4 text-sm w-full">変更</button>
            </div>

            <div class="mb-6">
                <h3 class="font-bold text-sm mb-2 border-b pb-1">パスワード変更</h3>
                <input type="password" id="update-pass-old" placeholder="現在のパスワード" class="w-full p-2 border rounded mb-2 themed-input">
                <input type="password" id="update-pass-new" placeholder="新しいパスワード" class="w-full p-2 border rounded mb-2 themed-input">
                <button onclick="updateProfile('password')" class="btn-primary py-1 px-4 text-sm w-full">変更</button>
            </div>

            <div class="mt-8 border-t pt-4">
                <button onclick="deleteAccount()" class="text-red-500 text-xs underline hover:text-red-700">アカウントを削除する</button>
                <p class="text-[10px] text-gray-500 mt-1">※削除後も同じメールアドレスで再登録可能です。</p>
            </div>
        </div>
        <button onclick="closeProfileModal(null)" class="fixed top-5 right-5 text-white text-4xl hover:text-gray-300 z-[2100]">
            <i class="bi bi-x-circle"></i>
        </button>
    </div>

    <!-- JavaScript ロジック -->
    <script>
        // ==========================================
        //  設定: Cloudflare WorkerのURL (修正済み)
        // ==========================================
        const API_BASE = "https://aaaaa.nden14800.workers.dev";
        
        // サイトのベースURL
        const SITE_URL = "https://fortune-telling-at-tenmei-no-mori-authentic-today-s-fortun.pages.dev";

        // --- 状態管理 ---
        let currentState = {
            view: 'home',
            user: null, // { email, username, token }
            lastResult: null,
            liveCount: 0,
            prevArticleView: null // 記事詳細からの戻り先
        };

        let favoriteList = [];
        let dailyRanking = [];
        let globalHistory = []; 

        // --- イニシャライズ ---
        window.onload = function() {
            showLoading(true);
            initHomeAnimation();
            initZodiacSystem();
            
            const storedUser = localStorage.getItem('omikuji_user');
            if(storedUser) {
                try {
                    currentState.user = JSON.parse(storedUser);
                } catch(e) {
                    console.error("Auth Data Parse Error", e);
                }
            }
            updateAuthUI();

            // 統計とカウンター取得
            fetchCount();
            fetchHistoryStats();
            setInterval(fetchHistoryStats, 5000); 
            setInterval(fetchCount, 5000);
            
            // お気に入りの読み込み
            loadFavorites();
            showLoading(false);
        };

        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if(show) {
                overlay.style.display = 'flex';
            } else {
                overlay.style.display = 'none';
            }
        }

        function showView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
                setTimeout(() => {
                    if(!el.classList.contains('active')) el.style.display = 'none';
                }, 500);
            });
            
            const target = document.getElementById(`view-${viewId}`);
            target.style.display = 'block';
            void target.offsetWidth; 
            target.classList.add('active');
            
            // 記事詳細の戻り先管理
            if (viewId === 'news' || viewId === 'column') {
                currentState.prevArticleView = viewId;
            }
            currentState.view = viewId;

            if(viewId === 'draw') {
                resetOmikujiPool();
            }
            if(viewId === 'history') {
                loadHistory();
            }
        }

        function backToArticleList() {
            if (currentState.prevArticleView) {
                showView(currentState.prevArticleView);
            } else {
                showView('home');
            }
        }

        // --- ホームアニメーション ---
        function initHomeAnimation() {
            const container = document.getElementById('home-anim-container');
            const paperCount = 20;
            for(let i=0; i<paperCount; i++) {
                const paper = document.createElement('div');
                paper.className = 'flying-paper';
                paper.style.left = Math.random() * 260 + 'px';
                paper.style.animationDelay = Math.random() * 4 + 's';
                paper.style.animationDuration = (3 + Math.random() * 3) + 's';
                paper.textContent = "天命乃杜";
                container.appendChild(paper);
            }
        }

        // --- ライブカウンター (API連携) ---
        async function fetchCount() {
            try {
                const res = await fetch(`${API_BASE}/api/counter`);
                if(res.ok) {
                    const data = await res.json();
                    // ログインしてない場合は表示だけ、してれば値はAPI由来
                    currentState.liveCount = data.count || 0;
                    document.getElementById('live-counter').textContent = currentState.liveCount.toLocaleString() + "本";
                    
                    const now = new Date();
                    document.getElementById('counter-time').textContent = now.toLocaleTimeString();
                }
            } catch(e) {
                console.error("Counter fetch error", e);
            }
        }

        function startOmikuji() {
            showView('draw');
        }

        // --- 統計情報の取得と表示 (API連携) ---
        async function fetchHistoryStats() {
            try {
                const res = await fetch(`${API_BASE}/api/stats`);
                if(res.ok) {
                    const data = await res.json();
                    document.getElementById('stats-update-time').textContent = data.timestamp || "--:--:--";

                    const setBar = (id, percent, count) => {
                        const p = parseFloat(percent).toFixed(2);
                        document.getElementById(`stat-${id}`).textContent = p + "%";
                        document.getElementById(`cnt-${id}`).textContent = (count || 0).toLocaleString() + "本";
                        document.getElementById(`bar-${id}`).style.width = p + "%";
                    };

                    const stats = data.stats || {};
                    const counts = data.counts || {};
                    
                    setBar('daikichi', stats.daikichi, counts.daikichi);
                    setBar('kichi', stats.kichi, counts.kichi);
                    setBar('chukichi', stats.chukichi, counts.chukichi);
                    setBar('shokichi', stats.shokichi, counts.shokichi);
                    setBar('suekichi', stats.suekichi, counts.suekichi);
                    setBar('kyo', stats.kyo, counts.kyo);
                    setBar('daikyo', stats.daikyo, counts.daikyo);
                }
            } catch(e) {
                console.error("Stats fetch error", e);
            }
        }

        // --- おみくじロジック ---
        function resetOmikujiPool() {
            const pool = document.getElementById('omikuji-pool');
            pool.innerHTML = '';
            addOmikujiBatch(100, true); 
        }

        function addOmikuji() {
            addOmikujiBatch(50, false);
            const section = document.getElementById('view-draw');
            section.scrollBy({ top: 400, behavior: 'smooth' });
        }

        function addOmikujiBatch(count, isInitial) {
            const pool = document.getElementById('omikuji-pool');
            let lastBottom = 0;
            if (!isInitial && pool.childElementCount > 0) {
                lastBottom = pool.childElementCount * 25; 
            }

            for(let i=0; i<count; i++) {
                const stick = document.createElement('div');
                stick.className = 'omikuji-stick shadow-md rounded';
                stick.textContent = `天命乃杜`; 
                
                const left = Math.random() * 90 + 5; 
                let top;
                if (isInitial) {
                    top = (i * 20) + (Math.random() * 100); 
                } else {
                    top = lastBottom + (i * 20) + (Math.random() * 100);
                }
                const rot = Math.random() * 360;
                
                stick.style.left = `calc(${left}% - 25px)`;
                stick.style.top = `${top}px`;
                stick.style.transform = `rotate(${rot}deg)`;
                stick.style.animation = `slideInRandom 0.5s ease forwards ${Math.random() * 0.3}s`;
                
                stick.onclick = function() {
                    drawResult(this);
                };
                
                pool.appendChild(stick);
            }
        }

        // 12段階の順位に対応したデータ (おみくじ堂準拠)
        const omikujiResults = [
            { type: "大吉", poem: "枯れ果てし 枝に再び 花咲くが如し", desc: "最高の運気です。長年の努力が報われ、枯れ木に花が咲くような喜びが訪れるでしょう。しかし慢心は禁物。感謝の心を忘れずに。", rankCode: 'daikichi' },
            { type: "中吉", poem: "照る月を 雲が隠せど 風払うなり", desc: "一時的な迷いがあっても、すぐに晴れ間が見えます。自分の信念を貫くことで、雲を払う風のような助けが現れるはずです。", rankCode: 'chukichi' },
            { type: "小吉", poem: "小川の水 淀まず流るる 様を見るべし", desc: "派手さはありませんが、平穏無事な日々が続きます。日々の小さな幸せを大切にし、流れに身を任せるのが吉です。", rankCode: 'shokichi' },
            { type: "吉", poem: "春風に 池の氷も 解け初めて", desc: "厳しい冬が終わり、徐々に運気が上昇しています。焦らず着実に進めば、池の氷が解けるように悩みも消えていくでしょう。", rankCode: 'kichi' },
            { type: "半吉", poem: "山道の 行き交う人も なかりけり", desc: "孤独を感じるかもしれませんが、それは自分自身と向き合うための大切な時間です。静寂の中に答えがあります。", rankCode: 'kichi' }, 
            { type: "末吉", poem: "山道の 険しき坂も 一歩より", desc: "今は登り坂で苦しい時かもしれませんが、一歩一歩進めば必ず頂上に辿り着けます。忍耐力が試される時です。", rankCode: 'suekichi' },
            { type: "末小吉", poem: "岸打つ波の 音も静かに", desc: "嵐の前の静けさではなく、凪の状態です。今は大きな行動を起こさず、力を蓄える時期と心得ましょう。", rankCode: 'suekichi' },
            { type: "凶", poem: "雨雲の 晴れ間も見えず 濡れ衣かな", desc: "誤解を受けやすく、思うようにいかない時期です。今は弁解せず、静かに嵐が過ぎるのを待つのが賢明な判断です。", rankCode: 'kyo' },
            { type: "小凶", poem: "古き家 柱も朽ちて 危うきかな", desc: "基盤が揺らいでいます。新しいことを始めるよりも、足元を固め、基本的な生活習慣を見直すことが重要です。", rankCode: 'kyo' },
            { type: "半凶", poem: "深き霧 道を見失う 心地せり", desc: "先が見えず不安になりますが、無理に進もうとすれば怪我をします。霧が晴れるまで、その場で待つのも勇気です。", rankCode: 'kyo' },
            { type: "末凶", poem: "枯葉散る 秋の夕暮れ 寂しきかな", desc: "終わりは始まりの合図でもあります。何かを手放すことで、新しい運気が入ってくるスペースができるでしょう。", rankCode: 'kyo' },
            { type: "大凶", poem: "嵐吹く 荒野に一人 立つが如し", desc: "八方塞がりの厳しい運勢。無理に動くと災いを招きます。身を潜め、自分を見つめ直す修行の時と心得てください。", rankCode: 'daikyo' }
        ];

        function drawResult(element) {
            const overlay = document.getElementById('countdown-overlay');
            const numEl = document.getElementById('countdown-number');
            overlay.style.display = 'flex';
            
            let count = 3;
            numEl.textContent = count;
            
            const timer = setInterval(() => {
                count--;
                if(count > 0) {
                    numEl.textContent = count;
                } else {
                    clearInterval(timer);
                    overlay.style.display = 'none';
                    showResultDetail(true); // true = 新規ドロー
                }
            }, 1000);
        }

        async function showResultDetail(isNewDraw, dataOverride = null) {
            showLoading(true);
            let resultData;
            let randNum;
            let detailsList = []; 
            let drawDateStr;

            if (isNewDraw) {
                // 新規抽選
                resultData = omikujiResults[Math.floor(Math.random() * omikujiResults.length)];
                randNum = Math.floor(Math.random() * 100) + 1;
                
                const cats = ['願望','待人','失物','旅行','商売','学問','恋愛','転居','病気'];
                const vals = ['叶う','来る','出る','吉','良','励め','実る','良し','治る','遅れる','来ず','出難い','控','耐','危','悪'];
                
                detailsList = cats.map(c => ({
                    title: c,
                    content: vals[Math.floor(Math.random() * vals.length)]
                }));
                
                const now = new Date();
                drawDateStr = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;

                currentState.lastResult = { 
                    ...resultData, 
                    num: randNum, 
                    timestamp: now.getTime(), 
                    detail: detailsList,
                    dateStr: drawDateStr
                };

                // ログインしている場合のみAPIへ送信
                if(currentState.user) {
                    try {
                        const res = await fetch(`${API_BASE}/api/draw`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                email: currentState.user.email,
                                token: currentState.user.token,
                                result: resultData.type,
                                poem: resultData.poem,
                                detail: detailsList 
                            })
                        });
                        
                        if(res.ok) {
                            const data = await res.json();
                            if(data.success && data.count) {
                                currentState.liveCount = data.count; // カウンター更新
                                fetchHistoryStats();
                            }
                        }
                    } catch(e) {
                        console.error("Draw API Error", e);
                    }
                }

            } else {
                // 履歴からの表示
                resultData = dataOverride;
                randNum = dataOverride.num || 1;
                detailsList = dataOverride.detail || [];
                const d = new Date(dataOverride.timestamp || Date.now());
                drawDateStr = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
            }

            // DOM更新 (カードに情報を流し込む)
            renderResultToCard('result-card-outer', resultData, randNum, detailsList, drawDateStr);

            showLoading(false);
            showView('result');
            
            if (isNewDraw) {
                setTimeout(generateResultImage, 1000);
            }
        }

        function renderResultToCard(outerId, resultData, randNum, detailsList, dateStr) {
            const outer = document.getElementById(outerId);
            const numText = outer.querySelector('#result-num');
            const kanji = outer.querySelector('#result-kanji');
            const poem = outer.querySelector('#result-poem');
            const details = outer.querySelector('#result-details');
            const qrBox = outer.querySelector('#qrcode');
            const dateEl = outer.querySelector('#result-date');
            const titleName = outer.querySelector('#result-title-name');

            // ユーザー名表示
            const name = currentState.user ? currentState.user.username : "あなた";
            titleName.textContent = `${name}さんのおみくじの結果`;

            // クラスリセット
            outer.className = 'result-card-outer';
            if(resultData.type === '大吉') outer.classList.add('is-daikichi');
            else if (resultData.type === '大凶') outer.classList.add('is-daikyo');

            numText.textContent = `第${randNum}番`;
            kanji.textContent = resultData.type;
            poem.textContent = resultData.poem;
            dateEl.textContent = dateStr;
            
            // 詳細項目
            details.innerHTML = '';
            if(detailsList && detailsList.length > 0) {
                detailsList.forEach(item => {
                    const row = document.createElement('div');
                    row.className = 'detail-row';
                    row.innerHTML = `<span class="detail-title">${item.title}</span><span class="detail-content">${item.content}</span>`;
                    details.appendChild(row);
                });
            }

            // QRコード生成
            qrBox.innerHTML = '';
            new QRCode(qrBox, {
                text: SITE_URL,
                width: 100,
                height: 100,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        // --- 履歴・おみくじの轍 ---
        async function loadHistory() {
            showLoading(true);
            const list = document.getElementById('history-list');
            const container = document.getElementById('history-container');
            const overlay = document.getElementById('history-login-overlay');
            const viewMode = document.getElementById('history-view-mode');
            const summary = document.getElementById('history-summary');

            list.innerHTML = '';

            if(!currentState.user) {
                // 非ログイン時
                container.classList.add('history-blurred');
                overlay.classList.remove('hidden');
                viewMode.textContent = "";
                summary.classList.add('hidden');

                // ダミー表示
                let html = '';
                for(let i=0; i<10; i++) {
                    html += `
                        <div class="bg-gray-50 dark:bg-zinc-800 p-3 rounded flex justify-between items-center border-l-4 border-gray-300">
                            <div class="flex flex-col">
                                <span class="text-xs themed-text-sub">??? 様</span>
                                <span class="text-xs text-gray-400">2026/01/02 --:--</span>
                            </div>
                            <span class="font-bold text-lg">???</span>
                        </div>
                    `;
                }
                list.innerHTML = html;
                showLoading(false);
                return;
            }

            // ログイン時
            container.classList.remove('history-blurred');
            overlay.classList.add('hidden');
            viewMode.textContent = "全参拝者の軌跡を表示中";
            summary.classList.remove('hidden');
            
            try {
                const res = await fetch(`${API_BASE}/api/history/global?token=${encodeURIComponent(currentState.user.token)}`);
                if(res.ok) {
                    const data = await res.json();
                    globalHistory = data.history || [];
                    
                    // 件数集計
                    const myCount = globalHistory.filter(h => h.username === currentState.user.username).length;
                    document.getElementById('my-history-count').textContent = myCount;
                    document.getElementById('global-history-count').textContent = globalHistory.length;

                    list.innerHTML = '';
                    if(globalHistory.length === 0) {
                        list.innerHTML = '<p class="text-gray-400 text-center">まだ履歴がありません。</p>';
                        showLoading(false);
                        return;
                    }

                    globalHistory.forEach((item, index) => {
                        const div = document.createElement('div');
                        const isMe = item.username === currentState.user.username;
                        const borderColor = item.result.includes('凶') ? 'border-gray-500' : 'border-red-500';
                        const bgClass = isMe ? 'bg-red-50 dark:bg-red-900/20' : 'bg-gray-50 dark:bg-zinc-800';

                        div.className = `${bgClass} p-3 rounded flex justify-between items-center border-l-4 ${borderColor} cursor-pointer hover:opacity-80 transition shadow-sm`;
                        // 履歴クリックで詳細再現
                        div.onclick = () => openHistoryDetail(index); 

                        const date = new Date(item.timestamp);
                        const dateStr = `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                        
                        div.innerHTML = `
                            <div class="flex flex-col">
                                <span class="text-xs font-bold ${isMe ? 'text-red-600' : 'themed-text-sub'}">${item.username} 様</span>
                                <span class="text-xs text-gray-400">${dateStr}</span>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="text-xs text-gray-500 hidden sm:inline truncate max-w-[150px]">${item.poem}</span>
                                <span class="font-bold text-red-700 dark:text-red-400 text-lg w-16 text-right">${item.result}</span>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                } else {
                    list.innerHTML = '<p class="text-center text-red-500">履歴の取得に失敗しました。</p>';
                }
            } catch(e) {
                console.error(e);
                list.innerHTML = '<p class="text-center text-red-500">通信エラーが発生しました。</p>';
            }
            showLoading(false);
        }

        // --- 履歴詳細モーダル ---
        function openHistoryDetail(index) {
            const data = globalHistory[index];
            const modal = document.getElementById('history-detail-modal');
            const content = document.getElementById('history-detail-content');
            
            // データ再現 (引いた当時の情報を復元、なければ補完)
            const restoreData = {
                type: data.result,
                poem: data.poem,
                detail: data.detail || [], 
                num: Math.floor(Math.random() * 100) + 1 
            };
            const d = new Date(data.timestamp);
            const dateStr = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;

            // モーダル内にカードHTMLを複製
            content.innerHTML = `
                <div class="result-card-outer mx-auto scale-90 origin-top" id="history-modal-card">
                    <div class="result-title-name" id="hist-title-name"></div>
                    <div class="result-subtitle">KNOTTING THE FORTUNE</div>
                    <div class="result-card-paper">
                        <div class="result-header">
                            <div class="result-shrine-logo"><i class="bi bi-moon-stars-fill"></i> 天命乃杜</div>
                            <div class="result-num" id="hist-num"></div>
                        </div>
                        <div class="result-circle">
                            <div class="result-label">運勢</div>
                            <div class="result-kanji" id="hist-kanji"></div>
                        </div>
                        <div class="result-body">
                            <div class="result-poem-box">
                                <div class="result-poem-content" id="hist-poem"></div>
                                <div class="result-poem-title">助言</div>
                            </div>
                            <div class="result-details-col" id="hist-details"></div>
                        </div>
                        <div class="result-qr-box"><div id="hist-qrcode"></div></div>
                        <div class="result-footer-link">fortune-telling-at-tenmei-no-mori.pages.dev</div>
                        <div class="result-date" id="hist-date"></div>
                    </div>
                </div>
            `;
            
            // IDを付け替えてレンダリング関数を呼ぶのは面倒なので、要素を直接操作
            const card = document.getElementById('history-modal-card');
            
            // スタイル適用
            card.className = 'result-card-outer mx-auto scale-90 origin-top';
            if(restoreData.type === '大吉') card.classList.add('is-daikichi');
            else if(restoreData.type === '大凶') card.classList.add('is-daikyo');

            card.querySelector('#hist-title-name').textContent = `${data.username || '匿名'}さんのおみくじの結果`;
            card.querySelector('#hist-num').textContent = `第${restoreData.num}番`;
            card.querySelector('#hist-kanji').textContent = restoreData.type;
            card.querySelector('#hist-poem').textContent = restoreData.poem;
            card.querySelector('#hist-date').textContent = dateStr;

            const details = card.querySelector('#hist-details');
            details.innerHTML = '';
            if(restoreData.detail && restoreData.detail.length > 0) {
                restoreData.detail.forEach(item => {
                    const row = document.createElement('div');
                    row.className = 'detail-row';
                    row.innerHTML = `<span class="detail-title">${item.title}</span><span class="detail-content">${item.content}</span>`;
                    details.appendChild(row);
                });
            }

            const qrBox = card.querySelector('#hist-qrcode');
            qrBox.innerHTML = '';
            new QRCode(qrBox, {
                text: SITE_URL,
                width: 100, height: 100, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H
            });
            
            modal.style.display = 'flex';
        }

        function closeHistoryDetail(e) {
            if(e && e.target.id !== 'history-detail-modal' && e.target.tagName !== 'BUTTON') return;
            document.getElementById('history-detail-modal').style.display = 'none';
        }

        // --- プロフィール関連 ---
        function openProfileModal() {
            document.getElementById('profile-modal').style.display = 'flex';
        }
        function closeProfileModal(e) {
            if(e && e.target.id !== 'profile-modal' && e.target.tagName !== 'BUTTON') return;
            document.getElementById('profile-modal').style.display = 'none';
        }

        async function updateProfile(type) {
            if(!currentState.user) return;
            showLoading(true);
            
            let body = { email: currentState.user.email, token: currentState.user.token, type: type };
            
            if(type === 'username') {
                const newName = document.getElementById('update-username').value;
                if(!newName) return alert('新しいユーザー名を入力してください');
                body.username = newName;
            } else if (type === 'password') {
                const oldPass = document.getElementById('update-pass-old').value;
                const newPass = document.getElementById('update-pass-new').value;
                if(!oldPass || !newPass) return alert('パスワードを入力してください');
                body.oldPassword = oldPass;
                body.newPassword = newPass;
            }

            try {
                // エンドポイントは仮定 (実装時はBackendも対応が必要)
                const res = await fetch(`${API_BASE}/api/auth/update`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                if(res.ok && data.success) {
                    alert('変更しました');
                    if(type === 'username') {
                        currentState.user.username = body.username;
                        localStorage.setItem('omikuji_user', JSON.stringify(currentState.user));
                        updateAuthUI();
                    }
                    closeProfileModal(null);
                } else {
                    alert('変更に失敗しました: ' + (data.message || '不明なエラー'));
                }
            } catch(e) {
                alert('通信エラー');
            }
            showLoading(false);
        }

        async function deleteAccount() {
            if(!confirm('本当にアカウントを削除しますか？\n（同じメールアドレスでの再登録は可能です）')) return;
            showLoading(true);
            try {
                const res = await fetch(`${API_BASE}/api/auth/delete`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email: currentState.user.email, token: currentState.user.token })
                });
                if(res.ok) {
                    alert('アカウントを削除しました。');
                    logout();
                } else {
                    alert('削除に失敗しました。');
                }
            } catch(e) {
                alert('通信エラー');
            }
            showLoading(false);
        }

        // --- シェア用画像生成 ---
        function generateResultImage() {
            const status = document.getElementById('gen-img-status');
            status.textContent = "シェア画像を生成中...";
            
            const target = document.getElementById('result-capture-container');
            const container = document.getElementById('generated-image-container');
            container.classList.add('hidden');
            container.innerHTML = '<p class="text-green-600 font-bold mb-2">画像の生成完了</p>';
            
            html2canvas(target, { 
                scale: 2, 
                useCORS: true, 
                backgroundColor: null,
                allowTaint: true
            }).then(canvas => {
                status.textContent = "";
                
                const img = document.createElement('img');
                img.src = canvas.toDataURL("image/png");
                img.className = "mx-auto rounded border";
                container.appendChild(img);
                container.classList.remove('hidden');

                const dlLink = document.createElement('a');
                dlLink.href = img.src;
                dlLink.download = `omikuji_result_${Date.now()}.png`;
                dlLink.className = "btn-primary text-sm mt-4 inline-block";
                dlLink.innerHTML = '<i class="bi bi-download"></i> 画像を長押し等で保存';
                container.appendChild(dlLink);
            }).catch(err => {
                console.error(err);
                status.textContent = "画像の生成に失敗しました";
            });
        }

        // --- シェアアクション (パラメータ付きURL) ---
        function shareToX() {
            if(!currentState.lastResult) return;
            const res = currentState.lastResult;
            let advice = "いまは我慢の時。";
            if(res.type === "大吉") advice = "最高の運気です。";
            if(res.type === "凶") advice = "今は耐える時です。";
            
            // 結果をURLパラメータに含める（簡易実装）
            // 実際にはサーバーサイドでOGP生成が必要だが、ここではURLのみ生成
            const shareUrl = `${SITE_URL}?result=${encodeURIComponent(res.type)}`;
            
            const text = `おみくじの結果は・・・「${res.type}」${res.type.includes('吉') ? '✨' : '😱'}\n\n【助言】\n${advice}\n\n（続きはWebで）\n ${shareUrl} #天命乃杜 #おみくじ #運勢診断`;
            const intent = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
            window.open(intent, '_blank');
        }
        function shareToFB() {
            const intent = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(SITE_URL)}`;
            window.open(intent, '_blank');
        }
        function shareToLine() {
            if(!currentState.lastResult) return;
            const text = `おみくじの結果：「${currentState.lastResult.type}」\n${currentState.lastResult.poem} ${SITE_URL}`;
            const intent = `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(SITE_URL)}&text=${encodeURIComponent(text)}`;
            window.open(intent, '_blank');
        }

        // --- 記事コンテンツ ---
        function openArticle(type, id) {
            const container = document.getElementById('article-detail-content');
            container.innerHTML = '';
            
            let html = '';
            
            if (type === 'column') {
                if (id === 1) {
                    html = `
                        <div class="article-header">
                            <div class="article-meta">
                                <span class="article-tag">雑学</span>
                                <span>2026/01/01</span>
                            </div>
                            <h2 class="article-title">おみくじの順番（正しい吉凶の順）</h2>
                        </div>
                        <div class="article-content">
                            <p>初詣や神社参拝の際に引く「おみくじ」。結果に一喜一憂するのも楽しみの一つですが、その「順位」について正しく理解している人は意外と少ないかもしれません。</p>
                            <p>実は神社やお寺によって解釈が異なるのですが、当サイト「運勢・天命乃杜」では、古来からの伝統に基づいた以下の12段階を採用しています。</p>
                            <h3>当サイトの吉凶順位</h3>
                            <ol class="list-decimal list-inside space-y-2 ml-4 mb-6 font-bold">
                                <li>大吉 (だいきち)</li>
                                <li>中吉 (ちゅうきち)</li>
                                <li>小吉 (しょうきち)</li>
                                <li>吉 (きち)</li>
                                <li>半吉 (はんきち)</li>
                                <li>末吉 (すえきち)</li>
                                <li>末小吉 (すえしょうきち)</li>
                                <li>凶 (きょう)</li>
                                <li>小凶 (しょうきょう)</li>
                                <li>半凶 (はんきょう)</li>
                                <li>末凶 (すえきょう)</li>
                                <li>大凶 (だいきょう)</li>
                            </ol>
                            <p>「吉」の位置づけが神社によって「大吉の次」とされる場合と、「小吉の下」とされる場合がありますが、当サイトでは「小吉と末吉の間」という中庸な位置づけとしています。</p>
                            <p>しかし、最も重要なのは順位ではありません。おみくじの本質は、そこに書かれている「神様からの和歌や助言」にあります。大吉であっても戒めの言葉があれば気を引き締め、大凶であっても励ましの言葉があれば希望を持つことが大切です。</p>
                        </div>
                    `;
                } else if (id === 2) {
                    html = `
                        <div class="article-header">
                            <div class="article-meta">
                                <span class="article-tag">豆知識</span>
                                <span>2026/01/01</span>
                            </div>
                            <h2 class="article-title">悪い結果が出ても実は大丈夫？「凶」の正しい扱い方</h2>
                        </div>
                        <div class="article-content">
                            <p>おみくじを引いて「凶」や「大凶」が出ると、誰しも気分が落ち込むものです。しかし、古来より「凶」は必ずしも忌むべきものとはされてきませんでした。</p>
                            <h3>「凶」は運気の底、これからは上がるのみ</h3>
                            <p>陰陽道などの考え方では、物事は極まれば反転すると考えます。「大吉」は今が頂点であり、これからは下り坂になる可能性があるため、むしろ慎重な行動が求められます。</p>
                            <p>逆に「凶」は、今が運気の底であり、これからは上昇する一方であることを示唆しています。「禍を転じて福となす」という言葉通り、今の困難を乗り越えることで、より大きな幸運をつかむチャンスなのです。</p>
                            <h3>結ぶか、持ち帰るか？</h3>
                            <p>悪い結果が出た場合、神社の境内にある「結び所」に結んで帰る風習が一般的です。これには「神様と縁を結ぶ」「悪い運気を神様に預けて浄化してもらう」という意味があります。</p>
                            <p>一方で、「戒めとして財布に入れて持ち歩く」という考え方もあります。自分への警告として時々読み返すことで、慎重な行動を心がけ、災いを未然に防ぐことができるからです。</p>
                            <p>当サイトでは、引いたおみくじの結果は自動的に「おみくじの轍」に記録されます。これがデジタルの「結び所」です。悪い結果が出ても、ここに結んでいくことで運気は好転するでしょう。</p>
                        </div>
                    `;
                } else if (id === 3) {
                    html = `
                        <div class="article-header">
                            <div class="article-meta">
                                <span class="article-tag">作法</span>
                                <span>2025/12/30</span>
                            </div>
                            <h2 class="article-title">神社での正しい参拝マナー</h2>
                        </div>
                        <div class="article-content">
                            <p>神社は神様のお住まいです。失礼のないよう、基本的な参拝マナーをおさらいしましょう。</p>
                            <h3>1. 鳥居をくぐる時</h3>
                            <p>鳥居は俗界と神域を分ける結界です。くぐる前には一礼（一揖）をし、帽子などは取ります。参道の中央（正中）は神様の通り道なので、避けて端を歩くのがマナーです。</p>
                            <h3>2. 手水舎での清め方</h3>
                            <p>参拝の前に、身の穢れを落とします。<br>
                            1. 右手で柄杓を持ち、水を汲んで左手を清める。<br>
                            2. 左手に持ち替え、右手を清める。<br>
                            3. 再び右手に持ち、左手で水を受けて口をすすぐ（柄杓に直接口をつけない）。<br>
                            4. 左手を再度清め、最後に柄杓を立てて残った水で柄を洗い流す。</p>
                            <h3>3. 拝礼（二礼二拍手一礼）</h3>
                            <p>お賽銭を入れた後、鈴を鳴らし、姿勢を正します。<br>
                            1. 深く二回お辞儀をする（二礼）。<br>
                            2. 胸の前で両手を合わせ、右手を少し下にずらして二回拍手を打つ（二拍手）。<br>
                            3. 指先を揃えて祈りを捧げる。<br>
                            4. 最後にもう一度深くお辞儀をする（一礼）。</p>
                            <p>※出雲大社など、一部の神社では「四拍手」など作法が異なる場合があります。</p>
                        </div>
                    `;
                } else if (id === 4) {
                    html = `
                        <div class="article-header">
                            <div class="article-meta">
                                <span class="article-tag">豆知識</span>
                                <span>2025/12/28</span>
                            </div>
                            <h2 class="article-title">「失せ物」の本当の意味</h2>
                        </div>
                        <div class="article-content">
                            <p>おみくじの項目にある「失せ物（うせもの）」。これは単に「落とし物」や「無くした財布」のことだけを指すのではありません。</p>
                            <h3>形あるもの、形なきもの</h3>
                            <p>失せ物には、物理的な物品だけでなく、「失った信頼」「忘れていた初心」「疎遠になった友人」など、形のないものも含まれます。</p>
                            <h3>言葉の意味</h3>
                            <ul class="list-disc ml-5 mb-4">
                                <li><b>「出ず（いでず）」</b>：残念ながら戻ってこない可能性が高いです。諦めて新しいものを探すか、執着を手放すべき時です。</li>
                                <li><b>「出る」</b>：見つかります。焦らず探しましょう。</li>
                                <li><b>「高いところより出る」</b>：棚の上や、普段見ない高い場所、あるいは目上の人からの連絡で見つかるかもしれません。</li>
                                <li><b>「女（男）の知る事あり」</b>：その性別の知人が何か知っているか、持っている可能性があります。</li>
                            </ul>
                            <p>「失せ物」の欄を見る時は、今自分が「何を探しているのか」「何を失ってしまったと感じているのか」を問い直してみると、深いメッセージを受け取れるかもしれません。</p>
                        </div>
                    `;
                } else if (id === 5) {
                    html = `
                        <div class="article-header">
                            <div class="article-meta">
                                <span class="article-tag">開運</span>
                                <span>2025/12/25</span>
                            </div>
                            <h2 class="article-title">「待ち人」は恋愛だけじゃない</h2>
                        </div>
                        <div class="article-content">
                            <p>「待ち人来ず」と出ると、恋人ができないのかとガッカリする人が多いですが、これは誤解です。</p>
                            <h3>人生を導くキーパーソン</h3>
                            <p>おみくじにおける「待ち人」とは、「あなたの人生に良い影響を与えてくれる人」「運命を切り開くきっかけとなる人」全般を指します。</p>
                            <p>それは将来の恋人や結婚相手かもしれませんし、ビジネスパートナー、あるいは人生の師となる先生、一生の親友、もしかすると赤ちゃん（妊娠）のことかもしれません。</p>
                            <h3>「来ず」の意味</h3>
                            <p>「来ず」とあっても、一生現れないわけではありません。「今はまだその時ではない」「自分から動きなさい」というメッセージであることが多いのです。「音信（たより）あり」とあれば、遠くから連絡が来るでしょう。</p>
                            <p>待ち人は、じっと待っているだけでは現れないこともあります。自分を磨き、行動範囲を広げることで、巡り会う確率はぐっと高まります。</p>
                        </div>
                    `;
                }
            } else if (type === 'news') {
                 if (id === 1) {
                    html = `
                        <div class="article-header">
                            <div class="article-meta">
                                <span>2026年1月1日 0:00</span>
                            </div>
                            <h2 class="article-title">あけましておめでとうごさいます</h2>
                        </div>
                        <div class="article-content">
                            <p>謹んで新年のご祝詞を申し上げます。</p>
                            <p>旧年中はひとかたならぬご厚情を賜り、誠にありがとうございました。<br>本年も皆様に幸多き年となりますよう、天命乃杜運営一同、心よりお祈り申し上げます。</p>
                            <p>新しい年が始まり、皆様それぞれに新たな目標や願いをお持ちのことと存じます。当サイトのおみくじが、皆様の迷いを晴らし、一歩を踏み出すための道標となれば幸いです。</p>
                            <p>本年も変わらぬご愛顧のほど、よろしくお願い申し上げます。</p>
                        </div>
                    `;
                } else if (id === 2) {
                    html = `
                        <div class="article-header">
                            <div class="article-meta">
                                <span>2026年1月2日 16:00</span>
                            </div>
                            <h2 class="article-title">「運勢・天命乃杜」を公開いたしました。</h2>
                        </div>
                        <div class="article-content">
                            <p>平素より格別のご高配を賜り、厚く御礼申し上げます。</p>
                            <p>この度、誰でも気軽に、かつ本格的な運勢占いを楽しめるWebサイト「運勢・天命乃杜（てんめいのもり）」を正式に公開いたしました。</p>
                            <p>当サイトでは、伝統的なおみくじの要素に加え、西洋占星術と血液型診断を組み合わせた独自のアルゴリズムによる「日替わり運勢ランキング」を提供しております。また、会員登録（無料）を行っていただくことで、ご自身の運勢履歴を保存したり、全体の統計データに参加したりすることが可能です。</p>
                            <p>今後もコンテンツの拡充や機能改善に努めてまいりますので、末永くご愛顧いただけますようお願い申し上げます。</p>
                        </div>
                    `;
                } else if (id === 3) {
                    html = `
                        <div class="article-header">
                            <div class="article-meta">
                                <span>2025年12月25日 10:00</span>
                            </div>
                            <h2 class="article-title">プレオープンのお知らせ</h2>
                        </div>
                        <div class="article-content">
                            <p>本日より、一部機能を制限した状態でのプレオープンを開始いたしました。</p>
                            <p>現在ご利用いただけるのは、「おみくじ機能」および「12星座占い（β版）」です。正式リリース時には、履歴保存機能や会員システムが追加される予定です。</p>
                            <p>動作に不具合等ございましたら、お問い合わせフォームよりご連絡いただけますと幸いです。</p>
                        </div>
                    `;
                } else if (id === 4) {
                    html = `
                        <div class="article-header">
                            <div class="article-meta">
                                <span>2025年12月20日 18:00</span>
                            </div>
                            <h2 class="article-title">サーバーメンテナンス完了</h2>
                        </div>
                        <div class="article-content">
                            <p>本日14:00より実施しておりましたサーバーメンテナンスは、予定通り18:00に完了いたしました。</p>
                            <p>今回のメンテナンスにより、データベースの応答速度が向上しております。ご協力ありがとうございました。</p>
                        </div>
                    `;
                } else if (id === 5) {
                    html = `
                        <div class="article-header">
                            <div class="article-meta">
                                <span>2025年12月10日 12:00</span>
                            </div>
                            <h2 class="article-title">サイト開設準備室より</h2>
                        </div>
                        <div class="article-content">
                            <p>「運勢・天命乃杜」の開設に向け、現在鋭意開発中です。</p>
                            <p>皆様に愛されるサイトを目指し、デザインの調整や占いロジックの検証を行っております。公開まで今しばらくお待ちください。</p>
                        </div>
                    `;
                }
            }

            container.innerHTML = html;
            showView('article-detail');
        }

        // --- 認証系 ---
        function toggleAuthTab(tab) {
            const loginForm = document.getElementById('form-login');
            const regForm = document.getElementById('form-register');
            const tabLogin = document.getElementById('tab-login');
            const tabReg = document.getElementById('tab-register');

            if (tab === 'login') {
                loginForm.classList.remove('hidden');
                regForm.classList.add('hidden');
                tabLogin.classList.add('border-red-500', 'font-bold');
                tabLogin.classList.remove('border-transparent', 'text-gray-500');
                tabReg.classList.remove('border-red-500', 'font-bold');
                tabReg.classList.add('border-transparent', 'text-gray-500');
            } else {
                loginForm.classList.add('hidden');
                regForm.classList.remove('hidden');
                tabReg.classList.add('border-red-500', 'font-bold');
                tabReg.classList.remove('border-transparent', 'text-gray-500');
                tabLogin.classList.remove('border-red-500', 'font-bold');
                tabLogin.classList.add('border-transparent', 'text-gray-500');
            }
        }

        async function sendAuthCode() {
            const isLoginOpen = !document.getElementById('form-login').classList.contains('hidden');
            const emailInputId = isLoginOpen ? 'login-email' : 'reg-email';
            const email = document.getElementById(emailInputId).value;
            const username = document.getElementById('reg-username').value;

            if(!email) return alert("メールアドレスを入力してください");
            showLoading(true);

            try {
                const res = await fetch(`${API_BASE}/api/auth/send`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email, username: isLoginOpen ? undefined : username }) 
                });
                
                const data = await res.json();
                
                if(res.ok && data.success) {
                    alert(`${email} に認証コードを送信しました。\nメールを確認してください。`);
                } else {
                    alert(`送信エラー: ${data.error || '不明なエラー'}`);
                }
            } catch(e) {
                console.error(e);
                alert("通信エラー: サーバーに接続できませんでした。");
            }
            showLoading(false);
        }

        async function performLogin() {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            const code = document.getElementById('login-code').value;

            if(!email || !pass || !code) return alert("全ての項目を入力してください");
            showLoading(true);
            
            try {
                const res = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email, password: pass, code })
                });

                const data = await res.json();

                if(res.ok && data.success) {
                    loginSuccess({ email, username: data.username, token: data.token });
                } else {
                    alert(`ログイン失敗: ${data.message || data.error || '入力情報が正しくありません'}`);
                }
            } catch(e) {
                console.error(e);
                alert("通信エラー: ログインできませんでした。");
            }
            showLoading(false);
        }

        async function performRegister() {
            const name = document.getElementById('reg-username').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-password').value;
            const code = document.getElementById('reg-code').value;

            if(!name || !email || !pass || !code) return alert("全ての項目を入力してください");
            showLoading(true);

            try {
                const res = await fetch(`${API_BASE}/api/auth/register`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        email, 
                        password: pass, 
                        username: name,
                        code 
                    })
                });

                const data = await res.json();

                if(res.ok && data.success) {
                    loginSuccess({ email, username: data.username, token: data.token });
                } else {
                    alert(`登録失敗: ${data.message || data.error || '登録できませんでした'}`);
                }
            } catch(e) {
                console.error(e);
                alert("通信エラー: 登録処理に失敗しました。");
            }
            showLoading(false);
        }

        function loginSuccess(user) {
            currentState.user = user;
            localStorage.setItem('omikuji_user', JSON.stringify(user));
            updateAuthUI();
            loadFavorites(); 
            alert(`ようこそ、${user.username || user.email} 様！\nログインしました。`);
            showView('home');
        }

        function updateAuthUI() {
            const badge = document.getElementById('fav-status-badge');
            
            if(currentState.user) {
                document.getElementById('auth-user-info').classList.remove('hidden');
                document.getElementById('form-login').parentElement.querySelector('div:not(#auth-user-info)').style.display = 'none'; 
                document.getElementById('user-display-name').textContent = currentState.user.username || currentState.user.email;
                document.getElementById('nav-login-btn').innerHTML = `<i class="bi bi-person-check-fill text-green-400"></i><span class="nav-text">会員: ${currentState.user.username}</span>`;
                if(badge) badge.textContent = "クラウド保存済み";
            } else {
                document.getElementById('auth-user-info').classList.add('hidden');
                const formsContainer = document.getElementById('form-login').parentElement.querySelector('div:not(#auth-user-info)');
                if(formsContainer) formsContainer.style.display = 'block';
                document.getElementById('nav-login-btn').innerHTML = `<i class="bi bi-person-circle"></i><span class="nav-text">ログイン/登録</span>`;
                if(badge) badge.textContent = "端末に保存中";
            }
        }
        
        function logout() {
            localStorage.removeItem('omikuji_user');
            currentState.user = null;
            location.reload();
        }

        // --- お気に入り機能 ---
        async function loadFavorites() {
            const badge = document.getElementById('fav-status-badge');
            
            if(currentState.user) {
                if(badge) badge.textContent = "同期中...";
                try {
                    const res = await fetch(`${API_BASE}/api/favorites?email=${encodeURIComponent(currentState.user.email)}&token=${encodeURIComponent(currentState.user.token)}`);
                    if(res.ok) {
                        const data = await res.json();
                        favoriteList = data.favorites || [];
                        if(badge) badge.textContent = "クラウド保存済み";
                    }
                } catch(e) {
                    console.error("Fav fetch error", e);
                }
            } else {
                const stored = localStorage.getItem('fortuneFavorites');
                if (stored) {
                    favoriteList = JSON.parse(stored);
                }
                if(badge) badge.textContent = "端末に保存中";
            }
            renderFavorites();
        }

        async function saveFavorites() {
            if(currentState.user) {
                try {
                    await fetch(`${API_BASE}/api/favorites`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: currentState.user.email,
                            token: currentState.user.token,
                            favorites: favoriteList
                        })
                    });
                } catch(e) {
                    console.error("Fav save error", e);
                }
            } else {
                localStorage.setItem('fortuneFavorites', JSON.stringify(favoriteList));
            }
            renderFavorites();
            renderRanking();
        }

        // ==========================================
        //  12星座×血液型占いロジック
        // ==========================================
        function initZodiacSystem() {
            const dateStr = getJSTDateString();
            const dateParts = dateStr.split('-');
            document.getElementById('current-date-display').innerHTML = `${dateParts[0]}年${dateParts[1]}月${dateParts[2]}日 <span class="text-sm font-normal ml-2 text-gray-500 dark:text-gray-400">(毎日 0:00 更新)</span>`;
            generateDailyRanking(dateStr);
            renderRanking();
        }

        function getJSTDateString() {
            const now = new Date();
            const jstOffset = 9 * 60; 
            const jstNow = new Date(now.getTime() + (now.getTimezoneOffset() + jstOffset) * 60000);
            return jstNow.toISOString().split('T')[0];
        }

        function getFutureDateString(baseDateStr, daysToAdd) {
            const date = new Date(baseDateStr);
            date.setDate(date.getDate() + daysToAdd);
            return date.toISOString().split('T')[0];
        }

        class SeededRandom {
            constructor(seed) {
                this.seed = 0;
                for (let i = 0; i < seed.length; i++) {
                    this.seed = (this.seed * 31 + seed.charCodeAt(i)) >>> 0;
                }
            }
            next() {
                this.seed ^= this.seed << 13;
                this.seed ^= this.seed >> 17;
                this.seed ^= this.seed << 5;
                let x = (this.seed < 0 ? ~this.seed + 1 : this.seed);
                return (x % 100000) / 100000;
            }
        }

        const zodiacSigns = [
            { id: "aries", name: "牡羊座", icon: "♈" }, { id: "taurus", name: "牡牛座", icon: "♉" }, { id: "gemini", name: "双子座", icon: "♊" },
            { id: "cancer", name: "蟹座", icon: "♋" }, { id: "leo", name: "獅子座", icon: "♌" }, { id: "virgo", name: "乙女座", icon: "♍" },
            { id: "libra", name: "天秤座", icon: "♎" }, { id: "scorpio", name: "蠍座", icon: "♏" }, { id: "sagittarius", name: "射手座", icon: "♐" },
            { id: "capricorn", name: "山羊座", icon: "♑" }, { id: "aquarius", name: "水瓶座", icon: "♒" }, { id: "pisces", name: "魚座", icon: "♓" }
        ];
        const bloodTypes = ["A", "B", "O", "AB"];
        const luckyItems = ["アンティーク時計", "文庫本の小説", "ミネラルウォーター", "銀のアクセサリー", "小さな観葉植物", "革製のシステム手帳", "ラベンダーの香り", "新しいスニーカー", "ワイヤレスイヤホン", "ミントタブレット"];
        const luckyColors = ["ルビーレッド", "スカイブルー", "フォレストグリーン", "レモンイエロー", "パールホワイト", "ミッドナイトブラック", "シャンパンゴールド", "プラチナシルバー", "サクラピンク", "ネイビーブルー"];

        const descPartsStart = [
            "全体的な星の配置を見ると、今日のあなたは非常に感受性が豊かになっており、",
            "今日の運勢は、宇宙のエネルギーがあなたの内面に強く働きかける配置となっていて、",
            "一日の流れとして、午前中は静かなスタートとなりますが、午後からは運気が急上昇し、",
            "今日の星回りは、過去の努力が実を結ぶタイミングを示唆しており、",
            "周囲の環境とあなたの波長が完璧にシンクロする一日となりそうで、"
        ];
        const descPartsSection2 = [
            "特に人間関係においては、あなたの何気ない一言が周囲の人々を勇気づけ、感謝される場面があるでしょう。",
            "直感が冴え渡る瞬間が多く訪れ、迷ったときに自分の心の声に従うことで、最良の選択をすることができます。",
            "今まで苦手意識を持っていたことに対して、不思議と前向きに取り組めるエネルギーが湧いてくるはずです。",
            "予期せぬ場所での出会いや、懐かしい人からの連絡が、新しいチャンスへの扉を開く鍵となるかもしれません。",
            "少し疲れを感じる瞬間もあるかもしれませんが、それは次のステップへ進むための好転反応ですので心配はいりません。"
        ];
        const descPartsSection3 = [
            "仕事や勉学の面では、集中力が途切れがちになるかもしれませんが、適度な休憩を挟むことで驚くほどの効率アップが望めます。",
            "金銭面に関しては、衝動買いに注意が必要ですが、自己投資となるものには惜しまずお金を使うことが将来の利益に繋がります。",
            "恋愛面では、素直な気持ちを伝えるのに最適な日であり、パートナーがいる人はより深い絆を結ぶことができるでしょう。",
            "クリエイティブな活動にツキがあり、あなたの独創的なアイデアが周囲から高く評価される可能性が高いです。",
            "健康面では、十分な睡眠とバランスの取れた食事を心がけることで、一日中パワフルに活動することができます。"
        ];
        const descPartsEnd = [
            "一日の終わりには、今日あった出来事に感謝しつつ、ゆっくりとリラックスする時間を持つことが、明日の幸運を引き寄せる秘訣です。",
            "ラッキーアイテムを身近に置くことで、さらに運気を底上げし、トラブルを未然に防ぐお守りとなってくれるでしょう。",
            "今日の経験は、あなたの人生において重要な意味を持つピースとなり、未来の成功への確かな布石となります。",
            "笑顔を絶やさず、ポジティブな言葉を使うことを意識すれば、素晴らしい一日になることは間違いありません。",
            "新しいことへのチャレンジを恐れず、自信を持って一歩を踏み出してください。星たちはあなたを応援しています。"
        ];

        const loveShorts = ["積極的なアプローチが吉", "相手の話を聞く姿勢が大事", "出会いのチャンス到来", "今は自分磨きに専念を", "誤解が解ける好機", "パートナーと穏やかな時間を"];
        const moneyShorts = ["無駄遣いに注意が必要", "思わぬ臨時収入の予感", "自己投資には最適な日", "財布の紐を固く締めて", "欲しかった物が安く手に入る", "契約事は慎重に確認を"];
        const workShorts = ["集中力が高まり効率アップ", "チームワークを大切に", "新しいアイデアが光る", "報告連絡相談を密に", "ミスに注意し確認徹底", "リーダーシップを発揮できる"];

        function generateDailyRanking(dateStr) {
            let combinations = [];
            zodiacSigns.forEach(sign => {
                bloodTypes.forEach(blood => {
                    combinations.push({ sign, blood });
                });
            });

            const rng = new SeededRandom(dateStr);

            let scoredData = combinations.map(item => {
                const baseScore = Math.floor(rng.next() * 60) + 40; 
                const loveScore = Math.floor(rng.next() * 60) + 40;
                const moneyScore = Math.floor(rng.next() * 60) + 40;
                const workScore = Math.floor(rng.next() * 60) + 40;
                const totalScoreRaw = (baseScore + loveScore + moneyScore + workScore) / 4;
                const totalScore = Math.min(100, Math.floor(totalScoreRaw));

                const p1 = descPartsStart[Math.floor(rng.next() * descPartsStart.length)];
                const p2 = descPartsSection2[Math.floor(rng.next() * descPartsSection2.length)];
                const p3 = descPartsSection3[Math.floor(rng.next() * descPartsSection3.length)];
                const p4 = descPartsEnd[Math.floor(rng.next() * descPartsEnd.length)];
                const longDesc = `${p1}${p2} ${p3}${p4}`;

                return {
                    sign: item.sign,
                    blood: item.blood,
                    totalScore: totalScore,
                    love: { score: loveScore, desc: loveShorts[Math.floor(rng.next() * loveShorts.length)] },
                    money: { score: moneyScore, desc: moneyShorts[Math.floor(rng.next() * moneyShorts.length)] },
                    work: { score: workScore, desc: workShorts[Math.floor(rng.next() * workShorts.length)] },
                    luckyNum: Math.floor(rng.next() * 9) + 1,
                    item: luckyItems[Math.floor(rng.next() * luckyItems.length)],
                    color: luckyColors[Math.floor(rng.next() * luckyColors.length)],
                    longDesc: longDesc
                };
            });

            scoredData.sort((a, b) => b.totalScore - a.totalScore);
            scoredData.forEach((d, i) => d.rank = i + 1);

            const assignSubRank = (prop) => {
                const sorted = [...scoredData].sort((a, b) => b[prop].score - a[prop].score);
                scoredData.forEach(d => {
                    d[prop].rank = sorted.findIndex(s => s === d) + 1;
                });
            };
            assignSubRank('love');
            assignSubRank('money');
            assignSubRank('work');

            scoredData.forEach(person => {
                person.calendar = calculateFutureLuck(person.sign.id, person.blood, dateStr);
            });

            dailyRanking = scoredData;
        }

        function calculateFutureLuck(signId, bloodType, baseDateStr) {
            let calendarDays = [];
            for(let i=0; i<30; i++) {
                const targetDate = getFutureDateString(baseDateStr, i);
                const dayOfMonth = new Date(targetDate).getDate();
                const rng = new SeededRandom(targetDate);
                let dayScores = [];
                zodiacSigns.forEach(s => {
                    bloodTypes.forEach(b => {
                        const bScore = Math.floor(rng.next() * 60) + 40;
                        const lScore = Math.floor(rng.next() * 60) + 40;
                        const mScore = Math.floor(rng.next() * 60) + 40;
                        const wScore = Math.floor(rng.next() * 60) + 40;
                        const tScore = Math.floor((bScore + lScore + mScore + wScore) / 4);
                        dayScores.push({ s: s.id, b: b, t: tScore, l: lScore, m: mScore, w: wScore });
                    });
                });
                const me = dayScores.find(d => d.s === signId && d.b === bloodType);
                let marks = [];
                if (me.t >= Math.max(...dayScores.map(d => d.t))) marks.push('<i class="bi bi-star-fill text-yellow-500"></i>');
                if (me.l >= Math.max(...dayScores.map(d => d.l))) marks.push('<i class="bi bi-heart-fill text-pink-500"></i>');
                if (me.m >= Math.max(...dayScores.map(d => d.m))) marks.push('<i class="bi bi-currency-yen text-yellow-600"></i>');
                if (me.w >= Math.max(...dayScores.map(d => d.w))) marks.push('<i class="bi bi-pencil-fill text-blue-500"></i>');
                calendarDays.push({ day: dayOfMonth, marks: marks });
            }
            return calendarDays;
        }

        function createCardHTML(data) {
            const isFav = isFavorite(data.sign.id, data.blood);
            const rankClass = data.rank <= 3 ? `rank-${data.rank}` : 'rank-other';
            const borderClass = data.rank <= 3 ? 'border-l-4 border-yellow-400' : '';
            const getBarColor = (score) => score > 80 ? '#ef4444' : (score > 50 ? '#eab308' : '#3b82f6');
            return `
                <div class="ranking-card ${borderClass} themed-card">
                    <button class="fav-btn ${isFav ? 'active' : ''}" onclick="toggleFavorite('${data.sign.id}', '${data.blood}')">
                        <i class="bi bi-star${isFav ? '-fill' : ''}"></i>
                    </button>
                    <div class="flex items-start">
                        <div class="rank-badge-lg ${rankClass}">${data.rank}</div>
                        <div class="ml-4 flex-grow">
                            <div class="flex items-center flex-wrap gap-2 mb-1">
                                <span class="text-3xl">${data.sign.icon}</span>
                                <span class="font-bold text-xl" style="color:var(--text-main);">${data.sign.name}</span>
                                <span class="bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded text-sm font-bold" style="color:var(--text-main);">${data.blood}型</span>
                            </div>
                            <div class="flex items-center gap-4 text-sm mt-1 mb-2" style="color: var(--text-sub);">
                                <span><i class="bi bi-hash"></i> ラッキーナンバー: <strong>${data.luckyNum}</strong></span>
                                <span><i class="bi bi-bar-chart-fill"></i> 総合: <strong>${data.totalScore}点</strong></span>
                            </div>
                            <p class="text-sm leading-relaxed mb-3 text-justify" style="color: var(--text-main); line-height:1.8;">${data.longDesc}</p>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs mb-3" style="color: var(--text-sub);">
                                <div><i class="bi bi-stars text-yellow-500"></i> ラッキーアイテム: ${data.item}</div>
                                <div><i class="bi bi-palette text-pink-500"></i> ラッキーカラー: ${data.color}</div>
                            </div>
                        </div>
                    </div>
                    <div class="param-grid">
                        <div class="param-item">
                            <div class="param-label"><i class="bi bi-heart-fill text-pink-500"></i> 恋愛 (${data.love.rank}位)</div>
                            <div class="param-score-text">${data.love.score}点</div>
                            <div class="param-value text-xs">${data.love.desc}</div>
                            <div class="score-bar-bg"><div class="score-bar-fill" style="width:${data.love.score}%; background:${getBarColor(data.love.score)};"></div></div>
                        </div>
                        <div class="param-item">
                            <div class="param-label"><i class="bi bi-currency-yen text-yellow-500"></i> 金運 (${data.money.rank}位)</div>
                            <div class="param-score-text">${data.money.score}点</div>
                            <div class="param-value text-xs">${data.money.desc}</div>
                            <div class="score-bar-bg"><div class="score-bar-fill" style="width:${data.money.score}%; background:${getBarColor(data.money.score)};"></div></div>
                        </div>
                        <div class="param-item">
                            <div class="param-label"><i class="bi bi-book-fill text-blue-500"></i> 仕事/勉強 (${data.work.rank}位)</div>
                            <div class="param-score-text">${data.work.score}点</div>
                            <div class="param-value text-xs">${data.work.desc}</div>
                            <div class="score-bar-bg"><div class="score-bar-fill" style="width:${data.work.score}%; background:${getBarColor(data.work.score)};"></div></div>
                        </div>
                    </div>
                    <div class="calendar-wrapper">
                        <p class="text-xs text-center mb-1 font-bold" style="color:var(--text-main);">向こう30日間のラッキーデー</p>
                        <div class="calendar-grid">
                            ${data.calendar.map(d => `<div class="calendar-cell"><span class="cal-date">${d.day}</span><span class="cal-mark">${d.marks.join('')}</span></div>`).join('')}
                        </div>
                        <div class="calendar-legend">
                            <span class="legend-item"><i class="bi bi-star-fill text-yellow-500"></i>総合1位</span>
                            <span class="legend-item"><i class="bi bi-heart-fill text-pink-500"></i>恋愛1位</span>
                            <span class="legend-item"><i class="bi bi-currency-yen text-yellow-600"></i>金運1位</span>
                            <span class="legend-item"><i class="bi bi-pencil-fill text-blue-500"></i>勉強1位</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderFavorites() {
            const container = document.getElementById('favorites-list');
            const section = document.getElementById('favorites-section');
            container.innerHTML = '';
            
            if (favoriteList.length === 0) {
                section.classList.add('hidden');
                return;
            }
            section.classList.remove('hidden');

            favoriteList.forEach(fav => {
                const data = dailyRanking.find(d => d.sign.id === fav.sign && d.blood === fav.blood);
                if (data) {
                    container.innerHTML += createCardHTML(data);
                }
            });
        }

        function renderRanking() {
            const listContainer = document.getElementById('ranking-list');
            const fullListContainer = document.getElementById('full-ranking-list');
            listContainer.innerHTML = '';
            fullListContainer.innerHTML = '';
            dailyRanking.forEach((data, index) => {
                const html = createCardHTML(data);
                if (index < 3) { listContainer.insertAdjacentHTML('beforeend', html); }
                else { fullListContainer.insertAdjacentHTML('beforeend', html); }
            });
        }

        function showFullRanking() {
            const fullList = document.getElementById('full-ranking-list');
            const txt = document.getElementById('show-ranking-text');
            if (fullList.classList.contains('hidden')) { fullList.classList.remove('hidden'); txt.textContent = "ランキングを閉じる"; }
            else { fullList.classList.add('hidden'); txt.textContent = "4位以下を見る"; }
        }

        function findMyRank() {
            const signId = document.getElementById('user-sign').value;
            const bloodId = document.getElementById('user-blood').value;
            const resultDiv = document.getElementById('my-rank-result');
            const myData = dailyRanking.find(d => d.sign.id === signId && d.blood === bloodId);
            if (myData) {
                resultDiv.innerHTML = createCardHTML(myData);
                resultDiv.classList.remove('hidden');
            }
        }

        // お気に入りヘルパー
        function toggleFavorite(signId, bloodType) {
            const existsIndex = favoriteList.findIndex(f => f.sign === signId && f.blood === bloodType);
            if (existsIndex >= 0) {
                favoriteList.splice(existsIndex, 1);
            } else {
                if (favoriteList.length >= 5) {
                    alert('お気に入りは最大5つまでです。');
                    return;
                }
                favoriteList.push({ sign: signId, blood: bloodType });
            }
            saveFavorites(); 
        }

        function isFavorite(signId, bloodType) {
            return favoriteList.some(f => f.sign === signId && f.blood === bloodType);
        }
    </script>
</body>
</html>
