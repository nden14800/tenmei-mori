<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>運勢・天命乃杜 | 本格・今日の運勢</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tailwind Config -->
    <script>
      tailwind.config = {
        darkMode: 'class',
      }
    </script>
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- jsPDF & html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- フォント -->
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500;600;800&family=Zen+Old+Mincho:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root {
            /* ライトモード変数 */
            --bg-pattern: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4d4d4' fill-opacity='0.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            --bg-color: #fdfbf7;
            --text-main: #2b2b2b;
            --text-sub: #555555;
            --card-bg: #ffffff;
            --card-border: #e6e6e6;
            --accent-red: #b91c1c;
            --accent-gold: #c5a059;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.3);
            --sidebar-bg: rgba(255, 255, 255, 0.75); /* すりガラス用に透明度アップ */
            --input-bg: #ffffff;
            --omi-paper: #fffcf2; 
            --sidebar-width: 80px;
            --sidebar-width-expanded: 240px;
        }

        /* --- ダークモード変数定義 (システム検知と手動.darkを完全に一致させる) --- */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-pattern: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23444444' fill-opacity='0.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
                --bg-color: #1a1a1a;
                --text-main: #e0e0e0;
                --text-sub: #b0b0b0;
                --card-bg: #2c2c2c;
                --card-border: #444444;
                --accent-red: #ff6b6b;
                --accent-gold: #e5c07b;
                --glass-bg: rgba(30, 30, 30, 0.9);
                --glass-border: rgba(255, 255, 255, 0.1);
                --sidebar-bg: rgba(30, 30, 30, 0.75);
                --input-bg: #333333;
                --omi-paper: #fffcf2; 
            }
        }

        /* 手動切り替え (.darkクラス付与時) - システム検知時と100%同じ値を適用 */
        .dark {
            --bg-pattern: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23444444' fill-opacity='0.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") !important;
            --bg-color: #1a1a1a !important;
            --text-main: #e0e0e0 !important;
            --text-sub: #b0b0b0 !important;
            --card-bg: #2c2c2c !important;
            --card-border: #444444 !important;
            --accent-red: #ff6b6b !important;
            --accent-gold: #e5c07b !important;
            --glass-bg: rgba(30, 30, 30, 0.9) !important;
            --glass-border: rgba(255, 255, 255, 0.1) !important;
            --sidebar-bg: rgba(30, 30, 30, 0.75) !important;
            --input-bg: #333333 !important;
            --omi-paper: #fffcf2 !important; 
        }

        /* Lab: 迎春・雅モード */
        body.theme-newyear {
            --bg-color: #fffbf0;
            --bg-pattern: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23d4af37' fill-opacity='0.2'%3E%3Cpath d='M0 0h40v40H0V0zm20 20h20v20H20V20zM0 20h20v20H0V20zM20 0h20v20H20V0z'/%3E%3C/g%3E%3C/svg%3E");
            --accent-red: #e60033; /* 紅白の紅 */
            --accent-gold: #d4af37; /* 金 */
            --card-border: #d4af37;
        }
        body.theme-newyear .nav-btn {
            color: #333;
        }
        body.theme-newyear #sidebar {
            background-color: rgba(255, 252, 240, 0.85);
            border-right: 1px solid #d4af37;
        }

        body {
            font-family: 'Zen Old Mincho', 'Shippori Mincho', serif;
            background-color: var(--bg-color);
            background-image: var(--bg-pattern);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- 汎用テーマクラス --- */
        .themed-card {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-main);
        }
        .themed-text-sub { color: var(--text-sub); }
        .themed-input {
            background-color: var(--input-bg);
            color: var(--text-main);
            border: 1px solid var(--card-border);
        }

        /* --- サイドバー (すりガラス効果強化) --- */
        #sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            backdrop-filter: blur(15px); /* すりガラス効果 */
            -webkit-backdrop-filter: blur(15px);
            border-right: 1px solid var(--glass-border);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 100;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding-top: 20px;
            overflow: hidden;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }
        #sidebar:hover {
            width: var(--sidebar-width-expanded);
        }
        .nav-btn {
            width: 100%;
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--text-main);
            background: none;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
            text-decoration: none;
            height: 60px;
        }
        .nav-btn:hover {
            background-color: rgba(128,128,128,0.1);
        }
        .nav-btn i {
            font-size: 1.5rem;
            min-width: 40px;
            text-align: center;
        }
        /* サイドバー用フラスコSVGのスタイル */
        .nav-btn svg {
            min-width: 40px; /* アイコンの幅を確保 */
            width: 32px;
            height: 32px;
            margin: 0; /* 左寄せではなく中央になるようにマージン調整が必要だがflexで制御 */
            display: block;
            flex-shrink: 0;
        }

        .nav-text {
            opacity: 0;
            transform: translateX(-10px);
            transition: all 0.3s;
            font-weight: bold;
            font-family: 'Zen Old Mincho', serif;
            margin-left: 10px;
        }
        #sidebar:hover .nav-text {
            opacity: 1;
            transform: translateX(0);
        }

        /* --- メインコンテンツ --- */
        #main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
            width: calc(100% - var(--sidebar-width));
            transition: margin-left 0.3s;
        }

        /* --- 共通コンポーネント --- */
        .btn-primary {
            background-color: var(--accent-red);
            color: white;
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .btn-primary:disabled {
            background-color: #999;
            cursor: not-allowed;
            transform: none;
        }
        .btn-outline {
            background-color: transparent;
            color: var(--text-main);
            border: 2px solid var(--text-main);
            padding: 10px 25px;
            border-radius: 30px;
            font-weight: bold;
            transition: all 0.3s;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        .btn-outline:hover {
            background-color: rgba(128,128,128,0.1);
        }

        /* --- 新ローディングスピナー --- */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease; /* 滑らかなフェード */
        }
        #loading-overlay.visible {
            opacity: 1;
        }
        
        .loader-svg {
            width: 80px;
            height: 80px;
            animation: rotate 1s linear infinite;
            transform-origin: center center;
        }
        .loader-path {
            stroke: #ffffff; /* 白色の線 */
            stroke-linecap: round;
            stroke-dasharray: 89 150;
            stroke-dashoffset: 0;
        }
        @keyframes rotate {
            100% { transform: rotate(360deg); }
        }

        /* --- ホーム画面 --- */
        .home-circle-container {
            width: 300px;
            height: 300px;
            border: 2px solid var(--accent-red);
            border-radius: 50%;
            margin: 20px auto;
            position: relative;
            overflow: hidden;
            background: rgba(128,128,128,0.1);
        }
        .flying-paper {
            position: absolute;
            width: 30px;
            height: 60px;
            background: var(--omi-paper);
            border: 1px solid #ccc;
            opacity: 0;
            animation: paperFly 4s infinite linear;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            writing-mode: vertical-rl;
            color: #b91c1c;
        }
        @keyframes paperFly {
            0% { transform: translateY(350px) rotate(0deg); opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translateY(-50px) rotate(360deg); opacity: 0; }
        }

        /* --- おみくじ選択画面 --- */
        .omikuji-pool {
            position: relative;
            width: 100%;
            min-height: 100vh;
            overflow-y: visible;
            perspective: 1000px;
            padding-bottom: 200px;
        }
        .omikuji-stick {
            position: absolute;
            width: 50px;
            height: 140px;
            background-color: var(--omi-paper);
            border: 1px solid #ccc;
            box-shadow: 3px 3px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
            font-family: 'Zen Old Mincho', serif;
            writing-mode: vertical-rl;
            color: var(--accent-red);
            user-select: none;
            border-radius: 4px;
        }
        .omikuji-stick:hover {
            transform: scale(1.15) !important;
            z-index: 50;
            box-shadow: 0 15px 30px rgba(0,0,0,0.4);
            background-color: #fff;
        }
        @keyframes slideInRandom {
            from { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            to { opacity: 1; }
        }

        /* --- カウントダウン --- */
        #countdown-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 999;
            display: none;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 8rem;
            font-family: 'Zen Old Mincho', serif;
        }

        /* --- おみくじ結果カード (新デザイン修正版) --- */
        #result-capture-container {
            width: 600px;
            margin: 0 auto;
            position: relative;
        }
        .result-card-outer {
            width: 600px;
            min-height: 1200px;
            padding: 30px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            font-family: 'Zen Old Mincho', serif;
        }

        /* スタイル1: 大吉 (金・和紙) */
        .style-daikichi {
            background-color: #f3c845;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.25'/%3E%3C/svg%3E");
            border: 8px double #fff;
            color: #3e1e00;
        }
        .style-daikichi .accent-border { border-color: #3e1e00; }
        .style-daikichi .accent-text { color: #8a1c1c; }

        /* スタイル2: 大凶 (黒白・重厚) */
        .style-daikyo {
            background-color: #1a1a1a;
            border: 8px solid #333;
            color: #f0f0f0;
        }
        .style-daikyo .accent-border { border-color: #f0f0f0; }
        .style-daikyo .accent-text { color: #fff; }
        .style-daikyo .red-text { color: #fff !important; }

        /* スタイル3: その他 (標準) */
        .style-normal {
            background-color: #fffcf2;
            border: 8px double #b91c1c;
            color: #333;
        }
        .style-normal .accent-border { border-color: #b91c1c; }
        .style-normal .accent-text { color: #b91c1c; }

        .result-logo-area {
            text-align: center;
            margin-bottom: 10px;
        }
        .result-kamon {
            font-size: 3rem;
            margin-bottom: 5px;
        }
        .result-title-text {
            font-size: 1.5rem;
            font-weight: 900;
            letter-spacing: 0.3em;
        }
        .result-issue-num {
            font-size: 0.9rem;
            margin-bottom: 20px;
            font-family: monospace;
            opacity: 0.8;
        }
        
        .result-circle-box {
            width: 200px;
            height: 200px;
            border: 4px solid currentColor;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            background: rgba(255,255,255,0.1);
        }
        .result-kanji-main {
            font-size: 6rem;
            font-weight: 900;
            line-height: 1;
        }
        .result-label-sub {
            font-size: 1.2rem;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .result-main-message-area {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 40px;
            width: 100%;
            padding: 0 20px;
        }
        .result-poem-vertical {
            writing-mode: vertical-rl;
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 0.2em;
            line-height: 1.8;
            height: 350px;
        }
        .result-advice-box {
            writing-mode: vertical-rl;
            border: 2px solid currentColor;
            padding: 15px 10px;
            font-size: 1rem;
            line-height: 1.8;
            height: 350px;
        }
        .advice-label {
            font-weight: 900;
            border-bottom: 1px solid currentColor; /* 縦書きなので左線に見えるが実際は下 */
            margin-left: 10px;
            padding-bottom: 5px;
        }

        .result-details-grid {
            display: flex;
            flex-direction: row-reverse; /* 縦書きなので右から左へ */
            justify-content: center;
            gap: 15px;
            width: 100%;
            margin-bottom: 40px;
            border-top: 1px solid currentColor;
            border-bottom: 1px solid currentColor;
            padding: 20px 0;
        }
        .detail-column {
            writing-mode: vertical-rl;
            height: 250px;
            font-size: 1.1rem;
            line-height: 1.5;
        }
        .detail-item-label {
            font-weight: 900;
            margin-bottom: 10px;
            display: inline-block;
        }
        .detail-item-content {
            display: inline-block;
        }

        .lucky-area {
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            text-align: left;
        }
        .lucky-box, .unlucky-box {
            border: 1px solid currentColor;
            padding: 15px;
            border-radius: 8px;
        }
        .lucky-title { font-weight: bold; margin-bottom: 10px; border-bottom: 1px dashed currentColor; padding-bottom: 5px; }
        .lucky-row { font-size: 0.9rem; margin-bottom: 4px; display: flex; align-items: flex-start;}
        .lucky-icon { margin-right: 5px; min-width: 20px; text-align: center; }

        .result-footer-info {
            width: 100%;
            text-align: center;
            border-top: 2px solid currentColor;
            padding-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .result-user-name {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .result-date {
            font-size: 0.9rem;
        }
        .result-qr-container {
            background: #fff;
            padding: 5px;
        }

        /* 12星座カード */
        .ranking-card {
            border-radius: 16px; box-shadow: 0 4px 6px var(--shadow); padding: 20px;
            margin-bottom: 20px; transition: transform 0.2s, box-shadow 0.2s; position: relative;
        }
        .ranking-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px var(--shadow); }
        .rank-badge-lg { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.5rem; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); flex-shrink: 0; }
        .rank-1 { background: linear-gradient(135deg, #FFD700, #FDB931); border: 2px solid #fff; }
        .rank-2 { background: linear-gradient(135deg, #E0E0E0, #BDBDBD); }
        .rank-3 { background: linear-gradient(135deg, #CD7F32, #A0522D); }
        .rank-other { background-color: var(--card-border); color: var(--text-sub); font-size: 1.2rem; width: 50px; height: 50px; }
        .param-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--card-border); }
        .param-item { text-align: center; }
        .param-label { font-size: 0.75rem; color: var(--text-main); margin-bottom: 4px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 2px; flex-wrap: wrap; }
        .param-score-text { font-size: 0.9rem; font-weight: 900; color: var(--accent-red); }
        .param-value { font-size: 0.75rem; color: var(--text-sub); margin-bottom: 2px; }
        .score-bar-bg { width: 100%; height: 8px; background-color: var(--card-border); border-radius: 4px; margin-top: 4px; overflow: hidden; }
        .score-bar-fill { height: 100%; border-radius: 4px; }
        .fav-btn {
            position: absolute; top: 15px; right: 15px; background: none; border: none;
            font-size: 1.5rem; color: #ccc; cursor: pointer; transition: color 0.2s, transform 0.2s;
        }
        .fav-btn.active { color: #FFD700; transform: scale(1.1); }
        .fav-btn:hover { transform: scale(1.15); }
        .calendar-wrapper { margin-top: 15px; border-top: 1px dashed var(--card-border); padding-top: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 8px; }
        .calendar-cell { background-color: var(--bg-color); border-radius: 8px; padding: 4px 2px; text-align: center; min-height: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid var(--card-border); }
        .cal-date { font-size: 0.7rem; font-weight: bold; color: var(--text-sub); }
        .cal-mark { font-size: 0.7rem; margin-top: 2px; line-height: 1; }
        .calendar-legend { display: flex; justify-content: center; gap: 10px; margin-top: 8px; font-size: 0.7rem; color: var(--text-sub); flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 2px; }

        /* ビュー制御 */
        .view-section { display: none; opacity: 0; transition: opacity 0.5s; }
        .view-section.active { display: block; opacity: 1; }

        /* おみくじの轍 ぼかし制御 */
        .history-blurred {
            position: relative;
            filter: blur(8px);
            pointer-events: none;
            user-select: none;
            overflow: hidden;
            opacity: 0.7;
        }
        .history-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            text-align: center;
            border: 1px solid var(--card-border);
            width: 80%;
            max-width: 400px;
        }

        /* Labs ぼかし制御 */
        .lab-blurred {
            filter: blur(10px);
            pointer-events: none;
            user-select: none;
            opacity: 0.6;
            transition: all 0.5s;
        }
        .lab-lock-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
            border: 1px solid var(--card-border);
            width: 80%;
            max-width: 400px;
        }
        /* ダークモード時のロック画面 */
        @media (prefers-color-scheme: dark) {
            .lab-lock-overlay {
                background-color: rgba(30, 30, 30, 0.7);
            }
        }

        /* 詳細モーダル (削除予定だが互換性のために残す) */
        #history-detail-modal {
            display: none; 
        }

        /* 記事詳細 */
        .article-container {
            max-width: 800px; margin: 0 auto; padding: 40px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: left; line-height: 2;
        }
        .article-header { border-bottom: 2px solid var(--card-border); padding-bottom: 20px; margin-bottom: 30px; }
        .article-title { font-size: 1.8rem; font-weight: bold; margin-bottom: 10px; }
        .article-meta { color: var(--text-sub); font-size: 0.9rem; display: flex; gap: 15px; }
        .article-tag { background: rgba(128,128,128,0.2); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
        .article-content h3 { font-size: 1.4rem; font-weight: bold; margin: 30px 0 15px; border-left: 4px solid var(--accent-red); padding-left: 10px; }
        .article-content p { margin-bottom: 20px; }

        /* --- TENMEI Labs モダンUI用スタイル (Google Labs風) --- */
        
        /* カード全体の設定 */
        #view-lab {
            position: relative;
            border-radius: 30px;
            min-height: 85vh;
            overflow: hidden; /* はみ出た背景をカット */
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            margin-top: 20px;
            margin-bottom: 40px;
        }

        /* 1. 背景のアニメーションレイヤー */
        .lab-modern-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0;
            background-color: #f8f9fa; /* ベース色 */
        }
        .dark .lab-modern-bg { background-color: #0f0f12; }

        /* 2. 動く色の塊 (Blob) */
        .lab-blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px); /* 色をぼかす */
            opacity: 0.8;
            animation: moveBlob 15s infinite alternate ease-in-out;
        }

        /* 色と配置の定義 */
        /* ピンク */
        .blob-1 { top: -10%; left: -10%; width: 500px; height: 500px; background: #ff9a9e; animation-delay: 0s; }
        /* 紫 */
        .blob-2 { bottom: -10%; right: -10%; width: 500px; height: 500px; background: #a18cd1; animation-delay: -5s; }
        /* 薄いピンク */
        .blob-3 { top: 40%; left: 40%; width: 400px; height: 400px; background: #fbc2eb; animation-delay: -10s; }
        /* ミントグリーン */
        .blob-4 { bottom: 10%; left: 10%; width: 300px; height: 300px; background: #84fab0; animation-delay: -2s; }
        /* 青 */
        .blob-5 { top: 10%; right: 10%; width: 350px; height: 350px; background: #4facfe; animation-delay: -7s; }

        /* ダークモード時の色調整 (少し暗く・透明度下げる) */
        .dark .blob-1 { background: #5e2b30; opacity: 0.4; }
        .dark .blob-2 { background: #3b2e5a; opacity: 0.4; }
        .dark .blob-3 { background: #5a3a50; opacity: 0.4; }
        .dark .blob-4 { background: #1a4a35; opacity: 0.4; }
        .dark .blob-5 { background: #1a3a5e; opacity: 0.4; }

        /* アニメーション定義: ゆっくり動いて拡大縮小 */
        @keyframes moveBlob {
            0% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(40px, -60px) scale(1.2); }
            66% { transform: translate(-30px, 30px) scale(0.8); }
            100% { transform: translate(20px, 20px) scale(1.1); }
        }

        /* 3. コンテンツラッパー (背景の上に表示) */
        .lab-content-relative {
            position: relative;
            z-index: 10;
        }

        /* 4. 縦書き装飾テキスト */
        .lab-vertical-deco {
            position: absolute;
            top: 30px;
            left: 20px;
            writing-mode: vertical-rl;
            font-size: 4rem;
            font-weight: 900;
            color: rgba(0,0,0,0.03); /* ほぼ透明 */
            pointer-events: none;
            line-height: 1;
            font-family: 'Zen Old Mincho', serif;
            z-index: 1;
        }
        .dark .lab-vertical-deco { color: rgba(255,255,255,0.05); }

        /* 5. モダンカードスタイル */
        .lab-card-modern {
            background: rgba(255, 255, 255, 0.85); /* 半透明の白 */
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s;
            border: 1px solid rgba(255,255,255,0.6);
            display: flex;
            justify-content: space-between; /* 左右配置 */
            align-items: center;
            backdrop-filter: blur(10px); /* すりガラス効果 */
        }
        .dark .lab-card-modern {
            background: rgba(30, 30, 30, 0.8);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.05);
        }
        .lab-card-modern:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
        }

        /* ヒーローエリア (タイトル周り) */
        .lab-hero-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 60px 0 60px;
            text-align: center;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: "";
            height: 16px; width: 16px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #6366f1; } /* インディゴ系に変更 */
        input:checked + .slider:before { transform: translateX(26px); }

        /* --- TENMEI Labs: Unified Real Flask --- */

/* 1. タイトル用フラスコ (メイン) */
.title-flask-anim {
    width: 160px;
    height: 160px;
    margin: 0 auto 10px;
    /* 綺麗な発光感 */
    filter: drop-shadow(0 15px 30px rgba(120, 80, 255, 0.3));
}

/* 2. サイドバー用アイコン (左側) */
.nav-flask-anim {
    width: 32px;
    height: 32px;
    display: block;
}

/* フラスコ全体の揺れ (共通) */
.flask-container {
    transform-origin: 100px 20px; /* 首元を支点に揺れる */
    animation: flaskSwing 4s ease-in-out infinite;
}

/* 中身の液体の慣性 (共通) */
.liquid-container {
    transform-origin: 100px 150px;
    animation: liquidInertia 4s ease-in-out infinite;
}

/* 波のアニメーション */
.wave-path {
    fill: url(#gradUnified); /* 共通の鮮やかなグラデーション */
    animation: waveMove 2s linear infinite;
}

/* メイン用: 奥の波 (薄く表示して立体感を出す) */
.wave-back {
    opacity: 0.4;
    animation: waveMove 3s linear infinite reverse;
}

/* メイン用: 手前の波 (くっきり) */
.wave-front {
    opacity: 0.95;
}

/* ガラスの質感 */
.glass-stroke {
    fill: rgba(255, 255, 255, 0.05);
    stroke: #333;
    stroke-width: 6;
    stroke-linecap: round;
    stroke-linejoin: round;
}
.dark .glass-stroke { stroke: #e0e0e0; }

/* 泡 */
.bubble {
    fill: rgba(255, 255, 255, 0.5);
    animation: bubbleUp 3s ease-in infinite;
}

/* --- アニメーション定義 --- */

/* フラスコ本体の揺れ（角度を4deg→10degにアップ） */
@keyframes flaskSwing {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(10deg); }  /* 右に大きく揺れる */
    75% { transform: rotate(-10deg); } /* 左に大きく揺れる */
}

/* 中身の液体の動き（本体と逆方向に大きく傾ける） */
@keyframes liquidInertia {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(-8deg); } /* 本体が右なら、水面は左へ */
    75% { transform: rotate(8deg); }  /* 本体が左なら、水面は右へ */
}

@keyframes waveMove {
    0% { transform: translateX(0) scaleY(1); }
    50% { transform: translateX(-100px) scaleY(1.05); }
    100% { transform: translateX(-200px) scaleY(1); }
}

@keyframes bubbleUp {
    0% { transform: translateY(0) scale(0.4); opacity: 0; }
    20% { opacity: 1; }
    100% { transform: translateY(-80px) scale(1.2); opacity: 0; }
}

        /* 認証コード入力欄（和風） */
        .auth-code-input-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            position: relative;
        }
        .auth-code-input {
            width: 300px;
            height: 60px;
            font-size: 2rem;
            letter-spacing: 0.8em;
            text-align: center;
            border: 3px double var(--accent-red);
            background-color: var(--omi-paper);
            color: var(--text-main);
            font-family: 'Zen Old Mincho', serif;
            border-radius: 4px;
            outline: none;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .auth-code-input:focus {
            box-shadow: 0 0 10px rgba(185, 28, 28, 0.3);
            background-color: #fff;
        }
        .auth-code-deco {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            padding: 0 10px;
            font-size: 0.8rem;
            color: var(--accent-red);
            font-weight: bold;
        }

        /* 認証初期選択画面 */
        .auth-selection-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.3s;
            border: 1px solid var(--card-border);
            background-color: var(--card-bg);
            color: var(--text-main);
        }
        .auth-selection-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            background-color: rgba(128,128,128,0.05);
        }
        .auth-selection-btn i {
            font-size: 1.5rem;
            margin-right: 15px;
        }

        /* 検索フォームスタイル */
        .search-form-container {
            padding: 15px;
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .search-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .search-input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--card-border);
            background-color: var(--input-bg);
            color: var(--text-main);
            font-size: 0.9rem;
        }

        /* 比較表のスタイル */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.9rem;
        }
        .comparison-table th, .comparison-table td {
            border: 1px solid var(--card-border);
            padding: 12px;
            text-align: center;
        }
        .comparison-table th {
            background-color: rgba(128,128,128,0.1);
            font-weight: bold;
        }
        .comparison-table td.highlight {
            background-color: rgba(185, 28, 28, 0.05);
            font-weight: bold;
            color: var(--accent-red);
        }
        .comparison-table tr:nth-child(even) {
            background-color: rgba(128,128,128,0.02);
        }
        
        /* Labs: 言霊の増幅 (文字サイズ拡大) */
        html.lab-big-text {
            font-size: 120%; /* 基準サイズを20%アップ (rem単位の全ての文字が大きくなります) */
        }
        /* 固定ピクセル指定(text-[10px]等)も無理やり大きくする補正 */
        html.lab-big-text .text-\[10px\] { font-size: 12px !important; }

        /* --- カード展開アニメーション (Google Labs風) --- */

/* モーダルオーバーレイ */
.lab-modal-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.95);
    z-index: 2000;
    display: none; /* JSで制御 */
    opacity: 0;
    transition: opacity 0.3s ease;
    overflow-y: auto;
    padding: 20px;
    align-items: center;
    justify-content: center;
}
.dark .lab-modal-overlay { background: rgba(18, 18, 18, 0.95); }
.lab-modal-overlay.active { display: flex; opacity: 1; }

/* 展開されるカード */
.lab-modal-card {
    background: #fff;
    width: 100%;
    max-width: 600px;
    border-radius: 24px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    padding: 40px;
    position: relative;
    transform: scale(0.9);
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    border: 1px solid rgba(0,0,0,0.05);
}
.dark .lab-modal-card {
    background: #1e1e1e;
    border: 1px solid rgba(255,255,255,0.1);
}
.lab-modal-overlay.active .lab-modal-card { transform: scale(1); }

/* 閉じるボタン */
.lab-close-btn {
    position: absolute;
    top: 20px; right: 20px;
    background: #f0f0f0;
    border: none;
    width: 40px; height: 40px;
    border-radius: 50%;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.2s;
}
.dark .lab-close-btn { background: #333; color: #fff; }
.lab-close-btn:hover { background: #e0e0e0; }

/* カード自体のクリックを促すスタイル */
.lab-card-modern {
    cursor: pointer; /* クリック可能に見せる */
}

/* スイッチ部分はクリックイベントを伝播させないための調整 */
.lab-card-modern .toggle-switch {
    z-index: 5; /* カードクリックより優先 */
}
       /* --- 隠しコマンド（イースターエッグ）演出用 --- */
        #secret-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000;
            z-index: 99999; /* 最前面 */
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #0f0; /* ターミナルグリーン */
            font-family: 'Courier New', monospace;
            padding: 20px;
            overflow: hidden;
        }
        #secret-overlay.active { display: flex; }
        
        .secret-text {
            font-size: 1.2rem;
            line-height: 1.5;
            white-space: pre-wrap;
            text-align: left;
            max-width: 600px;
            width: 100%;
            margin-bottom: 20px;
            opacity: 0;
            animation: fadeInTerminal 0.1s forwards;
        }
        .secret-cursor::after {
            content: '▋';
            animation: blinkCursor 1s infinite;
        }

        @keyframes blinkCursor { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        @keyframes fadeInTerminal { from { opacity: 0; } to { opacity: 1; } } 

        /* --- TENMEI Labs: 追加機能スタイル --- */

        /* --- 幽玄の霧 (超はっきり・高密度版) --- */
        #mist-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* 下のボタンを押せるようにする */
            z-index: 500; /* 全ての要素の上に重ねる */
            opacity: 0; /* 初期は透明 */
            visibility: hidden;
            transition: opacity 2s ease, visibility 2s; /* 消える時もふわっと */
            overflow: hidden;
        }

        /* ONの時に付与されるクラス */
        #mist-container.active {
            opacity: 1;
            visibility: visible;
        }

        .mist-blob {
            position: absolute;
            width: 80%;
            height: 80%;
            background: radial-gradient(circle, 
                rgba(255, 255, 255, 0.9) 0%, 
                rgba(255, 255, 255, 0.4) 50%, 
                transparent 80%);
            filter: blur(60px);
            animation: mistRotate 30s linear infinite;
        }

        /* ダークモード時は「深い霧」にするため青白く調整 */
        .dark .mist-blob {
            background: radial-gradient(circle, 
                rgba(200, 220, 255, 0.4) 0%, 
                rgba(100, 150, 255, 0.1) 50%, 
                transparent 80%);
        }

        /* 3つの巨大な霧の塊を違う動きで回す */
        .mist-1 { top: -10%; left: -10%; animation-duration: 25s; }
        .mist-2 { bottom: -10%; right: -10%; animation-duration: 40s; animation-direction: reverse; }
        .mist-3 { top: 40%; left: 30%; animation-duration: 35s; opacity: 0.6; }

        @keyframes mistRotate {
            0% { transform: translate(0, 0) rotate(0deg) scale(1); }
            33% { transform: translate(10%, 5%) rotate(120deg) scale(1.2); }
            66% { transform: translate(-5%, 10%) rotate(240deg) scale(0.8); }
            100% { transform: translate(0, 0) rotate(360deg) scale(1); }
        }

        /* 2. 黄金の神域 (Gold Theme Override) */
        body.theme-gold {
            --accent-red: #d4af37 !important; /* ゴールド */
            --accent-gold: #b8860b !important; /* 濃い金 */
        }
        body.theme-gold .btn-primary {
            background: linear-gradient(135deg, #f1c40f, #d4af37) !important;
            color: #3e1e00 !important;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4) !important;
        }
        body.theme-gold .text-red-600, 
        body.theme-gold .text-red-700,
        body.theme-gold .text-red-500 {
            color: #b8860b !important;
        }
        body.theme-gold .border-red-500,
        body.theme-gold .border-red-600 {
            border-color: #d4af37 !important;
        }

        /* --- PDF・印刷用スタイル (ベクター出力・表見切れ防止) --- */
        @media print {
            @page {
                size: A4;
                margin: 20mm;
            }
            body {
                background: #fff !important;
                color: #000 !important;
                display: block !important;
                height: auto !important;
                overflow: visible !important;
            }
            /* 不要な要素を消す */
            #sidebar, #mist-container, #loading-overlay, 
            .nav-btn, .btn-primary, .btn-outline, 
            #about-toc-container, #privacy-toc-container,
            #result-capture-container, button {
                display: none !important;
            }
            /* メインコンテンツの調整 */
            #main-content {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
            }
            .view-section {
                display: none !important; /* 一旦全部消す */
            }
            /* 印刷対象のセクションだけ表示 */
            .view-section.printing {
                display: block !important;
                opacity: 1 !important;
            }
            
            /* カードの枠などを消して文書らしくする */
            .themed-card {
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                background: transparent !important;
                color: #000 !important;
            }
            
            /* 表の見切れ防止・最適化 */
            .overflow-x-auto {
                overflow: visible !important;
                display: block !important;
                width: 100% !important;
            }
            table, .comparison-table {
                width: 100% !important;
                min-width: 0 !important; /* 横幅強制解除 */
                table-layout: fixed !important; /* 列幅を均等または指定通りに */
                border-collapse: collapse !important;
                font-size: 8pt !important; /* 表の文字を少し小さくして収める */
                page-break-inside: auto;
            }
            tr { 
                page-break-inside: avoid; 
                page-break-after: auto; 
            }
            th, td {
                border: 1px solid #000 !important; /* 枠線を黒く鮮明に */
                padding: 4px !important;
                color: #000 !important;
                word-wrap: break-word !important; /* 長い文字を折り返す */
                white-space: normal !important; /* 改行を許可 */
            }
            /* 背景色があるセル */
            .bg-gray-200, .bg-gray-50, .bg-red-100 {
                background-color: #f0f0f0 !important; /* 薄いグレーに統一 */
                -webkit-print-color-adjust: exact; /* 背景色を強制印刷 */
                print-color-adjust: exact;
            }
            /* リンクのURL表示を消す */
            a[href]:after {
                content: none !important;
            }
            /* テキスト調整 */
            h2, h3, h4 {
                page-break-after: avoid;
                color: #000 !important;
                border-bottom: 1px solid #000 !important;
            }
            p, li {
                color: #000 !important;
            }
        }

    </style>
</head>
<body>

    <!-- 幽玄の霧コンテナ (高密度版) -->
    <div id="mist-container">
        <div class="mist-blob mist-1"></div>
        <div class="mist-blob mist-2"></div>
        <div class="mist-blob mist-3"></div>
    </div>

    <!-- ローディングスピナー (SVG版) -->
    <div id="loading-overlay">
        <svg class="loader-svg" viewBox="0 0 50 50">
            <circle class="loader-path" cx="25" cy="25" r="20" fill="none" stroke-width="1.5"></circle>
        </svg>
    </div>

    <!-- サイドバー -->
    <nav id="sidebar">
        <button class="nav-btn" onclick="showView('home')">
            <i class="bi bi-house-door"></i>
            <span class="nav-text">ホーム</span>
        </button>
        <button class="nav-btn" onclick="showView('zodiac')">
            <i class="bi bi-stars"></i>
            <span class="nav-text">12星座×血液型占い</span>
        </button>
        <button class="nav-btn" onclick="showView('history')">
            <i class="bi bi-clock-history"></i>
            <span class="nav-text">おみくじの轍</span>
        </button>
        <button class="nav-btn" onclick="showView('news')">
            <i class="bi bi-bell"></i>
            <span class="nav-text">社務所だより</span>
        </button>
        <button class="nav-btn" onclick="showView('column')">
            <i class="bi bi-book"></i>
            <span class="nav-text">神籤草子</span>
        </button>
        <!-- サイドバーボタン: TENMEI Labs -->
        <button class="nav-btn" onclick="showView('lab')">
            <div class="nav-flask-anim">
                <svg viewBox="0 0 200 200" overflow="hidden" style="width:100%; height:100%;">
                    <defs>
                        <clipPath id="flaskClipNav">
                             <path d="M80 20 L120 20 L120 70 L170 170 C175 180, 165 190, 150 190 L50 190 C35 190, 25 180, 30 170 L80 70 Z" />
                        </clipPath>
                    </defs>
                    <g class="flask-container">
                        <g clip-path="url(#flaskClipNav)">
                            <g class="liquid-container">
                                <!-- サイドバーは視認性重視で手前の波のみ表示 -->
                                <path class="wave-path wave-front" 
                                      d="M0 120 Q50 140 100 120 T200 120 T300 120 T400 120 V250 H0 Z" />
                            </g>
                        </g>
                        <!-- ガラス容器 -->
                        <path class="glass-stroke" fill="none" stroke-width="12"
                              d="M80 20 L120 20 L120 70 L170 170 C175 180, 165 190, 150 190 L50 190 C35 190, 25 180, 30 170 L80 70 Z" />
                    </g>
                </svg>
            </div>
            <span class="nav-text">TENMEI Labs</span>
        </button>

        <button class="nav-btn" onclick="showView('prefecture')">
            <i class="bi bi-list-columns-reverse"></i>
            <span class="nav-text">全国の運気</span>
        </button>
        
        <button class="nav-btn" onclick="handleProfileClick()" id="nav-login-btn">
            <i class="bi bi-person-circle"></i>
            <span class="nav-text">ログイン/登録</span>
        </button>
        
        <div style="margin-top: auto; width: 100%;">
            <button class="nav-btn" onclick="showView('about')">
                <i class="bi bi-info-circle"></i>
                <span class="nav-text">当サイトについて</span>
            </button>
            <button class="nav-btn" onclick="showView('privacy')">
                <i class="bi bi-shield-lock"></i>
                <span class="nav-text">プライバシー</span>
            </button>
        </div>
    </nav>

    <!-- メインエリア -->
    <main id="main-content">
        
        <!-- ビュー: ホーム -->
        <section id="view-home" class="view-section active text-center max-w-4xl mx-auto">
            <h1 class="text-4xl font-black mb-2 tracking-widest" style="font-family: 'Zen Old Mincho'">運勢・天命乃杜</h1>
            <p class="text-sm font-serif mb-4 tracking-widest uppercase">FORTUNE TENMEI-NO-MORI</p>
            <p class="text-lg font-serif mb-8 themed-text-sub">天命が導く、日々の道しるべ<br>災いを避け、福を招く</p>

            <div class="home-circle-container" id="home-anim-container">
                <!-- JSで紙を生成 -->
            </div>

            <button onclick="startOmikuji()" class="btn-primary text-xl px-12 py-4 mb-8">
                <i class="bi bi-box-seam-fill"></i> おみくじを引く
            </button>

            <!-- カウンター -->
            <div id="home-counter-area" class="themed-card p-4 rounded-lg mb-2">
                <p class="text-sm themed-text-sub">累計発行本数</p>
                <div class="text-3xl font-bold font-mono text-red-700" id="live-counter">---</div>
                <!-- ▼ ここを修正: (5秒毎更新) → (1分毎更新) -->
                <p class="text-xs themed-text-sub mt-1">最終更新: <span id="counter-time">--:--:--</span> (1分毎更新)</p>
                <p class="text-[10px] themed-text-sub mt-1">※会員様の祈りの数のみが反映されます</p>
            </div>

            <!-- ダッシュボード風グリッド -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-12 text-left">
                <!-- 轍 (統計) -->
                <div class="themed-card p-6 rounded-xl shadow-sm">
                    <h3 class="font-bold text-lg mb-2 border-b border-gray-300 dark:border-gray-600 pb-2"><i class="bi bi-balloon-heart text-red-500"></i> おみくじの轍</h3>
                    <div class="text-xs text-right mb-2 themed-text-sub">更新: <span id="stats-update-time">--:--:--</span></div>
                    
                    <div class="space-y-3 mb-4 text-sm" id="home-history-stats">
                         <!-- 12段階 統計表示 -->
                         <div class="grid grid-cols-1 gap-2">
                             <!-- 大吉 -->
                             <div class="flex justify-between text-xs"><span>大吉</span><span><span id="cnt-daikichi" class="mr-2 font-mono">0</span><span id="stat-daikichi">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-daikichi" class="bg-yellow-400 h-1.5 rounded" style="width: 0%"></div></div>
                             
                             <!-- 中吉 -->
                             <div class="flex justify-between text-xs"><span>中吉</span><span><span id="cnt-chukichi" class="mr-2 font-mono">0</span><span id="stat-chukichi">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-chukichi" class="bg-orange-400 h-1.5 rounded" style="width: 0%"></div></div>

                             <!-- 小吉 -->
                             <div class="flex justify-between text-xs"><span>小吉</span><span><span id="cnt-shokichi" class="mr-2 font-mono">0</span><span id="stat-shokichi">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-shokichi" class="bg-green-400 h-1.5 rounded" style="width: 0%"></div></div>

                             <!-- 吉 -->
                             <div class="flex justify-between text-xs"><span>吉</span><span><span id="cnt-kichi" class="mr-2 font-mono">0</span><span id="stat-kichi">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-kichi" class="bg-red-400 h-1.5 rounded" style="width: 0%"></div></div>

                             <!-- 半吉 -->
                             <div class="flex justify-between text-xs"><span>半吉</span><span><span id="cnt-hankichi" class="mr-2 font-mono">0</span><span id="stat-hankichi">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-hankichi" class="bg-red-300 h-1.5 rounded" style="width: 0%"></div></div>

                             <!-- 末吉 -->
                             <div class="flex justify-between text-xs"><span>末吉</span><span><span id="cnt-suekichi" class="mr-2 font-mono">0</span><span id="stat-suekichi">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-suekichi" class="bg-blue-400 h-1.5 rounded" style="width: 0%"></div></div>

                             <!-- 末小吉 -->
                             <div class="flex justify-between text-xs"><span>末小吉</span><span><span id="cnt-sueshokichi" class="mr-2 font-mono">0</span><span id="stat-sueshokichi">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-sueshokichi" class="bg-blue-300 h-1.5 rounded" style="width: 0%"></div></div>

                             <!-- 凶 -->
                             <div class="flex justify-between text-xs"><span>凶</span><span><span id="cnt-kyo" class="mr-2 font-mono">0</span><span id="stat-kyo">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-kyo" class="bg-gray-400 h-1.5 rounded" style="width: 0%"></div></div>

                             <!-- 小凶 -->
                             <div class="flex justify-between text-xs"><span>小凶</span><span><span id="cnt-shokyo" class="mr-2 font-mono">0</span><span id="stat-shokyo">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-shokyo" class="bg-gray-500 h-1.5 rounded" style="width: 0%"></div></div>

                             <!-- 半凶 -->
                             <div class="flex justify-between text-xs"><span>半凶</span><span><span id="cnt-hankyo" class="mr-2 font-mono">0</span><span id="stat-hankyo">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1">
                                 <!-- ▼ 修正箇所: dark:bg-gray-400 を追加 -->
                                 <div id="bar-hankyo" class="bg-gray-600 dark:bg-gray-400 h-1.5 rounded" style="width: 0%"></div>
                             </div>

                             <!-- 末凶 -->
                             <div class="flex justify-between text-xs"><span>末凶</span><span><span id="cnt-suekyo" class="mr-2 font-mono">0</span><span id="stat-suekyo">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-suekyo" class="bg-gray-700 h-1.5 rounded" style="width: 0%"></div></div>

                             <!-- 大凶 -->
                             <div class="flex justify-between text-xs"><span>大凶</span><span><span id="cnt-daikyo" class="mr-2 font-mono">0</span><span id="stat-daikyo">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-daikyo" class="bg-black h-1.5 rounded" style="width: 0%"></div></div>
                         </div>
                    </div>
                    <button onclick="showView('history')" class="text-sm text-red-600 hover:underline">おみくじの轍をもっと見る (全運勢ログ)</button>
                </div>

                <!-- お知らせ (自動生成対応) -->
                <div class="themed-card p-6 rounded-xl shadow-sm">
                    <h3 class="font-bold text-lg mb-2 border-b border-gray-300 dark:border-gray-600 pb-2"><i class="bi bi-megaphone text-blue-500"></i> 社務所だより</h3>
                    <ul class="text-sm space-y-2 mb-4" id="home-news-list">
                        <!-- JSで自動挿入されます -->
                    </ul>
                    <button onclick="showView('news')" class="text-sm text-blue-600 hover:underline">社務所だよりをもっと見る</button>
                </div>

                <!-- コラム (自動生成対応) -->
                <div class="themed-card p-6 rounded-xl shadow-sm">
                    <h3 class="font-bold text-lg mb-2 border-b border-gray-300 dark:border-gray-600 pb-2"><i class="bi bi-book text-green-500"></i> 神籤草子 (コラム)</h3>
                    <ul class="text-sm space-y-2 mb-4" id="home-column-list">
                        <!-- JSで自動挿入されます -->
                    </ul>
                    <button onclick="showView('column')" class="text-sm text-green-600 hover:underline">神籤草子をもっと見る</button>
                </div>
            </div>
        </section>

        <!-- ビュー: おみくじ選択 -->
        <section id="view-draw" class="view-section relative min-h-screen w-full overflow-hidden" style="overflow-y: auto !important;">
            <h2 class="text-center text-2xl font-bold mb-4 z-10 relative mt-10">直感で一枚お選びください</h2>
            <div id="omikuji-pool" class="omikuji-pool"></div>
            <div class="fixed bottom-10 left-0 w-full text-center z-50 pointer-events-none">
                <button onclick="addOmikuji()" class="btn-primary pointer-events-auto shadow-xl">
                    <i class="bi bi-plus-lg"></i> もっとおみくじを探す
                </button>
            </div>
        </section>

        <!-- ビュー: おみくじ結果 -->
        <section id="view-result" class="view-section text-center">
            <div id="result-display-area" class="py-10">
                <!-- ここを書き換えてください -->
<div style="display: flex; justify-content: flex-start; overflow-x: auto; -webkit-overflow-scrolling: touch; padding: 0 10px;">
    <div id="result-capture-container">
                        <!-- 結果カード (JSで動的生成) -->
                        <div class="result-card-outer" id="result-card-outer"></div>
                    </div>
                </div>

                <!-- アクションボタンエリア -->
                <div class="max-w-xl mx-auto mt-8 p-4 themed-card rounded-lg shadow space-y-4">
                    <p class="font-bold">結果をシェアする</p>
                    
                    <button onclick="generateResultImage()" class="btn-outline w-full justify-center">
                        <i class="bi bi-download"></i> 画像を保存する
                    </button>
                    
                    <div id="gen-img-status" class="text-sm themed-text-sub"></div>
                    <div id="generated-image-container" class="hidden">
                        <p class="text-green-600 font-bold mb-2">画像の生成完了</p>
                        <!-- 生成画像 -->
                    </div>

                    <!-- index.html 内の view-result セクションにあるシェアボタンエリア -->

<div class="flex flex-col gap-3 mt-4">
    <!-- 追加・修正: 全SNS対応の注意書き -->
    <p class="text-xs text-red-600 dark:text-red-400 font-bold text-center border border-red-200 dark:border-red-900 bg-red-50 dark:bg-red-900/20 p-2 rounded">
        ※X, Bluesky, Misskey等への投稿時、画像は自動添付されません。<br>
        ボタンを押すと画像が端末に保存されますので、<br>開いた投稿画面で手動で添付してください。
    </p>

    <button onclick="shareToX()" class="bg-black text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:opacity-80">
        <i class="bi bi-twitter-x"></i> Xでシェア (画像を保存して投稿)
    </button>
    <button onclick="shareToFB()" class="bg-blue-600 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:opacity-80">
        <i class="bi bi-facebook"></i> Facebookでシェア
    </button>
    <button onclick="shareToLine()" class="bg-green-500 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:opacity-80">
        <i class="bi bi-line"></i> LINEでシェア
    </button>
    <!-- Blueskyでシェア (公式ロゴSVG) -->
    <button onclick="shareToBluesky()" class="bg-blue-500 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:opacity-80">
        <!-- Bluesky Butterfly Icon -->
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 600 530">
            <path d="M135.72 44.03c66.496 49.921 138.02 151.14 164.28 205.46 26.262-54.316 97.782-155.54 164.28-205.46 47.98-36.021 125.72-63.892 125.72 24.317 0 59.31-21.66 205.49-51.942 258.85-39.826 70.198-111.2 30.083-161.01-12.506 39.998 52.346 42.422 133.55-23.731 133.55-58.261 0-77.921-27.995-77.31-79.626 2.593-219.06-189.28-169.87-192.31-169.87-2.917 0-3.666-51.059-3.666-87.876 0-87.653 76.789-58.86 125.69-22.349z"/>
        </svg>
        Blueskyでシェア
    </button>
    <!-- Misskey.ioでシェア (公式ロゴ風SVG) -->
    <button onclick="shareToMisskey()" class="bg-lime-600 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:opacity-80">
        <!-- Misskey Icon -->
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.669 4.382c.074.225.137.458.19.697a4.67 4.67 0 0 1 .066.727c0 .193-.01.383-.028.57a3.86 3.86 0 0 1-.09.53 4.2 4.2 0 0 1-.72 1.621 3.96 3.96 0 0 1-.397.47c-.126.13-.263.25-.408.36-.146.113-.301.214-.465.304-.326.179-.675.316-1.038.406-.364.09-.74.136-1.119.136a4.7 4.7 0 0 1-1.12-.136 4.3 4.3 0 0 1-1.037-.406 4.1 4.1 0 0 1-.465-.304 3.9 3.9 0 0 1-.409-.36 4 4 0 0 1-.396-.47 4.2 4.2 0 0 1-.72-1.62 3.86 3.86 0 0 1-.09-.531 4.7 4.7 0 0 1-.028-.57c0-.246.022-.49.065-.727.054-.24.117-.472.19-.697A8 8 0 0 0 8 4.382z"/>
        </svg>
        Misskey.ioでシェア
    </button>
</div>
                    <div class="mt-4">
                        <button onclick="showView('home')" class="text-sm underline text-gray-500">ホームに戻る</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ビュー: 12星座×血液型占い -->
        <section id="view-zodiac" class="view-section">
             <div class="text-center mb-8">
                <h2 class="text-2xl font-bold mb-2 flex items-center justify-center gap-2">
                    <i class="bi bi-trophy-fill text-yellow-500"></i> 最強運勢ランキング
                </h2>
                <p class="text-lg font-serif" id="current-date-display"></p>
            </div>
    
            <!-- お気に入りセクション -->
            <div id="favorites-section" class="hidden w-full mb-8 max-w-3xl mx-auto">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i class="bi bi-star-fill text-yellow-400"></i> お気に入り (最大5件)
                    <span id="fav-status-badge" class="text-xs ml-2 px-2 py-1 rounded bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300"></span>
                </h3>
                <div id="favorites-list" class="space-y-4"></div>
                <hr class="my-6 border-gray-300 dark:border-gray-600">
            </div>
    
            <div class="themed-card backdrop-blur-sm p-6 rounded-xl shadow-sm border mb-8 max-w-xl mx-auto">
                <h3 class="font-bold text-lg mb-4 text-center">あなたの順位をチェック</h3>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <select id="user-sign" class="p-2 border rounded-md themed-input">
                        <option value="aries">牡羊座 (3/21-4/19)</option>
                        <option value="taurus">牡牛座 (4/20-5/20)</option>
                        <option value="gemini">双子座 (5/21-6/21)</option>
                        <option value="cancer">蟹座 (6/22-7/22)</option>
                        <option value="leo">獅子座 (7/23-8/22)</option>
                        <option value="virgo">乙女座 (8/23-9/22)</option>
                        <option value="libra">天秤座 (9/23-10/23)</option>
                        <option value="scorpio">蠍座 (10/24-11/22)</option>
                        <option value="sagittarius">射手座 (11/23-12/21)</option>
                        <option value="capricorn">山羊座 (12/22-1/19)</option>
                        <option value="aquarius">水瓶座 (1/20-2/18)</option>
                        <option value="pisces">魚座 (2/19-3/20)</option>
                    </select>
                    <select id="user-blood" class="p-2 border rounded-md themed-input">
                        <option value="A">A型</option>
                        <option value="B">B型</option>
                        <option value="O">O型</option>
                        <option value="AB">AB型</option>
                    </select>
                    <button onclick="findMyRank()" class="btn-primary text-sm py-2 px-6">
                        <i class="bi bi-search"></i> 判定
                    </button>
                </div>
                <div id="my-rank-result" class="mt-6 hidden pt-4 border-t border-gray-300 dark:border-gray-600"></div>
            </div>
    
            <div id="ranking-list" class="space-y-4 max-w-3xl mx-auto"></div>
            
            <div class="text-center mt-6 mb-10">
                <button onclick="showFullRanking()" class="text-sm underline hover:opacity-80 flex items-center justify-center gap-1 mx-auto themed-text-sub">
                    <i class="bi bi-list-ol"></i> <span id="show-ranking-text">4位以下を見る</span>
                </button>
            </div>
            <div id="full-ranking-list" class="space-y-4 mt-4 hidden max-w-3xl mx-auto"></div>
        </section>

        <!-- ビュー: TENMEI Labs (動画風モダンUI版) -->
        <section id="view-lab" class="view-section max-w-4xl mx-auto">
            
            <!-- 1. 背景アニメーションレイヤー -->
            <div class="lab-modern-bg">
                <div class="lab-blob blob-1"></div>
                <div class="lab-blob blob-2"></div>
                <div class="lab-blob blob-3"></div>
                <div class="lab-blob blob-4"></div>
                <div class="lab-blob blob-5"></div>
            </div>

            <!-- 2. 装飾テキスト (背景の巨大文字) -->
            <div class="lab-vertical-deco">天命実験室</div>

            <!-- 3. コンテンツレイヤー (背景の上に表示) -->
            <div class="lab-content-relative p-6 md:p-12">
                
                <!-- ヒーローエリア (タイトル) -->
                <div class="lab-hero-area">
                   
                   <!-- メインフラスコ (奥の波を削除し、サイドバーと完全統一) -->
                    <div class="title-flask-anim mb-6 transform scale-110">
                        <svg viewBox="0 0 200 200" overflow="hidden" style="width:100%; height:100%;">
                            <defs>
                                <!-- 共通の鮮やかなグラデーション (青→紫) -->
                                <linearGradient id="gradUnified" x1="0%" y1="100%" x2="100%" y2="0%">
                                    <stop offset="0%" stop-color="#4facfe" />
                                    <stop offset="100%" stop-color="#8e2de2" />
                                </linearGradient>
                                
                                <!-- 三角フラスコのマスク形状 -->
                                <clipPath id="flaskClipMain">
                                    <path d="M80 20 L120 20 L120 70 L170 170 C175 180, 165 190, 150 190 L50 190 C35 190, 25 180, 30 170 L80 70 Z" />
                                </clipPath>
                            </defs>

                            <!-- 揺れる本体 -->
                            <g class="flask-container">
                                
                                <!-- 液体レイヤー -->
                                <g clip-path="url(#flaskClipMain)">
                                    <g class="liquid-container">
                                        <!-- 背景 (薄いガラス色) -->
                                        <rect x="-50" y="-50" width="300" height="300" fill="rgba(255,255,255,0.05)" />

                                        <!-- 手前の波 (これ1つだけにしました) -->
                                        <path class="wave-path wave-front" 
                                              d="M0 135 Q50 150 100 135 T200 135 T300 135 T400 135 V250 H0 Z" />
                                        
                                        <!-- 泡 -->
                                        <circle class="bubble" cx="100" cy="180" r="4" style="animation-delay:0s" />
                                        <circle class="bubble" cx="60" cy="170" r="3" style="animation-delay:1s" />
                                        <circle class="bubble" cx="140" cy="175" r="5" style="animation-delay:2s" />
                                    </g>
                                </g>

                                <!-- ガラス容器 (三角) -->
                                <path class="glass-stroke" fill="none" 
                                      d="M80 20 L120 20 L120 70 L170 170 C175 180, 165 190, 150 190 L50 190 C35 190, 25 180, 30 170 L80 70 Z" />
                                
                                <!-- ハイライト -->
                                <path d="M45 170 L75 80" stroke="rgba(255,255,255,0.3)" stroke-width="4" fill="none" />
                            </g>
                        </svg>
                    </div>
                    <h2 class="text-3xl md:text-5xl font-black mb-4 tracking-tight text-gray-800 dark:text-white" style="font-family: 'Shippori Mincho', serif;">
                        未来の運勢を<br>試してみる
                    </h2>
                    <p class="text-gray-600 dark:text-gray-300 font-bold text-sm md:text-base max-w-lg mx-auto leading-relaxed">
                        TENMEI Labsへようこそ。<br>ここでは開発中の実験的な機能を先行して体験できます。<br>スイッチをONにして、新しい参拝の形を探求しましょう。
                    </p>
                </div>

                <!-- 機能カードリスト (ぼかし対象ラッパー) -->
                <div id="lab-content-wrapper" class="max-w-2xl mx-auto space-y-6 pb-20">
                    <div id="lab-container">
                        
                        <!-- カード 1: 迎春・雅 -->
                        <div class="lab-card-modern" onclick="TenmeiLab.openModal('newyear')">
                            <div class="flex items-center gap-5 pointer-events-none">
                                <div class="w-14 h-14 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center text-2xl flex-shrink-0 shadow-sm">
                                    <i class="bi bi-flower1"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg text-gray-800 dark:text-white">迎春・雅モード</h3>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 font-bold">サイト全体を紅白と金色の雅な装いに変更します。</p>
                                </div>
                            </div>
                            <label class="toggle-switch flex-shrink-0 ml-4" onclick="event.stopPropagation()">
                                <input type="checkbox" onchange="TenmeiLab.toggleNewYear(this)" id="switch-newyear">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <!-- カード 2: 神速の祈り -->
                        <div class="lab-card-modern" onclick="TenmeiLab.openModal('speed')">
                            <div class="flex items-center gap-5 pointer-events-none">
                                <div class="w-14 h-14 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-2xl flex-shrink-0 shadow-sm">
                                    <i class="bi bi-lightning-charge-fill"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg text-gray-800 dark:text-white">神速の祈り</h3>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 font-bold">3秒間のカウントダウンを省略し、結果をより素早く表示します。</p>
                                </div>
                            </div>
                            <label class="toggle-switch flex-shrink-0 ml-4" onclick="event.stopPropagation()">
                                <input type="checkbox" onchange="TenmeiLab.toggleSpeed(this)" id="switch-speed">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <!-- カード 3: 宵闇の刻 -->
                        <div class="lab-card-modern" onclick="TenmeiLab.openModal('dark')">
                            <div class="flex items-center gap-5 pointer-events-none">
                                <div class="w-14 h-14 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-2xl flex-shrink-0 shadow-sm">
                                    <i class="bi bi-moon-stars-fill"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg text-gray-800 dark:text-white">宵闇の刻</h3>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 font-bold">常にダークモードを強制適用し、夜の雰囲気を演出します。</p>
                                </div>
                            </div>
                            <label class="toggle-switch flex-shrink-0 ml-4" onclick="event.stopPropagation()">
                                <input type="checkbox" onchange="TenmeiLab.toggleDark(this)" id="switch-dark">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <!-- カード 4: 言霊の増幅 -->
                        <div class="lab-card-modern" onclick="TenmeiLab.openModal('bigtext')">
                            <div class="flex items-center gap-5 pointer-events-none">
                                <div class="w-14 h-14 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-2xl flex-shrink-0 shadow-sm">
                                    <i class="bi bi-type-h1"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg text-gray-800 dark:text-white">言霊の増幅</h3>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 font-bold">文字サイズを大きくし、神託を読みやすくします。</p>
                                </div>
                            </div>
                            <label class="toggle-switch flex-shrink-0 ml-4" onclick="event.stopPropagation()">
                                <input type="checkbox" onchange="TenmeiLab.toggleBigText(this)" id="switch-bigtext">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <!-- 追加カード 5: 幽玄の霧 -->
                        <div class="lab-card-modern" onclick="TenmeiLab.openModal('mist')">
                            <div class="flex items-center gap-5 pointer-events-none">
                                <div class="w-14 h-14 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center text-2xl flex-shrink-0 shadow-sm">
                                    <i class="bi bi-cloud-haze2-fill"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg text-gray-800 dark:text-white">幽玄の霧</h3>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 font-bold">画面に神秘的な霧を漂わせ、杜の臨場感を高めます。</p>
                                </div>
                            </div>
                            <label class="toggle-switch flex-shrink-0 ml-4" onclick="event.stopPropagation()">
                                <input type="checkbox" onchange="TenmeiLab.toggleMist(this)" id="switch-mist">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <!-- 追加カード 6: 黄金の神域 -->
                        <div class="lab-card-modern" onclick="TenmeiLab.openModal('gold')">
                            <div class="flex items-center gap-5 pointer-events-none">
                                <div class="w-14 h-14 rounded-full bg-yellow-50 text-yellow-500 flex items-center justify-center text-2xl flex-shrink-0 shadow-sm border border-yellow-200">
                                    <i class="bi bi-stars"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg text-gray-800 dark:text-white">黄金の神域</h3>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 font-bold">サイトのアクセントカラーを「紅」から「黄金」へ変更します。</p>
                                </div>
                            </div>
                            <label class="toggle-switch flex-shrink-0 ml-4" onclick="event.stopPropagation()">
                                <input type="checkbox" onchange="TenmeiLab.toggleGold(this)" id="switch-gold">
                                <span class="slider"></span>
                            </label>
                        </div>

                    </div>
                </div>
            </div>

            <!-- 非ログイン時のロックオーバーレイ (ぼかしの上に表示) -->
            <div id="lab-lock" class="lab-lock-overlay hidden flex items-center justify-center">
                <div class="bg-white/90 dark:bg-black/80 backdrop-blur-xl p-8 rounded-2xl shadow-2xl max-w-sm w-full border border-gray-100 dark:border-gray-800 text-center mx-4">
                    <i class="bi bi-lock-fill text-5xl text-indigo-500 mb-4 block"></i>
                    <h3 class="text-xl font-bold mb-2">会員限定エリア</h3>
                    <p class="text-sm text-gray-500 mb-6 leading-relaxed">ここから先は会員様のみが入室できる<br>天命実験室（Labs）です。</p>
                    <button onclick="showView('auth')" class="btn-primary w-full shadow-lg py-3">ログインして入室</button>
                </div>
            </div>
            <!-- 詳細モーダル (全画面オーバーレイ) -->
    <div id="lab-modal" class="lab-modal-overlay" onclick="TenmeiLab.closeModal(event)">
        <div class="lab-modal-card" onclick="event.stopPropagation()">
            <button class="lab-close-btn" onclick="TenmeiLab.closeModal(null)"><i class="bi bi-x-lg"></i></button>
            <div id="lab-modal-content">
                <!-- JSでコンテンツ挿入 -->
            </div>
        </div>
    </div>
        </section>

        <!-- ビュー: 都道府県別・運気ランキング -->
        <section id="view-prefecture" class="view-section">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold mb-2 flex items-center justify-center gap-2">
                        <i class="bi bi-geo-alt-fill text-red-600"></i> 全国・土地の運気ランキング
                    </h2>
                    <p class="text-sm themed-text-sub">
                        日本時間 0:00 更新<br>
                        47都道府県の「地の利」を数値化し、ランキング形式で発表します。<br>
                        スコアが高いほど、その土地には良質なエネルギーが満ちています。
                    </p>
                    <p class="text-lg font-serif mt-2 font-bold" id="pref-date-display">---</p>
                </div>

                <!-- ランキングリスト -->
                <div id="prefecture-list" class="space-y-4">
                    <!-- JSで47件自動生成 -->
                </div>
            </div>
        </section>

        <!-- ビュー: ログイン/登録 (新フロー: 選択 -> 入力 -> 認証) -->
        <section id="view-auth" class="view-section max-w-md mx-auto themed-card p-8 rounded-xl shadow-lg mt-10">
            <h2 class="text-2xl font-bold mb-8 text-center">アカウント認証</h2>
            
            <!-- 初期選択画面 -->
            <div id="auth-selection">
                <div class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 text-sm text-red-700 dark:text-red-300 border border-red-200 dark:border-red-800 rounded">
                    <h4 class="font-bold mb-2"><i class="bi bi-unlock-fill mr-1"></i> 会員特典</h4>
                    <ul class="list-disc list-inside space-y-1 text-xs">
                        <li>おみくじの轍（履歴）の完全閲覧＆保存</li>
                        <li>TENMEI Labs（実験機能）の利用権</li>
                        <li>累計発行本数カウンターへの貢献</li>
                    </ul>
                </div>

                <button class="auth-selection-btn" onclick="startAuthFlow('login')">
                    <i class="bi bi-box-arrow-in-right text-blue-500"></i> ログイン
                </button>
                <button class="auth-selection-btn" onclick="startAuthFlow('register')">
                    <i class="bi bi-person-plus text-green-500"></i> 新規登録
                </button>
            </div>

            <!-- ステップ1: メール/パスワード入力 -->
            <div id="auth-step-1" class="hidden">
                <div class="flex items-center mb-6">
                    <button onclick="backToAuthSelection()" class="text-gray-500 hover:text-gray-800 mr-4">
                        <i class="bi bi-arrow-left text-xl"></i>
                    </button>
                    <h3 class="font-bold text-lg" id="auth-form-title">ログイン</h3>
                </div>

                <div id="form-login-fields" class="hidden">
                    <label class="block mb-2 font-bold text-sm">メールアドレス</label>
                    <input type="email" id="login-email" placeholder="example@email.com" class="w-full p-3 border rounded mb-4 themed-input">
                    <label class="block mb-2 font-bold text-sm">パスワード</label>
                    <input type="password" id="login-password" placeholder="********" class="w-full p-3 border rounded mb-4 themed-input">
                    <button onclick="initiateAuth('login')" class="btn-primary w-full justify-center">
                        <i class="bi bi-send"></i> 認証コードを送信
                    </button>
                </div>

                <div id="form-register-fields" class="hidden">
                    <label class="block mb-2 font-bold text-sm">ユーザー名</label>
                    <input type="text" id="reg-username" placeholder="天命 太郎" class="w-full p-3 border rounded mb-4 themed-input">
                    <label class="block mb-2 font-bold text-sm">メールアドレス</label>
                    <input type="email" id="reg-email" placeholder="example@email.com" class="w-full p-3 border rounded mb-4 themed-input">
                    <label class="block mb-2 font-bold text-sm">パスワード</label>
                    <input type="password" id="reg-password" placeholder="********" class="w-full p-3 border rounded mb-4 themed-input">
                    <button onclick="initiateAuth('register')" class="btn-primary w-full justify-center">
                        <i class="bi bi-send"></i> 認証コードを送信
                    </button>
                </div>
            </div>

            <!-- ステップ2: 認証コード入力 (和風デザイン) -->
            <div id="auth-step-2" class="hidden text-center">
                <div class="mb-4">
                    <i class="bi bi-envelope-check text-4xl text-red-500"></i>
                </div>
                <p class="mb-2 font-bold">認証コードを入力してください</p>
                <p class="text-xs text-gray-500 mb-6">メールアドレスに送信された6桁の数字を入力し、認証を完了させてください。</p>
                
                <div class="auth-code-input-container">
                    <div class="auth-code-deco">天命認証符</div>
                    <input type="text" id="auth-code-input" maxlength="6" class="auth-code-input" placeholder="123456" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                </div>

                <button onclick="finalizeAuth()" class="btn-primary w-full justify-center mb-3">
                    <i class="bi bi-check-circle-fill"></i> 認証完了
                </button>
                <button onclick="backToAuthStep1()" class="text-sm underline text-gray-500">
                    戻る
                </button>
            </div>
        </section>

        <!-- ビュー: プロフィール -->
        <section id="view-profile" class="view-section max-w-md mx-auto themed-card p-8 rounded-xl shadow-lg mt-10">
            <h2 class="text-2xl font-bold mb-6 text-center">会員情報</h2>
            
            <div class="mb-6 border-b pb-4">
                <p class="text-sm themed-text-sub">現在のユーザー名</p>
                <p class="text-xl font-bold" id="profile-current-username">---</p>
                <p class="text-sm themed-text-sub mt-2">メールアドレス</p>
                <p class="text-lg" id="profile-current-email">---</p>
            </div>

            <div class="space-y-4">
                <h3 class="font-bold border-l-4 border-red-500 pl-2">情報変更</h3>
                <div>
                    <label class="block text-sm">新しいユーザー名 (変更する場合のみ)</label>
                    <input type="text" id="profile-new-username" class="w-full p-2 border rounded themed-input">
                </div>
                <div>
                    <label class="block text-sm">新しいパスワード (変更する場合のみ)</label>
                    <input type="password" id="profile-new-password" class="w-full p-2 border rounded themed-input">
                </div>
                <button onclick="updateProfile()" class="btn-primary w-full justify-center py-2 text-sm">変更を保存</button>
            </div>

            <div class="mt-10 border-t pt-6">
                <h3 class="font-bold text-red-600 mb-2">アカウント操作</h3>
                <button onclick="logout()" class="w-full bg-gray-500 text-white py-2 rounded hover:opacity-80 mb-4">ログアウト</button>
                <button onclick="deleteAccount()" class="w-full bg-red-600 text-white py-2 rounded hover:opacity-80 text-sm">アカウント削除</button>
                <p class="text-xs text-gray-500 mt-2">※アカウントを削除しても、同じメールアドレスで再登録可能です。</p>
            </div>
        </section>

        <!-- ビュー: おみくじの轍 (履歴) -->
        <section id="view-history" class="view-section max-w-4xl mx-auto relative">
            <h2 class="text-3xl font-bold mb-6 text-center text-red-800 dark:text-red-400">おみくじの轍</h2>
            
            <div class="text-center mb-6">
                <p class="text-sm themed-text-sub">ログインすると、ご自身の履歴と皆様の参拝記録が保存されます。</p>
            </div>

            <div id="history-container" class="">
                <div class="grid grid-cols-2 gap-4 mb-4 text-center">
                    <div class="themed-card p-3 rounded">
                        <p class="text-xs themed-text-sub">あなたの参拝数 (全期間)</p>
                        <p class="text-xl font-bold" id="personal-history-count">-</p>
                    </div>
                    <div class="themed-card p-3 rounded">
                        <p class="text-xs themed-text-sub">みんなの参拝数 (全期間)</p>
                        <p class="text-xl font-bold" id="global-history-count">-</p>
                    </div>
                </div>

                <!-- 検索フォーム -->
                <div class="search-form-container">
                    <h3 class="text-sm font-bold mb-2"><i class="bi bi-search"></i> 轍を検索</h3>
                    <div class="search-input-group">
                        <select id="search-type" class="search-input">
                            <option value="all">全ての運勢</option>
                            <option value="大吉">大吉</option>
                            <option value="中吉">中吉</option>
                            <option value="小吉">小吉</option>
                            <option value="吉">吉</option>
                            <option value="半吉">半吉</option>
                            <option value="末吉">末吉</option>
                            <option value="末小吉">末小吉</option>
                            <option value="凶">凶</option>
                            <option value="小凶">小凶</option>
                            <option value="半凶">半凶</option>
                            <option value="末凶">末凶</option>
                            <option value="大凶">大凶</option>
                        </select>
                        <input type="text" id="search-keyword" placeholder="ユーザー名" class="search-input">
                        <input type="date" id="search-date-start" class="search-input">
                        <span class="self-center">〜</span>
                        <input type="date" id="search-date-end" class="search-input">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="filterHistory()" class="btn-primary text-xs py-1 px-4">検索</button>
                        <button onclick="resetSearch()" class="btn-outline text-xs py-1 px-4">リセット</button>
                    </div>
                    <div class="text-right text-xs mt-2 themed-text-sub">
                        検索結果: <span id="search-result-count" class="font-bold">0</span> 件
                    </div>
                </div>

                <div class="themed-card p-6 rounded shadow mb-6">
                    <div class="flex justify-between items-center border-b border-gray-300 dark:border-gray-600 pb-2 mb-4">
                        <h3 class="font-bold">参拝の足跡一覧</h3>
                        <div class="text-xs text-gray-500" id="history-view-mode"></div>
                    </div>
                    <!-- ■ 修正前（目安） -->
<div id="history-list" class="space-y-3">
    <!-- JSで挿入 -->
</div>

<!-- ■ 修正後：この下に以下の div を追加してください -->
<div id="history-pagination" class="flex justify-center items-center gap-4 mt-6 text-sm"></div>
                </div>
            </div>

            <div id="history-login-overlay" class="history-overlay hidden">
                <i class="bi bi-lock-fill text-4xl text-gray-400 mb-4 block"></i>
                <p class="text-lg font-bold mb-2">轍を見るには会員証が必要です</p>
                <p class="text-sm themed-text-sub mb-4">ログインすると、過去の結果を詳細まで振り返ることができます。</p>
                <button onclick="showView('auth')" class="btn-primary">ログイン / 登録</button>
            </div>
        </section>

        <!-- ビュー: 社務所だより（検索・ページ機能付き） -->
        <section id="view-news" class="view-section max-w-3xl mx-auto">
            <h2 class="text-2xl font-bold mb-6">社務所だより</h2>
            
            <!-- 検索ボックス -->
            <div class="mb-6 flex gap-2">
                <input type="text" id="news-search-input" placeholder="記事を検索..." 
                       class="flex-1 p-3 border rounded-lg themed-input shadow-sm"
                       oninput="handleSearch('news', this.value)">
            </div>

            <!-- 記事リスト -->
            <div class="space-y-4" id="view-news-list">
                <!-- JSで自動挿入 -->
            </div>

            <!-- ページネーション -->
            <div id="news-pagination" class="flex justify-center items-center gap-4 mt-8">
                <!-- JSで自動挿入 -->
            </div>
        </section>

        <!-- ビュー: 神籤草子（検索・ページ機能付き） -->
        <section id="view-column" class="view-section max-w-3xl mx-auto">
            <h2 class="text-2xl font-bold mb-6">神籤草子</h2>
            
            <!-- 検索ボックス -->
            <div class="mb-6 flex gap-2">
                <input type="text" id="column-search-input" placeholder="コラムを検索..." 
                       class="flex-1 p-3 border rounded-lg themed-input shadow-sm"
                       oninput="handleSearch('column', this.value)">
            </div>

            <!-- 記事リスト -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="view-column-list">
                <!-- JSで自動挿入 -->
            </div>

            <!-- ページネーション -->
            <div id="column-pagination" class="flex justify-center items-center gap-4 mt-8">
                <!-- JSで自動挿入 -->
            </div>
        </section>

        <!-- ビュー: 記事詳細 -->
        <section id="view-article-detail" class="view-section">
            <div class="max-w-3xl mx-auto mb-4">
                <button onclick="articleBack()" class="text-sm themed-text-sub hover:text-red-500">
                    <i class="bi bi-arrow-left"></i> 戻る
                </button>
            </div>
            <div id="article-detail-content" class="article-container themed-card">
                <!-- JSでコンテンツ挿入 -->
            </div>
        </section>

        <!-- ビュー: 当サイトについて・利用規約・詳細解説 (目次・PDF対応版) -->
        <section id="view-about" class="view-section max-w-4xl mx-auto">
            <!-- PDF化する対象エリア（カード全体） -->
            <div id="about-content-area" class="themed-card p-10 rounded shadow-lg text-justify leading-loose bg-white dark:bg-zinc-800">
                <h2 class="text-3xl font-bold mb-8 text-center border-b border-gray-300 dark:border-gray-600 pb-4">当サイトについて・利用規約・詳細解説</h2>
                
                <div class="text-right text-sm themed-text-sub mb-8">
                    制定日: 2026年1月2日<br>
                    改定日: 2026年1月5日 (第3版)<br>
                    運営・開発: nden148<br>
                    基盤技術: Cloudflare Workers / Google Apps Script
                </div>

                <!-- ▼▼ 追加: 目次・PDFボタンエリア ▼▼ -->
                <div id="about-toc-container" class="mb-8 p-6 bg-gray-50 dark:bg-black/20 rounded-xl border border-gray-200 dark:border-gray-700 hidden" data-html2canvas-ignore="true">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-300 dark:border-gray-600 pb-2">
                        <h3 class="font-bold text-lg m-0 p-0 border-none"><i class="bi bi-list-ul mr-2"></i>目次</h3>
                        <button onclick="downloadPDF('about')" class="btn-primary text-xs py-2 px-4 shadow-none">
                            <i class="bi bi-file-pdf-fill"></i> PDF保存
                        </button>
                    </div>
                    <ul class="text-sm space-y-2 list-none m-0 p-0 text-gray-700 dark:text-gray-300" id="about-toc-list"></ul>
                </div>
                <!-- ▲▲ 追加ここまで ▲▲ -->

                <p class="mb-6 font-bold text-center">
                    〜 天命乃杜は、テクノロジーで再定義された「現代の鎮守の杜」です 〜
                </p>

                <!-- 徹底比較表 (35項目) -->
                <h3 class="text-xl font-bold mt-8 mb-4 border-l-4 border-red-500 pl-3">第1章 サービス性能・機能比較（完全版）</h3>
                <p class="mb-4 text-sm">
                    本表は、当サイト「天命乃杜」と、インターネット上に存在する主要な占いサービス形式（老舗Webサイト型、神社公式型、大手ポータル型、ネイティブアプリ型）の仕様を、客観的な技術指標に基づき比較したものです。特定の他社サービスを貶める意図はなく、利用者が自身のニーズに合ったサービスを選択するための判断材料として提供します。
                </p>
                <div class="overflow-x-auto mb-8">
                    <table class="comparison-table" style="font-size: 0.75rem; min-width: 900px; white-space: nowrap;">
                        <thead>
                            <tr class="bg-gray-200 dark:bg-zinc-700">
                                <th class="p-2 border border-gray-300 dark:border-gray-600" style="width: 10%;">大分類</th>
                                <th class="p-2 border border-gray-300 dark:border-gray-600" style="width: 15%;">詳細項目</th>
                                <th class="p-2 border border-gray-300 dark:border-gray-600 bg-red-100 dark:bg-red-900 text-red-900 dark:text-red-100 font-bold" style="width: 25%;">⛩️ 運勢・天命乃杜<br>(当サイト)</th>
                                <th class="p-2 border border-gray-300 dark:border-gray-600" style="width: 12%;">某老舗WebサイトA<br>(シンプル型)</th>
                                <th class="p-2 border border-gray-300 dark:border-gray-600" style="width: 12%;">某神社公式Web B<br>(儀式型)</th>
                                <th class="p-2 border border-gray-300 dark:border-gray-600" style="width: 12%;">某大手ポータルC<br>(メディア型)</th>
                                <th class="p-2 border border-gray-300 dark:border-gray-600" style="width: 14%;">有料アプリD<br>(課金型)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 1. 基本設計 -->
                            <tr><td rowspan="6" class="font-bold bg-gray-50 dark:bg-zinc-800">基本設計</td>
                                <td class="font-bold">利用料金</td>
                                <td class="highlight font-bold">完全無料</td>
                                <td>無料</td>
                                <td>無料</td>
                                <td>無料 (一部有料)</td>
                                <td>月額/都度課金</td>
                            </tr>
                            <tr>
                                <td class="font-bold">広告表示</td>
                                <td class="highlight font-bold">なし (静寂重視)</td>
                                <td>あり (追尾広告等)</td>
                                <td>なし</td>
                                <td>大量にあり</td>
                                <td>あり (無料版)</td>
                            </tr>
                            <tr>
                                <td class="font-bold">会員登録</td>
                                <td class="highlight">任意 (メール認証)</td>
                                <td>なし</td>
                                <td>なし (参拝者入力のみ)</td>
                                <td>ID登録必須</td>
                                <td>必須</td>
                            </tr>
                            <tr>
                                <td class="font-bold">更新頻度</td>
                                <td class="highlight">安定稼働 (完成済)</td>
                                <td>低 (数年放置)</td>
                                <td>低 (行事毎のみ)</td>
                                <td>高 (記事追加)</td>
                                <td>中 (バグ修正)</td>
                            </tr>
                            <tr>
                                <td class="font-bold">動作環境</td>
                                <td class="highlight">SPA (アプリ的挙動)</td>
                                <td>MPA (ページ遷移有)</td>
                                <td>MPA / Flash代替</td>
                                <td>MPA (重い)</td>
                                <td>iOS/Android</td>
                            </tr>
                            <tr>
                                <td class="font-bold">スマホ最適化</td>
                                <td class="highlight">◎ 完全レスポンシブ</td>
                                <td>△ PCレイアウト残り</td>
                                <td>○ 対応</td>
                                <td>○ 対応</td>
                                <td>◎ ネイティブ</td>
                            </tr>

                            <!-- 2. おみくじ機能 -->
                            <tr><td rowspan="7" class="font-bold bg-gray-50 dark:bg-zinc-800">おみくじ<br>体験</td>
                                <td class="font-bold">抽選ロジック</td>
                                <td class="highlight">12段階 + パラメータ</td>
                                <td>7段階 (標準)</td>
                                <td>7段階 (標準)</td>
                                <td>不明</td>
                                <td>操作の可能性有</td>
                            </tr>
                            <tr>
                                <td class="font-bold">アニメーション</td>
                                <td class="highlight">物理演算風・和風演出</td>
                                <td>なし (静止画)</td>
                                <td>箱を振る動画等</td>
                                <td>簡素</td>
                                <td>豪華エフェクト</td>
                            </tr>
                            <tr>
                                <td class="font-bold">結果の種別</td>
                                <td class="highlight">動的生成 (数億通り)</td>
                                <td>固定画像 (数十枚)</td>
                                <td>固定画像 (数十枚)</td>
                                <td>テキストDB</td>
                                <td>テキストDB</td>
                            </tr>
                            <tr>
                                <td class="font-bold">和歌・漢詩</td>
                                <td class="highlight">あり (独自解釈付)</td>
                                <td>なし</td>
                                <td>あり (本格的)</td>
                                <td>なし</td>
                                <td>一部あり</td>
                            </tr>
                            <tr>
                                <td class="font-bold">ラッキー項目</td>
                                <td class="highlight">物・色・場所・人</td>
                                <td>なし</td>
                                <td>なし</td>
                                <td>物・色</td>
                                <td>多数</td>
                            </tr>
                            <tr>
                                <td class="font-bold">願事・待人等</td>
                                <td class="highlight">7項目詳細</td>
                                <td>一言のみ</td>
                                <td>あり</td>
                                <td>あり</td>
                                <td>あり</td>
                            </tr>
                            <tr>
                                <td class="font-bold">効果音</td>
                                <td class="highlight">なし (静寂)</td>
                                <td>なし</td>
                                <td>あり (鈴・拍手等)</td>
                                <td>なし</td>
                                <td>あり</td>
                            </tr>

                            <!-- 3. データ管理 -->
                            <tr><td rowspan="6" class="font-bold bg-gray-50 dark:bg-zinc-800">データ<br>保存</td>
                                <td class="font-bold">履歴保存</td>
                                <td class="highlight font-bold">◎ 永続保存 (轍)</td>
                                <td>× 不可 (消失)</td>
                                <td>× 不可</td>
                                <td>△ Cookieのみ</td>
                                <td>○ アプリ内</td>
                            </tr>
                            <tr>
                                <td class="font-bold">クラウド同期</td>
                                <td class="highlight">◎ 可能 (KV使用)</td>
                                <td>× 不可</td>
                                <td>× 不可</td>
                                <td>○ ID連携時</td>
                                <td>○ ID連携時</td>
                            </tr>
                            <tr>
                                <td class="font-bold">履歴検索</td>
                                <td class="highlight">◎ 検索・ページ機能</td>
                                <td>-</td>
                                <td>-</td>
                                <td>× なし</td>
                                <td>△ 最近のみ</td>
                            </tr>
                            <tr>
                                <td class="font-bold">結果再表示</td>
                                <td class="highlight">◎ いつでも可能</td>
                                <td>× 不可</td>
                                <td>× 不可</td>
                                <td>× 不可</td>
                                <td>○ 可能</td>
                            </tr>
                            <tr>
                                <td class="font-bold">統計閲覧</td>
                                <td class="highlight">◎ リアルタイム詳細</td>
                                <td>△ 累計のみ(不正確)</td>
                                <td>× なし</td>
                                <td>× なし</td>
                                <td>× なし</td>
                            </tr>
                            <tr>
                                <td class="font-bold">エクスポート</td>
                                <td class="highlight">画像保存 (高画質)</td>
                                <td>テキスト選択のみ</td>
                                <td>不可</td>
                                <td>スクショ推奨</td>
                                <td>スクショ推奨</td>
                            </tr>

                            <!-- 4. 複合機能 -->
                            <tr><td rowspan="6" class="font-bold bg-gray-50 dark:bg-zinc-800">12星座<br>その他</td>
                                <td class="font-bold">12星座占い</td>
                                <td class="highlight font-bold">◎ あり (血液型掛合)</td>
                                <td>× なし</td>
                                <td>× なし</td>
                                <td>◎ あり (メイン)</td>
                                <td>◎ あり</td>
                            </tr>
                            <tr>
                                <td class="font-bold">再現性(運命)</td>
                                <td class="highlight">日付シード固定</td>
                                <td>-</td>
                                <td>-</td>
                                <td>ランダム多し</td>
                                <td>固定</td>
                            </tr>
                            <tr>
                                <td class="font-bold">土地の運気</td>
                                <td class="highlight font-bold">◎ 47都道府県ランク</td>
                                <td>× なし</td>
                                <td>× なし</td>
                                <td>× なし</td>
                                <td>△ 有料機能</td>
                            </tr>
                            <tr>
                                <td class="font-bold">カレンダー</td>
                                <td class="highlight">30日予報グラフ</td>
                                <td>-</td>
                                <td>-</td>
                                <td>簡易表示</td>
                                <td>有料</td>
                            </tr>
                            <tr>
                                <td class="font-bold">お気に入り</td>
                                <td class="highlight">あり (5件まで)</td>
                                <td>-</td>
                                <td>-</td>
                                <td>あり</td>
                                <td>あり</td>
                            </tr>
                            <tr>
                                <td class="font-bold">コラム・記事</td>
                                <td class="highlight">あり (神籤草子)</td>
                                <td>なし</td>
                                <td>由緒書き等</td>
                                <td>大量 (SEO用)</td>
                                <td>日替わり</td>
                            </tr>

                            <!-- 5. 技術仕様 -->
                            <tr><td rowspan="5" class="font-bold bg-gray-50 dark:bg-zinc-800">技術・<br>セキュリティ</td>
                                <td class="font-bold">サーバー基盤</td>
                                <td class="highlight">Cloudflare Edge</td>
                                <td>共用レンタル鯖</td>
                                <td>専用サーバー</td>
                                <td>クラウド(AWS等)</td>
                                <td>APIサーバー</td>
                            </tr>
                            <tr>
                                <td class="font-bold">認証方式</td>
                                <td class="highlight">OTPメール (GAS)</td>
                                <td>-</td>
                                <td>-</td>
                                <td>Social Login</td>
                                <td>OS依存</td>
                            </tr>
                            <tr>
                                <td class="font-bold">DB堅牢性</td>
                                <td class="highlight">分散KVS (高耐久)</td>
                                <td>ファイル (脆弱)</td>
                                <td>保存しない</td>
                                <td>RDB</td>
                                <td>RDB / SQLite</td>
                            </tr>
                            <tr>
                                <td class="font-bold">パスワード</td>
                                <td class="highlight">SHA-256ハッシュ</td>
                                <td>-</td>
                                <td>-</td>
                                <td>暗号化</td>
                                <td>トークン</td>
                            </tr>
                            <tr>
                                <td class="font-bold">シェア画像</td>
                                <td class="highlight">html2canvas生成</td>
                                <td>なし</td>
                                <td>なし</td>
                                <td>なし</td>
                                <td>OS共有機能</td>
                            </tr>

                            <!-- 6. 拡張性 -->
                            <tr><td rowspan="4" class="font-bold bg-gray-50 dark:bg-zinc-800">拡張性・<br>UX</td>
                                <td class="font-bold">ダークモード</td>
                                <td class="highlight font-bold">完全対応 + 強制機能</td>
                                <td>非対応</td>
                                <td>非対応</td>
                                <td>一部対応</td>
                                <td>対応</td>
                            </tr>
                            <tr>
                                <td class="font-bold">表示カスタマイズ</td>
                                <td class="highlight">Labs (迎春/文字等)</td>
                                <td>不可</td>
                                <td>不可</td>
                                <td>不可</td>
                                <td>着せ替え(有料)</td>
                            </tr>
                            <tr>
                                <td class="font-bold">読込速度</td>
                                <td class="highlight">爆速 (エッジ配信)</td>
                                <td>普通〜遅い</td>
                                <td>普通</td>
                                <td>遅い (広告重)</td>
                                <td>速い</td>
                            </tr>
                            <tr>
                                <td class="font-bold">アクセシビリティ</td>
                                <td class="highlight">文字サイズ変更可</td>
                                <td>ブラウザ依存</td>
                                <td>固定</td>
                                <td>固定</td>
                                <td>OS設定依存</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h3 class="text-xl font-bold mt-8 mb-4 border-l-4 border-red-500 pl-3">第2章 当サイトの運用ポリシーと技術的背景</h3>
                <p class="mb-4">
                    「運勢・天命乃杜」は、最新のWeb技術を用いて構築された、極めて現代的かつ実験的な占いプラットフォームです。一般的な商用サイトとは異なり、開発者（nden148）が個人で設計・実装・運営を行っております。
                </p>
                <h4 class="font-bold mt-4 border-b border-gray-300 dark:border-gray-600 pb-1">1. 更新頻度と「完成されたシステム」について</h4>
                <p class="mb-4">
                    当サイトの更新頻度は、他のニュースサイトやブログメディアと比較して低く設定されています。これは開発の停滞を意味するものではなく、<strong>「初期リリースの段階で、予定されていた主要機能の実装が完了しており、システムとして完成されている」</strong>ためです。現在は安定稼働フェーズにあり、バグ修正やサーバーメンテナンスを除き、頻繁なコード変更は行われません。皆様には、変わらぬ品質で永続的にサービスを提供し続けます。
                </p>
                <h4 class="font-bold mt-4 border-b border-gray-300 dark:border-gray-600 pb-1">2. サーバーレス技術による堅牢性</h4>
                <p class="mb-4">
                    当サイトは、物理的なサーバーを持たない「サーバーレス・アーキテクチャ（Cloudflare Workers）」上で動作しています。これにより、アクセス集中によるサーバーダウンのリスクは極めて低く、世界中どこからでも高速にアクセス可能です。また、データは「Workers KV」という分散型データベースに保存されており、特定拠点の災害等によるデータ消失リスクを回避しています。某老舗サイトで見られるような「サーバー移転に伴うカウンターの巻き戻り」といった事故は、本システムの構造上発生しません。
                </p>
                <h4 class="font-bold mt-4 border-b border-gray-300 dark:border-gray-600 pb-1">3. 真正性への取り組みと日付更新</h4>
                <p class="mb-4">
                    占いの結果生成において、当サイトは「真正性」を重視しています。12星座×血液型占いおよび全国運気ランキングにおいては、その日の日付（日本時間 JST 0:00基準）をシード値（種）とした決定論的乱数生成アルゴリズム（Seeded Random）を採用しており、リロードを繰り返して良い結果が出るまでやり直す「リセマラ」を防止しています。これは、占いを単なるゲームではなく、その日の運命（天命）として受け入れていただくための仕様です。
                </p>

                <h3 class="text-xl font-bold mt-8 mb-4 border-l-4 border-red-500 pl-3">第3章 利用規約</h3>
                <p class="mb-2">本サービスを利用される全ての参拝者（ユーザー）は、以下の規約に同意したものとみなされます。</p>
                
                <h4 class="font-bold mt-4">第1条（サービスの性質）</h4>
                <p class="mb-2 text-sm">
                    本サービスは娯楽目的で提供されるものであり、その結果の正確性や効果を保証するものではありません。結果に基づく行動はユーザーの自己責任となります。特に「全国・土地の運気ランキング」は、独自のアルゴリズムに基づくエンターテインメントコンテンツであり、実際の気象情報や地質学的データとは無関係です。
                </p>

                <h4 class="font-bold mt-4">第2条（アカウント管理）</h4>
                <p class="mb-2 text-sm">
                    1. アカウントのパスワードはSHA-256でハッシュ化され、運営者も閲覧不可能な状態で保存されます。パスワードの紛失時はアカウントの復旧ができません。<br>
                    2. 認証メールの送信にはGoogle Apps Scriptを使用しています。認証コードの有効期限は5分間です。
                </p>

                <h4 class="font-bold mt-4">第3条（禁止事項）</h4>
                <p class="mb-2 text-sm">
                    1. 自動化ツール（Bot、スクレイピングツール等）を用いて、おみくじを大量に引く行為、またはサーバーに過度な負荷をかける行為。<br>
                    2. APIの脆弱性を意図的に突く行為、またはリバースエンジニアリング。<br>
                    3. 生成されたおみくじ結果画像を改竄し、事実と異なる内容（当サイトが意図しない不適切な文言等）をSNS等で流布する行為。<br>
                    4. 他者のメールアドレスを不正に使用してアカウント登録を行う行為。
                </p>

                <h3 class="text-xl font-bold mt-8 mb-4 border-l-4 border-red-500 pl-3">第4章 著作権と二次利用</h3>
                <p class="mb-4">
                    1. 本サイトを構成するプログラムコード、デザイン、文章、ロゴ、および「TENMEI Labs」等の独自機能に関する知的財産権は、運営者（nden148）に帰属します。<br>
                    2. ただし、本サイトの機能を用いて生成された「おみくじ結果画像」については、ユーザー個人のSNS（X, Instagram, LINE等）での共有を目的とする限りにおいて、ユーザーはこれを自由に利用（複製、公衆送信）することができます。この際、画像に含まれるQRコードやサイトURLを削除しないことを推奨します。
                </p>

                <h3 class="text-xl font-bold mt-8 mb-4 border-l-4 border-red-500 pl-3">第5章 免責事項およびサポートの非提供</h3>
                <p class="mb-4 text-red-600 dark:text-red-400 font-bold border border-red-500 p-3 rounded bg-red-50 dark:bg-red-900/20">
                    【重要】お問い合わせについて
                </p>
                <p class="mb-4">
                    1. 当運営は、本サービスの提供の中断、停止、終了、利用不能、またはデータの消失（ユーザーによる退会処理や、不可抗力によるサーバー障害を含む）によってユーザーに生じた損害について、一切の責任を負いません。<br>
                    2. 「おみくじの轍（履歴）」機能は、ユーザーの利便性のために提供されるものですが、永続的なデータ保存を法的に保証するものではありません。重要な結果については、画像保存機能を用いてユーザー自身の端末に物理的に保存することを強く推奨します。<br>
                    3. 本サービスからリンクされている外部サイト（SNSシェア先等）の内容やプライバシー保護については、当運営は責任を負いません。<br>
                    4. <strong>本サービスは個人開発による実験的プロジェクトであり、専任のサポート窓口やお問い合わせフォームは一切設置しておりません。また、運営者のSNSアカウント等を通じた個別の連絡、不具合報告、機能要望への対応も、アカウント凍結等の事情により一切行うことができません。</strong><br>
                    5. 万が一、本サービスの利用により何らかの問題が生じた場合、または個人情報の取扱いに関して懸念が生じた場合は、直ちに本サービスの利用を中止し、「アカウント削除」機能を用いてご自身のデータを完全に消去する措置をとってください。これ以外の個別対応は致しかねますことを、あらかじめご了承ください。
                </p>
            </div>
        </section>

        <!-- ビュー: プライバシーポリシー (目次・PDF対応版) -->
        <section id="view-privacy" class="view-section max-w-4xl mx-auto">
            <!-- PDF化する対象エリア（カード全体） -->
            <div id="privacy-content-area" class="themed-card p-10 rounded shadow-lg text-justify leading-loose bg-white dark:bg-zinc-800">
                <h2 class="text-3xl font-bold mb-8 text-center border-b border-gray-300 dark:border-gray-600 pb-4">プライバシーポリシー</h2>
                <div class="text-right text-sm themed-text-sub mb-8">
                    制定日: 2026年1月2日<br>
                    改定日: 2026年1月5日 (第3版)<br>
                    運営者: nden148
                </div>

                <!-- ▼▼ 追加: 目次・PDFボタンエリア ▼▼ -->
                <div id="privacy-toc-container" class="mb-8 p-6 bg-gray-50 dark:bg-black/20 rounded-xl border border-gray-200 dark:border-gray-700 hidden" data-html2canvas-ignore="true">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-300 dark:border-gray-600 pb-2">
                        <h3 class="font-bold text-lg m-0 p-0 border-none"><i class="bi bi-list-ul mr-2"></i>目次</h3>
                        <button onclick="downloadPDF('privacy')" class="btn-primary text-xs py-2 px-4 shadow-none">
                            <i class="bi bi-file-pdf-fill"></i> PDF保存
                        </button>
                    </div>
                    <ul class="text-sm space-y-2 list-none m-0 p-0 text-gray-700 dark:text-gray-300" id="privacy-toc-list"></ul>
                </div>
                <!-- ▲▲ 追加ここまで ▲▲ -->

                <p class="mb-6">
                    運勢・天命乃杜（以下、「当サイト」といいます。）は、当サイトが提供するウェブサービス「運勢・天命乃杜」（以下、「本サービス」といいます。）における、ユーザーの個人情報の取扱いについて、以下のとおりプライバシーポリシー（以下、「本ポリシー」といいます。）を定めます。当サイトは、個人情報の保護に関する法律（平成15年法律第57号。以下「個人情報保護法」といいます。）その他関係法令を遵守するとともに、本ポリシーに基づき、ユーザーの個人情報を適正に取り扱い、その保護に努めます。
                </p>

                <h4 class="font-bold mt-6 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第1条（定義）</h4>
                <p class="mb-4 text-sm">
                    本ポリシーにおいて使用する用語の定義は、以下のとおりとします。
                    <br>1. <strong>「個人情報」</strong>とは、個人情報保護法第2条第1項にいう「個人情報」を指すものとし、生存する個人に関する情報であって、当該情報に含まれる氏名、生年月日、住所、電話番号、連絡先、その他の記述等により特定の個人を識別できる情報（他の情報と容易に照合することができ、それにより特定の個人を識別することができることとなるものを含みます。）を指します。
                    <br>2. <strong>「履歴情報および特性情報」</strong>とは、上記に定める「個人情報」以外のものをいい、ご利用いただいたサービスや、ご覧になったページ、ユーザーが検索された検索キーワード、ご利用日時、ご利用の方法、ご利用環境、郵便番号や性別、職業、年齢、ユーザーのIPアドレス、Cookie情報、位置情報、端末の個体識別情報などを指します。
                </p>

                <h4 class="font-bold mt-6 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第2条（収集する個人情報および収集方法）</h4>
                <p class="mb-4 text-sm">
                    当サイトは、本サービスの提供にあたり、以下の情報を適法かつ公正な手段により収集します。
                </p>
                <ol class="list-decimal pl-5 mb-4 space-y-2 text-sm">
                    <li>
                        <strong>ユーザー登録時に提供いただく情報：</strong><br>
                        本サービスの会員機能（「おみくじの轍」の保存、「TENMEI Labs」の利用等）を利用するために、ユーザー登録を行っていただく際、以下の情報の提供をお願いしております。
                        <ul class="list-disc pl-4 mt-1 text-gray-600 dark:text-gray-400">
                            <li>メールアドレス（本人確認および認証コード送信のため必須）</li>
                            <li>ユーザー名（サービス内での表示用ニックネーム）</li>
                            <li>パスワード（アカウント保護のため）</li>
                        </ul>
                    </li>
                    <li>
                        <strong>サービス利用時に自動的に収集される情報：</strong><br>
                        ユーザーが本サービスを利用する際、当サイトは、インターネット技術を用いて以下の情報を自動的に収集する場合があります。
                        <ul class="list-disc pl-4 mt-1 text-gray-600 dark:text-gray-400">
                            <li>IPアドレスおよびアクセス元の国・地域情報</li>
                            <li>アクセス日時および滞在時間</li>
                            <li>利用端末の種類、OSのバージョン、ブラウザの種類（User Agent）</li>
                            <li>おみくじの抽選結果、12星座占いの設定情報（星座・血液型）、お気に入り登録状況</li>
                            <li>「全国・土地の運気ランキング」の閲覧履歴（※位置情報GPSデータは一切取得・保存いたしません）</li>
                        </ul>
                    </li>
                </ol>

                <h4 class="font-bold mt-6 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第3条（個人情報の利用目的）</h4>
                <p class="mb-4 text-sm">
                    当サイトが個人情報を収集・利用する目的は、以下のとおりです。
                </p>
                <ul class="list-disc pl-5 mb-4 space-y-1 text-sm">
                    <li>本サービスの提供・運営のため（認証システムによるログイン状態の維持、履歴データの呼び出し等）</li>
                    <li>ユーザーからのお問い合わせに対応するため（本人確認を行うことを含む）</li>
                    <li>本サービスの利用規約に違反したユーザーや、不正・不当な目的でサービスを利用しようとするユーザーを特定し、ご利用をお断りするため</li>
                    <li>ユーザーにご自身の登録情報の閲覧や変更、削除、ご利用状況の閲覧を行っていただくため</li>
                    <li>メンテナンス、重要なお知らせなど必要に応じたご連絡のため</li>
                    <li>個人を識別できない形式に加工した統計データを作成し、本サービスの改善やマーケティング資料として利用・公表するため（例：「大吉」の出現率の統計的分析など）</li>
                    <li>上記の利用目的に付随する目的</li>
                </ul>

                <h4 class="font-bold mt-6 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第4条（個人情報の安全管理措置）</h4>
                <p class="mb-4 text-sm">
                    当サイトは、取り扱う個人情報の漏洩、滅失またはき損の防止、その他の個人情報の安全管理のために、必要かつ適切な措置を講じています。
                </p>
                <p class="mb-4 text-sm">
                    <strong>1. 技術的保護措置：</strong><br>
                    当サイトは、通信経路における第三者の盗聴を防止するため、全ての通信に対してSSL/TLS（Transport Layer Security）暗号化技術を使用しています。また、ユーザーのパスワードについては、サーバー上で平文（そのままの状態）で保存することは一切なく、<strong>SHA-256アルゴリズムを用いて不可逆的なハッシュ値に変換</strong>した上でデータベースに格納しております。これにより、万が一データベースへの不正アクセスが発生した場合でも、運営者を含め第三者が元のパスワードを知ることは不可能な仕組みとなっております。
                </p>
                <p class="mb-4 text-sm">
                    <strong>2. インフラストラクチャの安全性：</strong><br>
                    本サービスのサーバーサイド処理およびデータベースには、世界的なセキュリティ基準を満たす <strong>Cloudflare Workers</strong> および <strong>Workers KV</strong> を採用しています。データは分散ネットワーク上で冗長化されて保管され、物理的な障害やDDoS攻撃などの脅威から保護されています。
                </p>

                <h4 class="font-bold mt-6 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第5条（外部サービスとの連携とデータ移転）</h4>
                <p class="mb-4 text-sm">
                    本サービスの一部の機能は、信頼できる第三者の外部サービスを利用して提供されています。これに伴い、必要な範囲で以下の通りデータが送信されますが、各事業者はそれぞれのプライバシーポリシーに従ってデータを管理しています。
                </p>
                <div class="mb-4 text-sm border-l-2 border-gray-300 pl-4">
                    <p class="font-bold">1. Google Apps Script (Google LLC)</p>
                    <p class="mb-1">利用目的：アカウント認証用メール（ワンタイムパスワード）の自動送信処理</p>
                    <p class="mb-1">送信される情報：メールアドレス、認証コード、ユーザー名</p>
                    <p>特記事項：当サイトのシステムは、メール送信リクエストをGoogleのサーバーに送信します。Google側でメール送信処理が完了した後、当該個人情報がGoogleスプレッドシート等のストレージに永続的に蓄積されることはありません。</p>
                </div>
                <div class="mb-4 text-sm border-l-2 border-gray-300 pl-4">
                    <p class="font-bold">2. Cloudflare (Cloudflare, Inc.)</p>
                    <p class="mb-1">利用目的：コンテンツ配信（CDN）、サーバーレスコンピューティング、データベース機能</p>
                    <p>送信される情報：アクセスログ、ユーザー登録情報、利用履歴等の全てのデータ</p>
                </div>

                <h4 class="font-bold mt-6 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第6条（個人情報の第三者提供）</h4>
                <p class="mb-4 text-sm">
                    当サイトは、次に掲げる場合を除いて、あらかじめユーザーの同意を得ることなく、第三者に個人情報を提供することはありません。ただし、個人情報保護法その他の法令で認められる場合を除きます。
                </p>
                <ul class="list-disc pl-5 mb-4 space-y-1 text-sm">
                    <li>法令に基づく場合</li>
                    <li>人の生命、身体または財産の保護のために必要がある場合であって、本人の同意を得ることが困難であるとき</li>
                    <li>公衆衛生の向上または児童の健全な育成の推進のために特に必要がある場合であって、本人の同意を得ることが困難であるとき</li>
                    <li>国の機関もしくは地方公共団体またはその委託を受けた者が法令の定める事務を遂行することに対して協力する必要がある場合であって、本人の同意を得ることにより当該事務の遂行に支障を及ぼすおそれがあるとき</li>
                    <li>予め次の事項を告知あるいは公表し、かつ当サイトが個人情報保護委員会に届出をしたとき
                        <ul class="list-disc pl-4 mt-1 text-xs">
                            <li>利用目的に第三者への提供を含むこと</li>
                            <li>第三者に提供されるデータの項目</li>
                            <li>第三者への提供の手段または方法</li>
                            <li>本人の求めに応じて個人情報の第三者への提供を停止すること</li>
                            <li>本人の求めを受け付ける方法</li>
                        </ul>
                    </li>
                </ul>

                <h4 class="font-bold mt-6 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第7条（クッキー(Cookie)およびローカルストレージ）</h4>
                <p class="mb-4 text-sm">
                    1. 当サイトでは、ユーザーの利便性向上、ログイン状態の保持、および利用状況の分析のために、クッキー（Cookie）またはブラウザのローカルストレージ（LocalStorage）機能を使用しています。これにより、ユーザーのブラウザ内に設定情報（ダークモード設定、お気に入り星座等）やセッション情報を一時的に保存します。<br>
                    2. ユーザーは、ブラウザの設定を変更することにより、Cookie等の受け入れを拒否することができます。ただし、その場合、ログイン機能や履歴保存機能など、本サービスの一部機能が正常に動作しなくなる可能性がありますので、あらかじめご了承ください。
                </p>

                <h4 class="font-bold mt-6 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第8条（個人情報の開示・訂正・削除）</h4>
                <p class="mb-4 text-sm">
                    1. ユーザーは、当サイトの「プロフィール」画面を通じて、いつでもご自身の登録情報（ユーザー名）を閲覧および修正することができます。<br>
                    2. ユーザーは、当サイトに対し、ご自身の個人情報の削除（退会）を求めることができます。当サイトは、ユーザー本人からの請求であることを確認の上（ログイン状態での操作をもって本人確認とします）、データベースから当該ユーザーに関連する全ての個人情報（メールアドレス、パスワードハッシュ、利用履歴、お気に入り情報）を遅滞なく、かつ復元不可能な方法で削除いたします。<br>
                    3. 前項の規定にかかわらず、履歴情報および特性情報などの個人情報以外の情報については、原則として開示いたしません。
                </p>

                <h4 class="font-bold mt-6 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第9条（プライバシーポリシーの変更）</h4>
                <p class="mb-4 text-sm">
                    1. 本ポリシーの内容は、法令その他本ポリシーに別段の定めのある事項を除いて、ユーザーに通知することなく変更することができるものとします。<br>
                    2. 当サイトが別途定める場合を除いて、変更後のプライバシーポリシーは、本ウェブサイトに掲載したときから効力を生じるものとします。ユーザーは、本サービスを利用するたびに最新のプライバシーポリシーを確認するものとします。
                </p>

                <h4 class="font-bold mt-6 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第10条（免責事項）</h4>
                <p class="mb-4 text-sm">
                    当サイトからリンクやバナーなどによって他のサイトに移動された場合、移動先サイトで提供される情報、サービス等について一切の責任を負いません。また、移動先サイトにおける個人情報の取扱いについては、当該サイトのプライバシーポリシーをご確認ください。
                </p>

                <h4 class="font-bold mt-6 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第11条（お問い合わせ窓口の不存在と対処方法）</h4>
                <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded border border-red-300 dark:border-red-800 text-sm">
                    <p class="mb-2 font-bold text-red-700 dark:text-red-300">【重要：連絡先について】</p>
                    <p class="mb-4">
                        本サービスは個人開発による非営利・実験的なプロジェクトとして運営されております。現在、<strong>お問い合わせフォーム、サポート用メールアドレス、SNSアカウント等の連絡窓口は一切設置しておりません。</strong>そのため、個別の開示請求、苦情のお申し出、機能改善のご要望等をいただきましても、対応やご返信を行うことができません。
                    </p>
                    <p class="mb-2 font-bold">【対処方法】</p>
                    <p>
                        本サービスにおける個人情報の取扱い等に懸念が生じた場合、またはサービスの利用継続が困難であると判断された場合は、以下の手順によりご自身で対応をお願いいたします。
                    </p>
                    <ol class="list-decimal pl-5 mt-2 space-y-1">
                        <li>本サービスの利用を直ちに中止してください。</li>
                        <li>ログイン後の「プロフィール」画面にある<strong>「アカウント削除」ボタン</strong>を押下してください。これにより、メールアドレスを含む全ての個人データがサーバーから物理的に削除されます。</li>
                    </ol>
                    <p class="mt-4 text-xs text-gray-500 dark:text-gray-400">
                        ※アカウント削除後のデータ復旧は一切できません。あらかじめご了承ください。
                    </p>
                </div>
            </div>
        </section>
    </main>

    <!-- カウントダウンオーバーレイ -->
    <div id="countdown-overlay">
        <div id="countdown-number">3</div>
    </div>

    <!-- 詳細モーダル (おみくじの轍用) -->
    <div id="history-detail-modal" onclick="closeHistoryDetail(event)">
        <div id="history-detail-content" onclick="event.stopPropagation()">
            <!-- ここに結果カードを複製表示 -->
        </div>
        <button onclick="closeHistoryDetail(null)" class="fixed top-5 right-5 text-white text-4xl hover:text-gray-300 z-[2100]">
            <i class="bi bi-x-circle"></i>
        </button>
    </div>

    <!-- JavaScript ロジック -->
    <script>
        // ==========================================
        //  設定: Cloudflare WorkerのURL
        // ==========================================
        const API_BASE = "https://aaaaa.nden14800.workers.dev";
        const SITE_URL = "https://fortune-telling-at-tenmei-no-mori-authentic-today-s-fortun.pages.dev";

        // ==========================================
    //  データ管理: 社務所だより & 神籤草子 (強制上書き版)
    // ==========================================
    
    // ■ 社務所だより（ニュース）データ
    const newsData = [
        

        {
            id: 17,
            title: "【修正】ダークモード時における「半凶」グラフの表示色を調整いたしました",
            date: "2026/1/13",
            time: "16:15",
            tag: "デザイン修正",
            tagColor: "text-gray-600",
            borderColor: "border-gray-500",
            desc: "おみくじの轍（統計）において、背景色と同化して見えなくなっていた箇所を修正しました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日、以下の表示不具合を修正いたしました。</p>
                    
                    <h3>修正内容</h3>
                    <p>ダークモード（宵闇の刻、または端末設定）にて「おみくじの轍」の統計グラフをご覧いただいた際、<strong>「半凶」のバーの色が背景のレール色（グレー）と同化し、視認できなくなっている問題</strong>を解消いたしました。</p>
                    <p>具体的には、「半凶」のバーの色をダークモード時のみ「明るめのグレー」に変更し、背景とのコントラストを確保いたしました。これにより、すべての運勢の割合を正しくご確認いただけます。</p>
                    <p>ご不便をおかけいたしましたことをお詫び申し上げます。</p>
                </div>
            `
        },
        {
            id: 16,
            title: "【改善】スマートフォンでの「おみくじ結果」の表示崩れを修正いたしました",
            date: "2026/1/6",
            time: "17:30",
            tag: "機能改善",
            tagColor: "text-teal-600",
            borderColor: "border-teal-500",
            desc: "結果カードの一部が画面外に見切れてしまう問題を解消し、横スクロールで全文を閲覧できるようにいたしました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日、スマートフォンなどの画面幅が狭い端末において、おみくじの結果カード（御神籤）の左右が画面外にはみ出し、文章の一部が途切れて読めなくなる表示上の問題を修正いたしました。</p>
                    
                    <h3>修正内容：横スクロール（スワイプ）への対応</h3>
                    <p>これまでは、はみ出した部分がシステム的に隠されてしまっており、全文を読むためには一度「画像を保存」していただく必要がございました。</p>
                    <p>本日の更新により、画面からはみ出している部分を<strong>指で左右にスワイプ（横スクロール）</strong>することで、そのままブラウザ上で閲覧できるように改善いたしました。</p>
                    <p>これにより、まるで巻物を広げるような感覚で、端に書かれた吉凶や詳細な運勢までスムーズにご確認いただけます。今後も使い心地の向上に努めてまいります。</p>
                </div>
            `
        },
        {
            id: 14,
            title: "【重要】12星座占いの未来予報（カレンダー）における実装不備と、過去の誤表示に関する深いお詫び",
            date: "2026/1/6",
            time: "15:30",
            tag: "障害報告",
            tagColor: "text-red-600",
            borderColor: "border-red-600",
            desc: "「向こう30日間のラッキーデー」の表示内容が、実際の判定ロジックに基づかない「でたらめ」な状態であったことを深くお詫び申し上げます。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日、「12星座×血液型占い」コーナーにおける「向こう30日間のラッキーデー（カレンダー機能）」につきまして、表示内容の根幹に関わる重大な不備を修正し、システムを完全刷新いたしました。</p>
                    
                    <h3>不具合の発覚経緯と、カレンダー機能が「でたらめ」であった事実</h3>
                    <p>当サイトは利用規約およびプライバシーポリシーに明記しております通り、お問い合わせ窓口やサポート体制を一切設けておりません。そのため、今回の件はユーザーの皆様からご指摘をいただいたわけではなく、私自身がサイトの動作確認を行っていた際に、表示の矛盾に気付き発覚したものです。</p>
                    <p>具体的には、<strong>「今日のランキングでは総合1位（Sランク）と判定されているにもかかわらず、カレンダーの今日の日付欄には星マーク（ラッキーデーの印）が付いていない」</strong>という致命的な不整合を確認いたしました。</p>
                    <p>調査を行いましたところ、日々のランキング（今日の運勢順位）につきましては、日付と星座に基づき正常に計算されておりましたが、その下にあるカレンダー機能に関しては、本来行うべき「未来の運勢計算」を一切行わず、ランダムな箇所に適当なアイコンを表示するだけの、いわば<strong>「でたらめ」</strong>なプログラムが動作していたことが判明いたしました。</p>
                    <p>皆様が「この日は運が良いかもしれない」とカレンダーを見て予定を立てられたり、期待を寄せられたりしたお気持ちを、このような「見せかけだけの実装」で裏切っておりましたこと、弁解の余地もございません。実際の運勢とは無関係な、適当な記号を表示させていたことを深く猛省し、心よりお詫び申し上げます。</p>

                    <h3>修正内容：全パターンの完全シミュレーション化</h3>
                    <p>今回の更新において、旧来のカレンダー生成プログラムを即刻廃棄し、ゼロからロジックを作り直しました。</p>
                    <p>新しいシステムでは、カレンダーを表示するたびに、サーバー内部で<strong>「未来30日分」×「全48通り（12星座×4血液型）」＝計1,440回分の運勢計算</strong>を、手加減なしですべて実行しております。</p>
                    <p>これにより、「その日が本当に全48通りの中で1位（または各項目の1位）であるかどうか」を厳密にシミュレーション判定することが可能となりました。今後は、「ランキングで1位なら、カレンダーにも必ず星が付く」という当たり前の整合性が完全に保たれます。処理負荷は増大しましたが、これが本来あるべき正しい姿です。</p>

                    <h3>運勢テキストの大幅な加筆と改良</h3>
                    <p>また、今回の反省を込めまして、運勢結果の文章につきましても大幅な改良を行いました。</p>
                    <p>これまでは、恋愛・金運・仕事運の記述が連続しており、どこからどこまでがどの運勢の説明なのかが判然としない構成でした。今回より、各パラグラフの冒頭に<strong>【恋愛運：第〇位】</strong>といった明確な見出しを付け、さらにそれぞれの運勢について、「なぜその順位なのか」「具体的にどう行動すれば良いのか」を詳細に記述するよう、文章量を大幅に増量いたしました。</p>
                    
                    <p>今後は二度とこのような不誠実な実装を行わず、データの真正性にこだわって運営していくことをここに誓います。この度は、皆様の信頼を損なう事態を招き、本当に申し訳ございませんでした。</p>
                </div>
            `
        },
        {
            id: 15,
            title: "【復旧】深夜から早朝にかけて発生した表示不具合およびログイン表示エラーに関するお詫びとご報告",
            date: "2026/1/6",
            time: "08:30",
            tag: "障害報告",
            tagColor: "text-red-600",
            borderColor: "border-red-600",
            desc: "サイドメニュー操作時の画面消失、および各種数値が表示されない不具合が発生しておりました。現在は復旧しております。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>以下の日時にて、サイトが正常に閲覧できない、およびログイン状態が正しく反映されない重大な不具合が発生しておりました。現在は修正対応が完了し、正常に稼働しております。</p>
                    
                    <h3 class="text-red-600">発生日時（日本時間）</h3>
                    <p class="font-bold">2026年1月5日 23:35頃 〜 2026年1月6日 08:27頃</p>

                    <h3>発生していた不具合の内容</h3>
                    <ul class="list-disc ml-5 mb-4">
                        <li><strong>画面遷移の不具合：</strong><br>サイトに最初にアクセスした際はホーム画面が表示されますが、サイドバー（左側のメニュー）のボタンを押すと、コンテンツエリアが空白になり何も表示されなくなる現象が発生していました。（薄い十字架の背景模様とサイドバーのみが表示され、中身が消えてしまう状態でした）</li>
                        <li><strong>ログイン表示の不整合：</strong><br>実際にはログイン済みであるにもかかわらず、サイドバーのアイコンやテキストが「未ログイン状態（ログイン/登録）」のままになっておりました。</li>
                        <li><strong>数値データの消失：</strong><br>ホーム画面の「累計発行本数」が「---」のまま読み込まれず、また「おみくじの轍（統計グラフ）」もすべて「0本 / 0.00%」と表示されておりました。</li>
                    </ul>

                    <h3>原因：隠し機能追加によるコード競合</h3>
                    <p>今回の障害の原因は、私がサイトに「遊び心」を加えようとして実装を試みた、以下の2つの隠し機能（イースターエッグ）のコードにありました。</p>
                    <ul class="list-disc ml-5 mb-4">
                        <li>タイトルロゴを7回連続クリックすると、隠しメッセージが表示される機能</li>
                        <li>サイドバーのLabsアイコン（フラスコ）を5回連続クリックすると、実験機能が一時的にアンロックされる機能</li>
                    </ul>
                    <p>昨夜23:35頃、これらの機能を追加した直後から、クリックイベントの監視処理がサイト全体の描画システムと競合を起こし、ページ遷移やデータ取得のプロセスを阻害し始めました。</p>

                    <h3>復旧までの経緯</h3>
                    <p>不具合発覚直後より、原因の特定と修正作業を開始いたしました。修正を試みてはデプロイを繰り返しましたが、複雑に絡み合ったエラーは容易には解消されませんでした。</p>
                    <p>深夜、解決の糸口が見えないまま時間だけが過ぎ、焦りは募るばかりでした。「このまま徹夜してでも修正を完了させるべきではないか」という葛藤もありましたが、疲労による判断力の低下がさらなる重大なミス（二次被害）を招くリスクを考慮し、断腸の思いで一時作業を中断し、休息を取るという苦渋の決断をいたしました。不具合が残ったままの状態でサイトを放置することとなり、夜間に利用された皆様には多大なるご不便をおかけしましたことを深くお詫び申し上げます。</p>
                    <p>その後、早朝より作業を再開し、冷静にコードを見直した結果、「この隠し機能のコードが存在する限り、根本的な解決は困難である」という結論に至りました。そのため、追加しようとしていた隠し機能をすべて削除し、コードを元の安定した状態に戻すことで、本日8:27に完全な復旧を確認いたしました。</p>
                    
                    <p>本当はこの機能があっても、私の技術力が及んでいれば、コードを適切に修正して共存させることができたのかもしれません。遊び心と安定性を両立できなかったことは、開発者として悔しい限りです。しかし、今の私にとっては、自身のこだわりを貫くことよりも、サイトを確実に動く状態に戻し、皆様に快適な参拝環境をお返しすることを最優先すべきだと判断いたしました。</p>
                    <p>今後は、より慎重に開発を進めてまいります。重ねてになりますが、長時間にわたりご迷惑をおかけしましたことをお詫び申し上げます。</p>
                </div>
            `
        },
        {
            id: 13,
            title: "【復活】「全国・土地の運気予報」をテキスト版として再実装いたしました",
            date: "2026/1/5",
            time: "22:28",
            tag: "新機能",
            tagColor: "text-red-600",
            borderColor: "border-red-600",
            desc: "開発中止をお伝えした土地の運気機能ですが、地図を使わない「ランキング形式」として復活させました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。個人開発者のnden148です。</p>
                    <p>先ほど、技術的な課題（外部地図機能によるエラー多発）により「全国・土地の運気予報」の開発中止をお知らせいたしました。</p>
                    <p>しかし、あのお知らせを出した後も、「技術的に地図が無理だからといって、機能そのものを諦めて良いのか？」「皆様に日々の土地のエネルギーをお伝えしたいという当初の思いはどうなるのか？」と、一人パソコンの前で自問自答を繰り返しておりました。</p>
                    <p>企業が運営するサービスであれば、リスクを避けて「中止」で終わるのが正解かもしれません。しかし、ここは私が個人で情熱を注いでいる「天命乃杜」です。<strong>「地図がダメなら、文字で伝えればいい」</strong>という結論に至りました。</p>
                    
                    <h3>新機能：都道府県別・運気ランキング</h3>
                    <p>エラーの原因となっていた地図描画を廃止し、代わりに<strong>「47都道府県の運気スコアランキング」</strong>として機能を新生させました。</p>
                    <ul class="list-disc ml-5 mb-4">
                        <li><strong>全47都道府県を網羅：</strong> 北海道から沖縄まで、一切の省略なく全ての土地の運気を計算します。</li>
                        <li><strong>日替わりスコア（100点満点）：</strong> その日の星回りと土地の相性を数値化しました。</li>
                        <li><strong>詳細な運勢テキスト：</strong> 点数に応じて、その土地で過ごす際のアドバイスや心構えを長文で記しています。</li>
                    </ul>
                    <p>見た目の派手さは地図に劣るかもしれませんが、情報の「質」とシステムの「安定性」は格段に向上しております。私の悩みと執念の結果生まれたこの機能を、ぜひサイドメニューの「全国の運気」からお試しください。</p>
                </div>
            `
        },
        {
            id: 12,
            title: "【機能追加】過去記事の検索およびページ送り機能の実装",
            date: "2026/1/5",
            time: "21:45",
            tag: "機能追加",
            tagColor: "text-teal-600",
            borderColor: "border-teal-500",
            desc: "「社務所だより」と「神籤草子」に、キーワード検索機能とページ切り替え機能を追加しました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>この度、記事数が増加しても快適に閲覧いただけるよう、「社務所だより」および「神籤草子（コラム）」の一覧画面において、以下の機能追加を行いました。</p>
                    
                    <h3>1. キーワード検索機能</h3>
                    <p>一覧画面の上部に検索ボックスを設置いたしました。「作法」「待ち人」などのキーワードを入力することで、過去の記事やコラムの中から目的の内容を瞬時に探し出すことが可能です。</p>
                    
                    <h3>2. ページ送り機能（ページネーション）</h3>
                    <p>これまでは全記事を縦に長く表示しておりましたが、読みやすさを考慮し、一定件数ごとにページを分割いたしました。</p>
                    <ul class="list-disc ml-5 mb-4">
                        <li><strong>社務所だより：</strong> 1ページにつき5件表示</li>
                        <li><strong>神籤草子：</strong> 1ページにつき6件表示</li>
                    </ul>
                    <p>画面下部の「前へ」「次へ」ボタン、およびページ番号にて快適に読み進めていただけます。</p>
                    <p>今後とも参拝者の皆様にとって心地よい場所となりますよう、サイトの改良を重ねてまいります。</p>
                </div>
            `
        },
        {
            id: 11,
            title: "【システム】サーバー負荷軽減対策と理論値データ公開",
            date: "2026/1/5",
            time: "17:44",
            tag: "システム",
            tagColor: "text-gray-600",
            borderColor: "border-gray-800",
            desc: "Cloudflare Workers KVの読み取り制限に基づく詳細な理論値推移表を公開しました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日、安定したサービス提供継続のため、サイトの自動更新システムの調整を行いました。</p>
                    
                    <h3>当サイトの仕組みについて</h3>
                    <p>当サイトは、データベースとして<strong>「Cloudflare Workers KV」</strong>という技術を使用しています。このシステムには無料プランにおける利用制限（1日あたり読み取り10万回まで）が存在します。</p>
                    <p>今回、自動更新の間隔を「5秒」から「1分」に変更することで、この制限内でどれだけのユーザー様に利用いただけるかの<strong>理論値（Theoretical Value）</strong>が劇的に改善しました。</p>

                    <h3>負荷状況と許容人数の推移表（理論値）</h3>
                    <p>以下は、1人のユーザーが特定のタブ数・時間でサイトを開き続けた場合、1日あたり最大何人までアクセス可能かを計算した理論値です。</p>

                    <h4 class="font-bold text-red-600 mt-8 mb-2">▼ 【修正前】5秒更新（12回/分 × 2リクエスト）</h4>
                    <p class="text-xs mb-2 text-gray-500">※3タブ以上で24時間放置すると、たった1人でサーバーをダウンさせてしまう危険な設定でした。</p>
                    <div class="overflow-x-auto mb-8">
                        <table class="w-full text-xs border-collapse border border-gray-300 text-center" style="min-width: 500px;">
                            <thead class="bg-gray-100 dark:bg-zinc-700 font-bold">
                                <tr>
                                    <th class="p-2 border border-gray-300">タブ数</th>
                                    <th class="p-2 border border-gray-300">利用時間</th>
                                    <th class="p-2 border border-gray-300">読取回数/人</th>
                                    <th class="p-2 border border-gray-300">1日許容人数</th>
                                    <th class="p-2 border border-gray-300">判定</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 1タブ -->
                                <tr>
                                    <td rowspan="4" class="p-2 border border-gray-300 bg-gray-50 dark:bg-zinc-800 font-bold">1つ</td>
                                    <td class="p-2 border border-gray-300">1分間</td>
                                    <td class="p-2 border border-gray-300">24回</td>
                                    <td class="p-2 border border-gray-300">4,166人</td>
                                    <td class="p-2 border border-gray-300">注意</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">10分間</td>
                                    <td class="p-2 border border-gray-300">240回</td>
                                    <td class="p-2 border border-gray-300">416人</td>
                                    <td class="p-2 border border-gray-300">注意</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">1時間</td>
                                    <td class="p-2 border border-gray-300">1,440回</td>
                                    <td class="p-2 border border-gray-300">69人</td>
                                    <td class="p-2 border border-gray-300 text-red-600 font-bold">危険</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">24時間</td>
                                    <td class="p-2 border border-gray-300">34,560回</td>
                                    <td class="p-2 border border-gray-300">2人</td>
                                    <td class="p-2 border border-gray-300 text-red-600 font-bold">危険</td>
                                </tr>
                                <!-- 2タブ -->
                                <tr>
                                    <td rowspan="4" class="p-2 border border-gray-300 bg-gray-50 dark:bg-zinc-800 font-bold">2つ</td>
                                    <td class="p-2 border border-gray-300">1分間</td>
                                    <td class="p-2 border border-gray-300">48回</td>
                                    <td class="p-2 border border-gray-300">2,083人</td>
                                    <td class="p-2 border border-gray-300">注意</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">10分間</td>
                                    <td class="p-2 border border-gray-300">480回</td>
                                    <td class="p-2 border border-gray-300">208人</td>
                                    <td class="p-2 border border-gray-300 text-red-600 font-bold">危険</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">1時間</td>
                                    <td class="p-2 border border-gray-300">2,880回</td>
                                    <td class="p-2 border border-gray-300">34人</td>
                                    <td class="p-2 border border-gray-300 text-red-600 font-bold">危険</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">24時間</td>
                                    <td class="p-2 border border-gray-300">69,120回</td>
                                    <td class="p-2 border border-gray-300">1人</td>
                                    <td class="p-2 border border-gray-300 text-red-600 font-bold">危険</td>
                                </tr>
                                <!-- 3タブ -->
                                <tr>
                                    <td rowspan="4" class="p-2 border border-gray-300 bg-gray-50 dark:bg-zinc-800 font-bold">3つ</td>
                                    <td class="p-2 border border-gray-300">1分間</td>
                                    <td class="p-2 border border-gray-300">72回</td>
                                    <td class="p-2 border border-gray-300">1,388人</td>
                                    <td class="p-2 border border-gray-300 text-red-600 font-bold">危険</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">10分間</td>
                                    <td class="p-2 border border-gray-300">720回</td>
                                    <td class="p-2 border border-gray-300">138人</td>
                                    <td class="p-2 border border-gray-300 text-red-600 font-bold">危険</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">1時間</td>
                                    <td class="p-2 border border-gray-300">4,320回</td>
                                    <td class="p-2 border border-gray-300">23人</td>
                                    <td class="p-2 border border-gray-300 text-red-600 font-bold">危険</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">24時間</td>
                                    <td class="p-2 border border-gray-300">103,680回</td>
                                    <td class="p-2 border border-gray-300">0人</td>
                                    <td class="p-2 border border-gray-300 bg-red-100 text-red-800 font-bold">超過</td>
                                </tr>
                                <!-- 4タブ -->
                                <tr>
                                    <td rowspan="4" class="p-2 border border-gray-300 bg-gray-50 dark:bg-zinc-800 font-bold">4つ</td>
                                    <td class="p-2 border border-gray-300">1分間</td>
                                    <td class="p-2 border border-gray-300">96回</td>
                                    <td class="p-2 border border-gray-300">1,041人</td>
                                    <td class="p-2 border border-gray-300 text-red-600 font-bold">危険</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">10分間</td>
                                    <td class="p-2 border border-gray-300">960回</td>
                                    <td class="p-2 border border-gray-300">104人</td>
                                    <td class="p-2 border border-gray-300 text-red-600 font-bold">危険</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">1時間</td>
                                    <td class="p-2 border border-gray-300">5,760回</td>
                                    <td class="p-2 border border-gray-300">17人</td>
                                    <td class="p-2 border border-gray-300 bg-red-100 text-red-800 font-bold">停止</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">24時間</td>
                                    <td class="p-2 border border-gray-300">138,240回</td>
                                    <td class="p-2 border border-gray-300">0人</td>
                                    <td class="p-2 border border-gray-300 bg-black text-white font-bold">超過</td>
                                </tr>
                                <!-- 5タブ -->
                                <tr>
                                    <td rowspan="4" class="p-2 border border-gray-300 bg-gray-50 dark:bg-zinc-800 font-bold">5つ</td>
                                    <td class="p-2 border border-gray-300">1分間</td>
                                    <td class="p-2 border border-gray-300">120回</td>
                                    <td class="p-2 border border-gray-300">833人</td>
                                    <td class="p-2 border border-gray-300 text-red-600 font-bold">危険</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">10分間</td>
                                    <td class="p-2 border border-gray-300">1,200回</td>
                                    <td class="p-2 border border-gray-300">83人</td>
                                    <td class="p-2 border border-gray-300 bg-red-100 text-red-800 font-bold">停止</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">1時間</td>
                                    <td class="p-2 border border-gray-300">7,200回</td>
                                    <td class="p-2 border border-gray-300">13人</td>
                                    <td class="p-2 border border-gray-300 bg-red-100 text-red-800 font-bold">停止</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">24時間</td>
                                    <td class="p-2 border border-gray-300">172,800回</td>
                                    <td class="p-2 border border-gray-300">0人</td>
                                    <td class="p-2 border border-gray-300 bg-black text-white font-bold">超過</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h4 class="font-bold text-green-600 mt-6 mb-2">▼ 【修正後】60秒更新（現在の状態）</h4>
                    <p class="text-xs mb-2 text-gray-500">※最大負荷時でも余裕があり、数千〜数万人の同時アクセスに耐えうる設計となりました。</p>
                    <div class="overflow-x-auto mb-6">
                        <table class="w-full text-xs border-collapse border border-gray-300 text-center" style="min-width: 500px;">
                            <thead class="bg-blue-50 dark:bg-zinc-800 font-bold">
                                <tr>
                                    <th class="p-2 border border-gray-300">タブ数</th>
                                    <th class="p-2 border border-gray-300">利用時間</th>
                                    <th class="p-2 border border-gray-300">読取回数/人</th>
                                    <th class="p-2 border border-gray-300">1日許容人数</th>
                                    <th class="p-2 border border-gray-300">判定</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 1タブ -->
                                <tr>
                                    <td rowspan="4" class="p-2 border border-gray-300 bg-gray-50 dark:bg-zinc-800 font-bold">1つ</td>
                                    <td class="p-2 border border-gray-300">1分間</td>
                                    <td class="p-2 border border-gray-300">2回</td>
                                    <td class="p-2 border border-gray-300">50,000人</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-bold">余裕</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">10分間</td>
                                    <td class="p-2 border border-gray-300">20回</td>
                                    <td class="p-2 border border-gray-300">5,000人</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-bold">余裕</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">1時間</td>
                                    <td class="p-2 border border-gray-300">120回</td>
                                    <td class="p-2 border border-gray-300">833人</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-bold">余裕</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">24時間</td>
                                    <td class="p-2 border border-gray-300">2,880回</td>
                                    <td class="p-2 border border-gray-300">34人</td>
                                    <td class="p-2 border border-gray-300 text-blue-600 font-bold">安全</td>
                                </tr>
                                <!-- 2タブ -->
                                <tr>
                                    <td rowspan="4" class="p-2 border border-gray-300 bg-gray-50 dark:bg-zinc-800 font-bold">2つ</td>
                                    <td class="p-2 border border-gray-300">1分間</td>
                                    <td class="p-2 border border-gray-300">4回</td>
                                    <td class="p-2 border border-gray-300">25,000人</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-bold">余裕</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">10分間</td>
                                    <td class="p-2 border border-gray-300">40回</td>
                                    <td class="p-2 border border-gray-300">2,500人</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-bold">余裕</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">1時間</td>
                                    <td class="p-2 border border-gray-300">240回</td>
                                    <td class="p-2 border border-gray-300">416人</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-bold">余裕</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">24時間</td>
                                    <td class="p-2 border border-gray-300">5,760回</td>
                                    <td class="p-2 border border-gray-300">17人</td>
                                    <td class="p-2 border border-gray-300 text-blue-600 font-bold">安全</td>
                                </tr>
                                <!-- 3タブ -->
                                <tr>
                                    <td rowspan="4" class="p-2 border border-gray-300 bg-gray-50 dark:bg-zinc-800 font-bold">3つ</td>
                                    <td class="p-2 border border-gray-300">1分間</td>
                                    <td class="p-2 border border-gray-300">6回</td>
                                    <td class="p-2 border border-gray-300">16,666人</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-bold">余裕</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">10分間</td>
                                    <td class="p-2 border border-gray-300">60回</td>
                                    <td class="p-2 border border-gray-300">1,666人</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-bold">余裕</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">1時間</td>
                                    <td class="p-2 border border-gray-300">360回</td>
                                    <td class="p-2 border border-gray-300">277人</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-bold">余裕</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">24時間</td>
                                    <td class="p-2 border border-gray-300">8,640回</td>
                                    <td class="p-2 border border-gray-300">11人</td>
                                    <td class="p-2 border border-gray-300 text-blue-600 font-bold">安全</td>
                                </tr>
                                <!-- 4タブ -->
                                <tr>
                                    <td rowspan="4" class="p-2 border border-gray-300 bg-gray-50 dark:bg-zinc-800 font-bold">4つ</td>
                                    <td class="p-2 border border-gray-300">1分間</td>
                                    <td class="p-2 border border-gray-300">8回</td>
                                    <td class="p-2 border border-gray-300">12,500人</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-bold">余裕</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">10分間</td>
                                    <td class="p-2 border border-gray-300">80回</td>
                                    <td class="p-2 border border-gray-300">1,250人</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-bold">余裕</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">1時間</td>
                                    <td class="p-2 border border-gray-300">480回</td>
                                    <td class="p-2 border border-gray-300">208人</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-bold">余裕</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">24時間</td>
                                    <td class="p-2 border border-gray-300">11,520回</td>
                                    <td class="p-2 border border-gray-300">8人</td>
                                    <td class="p-2 border border-gray-300 text-blue-600 font-bold">安全</td>
                                </tr>
                                <!-- 5タブ -->
                                <tr>
                                    <td rowspan="4" class="p-2 border border-gray-300 bg-gray-50 dark:bg-zinc-800 font-bold">5つ</td>
                                    <td class="p-2 border border-gray-300">1分間</td>
                                    <td class="p-2 border border-gray-300">10回</td>
                                    <td class="p-2 border border-gray-300">10,000人</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-bold">余裕</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">10分間</td>
                                    <td class="p-2 border border-gray-300">100回</td>
                                    <td class="p-2 border border-gray-300">1,000人</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-bold">余裕</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">1時間</td>
                                    <td class="p-2 border border-gray-300">600回</td>
                                    <td class="p-2 border border-gray-300">166人</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-bold">余裕</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300">24時間</td>
                                    <td class="p-2 border border-gray-300">14,400回</td>
                                    <td class="p-2 border border-gray-300">6人</td>
                                    <td class="p-2 border border-gray-300 text-blue-600 font-bold">安全</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `
        },
        {
            id: 9,
            title: "【修正】TENMEI Labs機能の挙動改善について",
            date: "2026/1/5",
            time: "16:05",
            tag: "機能改善",
            tagColor: "text-green-600",
            borderColor: "border-green-500",
            desc: "「宵闇の刻」および「言霊の増幅」に関する表示不具合を修正しました。",
            content: `<p>TENMEI Labs（実験室）で提供している機能について、以下の修正を行いました。</p><h3>1. 「宵闇の刻」の挙動統一</h3><p>これまで、端末（OS）の設定がダークモードの場合、サイトの一部配色が正しく切り替わらない（完全なダークモードにならない）問題が発生しておりました。</p><p>本日の更新により、OS設定でダークモードをご利用の場合でも、Labs機能「宵闇の刻」をONにした際と同様の、正しい配色（完全なダークテーマ）が適用されるよう修正・統一いたしました。</p><h3>2. 「言霊の増幅」の適用範囲拡大</h3><p>文字サイズを大きくする「言霊の増幅」モードにおいて、一部のテキストやカードのサイズが拡大されていなかった問題を修正しました。これにより、より広範囲で視認性が向上しております。</p>`
        },
        {
            id: 8,
            title: "【重要】「全国・土地の運気予報」の開発中止に関するお知らせ",
            date: "2026/1/5",
            time: "14:30",
            tag: "重要",
            tagColor: "text-red-600",
            borderColor: "border-gray-800",
            desc: "技術的な不具合により、マップ機能の開発を完全に中止いたしました。代替案もございません。",
            content: `<p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p><p>以前より「TENMEI Labs」の追加機能として検討しておりました「全国・土地の運気予報（マップ機能）」につきまして、検討の結果、開発を完全に中止することといたしました。なお、本機能につきましては別の形での実装や代替機能の提供予定もございません。</p><h3>中止の理由</h3><p>外部地図ライブラリの導入に伴うシステムの深刻な不安定化、およびプログラム上の修復困難なエラーが複数確認されました。無理な実装を強行することは、現在安定して稼働している他の機能（おみくじやLabs等）の動作を損なう致命的なリスクがあると判断いたしました。</p><h3>今後の展望</h3><p>期待をお寄せいただいた皆様には誠に申し訳ございませんが、今後は新たな地図機能の模索は行わず、既存機能の保守と品質向上にのみ注力してまいります。何卒ご理解を賜りますようお願い申し上げます。</p>`
        },
        {
            id: 10,
            title: "【更新】TENMEI LabsのUIを大幅に変更いたしました",
            date: "2026/1/5",
            time: "12:55",
            tag: "デザイン",
            tagColor: "text-indigo-600",
            borderColor: "border-indigo-500",
            desc: "実験室（Labs）の画面デザインを、より現代的で没入感のある形式に刷新しました。",
            content: `<p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p><p>会員限定機能「TENMEI Labs（天命ラボ）」のユーザーインターフェース（UI）を大幅にリニューアルいたしました。</p><h3>視覚的な没入感の向上</h3><p>従来のシンプルなリスト形式から、背景に流体アニメーション（オーロラエフェクト）を取り入れたモダンなカード型デザインへと変更いたしました。また、シンボルである「フラスコ」のアニメーションも、液体の揺らぎや波紋をよりリアルに表現したものに一新しております。</p><p>機能のON/OFFスイッチもより直感的に操作できるよう改善いたしました。新しくなった実験室の雰囲気を、ぜひお楽しみください。</p>`
        },
        {
            id: 7,
            title: "【重要】認証システムに関する不具合の修正とお詫び",
            date: "2026/1/4",
            time: "08:00",
            tag: "障害報告",
            tagColor: "text-red-600",
            borderColor: "border-red-500",
            desc: "ログインおよびアカウント管理に関する重大な不具合を修正いたしました。",
            content: `<p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。2026年1月3日頃より発生しておりました、ログイン認証システムに関する重大な不具合について、修正が完了いたしましたことをご報告申し上げます。</p><h3>修正された不具合の内容</h3><p>1. ログイン時、パスワードが一致しない状態でも認証コードが送信される問題<br>2. パスワード不一致のまま認証を完了させると、意図せずアカウントが削除される問題<br>3. 未登録のメールアドレスに対しても、ログイン認証コードが送信される問題</p><h3>原因と経緯</h3><p>本不具合は、昨日（1月3日）のシステム更新の際、運営者によるコード編集上の不注意（人為的ミス）により発生いたしました。セキュリティに関わる重要な機能において、ユーザーの皆様にご不安とご不便をおかけしましたこと、深くお詫び申し上げます。現在はバリデーションロジックを全面的に見直し、正常な挙動に復旧しております。今後、再発防止に向けてコード管理の徹底に努めてまいります。</p>`
        },
        {
            id: 6,
            title: "新機能「TENMEI Labs」を公開いたしました。",
            date: "2026/1/3",
            time: "17:01",
            tag: "お知らせ",
            tagColor: "text-purple-600",
            borderColor: "border-purple-500",
            desc: "実験的な新機能を体験できるLabsページを会員様限定で追加しました。",
            content: `<p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p><p>この度、当サイトの実験的な試みとして、新機能<strong>「TENMEI Labs（天命ラボ）」</strong>を公開いたしました。</p><p>Labsでは、開発中の新機能や、サイトの雰囲気を大きく変える特殊なカスタマイズ設定をいち早く体験いただくことが可能です。現在は「迎春・雅モード」や「神速の祈り」など、複数の実験的な機能を公開しております。</p><p>本機能は、会員登録（ログイン）を行っていただくことでご利用いただけます。サイドバーのフラスコアイコンより、ぜひ未知の天命体験をお楽しみください。</p><p>今後も「杜」の技術革新に努めてまいります。何卒よろしくお願い申し上げます。</p>`
        },
        {
            id: 2,
            title: "「運勢・天命乃杜」を公開いたしました。",
            date: "2026/1/2",
            time: "16:00",
            tag: "お知らせ",
            tagColor: "text-blue-600",
            borderColor: "border-blue-500",
            desc: "本サービスを正式にリリースいたしました。",
            content: `<p>平素より格別のご高配を賜り、厚く御礼申し上げます。</p><p>この度、誰でも気軽に、かつ本格的な運勢占いを楽しめるWebサイト「運勢・天命乃杜（てんめいのもり）」を正式に公開いたしました。</p><p>当サイトでは、伝統的なおみくじの要素に加え、西洋占星術と血液型診断を組み合わせた独自のアルゴリズムによる「日替わり運勢ランキング」を提供しております。また、会員登録（無料）を行っていただくことで、ご自身の運勢履歴を保存したり、全体の統計データに参加したりすることが可能です。今後もコンテンツの拡充や機能改善に努めてまいりますので、末永くご愛顧いただけますようお願い申し上げます。</p>`
        },
        {
            id: 1,
            title: "あけましておめでとうごさいます",
            date: "2026/1/1",
            time: "00:00",
            tag: "ご挨拶",
            tagColor: "text-gray-600",
            borderColor: "border-gray-500",
            desc: "謹んで新年のご祝詞を申し上げます。",
            content: `<p>謹んで新年のご祝詞を申し上げます。</p><p>旧年中はひとかたならぬご厚情を賜り、誠にありがとうございました。<br>本年も皆様に幸多き年となりますよう、天命乃杜運営一同、心よりお祈り申し上げます。</p><p>新しい年が始まり、皆様それぞれに新たな目標や願いをお持ちのことと存じます。当サイトのおみくじが、皆様の迷いを晴らし、一歩を踏み出すための道標となれば幸いです。本年も変わらぬご愛顧のほど、よろしくお願い申し上げます。</p>`
        },
        {
            id: 3,
            title: "プレオープンのお知らせ",
            date: "2025/12/25",
            time: "10:00",
            tag: "お知らせ",
            tagColor: "text-gray-600",
            borderColor: "border-gray-400",
            desc: "一部機能を先行公開いたしました。",
            content: `<p>本日より、一部機能を制限した状態でのプレオープンを開始いたしました。</p><p>現在ご利用いただけるのは、「おみくじ機能」および「12星座占い（β版）」です。正式リリース時には、履歴保存機能や会員システムが追加される予定です。</p>`
        },
        {
            id: 4,
            title: "サーバーメンテナンス完了",
            date: "2025/12/20",
            time: "18:00",
            tag: "メンテナンス",
            tagColor: "text-green-600",
            borderColor: "border-green-500",
            desc: "予定されていたメンテナンスは無事終了しました。",
            content: `<p>本日14:00より実施しておりましたサーバーメンテナンスは、予定通り18:00に完了いたしました。</p><p>今回のメンテナンスにより、データベースの応答速度が向上しております。ご協力ありがとうございました。</p>`
        },
        {
            id: 5,
            title: "サイト開設準備室より",
            date: "2025/12/10",
            time: "12:00",
            tag: "お知らせ",
            tagColor: "text-gray-600",
            borderColor: "border-gray-400",
            desc: "現在、正式公開に向けて最終調整を行っております。",
            content: `<p>「運勢・天命乃杜」の開設に向け、現在鋭意開発中です。</p><p>皆様に愛されるサイトを目指し、デザインの調整や占いロジックの検証を行っております。公開まで今しばらくお待ちください。</p>`
        }
    ];

    // ■ 神籤草子（コラム）データ
    const columnData = [


        {
            id: 19,
            title: "【検定・中級】知っていると自慢できる？神社の名称クイズ",
            date: "2026/01/12",
            category: "クイズ",
            icon: "bi-mortarboard-fill",
            colorClass: "purple",
            content: `
                <div class="article-content">
                    <p>先ほどの問題は準備運動です。ここからは少し難易度を上げて、普段目にしているけれど「名前」までは意外と知らない、そんな神社のパーツを答えていただきます。</p>
                    
                    <!-- 第1問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-purple-200 dark:border-purple-900">
                        <span class="inline-block bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第1問</span>
                        <h3 class="font-bold text-lg mb-4 text-purple-700 dark:text-purple-300">Q1. 注連縄（しめなわ）や玉串に付いている、稲妻のような形をした「白い紙」の名前は？</h3>
                        
                        <div class="space-y-4">
                            <input type="text" id="quiz-hard-1" placeholder="答えを入力..." 
                                class="w-full p-4 rounded-lg bg-gray-800 text-white text-lg font-bold border border-gray-600 focus:outline-none focus:border-purple-500 transition-colors placeholder-gray-500"
                                style="caret-color: white;">
                            
                            <button onclick="handleInputQuiz(this, ['紙垂', 'しで', 'シデ', '四手'], 1)" 
                                class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg shadow-md transition transform active:scale-95">
                                回答する
                            </button>
                        </div>

                        <div class="hidden mt-6 pt-4 border-t border-gray-300 quiz-result">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-purple-600">正解：紙垂（しで）</span><br>
                                神聖・清浄をあらわす紙です。独特のギザギザした形は「雷（稲妻）」を象徴しており、雷が多い年は豊作になることから、邪気を払い豊作を祈願する意味が込められています。
                            </div>
                        </div>
                    </div>

                    <!-- 第2問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-purple-200 dark:border-purple-900">
                        <span class="inline-block bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第2問</span>
                        <h3 class="font-bold text-lg mb-4 text-purple-700 dark:text-purple-300">Q2. 拝殿で鈴（本坪鈴）を鳴らすために垂れ下がっている、あの太い「紐（ひも）」の正式名称は？</h3>
                        
                        <div class="space-y-4">
                            <input type="text" id="quiz-hard-2" placeholder="答えを入力..." 
                                class="w-full p-4 rounded-lg bg-gray-800 text-white text-lg font-bold border border-gray-600 focus:outline-none focus:border-purple-500 transition-colors placeholder-gray-500"
                                style="caret-color: white;">
                            
                            <button onclick="handleInputQuiz(this, ['鈴緒', 'すずお', 'スズオ'], 2)" 
                                class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg shadow-md transition transform active:scale-95">
                                回答する
                            </button>
                        </div>

                        <div class="hidden mt-6 pt-4 border-t border-gray-300 quiz-result">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-purple-600">正解：鈴緒（すずお）</span><br>
                                文字通り「鈴の緒」です。紅白や五色の布をねじって作られることが多く、この緒を通じて神様と繋がる（ご縁を結ぶ）という意味合いも持っています。
                            </div>
                        </div>
                    </div>

                    <!-- 第3問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-purple-200 dark:border-purple-900">
                        <span class="inline-block bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第3問</span>
                        <h3 class="font-bold text-lg mb-4 text-purple-700 dark:text-purple-300">Q3. 神社の屋根の上に並んでいる、丸太のような部材の名前は？（ある魚に似ていることが由来）</h3>
                        
                        <div class="space-y-4">
                            <input type="text" id="quiz-hard-3" placeholder="答えを入力..." 
                                class="w-full p-4 rounded-lg bg-gray-800 text-white text-lg font-bold border border-gray-600 focus:outline-none focus:border-purple-500 transition-colors placeholder-gray-500"
                                style="caret-color: white;">
                            
                            <button onclick="handleInputQuiz(this, ['鰹木', 'かつおぎ', 'カツオギ', '勝男木', '堅魚木'], 3)" 
                                class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg shadow-md transition transform active:scale-95">
                                回答する
                            </button>
                        </div>

                        <div class="hidden mt-6 pt-4 border-t border-gray-300 quiz-result">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-purple-600">正解：鰹木（かつおぎ）</span><br>
                                屋根の棟に対して直角に並べられた装飾です。形が「鰹節（かつおぶし）」に似ていることからこの名がつきました。ちなみに、屋根の両端でクロスして突き出ている板は「千木（ちぎ）」と呼びます。
                            </div>
                        </div>
                    </div>
                </div>
            `
        },
        {
            id: 18,
            title: "【検定】神社の常識、漢字で書けますか？（入力式クイズ）",
            date: "2026/01/12",
            category: "クイズ",
            icon: "bi-pencil-square",
            colorClass: "indigo",
            content: `
                <div class="article-content">
                    <p>今回は趣向を変えて、選択肢なしの「入力式」クイズです。神社の風景にある「あの名前」、ひらがなでも正解になりますので、ぜひ挑戦してみてください。</p>
                    
                    <!-- 第1問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第1問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q1. 神域と俗界を区画する「結界」であり、神様の世界への入り口を示す門のような建造物は？</h3>
                        
                        <div class="space-y-4">
                            <input type="text" id="quiz-input-1" placeholder="答えを入力..." 
                                class="w-full p-4 rounded-lg bg-gray-800 text-white text-lg font-bold border border-gray-600 focus:outline-none focus:border-indigo-500 transition-colors placeholder-gray-500"
                                style="caret-color: white;">
                            
                            <button onclick="handleInputQuiz(this, ['鳥居', 'とりい', 'トリイ'], 1)" 
                                class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-md transition transform active:scale-95">
                                回答する
                            </button>
                        </div>

                        <div class="hidden mt-6 pt-4 border-t border-gray-300 quiz-result">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">正解：鳥居（とりい）</span><br>
                                神社の象徴とも言える鳥居。その起源には諸説ありますが、「天岩戸」伝説で鶏（常世の長鳴鳥）を鳴かせた止まり木に由来するという説や、海外の門（インドのトラナ等）が変化したという説があります。
                            </div>
                        </div>
                    </div>

                    <!-- 第2問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第2問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q2. 参拝の前に、手や口をすすいで心身を清めるために水が張ってある場所を何という？</h3>
                        
                        <div class="space-y-4">
                            <input type="text" id="quiz-input-2" placeholder="答えを入力..." 
                                class="w-full p-4 rounded-lg bg-gray-800 text-white text-lg font-bold border border-gray-600 focus:outline-none focus:border-indigo-500 transition-colors placeholder-gray-500"
                                style="caret-color: white;">
                            
                            <button onclick="handleInputQuiz(this, ['手水舎', 'てみずや', 'ちょうずや', 'てみずしゃ', 'ちょうずしゃ', '手水'], 2)" 
                                class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-md transition transform active:scale-95">
                                回答する
                            </button>
                        </div>

                        <div class="hidden mt-6 pt-4 border-t border-gray-300 quiz-result">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">正解：手水舎（てみずや／ちょうずや）</span><br>
                                読み方はどちらも正解です。かつて川や海に入って全身を清めた「禊（みそぎ）」を簡略化したもので、神様の前に立つための最も重要な作法の一つです。
                            </div>
                        </div>
                    </div>

                    <!-- 第3問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第3問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q3. 神聖な場所であることを示し、不浄なものの侵入を防ぐために張られる「縄」は？</h3>
                        
                        <div class="space-y-4">
                            <input type="text" id="quiz-input-3" placeholder="答えを入力..." 
                                class="w-full p-4 rounded-lg bg-gray-800 text-white text-lg font-bold border border-gray-600 focus:outline-none focus:border-indigo-500 transition-colors placeholder-gray-500"
                                style="caret-color: white;">
                            
                            <button onclick="handleInputQuiz(this, ['注連縄', 'しめなわ', 'しめ縄', '七五三縄', '標縄'], 3)" 
                                class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-md transition transform active:scale-95">
                                回答する
                            </button>
                        </div>

                        <div class="hidden mt-6 pt-4 border-t border-gray-300 quiz-result">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">正解：注連縄（しめなわ）</span><br>
                                「七五三縄」と書くこともあります。天岩戸から出た天照大御神が二度と戻らないように縄を張った神話が起源とされ、神様の領域（常世）と現世（うつしよ）を隔てる結界の役割を持ちます。
                            </div>
                        </div>
                    </div>
                </div>
            `
        },
        {
            id: 17,
            title: "【歳時記】大人の仲間入りと神様への報告 — 成人の日によせて",
            date: "2026/01/12",
            category: "歳時記",
            icon: "bi-flower1",
            colorClass: "pink",
            content: `
                <div class="article-content">
                    <p>前回の更新（1月6日）をもって、長らく進めていたこのサイトのシステム開発が一通り完了いたしました。そのため、少し休息を取りつつ、実は別のサイトの開発に着手しておりました。そんな事情で少し更新の間隔が空いてしまいましたが、皆様いかがお過ごしでしょうか。</p>
                    
                    <p>さて、本日<strong>1月12日は「成人の日」</strong>です。今年晴れて新成人となられた皆様、誠におめでとうございます。</p>

                    <h3>神様から見た「大人」とは？</h3>
                    <p>現代では20歳（あるいは18歳）が成人の節目ですが、かつての日本には<strong>「元服（げんぷく）」</strong>という通過儀礼がありました。数え年の12〜16歳頃に行われ、髪型や服装を改めて、神様の前で「大人の仲間入り」を誓う儀式です。</p>
                    
                    <p>これは単にお祝いをするだけでなく、<strong>「神様の守り子である『氏子（うじこ）』として、一人前の責任を負い、地域社会に貢献する」</strong>と宣言する場でもありました。</p>

                    <h3>初心に立ち返る日として</h3>
                    <p>振袖や袴、スーツといった晴れ着は、かつての「冠（かんむり）」にあたります。外見を整えることで、内面の覚悟も新たにする。それが日本の伝統的な「ハレの日」の作法です。</p>

                    <p>すでに大人になられて久しい方も、今日はご自身の成人式や若き日の志を思い出し、地元の神社へ「おかげさまで、今日も無事に過ごせています」と報告に訪れてみてはいかがでしょうか。初心に立ち返り、背筋を伸ばすことで、また新しい良い運気が巡ってくるはずです。</p>
                </div>
            `
        },
        {
            id: 16,
            title: "【クイズ】知れば参拝が楽しくなる！神社の道具・作法編",
            date: "2026/01/06",
            category: "クイズ",
            icon: "bi-question-circle-fill",
            colorClass: "indigo",
            content: `
                <div class="article-content">
                    <p>神社の境内にある「道具」や、なんとなく行っている「習慣」。それら一つ一つには、神道に基づいた深い意味や理由が存在します。今回は、知っているようで知らない参拝の常識クイズです。</p>
                    
                    <!-- 第1問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第1問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q1. 拝殿の前にある「鈴（すず）」。これを鳴らす本来の目的は？</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, false, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 神様を起こすため（来訪の合図）
                            </button>
                            <button onclick="handleQuiz(this, true, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 自分の身を清めるため（祓い）
                            </button>
                            <button onclick="handleQuiz(this, false, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. お賽銭を入れた確認のため
                            </button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「2」</strong>です。<br>
                                鈴の清らかな音色には、邪気を払い、参拝者自身の心身を清める<strong>「祓（はら）い」</strong>の力があると考えられています。神様をお呼びするという側面もありますが、主たる目的は、神様の前に立つ前に自分を清浄にすることです。
                            </div>
                        </div>
                    </div>

                    <!-- 第2問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第2問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q2. 正式参拝などで「玉串（たまぐし/榊）」を神様にお供えする際、正しい向きは？</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, true, 0)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 根元（茎）を神様に向けて置く
                            </button>
                            <button onclick="handleQuiz(this, false, 0)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 葉先を神様に向けて置く
                            </button>
                            <button onclick="handleQuiz(this, false, 0)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. 横向き（平行）に置く
                            </button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「1」</strong>です。<br>
                                受け取る時は「根元が自分側」ですが、お供えする際は、時計回りに回して<strong>「根元を神様側」</strong>に向けて台に置きます。これは神様に対して敬意を表し、根の方から神聖な力を受け取るという意味合いもあります。
                            </div>
                        </div>
                    </div>

                    <!-- 第3問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第3問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q3. 語呂合わせの「縁起」において、お賽銭で避けたほうが良いとされる硬貨は？</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, false, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 5円玉（ご縁）
                            </button>
                            <button onclick="handleQuiz(this, false, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 50円玉（五重の縁）
                            </button>
                            <button onclick="handleQuiz(this, true, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. 10円玉（遠縁）
                            </button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「3」</strong>です。<br>
                                10円玉は<strong>「遠縁（とおえん）＝縁が遠ざかる」</strong>と読めるため、縁結び祈願などでは避ける人が多いです（500円玉も「これ以上硬貨（効果）がない」とされることがあります）。ただし、これらはあくまで語呂合わせの俗信であり、神様への感謝の気持ちがあれば金額や硬貨の種類は本来問いません。
                            </div>
                        </div>
                    </div>
                </div>
            `
        },
        {
            id: 15,
            title: "拝殿の鏡が映し出すもの —「かがみ」から「が」を取ると？",
            date: "2026/01/06",
            category: "読み解き",
            icon: "bi-record-circle",
            colorClass: "green",
            content: `
                <div class="article-content">
                    <p>神社の拝殿で手を合わせる際、奥に丸い「鏡（神鏡）」が祀られているのを見たことがあるでしょうか。あれは単なる装飾ではなく、天照大御神（太陽神）の象徴であり、ご神体そのものとして扱われる極めて重要なものです。</p>
                    
                    <h3>鏡が映し出す「正体」</h3>
                    <p>鏡の前に立つと、そこには何が映るでしょうか？当然、参拝している「自分自身」の姿です。これには深い意味があります。神道には<strong>「鏡（かがみ）から、我（が）を取ると、神（かみ）になる」</strong>という有名な教えがあります。</p>

                    <h3>「我（エゴ）」を取り払う修行</h3>
                    <p>鏡に映る自分と向き合い、その中にある「我欲（エゴ、執着、見栄）」を取り払った時、人の心には本来の清らかな「神性（神様の心）」が現れるということを示しています。つまり、神社への参拝は、神様に願い事をする場であると同時に、鏡を通じて<strong>「本来の清らかな自分（神）」に立ち返るための儀式</strong>でもあるのです。</p>
                    
                    <p>おみくじを引く際も、この鏡のような心持ちで、欲を捨てて無心になることで、より正確な天命（メッセージ）を受け取ることができると言われています。</p>
                </div>
            `
        },
        {
            id: 14,
            title: "なぜ神社の鳥居や社殿は「赤（朱色）」なのか？",
            date: "2026/01/06",
            category: "雑学",
            icon: "bi-palette-fill",
            colorClass: "red",
            content: `
                <div class="article-content">
                    <p>伏見稲荷大社の千本鳥居をはじめ、多くの神社の鳥居や社殿には鮮やかな「赤（朱色）」が使われています。これには、単なるデザイン以上の「科学的」かつ「霊的」な二つの重要な理由が存在します。</p>
                    
                    <h3>科学的理由：最強の防腐剤</h3>
                    <p>古来、朱色の塗料の原料には「丹（に）」と呼ばれる<strong>水銀（硫化水銀）</strong>が含まれていました。水銀には強力な防虫・防腐作用があります。日本の神社は木造建築が基本であり、雨や湿気、シロアリから建物を守り、長い年月維持するために、当時の最高級の防腐剤である「朱」が塗られたのです。</p>

                    <h3>霊的理由：魔除けと生命の象徴</h3>
                    <p>精神的な意味において、赤は「火」や「太陽」、「血」の色であり、<strong>生命の躍動</strong>を象徴します。また、古くから赤色には<strong>「魔除け（災厄を退ける力）」</strong>があると信じられてきました。</p>
                    <p>神聖な場所（神域）に邪悪な霊や災いが入ってこないように結界を張る意味で、入口である鳥居や社殿そのものを赤く染め上げているのです。当サイトのテーマカラーに「紅」が使われているのも、この魔除けと開運の力をデジタルの杜に取り入れるためです。</p>
                </div>
            `
        },
        {
            id: 13,
            title: "【特別クイズ】目指せ参拝の達人！神社検定・超難問10番勝負",
            date: "2026/01/06",
            category: "特別クイズ",
            icon: "bi-trophy-fill",
            colorClass: "yellow",
            content: `
                <div class="article-content">
                    <p>今回は「天命乃杜」からの挑戦状です。神社の歴史、作法、おみくじの深い知識を問う全10問の検定試験。全問正解できれば、あなたは真の「参拝の達人」です！</p>
                    
                    ${[
                        {q: "Q1. 明治神宮（東京）のおみくじには、他と違って『あるもの』が書かれていません。それは何？", a: ["吉凶（大吉や凶）", "和歌", "ラッキーカラー"], c: 0, exp: "明治神宮のおみくじ『大御心（おおみごころ）』には吉凶がありません。代わりに明治天皇や昭憲皇太后が詠まれた和歌と、その解説が記されています。"},
                        {q: "Q2. 出雲大社（島根）での正式な参拝方法は？", a: ["二礼二拍手一礼", "二礼四拍手一礼", "四礼四拍手一礼"], c: 1, exp: "一般的には二拍手ですが、出雲大社（および宇佐神宮など）では古くからの伝統により『四拍手』を打つのが正式な作法です。"},
                        {q: "Q3. 神社にある『しめ縄』のルーツとされている日本神話の場面は？", a: ["天の岩戸隠れ", "ヤマタノオロチ退治", "国譲り"], c: 0, exp: "天照大御神が岩戸から出てきた際、二度と戻れないように『尻久米縄（しりくめなわ）』を張ったのが始まりとされています。"},
                        {q: "Q4. 手水舎で、最後に柄杓（ひしゃく）を立てて水を流す理由は？", a: ["残った水を捨てるため", "自分が使った柄を清めるため", "神様に感謝を示すため"], c: 1, exp: "次に使う人のために、自分が握った柄の部分を洗い流して清めるのがマナーです。"},
                        {q: "Q5. 厳島神社の海に浮かぶ大鳥居。なぜ倒れずに立っていられる？", a: ["深く埋まっているから", "重石が入って自立しているから", "魔法の力で固定されているから"], c: 1, exp: "実は埋まっているのではなく、自重（約60トン）と、屋根の部分に詰められた大量の経石（石）の重みで海底に置かれているだけなのです。"},
                        {q: "Q6. おみくじで『待ち人』が『来る、遅し』とある場合、その『人』とは誰のこと？", a: ["好きな人や恋人", "自分の人生を好転させる人", "配達員"], c: 1, exp: "恋愛相手だけでなく、良い知らせを運ぶ人や助けてくれる人など、自分の運命に重要な影響を与える人物全般を指します。"},
                        {q: "Q7. 伊勢神宮の内宮に祀られている最高位の神様は？", a: ["天照大御神", "豊受大御神", "須佐之男命"], c: 0, exp: "内宮（皇大神宮）は皇室の祖神であり、太陽にも例えられる天照大御神（あまてらすおおみかみ）を祀っています。"},
                        {q: "Q8. 狛犬の『阿（あ）』と『吽（うん）』。口を閉じているのはどっち？", a: ["阿（向かって右）", "吽（向かって左）", "両方閉じている"], c: 1, exp: "『阿』は口を開け（始まり）、『吽』は口を閉じています（終わり）。宇宙の万物の始まりと終わりを表現しています。"},
                        {q: "Q9. おみくじの『失せ物（うせもの）』が指すのは、落とした物だけ？", a: ["はい、落とし物だけです", "いいえ、失った信頼やチャンスも含む", "いいえ、未来の宝物も含む"], c: 1, exp: "物理的な落とし物だけでなく、忘れてしまった初心や、逃したチャンス、疎遠になった人間関係なども含まれます。"},
                        {q: "Q10. 最も格の高い神社の称号を『社号』と呼びますが、伊勢神宮の正式名称は？", a: ["伊勢大神宮", "神宮", "伊勢神社"], c: 1, exp: "他の神社と区別するため、単に『神宮』と呼ぶのが正式名称です。それほどまでに特別な存在とされています。"}
                    ].map((item, i) => `
                        <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-yellow-200 dark:border-yellow-900">
                            <span class="inline-block bg-yellow-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第${i+1}問</span>
                            <h3 class="font-bold text-lg mb-4 text-yellow-800 dark:text-yellow-200">${item.q}</h3>
                            <div class="space-y-3">
                                ${item.a.map((ans, idx) => `
                                    <button onclick="handleQuiz(this, ${idx === item.c}, ${item.c})" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                        ${idx + 1}. ${ans}
                                    </button>
                                `).join('')}
                            </div>
                            <div class="hidden mt-6 pt-4 border-t border-gray-300">
                                <div class="quiz-msg text-xl font-black mb-2"></div>
                                <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                    <span class="font-bold text-yellow-600">解説：</span><br>${item.exp}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `
        },
        {
            id: 12,
            title: "和歌の心を読む — おみくじの裏側に隠された真実",
            date: "2026/01/06",
            category: "読み解き",
            icon: "bi-journal-richtext",
            colorClass: "green",
            content: `
                <div class="article-content">
                    <p>おみくじを引いて、真っ先に『大吉』や『凶』の文字だけを見て一喜一憂していませんか？ 実は、おみくじにおいて最も重要で、神様からの直接のメッセージが込められているのは、その横や裏に記された『和歌』なのです。</p>
                    
                    <h3>なぜ『吉凶』より『和歌』なのか</h3>
                    <p>吉凶のランクは、あくまでその瞬間の『勢い』を示す天気予報のようなものです。一方で和歌は、あなたが直面している問題に対する具体的な『指針』を示しています。和歌は古来より言霊（ことだま）が宿るとされ、その31文字の中には、現在のあなたの心の状態を映し出す鏡のような役割があります。</p>

                    <h3>情景から読み解くアドバイス</h3>
                    <p>例えば『枯れ木に花が咲く』という情景の歌であれば、今は苦しくても必ず好転するという希望を説いています。逆に『照りつける太陽』のような歌であれば、勢いはあるが傲慢になっていないか、という戒めが含まれています。</p>

                    <h3>自分の状況に引き寄せる</h3>
                    <p>和歌を読み解くコツは、今の悩みを頭に浮かべながら、歌の中の『登場人物』や『風景』を自分に置き換えてみることです。当杜のおみくじに添えられている言葉も、この和歌の精神をベースに現代的に解釈したものです。文字の奥にある「心」を読み取ることで、おみくじは単なる占いから、人生の羅針盤へと変わるでしょう。</p>
                </div>
            `
        },
        {
            id: 11,
            title: "鳥居の向こう側 — 神域と俗界を分ける境界線",
            date: "2026/01/06",
            category: "建築",
            icon: "bi-bank",
            colorClass: "green",
            content: `
                <div class="article-content">
                    <p>神社に足を踏み入れる際、必ず通るのが『鳥居』です。単なる入り口の門だと思われがちですが、そこには深い宗教的・哲学的な意味が込められています。</p>
                    
                    <h3>結界としての役割</h3>
                    <p>鳥居は、私たちの住む現実世界（俗界）と、神様がお鎮まりになる神聖な場所（神域）を区切る『結界』の役割を果たしています。鳥居をくぐるということは、神聖な空間に入るための最初の儀式です。そのため、くぐる前に衣服を整え、軽く一礼をするのが本来の作法とされています。</p>

                    <h3>二つの大きな形式：神明と明神</h3>
                    <p>日本全国には数多くの鳥居がありますが、大きく分けて二つの系統があります。
                    一つは『神明（しんめい）系』。伊勢神宮などに代表される、直線的で素朴な構造です。
                    もう一つは『明神（みょうじん）系』。柱の上に反り増しがある笠木が乗った、装飾的な形式です。私たちが普段目にする多くの鳥居はこちらの明神系に属します。</p>

                    <h3>なぜ『鳥』の居場所なのか</h3>
                    <p>諸説ありますが、日本神話において天照大御神が岩戸に隠れた際、常世の長鳴鳥（鶏）を鳴かせて神の出現を促したという伝説に基づき、神の使いである鳥が止まる場所として作られたという説が有力です。次に参拝される際は、その鳥居がどのような形をしており、どのような素材で作られているか観察してみてください。神域への入口は、すでにそこから始まっているのです。</p>
                </div>
            `
        },
        {
            id: 10,
            title: "【クイズ】神社の「動物」にまつわる謎（全3問）",
            date: "2026/01/06",
            category: "クイズ",
            icon: "bi-question-circle-fill",
            colorClass: "indigo",
            content: `
                <div class="article-content">
                    <p>神社には「狛犬」をはじめ、さまざまな動物の像が置かれています。これらは「神使（しんし）」と呼ばれ、神様の使いとされています。今回はそんな神社の動物に関するクイズです。</p>
                    
                    <!-- 第1問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第1問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q1. 稲荷神社でおなじみの「キツネ」。彼らが口にくわえているもので、実在しない「霊力のある宝物」はどれ？</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, false, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 稲穂（いなほ）
                            </button>
                            <button onclick="handleQuiz(this, true, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 宝珠（ほうじゅ）
                            </button>
                            <button onclick="handleQuiz(this, false, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. 鍵（かぎ）
                            </button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「2」</strong>です。宝珠（ほうじゅ）は、どんな願いも叶うとされる仏教由来の宝の玉です。お稲荷様のキツネは、稲穂、鍵、巻物、そして宝珠のいずれかをくわえていることが多いですが、宝珠だけが伝説上のアイテムです。
                            </div>
                        </div>
                    </div>

                    <!-- 第2問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第2問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q2. 天満宮（菅原道真公を祀る神社）で「牛」の像が必ず置かれているのはなぜ？</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, true, 0)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 道真公が丑年生まれで、牛を慈しんだから
                            </button>
                            <button onclick="handleQuiz(this, false, 0)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 道真公が牛に乗って戦った伝説があるから
                            </button>
                            <button onclick="handleQuiz(this, false, 0)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. 牛が知恵の象徴とされていたから
                            </button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「1」</strong>です。道真公は承和12年（845年）の「乙丑（きのとうし）」の年に生まれ、亡くなったのも丑の月日であったとされています。また、道真公の遺体を運ぶ牛車が座り込んで動かなくなった場所が現在の太宰府天満宮になったという伝説から、天満宮の牛は「座り牛」の形をしています。
                            </div>
                        </div>
                    </div>

                    <!-- 第3問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第3問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q3. 春日大社（奈良）などで、神様の使いとされている動物はどれ？</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, false, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. サル
                            </button>
                            <button onclick="handleQuiz(this, false, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. ウサギ
                            </button>
                            <button onclick="handleQuiz(this, true, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. シカ
                            </button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「3」</strong>です。春日大社の創建の際、茨城県の鹿島神宮から神様が白い鹿に乗ってやってきたという伝説に基づいています。そのため、奈良のシカは古くから「神鹿（しんろく）」として手厚く保護されてきました。
                            </div>
                        </div>
                    </div>
                </div>
            `
        },
        {
            id: 9,
            title: "最強の開運日を知る—天赦日と一粒万倍日",
            date: "2026/01/06",
            category: "開運",
            icon: "bi-calendar-heart",
            colorClass: "green",
            content: `
                <div class="article-content">
                    <p>おみくじを引くときや、新しいことを始めるときに気になるのが「暦（こよみ）」の吉日です。2026年も、数ある吉日の中でも特に強力とされる日が存在します。それぞれの意味を正しく理解し、天命を味方につけましょう。</p>
                    
                    <h3>天赦日（てんしゃにち）</h3>
                    <p>日本の暦の上で「最高の吉日」とされる日です。年にわずか5回〜6回しかありません。八百万の神々が天に昇り、天がすべての罪を許すとされる日です。「この日に始めたことはすべて成功する」と言われており、結婚、入籍、開業、お財布の新調にこれ以上ない日です。</p>

                    <h3>一粒万倍日（いちりゅうまんばいび）</h3>
                    <p>「一粒の籾（もみ）が万倍にも実る稲穂になる」という意味を持つ日です。わずかなものが飛躍的に増えることを示唆するため、新しい仕事のスタートや、投資、貯金、あるいは善行を行うのに非常に良い日とされています。ただし、借金や他人との諍いも「万倍」になってしまうため、注意が必要です。</p>

                    <h3>大安（たいあん）</h3>
                    <p>六曜の中で最も有名な吉日です。「大いに安し」という意味で、一日中何事においても吉とされる日です。天赦日や一粒万倍日とこの「大安」が重なる日は、最強の開運パワーを発揮すると言われています。</p>

                    <p>当杜の「12星座占い」や「全国の運気ランキング」で良い結果が出た日が、これらの吉日と重なっていれば、それはあなたにとって特別な転機となるかもしれません。暦を意識することで、日常の何気ない選択がより豊かなものに変わっていくでしょう。</p>
                </div>
            `
        },
        {
            id: 8,
            title: "おみくじの起源—元三大師と伝統の「百籤」",
            date: "2026/01/06",
            category: "歴史",
            icon: "bi-bank",
            colorClass: "green",
            content: `
                <div class="article-content">
                    <p>現在、私たちが神社や寺で引いているおみくじの原型は、平安時代の高僧、良源（慈恵大師、通称「元三大師」）にまで遡ります。彼は比叡山延暦寺の中興の祖として知られる人物です。</p>
                    
                    <h3>元三大師百籤（がんざんだいしひゃくせん）</h3>
                    <p>江戸時代、比叡山に伝わっていたこのおみくじが、徳川家康の側近であった天海大僧正（慈眼大師）によって広められたとされています。天海が夢の中で元三大師から授かったおみくじを箱に入れ、くじ引きの形で吉凶を占ったのが「元三大師百籤」であり、これが現代の日本のおみくじのスタンダードとなりました。</p>

                    <h3>漢詩と和歌の役割</h3>
                    <p>もともとのおみくじには、五言四句の「漢詩」が記されており、その内容から運勢を読み解くものでした。明治時代以降、多くの神社で日本独自の「和歌」が採用されるようになりましたが、現在でも「浅草寺」などの古い寺院では、起源に近い漢詩形式のおみくじを引くことができます。</p>

                    <h3>なぜ「天命乃杜」は12段階なのか</h3>
                    <p>江戸時代の百籤には「大吉」「吉」「中吉」「小吉」「末吉」「末小吉」「凶」の7段階が基本でした。当杜では、この伝統的な分類をさらに細分化し、現代人の複雑な心境に寄り添うべく、古来の陰陽五行や数秘術の視点を取り入れた独自の12段階構成を採用しています。</p>
                    <p>一枚の紙に託された先人の知恵。それをデジタルという形で受け継ぐことの重みを、私たちは大切にしていきたいと考えています。</p>
                </div>
            `
        },
        {
            id: 7,
            title: "「忖度なき天命」— 当杜のおみくじ確率について",
            date: "2026/01/06",
            category: "開発秘話",
            icon: "bi-dice-5-fill",
            colorClass: "red",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。個人開発者のnden148です。</p>
                    <p>本日は、当サイトの心臓部とも言える「おみくじの当選確率」について、その設計思想を詳しくお話しさせていただきます。</p>
                    
                    <h3>12分の1の真実</h3>
                    <p>世の中の多くの占いアプリやデジタルおみくじでは、利用者に喜んでもらうために「大吉」を多く出し、「凶」を極端に減らすといった、いわゆる「確率操作（重み付け）」が行われていることが少なくありません。中には、凶を一切入れないという選択をするサービスもあります。</p>
                    <p>しかし、当サイト「天命乃杜」は、その道を選びませんでした。当杜のおみくじは、全12種類の運勢すべてが<strong>「12分の1（約8.33%）」という完全に均等な確率</strong>で抽選されています。</p>

                    <h3>「大凶」もまた、等しく大切な天命</h3>
                    <p>開発段階において、「大凶が出すぎるとユーザーが離れてしまうのではないか」という葛藤がなかったわけではありません。しかし、私は「大凶」を単なるハズレだとは考えていません。人生において、うまくいかない時期や注意すべき瞬間を正直に受け入れることは、大吉を喜ぶことと同じくらい重要です。</p>
                    <p>大吉が出る確率と、大凶が出る確率が全く同じ。この<strong>「忖度なき平等」</strong>こそが、デジタルな杜において「真実の運命」を授かるための絶対条件だと確信したのです。大吉が出たときは心から喜び、大凶が出たときは「今日は神様が本気で注意を促してくれている」と、その重みを受け止めていただきたい。それが私の願いです。</p>

                    <h3>デジタル上の厳しい修行場として</h3>
                    <p>「全国・土地の運気ランキング」を文字ベースのガチな内容に変えた際もそうでしたが、私はこのサイトを、単なる娯楽以上の「自分を見つめ直す場所」にしたいと考えています。手加減なしの確率だからこそ、引き当てた結果には本物の価値が宿ります。</p>
                    <p>明日、あなたが引くおみくじが「大吉」か「大凶」かは、私にもわかりません。それこそが「天命」なのです。これからも当杜は、あなたの運命に対してどこまでも誠実であり続けます。どうぞ、覚悟を持って（？）おみくじをお引きください。</p>
                </div>
            `
        },
        {
            id: 6,
            title: "【クイズ】おみくじの常識、意外と知らない？（全3問）",
            date: "2026/1/5",
            category: "クイズ",
            icon: "bi-question-circle-fill",
            colorClass: "indigo",
            content: `
                <div class="article-content">
                    <p>しばらく更新が空いてしまいましたが、本日は趣向を変えて「クイズ形式」で神社の豆知識をお届けします。全3問、あなたはいくつ正解できるでしょうか？</p>
                    
                    <!-- 第1問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第1問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q1. おみくじを境内の「木」に結ぶ風習。なぜ昔は特に「松の木」に結んでいたのでしょうか？</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, false, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 木の生命力をもらうため
                            </button>
                            <button onclick="handleQuiz(this, true, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 「待つ（松）」にかけて願いを待つため
                            </button>
                            <button onclick="handleQuiz(this, false, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. 悪い運気を鋭い葉で払うため
                            </button>
                        </div>

                        <!-- 解説エリア -->
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「2」</strong>です。<br>
                                江戸時代から続く日本の「言霊（ことだま）」信仰によるものです。良い結果の場合は<strong>「願い事が『待つ（松）』」</strong>ように、悪い結果の場合も<strong>「良い運気が『待つ（松）』」</strong>ように、という願いを込めて、松の木に結ぶようになったと言われています。
                            </div>
                        </div>
                    </div>

                    <!-- 第2問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第2問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q2. おみくじの「有効期限」はいつまでとされているでしょう？</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, false, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 引いてから1週間
                            </button>
                            <button onclick="handleQuiz(this, false, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 大晦日まで（12月31日）
                            </button>
                            <button onclick="handleQuiz(this, true, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. 決まりはない（次に引くまで）
                            </button>
                        </div>

                        <!-- 解説エリア -->
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「3」</strong>です。<br>
                                おみくじに明確な有効期限はありません。一般的には「1年」や「願いが叶うまで」とされていますが、神様からのメッセージが必要だと感じた時が引き時であり、<strong>「次に引いた時が、前のおみくじの区切り」</strong>と考えるのが一般的です。
                            </div>
                        </div>
                    </div>

                    <!-- 第3問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第3問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q3. 「凶」が出た場合、持ち帰るのはマナー違反？</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, false, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 絶対に結んで帰るべき
                            </button>
                            <button onclick="handleQuiz(this, true, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 戒めとして持ち帰っても良い
                            </button>
                            <button onclick="handleQuiz(this, false, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. その場で破り捨てるべき
                            </button>
                        </div>

                        <!-- 解説エリア -->
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「2」</strong>です。<br>
                                「凶」などの悪い結果が出た場合、境内に結んで悪い運気を浄化してもらうのが一般的ですが、<strong>「自分への戒め（アドバイス）」として持ち帰り、時々読み返すことも推奨されています。</strong><br>
                                破り捨てたり粗末に扱うのはNGですが、大切に保管する分には問題ありません。
                            </div>
                        </div>
                    </div>

                    <p class="mt-8">いかがでしたか？<br>作法を知ると、おみくじがより深いメッセージとして心に響くようになります。ぜひ次回の参拝にお役立てください。</p>
                </div>
            `
        },
        {
            id: 1,
            title: "おみくじの順番（正しい吉凶の順）",
            date: "2026/01/01",
            category: "雑学",
            icon: "bi-list-ol",
            colorClass: "green",
            content: `<div class="article-content"><p>初詣や神社参拝の際に引く「おみくじ」。結果に一喜一憂するのも楽しみの一つですが、その「順位」について正しく理解している人は意外と少ないかもしれません。実は神社やお寺によって解釈が異なる場合があるのですが、一般的に広く知られている順位と、当サイト「運勢・天命乃杜」で採用している伝統的な12段階の順位について詳しく解説します。</p><h3>一般的な7段階の順位</h3><p>多くの神社で採用されている最もポピュラーな順位は以下の通りです。<br><b>大吉 ＞ 吉 ＞ 中吉 ＞ 小吉 ＞ 末吉 ＞ 凶 ＞ 大凶</b><br>あるいは、「吉」の位置が変わり、<b>大吉 ＞ 中吉 ＞ 小吉 ＞ 吉 ＞ 末吉 ＞ 凶 ＞ 大凶</b> とする場合もあります。「吉」は「大吉」に次ぐ良い運勢とする説と、「小吉」と「末吉」の間の中庸な運勢とする説があるのです。</p><h3>当サイトの12段階詳細順位</h3><p>当サイトでは、より細かく運勢を占うため、古来からの伝統に基づいた以下の12段階を採用しています。</p><ol class="list-decimal list-inside space-y-2 ml-4 mb-6 font-bold"><li>大吉 (だいきち)：最高の運気。感謝を忘れずに。</li><li>中吉 (ちゅうきち)：大吉に次ぐ良運。</li><li>小吉 (しょうきち)：ささやかな幸せが続く。</li><li>吉 (きち)：安定した運気。</li><li>半吉 (はんきち)：吉と凶の中間。</li><li>末吉 (すえきち)：末広がりの未来がある。</li><li>末小吉 (すえしょうきち)：今は耐える時だが希望はある。</li><li>凶 (きょう)：運気が停滞気味。慎重に。</li><li>小凶 (しょうきょう)：小さなトラブルに注意。</li><li>半凶 (はんきょう)：半分は凶だが半分は吉に転じる可能性。</li><li>末凶 (すえきょう)：終わりの凶、つまり次は吉へ向かう。</li><li>大凶 (だいきょう)：最も警戒すべき運気。しかしこれ以上落ちない。</li></ol><p>しかし、最も重要なのは順位そのものではありません。おみくじの本質は、そこに書かれている「神様からの和歌や助言」にあります。大吉であっても戒めの言葉があれば気を引き締め、大凶であっても励ましの言葉があれば希望を持つことが大切です。結果に一喜一憂せず、日々の行動指針として活用してください。</p></div>`
        },
        {
            id: 2,
            title: "悪い結果が出ても実は大丈夫？",
            date: "2026/01/01",
            category: "豆知識",
            icon: "bi-cloud-sun",
            colorClass: "green",
            content: `<div class="article-content"><p>おみくじを引いて「凶」や「大凶」が出ると、誰しも気分が落ち込むものです。「今年は良いことがないのではないか」「不吉なことが起こる前兆ではないか」と不安になるかもしれません。しかし、古来より「凶」は必ずしも忌むべきものとはされてきませんでした。むしろ、考え方によっては幸運への入り口とも言えるのです。</p><h3>「凶」は運気の底、これからは上がるのみ</h3><p>陰陽道などの東洋思想では、物事は極まれば反転すると考えます。「大吉」は今が頂点であり、これからは下り坂になる可能性があるため、むしろ慎重な行動を求められます。</p><p>逆に「凶」は、今が運気の底であり、これからは上昇する一方であることを示唆しています。「禍を転じて福となす」という言葉通り、今の困難を乗り越えることで、より大きな幸運をつかむチャンスなのです。凶を引いたということは、これ以上悪くなることはない、つまり「伸びしろしかない」状態であると前向きに捉えましょう。</p><h3>結ぶか、持ち帰るか？</h3><p>悪い結果が出た場合、神社の境内にある「結び所」に結んで帰る風習が一般的です。これには「神様と縁を結ぶ」「悪い運気を神様に預けて浄化してもらう」という意味があります。</p><p>一方で、「戒めとして財布に入れて持ち歩く」という考え方もあります。自分への警告として時々読み返すことで、慎重な行動を心がけ、災いを未然に防ぐことができるからです。</p></div>`
        },
        {
            id: 3,
            title: "神社での正しい参拝マナー",
            date: "2025/12/30",
            category: "作法",
            icon: "bi-person-check-fill",
            colorClass: "green",
            content: `<div class="article-content"><p>神社は神様のお住まいです。初詣や日常の参拝で失礼のないよう、基本的な参拝マナーをおさらいしましょう。作法を知ることで、心も整い、より深い感謝の気持ちを伝えることができます。</p><h3>1. 鳥居をくぐる時</h3><p>鳥居は俗界と神域を分ける結界です。くぐる前には衣服を整え、軽く一礼（一揖）をし、帽子などは取ります。参道の中央（正中）は神様の通り道なので、避けて端を歩くのがマナーです。</p><h3>2. 手水舎での清め方</h3><p>参拝の前に、手水舎（てみずや）で身の穢れを落とします。<br>1. 右手で柄杓を持ち、水を汲んで左手を清める。<br>2. 左手に持ち替え、右手を清める。<br>3. 再び右手に持ち、左手で水を受けて口をすすぐ。<br>4. 左手を再度清め、最後に柄杓を立てて残った水で柄を洗い流す。</p><h3>3. 拝礼（二礼二拍手一礼）</h3><p>お賽銭を入れた後、鈴を鳴らし、姿勢を正します。<br>1. 深く二回お辞儀をする（二礼）。<br>2. 胸の前で両手を合わせ、右手を少し下にずらして二回拍手を打つ（二拍手）。<br>3. 指先を揃えて祈りを捧げる。<br>4. 最後にもう一度深くお辞儀をする（一礼）。</p></div>`
        },
        {
            id: 4,
            title: "「失せ物」の本当の意味",
            date: "2025/12/28",
            category: "豆知識",
            icon: "bi-search",
            colorClass: "green",
            content: `<div class="article-content"><p>おみくじの項目にある「失せ物（うせもの）」。これは単に「落とし物」や「無くした財布」のことだけを指すのではありません。人生において私たちが失ってしまうものは、物理的なモノだけではないからです。</p><h3>形あるもの、形なきもの</h3><p>失せ物には、物理的な物品だけでなく、「失った信頼」「忘れていた初心」「疎遠になった友人」「失恋した相手」「やる気」「健康」など、形のないものも含まれます。今あなたが心の中で「失ってしまった」と感じている欠落感、それこそが「失せ物」の正体かもしれません。</p><h3>言葉の意味</h3><ul class="list-disc ml-5 mb-4"><li><b>「出ず（いでず）」</b>：残念ながら戻ってこない可能性が高いです。諦めて新しいものを探すか、執着を手放すべき時です。</li><li><b>「出る」</b>：見つかります。焦らず探しましょう。</li><li><b>「高いところより出る」</b>：棚の上や、普段見ない高い場所、あるいは目上の人からの連絡で見つかるかもしれません。</li></ul></div>`
        },
        {
            id: 5,
            title: "「待ち人」は恋愛だけじゃない",
            date: "2025/12/25",
            category: "開運",
            icon: "bi-heart",
            colorClass: "green",
            content: `<div class="article-content"><p>「待ち人来ず」と出ると、恋人ができないのかとガッカリする人が多いですが、これは大きな誤解です。おみくじにおける「待ち人」の意味はもっと広く、人生全般に関わるものです。</p><h3>人生を導くキーパーソン</h3><p>おみくじにおける「待ち人」とは、「あなたの人生に良い影響を与えてくれる人」「運命を切り開くきっかけとなる人」全般を指します。それは将来の恋人や結婚相手かもしれませんし、ビジネスパートナー、あるいは人生の師となる先生、一生の親友、もしかすると赤ちゃん（妊娠）のことかもしれません。</p><h3>「来ず」の意味</h3><p>「来ず」とあっても、一生現れないこともあります。「今はまだその時ではない」「自分から動きなさい」というメッセージであることが多いのです。「音信（たより）あり」とあれば、遠くから連絡が来るでしょう。</p></div>`
        }
    ];

// 履歴ページネーション用の状態管理
let historyPageState = {
    page: 1,
    perPage: 100, // 1ページ100件
    filteredData: [] // 現在表示対象となっているデータ（検索結果含む）
};
        

    // ==========================================
    //  ページネーション＆検索機能ロジック
    // ==========================================
    
    // 状態管理 (ページ番号と検索ワード)
    const listState = {
        news: { page: 1, query: '', perPage: 5 },   // ニュースは1ページ5件
        column: { page: 1, query: '', perPage: 6 }  // コラムは1ページ6件
    };

    // 検索ハンドラ
    window.handleSearch = function(type, query) {
        listState[type].query = query.trim().toLowerCase();
        listState[type].page = 1; // 検索時は1ページ目に戻す
        if (type === 'news') renderFullNewsView();
        else renderFullColumnView();
    };

    // ページ切り替えハンドラ
    window.changePage = function(type, newPage) {
        listState[type].page = newPage;
        if (type === 'news') renderFullNewsView();
        else renderFullColumnView();
        
        // ページ上部へスクロール
        const section = document.getElementById(`view-${type}`);
        if(section) section.scrollIntoView({ behavior: 'smooth' });
    };

    // 共通: データのフィルタリングとページ切り出し
    function getPaginatedData(type, sourceData) {
        const state = listState[type];
        
        // 1. 検索フィルタ
        const filtered = sourceData.filter(item => {
            if (!state.query) return true;
            // タイトル、本文、タグなどを検索対象にする
            const searchStr = (item.title + (item.desc || '') + (item.content || '') + (item.tag || '') + (item.category || '')).toLowerCase();
            return searchStr.includes(state.query);
        });

        // 2. ページネーション計算
        const totalItems = filtered.length;
        const totalPages = Math.ceil(totalItems / state.perPage) || 1;
        
        // ページ番号の補正
        if (state.page > totalPages) state.page = totalPages;
        if (state.page < 1) state.page = 1;

        const startIndex = (state.page - 1) * state.perPage;
        const endIndex = startIndex + state.perPage;
        const slicedData = filtered.slice(startIndex, endIndex);

        return { data: slicedData, totalPages, currentPage: state.page, totalItems };
    }

    // 共通: ページネーションボタンのHTML生成
    function createPaginationHTML(type, current, total) {
        if (total <= 1) return ''; // 1ページのみなら非表示

        let html = '';
        // 前へボタン
        html += `<button onclick="changePage('${type}', ${current - 1})" 
                 class="px-4 py-2 rounded border bg-white dark:bg-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-700 disabled:opacity-50 transition"
                 ${current === 1 ? 'disabled' : ''}>
                 <i class="bi bi-chevron-left"></i> 前へ</button>`;

        // ページ番号
        html += `<span class="font-bold font-mono mx-4">${current} / ${total}</span>`;

        // 次へボタン
        html += `<button onclick="changePage('${type}', ${current + 1})" 
                 class="px-4 py-2 rounded border bg-white dark:bg-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-700 disabled:opacity-50 transition"
                 ${current === total ? 'disabled' : ''}>
                 次へ <i class="bi bi-chevron-right"></i></button>`;

        return html;
    }

    // ==========================================
    //  描画ロジック (一覧・ホーム・詳細)
    // ==========================================

    // 1. ホーム画面のリスト (最新件数のみ表示)
    // ★これが消えていたためエラーになっていました
    window.renderHomeLists = function() {
        // 社務所だより（最新4件）
        const newsListEl = document.getElementById('home-news-list');
        if (newsListEl) {
            newsListEl.innerHTML = newsData.slice(0, 4).map(item => `
                <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('news', ${item.id})">
                    <span class="truncate">
                        <span class="bg-gray-200 dark:bg-zinc-700 px-1 py-0.5 rounded text-[10px] mr-1 ${item.tagColor || 'text-gray-600'}">${item.tag}</span>
                        ${item.title}
                    </span>
                    <span class="themed-text-sub flex-shrink-0 ml-2">${item.date}</span>
                </li>
            `).join('');
        }

        // 神籤草子（最新5件）
        const columnListEl = document.getElementById('home-column-list');
        if (columnListEl) {
            columnListEl.innerHTML = columnData.slice(0, 5).map(item => `
                <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('column', ${item.id})">
                    <span class="truncate">
                        <span class="bg-gray-200 dark:bg-zinc-700 px-1 py-0.5 rounded text-[10px] mr-1 text-gray-600 dark:text-gray-300">${item.category}</span>
                        ${item.title}
                    </span>
                    <span class="themed-text-sub flex-shrink-0 ml-2">${item.date}</span>
                </li>
            `).join('');
        }
    };

    // 2. 社務所だより一覧 (検索・ページ機能付き)
    window.renderFullNewsView = function() {
        const container = document.getElementById('view-news-list');
        const pagination = document.getElementById('news-pagination');
        if (!container) return;

        const { data, totalPages, currentPage, totalItems } = getPaginatedData('news', newsData);

        if (totalItems === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 py-8">該当する記事が見つかりませんでした。</p>';
            pagination.innerHTML = '';
            return;
        }

        container.innerHTML = data.map(item => `
            <article class="themed-card p-4 rounded shadow border-l-4 ${item.borderColor || 'border-gray-400'} cursor-pointer hover:opacity-80 transition" onclick="openArticle('news', ${item.id})">
                <div class="text-sm themed-text-sub">${item.date} ${item.time || ''} <span class="ml-2 font-bold ${item.tagColor}">${item.tag}</span></div>
                <h3 class="font-bold text-lg ${item.tag === '重要' ? 'text-red-600' : ''}">${item.title}</h3>
                <p class="text-sm mt-2 truncate themed-text-sub">${item.desc}</p>
            </article>
        `).join('');

        pagination.innerHTML = createPaginationHTML('news', currentPage, totalPages);
    };

    // 3. 神籤草子一覧 (検索・ページ機能付き)
    window.renderFullColumnView = function() {
        const container = document.getElementById('view-column-list');
        const pagination = document.getElementById('column-pagination');
        if (!container) return;

        const { data, totalPages, currentPage, totalItems } = getPaginatedData('column', columnData);

        if (totalItems === 0) {
            container.innerHTML = '<p class="col-span-full text-center text-gray-500 py-8">該当するコラムが見つかりませんでした。</p>';
            pagination.innerHTML = '';
            return;
        }

        container.innerHTML = data.map(item => `
            <article class="themed-card rounded overflow-hidden shadow cursor-pointer hover:shadow-lg transition" onclick="openArticle('column', ${item.id})">
                <div class="h-32 bg-${item.colorClass}-100 dark:bg-${item.colorClass}-900 flex items-center justify-center text-${item.colorClass}-800 dark:text-${item.colorClass}-200 font-bold">
                    <i class="bi ${item.icon} text-3xl"></i>
                </div>
                <div class="p-4">
                    <div class="text-xs themed-text-sub mb-1">
                         <span class="bg-gray-200 dark:bg-zinc-700 px-2 py-0.5 rounded text-[10px] mr-2">${item.category}</span>${item.date}
                    </div>
                    <h3 class="font-bold">${item.title}</h3>
                </div>
            </article>
        `).join('');

        pagination.innerHTML = createPaginationHTML('column', currentPage, totalPages);
    };

    // 4. 記事詳細表示
    window.openArticle = function(type, id) {
        let item;
        if (type === 'news') item = newsData.find(d => d.id === id);
        else if (type === 'column') item = columnData.find(d => d.id === id);

        if (!item) return;

        const container = document.getElementById('article-detail-content');
        if (container) {
            const headerTitleClass = (type === 'news' && item.tag === '重要') ? 'text-red-600' : '';
            container.innerHTML = `
                <div class="article-header">
                    <h2 class="article-title ${headerTitleClass}">${item.title}</h2>
                    <div class="article-meta">
                        <span>${item.date} ${item.time || ''}</span>
                        ${item.tag ? `<span class="article-tag">${item.tag}</span>` : ''}
                        ${item.category ? `<span class="article-tag">${item.category}</span>` : ''}
                    </div>
                </div>
                <div class="article-content">${item.content}</div>
            `;
            showView('article-detail');
            window.scrollTo(0, 0);
        }
    };

    // 5. クイズ機能ロジック
    window.handleQuiz = function(btn, isCorrect, correctIndex) {
        const optionsArea = btn.parentElement;
        const allBtns = optionsArea.querySelectorAll('button');
        const resultArea = optionsArea.nextElementSibling;
        const msg = resultArea.querySelector('.quiz-msg');

        allBtns.forEach(b => {
            b.disabled = true;
            b.classList.add('opacity-50', 'cursor-not-allowed');
        });

        if (isCorrect) {
            btn.classList.remove('bg-white', 'dark:bg-black', 'border-gray-300', 'opacity-50');
            btn.classList.add('bg-green-100', 'dark:bg-green-900', 'border-green-500', 'text-green-800', 'dark:text-green-100', 'ring-2', 'ring-green-500');
            btn.innerHTML = '<i class="bi bi-circle text-xl mr-2"></i> ' + btn.innerText;
            msg.innerHTML = '<span class="text-green-600"><i class="bi bi-check-circle-fill"></i> 正解！</span>';
        } else {
            btn.classList.remove('bg-white', 'dark:bg-black', 'border-gray-300', 'opacity-50');
            btn.classList.add('bg-red-100', 'dark:bg-red-900', 'border-red-500', 'text-red-800', 'dark:text-red-100');
            btn.innerHTML = '<i class="bi bi-x-lg text-xl mr-2"></i> ' + btn.innerText;
            msg.innerHTML = '<span class="text-red-600"><i class="bi bi-x-circle-fill"></i> 不正解...</span>';
            const correctBtn = allBtns[correctIndex]; 
            if(correctBtn) {
                correctBtn.classList.remove('opacity-50', 'bg-white', 'dark:bg-black', 'border-gray-300');
                correctBtn.classList.add('bg-green-50', 'dark:bg-green-900/30', 'border-green-500', 'font-black', 'text-green-700', 'dark:text-green-300');
                correctBtn.innerHTML = '<i class="bi bi-circle text-xl mr-2"></i> ' + correctBtn.innerText;
            }
        }
        resultArea.classList.remove('hidden');
    };

        // ==========================================
    //  都道府県ランキング機能 (JST 0:00更新・47種長文完全版)
    // ==========================================
    
    const prefecturesList = [
        "北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県",
        "茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県",
        "新潟県","富山県","石川県","福井県","山梨県","長野県","岐阜県",
        "静岡県","愛知県","三重県","滋賀県","京都府","大阪府","兵庫県",
        "奈良県","和歌山県","鳥取県","島根県","岡山県","広島県","山口県",
        "徳島県","香川県","愛媛県","高知県","福岡県","佐賀県","長崎県",
        "熊本県","大分県","宮崎県","鹿児島県","沖縄県"
    ];

    // ランキング生成・描画関数
    window.renderPrefectureRanking = function() {
        const listContainer = document.getElementById('prefecture-list');
        const dateDisplay = document.getElementById('pref-date-display');
        
        // コンテナが存在しない場合は処理を中断（エラー防止）
        if (!listContainer) return;

        // 【重要】日本時間(JST)の日付文字列を取得
        const dateStr = getJSTDateString(); 
        
        if (dateDisplay) {
            const dateParts = dateStr.split('-');
            dateDisplay.innerHTML = `${dateParts[0]}年${dateParts[1]}月${dateParts[2]}日 <span class="text-sm font-normal ml-2 text-gray-500 dark:text-gray-400">の運勢順位</span>`;
        }

        // 1. データ生成 (47都道府県すべて計算)
        let rankingData = prefecturesList.map((pref, index) => {
            // シード: 日付文字列(JST) + 県名
            const seed = dateStr + "_" + pref;
            const rng = new SeededRandom(seed);
            
            // スコア算出 (49点〜100点の範囲)
            const score = Math.floor(rng.next() * 52) + 49;
            
            return {
                name: pref,
                score: score,
                // indexを渡して、47都道府県で被らないように制御
                text: generatePrefectureText(pref, score, rng, index)
            };
        });

        // 2. ソート (点数が高い順に並び替え)
        rankingData.sort((a, b) => b.score - a.score);

        // 3. 描画 HTML生成
        let html = '';
        rankingData.forEach((item, index) => {
            const rank = index + 1;
            
            // ランク別スタイル定義
            let rankBadgeClass = "bg-gray-200 text-gray-600";
            let borderClass = "border-gray-300";
            let scoreColor = "text-gray-600";

            // 100点〜90点 (Sランク)
            if (item.score >= 90) { 
                rankBadgeClass = "bg-gradient-to-br from-yellow-300 to-yellow-500 text-white border-2 border-yellow-100 shadow";
                borderClass = "border-yellow-400 bg-yellow-50 dark:bg-yellow-900/20";
                scoreColor = "text-red-600";
            
            // 89点〜70点 (Aランク)
            } else if (item.score >= 70) { 
                rankBadgeClass = "bg-red-500 text-white";
                borderClass = "border-red-300 bg-red-50 dark:bg-red-900/10";
                scoreColor = "text-red-500";
            
            // 69点〜40点 (Bランク)
            } else if (item.score >= 40) { 
                rankBadgeClass = "bg-blue-500 text-white";
                borderClass = "border-blue-200";
                scoreColor = "text-blue-600";
            
            // 39点〜0点 (Cランク)
            } else { 
                rankBadgeClass = "bg-gray-500 text-white";
                borderClass = "border-gray-400 bg-gray-100 dark:bg-zinc-800";
                scoreColor = "text-gray-500";
            }

            // 王冠アイコン (TOP3のみ表示)
            let crown = "";
            if(rank === 1) crown = '<i class="bi bi-trophy-fill text-yellow-500 mr-1"></i>';
            else if(rank === 2) crown = '<i class="bi bi-award-fill text-gray-400 mr-1"></i>';
            else if(rank === 3) crown = '<i class="bi bi-award-fill text-orange-400 mr-1"></i>';

            // カードHTMLの組み立て
            html += `
                <div class="themed-card rounded-xl p-5 border-l-8 ${borderClass} shadow-sm flex flex-col md:flex-row gap-4 items-start md:items-center">
                    <!-- 順位と県名 -->
                    <div class="flex items-center gap-4 min-w-[180px]">
                        <div class="flex flex-col items-center justify-center w-16">
                            <span class="text-xs font-bold text-gray-400 mb-1">RANK</span>
                            <div class="w-12 h-12 rounded-full flex items-center justify-center font-black text-xl ${rankBadgeClass}">
                                ${rank}
                            </div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500 font-bold mb-1">${crown}No.${rank}</div>
                            <div class="text-2xl font-black tracking-widest">${item.name}</div>
                        </div>
                    </div>

                    <!-- スコアとテキスト -->
                    <div class="flex-1 w-full">
                        <div class="flex justify-between items-end border-b border-gray-200 dark:border-gray-700 pb-2 mb-3">
                            <span class="text-xs font-bold text-gray-400">運気指数</span>
                            <span class="text-3xl font-black ${scoreColor} font-mono">${item.score}<span class="text-sm ml-1 text-gray-500">/100</span></span>
                        </div>
                        <p class="text-sm leading-7 text-justify text-gray-700 dark:text-gray-300 font-medium">
                            ${item.text}
                        </p>
                    </div>
                </div>
            `;
        });

        // 画面に反映
        listContainer.innerHTML = html;
    };

    // 文章生成ロジック (47種類の長文テンプレートからスコアに応じて選択)
    function generatePrefectureText(prefName, score, rng, index) {
        
        // --- 47種類のベース文章パターン（スコア帯ごとに分割） ---
        
        // Sランク用 (90-100点): 16パターン
        const textsS = [
            `今日の${prefName}は、あたかも天からの祝福を受けているかのような、強烈かつ清らかなエネルギーに満ち溢れています。土地自体が発光しているかのような高い波動を観測でき、この場所に身を置くすべての人に幸運をもたらすでしょう。特に${prefName}内の神社仏閣への参拝は絶大な効果を発揮します。感謝の気持ちを伝えることで、さらなる加護が得られるでしょう。自信を持って行動してください。`,
            `奇跡的な星の配置により、本日の${prefName}は国内で最も「願いが通じやすい」特異点となっています。長年の悩みが嘘のように晴れたり、思いがけない良縁に恵まれたりと、ドラマチックな展開が期待できる一日です。新しいプロジェクトの始動や、大切な人への告白など、人生の重要な決断を下すのにこれ以上ない最適なタイミングです。`,
            `まさに最強の運気です。今日の${prefName}全域において、滞っていた物事が一気に動き出す「開運の風」が吹いています。ビジネス、恋愛、健康、あらゆる面においてポジティブな結果が得られる、稀に見る吉日となるでしょう。この土地の食材を使った料理を食べることで、身体の内側から運気を取り込むことができます。地産地消を心がけてみてください。`,
            `天空のエネルギーが${prefName}の大地に降り注ぎ、住む人の潜在能力を極限まで引き出す一日です。直感が冴え渡り、迷っていた答えが自然と見つかるような感覚を覚えるでしょう。今日は迷わず自分の信じた道を進んでください。その先には、あなたが想像する以上の素晴らしい成果が待っています。`,
            `今日の${prefName}は、黄金の光に包まれたような繁栄の気が漂っています。特に金運や仕事運が絶好調で、過去の努力が形となって返ってくる収穫の時を迎えています。積極的に人と会い、情報を交換することで、さらなるチャンスが舞い込むでしょう。笑顔で過ごすことが、最強の開運アクションです。`,
            `静寂の中にも力強い鼓動を感じる、神聖な一日です。今日の${prefName}は、精神的な成長を促すエネルギーに満ちています。瞑想や読書など、静かに自分と向き合う時間を持つことで、魂が洗われるような体験ができるでしょう。今日得たインスピレーションは、今後の人生を大きく左右する重要な鍵となります。`,
            `まるで生まれ変わったかのような、新鮮で清々しい気が${prefName}を巡っています。過去の失敗や後悔を断ち切り、新たな一歩を踏み出すのに最適な「再生」の日です。新しい服をおろしたり、髪型を変えてみるのも吉。変化を恐れず、新しい自分を表現することで、運気はさらに上昇気流に乗ります。`,
            `愛と調和のエネルギーが${prefName}全土を優しく包み込んでいます。今日は対人運が最高潮で、家族や友人、パートナーとの絆が深まる素晴らしい一日となるでしょう。喧嘩をしていた人も、今日なら素直に仲直りができるはずです。大切な人に「ありがとう」と伝えるだけで、奇跡のような幸せが訪れます。`,
            `情熱と活力が湧き上がる、エネルギッシュな一日です。今日の${prefName}は、スポーツや体を動かすことに最適な「動」の運気に支配されています。汗を流すことで体内の澱みが浄化され、ポジティブな思考がみなぎってくるでしょう。困難な壁も、今のあなたなら勢いで乗り越えることができます。`,
            `知性と創造性がスパークする、クリエイティブな一日です。今日の${prefName}では、芸術的な活動や企画立案において素晴らしい成果が期待できます。美術館や博物館を訪れたり、美しい風景を眺めることで、感性が刺激され、素晴らしいアイデアが降ってくるでしょう。`,
            `今日の${prefName}は、積み重ねてきた努力が報われる「達成」のエネルギーに満ちています。試験や発表、プレゼンテーションなど、勝負事において最高の結果を残せる強運日です。周囲からの評価も高まり、自信に満ちた一日を過ごせるでしょう。胸を張って、堂々と振る舞ってください。`,
            `人と人との縁が結ばれる、出会いの気が${prefName}に集まっています。今日は家に閉じこもらず、積極的に外に出かけるべきです。偶然立ち寄った場所で、生涯の友やパートナーとなる人物と巡り会う可能性があります。直感に従って行動範囲を広げることが、幸運への近道です。`,
            `今日の${prefName}は、すべてがスムーズに流れる「順風満帆」の運気です。信号が青続きだったり、タイミングよく電車に乗れたりと、日常の些細なことでもツイていると感じる場面が多いでしょう。この流れに乗って、普段は躊躇してしまうような大きな目標に挑戦してみるのもおすすめです。`,
            `癒しと浄化の雨（または気）が、${prefName}の疲れを洗い流してくれる日です。今日は無理をせず、自分を甘やかすことで運気が回復します。温泉やスパに行ったり、美味しいものをゆっくり味わったりして、心身のメンテナンスを優先してください。明日への活力が驚くほど湧いてくるはずです。`,
            `今日の${prefName}は、天と地が繋がるようなスピリチュアルなパワーが強まっています。不思議な偶然（シンクロニシティ）が重なり、導かれるように幸運な出来事に遭遇するかもしれません。夢の中で見たことや、ふと思い浮かんだ言葉をメモしておくと、後々重要なメッセージとなるでしょう。`,
            `圧倒的なカリスマ性が宿る日です。今日の${prefName}にいるあなたは、周囲を惹きつける不思議な魅力に溢れています。リーダーシップを発揮したり、人前で話をすることで、多くの賛同や協力を得ることができるでしょう。恐れずに前に出ることで、運命の扉が開かれます。`
        ];

        // Aランク用 (70-89点): 16パターン
        const textsA = [
            `${prefName}の空には穏やかで温かい気が流れており、非常に過ごしやすい一日となりそうです。派手さはありませんが、確実な前進を感じられる安定した良運気に包まれています。${prefName}の自然豊かな場所へ足を運ぶと、心身のリフレッシュ効果が倍増します。深呼吸をして、土地のエネルギーを吸い込みましょう。`,
            `今日の${prefName}は、「調和」と「発展」のエネルギーが活性化しています。人間関係がスムーズに運び、周囲との協力体制が自然と築けるような、心地よい空気が土地全体を覆っています。友人や家族と${prefName}の名所を訪れるのが吉です。会話が弾み、絆がより一層深まる素晴らしい時間を過ごせるはずです。`,
            `活気あふれる一日です。${prefName}の土地が持つ本来のパワーが高まっており、訪れる人のやる気や好奇心を刺激してくれるでしょう。何か新しい発見があるかもしれません。買い物や散策に出かけるのに適しています。以前から欲しかったものが${prefName}のお店で見つかるなど、小さなラッキーが重なる予感です。`,
            `爽やかな風が吹き抜けるような、清々しい運気です。今日の${prefName}では、新しい知識や技術を学ぶのに最適な環境が整っています。図書館や書店に足を運んでみましょう。あなたの知的好奇心を満たす一冊との出会いが、将来の可能性を広げてくれるかもしれません。`,
            `今日の${prefName}は、コツコツと積み重ねることが吉と出る「継続」の運気です。派手な成功よりも、地道な努力が正当に評価される日となります。日々のルーティンを大切にし、丁寧な仕事を心がけることで、周囲からの信頼が厚くなるでしょう。`,
            `美味しい食事にツキがある一日です。今日の${prefName}は「食」に関するエネルギーが高まっています。地元の名産品や、旬の食材を使った料理を味わうことで、身体の底から元気が湧いてきます。親しい人を誘って食事会を開くと、楽しい話題で盛り上がること間違いなしです。`,
            `今日の${prefName}は、整理整頓に適した「清浄」の気が流れています。身の回りを片付けたり、不要なものを手放すことで、運気の通り道がクリアになります。掃除が終わった後のスッキリとした空間で過ごす時間は、何物にも代えがたい幸福感をもたらしてくれるでしょう。`,
            `懐かしい再会や、過去の縁が復活する兆しがあります。今日の${prefName}では、昔の友人や恩師に連絡を取ってみると良いでしょう。思い出話に花が咲き、忘れていた大切な気持ちを思い出すことができるはずです。過去を振り返ることが、未来へのヒントになります。`,
            `今日の${prefName}は、美意識が高まる「芸術」の日です。ファッションやインテリアにこだわってみたり、美術館でアートに触れることで、心が豊かになります。美しいものに囲まれて過ごすことで、あなた自身の魅力も磨かれ、内面から輝きが増していくでしょう。`,
            `心地よいリズムで一日が進んでいきます。今日の${prefName}は、焦らずマイペースに過ごすことが幸運の鍵です。周囲の喧騒に惑わされず、自分の時間を大切にしてください。お気に入りの音楽を聴きながら散歩をするだけで、素晴らしいアイデアが浮かんでくるかもしれません。`,
            `今日の${prefName}は、小さな親切が大きな喜びに変わる「奉仕」の運気です。困っている人に手を差し伸べたり、席を譲ったりする何気ない優しさが、巡り巡ってあなたに幸運をもたらします。${prefName}の街全体が、あなたの優しさを温かく見守っています。`,
            `未来への希望が膨らむ、明るい一日です。今日の${prefName}では、将来の計画を立てたり、夢を語り合うのに適しています。手帳に来年の目標を書き込んでみましょう。この土地の前向きなエネルギーが、あなたの夢を後押ししてくれます。`,
            `今日の${prefName}は、コミュニケーション運が良好です。SNSでの発信や、メールの返信を積極的に行うと良いでしょう。あなたの言葉が誰かの心に響き、素敵な繋がりが生まれるかもしれません。言葉選びを丁寧にすることで、さらに運気がアップします。`,
            `伝統や文化に触れると良い一日です。${prefName}にある古い街並みや史跡を訪ねてみましょう。先人たちの知恵や歴史の重みを感じることで、今の悩みがいかに小さなものか気付かされるはずです。温故知新の精神が、道を開きます。`,
            `今日の${prefName}は、バランス感覚に優れた安定した一日です。仕事とプライベート、ONとOFFの切り替えが上手くいき、充実した時間を過ごせます。どちらかに偏ることなく、中庸を心がけることで、心身ともに健康的な状態を維持できるでしょう。`,
            `予期せぬラッキーハプニングの予感です。今日の${prefName}では、ちょっとしたくじ運や懸賞運が上昇しています。宝くじ売り場を見かけたら、運試しに一枚買ってみるのも面白いかもしれません。ワクワクする気持ちが、さらなる幸運を引き寄せます。`
        ];

        // Bランク用 (49-69点): 15パターン
        const textsB = [
            `今日の${prefName}は、可もなく不可もなく、静寂に包まれたフラットな運気です。劇的な変化は望めませんが、それは逆に言えば「平穏無事」であるという証でもあります。無理に予定を詰め込まず、${prefName}のカフェや公園でゆっくりと読書などをして過ごすのがおすすめです。心の洗濯をしましょう。`,
            `嵐の前の静けさのような、落ち着いた空気が${prefName}を漂っています。外に向かってエネルギーを発散するよりも、内面を見つめ直すのに適した、静的な一日となるでしょう。家の中の掃除や整理整頓を行うと良いでしょう。${prefName}の土地の神様は、清潔な場所を好みます。足元を固める一日としてください。`,
            `エネルギーの波は安定しています。今日の${prefName}では、ルーティンワークや日常の些細な出来事を大切にすることで、運気が徐々に上向いていく傾向にあります。今日は「受け身」の姿勢が吉と出ます。${prefName}の中で起こる出来事に抗わず、流れに身を任せることで、災いを避けることができます。`,
            `少し停滞感を感じるかもしれませんが、焦りは禁物です。今日の${prefName}は「充電」の期間と割り切りましょう。無理に動くと空回りする可能性があります。早めに帰宅して、好きな映画を見たり、趣味に没頭する時間を設けることで、明日への英気を養うことができます。`,
            `今日の${prefName}は、周囲の意見に耳を傾けるべき「傾聴」の日です。自分の主張を通そうとすると摩擦が起きやすいですが、一歩引いて相手を立てることで、物事は円滑に進みます。謙虚な姿勢が、${prefName}でのあなたの評価を高めてくれるでしょう。`,
            `派手な行動は控え、慎重さが求められる一日です。今日の${prefName}では、大きな買い物や契約は避けた方が無難でしょう。石橋を叩いて渡るくらいの慎重さが、トラブルを未然に防ぎます。今日は情報収集に徹し、決断は後日に回すのが賢明です。`,
            `体調管理に気を配りたい日です。${prefName}の気候の変化や、室内の温度差に注意してください。少しでも不調を感じたら、無理をせず休息を取りましょう。身体を温める食事を摂り、十分な睡眠を確保することが、運気回復の鍵となります。`,
            `今日の${prefName}は、過去の整理に適しています。溜まっていた書類を片付けたり、スマホのデータを整理すると良いでしょう。物理的なスペースを空けることで、新しい運気が入ってくる隙間が生まれます。断捨離をするには絶好のタイミングです。`,
            `人間関係において、適度な距離感が大切な一日です。今日の${prefName}では、親しき仲にも礼儀ありを心がけましょう。馴れ合いになりすぎず、相手を尊重する態度を示すことで、無用なトラブルを避けることができます。大人の対応が求められる日です。`,
            `今日の${prefName}は、自然の力に癒やされると良いでしょう。近くの公園や川沿いを散歩するだけで、淀んだ気が浄化されます。コンクリートの建物の中に閉じこもらず、少しでも土や植物に触れる時間を作ってください。自然回帰が運を開きます。`,
            `少し孤独を感じやすい日かもしれません。しかし、それは「自立」を促すサインです。今日の${prefName}では、一人で行動することにツキがあります。一人ランチや一人旅を楽しんでみましょう。誰にも気を使わず、自分だけの時間を満喫することで、心が強くなります。`,
            `今日の${prefName}は、情報の取捨選択が重要です。噂話やフェイクニュースに惑わされないよう、確かな情報源を見極める目を持ってください。${prefName}の図書館や公的な場所で、静かに調べ物をするのが吉です。真実は静寂の中にあります。`,
            `金銭面での引き締めが必要な日です。今日の${prefName}では、衝動買いの誘惑に駆られるかもしれませんが、一度立ち止まって考えましょう。本当に必要なものかどうか自問自答することで、無駄な出費を抑えることができます。財布の紐を固くすることが、未来の豊かさに繋がります。`,
            `今日の${prefName}は、計画の見直しに適しています。進めている物事に無理がないか、一度立ち止まって点検してみましょう。修正すべき点が見つかるかもしれません。急がば回れの精神で、土台をしっかりと固める作業に時間を費やしてください。`,
            `目立たず、縁の下の力持ちに徹することで運が開ける日です。今日の${prefName}では、裏方の作業やサポート役に回るのが良いでしょう。誰かが見ていなくても、あなたの誠実な働きは必ず天に届いています。陰徳を積む一日としてください。`
        ];

        // --- 選択ロジック ---
        
        let selectedText = "";
        
        // スコアに応じて配列を選択
        let targetArray = [];
        if (score >= 90) targetArray = textsS;
        else if (score >= 70) targetArray = textsA;
        else targetArray = textsB;

        // 【重要】47都道府県それぞれに「固定のインデックス」を割り当てる
        // 配列の長さで割った余りを使うことで、ランダム性を保ちつつ
        // "北海道はこれ" "青森はこれ" といった偏りを防ぎ、かつ配列外参照も防ぐ
        // 日付が変われば rng の中身が変わるので、割り当てられる文章も変わる
        
        // index (0-46) を配列長 (15 or 16) で割った余りを使うと、
        // 47都道府県がまんべんなく異なる文章になる。
        // さらに rng.next() を加えて、日によって「どの県がどの文章になるか」をシャッフルする。
        
        const shuffleOffset = Math.floor(rng.next() * targetArray.length);
        const textIndex = (index + shuffleOffset) % targetArray.length;
        
        selectedText = targetArray[textIndex];

        // 最後に一言アドバイスを添える (共通)
        const advice = score >= 90 ? "自信を持って行動してください。" : 
                       score >= 70 ? "笑顔を絶やさず過ごしましょう。" : 
                       "焦らずマイペースを維持してください。";

        return selectedText + " " + advice;
    }
    // ==========================================
    //  統合された初期化処理 (window.onload)
    // ==========================================
    window.onload = function() {
        // 基本初期化
        initHomeAnimation();
        initZodiacSystem();
        
        // 認証状態の復元
        const storedUser = localStorage.getItem('omikuji_user');
        if(storedUser) {
            try { currentState.user = JSON.parse(storedUser); } catch(e){ console.error(e); }
        }
        updateAuthUI();
        loadLabSettings();

        // ダークモード監視
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme);

        // 各種データ取得・定期実行
        startLiveCounter();
        fetchHistoryStats();
        setInterval(fetchHistoryStats, 60000); 
        loadFavorites();

        // URLクリーンアップ
        const url = new URL(window.location);
        if (url.searchParams.has('d')) {
            url.searchParams.delete('d');
            window.history.replaceState({}, '', url);
        }

        // ▼ 記事リストの描画（ここでエラーが出ていた箇所を修正）
        renderHomeLists();      // ホーム画面用
        renderFullNewsView();   // 一覧画面用（ニュース）
        renderFullColumnView(); // 一覧画面用（コラム）
    };

        // --- 状態管理 ---
        let currentState = {
            view: 'home',
            user: null, // { email, username, token }
            lastResult: null,
            liveCount: 0,
            authMode: 'login' // 'login' or 'register'
        };

        let favoriteList = [];
        let dailyRanking = [];
        let globalHistory = [];
        let personalHistory = [];

        // --- Lab機能の状態管理とモーダル制御 (理由付き・検証済み完全版) ---
        const TenmeiLab = {
            details: {
                newyear: {
                    title: "迎春・雅（みやび）モード",
                    icon: '<i class="bi bi-flower1 text-yellow-600"></i>',
                    desc: "サイト全体のテーマカラーを「紅白」と「金」を基調としたお正月仕様に変更します。<br><br>背景に特別な和柄が浮かび上がり、おめでたい雰囲気を演出します。",
                    reason: "配色のコントラストが非常に強いため、長時間の閲覧において目の疲れ（ハレーション）を招く可能性があります。また、専用の装飾パターンが通信環境によっては読み込み遅延を起こす場合があります。",
                    bgClass: "bg-yellow-100"
                },
                speed: {
                    title: "神速（しんそく）の祈り",
                    icon: '<i class="bi bi-lightning-charge-fill text-blue-600"></i>',
                    desc: "おみくじ結果表示前の「3秒間のカウントダウン」を省略します。<br><br>※サーバーへの記録通信（ローディング）は数秒発生しますのでご了承ください。",
                    reason: "おみくじ本来の「待つ間の緊張感」や「情緒」が損なわれるため、UX（ユーザー体験）の観点から非推奨としています。また、連打が可能になることでAPIリクエスト制限（Rate Limit）に抵触しやすくなるリスクがあります。",
                    bgClass: "bg-blue-100"
                },
                dark: {
                    title: "宵闇（よいやみ）の刻",
                    icon: '<i class="bi bi-moon-stars-fill text-purple-600"></i>',
                    desc: "OSの設定に関わらず、強制的にダークモードを適用します。夜間の参拝や目に優しい画面を好む方に最適です。",
                    reason: "CSS変数の強制上書きを行うため、一部のブラウザや古い端末において、画面切り替え時に一瞬背景が白く光る「フラッシュ現象」が発生する可能性があります。",
                    bgClass: "bg-purple-100"
                },
                bigtext: {
                    title: "言霊（ことだま）の増幅",
                    icon: '<i class="bi bi-type-h1 text-green-600"></i>',
                    desc: "サイト内の主要な文字サイズを大きくします。神託の言葉をより力強く、読みやすく表示します。",
                    reason: "全体のレイアウト計算を無視してフォントサイズを拡大するため、スマートフォンなどの画面幅が狭い端末では、文字の改行位置が不自然になったり、枠からはみ出したりする（レイアウト崩れ）現象が避けられません。",
                    bgClass: "bg-green-100"
                },
                mist: {
                    title: "幽玄（ゆうげん）の霧",
                    icon: '<i class="bi bi-cloud-haze2-fill text-gray-600"></i>',
                    desc: "画面全体に流れる霧のアニメーションを重畳させます。<br><br>静かな杜の中にいるような、幻想的で神秘的な没入感を演出する視覚実験です。",
                    reason: "広範囲にぼかしフィルター（Blur）とアニメーションを常時適用するため、GPU（描画処理装置）への負荷が極めて高く、古いスマートフォンの動作が重くなったり、バッテリー消費が激しくなる問題があります。",
                    bgClass: "bg-gray-100"
                },
                gold: {
                    title: "黄金（おうごん）の神域",
                    icon: '<i class="bi bi-stars text-yellow-500"></i>',
                    desc: "サイト全体のアクセントカラーである「紅」を、すべて「黄金（ゴールド）」に変更します。<br><br>ボタンやタイトル、アイコンが金色に輝き、最高位の神域を彷彿とさせる豪華な装いになります。",
                    reason: "白背景に金色の文字を使用するため、視認性（アクセシビリティ）のガイドライン基準を満たしておらず、屋外や明るい場所では文字が読みづらくなるという欠陥を抱えています。",
                    bgClass: "bg-yellow-50"
                }
            },

            // 各スイッチの動作ロジック
            toggleNewYear: (el) => {
                if(el.checked) document.body.classList.add('theme-newyear');
                else document.body.classList.remove('theme-newyear');
                saveLabSettings();
            },
            toggleSpeed: (el) => {
                window.labSpeedMode = el.checked;
                saveLabSettings();
            },
            toggleDark: (el) => {
                saveLabSettings();
                applyTheme(); 
            },
            toggleBigText: (el) => {
                if(el.checked) document.documentElement.classList.add('lab-big-text');
                else document.documentElement.classList.remove('lab-big-text');
                saveLabSettings();
            },
            toggleMist: (el) => {
                const container = document.getElementById('mist-container');
                if(!container) return;

                if(el.checked) {
                    container.classList.add('active');
                } else {
                    container.classList.remove('active');
                }
                saveLabSettings();
            },
            toggleGold: (el) => {
                if(el.checked) document.body.classList.add('theme-gold');
                else document.body.classList.remove('theme-gold');
                saveLabSettings();
            },

            // モーダル制御
            openModal: (key) => {
                const data = TenmeiLab.details[key];
                if(!data) return;
                const content = document.getElementById('lab-modal-content');
                
                content.innerHTML = `
                    <div class="flex flex-col items-center text-center">
                        <div class="w-20 h-20 rounded-full ${data.bgClass} flex items-center justify-center text-4xl mb-6 shadow-sm">
                            ${data.icon}
                        </div>
                        <h3 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-100">${data.title}</h3>
                        
                        <!-- 機能説明 -->
                        <div class="text-gray-600 dark:text-gray-300 leading-loose text-left w-full bg-gray-50 dark:bg-zinc-800 p-6 rounded-xl border border-gray-100 dark:border-gray-700 mb-6 shadow-inner">
                            ${data.desc}
                        </div>

                        <!-- 実験的理由（警告エリア） -->
                        <div class="w-full bg-red-50 dark:bg-red-900/20 p-5 rounded-xl border border-red-200 dark:border-red-800 text-left shadow-sm">
                            <p class="font-bold text-red-600 dark:text-red-300 mb-2 flex items-center text-sm">
                                <i class="bi bi-exclamation-triangle-fill mr-2"></i>なぜ「実験的」なのか？
                            </p>
                            <p class="text-gray-700 dark:text-gray-300 leading-relaxed text-xs">
                                ${data.reason}
                            </p>
                        </div>

                        <div class="mt-8 w-full">
                            <button onclick="TenmeiLab.closeModal(null)" class="btn-primary w-full py-3 shadow-lg">
                                <i class="bi bi-check2"></i> 確認して閉じる
                            </button>
                        </div>
                    </div>
                `;
                const modal = document.getElementById('lab-modal');
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            },
            closeModal: (e) => {
                if (e && e.target.id !== 'lab-modal' && !e.target.classList.contains('lab-close-btn') && e.target.tagName !== 'BUTTON') return;
                document.getElementById('lab-modal').classList.remove('active');
                document.body.style.overflow = '';
            }
        };

        // --- 追加: テーマ適用ロジック（OS設定とLab設定の統合） ---
        function applyTheme() {
            let userSettings = null;
            if (currentState.user) {
                try {
                    userSettings = JSON.parse(localStorage.getItem(`lab_settings_${currentState.user.email}`));
                } catch(e) {}
            }

            // 「宵闇の刻」がONかどうか
            const forceDark = userSettings ? userSettings.dark : false;
            
            // OSがダークモードかどうか
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            // スイッチON または (スイッチOFFかつOSがダーク) の場合に dark クラスを付与
            if (forceDark || systemDark) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }

            // スイッチの見た目同期（ログイン時のみ）
            const switchDark = document.getElementById('switch-dark');
            if(switchDark && userSettings) {
                switchDark.checked = forceDark;
            }
        }

        // ==========================================
    //  TENMEI Labs 設定同期ロジック (サーバー連携版)
    // ==========================================

    // 1. 設定を保存する関数 (クラウド+ローカル)
    async function saveLabSettings() {
        const settings = {
            newyear: document.getElementById('switch-newyear').checked,
            speed: document.getElementById('switch-speed').checked,
            dark: document.getElementById('switch-dark').checked,
            bigtext: document.getElementById('switch-bigtext').checked,
            mist: document.getElementById('switch-mist').checked,
            gold: document.getElementById('switch-gold').checked
        };

        if (currentState.user) {
            // ログイン中：サーバー(KV)と同期
            // まずローカルに保存（オフライン対策・高速化）
            localStorage.setItem(`lab_settings_${currentState.user.email}`, JSON.stringify(settings));
            
            try {
                const res = await fetch(`${API_BASE}/api/user/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: currentState.user.email,
                        token: currentState.user.token,
                        settings: settings
                    })
                });
                if(!res.ok) throw new Error("Sync Failed");
                console.log("Labs設定をクラウドに保存しました");
            } catch (e) {
                console.error("Labs設定のクラウド同期に失敗しました", e);
            }
        } else {
            // 未ログイン：ゲスト用としてローカルのみ保存
            localStorage.setItem('lab_settings_guest', JSON.stringify(settings));
        }
    }

    // 2. 設定を読み込み、UIに反映させる関数
    async function loadLabSettings() {
        let settings = null;

        if (currentState.user) {
            // ログイン中：サーバーから最新設定を取得
            try {
                const res = await fetch(`${API_BASE}/api/user/settings?email=${encodeURIComponent(currentState.user.email)}&token=${encodeURIComponent(currentState.user.token)}`);
                if (res.ok) {
                    const data = await res.json();
                    settings = data.settings;
                    // クラウドから得た最新をローカルにもキャッシュ
                    if(settings) localStorage.setItem(`lab_settings_${currentState.user.email}`, JSON.stringify(settings));
                }
            } catch (e) {
                console.error("サーバーからの設定取得に失敗しました。ローカルデータを使用します。", e);
                const local = localStorage.getItem(`lab_settings_${currentState.user.email}`);
                if(local) settings = JSON.parse(local);
            }
        } else {
            // 未ログイン：ローカルから取得
            const local = localStorage.getItem('lab_settings_guest');
            if(local) settings = JSON.parse(local);
        }

        // --- UI（スイッチ）とクラスの反映 ---
        if (settings) {
            // 雅モード
            const swNewYear = document.getElementById('switch-newyear');
            if(swNewYear) swNewYear.checked = !!settings.newyear;
            if(settings.newyear) document.body.classList.add('theme-newyear');
            else document.body.classList.remove('theme-newyear');

            // 神速の祈り
            const swSpeed = document.getElementById('switch-speed');
            if(swSpeed) swSpeed.checked = !!settings.speed;
            window.labSpeedMode = !!settings.speed;

            // 言霊の増幅
            const swBigText = document.getElementById('switch-bigtext');
            if(swBigText) swBigText.checked = !!settings.bigtext;
            if(settings.bigtext) document.documentElement.classList.add('lab-big-text');
            else document.documentElement.classList.remove('lab-big-text');

            // 幽玄の霧
            const swMist = document.getElementById('switch-mist');
            const mistContainer = document.getElementById('mist-container');
            if(swMist) swMist.checked = !!settings.mist;
            if(settings.mist && mistContainer) mistContainer.classList.add('active');
            else if(mistContainer) mistContainer.classList.remove('active');

            // 黄金の神域
            const swGold = document.getElementById('switch-gold');
            if(swGold) swGold.checked = !!settings.gold;
            if(settings.gold) document.body.classList.add('theme-gold');
            else document.body.classList.remove('theme-gold');

            // 宵闇の刻
            const swDark = document.getElementById('switch-dark');
            if(swDark) swDark.checked = !!settings.dark;
        } else {
            // 設定データがない場合の初期化
            document.body.classList.remove('theme-newyear', 'theme-gold');
            document.documentElement.classList.remove('lab-big-text');
            const mistContainer = document.getElementById('mist-container');
            if(mistContainer) mistContainer.classList.remove('active');
            window.labSpeedMode = false;
        }

        // 最後に共通のテーマ適用（宵闇の刻など）を呼び出す
        applyTheme();
    }
        
        // --- window.onload への追加修正 ---
        window.onload = function() {
            initHomeAnimation();
            initZodiacSystem();
            
            const storedUser = localStorage.getItem('omikuji_user');
            if(storedUser) {
                try {
                    currentState.user = JSON.parse(storedUser);
                } catch(e) {
                    console.error("Auth Data Parse Error", e);
                }
            }
            updateAuthUI();
            loadLabSettings(); // ここで applyTheme が呼ばれます

            // OSのダークモード切り替えをリアルタイム検知して反映するリスナーを追加
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                applyTheme();
            });

            // ==========================================
    //  クイズ機能用ロジック (3問対応版)
    // ==========================================
    // btn: クリックされたボタン要素
    // isCorrect: 正解かどうか (true/false)
    // correctIndex: 選択肢の中で正解のボタンは何番目か (0, 1, 2... 上から順)
    window.handleQuiz = function(btn, isCorrect, correctIndex) {
        // ボタンの親要素（選択肢コンテナ）を取得
        const optionsArea = btn.parentElement;
        // そのコンテナ内の全ボタンを取得
        const allBtns = optionsArea.querySelectorAll('button');
        // 解説エリアを取得（選択肢コンテナの次にある要素）
        const resultArea = optionsArea.nextElementSibling;
        const msg = resultArea.querySelector('.quiz-msg');

        // 全ボタン無効化（連打防止）
        allBtns.forEach(b => {
            b.disabled = true;
            b.classList.add('opacity-50', 'cursor-not-allowed');
        });

        // 判定演出
        if (isCorrect) {
            btn.classList.remove('bg-white', 'dark:bg-black', 'border-gray-300', 'opacity-50');
            btn.classList.add('bg-green-100', 'dark:bg-green-900', 'border-green-500', 'text-green-800', 'dark:text-green-100', 'ring-2', 'ring-green-500');
            
            // 丸アイコンを追加
            const originalText = btn.innerText;
            btn.innerHTML = '<i class="bi bi-circle text-xl mr-2"></i> ' + originalText;
            
            msg.innerHTML = '<span class="text-green-600"><i class="bi bi-check-circle-fill"></i> 正解！</span>';
        } else {
            btn.classList.remove('bg-white', 'dark:bg-black', 'border-gray-300', 'opacity-50');
            btn.classList.add('bg-red-100', 'dark:bg-red-900', 'border-red-500', 'text-red-800', 'dark:text-red-100');
            
            // バツアイコンを追加
            const originalText = btn.innerText;
            btn.innerHTML = '<i class="bi bi-x-lg text-xl mr-2"></i> ' + originalText;

            msg.innerHTML = '<span class="text-red-600"><i class="bi bi-x-circle-fill"></i> 不正解...</span>';
            
            // 正解のボタンを強調表示してあげる（答え合わせ）
            const correctBtn = allBtns[correctIndex]; 
            if(correctBtn) {
                correctBtn.classList.remove('opacity-50', 'bg-white', 'dark:bg-black', 'border-gray-300');
                correctBtn.classList.add('bg-green-50', 'dark:bg-green-900/30', 'border-green-500', 'font-black', 'text-green-700', 'dark:text-green-300');
                correctBtn.innerHTML = '<i class="bi bi-circle text-xl mr-2"></i> ' + correctBtn.innerText;
            }
        }

        // 解説を表示
        resultArea.classList.remove('hidden');
    };

            startLiveCounter();
            fetchHistoryStats();
            setInterval(fetchHistoryStats, 60000); 
            
            loadFavorites();

            const url = new URL(window.location);
            if (url.searchParams.has('d')) {
                url.searchParams.delete('d');
                window.history.replaceState({}, '', url);
            }
             // ▼ 今回の追加箇所 ▼
    renderHomeLists();
    renderFullNewsView();
    renderFullColumnView();
        };

        // ■ 入力式クイズの判定関数
// button: クリックされたボタン要素
// correctAnswers: 正解の文字列リスト（配列）例: ['鳥居', 'とりい']
// questionId: 問題番号（入力欄の特定に使用）
function handleInputQuiz(button, correctAnswers, questionId) {
    // 入力欄を取得
    const inputField = button.parentElement.querySelector('input');
    const userValue = inputField.value.trim(); // 空白除去
    
    // 結果表示エリアを取得
    const parent = button.closest('.my-8'); // 親コンテナを探す
    const resultArea = parent.querySelector('.quiz-result');
    const msgArea = resultArea.querySelector('.quiz-msg');
    
    // すでに回答済みなら処理しない（連打防止）
    if (!resultArea.classList.contains('hidden') && resultArea.dataset.answered === "true") {
        return;
    }

    // 正誤判定（ひらがな・カタカナ・漢字の完全一致を確認）
    // ユーザーの入力を正規化（全角・半角などを揃える処理を入れても良いが、今回は単純比較）
    const isCorrect = correctAnswers.some(ans => ans === userValue);

    // 結果表示
    resultArea.classList.remove('hidden');
    resultArea.dataset.answered = "true"; // 回答済みフラグ
    
    if (isCorrect) {
        msgArea.innerHTML = '<span class="text-green-600">正解！</span>';
        msgArea.classList.add('text-green-600');
        // 入力欄を正解色に
        inputField.classList.add('border-green-500', 'bg-green-900', 'text-green-100');
        inputField.classList.remove('bg-gray-800');
    } else {
        msgArea.innerHTML = '<span class="text-red-500">残念...</span>';
        msgArea.classList.add('text-red-500');
        // 入力欄を不正解色に
        inputField.classList.add('border-red-500', 'bg-red-900', 'text-red-100');
        inputField.classList.remove('bg-gray-800');
    }
    
    // 入力欄を無効化（書き換え防止）
    inputField.disabled = true;
    button.disabled = true;
    button.classList.add('opacity-50', 'cursor-not-allowed');
    button.innerText = '回答済み';
}

        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if(show) {
                overlay.style.display = 'flex';
                // わずかに遅らせてopacityを変更しフェードインさせる
                requestAnimationFrame(() => overlay.classList.add('visible'));
            } else {
                overlay.classList.remove('visible');
                // フェードアウト後に非表示
                setTimeout(() => {
                    if(!overlay.classList.contains('visible')) overlay.style.display = 'none';
                }, 300);
            }
        }

        function showView(viewId) {
            // Lab機能へのアクセス制限処理
            if(viewId === 'lab') {
                const lock = document.getElementById('lab-lock');
                const wrapper = document.getElementById('lab-content-wrapper');
                
                if(!currentState.user) {
                    lock.classList.remove('hidden');
                    wrapper.classList.add('lab-blurred');
                } else {
                    lock.classList.add('hidden');
                    wrapper.classList.remove('lab-blurred');
                }
            }

            // 画面の切り替え（フェードアニメーション）
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
                setTimeout(() => {
                    if(!el.classList.contains('active')) el.style.display = 'none';
                }, 500);
            });
            
            const target = document.getElementById(`view-${viewId}`);
            if (target) {
                target.style.display = 'block';
                void target.offsetWidth; 
                target.classList.add('active');
            }
            currentState.view = viewId;

            // --- 各ビューごとの初期化ロジック ---
            if(viewId === 'draw') {
                resetOmikujiPool();
            }
            if(viewId === 'history') {
                loadHistory();
            }
            // ▼ ここが重要：都道府県ランキングの呼び出し
            if(viewId === 'prefecture') {
                renderPrefectureRanking();
            }
        }
        function articleBack() {
            showView('home'); 
        }

        // --- ホームアニメーション ---
        function initHomeAnimation() {
            const container = document.getElementById('home-anim-container');
            const paperCount = 20;
            for(let i=0; i<paperCount; i++) {
                const paper = document.createElement('div');
                paper.className = 'flying-paper';
                paper.style.left = Math.random() * 260 + 'px';
                paper.style.animationDelay = Math.random() * 4 + 's';
                paper.style.animationDuration = (3 + Math.random() * 3) + 's';
                paper.textContent = "天命乃杜";
                container.appendChild(paper);
            }
        }

        // --- ライブカウンター (API連携) ---
        function startLiveCounter() {
            const el = document.getElementById('live-counter');
            const timeEl = document.getElementById('counter-time');
            
            fetchCount();
            setInterval(fetchCount, 60000);

            async function fetchCount() {
                const now = new Date();
                timeEl.textContent = now.toLocaleTimeString();
                try {
                    const res = await fetch(`${API_BASE}/api/counter`);
                    if(res.ok) {
                        const data = await res.json();
                        // サーバーの値をそのまま表示
                        currentState.liveCount = (data.count || 0);
                        el.textContent = currentState.liveCount.toLocaleString() + "本";
                    }
                } catch(e) { console.error(e); }
            }
        }

        // --- 統計情報の取得 (12種類対応版) ---
        async function fetchHistoryStats() {
            try {
                const res = await fetch(`${API_BASE}/api/stats`);
                if(res.ok) {
                    const data = await res.json();
                    document.getElementById('stats-update-time').textContent = data.timestamp || "--:--:--";

                    const setBar = (id, percent, count) => {
                        // 要素が存在する場合のみ更新
                        const statEl = document.getElementById(`stat-${id}`);
                        if (statEl) {
                            const p = parseFloat(percent).toFixed(2);
                            statEl.textContent = p + "%";
                            document.getElementById(`cnt-${id}`).textContent = (count || 0).toLocaleString() + "本";
                            document.getElementById(`bar-${id}`).style.width = p + "%";
                        }
                    };

                    const stats = data.stats || {};
                    const counts = data.counts || {};
                    
                    // 12種類全てのキーを更新
                    const keys = [
                        'daikichi', 'chukichi', 'shokichi', 'kichi', 'hankichi', 'suekichi', 'sueshokichi',
                        'kyo', 'shokyo', 'hankyo', 'suekyo', 'daikyo'
                    ];
                    
                    keys.forEach(key => {
                        setBar(key, stats[key] || 0, counts[key] || 0);
                    });
                }
            } catch(e) { console.error(e); }
        }

        // --- おみくじロジック ---
        function startOmikuji() {
            showView('draw');
        }

        function resetOmikujiPool() {
            const pool = document.getElementById('omikuji-pool');
            pool.innerHTML = '';
            addOmikujiBatch(100, true); 
        }

        function addOmikuji() {
            addOmikujiBatch(50, false);
            const section = document.getElementById('view-draw');
            section.scrollBy({ top: 400, behavior: 'smooth' });
        }

        function addOmikujiBatch(count, isInitial) {
            const pool = document.getElementById('omikuji-pool');
            let lastBottom = 0;
            if (!isInitial && pool.childElementCount > 0) {
                lastBottom = pool.childElementCount * 25; 
            }

            for(let i=0; i<count; i++) {
                const stick = document.createElement('div');
                stick.className = 'omikuji-stick shadow-md rounded';
                stick.textContent = `天命乃杜`; 
                
                const left = Math.random() * 90 + 5; 
                let top;
                if (isInitial) {
                    top = (i * 20) + (Math.random() * 100); 
                } else {
                    top = lastBottom + (i * 20) + (Math.random() * 100);
                }
                const rot = Math.random() * 360;
                
                stick.style.left = `calc(${left}% - 25px)`;
                stick.style.top = `${top}px`;
                stick.style.transform = `rotate(${rot}deg)`;
                stick.style.animation = `slideInRandom 0.5s ease forwards ${Math.random() * 0.3}s`;
                
                stick.onclick = function() {
                    drawResult(this);
                };
                
                pool.appendChild(stick);
            }
        }

        // 12種類のおみくじ結果定義
        const omikujiResults = [
            { type: "大吉", rank: 5, poem: "枯れ果てし 枝に再び 花咲くが如し", desc: "最高の運気です。長年の努力が報われ、枯れ木に花が咲くような喜びが訪れるでしょう。しかし慢心は禁物。感謝の心を忘れずに。" },
            { type: "中吉", rank: 4, poem: "照る月を 雲が隠せど 風払うなり", desc: "一時的な迷いがあっても、すぐに晴れ間が見えます。自分の信念を貫くことで、雲を払う風のような助けが現れるはずです。" },
            { type: "小吉", rank: 3, poem: "小川の水 淀まず流るる 様を見るべし", desc: "派手さはありませんが、平穏無事な日々が続きます。日々の小さな幸せを大切にし、流れに身を任せるのが吉です。" },
            { type: "吉", rank: 4, poem: "春風に 池の氷も 解け初めて", desc: "厳しい冬が終わり、徐々に運気が上昇しています。焦らず着実に進めば、池の氷が解けるように悩みも消えていくでしょう。" },
            { type: "半吉", rank: 3, poem: "山里の 雪解け水も 川となりて", desc: "今はまだ準備段階。しかし確実に運気は開けつつあります。焦らず力を蓄え、時が来るのを待ちましょう。" },
            { type: "末吉", rank: 3, poem: "山道の 険しき坂も 一歩より", desc: "今は登り坂で苦しい時かもしれませんが、一歩一歩進めば必ず頂上に辿り着けます。忍耐力が試される時です。" },
            { type: "末小吉", rank: 2, poem: "種まけば やがて芽が出る 時を待て", desc: "結果が出るまでには時間がかかります。今は地道な努力を続ける時期。将来の大輪の花を信じて。" },
            { type: "凶", rank: 1, poem: "雨雲の 晴れ間も見えず 濡れ衣かな", desc: "誤解を受けやすく、思うようにいかない時期です。今は弁解せず、静かに嵐が過ぎるのを待つのが賢明な判断です。" },
            { type: "小凶", rank: 2, poem: "石の上にも 三年いれば 暖かき", desc: "辛抱が必要な時。すぐに結果を求めず、じっくりと腰を据えて取り組むことで道が開けます。" },
            { type: "半凶", rank: 2, poem: "嵐吹く 庭の小枝も 折れぬよう", desc: "逆風が吹くかもしれません。しかし、しなやかに対応すれば折れることはありません。柔軟な姿勢が大切です。" },
            { type: "末凶", rank: 1, poem: "夜の闇 深きほどに 暁近し", desc: "今は一番暗い時期かもしれませんが、夜明けは必ず来ます。希望を捨てずに前を向きましょう。" },
            { type: "大凶", rank: 0, poem: "嵐吹く 荒野に一人 立つが如し", desc: "八方塞がりの厳しい運勢。無理に動くと災いを招きます。身を潜め、自分を見つめ直す修行の時と心得てください。" }
        ];

        // 運勢ランク別詳細テキストデータ
        const detailTexts = {
            '願事': ["意のままに叶う", "速やかに叶う", "後に叶う", "叶うが遅し", "叶いにくし", "叶わず"],
            '恋愛': ["相思相愛なり", "良縁に恵まれる", "誠意で通じる", "迷いあり", "諦めが肝心", "縁なし"],
            '待人': ["来る 喜びあり", "来る たよりあり", "遅れるが来る", "来ず 音信あり", "来ず さわりあり", "来ず 決して来ず"],
            '商売': ["買うに吉 利あり", "利益あり", "売り買い吉", "利少なし", "損害の恐れ", "商うな 損する"],
            '旅立': ["いざ行け 大吉", "行先に利あり", "よき連れあり", "盗難に注意", "行くな 災いあり", "道中 危険あり"],
            '学問': ["安心して勉めよ", "試験に通る", "努力せよ", "困難あり", "危うし", "絶望的"],
            '病気': ["全快す", "治る 信じよ", "長引くが治る", "養生せよ", "重し 医者を選べ", "危うし 祈れ"]
        };

        // 重複排除用リスト拡張
        const luckyItemsList = [
            "古時計","香水","手鏡","文庫本","スニーカー","万年筆",
            "水晶","観葉植物","銀の指輪","ハンカチ","革靴","手帳",
            "香辛料","紅茶","コイン","鈴","扇子","万華鏡",
            "砂時計","栞","眼鏡","帽子","手袋","香木",
            "和紙","筆","インク","切手","古銭","鍵",
            "ロケット","ブローチ","スカーフ","リボン","ベルト","財布",
            "パスケース","名刺入れ","ポーチ","水筒","マグカップ","皿",
            "箸","風鈴","お守り","数珠","朱肉","印鑑"
        ];
        const luckySpotsList = [
            "図書館","カフェ","神社","海辺","高台","公園",
            "美術館","映画館","博物館","水族館","動物園","植物園",
            "本屋","雑貨屋","パン屋","花屋","駅","空港",
            "港","橋の上","川沿い","山頂","森","温泉",
            "寺院","教会","塔","城","市場","路地裏",
            "噴水広場","並木道","屋上","地下街","交差点","歩道橋",
            "ベンチ","テラス","窓際","カウンター","個室","ロビー",
            "玄関","庭","ベランダ","書斎","リビング","寝室"
        ];
        const luckyColorsList = [
            "赤","青","白","金","紫","緑",
            "黄","橙","桃","黒","銀","紺",
            "茶","灰","水色","黄緑","深紅","群青",
            "琥珀","翡翠","瑠璃","真紅","漆黒","純白",
            "桜色","藤色","山吹色","若草色","空色","茜色",
            "黄金","白銀","銅","パール","ベージュ","クリーム",
            "ワインレッド","オリーブ","ミント","ラベンダー","サーモン","コーラル",
            "ターコイズ","インディゴ","マゼンタ","シアン","ライム","レモン"
        ];
        const luckyPersonsList = [
            "旧友","年上","年下","家族","先生","初対面",
            "同僚","上司","部下","隣人","店員","旅人",
            "子供","老人","職人","芸術家","医師","看護師",
            "警察官","消防士","運転手","駅員","郵便屋","料理人",
            "美容師","作家","歌手","俳優","選手","学者",
            "社長","秘書","受付","警備員","清掃員","農家",
            "漁師","神主","住職","牧師","シスター","占い師",
            "幼馴染","親戚","恩師","先輩","後輩","ライバル"
        ];

        function getRandomUnique(list, count) {
            const shuffled = [...list].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        function drawResult(element) {
            const overlay = document.getElementById('countdown-overlay');
            const numEl = document.getElementById('countdown-number');
            overlay.style.display = 'flex';
            
            // Lab: 神速の祈りモードならカウントダウン省略
            if(window.labSpeedMode) {
                overlay.style.display = 'none';
                showResultDetail(true);
                return;
            }
            
            let count = 3;
            numEl.textContent = count;
            
            const timer = setInterval(() => {
                count--;
                if(count > 0) {
                    numEl.textContent = count;
                } else {
                    clearInterval(timer);
                    overlay.style.display = 'none';
                    showResultDetail(true); 
                }
            }, 1000);
        }

        async function showResultDetail(isNewDraw, dataOverride = null) {
            let resultData, randNum, detailsList, luckyItems, unluckyItems, timestamp, username;

            if (isNewDraw) {
                // 新規抽選
                const base = omikujiResults[Math.floor(Math.random() * omikujiResults.length)];
                randNum = Math.floor(Math.random() * 100) + 1;
                timestamp = Date.now();
                username = currentState.user ? (currentState.user.username || "参拝者") : "ゲスト";

                // 詳細項目: 運勢ランク連動ロジック
                const detailIndex = 5 - base.rank;
                const cats = ['願事','恋愛','待人','商売','旅立','学問','病気'];
                
                detailsList = cats.map(c => ({
                    title: c,
                    content: detailTexts[c][Math.min(detailIndex, detailTexts[c].length - 1)]
                }));

                // ラッキー/アンラッキー
                luckyItems = {
                    item: luckyItemsList[Math.floor(Math.random()*luckyItemsList.length)],
                    spot: luckySpotsList[Math.floor(Math.random()*luckySpotsList.length)],
                    color: luckyColorsList[Math.floor(Math.random()*luckyColorsList.length)],
                    person: luckyPersonsList[Math.floor(Math.random()*luckyPersonsList.length)]
                };
                
                let ulItem, ulSpot, ulPerson;
                do { ulItem = luckyItemsList[Math.floor(Math.random()*luckyItemsList.length)]; } while(ulItem === luckyItems.item);
                do { ulSpot = luckySpotsList[Math.floor(Math.random()*luckySpotsList.length)]; } while(ulSpot === luckyItems.spot);
                do { ulPerson = luckyPersonsList[Math.floor(Math.random()*luckyPersonsList.length)]; } while(ulPerson === luckyItems.person);

                unluckyItems = {
                    item: ulItem,
                    spot: ulSpot,
                    person: ulPerson
                };

                resultData = { 
                    type: base.type, 
                    poem: base.poem, 
                    desc: base.desc,
                    num: randNum, 
                    detail: detailsList,
                    lucky: luckyItems,
                    unlucky: unluckyItems,
                    timestamp: timestamp,
                    username: username
                };
                currentState.lastResult = resultData;

                // URL更新廃止: クリーンなURLのまま

                // ログイン時のみ保存・更新
                if(currentState.user) {
                    showLoading(true);
                    try {
                        const res = await fetch(`${API_BASE}/api/draw`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                email: currentState.user.email,
                                token: currentState.user.token,
                                result: resultData.type,
                                poem: resultData.poem,
                                detail: detailsList,
                                lucky: luckyItems,
                                unlucky: unluckyItems
                            })
                        });
                        
                        if(res.ok) {
                            const data = await res.json();
                            if(data.success && data.count) {
                                currentState.liveCount = data.count;
                                document.getElementById('live-counter').textContent = currentState.liveCount.toLocaleString() + "本";
                                fetchHistoryStats();
                            }
                        }
                    } catch(e) { console.error(e); }
                    finally { showLoading(false); }
                }

            } else {
                // 復元
                resultData = dataOverride;
                randNum = dataOverride.num || 1;
                
                // 詳細項目の復元
                if (Array.isArray(dataOverride.detail)) {
                    detailsList = dataOverride.detail;
                } else {
                    const cats = ['願事','恋愛','待人','商売','旅立','学問','病気'];
                    const vals = ['叶う','良し','来る','繁盛','吉','成就','治る','遅れる','待て','控','難','危'];
                    detailsList = cats.map(c => ({
                        title: c,
                        content: vals[Math.floor(Math.random() * vals.length)]
                    }));
                }

                // 助言の復元
                let restoredDesc = dataOverride.desc;
                if (!restoredDesc && dataOverride.poem) {
                    const original = omikujiResults.find(r => r.poem === dataOverride.poem);
                    if (original) {
                        restoredDesc = original.desc;
                    } else {
                        restoredDesc = "心穏やかに過ごすべし。";
                    }
                } else if (!restoredDesc) {
                    restoredDesc = "心穏やかに過ごすべし。";
                }

                // ラッキーアイテム等の復元
                luckyItems = dataOverride.lucky || { item: "不明", spot: "不明", color: "不明", person: "不明" };
                unluckyItems = dataOverride.unlucky || { item: "不明", spot: "不明", person: "不明" };

                timestamp = dataOverride.timestamp;
                username = dataOverride.username || "参拝者";
                
                resultData = {
                    type: dataOverride.type || dataOverride.result,
                    poem: dataOverride.poem,
                    desc: restoredDesc,
                    num: randNum,
                    detail: detailsList,
                    lucky: luckyItems,
                    unlucky: unluckyItems,
                    timestamp: timestamp,
                    username: username
                };
                currentState.lastResult = resultData;
            }

            renderResultToCard('result-card-outer', resultData, true); 
            showView('result');
            
            const container = document.getElementById('generated-image-container');
            container.innerHTML = '';
            container.classList.add('hidden');
            document.getElementById('gen-img-status').textContent = "";
        }

        // updateURL は廃止（空関数にして互換性維持）
        function updateURL(resultData) {}

        function renderResultToCard(outerId, data, withFooter) {
            const outer = document.getElementById(outerId);
            outer.innerHTML = ''; 

            // スタイル適用
            outer.className = 'result-card-outer';
            if (data.type === "大吉") outer.classList.add("style-daikichi");
            else if (data.type === "大凶") outer.classList.add("style-daikyo");
            else outer.classList.add("style-normal");

            // 1. 最上部: 家紋 + タイトル
            const headerDiv = document.createElement('div');
            headerDiv.className = 'result-logo-area';
            headerDiv.innerHTML = `
                <div class="result-kamon accent-text"><i class="bi bi-flower1"></i></div>
                <div class="result-title-text accent-text">運勢・天命乃杜</div>
            `;
            outer.appendChild(headerDiv);

            // 2. 累計発行本数 (第〇〇番の代わり)
            const issueDiv = document.createElement('div');
            issueDiv.className = 'result-issue-num';
            let issueNum = currentState.liveCount || 15118061;
            issueDiv.textContent = `累計発行本数 ${issueNum.toLocaleString()} 本`;
            outer.appendChild(issueDiv);

            // 3. 中央: 運勢結果（円）
            const circleBox = document.createElement('div');
            circleBox.className = 'result-circle-box accent-border';
            circleBox.innerHTML = `<div class="result-kanji-main accent-text">${data.type}</div>`;
            outer.appendChild(circleBox);

            // 4. 円の下: 運勢という文字
            const labelSub = document.createElement('div');
            labelSub.className = 'result-label-sub accent-text';
            labelSub.textContent = '運勢';
            outer.appendChild(labelSub);

            // 5. メインメッセージ + 助言
            const msgArea = document.createElement('div');
            msgArea.className = 'result-main-message-area';
            
            const adviceBox = document.createElement('div');
            adviceBox.className = 'result-advice-box accent-border';
            const adviceText = data.desc || "心穏やかに過ごすべし。";
            adviceBox.innerHTML = `<span class="advice-label accent-text">助言</span> <span class="accent-text">${adviceText}</span>`;
            
            const poemDiv = document.createElement('div');
            poemDiv.className = 'result-poem-vertical accent-text';
            poemDiv.textContent = data.poem;

            msgArea.appendChild(adviceBox);
            msgArea.appendChild(poemDiv);
            outer.appendChild(msgArea);

            // 6. 詳細運勢リスト (縦書き)
            const detailGrid = document.createElement('div');
            detailGrid.className = 'result-details-grid accent-border';
            
            if (data.detail) {
                data.detail.forEach(d => {
                    const col = document.createElement('div');
                    col.className = 'detail-column';
                    col.innerHTML = `<span class="detail-item-label accent-text">${d.title}</span> <span class="detail-item-content accent-text">${d.content}</span>`;
                    detailGrid.appendChild(col);
                });
            }
            outer.appendChild(detailGrid);

            // 7. 開運・不運項目
            const luckyArea = document.createElement('div');
            luckyArea.className = 'lucky-area';
            
            const lBox = document.createElement('div');
            lBox.className = 'lucky-box accent-border';
            if (data.lucky) {
                lBox.innerHTML = `
                    <div class="lucky-title accent-text">開運</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-stars"></i></span>物：${data.lucky.item}</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-geo-alt"></i></span>所：${data.lucky.spot}</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-palette"></i></span>色：${data.lucky.color}</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-person"></i></span>人：${data.lucky.person}</div>
                `;
            }
            luckyArea.appendChild(lBox);

            const uBox = document.createElement('div');
            uBox.className = 'unlucky-box accent-border';
            if (data.unlucky) {
                uBox.innerHTML = `
                    <div class="lucky-title accent-text red-text" style="color:red">不運・注意</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-exclamation-triangle"></i></span>物：${data.unlucky.item}</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-x-octagon"></i></span>所：${data.unlucky.spot}</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-person-x"></i></span>人：${data.unlucky.person}</div>
                `;
            }
            luckyArea.appendChild(uBox);
            outer.appendChild(luckyArea);

            // 8. フッター (日時・名前・QR)
            if (withFooter) {
                const footer = document.createElement('div');
                footer.className = 'result-footer-info accent-border';
                
                const metaDiv = document.createElement('div');
                metaDiv.style.textAlign = 'left';
                
                const name = data.username || "参拝者";
                const date = new Date(data.timestamp || Date.now());
                const dateStr = `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日 ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;

                metaDiv.innerHTML = `
                    <div class="result-user-name accent-text">${name} 様の運勢</div>
                    <div class="result-date accent-text">参拝日: ${dateStr}</div>
                `;

                const qrDiv = document.createElement('div');
                qrDiv.className = 'result-qr-container';
                const qrTarget = document.createElement('div');
                qrDiv.appendChild(qrTarget);
                
                footer.appendChild(metaDiv);
                footer.appendChild(qrDiv);
                outer.appendChild(footer);

                setTimeout(() => {
                    new QRCode(qrTarget, {
                        text: SITE_URL,
                        width: 60,
                        height: 60,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                }, 100);
            }
        }

       // --- 履歴・おみくじの轍 (修正版: ページ機能対応) ---
async function loadHistory() {
    const list = document.getElementById('history-list');
    const container = document.getElementById('history-container');
    const overlay = document.getElementById('history-login-overlay');
    const viewMode = document.getElementById('history-view-mode');
    const myCountEl = document.getElementById('personal-history-count');
    const globalCountEl = document.getElementById('global-history-count');
    const pagination = document.getElementById('history-pagination'); // 追加

    list.innerHTML = '';
    pagination.innerHTML = ''; // リセット

    if(!currentState.user) {
        container.classList.add('history-blurred');
        overlay.classList.remove('hidden');
        viewMode.textContent = "";
        myCountEl.textContent = "-";
        globalCountEl.textContent = "-";
        // 非ログイン時のダミー表示
        let html = '';
        for(let i=0; i<10; i++) {
            html += `
                <div class="bg-gray-50 dark:bg-zinc-800 p-3 rounded flex justify-between items-center border-l-4 border-gray-300">
                    <div class="flex flex-col">
                        <span class="text-xs themed-text-sub">??? 様</span>
                        <span class="text-xs text-gray-400">----/--/--</span>
                    </div>
                    <span class="font-bold text-lg">???</span>
                </div>
            `;
        }
        list.innerHTML = html;
        return;
    }

    container.classList.remove('history-blurred');
    overlay.classList.add('hidden');
    viewMode.textContent = "全参拝者の記録 (全期間)";
    list.innerHTML = '<p class="text-center text-sm themed-text-sub">読み込み中...</p>';
    showLoading(true);

    try {
        const res = await fetch(`${API_BASE}/api/history/global?token=${encodeURIComponent(currentState.user.token)}`);
        if(res.ok) {
            const data = await res.json();
            globalHistory = data.global || [];
            personalHistory = data.personal || [];
            
            myCountEl.textContent = personalHistory.length + "回";
            globalCountEl.textContent = globalHistory.length + "回";

            // ★修正: データをセットしてページ表示関数を呼ぶ
            historyPageState.filteredData = globalHistory;
            historyPageState.page = 1;
            renderHistoryWithPagination();
            
        } else {
            list.innerHTML = '<p class="text-center text-red-500">取得失敗</p>';
        }
    } catch(e) {
        console.error(e);
        list.innerHTML = '<p class="text-center text-red-500">通信エラー</p>';
    } finally {
        showLoading(false);
    }
}

        // 履歴リストのレンダリング関数 (修正版: 件数表示の上書きを削除)
        function renderHistoryList(historyData) {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            
            // 【削除】ここで件数を上書きしていたため、ページごとの件数になってしまっていました。
            // document.getElementById('search-result-count').textContent = historyData.length;

            if(historyData.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-center">該当する履歴がありません。</p>';
                return;
            }

            historyData.forEach((item) => {
                const div = document.createElement('div');
                const isMe = item.username === currentState.user.username;
                const borderColor = item.result.includes('凶') ? 'border-gray-500' : 'border-red-500';
                const bgClass = isMe ? 'bg-red-50 dark:bg-red-900/20' : 'bg-gray-50 dark:bg-zinc-800';

                div.className = `${bgClass} p-3 rounded flex justify-between items-center border-l-4 ${borderColor} cursor-pointer hover:opacity-80 transition shadow-sm`;
                
                div.onclick = () => {
                    showResultDetail(false, item);
                }; 

                const date = new Date(item.timestamp);
                const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                div.innerHTML = `
                    <div class="flex flex-col text-left">
                        <span class="text-xs font-bold ${isMe ? 'text-red-600' : 'themed-text-sub'}">${item.username} 様</span>
                        <span class="text-xs text-gray-400">${dateStr}</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-bold text-red-700 dark:text-red-400 text-lg w-16 text-right">${item.result}</span>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // 検索ロジック (修正版: ページ機能対応)
function filterHistory() {
    const type = document.getElementById('search-type').value;
    const keyword = document.getElementById('search-keyword').value.toLowerCase();
    const dateStart = document.getElementById('search-date-start').value;
    const dateEnd = document.getElementById('search-date-end').value;

    let targetList = globalHistory;

    const filtered = targetList.filter(item => {
        const itemDate = new Date(item.timestamp);
        
        // 運勢タイプフィルタ
        if (type !== 'all' && item.result !== type) return false;

        // キーワードフィルタ (ユーザー名)
        if (keyword && !item.username.toLowerCase().includes(keyword)) return false;

        // 日付範囲フィルタ
        if (dateStart) {
            const start = new Date(dateStart);
            start.setHours(0, 0, 0, 0);
            if (itemDate < start) return false;
        }
        if (dateEnd) {
            const end = new Date(dateEnd);
            end.setHours(23, 59, 59, 999);
            if (itemDate > end) return false;
        }

        return true;
    });

    // ★修正: フィルタ結果をセットして1ページ目を表示
    historyPageState.filteredData = filtered;
    historyPageState.page = 1;
    renderHistoryWithPagination();
}

// リセット機能も修正
function resetSearch() {
    document.getElementById('search-type').value = 'all';
    document.getElementById('search-keyword').value = '';
    document.getElementById('search-date-start').value = '';
    document.getElementById('search-date-end').value = '';
    
    // 全件に戻す
    historyPageState.filteredData = globalHistory;
    historyPageState.page = 1;
    renderHistoryWithPagination();
}

        // モーダル機能は使わなくなったので削除または無効化
        function openHistoryDetail(index) {
            // 廃止: 直接遷移するため
        }
        function closeHistoryDetail(e) {
            if(e && e.target.id !== 'history-detail-modal' && e.target.tagName !== 'BUTTON') return;
            document.getElementById('history-detail-modal').style.display = 'none';
        }

        // --- シェア用画像生成 (大吉バグ修正版) ---
        function generateResultImage() {
            const status = document.getElementById('gen-img-status');
            status.textContent = "シェア画像を生成中...フォント読み込み待機";
            
            const target = document.getElementById('result-capture-container');
            const container = document.getElementById('generated-image-container');
            container.innerHTML = '';
            container.classList.add('hidden');
            
            document.fonts.ready.then(() => {
                const originalScrollPos = window.scrollY;

                html2canvas(target, { 
                    scale: 3, 
                    useCORS: true, 
                    allowTaint: true,
                    backgroundColor: null, 
                    scrollX: 0,
                    scrollY: -window.scrollY, 
                    // ここが修正の肝です
                    onclone: (clonedDoc) => {
                        const clonedOuter = clonedDoc.getElementById('result-card-outer');
                        if (clonedOuter) {
                            // 1. 縦書きレイアウト崩れ防止ハック
                            const verticals = clonedOuter.querySelectorAll('.result-poem-vertical, .result-advice-box, .detail-column');
                            verticals.forEach(el => {
                                el.style.letterSpacing = '0.1em'; 
                                el.style.lineHeight = '1.6';
                                el.style.fontFamily = "'Zen Old Mincho', serif"; 
                            });

                            // 2. 【重要】大吉の背景SVGを削除する (これでクラッシュを防ぐ)
                            // 模様は消えますが、背景色の金色(#f3c845)は残るので見た目は金色のままです
                            clonedOuter.style.backgroundImage = 'none';

                            clonedOuter.style.height = 'auto';
                            clonedOuter.style.minHeight = '1200px'; 
                            clonedOuter.style.transform = 'none'; 
                        }
                    }
                }).then(canvas => {
                    status.textContent = "";
                    
                    container.innerHTML = '<p class="text-green-600 font-bold mb-2">画像の生成完了</p>';
                    
                    canvas.toBlob(blob => {
                        currentState.lastImageBlob = blob;
                        const url = URL.createObjectURL(blob);
                        
                        const img = document.createElement('img');
                        img.src = url;
                        img.className = "mx-auto rounded border w-32 mb-2 shadow-sm"; 
                        container.appendChild(img);
                        container.classList.remove('hidden');

                        const dlLink = document.createElement('a');
                        dlLink.href = url;
                        dlLink.download = `tenmei_omikuji_${Date.now()}.png`;
                        dlLink.className = "btn-primary text-sm mt-2 inline-block";
                        dlLink.innerHTML = '<i class="bi bi-download"></i> ダウンロード';
                        container.appendChild(dlLink);
                    }, 'image/png');

                    window.scrollTo(0, originalScrollPos);

                }).catch(err => {
                    console.error(err);
                    status.textContent = "画像の生成に失敗しました。";
                    window.scrollTo(0, originalScrollPos);
                });
            });
        }

        // サイトルートURLを返す（生成URL廃止）
        function getShareUrl() {
            return SITE_URL;
        }

        // 全プラットフォーム共通の凝縮版長文テキスト生成ロジック
        // 日本語140文字程度に収めるよう調整
        function generateUnifiedShareText(res) {
            const userName = res.username || "参拝者"; 
            const date = new Date(res.timestamp);
            const dateStr = `${date.getMonth()+1}月${date.getDate()}日`;
            
            // 開運情報は全て表示
            const luckyItems = `🗝️開運:${res.lucky.item} / ${res.lucky.color}`;
            
            // 投稿文組み立て
            return `⛩️ 運勢・天命乃杜で運試し ⛩️

参拝者：${userName}様（${dateStr}）
✨運勢：【 ${res.type} 】
📜神託：『${res.poem.substring(0, 5)}...』続きはWebで

${luckyItems}

過去の記録は「おみくじの轍」へ保存済⛩️
履歴が多ければ条件指定の検索機能で即発見🔍

#天命乃杜 #おみくじ #運勢
${getShareUrl()}`;
        }

        // --- シェアアクション (アラート削除版) ---
        async function shareToX() {
            if(!currentState.lastResult) return;
            const fullText = generateUnifiedShareText(currentState.lastResult);

            // 1. Web Share API (スマホアプリ連携) トライ
            if (navigator.share && currentState.lastImageBlob) {
                try {
                    const file = new File([currentState.lastImageBlob], "tenmei_omikuji.png", { type: "image/png" });
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            text: fullText,
                            files: [file]
                        });
                        return;
                    }
                } catch (e) {
                    console.log("Web Share API failed", e);
                }
            }

            // 2. PC/フォールバック: 画像ダウンロード + 投稿画面
            if (currentState.lastImageBlob) {
                // 画像をダウンロードさせる
                const url = URL.createObjectURL(currentState.lastImageBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tenmei_omikuji_${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // 【削除】ここで alert を出していましたが、削除しました。
            }

            // Xの投稿画面を開く
            const intent = `https://twitter.com/intent/tweet?text=${encodeURIComponent(fullText)}`;
            window.open(intent, '_blank');
        }

        async function shareToFB() {
            if(!currentState.lastResult) return;
            const fullText = generateUnifiedShareText(currentState.lastResult);

            if (navigator.share && currentState.lastImageBlob) {
                try {
                    const file = new File([currentState.lastImageBlob], "omikuji.png", { type: "image/png" });
                    await navigator.share({
                        text: fullText,
                        files: [file]
                    });
                    return;
                } catch (e) {
                    console.log("Web Share API failed for FB", e);
                }
            }

            const url = getShareUrl();
            const intent = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
            window.open(intent, '_blank');
        }
        
        async function shareToLine() {
            if(!currentState.lastResult) return;
            const fullText = generateUnifiedShareText(currentState.lastResult);

             if (navigator.share && currentState.lastImageBlob) {
                try {
                    const file = new File([currentState.lastImageBlob], "omikuji.png", { type: "image/png" });
                    await navigator.share({
                        text: fullText,
                        files: [file]
                    });
                    return;
                } catch(e) {
                    console.log("Web Share API failed for LINE", e);
                }
            }

            const intent = `https://social-plugins.line.me/lineit/share?text=${encodeURIComponent(fullText)}`;
            window.open(intent, '_blank');
        }

        async function shareToBluesky() {
            if(!currentState.lastResult) return;
            const fullText = generateUnifiedShareText(currentState.lastResult);

            // 1. Web Share API (アプリ連携) トライ
            if (navigator.share && currentState.lastImageBlob) {
                try {
                    const file = new File([currentState.lastImageBlob], "tenmei_omikuji.png", { type: "image/png" });
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            text: fullText,
                            files: [file]
                        });
                        return;
                    }
                } catch (e) {
                    console.log("Web Share API failed for Bluesky", e);
                }
            }

            // 2. PC/フォールバック: 画像ダウンロード + 投稿画面
            if (currentState.lastImageBlob) {
                const url = URL.createObjectURL(currentState.lastImageBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tenmei_omikuji_${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // Blueskyの投稿画面を開く
            const intent = `https://bsky.app/intent/compose?text=${encodeURIComponent(fullText)}`;
            window.open(intent, '_blank');
        }

        async function shareToMisskey() {
            if(!currentState.lastResult) return;
            const fullText = generateUnifiedShareText(currentState.lastResult);

            // 1. Web Share API (アプリ連携) トライ
            if (navigator.share && currentState.lastImageBlob) {
                try {
                    const file = new File([currentState.lastImageBlob], "tenmei_omikuji.png", { type: "image/png" });
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            text: fullText,
                            files: [file]
                        });
                        return;
                    }
                } catch (e) {
                    console.log("Web Share API failed for Misskey", e);
                }
            }

            // 2. PC/フォールバック: 画像ダウンロード + 投稿画面
            if (currentState.lastImageBlob) {
                const url = URL.createObjectURL(currentState.lastImageBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tenmei_omikuji_${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // Misskey.ioの投稿画面を開く
            const intent = `https://misskey.io/share?text=${encodeURIComponent(fullText)}`;
            window.open(intent, '_blank');
        }

        // --- プロフィール機能 ---
        function handleProfileClick() {
            if(currentState.user) {
                showView('profile');
                document.getElementById('profile-current-username').textContent = currentState.user.username;
                document.getElementById('profile-current-email').textContent = currentState.user.email;
            } else {
                showView('auth');
            }
        }

        async function updateProfile() {
            const newName = document.getElementById('profile-new-username').value;
            const newPass = document.getElementById('profile-new-password').value;
            
            if(!newName && !newPass) return alert("変更内容を入力してください");
            
            showLoading(true);
            try {
                const res = await fetch(`${API_BASE}/api/user/update`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        token: currentState.user.token,
                        email: currentState.user.email,
                        newUsername: newName || undefined,
                        newPassword: newPass || undefined
                    })
                });
                const data = await res.json();
                if(data.success) {
                    alert("更新しました");
                    if(newName) currentState.user.username = newName;
                    localStorage.setItem('omikuji_user', JSON.stringify(currentState.user));
                    handleProfileClick();
                } else {
                    alert("更新失敗: " + data.error);
                }
            } catch(e) { alert("通信エラー"); }
            finally { showLoading(false); }
        }

        async function deleteAccount() {
            if(!confirm("本当にアカウントを削除しますか？\n履歴やお気に入りデータも完全に消去されます。")) return;
            
            showLoading(true);
            try {
                const res = await fetch(`${API_BASE}/api/user/delete`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        token: currentState.user.token,
                        email: currentState.user.email
                    })
                });
                
                // レスポンスがJSONかどうか確認
                const contentType = res.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const data = await res.json();
                    if(data.success) {
                        alert("アカウントを削除しました。ご利用ありがとうございました。");
                        logout();
                    } else {
                        alert("削除失敗: " + (data.message || data.error));
                    }
                } else {
                    // JSONでない場合（サーバーエラーなど）
                    const text = await res.text();
                    console.error("Delete Error:", text);
                    alert("削除処理中にエラーが発生しました。");
                }
            } catch(e) { 
                console.error(e);
                alert("通信エラーが発生しました。"); 
            }
            finally { showLoading(false); }
        }

        // --- 認証系 (新: 選択 -> 入力 -> 認証) ---
        function startAuthFlow(mode) {
            document.getElementById('auth-selection').classList.add('hidden');
            document.getElementById('auth-step-1').classList.remove('hidden');
            
            currentState.authMode = mode;
            
            const loginFields = document.getElementById('form-login-fields');
            const regFields = document.getElementById('form-register-fields');
            const title = document.getElementById('auth-form-title');

            if (mode === 'login') {
                loginFields.classList.remove('hidden');
                regFields.classList.add('hidden');
                title.textContent = 'ログイン';
            } else {
                loginFields.classList.add('hidden');
                regFields.classList.remove('hidden');
                title.textContent = '新規登録';
            }
        }

        function backToAuthSelection() {
            document.getElementById('auth-step-1').classList.add('hidden');
            document.getElementById('auth-selection').classList.remove('hidden');
        }

        async function initiateAuth(mode) {
            const emailInputId = (mode === 'login') ? 'login-email' : 'reg-email';
            const email = document.getElementById(emailInputId).value;
            const username = document.getElementById('reg-username').value;
            const pass = document.getElementById(mode === 'login' ? 'login-password' : 'reg-password').value;

            if(!email || !pass) return alert("メールアドレスとパスワードを入力してください");
            if(mode === 'register' && !username) return alert("ユーザー名を入力してください");

            // コード送信APIを叩く (脆弱性修正: パスワード検証を追加)
            showLoading(true);
            try {
                const res = await fetch(`${API_BASE}/api/auth/send`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        email, 
                        password: pass, // パスワードも送信して事前検証する
                        username: mode === 'register' ? username : undefined,
                        mode: mode 
                    }) 
                });
                const data = await res.json();
                
                if(res.ok && data.success) {
                    // ステップ2へ遷移
                    document.getElementById('auth-step-1').classList.add('hidden');
                    document.getElementById('auth-step-2').classList.remove('hidden');
                    // コード入力欄をクリアしてフォーカス
                    const codeInput = document.getElementById('auth-code-input');
                    codeInput.value = '';
                    codeInput.focus();
                } else {
                    alert(`送信エラー: ${data.error || '不明なエラー'}`);
                }
            } catch(e) { alert("通信エラー"); }
            finally { showLoading(false); }
        }

        function backToAuthStep1() {
            document.getElementById('auth-step-2').classList.add('hidden');
            document.getElementById('auth-step-1').classList.remove('hidden');
        }

        async function finalizeAuth() {
            const code = document.getElementById('auth-code-input').value;
            if(!code || code.length !== 6) return alert("6桁の認証コードを入力してください");

            const mode = currentState.authMode;
            const email = document.getElementById(mode === 'login' ? 'login-email' : 'reg-email').value;
            const pass = document.getElementById(mode === 'login' ? 'login-password' : 'reg-password').value;
            const username = document.getElementById('reg-username').value;

            showLoading(true);
            try {
                const endpoint = (mode === 'login') ? '/api/auth/login' : '/api/auth/register';
                const body = { email, password: pass, code };
                if (mode === 'register') body.username = username;

                const res = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                
                if(res.ok && data.success) {
                    loginSuccess({ email, username: data.username, token: data.token });
                } else {
                    alert(`${mode === 'login' ? 'ログイン' : '登録'}失敗: ${data.message || data.error}`);
                }
            } catch(e) { alert("通信エラー"); }
            finally { showLoading(false); }
        }

        // 旧: sendAuthCode (削除せず互換性のため残すが使用しない)
        async function sendAuthCode() { initiateAuth(currentState.authMode); }
        // 旧: performLogin / performRegister (finalizeAuthに統合)

        // ==========================================
    //  認証状態のUI更新ロジック (復旧版)
    // ==========================================
    function updateAuthUI() {
        const badge = document.getElementById('fav-status-badge');
        const navBtn = document.getElementById('nav-login-btn');
        
        if (currentState.user) {
            // ログイン中：ナビゲーションボタンを会員名に変更
            if (navBtn) {
                navBtn.innerHTML = `<i class="bi bi-person-check-fill text-green-400"></i><span class="nav-text">会員: ${currentState.user.username}</span>`;
            }
            // お気に入りの同期状態バッジを更新
            if (badge) {
                badge.textContent = "クラウド保存済み";
            }
        } else {
            // 未ログイン：デフォルトの状態
            if (navBtn) {
                navBtn.innerHTML = `<i class="bi bi-person-circle"></i><span class="nav-text">ログイン/登録</span>`;
            }
            if (badge) {
                badge.textContent = "端末に保存中";
            }
        }
    }

        // 3. ログイン成功時の処理 (設定を即座にクラウドから取得)
    function loginSuccess(user) {
        currentState.user = user;
        localStorage.setItem('omikuji_user', JSON.stringify(user));
        updateAuthUI();
        loadFavorites(); 
        
        // ログイン直後にサーバーから設定を読み込む（最優先）
        loadLabSettings().then(() => {
            // Lab画面のロック状態を即座に更新するためにView再描画
            if(currentState.view === 'lab') {
                showView('lab');
            }
            alert(`ようこそ、${user.username || user.email} 様！クラウド設定を同期しました。`);
            showView('home');
        });
    }

    // 4. ログアウト処理
    function logout() {
        localStorage.removeItem('omikuji_user');
        // ユーザー情報を消去し、loadLabSettingsを呼んで表示をゲスト用に戻す
        currentState.user = null;
        loadLabSettings().then(() => {
            location.reload();
        });
    }

        // --- 記事詳細 (長文版・更新版) ---
        function openArticle(type, id) {
            const container = document.getElementById('article-detail-content');
            container.innerHTML = '';
            let html = '';
            
            if (type === 'column') {
                if (id === 1) {
                    html = `
                        <div class="article-header"><h2 class="article-title">おみくじの順番（正しい吉凶の順）</h2><div class="article-meta">2026/01/01</div></div>
                        <div class="article-content">
                            <p>初詣や神社参拝の際に引く「おみくじ」。結果に一喜一憂するのも楽しみの一つですが、その「順位」について正しく理解している人は意外と少ないかもしれません。実は神社やお寺によって解釈が異なる場合があるのですが、一般的に広く知られている順位と、当サイト「運勢・天命乃杜」で採用している伝統的な12段階の順位について詳しく解説します。</p>
                            <h3>一般的な7段階の順位</h3>
                            <p>多くの神社で採用されている最もポピュラーな順位は以下の通りです。<br><b>大吉 ＞ 吉 ＞ 中吉 ＞ 小吉 ＞ 末吉 ＞ 凶 ＞ 大凶</b><br>あるいは、「吉」の位置が変わり、<b>大吉 ＞ 中吉 ＞ 小吉 ＞ 吉 ＞ 末吉 ＞ 凶 ＞ 大凶</b> とする場合もあります。「吉」は「大吉」に次ぐ良い運勢とする説と、「小吉」と「末吉」の間の中庸な運勢とする説があるのです。</p>
                            <h3>当サイトの12段階詳細順位</h3>
                            <p>当サイトでは、より細かく運勢を占うため、古来からの伝統に基づいた以下の12段階を採用しています。</p>
                            <ol class="list-decimal list-inside space-y-2 ml-4 mb-6 font-bold">
                                <li>大吉 (だいきち)：最高の運気。感謝を忘れずに。</li>
                                <li>中吉 (ちゅうきち)：大吉に次ぐ良運。</li>
                                <li>小吉 (しょうきち)：ささやかな幸せが続く。</li>
                                <li>吉 (きち)：安定した運気。</li>
                                <li>半吉 (はんきち)：吉と凶の中間。</li>
                                <li>末吉 (すえきち)：末広がりの未来がある。</li>
                                <li>末小吉 (すえしょうきち)：今は耐える時だが希望はある。</li>
                                <li>凶 (きょう)：運気が停滞気味。慎重に。</li>
                                <li>小凶 (しょうきょう)：小さなトラブルに注意。</li>
                                <li>半凶 (はんきょう)：半分は凶だが半分は吉に転じる可能性。</li>
                                <li>末凶 (すえきょう)：終わりの凶、つまり次は吉へ向かう。</li>
                                <li>大凶 (だいきょう)：最も警戒すべき運気。しかしこれ以上落ちない。</li>
                            </ol>
                            <p>しかし、最も重要なのは順位そのものではありません。おみくじの本質は、そこに書かれている「神様からの和歌や助言」にあります。大吉であっても戒めの言葉があれば気を引き締め、大凶であっても励ましの言葉があれば希望を持つことが大切です。結果に一喜一憂せず、日々の行動指針として活用してください。</p>
                        </div>
                    `;
                } else if (id === 2) {
                    html = `
                        <div class="article-header"><h2 class="article-title">悪い結果が出ても実は大丈夫？「凶」の正しい扱い方</h2><div class="article-meta">2026/01/01</div></div>
                        <div class="article-content">
                            <p>おみくじを引いて「凶」や「大凶」が出ると、誰しも気分が落ち込むものです。「今年は良いことがないのではないか」「不吉なことが起こる前兆ではないか」と不安になるかもしれません。しかし、古来より「凶」は必ずしも忌むべきものとはされてきませんでした。むしろ、考え方によっては幸運への入り口とも言えるのです。</p>
                            <h3>「凶」は運気の底、これからは上がるのみ</h3>
                            <p>陰陽道などの東洋思想では、物事は極まれば反転すると考えます。「大吉」は今が頂点であり、これからは下り坂になる可能性があるため、むしろ慎重な行動が求められます。慢心すれば足元をすくわれる、という戒めが含まれていることが多いのです。</p>
                            <p>逆に「凶」は、今が運気の底であり、これからは上昇する一方であることを示唆しています。「禍を転じて福となす」という言葉通り、今の困難を乗り越えることで、より大きな幸運をつかむチャンスなのです。凶を引いたということは、これ以上悪くなることはない、つまり「伸びしろしかない」状態であると前向きに捉えましょう。</p>
                            <h3>結ぶか、持ち帰るか？</h3>
                            <p>悪い結果が出た場合、神社の境内にある「結び所」に結んで帰る風習が一般的です。これには「神様と縁を結ぶ」「悪い運気を神様に預けて浄化してもらう」という意味があります。利き手ではない手で結ぶことで、「困難な行いを達成した」として吉に転じさせるという修行的な意味合いも含まれています。</p>
                            <p>一方で、「戒めとして財布に入れて持ち歩く」という考え方もあります。自分への警告として時々読み返すことで、慎重な行動を心がけ、災いを未然に防ぐことができるからです。ボロボロになったら神社にお焚き上げをお願いすれば良いのです。</p>
                            <p>当サイトでは、引いたおみくじの結果は自動的に「おみくじの轍」に記録されます。これがデジタルの「結び所」です。悪い結果が出ても、ここに結んでいくことで運気は好転するでしょう。</p>
                        </div>
                    `;
                } else if (id === 3) {
                    html = `<div class="article-header"><h2 class="article-title">神社での正しい参拝マナー</h2><div class="article-meta">2025/12/30</div></div><div class="article-content"><p>神社は神様のお住まいです。初詣や日常の参拝で失礼のないよう、基本的な参拝マナーをおさらいしましょう。作法を知ることで、心も整い、より深い感謝の気持ちを伝えることができます。</p><h3>1. 鳥居をくぐる時</h3><p>鳥居は俗界と神域を分ける結界です。くぐる前には衣服を整え、軽く一礼（一揖）をし、帽子などは取ります。参道の中央（正中）は神様の通り道なので、避けて端を歩くのがマナーです。帰る際も、鳥居を出てから振り返り一礼するのが美しい作法です。</p><h3>2. 手水舎での清め方</h3><p>参拝の前に、手水舎（てみずや）で身の穢れを落とします。<br>1. 右手で柄杓を持ち、水を汲んで左手を清める。<br>2. 左手に持ち替え、右手を清める。<br>3. 再び右手に持ち、左手で水を受けて口をすすぐ（柄杓に直接口をつけない）。<br>4. 左手を再度清め、最後に柄杓を立てて残った水で柄を洗い流す。<br>これらを一杯の水で行うのが理想的です。</p><h3>3. 拝礼（二礼二拍手一礼）</h3><p>お賽銭を入れた後、鈴を鳴らし、姿勢を正します。<br>1. 深く二回お辞儀をする（二礼）。<br>2. 胸の前で両手を合わせ、右手を少し下にずらして二回拍手を打つ（二拍手）。音を立てることで邪気を払います。<br>3. 指先を揃えて祈りを捧げる。感謝の気持ちを述べ、その後に願い事を。<br>4. 最後にもう一度深くお辞儀をする（一礼）。</p><p>※出雲大社など、一部の神社では「四拍手」など作法が異なる場合がありますので、現地の案内に従ってください。</p></div>`;
                } else if (id === 4) {
                    html = `<div class="article-header"><h2 class="article-title">「失せ物」の本当の意味</h2><div class="article-meta">2025/12/28</div></div><div class="article-content"><p>おみくじの項目にある「失せ物（うせもの）」。これは単に「落とし物」や「無くした財布」のことだけを指すのではありません。人生において私たちが失ってしまうものは、物理的なモノだけではないからです。</p><h3>形あるもの、形なきもの</h3><p>失せ物には、物理的な物品だけでなく、「失った信頼」「忘れていた初心」「疎遠になった友人」「失恋した相手」「やる気」「健康」など、形のないものも含まれます。今あなたが心の中で「失ってしまった」と感じている欠落感、それこそが「失せ物」の正体かもしれません。</p><h3>言葉の意味</h3><ul class="list-disc ml-5 mb-4"><li><b>「出ず（いでず）」</b>：残念ながら戻ってこない可能性が高いです。諦めて新しいものを探すか、執着を手放すべき時です.過去にとらわれず前へ進めというメッセージです。</li><li><b>「出る」</b>：見つかります。焦らず探しましょう。</li><li><b>「高いところより出る」</b>：棚の上や、普段見ない高い場所、あるいは目上の人からの連絡で見つかるかもしれません。</li><li><b>「女（男）の知る事あり」</b>：その性別の知人が何か知っているか、持っている可能性があります。</li></ul><p>「失せ物」の欄を見る時は、今自分が「何を探しているのか」「何を失ってしまったと感じているのか」を深く問い直してみると、表面的な意味以上の深いメッセージを受け取れるかもしれません。</p></div>`;
                } else if (id === 5) {
                    html = `<div class="article-header"><h2 class="article-title">「待ち人」は恋愛だけじゃない</h2><div class="article-meta">2025/12/25</div></div><div class="article-content"><p>「待ち人来ず」と出ると、恋人ができないのかとガッカリする人が多いですが、これは大きな誤解です。おみくじにおける「待ち人」の意味はもっと広く、人生全般に関わるものです。</p><h3>人生を導くキーパーソン</h3><p>おみくじにおける「待ち人」とは、「あなたの人生に良い影響を与えてくれる人」「運命を切り開くきっかけとなる人」全般を指します。それは将来の恋人や結婚相手かもしれませんし、ビジネスパートナー、あるいは人生の師となる先生、一生の親友、もしかすると赤ちゃん（妊娠）のことかもしれません。あなたを待っている人、あるいはあなたが待つべき運命の人、すべてを含みます。</p><h3>「来ず」の意味</h3><p>「来ず」とあっても、一生現れないこともあります。「今はまだその時ではない」「自分から動きなさい」というメッセージであることが多いのです。「音信（たより）あり」とあれば、遠くから連絡が来るでしょう。「触り（さわり）あり」なら、何らかの邪魔が入るかもしれません。</p><p>待ち人は、じっと待っているだけでは現れないこともあります。自分を磨き、行動範囲を広げることで、巡り会う確率はぐっと高まります。焦らず、その時を待ちつつ、自分自身を高める努力を続けましょう。</p></div>`;
                }
            } else if (type === 'news') {
                if (id === 1) html = `<div class="article-header"><h2 class="article-title">あけましておめでとうごさいます</h2><div class="article-meta">2026/01/01</div></div><div class="article-content"><p>謹んで新年のご祝詞を申し上げます。</p><p>旧年中はひとかたならぬご厚情を賜り、誠にありがとうございました。<br>本年も皆様に幸多き年となりますよう、天命乃杜運営一同、心よりお祈り申し上げます。</p><p>新しい年が始まり、皆様それぞれに新たな目標や願いをお持ちのことと存じます。当サイトのおみくじが、皆様の迷いを晴らし、一歩を踏み出すための道標となれば幸いです。本年も変わらぬご愛顧のほど、よろしくお願い申し上げます。</p></div>`;
                else if (id === 2) html = `<div class="article-header"><h2 class="article-title">「運勢・天命乃杜」を公開いたしました。</h2><div class="article-meta">2026/01/02</div></div><div class="article-content"><p>平素より格別のご高配を賜り、厚く御礼申し上げます。</p><p>この度、誰でも気軽に、かつ本格的な運勢占いを楽しめるWebサイト「運勢・天命乃杜（てんめいのもり）」を正式に公開いたしました。</p><p>当サイトでは、伝統的なおみくじの要素に加え、西洋占星術と血液型診断を組み合わせた独自のアルゴリズムによる「日替わり運勢ランキング」を提供しております。また、会員登録（無料）を行っていただくことで、ご自身の運勢履歴を保存したり、全体の統計データに参加したりすることが可能です。今後もコンテンツの拡充や機能改善に努めてまいりますので、末永くご愛顧いただけますようお願い申し上げます。</p></div>`;
                else if (id === 3) html = `<div class="article-header"><h2 class="article-title">プレオープンのお知らせ</h2><div class="article-meta">2025/12/25</div></div><div class="article-content"><p>本日より、一部機能を制限した状態でのプレオープンを開始いたしました。</p><p>現在ご利用いただけるのは、「おみくじ機能」および「12星座占い（β版）」です。正式リリース時には、履歴保存機能や会員システムが追加される予定です。</p></div>`;
                else if (id === 4) html = `<div class="article-header"><h2 class="article-title">サーバーメンテナンス完了</h2><div class="article-meta">2025/12/20</div></div><div class="article-content"><p>本日14:00より実施しておりましたサーバーメンテナンスは、予定通り18:00に完了いたしました。</p><p>今回のメンテナンスにより、データベースの応答速度が向上しております。ご協力ありがとうございました。</p></div>`;
                else if (id === 5) html = `<div class="article-header"><h2 class="article-title">サイト開設準備室より</h2><div class="article-meta">2025/12/10</div></div><div class="article-content"><p>「運勢・天命乃杜」の開設に向け、現在鋭意開発中です。</p><p>皆様に愛されるサイトを目指し、デザインの調整や占いロジックの検証を行っております。公開まで今しばらくお待ちください。</p></div>`;
                else if (id === 6) html = `<div class="article-header"><h2 class="article-title">新機能「TENMEI Labs」を公開いたしました。</h2><div class="article-meta">2026/01/03 17:01</div></div><div class="article-content"><p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p><p>この度、当サイトの実験的な試みとして、新機能<strong>「TENMEI Labs（天命ラボ）」</strong>を公開いたしました。</p><p>Labsでは、開発中の新機能や、サイトの雰囲気を大きく変える特殊なカスタマイズ設定をいち早く体験いただくことが可能です。現在は「迎春・雅モード」や「神速の祈り」など、複数の実験的な機能を公開しております。</p><p>本機能は、会員登録（ログイン）を行っていただくことでご利用いただけます。サイドバーのフラスコアイコンより、ぜひ未知の天命体験をお楽しみください。</p><p>今後も「杜」の技術革新に努めてまいります。何卒よろしくお願い申し上げます。</p></div>`;
                else if (id === 7) html = `<div class="article-header"><h2 class="article-title">【重要】認証システムに関する不具合の修正とお詫び</h2><div class="article-meta">2026/01/04 08:00</div></div><div class="article-content"><p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。2026年1月3日頃より発生しておりました、ログイン認証システムに関する重大な不具合について、修正が完了いたしましたことをご報告申し上げます。</p><h3>修正された不具合の内容</h3><p>1. ログイン時、パスワードが一致しない状態でも認証コードが送信される問題<br>2. パスワード不一致のまま認証を完了させると、意図せずアカウントが削除される問題<br>3. 未登録のメールアドレスに対しても、ログイン認証コードが送信される問題</p><h3>原因と経緯</h3><p>本不具合は、昨日（1月3日）のシステム更新の際、運営者によるコード編集上の不注意（人為的ミス）により発生いたしました。セキュリティに関わる重要な機能において、ユーザーの皆様にご不安とご不便をおかけしましたこと、深くお詫び申し上げます。現在はバリデーションロジックを全面的に見直し、正常な挙動に復旧しております。今後、再発防止に向けてコード管理の徹底に努めてまいります。</p></div>`;
                else if (id === 8) html = `<div class="article-header"><h2 class="article-title text-red-600">【重要】「全国・土地の運気予報」の開発中止に関するお知らせ</h2><div class="article-meta">2026/01/05 14:30</div></div><div class="article-content"><p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p><p>以前より「TENMEI Labs」の追加機能として検討しておりました「全国・土地の運気予報（マップ機能）」につきまして、検討の結果、開発を完全に中止することといたしました。なお、本機能につきましては別の形での実装や代替機能の提供予定もございません。</p><h3>中止の理由</h3><p>外部地図ライブラリの導入に伴うシステムの深刻な不安定化、およびプログラム上の修復困難なエラーが複数確認されました。無理な実装を強行することは、現在安定して稼働している他の機能（おみくじやLabs等）の動作を損なう致命的なリスクがあると判断いたしました。</p><h3>今後の展望</h3><p>期待をお寄せいただいた皆様には誠に申し訳ございませんが、今後は新たな地図機能の模索は行わず、既存機能の保守と品質向上にのみ注力してまいります。何卒ご理解を賜りますようお願い申し上げます。</p></div>`;
            }

            container.innerHTML = html;
            showView('article-detail');
        }

        // --- お気に入り、ランキングなど既存機能 (省略なし) ---
        async function loadFavorites() {
            const badge = document.getElementById('fav-status-badge');
            if(currentState.user) {
                if(badge) badge.textContent = "同期中...";
                try {
                    const res = await fetch(`${API_BASE}/api/favorites?email=${encodeURIComponent(currentState.user.email)}&token=${encodeURIComponent(currentState.user.token)}`);
                    if(res.ok) {
                        const data = await res.json();
                        favoriteList = data.favorites || [];
                        if(badge) badge.textContent = "クラウド保存済み";
                    }
                } catch(e) { console.error(e); }
            } else {
                const stored = localStorage.getItem('fortuneFavorites');
                if (stored) favoriteList = JSON.parse(stored);
                if(badge) badge.textContent = "端末に保存中";
            }
            renderFavorites();
        }

        // 12星座ロジック
        function initZodiacSystem() {
            const dateStr = getJSTDateString();
            const dateParts = dateStr.split('-');
            document.getElementById('current-date-display').innerHTML = `${dateParts[0]}年${dateParts[1]}月${dateParts[2]}日 <span class="text-sm font-normal ml-2 text-gray-500 dark:text-gray-400">(毎日 0:00 更新)</span>`;
            generateDailyRanking(dateStr);
            renderRanking();
        }
        
        // --- 日本時間 (JST) の日付文字列取得 (修正版) ---
        function getJSTDateString() {
            return new Date().toLocaleDateString("ja-JP", {
                timeZone: "Asia/Tokyo",
                year: "numeric",
                month: "2-digit",
                day: "2-digit"
            }).replaceAll('/', '-');
        }
        
        function getFutureDateString(baseDateStr, daysToAdd) {
            const date = new Date(baseDateStr);
            date.setDate(date.getDate() + daysToAdd);
            return date.toISOString().split('T')[0];
        }
        class SeededRandom {
            constructor(seed) {
                this.seed = 0;
                for (let i = 0; i < seed.length; i++) this.seed = (this.seed * 31 + seed.charCodeAt(i)) >>> 0;
            }
            next() {
                this.seed ^= this.seed << 13;
                this.seed ^= this.seed >> 17;
                this.seed ^= this.seed << 5;
                let x = (this.seed < 0 ? ~this.seed + 1 : this.seed);
                return (x % 100000) / 100000;
            }
        }
       // ==========================================
    //  12星座×血液型占い：データ定義
    // ==========================================
    const zodiacSigns = [
        { id: "aries", name: "牡羊座", icon: "♈" }, { id: "taurus", name: "牡牛座", icon: "♉" }, 
        { id: "gemini", name: "双子座", icon: "♊" }, { id: "cancer", name: "蟹座", icon: "♋" }, 
        { id: "leo", name: "獅子座", icon: "♌" }, { id: "virgo", name: "乙女座", icon: "♍" },
        { id: "libra", name: "天秤座", icon: "♎" }, { id: "scorpio", name: "蠍座", icon: "♏" }, 
        { id: "sagittarius", name: "射手座", icon: "♐" }, { id: "capricorn", name: "山羊座", icon: "♑" }, 
        { id: "aquarius", name: "水瓶座", icon: "♒" }, { id: "pisces", name: "魚座", icon: "♓" }
    ];
    const bloodTypes = ["A", "B", "O", "AB"];

    const zodiacItemsList = [
        "時計", "本", "水", "銀", "植物", "手帳", "香り", "靴", "音楽", "飴",
        "鏡", "ハンカチ", "帽子", "鞄", "ペン", "写真", "石", "貝殻", "鍵", "鈴",
        "リボン", "指輪", "お茶", "果物", "野菜", "パン", "手紙", "切手", "地図", "コンパス",
        "ランプ", "キャンドル", "クッション", "マグカップ", "グラス", "皿", "箸", "スプーン", "フォーク", "ナイフ",
        "石鹸", "タオル", "入浴剤", "お香", "風鈴", "扇子", "うちわ", "手袋", "マフラー", "傘"
    ];

    const zodiacColorsList = [
        "赤", "青", "緑", "黄", "白", "黒", "金", "銀", "桃", "紺",
        "橙", "紫", "茶", "灰", "水色", "黄緑", "深紅", "群青", "琥珀", "翡翠",
        "瑠璃", "真紅", "漆黒", "純白", "桜色", "藤色", "山吹色", "若草色", "空色", "茜色",
        "黄金", "白銀", "銅", "パール", "ベージュ", "クリーム", "ワインレッド", "オリーブ", "ミント", "ラベンダー",
        "サーモン", "コーラル", "ターコイズ", "インディゴ", "マゼンタ", "シアン", "ライム", "レモン", "チャコール", "カーキ"
    ];

    // --- 超長文・状況別詳細コメントデータベース ---
    const luckComments = {
        // 【総合運：導入文】順位が高いほどポジティブ、低いほど戒め
        mainIntro: {
            S: [
                "今日のあなたは、宇宙のすべての理が味方をしているかのような、圧倒的な強運の渦中にあります。星々の配置は完璧な調和を見せ、あなたの放つオーラは周囲の人々をも照らすほどに輝きを増しています。迷いや不安といった負のエネルギーは今日のあなたには一切届きません。信じられないような幸運が、向こうから歩み寄ってくるのを感じるでしょう。",
                "今、天空の星々はあなたに最大の祝福を授けています。これまでに積み重ねてきた努力が、最高の形で結実する瞬間が近づいています。まるで霧が晴れるように進むべき道が明確になり、自信に満ち溢れた足取りで未来を切り拓いていくことができるでしょう。今日は、あなたの人生における重要な転換点となる可能性を秘めた、奇跡的な一日です。"
            ],
            A: [
                "全体的な運気は非常に好調な波に乗っています。心地よい追い風があなたの背中を押し、滞っていた物事がスムーズに動き出すでしょう。周囲との協力関係も良好で、あなたが動くことでプラスの連鎖が生まれます。直感も冴え渡っているため、今日感じた『なんとなく良い予感』は、高い確率で的中することになるでしょう。",
                "今日のあなたは、非常にバランスの取れた幸運に恵まれています。心身ともにエネルギーが充満しており、何事にも前向きに取り組める活力が備わっています。星々のサポートを十分に受けられる配置にあるため、積極的に行動すればするほど、得られる果実は大きくなります。素晴らしい収穫の一日となるでしょう。"
            ],
            B: [
                "今日の運勢は、穏やかで安定した凪のような一日を指し示しています。大きな波乱はありませんが、それは平穏という名の幸運に守られている証でもあります。劇的な変化を求めるよりも、日常の中にある小さな幸せや気づきを大切にすることで、運気の底上げができる時期です。足元を固めるには最適な、地に足の着いた運気です。",
                "可もなく不可もなく、といった落ち着いた運気ですが、あなたの心の持ちよう次第で吉へと転じる柔軟なエネルギーが流れています。周囲の喧騒に惑わされず、自分のペースを守ることで、思わぬところからチャンスの芽が見つかるかもしれません。今日は「準備の日」と心得て、じっくりと自分を整えることが推奨されます。"
            ],
            C: [
                "今日のあなたは、少し慎重さが求められる星回りの中にいます。運気の流れが一時的に停滞しており、物事が思うように進まないもどかしさを感じる場面があるかもしれません。しかし、これは不運の宣告ではなく、天があなたに「休息と内省」を促しているサインです。今は無理に抗わず、静かに時を待つことが最善の策となります。",
                "全体的にエネルギーの出力が弱まっており、些細なことで疲れを感じたり、判断力が鈍りやすい傾向にあります。周囲の期待に応えようと自分を追い込むのは避けてください。今は「忍耐」の時であり、嵐が過ぎ去るのを待つことで、次に訪れる大きな運気の波に備えることができます。今日は自分自身を一番に労ってください。"
            ]
        },

        // 【恋愛・金運・仕事：詳細文】カテゴリー順位(1〜48位)に完全連動
        loveDetail: {
            high: "情愛の運気は極めて高く、運命の糸が太く結ばれる暗示があります。言葉にせずとも心が通じ合うような、魂の共鳴を感じる瞬間があるでしょう。アプローチや告白にも最適な、愛の女神の加護がある時です。",
            mid: "愛の気流は安定しています。特別な刺激はなくとも、信頼関係が深まる丁寧なやり取りが、将来の大きな実りへと繋がります。今は派手な行動より、相手の話に耳を傾ける優しさが運気を安定させます。",
            low: "今は恋愛に関して動くよりも、自分自身の魅力を磨く内省の時間とすべきです。焦って答えを出そうとすると、ボタンを掛け違える恐れがあります。一人の時間を充実させることが、結果的に次なる良縁を呼び寄せます。"
        },
        moneyDetail: {
            high: "豊かさのエネルギーが力強く循環しています。投資や買い物、あるいは将来への蓄えにおいて、非常に鋭い判断が下せる時です。思わぬ臨時収入や、価値あるものとの出会いが、あなたの財産を豊かにするでしょう。",
            mid: "収支のバランスが取れた堅実な運気です。無駄を省き、本当に必要なものに投資することで、土地の神様からの加護が得られます。派手な勝負は避け、今の資産を守りつつ育てる意識が吉と出ます。",
            low: "財運は一時的に閉じています。衝動的な支出や、うまい儲け話には十分な注意が必要です。財布の紐を固く締め、守りに徹することで難を逃れます。今は「持たざる贅沢」を楽しむ時期と心得ましょう。"
        },
        workDetail: {
            high: "知性と創造性が極限まで高まっています。あなたの発言や取り組みが周囲を動かし、不可能と思われた難題をも打破する突破口となるでしょう。評価は急上昇し、重要な役割や目標達成への大きな一歩を踏み出す、輝かしい起点となります。",
            mid: "基本に忠実であり、地道な努力を重ねることで道が開けます。派手な動きよりも、丁寧な確認作業や試験・業務への準備を徹底することが、最終的な成功への確実な近道となります。周囲との協調を大切にしてください。",
            low: "集中力が散漫になりやすく、細かなミスや見落としが重なりやすい星回りです。一人で抱え込まず、信頼できる仲間に早めに相談することで、大きなトラブルを未然に防げます。今日は無理をせず、早めの休息で英気を養いましょう。"
        },

        // 【グラフ横の短い説明】※ここでエラーが出ていたので復活させました
        loveShorts: {
            S: ["運命の出会いが期待できる最高の日", "パートナーとの愛が劇的に深まる時", "アプローチするなら今が絶好機"],
            A: ["穏やかで幸せな時間を過ごせそう", "素直な気持ちが相手に届く日", "良い出会いの兆しがあります"],
            B: ["現状維持を心がけると吉", "相手の話をよく聞くことが大切", "焦らずゆっくり関係を育んで"],
            C: ["誤解を招きやすいので言動に注意", "感情的な衝突に気をつけてください", "一人の時間を大切にするのが無難"]
        },
        moneyShorts: {
            S: ["臨時収入や昇給のチャンス到来", "投資や宝くじに強いツキあり", "欲しかったものがお得に手に入る"],
            A: ["賢い買い物ができそうな日", "将来のための自己投資は吉", "お金回りが良くスムーズな一日"],
            B: ["収支のバランスを見直すと良い", "計画的な利用を心がけて", "衝動買いは控えたほうが無難"],
            C: ["財布の紐を固く締めるべき日", "詐欺や甘い話には要注意です", "無駄遣いで後悔する可能性大"]
        },
        workShorts: {
            S: ["大きな成果を上げ高い評価を得る日", "リーダーシップを発揮し目標を達成", "新しいアイデアが次々採用されそう"],
            A: ["チームワークや共同作業が成功の鍵", "効率よく課題やタスクを消化できる", "周囲からの信頼が高まる予感です"],
            B: ["基本に忠実に取り組むと吉です", "報告・連絡・相談を大切にすべき時", "無理せず自分のペースで進めて"],
            C: ["ケアレスミスに十分注意して下さい", "確認作業を怠らないようにすべき日", "無理なスケジュールは避けて正解"]
        },

        // 【総合運：結びの文章】
        mainConclusion: {
            S: [
                "総じて、今日は何をやってもうまくいく「無敵」の一日です。感謝の心を忘れずに、この貴重な幸運を存分に味わってください。あなたの決断はすべて正解へと繋がっています。",
                "この素晴らしい運気を活かし、新しい挑戦の扉を叩いてみてください。宇宙はあなたの勇気を称え、必ずや輝かしい未来を用意してくれることでしょう。最高の吉日です。"
            ],
            A: [
                "ポジティブな姿勢を維持することで、運気はさらに盤石なものとなります。笑顔を絶やさず、周囲への感謝を伝えることで、この幸運は長く続いていくことでしょう。",
                "自信を持って一歩前へ踏み出してください。今日のあなたには、それを成し遂げる十分な力と加護が備わっています。今日という一日を大切に、充実させてください。"
            ],
            B: [
                "無理をせず、自分のペースを守ることが開運の鍵となります。リラックスできる時間を意識的に持ち、明日のためにエネルギーを蓄えてください。焦りは禁物です。",
                "着実に進むことが、最終的な成功への一番の近道です。派手な結果は出なくとも、今日のあなたの努力は必ず天に届いています。地道な歩みを止めることなく進みましょう。"
            ],
            C: [
                "今日は「自分を守る日」と割り切り、心穏やかに過ごす工夫をしてください。この経験が、あなたの魂をより深く、強く成長させてくれるはずです。明けない夜はありません。",
                "落ち込む必要はありません。運気は常に巡るものです。今日は自分自身を見つめ直す良い機会と捉え、ゆったりとした心で一日をやり過ごしましょう。明日は吉報が届きます。"
            ]
        }
    };

    // ==========================================
    //  12星座×血液型占い：計算ロジック
    // ==========================================

    function getRank(score) {
        if (score >= 90) return 'S';
        if (score >= 75) return 'A';
        if (score >= 50) return 'B';
        return 'C';
    }

    function calculateScoresForDate(dateStr) {
        let results = [];
        zodiacSigns.forEach(sign => {
            bloodTypes.forEach(blood => {
                const seed = `${dateStr}_${sign.id}_${blood}`;
                const rng = new SeededRandom(seed);
                const loveScore = Math.floor(rng.next() * 52) + 49;
                const moneyScore = Math.floor(rng.next() * 52) + 49;
                const workScore = Math.floor(rng.next() * 52) + 49;
                const totalScore = Math.floor((loveScore + moneyScore + workScore) / 3);
                results.push({
                    sign: sign, blood: blood, totalScore: totalScore,
                    love: { score: loveScore }, money: { score: moneyScore }, work: { score: workScore }
                });
            });
        });
        return results;
    }

    function initZodiacSystem() {
        const dateStr = getJSTDateString();
        const dateParts = dateStr.split('-');
        const display = document.getElementById('current-date-display');
        if (display) {
            display.innerHTML = `${dateParts[0]}年${dateParts[1]}月${dateParts[2]}日 <span class="text-sm font-normal ml-2 text-gray-500 dark:text-gray-400">(毎日 0:00 更新)</span>`;
        }
        generateDailyRanking(dateStr);
        renderRanking();
    }

    function generateDailyRanking(dateStr) {
        let scoredData = calculateScoresForDate(dateStr);
        const decoRng = new SeededRandom(dateStr + "_decoration");
        
        scoredData.sort((a, b) => b.totalScore - a.totalScore);
        scoredData.forEach((d, i) => { 
            d.rank = i + 1;
            const totalRank = getRank(d.totalScore);
            
            // 項目別順位を計算（1〜48位）
            d.love.rank = [...scoredData].sort((a,b) => b.love.score - a.love.score).findIndex(x => x === d) + 1;
            d.money.rank = [...scoredData].sort((a,b) => b.money.score - a.money.score).findIndex(x => x === d) + 1;
            d.work.rank = [...scoredData].sort((a,b) => b.work.score - a.work.score).findIndex(x => x === d) + 1;

            const lR = getRank(d.love.score);
            const mR = getRank(d.money.score);
            const wR = getRank(d.work.score);

            // 短い説明文の抽出（undefined防止）
            d.love.desc = luckComments.loveShorts[lR][Math.floor(decoRng.next() * luckComments.loveShorts[lR].length)];
            d.money.desc = luckComments.moneyShorts[mR][Math.floor(decoRng.next() * luckComments.moneyShorts[mR].length)];
            d.work.desc = luckComments.workShorts[wR][Math.floor(decoRng.next() * luckComments.workShorts[wR].length)];

            // --- 超長文の生成ロジック ---
            const intro = luckComments.mainIntro[totalRank][Math.floor(decoRng.next() * luckComments.mainIntro[totalRank].length)];
            
            const getDetailText = (rank, type) => {
                if (rank <= 10) return luckComments[`${type}Detail`].high;
                if (rank <= 38) return luckComments[`${type}Detail`].mid;
                return luckComments[`${type}Detail`].low;
            };

            const lovePara = `【恋愛運：第${d.love.rank}位】${getDetailText(d.love.rank, 'love')}`;
            const moneyPara = `【金運：第${d.money.rank}位】${getDetailText(d.money.rank, 'money')}`;
            const workPara = `【仕事・勉強運：第${d.work.rank}位】${getDetailText(d.work.rank, 'work')}`;
            
            const conclusion = luckComments.mainConclusion[totalRank][Math.floor(decoRng.next() * luckComments.mainConclusion[totalRank].length)];

            // 全てを繋げて超長文にする
            d.longDesc = `${intro}<br><br>${lovePara}<br><br>${moneyPara}<br><br>${workPara}<br><br>${conclusion}`;

            d.luckyNum = Math.floor(decoRng.next() * 9) + 1;
            d.item = zodiacItemsList[Math.floor(decoRng.next() * zodiacItemsList.length)];
            d.color = zodiacColorsList[Math.floor(decoRng.next() * zodiacColorsList.length)];
            d.calendar = calculateFutureLuck(d.sign.id, d.blood, dateStr);
        });

        dailyRanking = scoredData;
    }

    function calculateFutureLuck(signId, bloodType, baseDateStr) {
        let calendarDays = [];
        for(let i=0; i<30; i++) {
            const targetDate = getFutureDateString(baseDateStr, i);
            const dayOfMonth = new Date(targetDate).getDate();
            const dayAllData = calculateScoresForDate(targetDate);
            const me = dayAllData.find(d => d.sign.id === signId && d.blood === bloodType);
            const maxTotal = Math.max(...dayAllData.map(d => d.totalScore));
            const maxLove = Math.max(...dayAllData.map(d => d.love.score));
            const maxMoney = Math.max(...dayAllData.map(d => d.money.score));
            const maxWork = Math.max(...dayAllData.map(d => d.work.score));

            let marks = [];
            if (me.totalScore === maxTotal) marks.push('<i class="bi bi-star-fill text-yellow-500"></i>');
            if (me.love.score === maxLove) marks.push('<i class="bi bi-heart-fill text-pink-500"></i>');
            if (me.money.score === maxMoney) marks.push('<i class="bi bi-currency-yen text-yellow-600"></i>');
            if (me.work.score === maxWork) marks.push('<i class="bi bi-pencil-fill text-blue-500"></i>');
            calendarDays.push({ day: dayOfMonth, marks: marks });
        }
        return calendarDays;
    }

    function createCardHTML(data) {
        const isFav = favoriteList.some(f => f.sign === data.sign.id && f.blood === data.blood);
        const rankClass = data.rank <= 3 ? `rank-${data.rank}` : 'rank-other';
        const borderClass = data.rank <= 3 ? 'border-l-4 border-yellow-400' : '';
        const getBarColor = (score) => score > 80 ? '#ef4444' : (score > 50 ? '#eab308' : '#3b82f6');
        
        return `
            <div class="ranking-card ${borderClass} themed-card">
                <button class="fav-btn ${isFav ? 'active' : ''}" onclick="toggleFavorite('${data.sign.id}', '${data.blood}')">
                    <i class="bi bi-star${isFav ? '-fill' : ''}"></i>
                </button>
                <div class="flex items-start">
                    <div class="rank-badge-lg ${rankClass}">${data.rank}</div>
                    <div class="ml-4 flex-grow">
                        <div class="flex items-center flex-wrap gap-2 mb-1">
                            <span class="text-3xl">${data.sign.icon}</span>
                            <span class="font-bold text-xl" style="color:var(--text-main);">${data.sign.name}</span>
                            <span class="bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded text-sm font-bold" style="color:var(--text-main);">${data.blood}型</span>
                        </div>
                        <div class="flex items-center gap-4 text-sm mt-1 mb-2" style="color: var(--text-sub);">
                            <span><i class="bi bi-hash"></i> ラッキーナンバー: <strong>${data.luckyNum}</strong></span>
                            <span><i class="bi bi-bar-chart-fill"></i> 総合: <strong>${data.totalScore}点</strong></span>
                        </div>
                        <p class="text-sm leading-relaxed mb-4 text-justify" style="color: var(--text-main); line-height:1.8;">${data.longDesc}</p>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs mb-3" style="color: var(--text-sub);">
                            <div><i class="bi bi-stars text-yellow-500"></i> ラッキーアイテム: ${data.item}</div>
                            <div><i class="bi bi-palette text-pink-500"></i> ラッキーカラー: ${data.color}</div>
                        </div>
                    </div>
                </div>
                <div class="param-grid">
                    <div class="param-item">
                        <div class="param-label"><i class="bi bi-heart-fill text-pink-500"></i> 恋愛 (${data.love.rank}位)</div>
                        <div class="param-score-text">${data.love.score}点</div>
                        <div class="param-value text-xs">${data.love.desc}</div>
                        <div class="score-bar-bg"><div class="score-bar-fill" style="width:${data.love.score}%; background:${getBarColor(data.love.score)};"></div></div>
                    </div>
                    <div class="param-item">
                        <div class="param-label"><i class="bi bi-currency-yen text-yellow-500"></i> 金運 (${data.money.rank}位)</div>
                        <div class="param-score-text">${data.money.score}点</div>
                        <div class="param-value text-xs">${data.money.desc}</div>
                        <div class="score-bar-bg"><div class="score-bar-fill" style="width:${data.money.score}%; background:${getBarColor(data.money.score)};"></div></div>
                    </div>
                    <div class="param-item">
                        <!-- ▼「仕事」から「仕事/勉強」に修正 -->
                        <div class="param-label"><i class="bi bi-book-fill text-blue-500"></i> 仕事/勉強 (${data.work.rank}位)</div>
                        <div class="param-score-text">${data.work.score}点</div>
                        <div class="param-value text-xs">${data.work.desc}</div>
                        <div class="score-bar-bg"><div class="score-bar-fill" style="width:${data.work.score}%; background:${getBarColor(data.work.score)};"></div></div>
                    </div>
                </div>
                <div class="calendar-wrapper">
                    <p class="text-xs text-center mb-1 font-bold" style="color:var(--text-main);">向こう30日間のラッキーデー</p>
                    <div class="calendar-grid">
                        ${data.calendar.map(d => `<div class="calendar-cell"><span class="cal-date">${d.day}</span><span class="cal-mark">${d.marks.join('')}</span></div>`).join('')}
                    </div>
                    <div class="calendar-legend">
                        <div class="legend-item"><i class="bi bi-star-fill text-yellow-500"></i>総合1位</div>
                        <div class="legend-item"><i class="bi bi-heart-fill text-pink-500"></i>恋愛1位</div>
                        <div class="legend-item"><i class="bi bi-currency-yen text-yellow-600"></i>金運1位</div>
                        <!-- ▼「勉強1位」から「仕事/勉強1位」に修正 -->
                        <div class="legend-item"><i class="bi bi-pencil-fill text-blue-500"></i>仕事/勉強1位</div>
                    </div>
                </div>
            </div>
        `;
    }

    function toggleFavorite(signId, bloodType) {
        const existsIndex = favoriteList.findIndex(f => f.sign === signId && f.blood === bloodType);
        if (existsIndex >= 0) { favoriteList.splice(existsIndex, 1); } 
        else { if (favoriteList.length >= 5) return alert('最大5つまで'); favoriteList.push({ sign: signId, blood: bloodType }); }
        if(currentState.user) {
            fetch(`${API_BASE}/api/favorites`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email:currentState.user.email, token:currentState.user.token, favorites:favoriteList}) });
        } else { localStorage.setItem('fortuneFavorites', JSON.stringify(favoriteList)); }
        renderFavorites();
    }

    function renderFavorites() {
        const container = document.getElementById('favorites-list');
        const section = document.getElementById('favorites-section');
        if (!container || !section) return;
        container.innerHTML = '';
        if (favoriteList.length === 0) { section.classList.add('hidden'); return; }
        section.classList.remove('hidden');
        favoriteList.forEach(fav => {
            const data = dailyRanking.find(d => d.sign.id === fav.sign && d.blood === fav.blood);
            if (data) container.innerHTML += createCardHTML(data);
        });
    }

    function renderRanking() {
        const listContainer = document.getElementById('ranking-list');
        const fullListContainer = document.getElementById('full-ranking-list');
        if (!listContainer || !fullListContainer) return;
        listContainer.innerHTML = ''; fullListContainer.innerHTML = '';
        dailyRanking.forEach((data, index) => {
            const html = createCardHTML(data);
            if (index < 3) listContainer.insertAdjacentHTML('beforeend', html);
            else fullListContainer.insertAdjacentHTML('beforeend', html);
        });
        renderFavorites();
    }

    function showFullRanking() {
        const fullList = document.getElementById('full-ranking-list');
        const txt = document.getElementById('show-ranking-text');
        if (fullList.classList.contains('hidden')) { fullList.classList.remove('hidden'); txt.textContent = "ランキングを閉じる"; }
        else { fullList.classList.add('hidden'); txt.textContent = "4位以下を見る"; }
    }

    function findMyRank() {
        const signId = document.getElementById('user-sign').value;
        const bloodId = document.getElementById('user-blood').value;
        const resultDiv = document.getElementById('my-rank-result');
        const myData = dailyRanking.find(d => d.sign.id === signId && d.blood === bloodId);
        if (myData) { resultDiv.innerHTML = createCardHTML(myData); resultDiv.classList.remove('hidden'); }
    } 

        // --- 新規追加: ページネーション制御付き描画関数 ---
function renderHistoryWithPagination() {
    const paginationEl = document.getElementById('history-pagination');
    const countEl = document.getElementById('search-result-count');
    
    const totalItems = historyPageState.filteredData.length;
    countEl.textContent = totalItems; // 件数表示更新

    // ページ数計算
    const totalPages = Math.ceil(totalItems / historyPageState.perPage) || 1;
    
    // ページ番号の範囲是正
    if (historyPageState.page > totalPages) historyPageState.page = totalPages;
    if (historyPageState.page < 1) historyPageState.page = 1;

    // データの切り出し (Slice)
    const startIndex = (historyPageState.page - 1) * historyPageState.perPage;
    const endIndex = startIndex + historyPageState.perPage;
    const slicedData = historyPageState.filteredData.slice(startIndex, endIndex);

    // 既存のリスト描画関数を呼び出す（切り出したデータだけ渡す）
    renderHistoryList(slicedData);

    // ページネーションボタンの生成
    if (totalItems <= historyPageState.perPage) {
        paginationEl.innerHTML = ''; // 1ページのみならボタン不要
        return;
    }

    let html = '';
    // 前へボタン
    html += `<button onclick="changeHistoryPage(${historyPageState.page - 1})" 
             class="px-4 py-2 rounded border bg-white dark:bg-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-700 disabled:opacity-50 transition"
             ${historyPageState.page === 1 ? 'disabled' : ''}>
             <i class="bi bi-chevron-left"></i> 前へ</button>`;

    // ページ番号表示
    html += `<span class="font-bold font-mono mx-4">Page ${historyPageState.page} / ${totalPages}</span>`;

    // 次へボタン
    html += `<button onclick="changeHistoryPage(${historyPageState.page + 1})" 
             class="px-4 py-2 rounded border bg-white dark:bg-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-700 disabled:opacity-50 transition"
             ${historyPageState.page === totalPages ? 'disabled' : ''}>
             次へ <i class="bi bi-chevron-right"></i></button>`;

    paginationEl.innerHTML = html;
}

// ページ切り替えハンドラ
function changeHistoryPage(newPage) {
    historyPageState.page = newPage;
    renderHistoryWithPagination();
    // リストの一番上へスクロール
    const listTop = document.getElementById('history-container');
    if(listTop) listTop.scrollIntoView({ behavior: 'smooth' });
}

        // --- 新規追加: 目次生成とPDFダウンロード機能 ---

    // 1. 目次生成関数
    function initTOC(viewId) {
        const contentAreaId = viewId === 'about' ? 'about-content-area' : 'privacy-content-area';
        const tocContainer = document.getElementById(`${viewId}-toc-container`);
        const tocList = document.getElementById(`${viewId}-toc-list`);
        
        if(!tocContainer || !tocList) return;

        // すでに生成済みなら何もしない（重複防止）
        if(tocList.children.length > 0) {
            tocContainer.classList.remove('hidden');
            return;
        }

        const area = document.getElementById(contentAreaId);
        // H3とH4タグを収集
        const headers = area.querySelectorAll('h3, h4');
        
        if(headers.length === 0) return;

        let tocHTML = '';
        headers.forEach((header, index) => {
            // IDがなければ付与する
            if(!header.id) {
                header.id = `${viewId}-header-${index}`;
            }

            const isH3 = header.tagName.toLowerCase() === 'h3';
            const indent = isH3 ? '' : 'ml-4';
            const icon = isH3 ? 'bi-caret-right-fill' : 'bi-dot';
            const fontSize = isH3 ? 'font-bold' : 'text-xs text-gray-600 dark:text-gray-400';

            tocHTML += `
                <li class="${indent} ${fontSize}">
                    <a href="#${header.id}" class="hover:text-red-500 hover:underline flex items-start transition" onclick="smoothScroll(event, '${header.id}')">
                        <i class="bi ${icon} mt-1 mr-1 flex-shrink-0"></i>
                        <span>${header.textContent}</span>
                    </a>
                </li>
            `;
        });

        tocList.innerHTML = tocHTML;
        tocContainer.classList.remove('hidden');
    }

    // 2. スムーズスクロール用
    function smoothScroll(e, targetId) {
        e.preventDefault();
        const target = document.getElementById(targetId);
        if(target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

// --- 3. PDFダウンロード関数 (最終修正版: 文字消え・表見切れ・DLボタン問題を全解決) ---
    async function downloadPDF(viewId) {
        const { jsPDF } = window.jspdf;
        
        const sourceId = viewId === 'about' ? 'about-content-area' : 'privacy-content-area';
        const sourceElement = document.getElementById(sourceId);
        const btn = event.target.closest('button');

        if (!sourceElement) return;

        // ボタンをローディング状態に
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 準備中...';
        btn.disabled = true;

        try {
            // --- 1. 日本語フォント (Shippori Mincho) を確実にロード ---
            // ※文字が表示されない問題を解決するため、信頼性の高いCDNから取得
            const fontUrl = 'https://cdn.jsdelivr.net/gh/google/fonts@main/ofl/shipporimincho/ShipporiMincho-Regular.ttf';
            const fontRes = await fetch(fontUrl);
            if (!fontRes.ok) throw new Error("フォントデータの取得に失敗しました。");
            const fontBuffer = await fontRes.arrayBuffer();
            const fontBase64 = arrayBufferToBase64(fontBuffer);

            // --- 2. PDFドキュメントの基本設定 ---
            const doc = new jsPDF({
                orientation: 'p',
                unit: 'pt',
                format: 'a4',
                putOnlyUsedFonts: true
            });

            // フォントの登録
            doc.addFileToVFS('ShipporiMincho.ttf', fontBase64);
            doc.addFont('ShipporiMincho.ttf', 'ShipporiMincho', 'normal');
            doc.setFont('ShipporiMincho');

            const pdfWidth = doc.internal.pageSize.getWidth();
            const margin = 35; 
            const contentWidth = pdfWidth - (margin * 2);

            // --- 3. HTMLクローンの作成と「PDF専用スタイル」の強制適用 ---
            const clone = sourceElement.cloneNode(true);
            
            // 目次などを削除
            const toc = clone.querySelector(`#${viewId}-toc-container`);
            if(toc) toc.remove();

            // クローン全体の見た目を「普通の文書」に強制変更
            clone.style.width = '800px'; // 計算用の基準幅
            clone.style.padding = '20px';
            clone.style.background = '#ffffff';
            clone.style.fontFamily = "'ShipporiMincho', serif";
            clone.style.color = '#000000';
            clone.style.lineHeight = '1.7';

            // 全要素のTailwindスタイルをPDF用に上書き
            const allNodes = clone.querySelectorAll('*');
            allNodes.forEach(node => {
                node.style.color = '#000000';
                node.style.boxShadow = 'none';
                node.style.textShadow = 'none';
                
                // 元のサイトで center 指定されているものを維持
                if (node.classList.contains('text-center') || node.tagName === 'H2') {
                    node.style.textAlign = 'center';
                }
                if (node.classList.contains('text-right')) {
                    node.style.textAlign = 'right';
                }
            });

            // ■ 表 (Table) の見切れ対策 [最重要]
            const tables = clone.querySelectorAll('table');
            tables.forEach(table => {
                table.style.width = '100%';
                table.style.tableLayout = 'fixed'; // 列幅を固定してはみ出しを強制阻止
                table.style.borderCollapse = 'collapse';
                table.style.fontSize = '7pt'; // 比較表は列が多いため、文字を小さく設定
                
                const cells = table.querySelectorAll('th, td');
                cells.forEach(cell => {
                    cell.style.border = '0.5pt solid #000000';
                    cell.style.padding = '3pt';
                    cell.style.wordBreak = 'break-all'; // 長い単語を強制折り返し
                    cell.style.backgroundColor = cell.tagName === 'TH' ? '#f5f5f5' : '#ffffff';
                });
            });

            // 見えない場所に配置してレンダリング準備
            const container = document.createElement('div');
            container.style.position = 'fixed';
            container.style.left = '-10000px';
            container.style.top = '0';
            container.appendChild(clone);
            document.body.appendChild(container);

            // --- 4. HTMLからPDFへのベクター変換 ---
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 書き出し中...';

            await doc.html(clone, {
                x: margin,
                y: margin,
                width: contentWidth, // PDF上の表示幅
                windowWidth: 800,    // HTMLを解釈する幅
                autoPaging: 'text',
                margin: [margin, margin, margin, margin],
                callback: function(doc) {
                    // クリーンアップ
                    document.body.removeChild(container);

                    // --- 5. 新しいタブで「PDFとして」開く (DLボタン表示対策) ---
                    const pdfBlob = doc.output('blob');
                    const fileName = viewId === 'about' ? 'tenmei_terms.pdf' : 'tenmei_privacy.pdf';
                    
                    // BlobからURLを生成（Typeを明示）
                    const fileURL = URL.createObjectURL(new Blob([pdfBlob], { type: 'application/pdf' }));
                    
                    // 新しいタブを開く
                    const newWindow = window.open(fileURL, '_blank');
                    
                    // タブのタイトルを設定（一部ブラウザでダウンロード名に反映される）
                    if (newWindow) {
                        newWindow.document.title = fileName;
                    }

                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });

        } catch (e) {
            console.error(e);
            alert("PDFの生成に失敗しました。ブラウザの制限を確認してください。");
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // ヘルパー: ArrayBufferをBase64に変換
    function arrayBufferToBase64(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
    }

    // 既存の showView 関数を少し修正して、画面表示時に目次を生成するようにする
    const originalShowView = window.showView; // 既存の関数を退避（または直接書き換え）
    
    // showView関数を上書き（既存のロジック + 目次生成呼び出し）
    window.showView = function(viewId) {
        // --- 既存のshowViewの中身 ---
        // Lab機能へのアクセス制限処理
        if(viewId === 'lab') {
            const lock = document.getElementById('lab-lock');
            const wrapper = document.getElementById('lab-content-wrapper');
            
            if(!currentState.user) {
                lock.classList.remove('hidden');
                wrapper.classList.add('lab-blurred');
            } else {
                lock.classList.add('hidden');
                wrapper.classList.remove('lab-blurred');
            }
        }

        // 画面の切り替え
        document.querySelectorAll('.view-section').forEach(el => {
            el.classList.remove('active');
            setTimeout(() => {
                if(!el.classList.contains('active')) el.style.display = 'none';
            }, 500);
        });
        
        const target = document.getElementById(`view-${viewId}`);
        if (target) {
            target.style.display = 'block';
            void target.offsetWidth; 
            target.classList.add('active');
        }
        currentState.view = viewId;

        // 各ビューごとの初期化ロジック
        if(viewId === 'draw') resetOmikujiPool();
        if(viewId === 'history') loadHistory();
        if(viewId === 'prefecture') renderPrefectureRanking();

        // ★追加: 規約・ポリシー画面を開いた時に目次を生成
        if(viewId === 'about' || viewId === 'privacy') {
            initTOC(viewId);
        }
    };
    </script>
</body>
</html>
