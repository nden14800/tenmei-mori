<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>運勢・天命乃杜 | 本格・今日の運勢</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tailwind Config -->
    <script>
      tailwind.config = {
        darkMode: 'class',
      }
    </script>
   <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- jsPDF & html2canvas -->
    <!-- 修正: jspdfを削除し、html2canvasのみ残す -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- フォント -->
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500;600;800&family=Zen+Old+Mincho:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root {
            /* ライトモード変数 */
            /* ▼▼▼ 背景パターンはそのまま、色だけ真っ白に変更 ▼▼▼ */
            --bg-pattern: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4d4d4' fill-opacity='0.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            --bg-color: #ffffff; /* ← ここを #fdfbf7 から #ffffff に変更 */
            --text-main: #2b2b2b;
            --text-sub: #555555;
            --card-bg: #ffffff;
            --card-border: #e6e6e6;
            --accent-red: #b91c1c;
            --accent-gold: #c5a059;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.3);
            --sidebar-bg: rgba(255, 255, 255, 0.75); /* すりガラス用に透明度アップ */
            --input-bg: #ffffff;
            --omi-paper: #fffcf2; 
            --sidebar-width: 80px;
            --sidebar-width-expanded: 240px;
        }

        /* --- ダークモード変数定義 (システム検知) --- */
        @media (prefers-color-scheme: dark) {
            :root {
                /* ▼▼▼ 修正: #ff6b6b から #b91c1c (ライトモードと同じ色) に変更 ▼▼▼ */
                --accent-red: #b91c1c; 
                
                /* 他の変数はそのまま */
                --bg-pattern: url("data:image/svg+xml,...");
                --bg-color: #1a1a1a;
                --text-main: #e0e0e0;
                --text-sub: #b0b0b0;
                --card-bg: #2c2c2c;
                --card-border: #444444;
                --accent-gold: #e5c07b;
                --glass-bg: rgba(30, 30, 30, 0.9);
                --glass-border: rgba(255, 255, 255, 0.1);
                --sidebar-bg: rgba(30, 30, 30, 0.75);
                --input-bg: #333333;
                --omi-paper: #fffcf2; 
            }
        }

        /* 手動切り替え (.darkクラス付与時) */
        .dark {
            /* ▼▼▼ 修正: #ff6b6b から #b91c1c (ライトモードと同じ色) に変更 ▼▼▼ */
            --accent-red: #b91c1c !important;

            /* 他の変数はそのまま */
            --bg-pattern: url("data:image/svg+xml,...") !important;
            --bg-color: #1a1a1a !important;
            --text-main: #e0e0e0 !important;
            --text-sub: #b0b0b0 !important;
            --card-bg: #2c2c2c !important;
            --card-border: #444444 !important;
            --accent-gold: #e5c07b !important;
            --glass-bg: rgba(30, 30, 30, 0.9) !important;
            --glass-border: rgba(255, 255, 255, 0.1) !important;
            --sidebar-bg: rgba(30, 30, 30, 0.75) !important;
            --input-bg: #333333 !important;
            --omi-paper: #fffcf2 !important; 
        }

        /* Lab: 迎春・雅モード */
        body.theme-newyear {
            --bg-color: #fffbf0;
            --bg-pattern: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23d4af37' fill-opacity='0.2'%3E%3Cpath d='M0 0h40v40H0V0zm20 20h20v20H20V20zM0 20h20v20H0V20zM20 0h20v20H20V0z'/%3E%3C/g%3E%3C/svg%3E");
            --accent-red: #e60033; /* 紅白の紅 */
            --accent-gold: #d4af37; /* 金 */
            --card-border: #d4af37;
        }
        body.theme-newyear .nav-btn {
            color: #333;
        }
        body.theme-newyear #sidebar {
            background-color: rgba(255, 252, 240, 0.85);
            border-right: 1px solid #d4af37;
        }

        body {
            font-family: 'Zen Old Mincho', 'Shippori Mincho', serif;
            background-color: var(--bg-color);
            background-image: var(--bg-pattern);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- 汎用テーマクラス --- */
        .themed-card {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-main);
        }
        .themed-text-sub { color: var(--text-sub); }
        .themed-input {
            background-color: var(--input-bg);
            color: var(--text-main);
            border: 1px solid var(--card-border);
        }

        /* --- サイドバー (すりガラス効果強化) --- */
        #sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            backdrop-filter: blur(15px); /* すりガラス効果 */
            -webkit-backdrop-filter: blur(15px);
            border-right: 1px solid var(--glass-border);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 100;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding-top: 20px;
            overflow: hidden;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }
        #sidebar:hover {
            width: var(--sidebar-width-expanded);
        }
        .nav-btn {
            width: 100%;
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--text-main);
            background: none;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
            text-decoration: none;
            height: 60px;
        }
        .nav-btn:hover {
            background-color: rgba(128,128,128,0.1);
        }
        .nav-btn i {
            font-size: 1.5rem;
            min-width: 40px;
            text-align: center;
        }
        /* サイドバー用フラスコSVGのスタイル */
        .nav-btn svg {
            min-width: 40px; /* アイコンの幅を確保 */
            width: 32px;
            height: 32px;
            margin: 0; /* 左寄せではなく中央になるようにマージン調整が必要だがflexで制御 */
            display: block;
            flex-shrink: 0;
        }

        .nav-text {
            opacity: 0;
            transform: translateX(-10px);
            transition: all 0.3s;
            font-weight: bold;
            font-family: 'Zen Old Mincho', serif;
            margin-left: 10px;
        }
        #sidebar:hover .nav-text {
            opacity: 1;
            transform: translateX(0);
        }

        /* --- メインコンテンツ --- */
        #main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
            width: calc(100% - var(--sidebar-width));
            transition: margin-left 0.3s;
        }

        /* --- 共通コンポーネント --- */
        .btn-primary {
            background-color: var(--accent-red);
            color: white;
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .btn-primary:disabled {
            background-color: #999;
            cursor: not-allowed;
            transform: none;
        }
        .btn-outline {
            background-color: transparent;
            color: var(--text-main);
            border: 2px solid var(--text-main);
            padding: 10px 25px;
            border-radius: 30px;
            font-weight: bold;
            transition: all 0.3s;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        .btn-outline:hover {
            background-color: rgba(128,128,128,0.1);
        }

        /* --- 新ローディングスピナー --- */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease; /* 滑らかなフェード */
        }
        #loading-overlay.visible {
            opacity: 1;
        }
        
        .loader-svg {
            width: 80px;
            height: 80px;
            animation: rotate 1s linear infinite;
            transform-origin: center center;
        }
        .loader-path {
            stroke: #ffffff; /* 白色の線 */
            stroke-linecap: round;
            stroke-dasharray: 89 150;
            stroke-dashoffset: 0;
        }
        @keyframes rotate {
            100% { transform: rotate(360deg); }
        }

        /* --- ホーム画面 (札デザイン統一版) --- */
        .home-circle-container {
            width: 300px;
            height: 300px;
            border: 2px solid var(--accent-red);
            border-radius: 50%;
            margin: 20px auto;
            position: relative;
            overflow: hidden;
            background: rgba(255,255,255,0.5);
        }
        /* --- ホーム画面 (札デザイン統一版) --- */
        .home-circle-container {
            width: 300px;
            height: 300px;
            border: 2px solid var(--accent-red);
            border-radius: 50%;
            margin: 20px auto;
            position: relative;
            overflow: hidden;
            background: rgba(255,255,255,0.5); /* ライトモードは半透明の白 */
        }
/* ▼▼▼ 追加：ダークモード時は薄い黒にして目立たなくする ▼▼▼ */
        .dark .home-circle-container {
            background: rgba(0, 0, 0, 0.2); /* ほぼ透明な黒 */
            border-color: rgba(255, 255, 255, 0.1); /* 枠線も極薄に */
        }
        .flying-paper {
            position: absolute;
            width: 24px;
            height: 70px;
            background-color: #fff;
            /* ▼▼ 変更: 1本線(solid)から2本線(double)へ ▼▼ */
            border: 3px double var(--accent-red); 
            box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
            opacity: 0;
            animation: paperFly 5s infinite linear;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Zen Old Mincho', serif;
            writing-mode: vertical-rl;
            color: var(--accent-red);
            font-weight: bold;
            font-size: 9px;
            user-select: none;
            z-index: 1;
        }
        
        @keyframes paperFly {
            0% { transform: translateY(350px) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-50px) rotate(360deg); opacity: 0; }
        }

        /* --- おみくじ選択画面 (修正・統一版) --- */
        .omikuji-pool {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-content: flex-start;
            gap: 15px;
            padding-bottom: 200px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .omikuji-stick {
            /* 共通カードスタイル */
            position: relative;
            width: 52px;
            height: 160px;
            background-color: #fff;
            
            /* ▼▼ 修正: 4pxの二重線 (結果カードと統一) ▼▼ */
            border: 4px double var(--accent-red);
            
            box-shadow: 3px 3px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            
            /* 中身の配置 */
            display: flex;
            flex-direction: column;
            align-items: center;
            
            /* ▼▼ 修正: 端に寄せず、均等に配置してはみ出し防止 ▼▼ */
            justify-content: space-evenly; 
            
            padding: 8px 0; /* 上下の余白を確保 */
            user-select: none;
            
            /* ホバー時の挙動設定 */
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.2s, border-color 0.2s;
            transform-origin: center center;
        }

        /* アニメーション競合対策: transformを使わず margin-top で出現させる */
        @keyframes fadeInStickMargin {
            from { opacity: 0; margin-top: 30px; }
            to { opacity: 1; margin-top: 0; }
        }

        .omikuji-stick:hover {
            transform: scale(1.15) rotate(0deg) !important;
            z-index: 100;
            box-shadow: 0 15px 30px rgba(185, 28, 28, 0.25);
            border-color: #d4af37;
            background-color: #fffcf5;
        }

        /* 札内のパーツスタイル */
        .stick-icon {
            font-size: 1.2rem; /* 少し小さくしてバランス調整 */
            color: var(--accent-red);
            line-height: 1;
            flex-shrink: 0; /* 縮まないようにする */
        }
        
        .stick-text {
            writing-mode: vertical-rl;
            font-family: 'Zen Old Mincho', serif;
            font-size: 1.1rem;
            font-weight: 900;
            color: var(--accent-red);
            letter-spacing: 0.2em;
            
            /* ▼▼ 修正: 絶対に改行させない ▼▼ */
            white-space: nowrap; 
            line-height: 1;
        }
        
        .stick-footer {
            writing-mode: vertical-rl;
            font-family: 'Zen Old Mincho', serif;
            font-size: 0.6rem; /* 文字サイズを調整 */
            color: var(--accent-red);
            opacity: 0.8;
            font-weight: bold;
            letter-spacing: 0.1em;
            
            /* ▼▼ 修正: 絶対に改行させない＆はみ出し防止 ▼▼ */
            white-space: nowrap;
            line-height: 1;
            flex-shrink: 0;
        }

        /* --- カウントダウン --- */
        #countdown-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 999;
            display: none;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 8rem;
            font-family: 'Zen Old Mincho', serif;
        }

        /* --- おみくじ結果カード (新デザイン修正版) --- */
        #result-capture-container {
            width: 600px;
            margin: 0 auto;
            position: relative;
        }
        .result-card-outer {
            width: 600px;
            min-height: 1200px;
            padding: 30px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            font-family: 'Zen Old Mincho', serif;
        }

        .result-logo-area {
            text-align: center;
            margin-bottom: 10px;
        }
        .result-kamon {
            font-size: 3rem;
            margin-bottom: 5px;
        }
        .result-title-text {
            font-size: 1.5rem;
            font-weight: 900;
            letter-spacing: 0.3em;
        }
        .result-issue-num {
            font-size: 0.9rem;
            margin-bottom: 20px;
            font-family: monospace;
            opacity: 0.8;
        }
        
        /* --- 運勢ハンコ（最新デザイン） --- */
        .result-circle-box {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            overflow: hidden;
            padding: 10px;
            box-sizing: border-box;
            border: 3px solid transparent; /* デフォルト */
        }

        .result-kanji-main {
            writing-mode: vertical-rl;
            text-orientation: upright;
            font-weight: 900;
            line-height: 1;
            letter-spacing: -0.05em;
            display: block;
        }

       /* --- スタイル別定義 --- */

        /* 1. 標準（中吉・小吉・吉など）: 二重線カード、赤塗りハンコ、赤文字 */
        .style-normal {
            background-color: #ffffff;
            border: 8px double #b91c1c; /* カード外枠：赤二重線 */
            color: #b91c1c; /* ▼修正: ここを #333 から #b91c1c (赤) に変更 */
        }
        .style-normal .result-circle-box {
            background-color: #b91c1c; /* ハンコ塗りつぶし：赤 */
            color: #ffffff !important; /* ハンコ内の文字：白 */
        }

        /* 2. 大吉: 画像のような鮮やかな黄金色と、和紙の強いザラザラ感を再現 */
        .style-daikichi {
            /* 画像から抽出した、赤みの入った濃厚な山吹色 */
            background-color: #ffb700;
            
            /* ザラザラ感（和紙の繊維）を表現するノイズ画像 */
            /* 粒子を少し粗く(0.5)し、不透明度を高く(0.4)して、質感をくっきりと出しています */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='washi'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.5' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23washi)' opacity='0.4'/%3E%3C/svg%3E");
            
            /* 背景色とノイズを合成して、深みのある質感にする */
            background-blend-mode: overlay;
            
            border: 8px double #fff; /* 外枠はそのまま */
            color: #b91c1c; /* 文字色は赤 */
        }
        
        .style-daikichi .result-circle-box {
            background-color: transparent;
            border: 2px solid #b91c1c; /* ハンコの線（2px） */
            color: #b91c1c !important;
        }

        /* 3. 大凶: 白カード、黒二重線、黒ハンコ（縁のみ）、黒文字 */
        .style-daikyo {
            background-color: #ffffff; /* 背景：白 */
            border: 8px double #000000; /* カード外枠：黒二重線 */
            color: #000000; /* 文字：黒（ここはそのまま） */
        }
        .style-daikyo .result-circle-box {
            background-color: transparent;
            border: 4px solid #000000; /* ハンコ：黒縁 */
            color: #000000 !important; /* 文字：黒 */
        }
        
        /* パーツごとの色強制（大凶の時は黒、それ以外は親要素のcolor＝赤を継承） */
        .style-daikyo .accent-border { border-color: #000 !important; }
        .style-daikyo .accent-text { color: #000 !important; }
        .style-daikyo .red-text { color: #000 !important; }
        
        /* 標準と大吉の時は、親要素の赤色(#b91c1c)を引き継ぐ設定 */
        .style-normal .accent-border, .style-daikichi .accent-border { border-color: currentColor; }
        .style-normal .accent-text, .style-daikichi .accent-text { color: currentColor; }
        .style-normal .red-text, .style-daikichi .red-text { color: currentColor; }

        .result-card-outer {
            padding: 30px 40px !important;
        }
        
        .result-label-sub {
            font-size: 1.2rem;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .result-main-message-area {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 40px;
            width: 100%;
            padding: 0 20px;
        }
        .result-poem-vertical {
            writing-mode: vertical-rl;
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 0.2em;
            line-height: 1.8;
            height: 350px;
        }
        .result-advice-box {
            writing-mode: vertical-rl;
            border: 2px solid currentColor;
            padding: 15px 10px;
            font-size: 1rem;
            line-height: 1.8;
            height: 350px;
        }
        .advice-label {
            font-weight: 900;
            border-bottom: 1px solid currentColor; /* 縦書きなので左線に見えるが実際は下 */
            margin-left: 10px;
            padding-bottom: 5px;
        }

        .result-details-grid {
            display: flex;
            flex-direction: row-reverse; /* 縦書きなので右から左へ */
            justify-content: center;
            gap: 15px;
            width: 100%;
            margin-bottom: 40px;
            border-top: 1px solid currentColor;
            border-bottom: 1px solid currentColor;
            padding: 20px 0;
        }
        .detail-column {
            writing-mode: vertical-rl;
            height: 250px;
            font-size: 1.1rem;
            line-height: 1.5;
        }
        .detail-item-label {
            font-weight: 900;
            margin-bottom: 10px;
            display: inline-block;
        }
        .detail-item-content {
            display: inline-block;
        }

        .lucky-area {
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            text-align: left;
        }
        .lucky-box, .unlucky-box {
            border: 1px solid currentColor;
            padding: 15px;
            border-radius: 8px;
        }
        .lucky-title { font-weight: bold; margin-bottom: 10px; border-bottom: 1px dashed currentColor; padding-bottom: 5px; }
        .lucky-row { font-size: 0.9rem; margin-bottom: 4px; display: flex; align-items: flex-start;}
        .lucky-icon { margin-right: 5px; min-width: 20px; text-align: center; }

        .result-footer-info {
            width: 100%;
            text-align: center;
            border-top: 2px solid currentColor;
            padding-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .result-user-name {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .result-date {
            font-size: 0.9rem;
        }
        .result-qr-container {
            background: #fff;
            padding: 5px;
        }

        /* 12星座カード */
        .ranking-card {
            border-radius: 16px; box-shadow: 0 4px 6px var(--shadow); padding: 20px;
            margin-bottom: 20px; transition: transform 0.2s, box-shadow 0.2s; position: relative;
        }
        .ranking-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px var(--shadow); }
        .rank-badge-lg { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.5rem; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); flex-shrink: 0; }
        .rank-1 { background: linear-gradient(135deg, #FFD700, #FDB931); border: 2px solid #fff; }
        .rank-2 { background: linear-gradient(135deg, #E0E0E0, #BDBDBD); }
        .rank-3 { background: linear-gradient(135deg, #CD7F32, #A0522D); }
        .rank-other { background-color: var(--card-border); color: var(--text-sub); font-size: 1.2rem; width: 50px; height: 50px; }
        .param-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--card-border); }
        .param-item { text-align: center; }
        .param-label { font-size: 0.75rem; color: var(--text-main); margin-bottom: 4px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 2px; flex-wrap: wrap; }
        .param-score-text { font-size: 0.9rem; font-weight: 900; color: var(--accent-red); }
        .param-value { font-size: 0.75rem; color: var(--text-sub); margin-bottom: 2px; }
        .score-bar-bg { width: 100%; height: 8px; background-color: var(--card-border); border-radius: 4px; margin-top: 4px; overflow: hidden; }
        .score-bar-fill { height: 100%; border-radius: 4px; }
        .fav-btn {
            position: absolute; top: 15px; right: 15px; background: none; border: none;
            font-size: 1.5rem; color: #ccc; cursor: pointer; transition: color 0.2s, transform 0.2s;
        }
        .fav-btn.active { color: #FFD700; transform: scale(1.1); }
        .fav-btn:hover { transform: scale(1.15); }
        .calendar-wrapper { margin-top: 15px; border-top: 1px dashed var(--card-border); padding-top: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 8px; }
        .calendar-cell { background-color: var(--bg-color); border-radius: 8px; padding: 4px 2px; text-align: center; min-height: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid var(--card-border); }
        .cal-date { font-size: 0.7rem; font-weight: bold; color: var(--text-sub); }
        .cal-mark { font-size: 0.7rem; margin-top: 2px; line-height: 1; }
        .calendar-legend { display: flex; justify-content: center; gap: 10px; margin-top: 8px; font-size: 0.7rem; color: var(--text-sub); flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 2px; }

        /* ビュー制御 */
        .view-section { display: none; opacity: 0; transition: opacity 0.5s; }
        .view-section.active { display: block; opacity: 1; }

        /* おみくじの轍 ぼかし制御 */
        .history-blurred {
            position: relative;
            filter: blur(8px);
            pointer-events: none;
            user-select: none;
            overflow: hidden;
            opacity: 0.7;
        }

        /* --- おみくじの轍：モダン・タイムラインUI --- */

/* 1. 統計ダッシュボード (Bentoスタイル) */
.history-stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-bottom: 24px;
}

.history-stat-card {
    background-color: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 16px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    
    /* ▼▼▼ 追加：アニメーション設定 ▼▼▼ */
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    cursor: pointer; /* クリックできる感触を出す */
}

/* ▼▼▼ 追加：ホバー時の浮き上がりと赤い枠線 ▼▼▼ */
.history-stat-card:hover {
    transform: translateY(-4px) scale(1.01);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    border-color: var(--accent-red); /* 赤い線 */
    z-index: 10;
}

/* 装飾用の背景アイコン (ここはそのまま) */
.history-stat-card::before {
    content: '';
    position: absolute;
    right: -10px;
    bottom: -10px;
    font-size: 4rem;
    opacity: 0.05;
    font-family: 'bootstrap-icons';
    z-index: 0;
}
.stat-card-personal::before { content: '\F4E1'; } /* person-walking */
.stat-card-global::before { content: '\F622'; } /* globe */

.stat-value {
    font-size: 1.8rem;
    font-weight: 900;
    font-family: 'Zen Old Mincho', serif;
    position: relative;
    z-index: 1;
}
.stat-label {
    font-size: 0.75rem;
    color: var(--text-sub);
    font-weight: bold;
    position: relative;
    z-index: 1;
    margin-bottom: 5px;
}

/* 2. コントロールバー (検索フィルタ) */
.history-control-bar {
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid var(--card-border);
    border-radius: 16px;
    padding: 15px;
    margin-bottom: 30px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.05);
}
.dark .history-control-bar {
    background: rgba(30, 30, 30, 0.7);
}

.control-group-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.modern-filter-select, .modern-filter-input {
    padding: 10px 14px;
    border-radius: 10px;
    border: 1px solid var(--card-border);
    background-color: var(--input-bg);
    color: var(--text-main);
    font-size: 0.9rem;
    outline: none;
    transition: all 0.2s;
}
.modern-filter-select:focus, .modern-filter-input:focus {
    border-color: var(--accent-red);
    box-shadow: 0 0 0 2px rgba(185, 28, 28, 0.1);
}

/* 3. タイムラインリスト */
.timeline-container {
    position: relative;
    padding-left: 20px; /* 左側のライン用スペース */
}
/* 縦のライン */
.timeline-container::before {
    content: '';
    position: absolute;
    top: 10px;
    bottom: 20px;
    left: 6px;
    width: 2px;
    background: #e5e7eb;
    border-radius: 2px;
}
.dark .timeline-container::before {
    background: #3f3f46;
}

/* タイムラインアイテム */
.timeline-item {
    position: relative;
    margin-bottom: 24px;
    padding-left: 20px;
    opacity: 0;
    animation: slideInRight 0.4s ease-out forwards;
}

@keyframes slideInRight {
    from { opacity: 0; transform: translateX(10px); }
    to { opacity: 1; transform: translateX(0); }
}

/* タイムラインの「点」 */
.timeline-dot {
    position: absolute;
    left: -19px; /* コンテナのpaddingを考慮して位置調整 */
    top: 18px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #fff;
    border: 3px solid #d1d5db;
    z-index: 2;
}
.dark .timeline-dot {
    background-color: #18181b;
    border-color: #52525b;
}

/* 自分の投稿の場合のドット強調 */
.timeline-item.is-me .timeline-dot {
    border-color: var(--accent-red);
    box-shadow: 0 0 0 3px rgba(185, 28, 28, 0.2);
}

/* カード本体 */
.history-card {
    background-color: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 12px;
    padding: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
}
.history-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.08);
}

/* 自分のカードは少し色をつける */
.history-card.is-me {
    background-color: #fffaf0; /* 薄い黄色/赤 */
    border-left: 4px solid var(--accent-red);
}
.dark .history-card.is-me {
    background-color: #3f2c2c; /* ダークモード時の薄い赤 */
}

/* 結果バッジ */
.result-badge {
    font-family: 'Zen Old Mincho', serif;
    font-weight: 900;
    font-size: 1.2rem;
    padding: 4px 12px;
    border-radius: 8px;
    letter-spacing: 0.1em;
    white-space: nowrap;
}
/* 結果ごとの色 */
.res-daikichi { color: #b45309; background: #fffbeb; border: 1px solid #fcd34d; } /* 大吉:金 */
.res-kichi    { color: #b91c1c; background: #fef2f2; border: 1px solid #fca5a5; } /* 吉系:赤 */
.res-kyo      { color: #374151; background: #f3f4f6; border: 1px solid #d1d5db; } /* 凶系:グレー */
.res-daikyo   { color: #ffffff; background: #1f2937; border: 1px solid #000000; } /* 大凶:黒 */

/* ダークモード対応 */
.dark .res-daikichi { color: #fbbf24; background: #422006; border-color: #b45309; }
.dark .res-kichi    { color: #f87171; background: #450a0a; border-color: #991b1b; }
.dark .res-kyo      { color: #9ca3af; background: #1f2937; border-color: #374151; }
.dark .res-daikyo   { color: #e5e7eb; background: #000000; border-color: #4b5563; }

        /* --- 社務所だより：モダン・瓦版UI --- */

/* 1. ニュース検索エリア (履歴のコントロールバーと統一) */
.news-control-bar {
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid var(--card-border);
    border-radius: 16px;
    padding: 15px;
    margin-bottom: 30px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.05);
}
.dark .news-control-bar {
    background: rgba(30, 30, 30, 0.7);
}

/* 2. ニュースグリッド */
.news-grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

/* 3. ニュースカード本体 */
.news-card {
    background-color: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 16px;
    padding: 24px;
    position: relative;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); /* 統一されたアニメーション */
    cursor: pointer;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    min-height: 180px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.02);
}

/* ホバー時の挙動 (ホーム画面・履歴と統一) */
.news-card:hover {
    transform: translateY(-4px) scale(1.01);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    border-color: var(--accent-red);
    z-index: 10;
}

/* 背景の巨大アイコン装飾 */
.news-card::before {
    content: '';
    position: absolute;
    right: -10px;
    bottom: -15px;
    font-size: 5rem;
    opacity: 0.05;
    font-family: 'bootstrap-icons';
    z-index: 0;
    transition: transform 0.4s;
}
.news-card:hover::before {
    transform: scale(1.2) rotate(-10deg);
    opacity: 0.1;
}

/* カード内の要素 */
.news-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    position: relative;
    z-index: 1;
}

.news-date {
    font-size: 0.75rem;
    color: var(--text-sub);
    font-family: monospace;
    font-weight: bold;
}

.news-tag {
    font-size: 0.7rem;
    font-weight: bold;
    padding: 3px 10px;
    border-radius: 20px;
    border: 1px solid transparent;
}

/* タグの色分け (拡張版) */
.tag-important { background: #fee2e2; color: #b91c1c; border-color: #fecaca; } /* 重要: 赤 */
.tag-update    { background: #e0e7ff; color: #1d4ed8; border-color: #c7d2fe; } /* 更新: 青 */
.tag-info      { background: #f3f4f6; color: #4b5563; border-color: #e5e7eb; } /* お知らせ: 灰 */
.tag-system    { background: #fef3c7; color: #b45309; border-color: #fde68a; } /* 新機能: 黄 */
.tag-green     { background: #dcfce7; color: #047857; border-color: #bbf7d0; } /* 開発: 緑 */
.tag-purple    { background: #f3e8ff; color: #7e22ce; border-color: #d8b4fe; } /* メンテ: 紫 */
.tag-pink      { background: #fce7f3; color: #be185d; border-color: #fbcfe8; } /* 挨拶/行事: ピンク */
.tag-teal      { background: #ccfbf1; color: #0f766e; border-color: #99f6e4; } /* デザイン: 青緑 */
.tag-orange    { background: #ffedd5; color: #c2410c; border-color: #fed7aa; } /* 解説/注意: 橙 */

/* ダークモード時のタグ色調整 */
.dark .tag-important { background: #450a0a; color: #fca5a5; border-color: #7f1d1d; }
.dark .tag-update    { background: #172554; color: #93c5fd; border-color: #1e3a8a; }
.dark .tag-info      { background: #1f2937; color: #d1d5db; border-color: #374151; }
.dark .tag-system    { background: #451a03; color: #fcd34d; border-color: #78350f; }
.dark .tag-green     { background: #064e3b; color: #6ee7b7; border-color: #065f46; }
.dark .tag-purple    { background: #3b0764; color: #e9d5ff; border-color: #6b21a8; }
.dark .tag-pink      { background: #500724; color: #fbcfe8; border-color: #9d174d; }
.dark .tag-teal      { background: #042f2e; color: #99f6e4; border-color: #115e59; }
.dark .tag-orange    { background: #431407; color: #fdba74; border-color: #9a3412; }

/* 4. 背景アイコン定義クラス (Bootstrap Icons Codes) */
/* 重要・警告 */
.icon-news-alert::before   { content: '\F332'; } /* exclamation-triangle */
/* 更新・矢印 */
.icon-news-update::before  { content: '\F128'; } /* arrow-repeat */
/* お知らせ・情報 */
.icon-news-info::before    { content: '\F431'; } /* info-circle */
/* 新機能・キラキラ */
.icon-news-star::before    { content: '\F586'; } /* stars */
/* 開発話・チャット */
.icon-news-chat::before    { content: '\F27A'; } /* chat-quote */
/* メンテナンス・工事 */
.icon-news-maint::before   { content: '\F2AB'; } /* cone-striped */
/* 挨拶・イベント・花 */
.icon-news-flower::before  { content: '\F3E5'; } /* flower1 */
/* デザイン・パレット */
.icon-news-design::before  { content: '\F4BE'; } /* palette */
/* 解説・本 */
.icon-news-book::before    { content: '\F1D6'; } /* book */
/* バグ修正・虫 */
.icon-news-bug::before     { content: '\F1DC'; } /* bug */

.news-title {
    font-size: 1.1rem;
    font-weight: 900;
    line-height: 1.5;
    margin-bottom: 10px;
    color: var(--text-main);
    position: relative;
    z-index: 1;
}

.news-desc {
    font-size: 0.85rem;
    color: var(--text-sub);
    line-height: 1.6;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    position: relative;
    z-index: 1;
}

/* 4. アイコン定義クラス */
.icon-news-alert::before { content: '\F332'; } /* exclamation-triangle */
.icon-news-info::before { content: '\F431'; } /* info-circle */
.icon-news-update::before { content: '\F128'; } /* arrow-repeat */
.icon-news-star::before { content: '\F586'; } /* star */
.icon-news-chat::before { content: '\F27A'; } /* chat-quote */

        /* --- 神籤草子：モダン・書架UI --- */

/* 1. 書架グリッド */
.column-grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 24px;
    margin-bottom: 40px;
}

/* 2. コラムカード (本のようなデザイン) */
.column-card {
    background-color: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 12px 16px 16px 12px; /* 左側を背表紙っぽく */
    position: relative;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 6px rgba(0,0,0,0.02);
    height: 100%;
}

/* ホバー時の挙動 */
.column-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 30px -10px rgba(0, 0, 0, 0.15);
    z-index: 10;
}

/* 装飾：左端の背表紙ライン */
.column-card::after {
    content: '';
    position: absolute;
    top: 0; bottom: 0; left: 0;
    width: 6px;
    background-color: var(--accent-gold); /* デフォルト色 */
    opacity: 0.7;
}

/* 3. アイコンヘッダーエリア */
.column-header {
    height: 140px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
}

/* 巨大アイコン背景 */
.column-header i {
    font-size: 5rem;
    z-index: 1;
    position: relative;
    filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
    transition: transform 0.4s;
}
.column-card:hover .column-header i {
    transform: scale(1.1) rotate(5deg);
}

/* 4. 本文エリア */
.column-body {
    padding: 20px;
    flex: 1;
    display: flex;
    flex-direction: column;
}

.column-category {
    font-size: 0.7rem;
    font-weight: bold;
    color: var(--text-sub);
    letter-spacing: 0.1em;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
}

.column-title {
    font-size: 1.15rem;
    font-weight: 900;
    line-height: 1.5;
    margin-bottom: 10px;
    color: var(--text-main);
    font-family: 'Zen Old Mincho', serif;
}

.column-date {
    margin-top: auto; /* 下寄せ */
    padding-top: 15px;
    font-size: 0.75rem;
    color: var(--text-sub);
    text-align: right;
    border-top: 1px dashed var(--card-border);
}

/* 色バリエーション (ヘッダー背景色) */
.col-bg-indigo { background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); color: #4338ca; }
.col-bg-green  { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); color: #15803d; }
.col-bg-purple { background: linear-gradient(135deg, #f3e8ff 0%, #d8b4fe 100%); color: #7e22ce; }
.col-bg-orange { background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%); color: #c2410c; }
.col-bg-pink   { background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); color: #be185d; }
.col-bg-yellow { background: linear-gradient(135deg, #fef9c3 0%, #fde68a 100%); color: #b45309; }
.col-bg-red    { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #b91c1c; }

/* ダークモード対応 */
.dark .col-bg-indigo { background: linear-gradient(135deg, #312e81 0%, #1e1b4b 100%); color: #a5b4fc; }
.dark .col-bg-green  { background: linear-gradient(135deg, #064e3b 0%, #022c22 100%); color: #86efac; }
.dark .col-bg-purple { background: linear-gradient(135deg, #581c87 0%, #3b0764 100%); color: #d8b4fe; }
.dark .col-bg-orange { background: linear-gradient(135deg, #7c2d12 0%, #431407 100%); color: #fdba74; }
.dark .col-bg-pink   { background: linear-gradient(135deg, #831843 0%, #500724 100%); color: #f9a8d4; }
.dark .col-bg-yellow { background: linear-gradient(135deg, #713f12 0%, #451a03 100%); color: #fde047; }
.dark .col-bg-red    { background: linear-gradient(135deg, #7f1d1d 0%, #450a0a 100%); color: #fca5a5; }

/* 背表紙ラインの色調整 */
.column-card.c-indigo::after { background-color: #4338ca; }
.column-card.c-green::after  { background-color: #15803d; }
.column-card.c-purple::after { background-color: #7e22ce; }
.column-card.c-orange::after { background-color: #c2410c; }
.column-card.c-pink::after   { background-color: #be185d; }
.column-card.c-yellow::after { background-color: #b45309; }
.column-card.c-red::after    { background-color: #b91c1c; }
/* ダークモード時のライン */
.dark .column-card::after { opacity: 1; }

        
/* --- 御守授与所：モダンUI --- */

/* 1. 願い事グリッド */
.omamori-grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

/* 2. 願い事カード (木札・お守り風) */
.wish-card {
    background-color: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 12px;
    padding: 20px 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    position: relative;
    overflow: hidden;
    height: 200px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.02);
}

/* ホバー時の挙動 */
.wish-card:hover {
    transform: translateY(-5px) scale(1.03);
    box-shadow: 0 15px 25px rgba(0,0,0,0.1);
    border-color: currentColor; /* アイコンの色を枠線に反映 */
    z-index: 10;
}

/* カード内の要素 */
.wish-icon-box {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: rgba(128,128,128,0.05);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    margin-bottom: 15px;
    transition: transform 0.3s;
}
.wish-card:hover .wish-icon-box {
    transform: scale(1.1) rotate(10deg);
}

.wish-title {
    font-size: 1.1rem;
    font-weight: 900;
    margin-bottom: 5px;
    font-family: 'Zen Old Mincho', serif;
    letter-spacing: 0.1em;
}

.wish-desc {
    font-size: 0.65rem;
    color: var(--text-sub);
    opacity: 0.8;
}

/* 願い事ごとのカラーテーマ */
.wish-safety  { color: #15803d; } /* 緑: 交通安全 */
.wish-safety:hover { background-color: #f0fdf4; }

.wish-health  { color: #0f766e; } /* 深緑: 健康 */
.wish-health:hover { background-color: #ccfbf1; }

.wish-love    { color: #be185d; } /* ピンク: 恋愛 */
.wish-love:hover { background-color: #fce7f3; }

.wish-money   { color: #b45309; } /* 金/黄: 金運 */
.wish-money:hover { background-color: #fffbeb; }

.wish-study   { color: #1d4ed8; } /* 青: 学業 */
.wish-study:hover { background-color: #eff6ff; }

.wish-victory { color: #b91c1c; } /* 赤: 必勝 */
.wish-victory:hover { background-color: #fef2f2; }

.wish-protect { color: #374151; } /* 黒/灰: 厄除 */
.wish-protect:hover { background-color: #f3f4f6; }

.wish-success { color: #7e22ce; } /* 紫: 大願 */
.wish-success:hover { background-color: #f3e8ff; }

/* ダークモード時のホバー背景調整 */
.dark .wish-safety:hover  { background-color: #052e16; }
.dark .wish-health:hover  { background-color: #042f2e; }
.dark .wish-love:hover    { background-color: #500724; }
.dark .wish-money:hover   { background-color: #451a03; }
.dark .wish-study:hover   { background-color: #172554; }
.dark .wish-victory:hover { background-color: #450a0a; }
.dark .wish-protect:hover { background-color: #1f2937; }
.dark .wish-success:hover { background-color: #3b0764; }

/* 3. 授与エリア (結果表示) */
.omamori-stage {
    background-color: var(--card-bg);
    border: 8px double var(--card-border); /* 神棚っぽい枠 */
    border-radius: 20px;
    padding: 40px 20px;
    position: relative;
    margin-bottom: 30px;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 400px;
}
/* ステージの背景装飾 */
.omamori-stage::before {
    content: '';
    position: absolute;
    width: 200px;
    height: 200px;
    background: radial-gradient(circle, var(--accent-red) 0%, transparent 70%);
    opacity: 0.05;
    border-radius: 50%;
    z-index: 0;
}

        /* --- 都道府県ランキング：ダッシュボードUI --- */

/* 1. TOP3エリア (横並び・強調) */
.pref-top3-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-bottom: 40px;
}
@media (min-width: 768px) {
    .pref-top3-container {
        flex-direction: row;
        align-items: flex-end; /* 1位を一番高く見せる演出も可だが、今回は揃える */
        justify-content: center;
    }
}

/* 2. TOP3カード */
.pref-card-top {
    flex: 1;
    background-color: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 20px;
    padding: 24px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    transition: transform 0.3s;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}
.pref-card-top:hover {
    transform: translateY(-5px);
}

/* 順位ごとの装飾 */
.top-rank-1 {
    border: 2px solid #d4af37;
    background: linear-gradient(to bottom right, #fff, #fffbef);
    z-index: 2; /* 真ん中に来た時手前に */
    transform: scale(1.05); /* 1位だけ少し大きく */
}
.top-rank-1:hover { transform: scale(1.08); }

.top-rank-2 { border-top: 6px solid #a0a0a0; }
.top-rank-3 { border-top: 6px solid #b87333; }

/* ダークモード調整 */
.dark .top-rank-1 { background: linear-gradient(to bottom right, #1a1a1a, #3f2c00); }

/* 王冠アイコン */
.pref-crown {
    font-size: 3rem;
    margin-bottom: 10px;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
}
.crown-gold   { color: #d4af37; }
.crown-silver { color: #a0a0a0; }
.crown-bronze { color: #b87333; }

/* 県名とスコア */
.pref-name-lg {
    font-size: 1.8rem;
    font-weight: 900;
    margin-bottom: 5px;
    font-family: 'Zen Old Mincho', serif;
}
.pref-score-lg {
    font-size: 2.5rem;
    font-weight: 900;
    font-family: monospace;
    line-height: 1;
    margin-bottom: 15px;
}
.pref-text-box {
    font-size: 0.85rem;
    text-align: justify;
    line-height: 1.6;
    color: var(--text-sub);
    background: rgba(0,0,0,0.03);
    padding: 10px;
    border-radius: 8px;
    width: 100%;
}

/* 3. 4位以下のグリッドリスト */
.pref-list-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); /* PCは2列 */
    gap: 16px;
}

/* 4位以下のカード */
.pref-card-normal {
    background-color: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 12px;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    transition: all 0.2s;
}
.pref-card-normal:hover {
    border-color: var(--accent-red);
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.pref-normal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.pref-rank-badge {
    background: var(--card-border);
    color: var(--text-sub);
    font-weight: bold;
    font-size: 0.8rem;
    padding: 2px 8px;
    border-radius: 4px;
}
.pref-score-sm {
    font-weight: 900;
    font-size: 1.2rem;
    color: var(--accent-red);
}

/* スコアバー */
.pref-bar-bg {
    width: 100%;
    height: 6px;
    background: #e5e7eb;
    border-radius: 3px;
    overflow: hidden;
}
.dark .pref-bar-bg { background: #3f3f46; }

.pref-bar-fill {
    height: 100%;
    border-radius: 3px;
    background: var(--accent-red);
}

/* ランクに応じたバーの色 */
.bar-S { background: #d4af37; } /* 金 */
.bar-A { background: #ef4444; } /* 赤 */
.bar-B { background: #3b82f6; } /* 青 */
.bar-C { background: #6b7280; } /* 灰 */

        /* --- 参拝の記録：ダッシュボードUI --- */

/* 1. ヒーローセクション (主要スコア) */
.stats-hero-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-bottom: 30px;
}

.stats-hero-card {
    background-color: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 20px;
    padding: 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 10px rgba(0,0,0,0.03);
}

/* 背景の巨大文字装飾 */
.stats-hero-card::after {
    content: attr(data-bg-text);
    position: absolute;
    bottom: -15px;
    right: -10px;
    font-size: 5rem;
    font-weight: 900;
    color: currentColor;
    opacity: 0.07;
    font-family: 'Zen Old Mincho', serif;
    pointer-events: none;
}

.stats-hero-label {
    font-size: 0.8rem;
    font-weight: bold;
    color: var(--text-sub);
    margin-bottom: 5px;
    z-index: 1;
}

.stats-hero-value {
    font-size: 2.2rem;
    font-weight: 900;
    font-family: monospace; /* 数字は見やすく */
    line-height: 1;
    z-index: 1;
}

/* 色分け */
.hero-total { color: var(--text-main); }
.hero-daikichi { color: #d4af37; border-color: #fcd34d; background: linear-gradient(to bottom right, #fff, #fffbef); }
.dark .hero-daikichi { background: linear-gradient(to bottom right, #1a1a1a, #3f2c00); border-color: #854d0e; }

/* 2. インサイトエリア (比較) */
.stats-insight-box {
    background-color: var(--card-bg);
    border-left: 4px solid var(--accent-red);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.stats-insight-text {
    font-size: 0.9rem;
    line-height: 1.8;
    color: var(--text-main);
}
.stats-insight-highlight {
    font-weight: 900;
    font-size: 1.2rem;
    color: var(--accent-red);
    margin: 0 4px;
}

/* 3. 運勢スペクトル (グラフ) */
.stats-graph-container {
    background-color: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 16px;
    padding: 24px;
    position: relative;
}

.stats-graph-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--card-border);
    padding-bottom: 10px;
}

.stats-row {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    height: 28px; /* 行の高さ固定 */
}

.stats-label-col {
    width: 60px;
    font-size: 0.75rem;
    font-weight: bold;
    color: var(--text-sub);
    flex-shrink: 0;
}

.stats-bar-area {
    flex: 1;
    height: 100%;
    position: relative;
    background: rgba(0,0,0,0.03);
    border-radius: 6px;
    overflow: hidden;
    margin: 0 10px;
    display: flex;
}

/* 2つのバーを重ねるためのスタイル */
.stats-bar-avg {
    height: 100%;
    background-color: #d1d5db; /* 平均はグレー */
    opacity: 0.5;
    border-right: 1px solid #fff;
}
.dark .stats-bar-avg { background-color: #52525b; border-right-color: #000; }

.stats-bar-user {
    height: 100%;
    background-color: var(--accent-red); /* 自分は赤 */
    position: absolute; /* 平均の上に重ねる */
    top: 0; left: 0;
    border-radius: 6px;
    opacity: 0.9;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    
    /* アニメーション用 */
    width: 0; 
    transition: width 1s cubic-bezier(0.22, 1, 0.36, 1);
}

/* 特別な色のバー */
.bar-color-gold { background-color: #d4af37 !important; } /* 大吉 */
.bar-color-black { background-color: #1f2937 !important; } /* 大凶 */
.dark .bar-color-black { background-color: #9ca3af !important; }

.stats-val-col {
    width: 80px;
    font-family: monospace;
    text-align: right;
    font-size: 0.75rem;
    color: var(--text-main);
    display: flex;
    flex-direction: column;
    justify-content: center;
    line-height: 1.1;
}
.val-sub {
    font-size: 0.65rem;
    color: #9ca3af;
}


/* --- 参拝の記録：インタラクティブUI & 独立グラフ --- */

/* クリック・ホバーできるカード */
.stats-card-interactive {
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    cursor: pointer;
    border: 1px solid var(--card-border);
    position: relative;
    z-index: 1;
    background-color: var(--card-bg);
    overflow: hidden; /* はみ出し防止 */
}

/* 浮き上がり＋赤枠エフェクト */
.stats-card-interactive:hover {
    transform: translateY(-4px) scale(1.01);
    box-shadow: 0 15px 30px -5px rgba(185, 28, 28, 0.15);
    border-color: var(--accent-red);
    z-index: 10;
}

/* グラフコンテナ */
.stats-graph-container {
    padding-top: 40px;
    margin-top: 20px;
    border-radius: 16px;
    position: relative;
}

/* 目盛り線（グリッド） */
.graph-grid-overlay {
    position: absolute;
    top: 45px;
    bottom: 20px;
    left: 70px; /* ラベル幅考慮 */
    right: 20px;
    pointer-events: none;
    z-index: 0;
}

.grid-line-item {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 1px;
    background-color: rgba(128, 128, 128, 0.1);
}

.grid-label-text {
    position: absolute;
    top: -20px;
    transform: translateX(-50%);
    font-size: 0.65rem;
    color: var(--text-sub);
    opacity: 0.5;
    font-family: monospace;
    white-space: nowrap;
}

/* グラフの行レイアウト (上下2段表示用) */
.stats-row-dual {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    position: relative;
    z-index: 1;
    padding-right: 20px; /* 右余白 */
}

.stats-label-modern {
    width: 70px;
    font-size: 0.75rem;
    font-weight: bold;
    color: var(--text-sub);
    flex-shrink: 0;
    padding-right: 10px;
    text-align: right;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    height: 100%;
}

/* バーエリア（縦に並べる） */
.stats-bar-area-dual {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px; /* バー同士の間隔 */
    justify-content: center;
}

/* バーの共通スタイル */
.stats-bar-base {
    height: 10px; /* 少し太さを持たせる */
    border-radius: 3px; /* 丸みのある四角 */
    width: 0; /* アニメーション前 */
    transition: width 1s cubic-bezier(0.22, 1, 0.36, 1);
    position: relative;
}

/* 色定義 */
.bar-gold  { background-color: #d4af37; } /* 大吉: 黄金 */
.dark .bar-gold { background-color: #fbbf24; }

.bar-black { background-color: #374151; } /* 大凶: 黒灰 */
.dark .bar-black { background-color: #9ca3af; }

.bar-red   { background-color: var(--accent-red); } /* その他: 紅 */

/* 平均バー（薄いグレー） */
.bar-avg   { background-color: #e5e7eb; }
.dark .bar-avg { background-color: #3f3f46; }

/* 値のラベル（バーの横に出す場合） */
.bar-val-label {
    margin-left: 4px;
    font-size: 0.65rem;
    color: var(--text-sub);
    opacity: 0.8;
    line-height: 1;
    white-space: nowrap;
    position: absolute;
    left: 100%;
    top: 50%;
    transform: translateY(-50%);
}

        /* --- アカウント設定：Bento Profile UI --- */

/* プロフィール用グリッドレイアウト */
.profile-bento-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 20px;
    max-width: 900px;
    margin: 0 auto;
    padding-bottom: 60px;
}

/* 1. IDカード (左上) */
.profile-card-identity {
    grid-column: span 12;
    background: linear-gradient(135deg, var(--card-bg) 60%, var(--bg-color) 100%);
    display: flex;
    flex-direction: row; /* PCは横並び */
    align-items: center;
    gap: 24px;
}
@media (min-width: 768px) {
    .profile-card-identity { grid-column: span 7; }
}

/* アイコンリング */
.profile-icon-ring {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 3px double var(--accent-red);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    color: var(--text-main);
    background-color: var(--bg-color);
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

/* 2. ステータスカード (右上) */
.profile-card-status {
    grid-column: span 12;
    background-color: var(--card-bg);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: flex-start;
}
@media (min-width: 768px) {
    .profile-card-status { grid-column: span 5; }
}

/* 3. 編集フォーム (左下・メイン) */
.profile-card-edit {
    grid-column: span 12;
}
@media (min-width: 768px) {
    .profile-card-edit { grid-column: span 8; }
}

/* 4. デンジャーゾーン (右下) */
.profile-card-danger {
    grid-column: span 12;
}
@media (min-width: 768px) {
    .profile-card-danger { grid-column: span 4; }
}

/* 入力欄のモダン化 */
.profile-input-group {
    margin-bottom: 16px;
}
.profile-input-label {
    display: block;
    font-size: 0.75rem;
    font-weight: bold;
    color: var(--text-sub);
    margin-bottom: 6px;
}
.profile-input-field {
    width: 100%;
    padding: 12px 16px;
    border-radius: 12px;
    border: 1px solid var(--card-border);
    background-color: var(--input-bg);
    color: var(--text-main);
    font-size: 0.95rem;
    transition: all 0.2s;
}
.profile-input-field:focus {
    border-color: var(--accent-red);
    box-shadow: 0 0 0 3px rgba(185, 28, 28, 0.1);
    outline: none;
}

/* 会員バッジ装飾 */
.member-rank-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: bold;
    letter-spacing: 0.05em;
    background: #fffbeb;
    color: #b45309;
    border: 1px solid #fcd34d;
}
.dark .member-rank-badge {
    background: #451a03;
    color: #fbbf24;
    border-color: #92400e;
}

        /* --- 認証画面：Bento Auth UI --- */

.auth-bento-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    max-width: 600px;
    margin: 0 auto;
}

/* 選択カード (ログイン/登録) */
.auth-action-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 30px 20px;
    text-align: center;
    border-radius: 20px;
    background-color: var(--card-bg);
    transition: all 0.3s;
    height: 100%;
    min-height: 180px;
}

/* アイコン装飾 */
.auth-icon-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    margin-bottom: 15px;
    transition: transform 0.3s;
}
.auth-action-card:hover .auth-icon-circle {
    transform: scale(1.1) rotate(10deg);
}

/* 説明エリア (下部) */
.auth-info-card {
    grid-column: span 2;
    background: linear-gradient(135deg, var(--card-bg) 0%, var(--bg-color) 100%);
    padding: 20px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    gap: 15px;
}

/* フォームコンテナ (入力・認証) */
.auth-form-container {
    max-width: 400px;
    margin: 0 auto;
    background-color: var(--card-bg);
    padding: 30px;
    border-radius: 24px;
}

/* 認証コード入力欄 (特別仕様) */
.auth-code-input-modern {
    width: 100%;
    height: 70px;
    font-size: 2.5rem;
    letter-spacing: 0.5em; /* 文字間隔を広く */
    text-align: center;
    border: 2px solid var(--card-border);
    border-radius: 12px;
    background-color: var(--input-bg);
    color: var(--text-main);
    font-family: monospace; /* 等幅フォント */
    font-weight: bold;
    outline: none;
    transition: all 0.3s;
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
}
.auth-code-input-modern:focus {
    border-color: var(--accent-red);
    box-shadow: 0 0 0 4px rgba(185, 28, 28, 0.1);
    transform: scale(1.02);
}

        /* --- おみくじ選択・結果画面：Bento UI拡張 --- */

/* 1. 選択画面のヘッダーカード */
.draw-header-card {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--card-border);
    border-radius: 24px;
    padding: 20px;
    margin: 20px auto;
    max-width: 600px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
    text-align: center;
    position: relative;
    z-index: 20;
}
.dark .draw-header-card {
    background: rgba(30, 30, 30, 0.85);
    border-color: rgba(255, 255, 255, 0.1);
}

/* 2. 結果画面のアクショングリッド */
.result-action-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    max-width: 600px;
    margin: 24px auto 0;
}

/* アクションカードボタン */
.action-card-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px 10px;
    border-radius: 16px;
    background-color: var(--card-bg);
    border: 1px solid var(--card-border);
    color: var(--text-main);
    font-weight: bold;
    font-size: 0.9rem;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    box-shadow: 0 4px 6px rgba(0,0,0,0.02);
}
.action-card-btn:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1);
    z-index: 10;
}

/* アイコンサイズ */
.action-card-btn i, .action-card-btn svg {
    font-size: 1.8rem;
    margin-bottom: 8px;
    width: 28px;
    height: 28px;
}

/* 主要アクション（保存など）の強調 */
.action-primary {
    background-color: var(--accent-red);
    color: white;
    border-color: var(--accent-red);
}
.action-primary:hover {
    background-color: #a01818; /* 少し濃く */
}

/* SNSごとの色 */
.btn-x { color: #000; } .dark .btn-x { color: #fff; }
.btn-line { color: #06c755; }
.btn-fb { color: #1877f2; }
.btn-bsky { color: #0285ff; }
.btn-misskey { color: #86b300; }

        /* --- TENMEI Labs: グラス・コントロールパネルUI --- */

/* 1. ラボ用グリッド */
.lab-grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
    position: relative;
    z-index: 10;
}

/* 2. ガラスカード (カプセル) */
.lab-glass-card {
    background: rgba(255, 255, 255, 0.65);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.6);
    border-radius: 20px;
    padding: 20px;
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
    cursor: pointer;
    display: flex;
    flex-direction: column;
}

.dark .lab-glass-card {
    background: rgba(30, 30, 30, 0.6);
    border-color: rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

/* ホバー時の発光 */
.lab-glass-card:hover {
    transform: translateY(-4px) scale(1.02);
    background: rgba(255, 255, 255, 0.8);
    border-color: var(--accent-red);
    box-shadow: 0 15px 40px rgba(185, 28, 28, 0.15);
}
.dark .lab-glass-card:hover {
    background: rgba(40, 40, 40, 0.8);
    border-color: var(--accent-gold);
}

/* 3. カード内レイアウト */
.lab-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.lab-icon-box {
    width: 50px;
    height: 50px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: #fff;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

/* アイコン背景色バリエーション */
.icon-bg-red    { background: linear-gradient(135deg, #ef4444, #b91c1c); }
.icon-bg-blue   { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
.icon-bg-yellow { background: linear-gradient(135deg, #eab308, #b45309); }
.icon-bg-purple { background: linear-gradient(135deg, #a855f7, #7e22ce); }
.icon-bg-green  { background: linear-gradient(135deg, #10b981, #047857); }
.icon-bg-gray   { background: linear-gradient(135deg, #6b7280, #374151); }
.icon-bg-gold   { background: linear-gradient(135deg, #fbbf24, #d97706); }

/* スイッチ (右上配置) */
.lab-switch-wrapper {
    position: relative;
    z-index: 20; /* クリック優先 */
}

/* タイトルと説明 */
.lab-card-body h3 {
    font-size: 1.1rem;
    font-weight: 900;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.lab-card-desc {
    font-size: 0.8rem;
    color: var(--text-sub);
    line-height: 1.6;
    margin-bottom: 12px;
    opacity: 0.9;
}

/* ステータスバッジ */
.lab-badge {
    font-size: 0.65rem;
    padding: 2px 8px;
    border-radius: 12px;
    font-weight: bold;
    letter-spacing: 0.05em;
    text-transform: uppercase;
}
.badge-stable { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
.badge-beta   { background: #ffedd5; color: #9a3412; border: 1px solid #fed7aa; }
.badge-exp    { background: #f3e8ff; color: #6b21a8; border: 1px solid #d8b4fe; }
.badge-danger { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

.dark .badge-stable { background: #064e3b; color: #86efac; border-color: #065f46; }
.dark .badge-beta   { background: #431407; color: #fdba74; border-color: #7c2d12; }
.dark .badge-exp    { background: #3b0764; color: #d8b4fe; border-color: #581c87; }
.dark .badge-danger { background: #450a0a; color: #fca5a5; border-color: #7f1d1d; }

/* フッター (詳細へ) */
.lab-card-footer {
    margin-top: auto;
    padding-top: 10px;
    border-top: 1px dashed rgba(128,128,128,0.2);
    font-size: 0.75rem;
    color: var(--text-sub);
    text-align: right;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 5px;
    opacity: 0.7;
    transition: opacity 0.2s;
}
.lab-glass-card:hover .lab-card-footer {
    opacity: 1;
    color: var(--accent-red);
}
        
        .history-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            text-align: center;
            border: 1px solid var(--card-border);
            width: 80%;
            max-width: 400px;
        }

        /* --- 修正版：TENMEI Labs ロック画面スタイル --- */

/* 1. ロック画面のコンテナ (位置合わせ専用・クリック透過) */
.lab-lock-container {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 9999 !important; /* 最前面を強制 */
    pointer-events: none;     /* コンテナ自体はクリックを通す */
    /* フレックスボックスで中央揃え (HTMLのクラスと合わせて制御) */
    display: flex;
    align-items: center;
    justify-content: center;
}

/* 2. ロック画面のカード本体 (見た目専用・クリック有効) */
.lab-lock-card {
    pointer-events: auto; /* カード内のボタン等はクリック可能に */
    background-color: rgba(255, 255, 255, 0.98) !important; /* ほぼ不透明な白 */
    border: 1px solid var(--card-border);
    border-radius: 24px;
    padding: 40px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 25px 60px rgba(0,0,0,0.5); /* 強い影で浮き上がらせる */
    
    /* ★重要：ぼかしを強制解除し、不透明度を確保 */
    filter: none !important; 
    opacity: 1 !important;
    backdrop-filter: none !important; 
    transform: translateZ(0); /* 描画レイヤーを分離 */
}

/* ダークモード時のカードスタイル */
.dark .lab-lock-card {
    background-color: rgba(20, 20, 20, 0.98) !important; /* ほぼ不透明な黒 */
    border-color: rgba(255, 255, 255, 0.15);
}

/* コンテンツ側のぼかし (ここはそのまま) */
.lab-blurred {
    filter: blur(15px);
    opacity: 0.4;
    pointer-events: none;
    user-select: none;
    transition: all 0.5s;
}

        /* 詳細モーダル (削除予定だが互換性のために残す) */
        #history-detail-modal {
            display: none; 
        }

        /* 記事詳細 */
        .article-container {
            max-width: 800px; margin: 0 auto; padding: 40px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: left; line-height: 2;
        }
        .article-header { border-bottom: 2px solid var(--card-border); padding-bottom: 20px; margin-bottom: 30px; }
        .article-title { font-size: 1.8rem; font-weight: bold; margin-bottom: 10px; }
        .article-meta { color: var(--text-sub); font-size: 0.9rem; display: flex; gap: 15px; }
        .article-tag { background: rgba(128,128,128,0.2); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
        .article-content h3 { font-size: 1.4rem; font-weight: bold; margin: 30px 0 15px; border-left: 4px solid var(--accent-red); padding-left: 10px; }
        .article-content p { margin-bottom: 20px; }

        /* --- TENMEI Labs モダンUI用スタイル (Google Labs風) --- */
        
        /* カード全体の設定 */
        #view-lab {
            position: relative;
            border-radius: 30px;
            min-height: 85vh;
            overflow: hidden; /* はみ出た背景をカット */
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            margin-top: 20px;
            margin-bottom: 40px;
        }

        /* 1. 背景のアニメーションレイヤー */
        .lab-modern-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0;
            background-color: #f8f9fa; /* ベース色 */
        }
        .dark .lab-modern-bg { background-color: #0f0f12; }

        /* 2. 動く色の塊 (Blob) */
        .lab-blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px); /* 色をぼかす */
            opacity: 0.8;
            animation: moveBlob 15s infinite alternate ease-in-out;
        }

        /* 色と配置の定義 */
        /* ピンク */
        .blob-1 { top: -10%; left: -10%; width: 500px; height: 500px; background: #ff9a9e; animation-delay: 0s; }
        /* 紫 */
        .blob-2 { bottom: -10%; right: -10%; width: 500px; height: 500px; background: #a18cd1; animation-delay: -5s; }
        /* 薄いピンク */
        .blob-3 { top: 40%; left: 40%; width: 400px; height: 400px; background: #fbc2eb; animation-delay: -10s; }
        /* ミントグリーン */
        .blob-4 { bottom: 10%; left: 10%; width: 300px; height: 300px; background: #84fab0; animation-delay: -2s; }
        /* 青 */
        .blob-5 { top: 10%; right: 10%; width: 350px; height: 350px; background: #4facfe; animation-delay: -7s; }

        /* ダークモード時の色調整 (少し暗く・透明度下げる) */
        .dark .blob-1 { background: #5e2b30; opacity: 0.4; }
        .dark .blob-2 { background: #3b2e5a; opacity: 0.4; }
        .dark .blob-3 { background: #5a3a50; opacity: 0.4; }
        .dark .blob-4 { background: #1a4a35; opacity: 0.4; }
        .dark .blob-5 { background: #1a3a5e; opacity: 0.4; }

        /* アニメーション定義: ゆっくり動いて拡大縮小 */
        @keyframes moveBlob {
            0% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(40px, -60px) scale(1.2); }
            66% { transform: translate(-30px, 30px) scale(0.8); }
            100% { transform: translate(20px, 20px) scale(1.1); }
        }

        /* 3. コンテンツラッパー (背景の上に表示) */
        .lab-content-relative {
            position: relative;
            z-index: 10;
        }

        /* 4. 縦書き装飾テキスト */
        .lab-vertical-deco {
            position: absolute;
            top: 30px;
            left: 20px;
            writing-mode: vertical-rl;
            font-size: 4rem;
            font-weight: 900;
            color: rgba(0,0,0,0.03); /* ほぼ透明 */
            pointer-events: none;
            line-height: 1;
            font-family: 'Zen Old Mincho', serif;
            z-index: 1;
        }
        .dark .lab-vertical-deco { color: rgba(255,255,255,0.05); }

        /* 5. モダンカードスタイル */
        .lab-card-modern {
            background: rgba(255, 255, 255, 0.85); /* 半透明の白 */
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s;
            border: 1px solid rgba(255,255,255,0.6);
            display: flex;
            justify-content: space-between; /* 左右配置 */
            align-items: center;
            backdrop-filter: blur(10px); /* すりガラス効果 */
        }
        .dark .lab-card-modern {
            background: rgba(30, 30, 30, 0.8);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.05);
        }
        .lab-card-modern:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
        }

        /* ヒーローエリア (タイトル周り) */
        .lab-hero-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 60px 0 60px;
            text-align: center;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: "";
            height: 16px; width: 16px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #6366f1; } /* インディゴ系に変更 */
        input:checked + .slider:before { transform: translateX(26px); }

        /* --- TENMEI Labs: Unified Real Flask --- */

/* 1. タイトル用フラスコ (メイン) */
.title-flask-anim {
    width: 160px;
    height: 160px;
    margin: 0 auto 10px;
    /* 綺麗な発光感 */
    filter: drop-shadow(0 15px 30px rgba(120, 80, 255, 0.3));
}

/* 2. サイドバー用アイコン (左側) */
.nav-flask-anim {
    width: 32px;
    height: 32px;
    display: block;
}

/* フラスコ全体の揺れ (共通) */
.flask-container {
    transform-origin: 100px 20px; /* 首元を支点に揺れる */
    animation: flaskSwing 4s ease-in-out infinite;
}

/* 中身の液体の慣性 (共通) */
.liquid-container {
    transform-origin: 100px 150px;
    animation: liquidInertia 4s ease-in-out infinite;
}

/* 波のアニメーション */
.wave-path {
    fill: url(#gradUnified); /* 共通の鮮やかなグラデーション */
    animation: waveMove 2s linear infinite;
}

/* メイン用: 奥の波 (薄く表示して立体感を出す) */
.wave-back {
    opacity: 0.4;
    animation: waveMove 3s linear infinite reverse;
}

/* メイン用: 手前の波 (くっきり) */
.wave-front {
    opacity: 0.95;
}

/* ガラスの質感 */
.glass-stroke {
    fill: rgba(255, 255, 255, 0.05);
    stroke: #333;
    stroke-width: 6;
    stroke-linecap: round;
    stroke-linejoin: round;
}
.dark .glass-stroke { stroke: #e0e0e0; }

/* 泡 */
.bubble {
    fill: rgba(255, 255, 255, 0.5);
    animation: bubbleUp 3s ease-in infinite;
}

/* --- アニメーション定義 --- */

/* フラスコ本体の揺れ（角度を4deg→10degにアップ） */
@keyframes flaskSwing {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(10deg); }  /* 右に大きく揺れる */
    75% { transform: rotate(-10deg); } /* 左に大きく揺れる */
}

/* 中身の液体の動き（本体と逆方向に大きく傾ける） */
@keyframes liquidInertia {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(-8deg); } /* 本体が右なら、水面は左へ */
    75% { transform: rotate(8deg); }  /* 本体が左なら、水面は右へ */
}

@keyframes waveMove {
    0% { transform: translateX(0) scaleY(1); }
    50% { transform: translateX(-100px) scaleY(1.05); }
    100% { transform: translateX(-200px) scaleY(1); }
}

@keyframes bubbleUp {
    0% { transform: translateY(0) scale(0.4); opacity: 0; }
    20% { opacity: 1; }
    100% { transform: translateY(-80px) scale(1.2); opacity: 0; }
}

        /* --- Bento Grid UI (モダン・グリッドレイアウト) --- */
        .bento-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-auto-rows: minmax(100px, auto); /* 行の高さを自動調整 */
            gap: 20px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding-bottom: 60px;
        }

        .bento-card {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 24px; /* 角丸を大きくモダンに */
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        .bento-card:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: var(--accent-red); /* ホバー時に紅色の枠 */
            z-index: 10;
        }

        /* 挨拶エリア（ヘッダー） */
        .bento-welcome {
            grid-column: span 12; /* 横幅いっぱい */
            background: linear-gradient(135deg, var(--card-bg) 0%, var(--bg-color) 100%);
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            min-height: 120px;
        }

        /* タイトルエリア */
        .bento-title {
            grid-column: span 8;
            grid-row: span 2;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background-image: var(--bg-pattern);
        }

        /* アクションエリア（おみくじを引く） */
        .bento-action {
            grid-column: span 4;
            grid-row: span 2;
            background-color: var(--accent-red);
            color: white;
            border: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            text-align: center;
        }
        .bento-action:hover {
            background-color: #a01818; /* 少し濃く */
        }
        .bento-action h3 {
            font-size: 1.5rem;
            font-weight: 900;
            margin-bottom: 10px;
        }
        
        /* 統計エリア・ニュース・コラム */
        .bento-stats { grid-column: span 4; grid-row: span 2; }
        .bento-news  { grid-column: span 4; grid-row: span 2; }
        .bento-col   { grid-column: span 4; grid-row: span 2; }

        /* カウンター小窓 */
        .bento-mini {
            grid-column: span 6;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 15px;
        }

        /* --- モバイル対応（1カラムにする） --- */
        @media (max-width: 768px) {
            .bento-grid {
                display: flex;
                flex-direction: column;
            }
            .bento-card {
                min-height: auto;
            }
            /* モバイルでは挨拶エリアを縦並びに */
            .bento-welcome {
                flex-direction: column;
                text-align: center;
                gap: 10px;
                padding: 30px;
            }
        }
        
        /* --- 12星座占い モダンUI --- */
        
        /* 入力エリアのグリッド */
        .zodiac-input-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        /* 選択セレクトボックスのモダン化 */
        .modern-select {
            appearance: none;
            background-color: var(--input-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 16px;
            font-size: 1rem;
            color: var(--text-main);
            width: 100%;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23888' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
        }
        .modern-select:hover, .modern-select:focus {
            border-color: var(--accent-red);
            box-shadow: 0 0 0 4px rgba(185, 28, 28, 0.1);
            outline: none;
        }

        /* 判定ボタン */
        .modern-search-btn {
            background-color: var(--accent-red);
            color: white;
            border: none;
            border-radius: 16px;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(185, 28, 28, 0.3);
        }
        .modern-search-btn:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }
        .modern-search-btn:active {
            transform: translateY(0);
        }

        /* --- 12星座占い 新カードスタイル (修正・完全版) --- */

        /* カード全体（背景は強制的に白、枠線で順位を表現） */
        .zodiac-card-box {
            background-color: var(--card-bg) !important; /* ★ここ重要：背景色を強制 */
            border: 1px solid var(--card-border);
            border-radius: 16px;
            margin-bottom: 20px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); /* 影を統一 */
            overflow: hidden;
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
        }
        
        /* ランク別の枠線スタイル (クラス名を変更して干渉を回避) */
        /* 1位: 金枠＋太い左線 */
        .zodiac-card-box.card-rank-1 { 
            border: 2px solid #d4af37; 
            border-left-width: 6px; 
        }
        /* 2位: 銀枠＋太い左線 */
        .zodiac-card-box.card-rank-2 { 
            border: 2px solid #a0a0a0; 
            border-left-width: 6px; 
        }
        /* 3位: 銅枠＋太い左線 */
        .zodiac-card-box.card-rank-3 { 
            border: 2px solid #b87333; 
            border-left-width: 6px; 
        }
        /* 4位以下: 通常枠＋左線のみ */
        .zodiac-card-box.card-rank-normal { 
            border-left: 4px solid var(--card-border); 
        }

        /* ダークモード対応 */
        .dark .zodiac-card-box {
            background-color: var(--card-bg) !important;
        }

        /* コンテンツエリア */
        .zodiac-card-body {
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* PC/タブレット以上で横並び */
        @media (min-width: 768px) {
            .zodiac-card-body {
                flex-direction: row;
                align-items: flex-start;
            }
        }

        /* 中央コンテンツエリア（文章とカレンダーを横並びにする） */
        .zodiac-content-middle {
            flex: 1;
            min-width: 0;
            display: flex;
            gap: 15px;
        }
        @media (max-width: 600px) {
            .zodiac-content-middle {
                flex-direction: column; /* スマホ極小画面では縦に戻す */
            }
        }

        /* 文章エリア */
        .zodiac-text-area {
            flex: 1;
        }

        /* コンパクトカレンダーエリア（右側配置用） */
        .zodiac-compact-calendar {
            width: 130px; /* 固定幅でコンパクトに */
            flex-shrink: 0;
            background-color: rgba(128,128,128,0.03);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 6px;
            text-align: center;
        }
        .zodiac-compact-calendar h4 {
            font-size: 0.6rem;
            color: var(--text-sub);
            margin-bottom: 4px;
            font-weight: bold;
        }

        /* カレンダーグリッド (6列で配置) */
        .zodiac-cal-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr); 
            gap: 3px;
            margin-top: 5px;
        }

        /* カレンダーのセル (丸みを帯びさせる) */
        .zodiac-cal-cell {
            background: var(--bg-color);
            border: 1px solid var(--card-border);
            border-radius: 6px; /* ★ここを修正: 角を丸く */
            height: 24px; /* アイコンが入るよう少し高さを確保 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        /* 日付の文字 */
        .zodiac-cal-date {
            font-size: 0.55rem;
            line-height: 1;
            color: var(--text-sub);
            font-weight: bold;
        }

        /* マークエリア */
        .zodiac-cal-marks {
            display: flex;
            justify-content: center;
            gap: 1px;
            margin-top: 1px;
            line-height: 1;
        }
        /* カレンダー内の極小アイコン */
        .zodiac-cal-marks i {
            font-size: 0.5rem; /* かなり小さくして収める */
        }

        /* マークがある日の強調（背景色を薄くつける） */
        .zodiac-cal-cell.has-mark {
            background-color: #fffbef;
            border-color: #fcd34d;
        }
        .dark .zodiac-cal-cell.has-mark {
            background-color: #3f2c00;
            border-color: #854d0e;
        }

        /* ランクバッジ */
        .zodiac-rank-badge {
            width: 40px; height: 40px;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 1.2rem;
            color: white;
            flex-shrink: 0;
        }
        /* バッジの色 */
        .badge-gold   { background: linear-gradient(135deg, #ffd700, #fdb931); }
        .badge-silver { background: linear-gradient(135deg, #e0e0e0, #bdbdbd); color: #555; }
        .badge-bronze { background: linear-gradient(135deg, #cd7f32, #a0522d); }
        .badge-normal { background: var(--card-border); color: var(--text-sub); font-size: 1rem; }

        /* お気に入りボタン（名前の横） */
        .fav-star-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: #ccc;
            transition: transform 0.2s, color 0.2s;
            margin-left: 5px;
            padding: 0 5px;
            line-height: 1;
        }
        .fav-star-btn.active {
            color: #facc15; /* 黄色 */
            transform: scale(1.1);
        }
        .fav-star-btn:hover {
            color: #facc15;
        }
        
        /* 認証コード入力欄（和風） */
        .auth-code-input-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            position: relative;
        }
        .auth-code-input {
            width: 300px;
            height: 60px;
            font-size: 2rem;
            letter-spacing: 0.8em;
            text-align: center;
            border: 3px double var(--accent-red);
            background-color: var(--omi-paper);
            color: var(--text-main);
            font-family: 'Zen Old Mincho', serif;
            border-radius: 4px;
            outline: none;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .auth-code-input:focus {
            box-shadow: 0 0 10px rgba(185, 28, 28, 0.3);
            background-color: #fff;
        }
        .auth-code-deco {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            padding: 0 10px;
            font-size: 0.8rem;
            color: var(--accent-red);
            font-weight: bold;
        }

        /* 認証初期選択画面 */
        .auth-selection-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.3s;
            border: 1px solid var(--card-border);
            background-color: var(--card-bg);
            color: var(--text-main);
        }
        .auth-selection-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            background-color: rgba(128,128,128,0.05);
        }
        .auth-selection-btn i {
            font-size: 1.5rem;
            margin-right: 15px;
        }

        /* 検索フォームスタイル */
        .search-form-container {
            padding: 15px;
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .search-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .search-input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--card-border);
            background-color: var(--input-bg);
            color: var(--text-main);
            font-size: 0.9rem;
        }

        /* 比較表のスタイル */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.9rem;
        }
        .comparison-table th, .comparison-table td {
            border: 1px solid var(--card-border);
            padding: 12px;
            text-align: center;
        }
        .comparison-table th {
            background-color: rgba(128,128,128,0.1);
            font-weight: bold;
        }
        .comparison-table td.highlight {
            background-color: rgba(185, 28, 28, 0.05);
            font-weight: bold;
            color: var(--accent-red);
        }
        .comparison-table tr:nth-child(even) {
            background-color: rgba(128,128,128,0.02);
        }
        
        /* Labs: 言霊の増幅 (文字サイズ拡大) */
        html.lab-big-text {
            font-size: 120%; /* 基準サイズを20%アップ (rem単位の全ての文字が大きくなります) */
        }
        /* 固定ピクセル指定(text-[10px]等)も無理やり大きくする補正 */
        html.lab-big-text .text-\[10px\] { font-size: 12px !important; }

        /* --- カード展開アニメーション (Google Labs風) --- */

/* モーダルオーバーレイ */
.lab-modal-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.95);
    z-index: 2000;
    display: none; /* JSで制御 */
    opacity: 0;
    transition: opacity 0.3s ease;
    overflow-y: auto;
    padding: 20px;
    align-items: center;
    justify-content: center;
}
.dark .lab-modal-overlay { background: rgba(18, 18, 18, 0.95); }
.lab-modal-overlay.active { display: flex; opacity: 1; }

/* 展開されるカード */
.lab-modal-card {
    background: #fff;
    width: 100%;
    max-width: 600px;
    border-radius: 24px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    padding: 40px;
    position: relative;
    transform: scale(0.9);
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    border: 1px solid rgba(0,0,0,0.05);
}
.dark .lab-modal-card {
    background: #1e1e1e;
    border: 1px solid rgba(255,255,255,0.1);
}
.lab-modal-overlay.active .lab-modal-card { transform: scale(1); }

/* 閉じるボタン */
.lab-close-btn {
    position: absolute;
    top: 20px; right: 20px;
    background: #f0f0f0;
    border: none;
    width: 40px; height: 40px;
    border-radius: 50%;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.2s;
}
.dark .lab-close-btn { background: #333; color: #fff; }
.lab-close-btn:hover { background: #e0e0e0; }

/* カード自体のクリックを促すスタイル */
.lab-card-modern {
    cursor: pointer; /* クリック可能に見せる */
}

/* スイッチ部分はクリックイベントを伝播させないための調整 */
.lab-card-modern .toggle-switch {
    z-index: 5; /* カードクリックより優先 */
}
       /* --- 隠しコマンド（イースターエッグ）演出用 --- */
        #secret-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000;
            z-index: 99999; /* 最前面 */
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #0f0; /* ターミナルグリーン */
            font-family: 'Courier New', monospace;
            padding: 20px;
            overflow: hidden;
        }
        #secret-overlay.active { display: flex; }
        
        .secret-text {
            font-size: 1.2rem;
            line-height: 1.5;
            white-space: pre-wrap;
            text-align: left;
            max-width: 600px;
            width: 100%;
            margin-bottom: 20px;
            opacity: 0;
            animation: fadeInTerminal 0.1s forwards;
        }
        .secret-cursor::after {
            content: '▋';
            animation: blinkCursor 1s infinite;
        }

        @keyframes blinkCursor { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        @keyframes fadeInTerminal { from { opacity: 0; } to { opacity: 1; } } 

        /* --- TENMEI Labs: 追加機能スタイル --- */

        /* --- 幽玄の霧 (超はっきり・高密度版) --- */
        #mist-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* 下のボタンを押せるようにする */
            z-index: 500; /* 全ての要素の上に重ねる */
            opacity: 0; /* 初期は透明 */
            visibility: hidden;
            transition: opacity 2s ease, visibility 2s; /* 消える時もふわっと */
            overflow: hidden;
        }

        /* ONの時に付与されるクラス */
        #mist-container.active {
            opacity: 1;
            visibility: visible;
        }

        .mist-blob {
            position: absolute;
            width: 80%;
            height: 80%;
            background: radial-gradient(circle, 
                rgba(255, 255, 255, 0.9) 0%, 
                rgba(255, 255, 255, 0.4) 50%, 
                transparent 80%);
            filter: blur(60px);
            animation: mistRotate 30s linear infinite;
        }

        /* ダークモード時は「深い霧」にするため青白く調整 */
        .dark .mist-blob {
            background: radial-gradient(circle, 
                rgba(200, 220, 255, 0.4) 0%, 
                rgba(100, 150, 255, 0.1) 50%, 
                transparent 80%);
        }

        /* 3つの巨大な霧の塊を違う動きで回す */
        .mist-1 { top: -10%; left: -10%; animation-duration: 25s; }
        .mist-2 { bottom: -10%; right: -10%; animation-duration: 40s; animation-direction: reverse; }
        .mist-3 { top: 40%; left: 30%; animation-duration: 35s; opacity: 0.6; }

        @keyframes mistRotate {
            0% { transform: translate(0, 0) rotate(0deg) scale(1); }
            33% { transform: translate(10%, 5%) rotate(120deg) scale(1.2); }
            66% { transform: translate(-5%, 10%) rotate(240deg) scale(0.8); }
            100% { transform: translate(0, 0) rotate(360deg) scale(1); }
        }

        /* 2. 黄金の神域 (Gold Theme Override) */
        body.theme-gold {
            --accent-red: #d4af37 !important; /* ゴールド */
            --accent-gold: #b8860b !important; /* 濃い金 */
        }
        body.theme-gold .btn-primary {
            background: linear-gradient(135deg, #f1c40f, #d4af37) !important;
            color: #3e1e00 !important;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4) !important;
        }
        body.theme-gold .text-red-600, 
        body.theme-gold .text-red-700,
        body.theme-gold .text-red-500 {
            color: #b8860b !important;
        }
        body.theme-gold .border-red-500,
        body.theme-gold .border-red-600 {
            border-color: #d4af37 !important;
        }

        /* --- PDF・印刷用スタイル (ベクター出力・表見切れ防止) --- */
        @media print {
            @page {
                size: A4;
                margin: 20mm;
            }
            body {
                background: #fff !important;
                color: #000 !important;
                display: block !important;
                height: auto !important;
                overflow: visible !important;
            }
            /* 不要な要素を消す */
            #sidebar, #mist-container, #loading-overlay, 
            .nav-btn, .btn-primary, .btn-outline, 
            #about-toc-container, #privacy-toc-container,
            #result-capture-container, button {
                display: none !important;
            }
            /* メインコンテンツの調整 */
            #main-content {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
            }
            .view-section {
                display: none !important; /* 一旦全部消す */
            }
            /* 印刷対象のセクションだけ表示 */
            .view-section.printing {
                display: block !important;
                opacity: 1 !important;
            }
            
            /* カードの枠などを消して文書らしくする */
            .themed-card {
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                background: transparent !important;
                color: #000 !important;
            }
            
            /* 表の見切れ防止・最適化 */
            .overflow-x-auto {
                overflow: visible !important;
                display: block !important;
                width: 100% !important;
            }
            table, .comparison-table {
                width: 100% !important;
                min-width: 0 !important; /* 横幅強制解除 */
                table-layout: fixed !important; /* 列幅を均等または指定通りに */
                border-collapse: collapse !important;
                font-size: 8pt !important; /* 表の文字を少し小さくして収める */
                page-break-inside: auto;
            }
            tr { 
                page-break-inside: avoid; 
                page-break-after: auto; 
            }
            th, td {
                border: 1px solid #000 !important; /* 枠線を黒く鮮明に */
                padding: 4px !important;
                color: #000 !important;
                word-wrap: break-word !important; /* 長い文字を折り返す */
                white-space: normal !important; /* 改行を許可 */
            }
            /* 背景色があるセル */
            .bg-gray-200, .bg-gray-50, .bg-red-100 {
                background-color: #f0f0f0 !important; /* 薄いグレーに統一 */
                -webkit-print-color-adjust: exact; /* 背景色を強制印刷 */
                print-color-adjust: exact;
            }
            /* リンクのURL表示を消す */
            a[href]:after {
                content: none !important;
            }
            /* テキスト調整 */
            h2, h3, h4 {
                page-break-after: avoid;
                color: #000 !important;
                border-bottom: 1px solid #000 !important;
            }
            p, li {
                color: #000 !important;
            }
        }

        /* --- 御守授与所スタイル (修正版) --- */
        
        /* 御守本体 */
        .omamori-body {
            width: 220px;
            height: 400px; /* 高さを少し増やしてバランス調整 */
            position: relative;
            margin: 0 auto;
            /* clip-pathをやめて、border-radiusで形を作る（画像保存対策） */
            border-radius: 20px 20px 8px 8px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* 上寄せに変更 */
            padding-top: 150px; /* 紐のスペースを確保（ここ重要） */
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            font-family: 'Zen Old Mincho', serif;
            overflow: hidden;
            z-index: 10;
            box-sizing: border-box;
        }

        /* 御守の「肩」の部分を表現する三角形 */
        .omamori-body::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 0; height: 0;
            border-style: solid;
            border-width: 40px 40px 0 0;
            border-color: var(--bg-color) transparent transparent transparent;
            z-index: 20;
        }
        .omamori-body::after {
            content: '';
            position: absolute;
            top: 0; right: 0;
            width: 0; height: 0;
            border-style: solid;
            border-width: 0 40px 40px 0;
            border-color: transparent var(--bg-color) transparent transparent;
            z-index: 20;
        }
        /* ※背景色がダークモードなどで変わる場合の対策はJSで行います */

        /* 生地の質感 */
        .omamori-texture {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.08) 0px, rgba(255,255,255,0.08) 1px, transparent 1px, transparent 4px);
            z-index: 0;
            pointer-events: none;
        }

        /* 中央の文字札 */
        .omamori-label {
            background: #fff;
            color: #333;
            writing-mode: vertical-rl;
            padding: 15px 12px;
            font-size: 2rem;
            font-weight: 900;
            letter-spacing: 0.3em;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 2;
            height: 200px; /* 固定高さ */
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* 紐（叶結び） */
        .omamori-knot {
            position: absolute;
            top: 45px; /* 位置調整 */
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 90px;
            z-index: 30; /* 文字より上に */
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.4));
        }

        /* 飾り枠 */
        .omamori-border {
            position: absolute;
            top: 12px; left: 12px; right: 12px; bottom: 12px;
            border: 2px solid rgba(255,255,255,0.4);
            border-radius: 12px;
            z-index: 1;
        }

        /* 名前刻印 */
        .omamori-name {
            position: absolute; 
            bottom: 20px; 
            font-size: 0.8rem; 
            color: rgba(255,255,255,0.9); 
            writing-mode: horizontal-tb;
            letter-spacing: 0.1em; 
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            z-index: 5;
        }
        
        /* 選択ボタンのグリッド */
        .wish-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .wish-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            height: 140px;
        }
        .wish-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border-color: var(--accent-red);
        }
        .wish-icon { font-size: 2.5rem; margin-bottom: 10px; }
        .wish-name { font-weight: bold; font-size: 1.1rem; }

        /* 祈祷アニメーション */
        .prayer-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Zen Old Mincho', serif;
        }
        .dark .prayer-overlay { background: rgba(0,0,0,0.9); }
        
        .prayer-light {
            width: 100px; height: 100px;
            background: radial-gradient(circle, #ffd700 0%, transparent 70%);
            animation: pulseLight 1.5s infinite;
            border-radius: 50%;
        }
        @keyframes pulseLight {
            0% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.5; }
        }

        /* --- Windows 11風 Fluent Design 通知 --- */
    #toast-container {
        position: fixed;
        bottom: 24px; /* Windows 11に合わせて右下に配置（上の方が良ければ top: 80px に戻してください） */
        right: 24px;
        z-index: 99999;
        display: flex;
        flex-direction: column;
        gap: 12px;
        pointer-events: none;
    }

    .toast-notification {
        position: relative;
        min-width: 340px;
        max-width: 420px;
        padding: 16px;
        border-radius: 8px; /* Win11の標準R */
        
        /* Fluent Design: Acrylic Material (Light) */
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        
        /* 極細の境界線と影 */
        border: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.14);
        
        /* アニメーション */
        transform: translateX(120%);
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.1, 0.9, 0.2, 1); /* Win11風のバネのような動き */
        
        pointer-events: auto;
        display: flex;
        align-items: flex-start;
        overflow: hidden;
        
        /* フォント設定 */
        font-family: 'Segoe UI', 'Zen Old Mincho', sans-serif;
        color: #1a1a1a;
    }

    /* ダークモード時のAcrylic (Dark) */
    .dark .toast-notification {
        background: rgba(32, 32, 32, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: #ffffff;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
    }

    /* 表示状態 */
    .toast-visible {
        transform: translateX(0) !important;
        opacity: 1 !important;
    }

    /* アイコンエリア */
    .toast-icon-area {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        margin-right: 12px;
        flex-shrink: 0;
        font-size: 1.2rem;
    }

    /* テキストエリア */
    .toast-content {
        flex: 1;
        padding-right: 24px; /* 閉じるボタンのスペース */
    }

    .toast-title {
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 4px;
        line-height: 1.4;
    }

    .toast-msg {
        font-size: 0.85rem;
        opacity: 0.8;
        line-height: 1.5;
    }

    /* 閉じるボタン */
    .toast-close {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 24px;
        height: 24px;
        border: none;
        background: transparent;
        color: inherit;
        opacity: 0.5;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s;
    }
    .toast-close:hover {
        background: rgba(0,0,0,0.05);
        opacity: 1;
    }
    .dark .toast-close:hover {
        background: rgba(255,255,255,0.1);
    }

    /* タイムバー（プログレスバー） */
    .toast-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 3px;
        background: currentColor;
        opacity: 0.3;
        width: 100%;
        transform-origin: left;
    }

    /* タイプ別の色定義 */
    .toast-info .toast-icon-area, .toast-info .toast-progress { color: #0078d4; } /* Windows Blue */
    .toast-success .toast-icon-area, .toast-success .toast-progress { color: #107c10; } /* Windows Green */
    .toast-warning .toast-icon-area, .toast-warning .toast-progress { color: #d83b01; } /* Windows Orange */
    .toast-error .toast-icon-area, .toast-error .toast-progress { color: #c50f1f; } /* Windows Red */

        /* --- Roblox風プロフィール (参拝者台帳) --- */
        .profile-header-bg {
            height: 180px;
            background: linear-gradient(135deg, #1a1a1a 0%, #4a4a4a 100%);
            border-radius: 16px 16px 0 0;
            position: relative;
            margin-bottom: 60px;
        }
        .theme-newyear .profile-header-bg {
            background: linear-gradient(135deg, #b91c1c 0%, #d4af37 100%);
        }
        .profile-avatar-container {
            position: absolute;
            bottom: -50px;
            left: 30px;
            width: 120px;
            height: 120px;
            background: var(--card-bg);
            border-radius: 50%;
            padding: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .profile-avatar-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #555;
            border: 2px solid var(--card-border);
        }
        .profile-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        .profile-stat-box {
            background: var(--input-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }
        .profile-stat-val { font-size: 1.5rem; font-weight: 900; font-family: monospace; }
        .profile-stat-label { font-size: 0.8rem; color: var(--text-sub); }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 15px;
        }
        .badge-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .badge-item:hover { transform: scale(1.1); }
        .badge-icon {
            width: 60px; height: 60px;
            border-radius: 12px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem;
            color: #ccc; /* 未獲得色 */
            margin-bottom: 5px;
        }
        .badge-item.unlocked .badge-icon {
            background: #fffcf2;
            border-color: #d4af37;
            color: #d4af37;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.3);
        }
        .badge-name { font-size: 0.7rem; font-weight: bold; line-height: 1.2; }

        /* 検索バー */
        .user-search-container {
            position: relative;
            margin-bottom: 20px;
        }
        .search-suggestions {
            position: absolute;
            top: 100%; left: 0; width: 100%;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 0 0 8px 8px;
            z-index: 50;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex; align-items: center;
        }
        .suggestion-item:hover { background-color: rgba(128,128,128,0.1); }

        /* 編集モーダル */
        #edit-profile-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 3000;
            display: none; align-items: center; justify-content: center;
        }
        
        /* フォロー統計 */
        .profile-social-stats {
            display: flex; gap: 20px; justify-content: center; margin-top: 10px;
            font-size: 0.9rem; color: var(--text-sub);
        }
        .social-stat strong { color: var(--text-main); font-size: 1.1rem; }

        
/* フォローリスト */
        .follow-user-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px; border-radius: 8px;
            background: var(--input-bg); border: 1px solid var(--card-border);
            cursor: pointer; transition: background 0.2s;
        }
        .follow-user-item:hover { background-color: rgba(128,128,128,0.1); }
        
        /* 統計値をクリック可能にする */
        .social-stat {
            cursor: pointer; transition: opacity 0.2s;
            padding: 5px 10px; border-radius: 6px;
        }
        .social-stat:hover {
            background-color: rgba(0,0,0,0.05); opacity: 0.8;
        }
        .dark .social-stat:hover { background-color: rgba(255,255,255,0.1); }

        /* 認証マーク */
        .verified-badge { cursor: pointer; display: inline-flex; align-items: center; justify-content: center; margin-left: 4px; vertical-align: middle; }
        .verified-gold { color: #d4af37; filter: drop-shadow(0 0 2px rgba(212, 175, 55, 0.5)); }
        .verified-blue { color: #3b82f6; }

        /* 3点リーダーメニュー */
        .profile-menu-container { position: relative; display: inline-block; }
        .profile-menu-btn { 
            width: 40px; height: 40px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            background: transparent; border: 1px solid var(--card-border);
            color: var(--text-main); font-size: 1.2rem; cursor: pointer;
            transition: all 0.2s;
        }
        .profile-menu-btn:hover { background-color: rgba(128,128,128,0.1); }
        
        .profile-menu-dropdown {
            position: absolute; top: 100%; right: 0; 
            width: 180px; background: var(--card-bg); 
            border: 1px solid var(--card-border); border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            display: none; z-index: 100; overflow: hidden;
            margin-top: 8px;
        }
        .profile-menu-dropdown.active { display: block; animation: fadeInMenu 0.2s; }
        @keyframes fadeInMenu { from{opacity:0; transform:translateY(-10px);} to{opacity:1; transform:translateY(0);} }
        
        .menu-item {
            width: 100%; padding: 12px 15px; text-align: left;
            background: none; border: none; color: var(--text-main);
            font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 10px;
            transition: background 0.1s;
        }
        .menu-item:hover { background-color: rgba(128,128,128,0.1); }
        .menu-item.danger { color: #dc2626; }
        .menu-item.danger:hover { background-color: rgba(220, 38, 38, 0.1); }

        /* アイコン選択 */
        .icon-select-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px; }
        .icon-option { 
            width: 40px; height: 40px; border-radius: 8px; border: 1px solid var(--card-border); 
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .icon-option.selected { border-color: var(--accent-red); background-color: rgba(185, 28, 28, 0.1); }
        
        .color-select-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-bottom: 15px; }
        .color-option { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-option.selected { border-color: var(--text-main); transform: scale(1.1); }
        
        /* 認証モーダル */
        #verified-modal-content { font-family: 'Zen Old Mincho', serif; }

        /* 進捗バーのスタイル */
        .badge-progress-container {
            width: 100%;
            height: 6px;
            background-color: #e5e7eb; /* グレー */
            border-radius: 3px;
            margin-top: 6px;
            overflow: hidden;
        }
        .dark .badge-progress-container {
            background-color: #374151;
        }
        .badge-progress-bar {
            height: 100%;
            background-color: var(--accent-gold); /* 黄金色 */
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        .badge-progress-text {
            font-size: 0.65rem;
            color: var(--text-sub);
            margin-top: 2px;
            text-align: right;
            font-family: monospace;
        }

        /* --- スタンプカード (連続参拝ゲーム風UI) --- */
.stamp-card-container {
    background-color: #fff;
    border: 2px solid #e5e7eb;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
}
.dark .stamp-card-container {
    background-color: #27272a;
    border-color: #3f3f46;
}
.stamp-grid {
    display: flex;
    justify-content: space-between;
    gap: 8px;
    margin-top: 15px;
}
.stamp-item {
    width: 100%;
    aspect-ratio: 1;
    border: 2px dashed #d1d5db;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
    font-size: 0.8rem;
    position: relative;
    background: rgba(0,0,0,0.02);
}
.dark .stamp-item {
    border-color: #52525b;
    color: #71717a;
}
.stamp-item.active {
    border: 2px solid #d4af37;
    background-color: #fffcf0;
    color: #d4af37;
    box-shadow: 0 4px 10px rgba(212, 175, 55, 0.2);
}
.dark .stamp-item.active {
    background-color: #3f2c00;
}
.stamp-mark {
    font-size: 1.5rem;
    color: #d4af37; /* 黄金 */
    animation: stampIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes stampIn {
    from { transform: scale(2); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}
.stamp-label {
    position: absolute;
    bottom: -20px;
    font-size: 0.65rem;
    white-space: nowrap;
    color: var(--text-sub);
}

    /* グラフアニメーション */
.stat-bar-animate {
    width: 0;
    transition: width 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
}    

        /* 右に行くほど加速するアニメーション (ease-in) */
.bar-animate-fast {
    width: 0;
    transition: width 1.5s cubic-bezier(0.4, 0, 1, 1);
}

/* 目盛り線のスタイル */
.grid-line {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 1px;
    background-color: rgba(128, 128, 128, 0.1);
    z-index: 0;
}
.grid-label {
    position: absolute;
    top: -20px;
    transform: translateX(-50%);
    font-size: 9px;
    color: rgba(128, 128, 128, 0.4);
    font-family: monospace;
}

        
/* 判定結果エリアの修正 */
        #my-rank-result .rank-card-modern {
            margin-bottom: 0; /* 余計な下マージンを削除 */
            box-shadow: none; /* 影を消してフラットに（親カードに馴染ませる） */
            border: 1px solid rgba(0,0,0,0.05); /* 薄い枠線に変更 */
        }
        
        /* 判定結果カード内のスマホ表示調整 */
        @media (max-width: 768px) {
            #my-rank-result .rank-card-modern {
                padding: 15px; /* スマホではパディングを少し減らす */
            }
        }

        /* --- TENMEI Labs: 詳細設定パネル --- */

/* 設定項目の行 */
.lab-setting-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid rgba(0,0,0,0.05);
}
.dark .lab-setting-row {
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.lab-setting-label {
    font-weight: bold;
    font-size: 0.9rem;
    color: var(--text-main);
    display: flex;
    flex-direction: column;
}
.lab-setting-sub {
    font-size: 0.7rem;
    color: var(--text-sub);
    font-weight: normal;
}

/* スライダー */
.lab-slider-container {
    width: 50%;
    display: flex;
    align-items: center;
    gap: 10px;
}
.lab-range-input {
    width: 100%;
    height: 6px;
    background: #e5e7eb;
    border-radius: 3px;
    appearance: none;
    outline: none;
}
.dark .lab-range-input { background: #4b5563; }

.lab-range-input::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent-red);
    cursor: pointer;
    border: 2px solid #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* 値の表示 */
.lab-val-display {
    font-family: monospace;
    font-weight: bold;
    width: 40px;
    text-align: right;
}

/* --- 動的CSS変数 (JSで操作する対象) --- */

/* 幽玄の霧: 透明度変数を適用 */
.mist-blob {
    /* デフォルト値をJSで上書きできるように変数化 */
    opacity: var(--lab-mist-opacity, 0.6); 
    /* アニメーション速度も変数化 */
    animation-duration: var(--lab-mist-speed, 30s) !important;
}

/* 言霊の増幅: サイズ変数を適用 */
html.lab-big-text {
    font-size: var(--lab-font-scale, 120%);
}

/* 迎春モード: パターン濃度 */
body.theme-newyear {
    /* 背景画像の不透明度操作は難しいので、擬似要素などで対応するか、
       ここではシンプルに「背景色のブレンド」などで対応する想定 */
}

    /* QRコードを高画質にするための縮小表示設定 */
        .result-qr-container img, 
        .result-qr-container canvas {
            width: 60px !important;  /* 見た目のサイズ */
            height: 60px !important;
            display: block;
        }    

       /* --- グラフ用ツールチップ & 軸スタイル --- */
        .chart-tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.75rem;
            pointer-events: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 50;
            color: var(--text-main);
            white-space: nowrap;
            font-family: monospace;
            font-weight: bold;
        }
        .dark .chart-tooltip {
            background: rgba(30, 30, 30, 0.95);
            border-color: rgba(255, 255, 255, 0.1);
        }
        .chart-axis-text {
            font-size: 9px;
            fill: #ca8a04; /* text-yellow-600 (発行数用) */
            font-family: monospace;
            font-weight: bold;
        }
        .chart-axis-text-right {
            font-size: 9px;
            fill: #dc2626; /* text-red-600 (参拝者用) */
            font-family: monospace;
            font-weight: bold;
            text-anchor: start;
        }
        .chart-grid-line {
            stroke: currentColor;
            stroke-opacity: 0.1;
            stroke-width: 1px;
        }
        .chart-hover-line {
            stroke: var(--text-sub);
            stroke-width: 1px;
            stroke-dasharray: 4 4;
            opacity: 0;
        }

        /* グラフエリアのグリッドレイアウト */
        .charts-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 240px; /*高さを確保*/
            position: relative;
        }
        @media (max-width: 768px) {
            .charts-wrapper {
                grid-template-columns: 1fr; /* スマホは縦並び */
                height: auto;
            }
            .chart-box {
                height: 200px;
            }
        }
        .chart-box {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* グラフエリア（おみくじの轍の統計）を削除 */
        .history-stats-grid {
            display: none !important;
        }
        
        /* 検索バーの下マージン調整 */
        .history-control-bar {
            margin-top: 20px;
        }

    </style>
</head>
<body>

    <!-- 幽玄の霧コンテナ (高密度版) -->
    <div id="mist-container">
        <div class="mist-blob mist-1"></div>
        <div class="mist-blob mist-2"></div>
        <div class="mist-blob mist-3"></div>
    </div>

    <!-- ローディングスピナー (SVG版) -->
    <div id="loading-overlay">
        <svg class="loader-svg" viewBox="0 0 50 50">
            <circle class="loader-path" cx="25" cy="25" r="20" fill="none" stroke-width="1.5"></circle>
        </svg>
    </div>

    <!-- サイドバー -->
    <nav id="sidebar">
        <button class="nav-btn" onclick="showView('home')">
            <i class="bi bi-house-door"></i>
            <span class="nav-text">ホーム</span>
        </button>
        <button class="nav-btn" onclick="showView('zodiac')">
            <i class="bi bi-stars"></i>
            <span class="nav-text">12星座×血液型占い</span>
        </button>
        <button class="nav-btn" onclick="showView('history')">
            <i class="bi bi-clock-history"></i>
            <span class="nav-text">おみくじの轍</span>
        </button>
        <button class="nav-btn" onclick="showView('news')">
            <i class="bi bi-bell"></i>
            <span class="nav-text">社務所だより</span>
        </button>
        <button class="nav-btn" onclick="showView('column')">
            <i class="bi bi-book"></i>
            <span class="nav-text">神籤草子</span>
        </button>
        <!-- サイドバー内に追加 -->
        <button class="nav-btn" onclick="showView('omamori')">
            <!-- 盾のアイコンで「守り」を表現 -->
            <i class="bi bi-shield-fill-check"></i>
            <span class="nav-text">御守授与所</span>
        </button>
        <!-- サイドバーボタン: TENMEI Labs -->
        <button class="nav-btn" onclick="showView('lab')">
            <div class="nav-flask-anim">
                <svg viewBox="0 0 200 200" overflow="hidden" style="width:100%; height:100%;">
                    <defs>
                        <clipPath id="flaskClipNav">
                             <path d="M80 20 L120 20 L120 70 L170 170 C175 180, 165 190, 150 190 L50 190 C35 190, 25 180, 30 170 L80 70 Z" />
                        </clipPath>
                    </defs>
                    <g class="flask-container">
                        <g clip-path="url(#flaskClipNav)">
                            <g class="liquid-container">
                                <!-- サイドバーは視認性重視で手前の波のみ表示 -->
                                <path class="wave-path wave-front" 
                                      d="M0 120 Q50 140 100 120 T200 120 T300 120 T400 120 V250 H0 Z" />
                            </g>
                        </g>
                        <!-- ガラス容器 -->
                        <path class="glass-stroke" fill="none" stroke-width="12"
                              d="M80 20 L120 20 L120 70 L170 170 C175 180, 165 190, 150 190 L50 190 C35 190, 25 180, 30 170 L80 70 Z" />
                    </g>
                </svg>
            </div>
            <span class="nav-text">TENMEI Labs</span>
        </button>

        <button class="nav-btn" onclick="showView('prefecture')">
            <i class="bi bi-list-columns-reverse"></i>
            <span class="nav-text">全国の運気</span>
        </button>

        <!-- ▼▼ 変更: 参拝者台帳を削除し、統計ボタンに変更 ▼▼ -->
    <button class="nav-btn" onclick="showView('stats')">
        <i class="bi bi-bar-chart-line-fill"></i>
        <span class="nav-text">参拝の記録</span>
    </button>
        
        <button class="nav-btn" onclick="handleProfileClick()" id="nav-login-btn">
            <i class="bi bi-person-circle"></i>
            <span class="nav-text">ログイン/登録</span>
        </button>
        
        <div style="margin-top: auto; width: 100%;">
            <button class="nav-btn" onclick="showView('about')">
                <i class="bi bi-info-circle"></i>
                <span class="nav-text">当サイトについて</span>
            </button>
            <button class="nav-btn" onclick="showView('privacy')">
                <i class="bi bi-shield-lock"></i>
                <span class="nav-text">プライバシー</span>
            </button>
        </div>
    </nav>

    <!-- メインエリア -->
    <main id="main-content">
        
        <!-- ビュー: ホーム (Bento Grid UI) -->
        <section id="view-home" class="view-section active">
            
            <div class="bento-grid">
                
                <!-- 1. 挨拶エリア (Welcome) -->
                <div class="bento-card bento-welcome">
                    <div class="text-left md:text-left text-center w-full">
                        <p class="text-sm font-bold text-gray-500 dark:text-gray-400 mb-1" id="welcome-date">---</p>
                        <h2 class="text-2xl md:text-3xl font-black tracking-wide" style="font-family: 'Zen Old Mincho', serif;">
    <!-- ▼▼▼ 修正: クラスを text-[var(--accent-red)] に変更し、モード問わず「紅」に固定 ▼▼▼ -->
    <span id="welcome-username" class="text-[var(--accent-red)]">ゲスト</span> さん
</h2>
                        <p class="text-lg text-gray-700 dark:text-gray-300 font-medium mt-1">ようこそ、運勢・天命乃杜へ</p>
                    </div>
                    <!-- 右側にちょっとした装飾 -->
                    <div class="hidden md:block opacity-20 text-6xl text-red-500">
                        <i class="bi bi-flower1"></i>
                    </div>
                </div>

                <!-- 2. タイトル＆メインビジュアル -->
                <div class="bento-card bento-title relative">
                    <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
                        <!-- 背景装飾 -->
                        <div class="home-circle-container" id="home-anim-container" style="transform: scale(0.8); border:none; width:100%; height:100%;"></div>
                    </div>
                    <div class="z-10">
                        <p class="text-xs font-serif tracking-[0.3em] uppercase mb-2">FORTUNE TELLING</p>
                        <h1 class="text-4xl md:text-5xl font-black mb-4 tracking-widest" style="font-family: 'Zen Old Mincho'">運勢・天命乃杜</h1>
                        <!-- 変更後 -->
<p class="text-sm font-serif themed-text-sub leading-relaxed">
    天命が導く、日々の道しるべ<br>災いを避け、福を招く
</p>
                    </div>
                </div>

                <!-- 3. おみくじを引く (アクションボタン) -->
                <button onclick="startOmikuji()" class="bento-card bento-action group">
                    <div class="transform transition group-hover:scale-110 duration-300">
                        <i class="bi bi-box-seam-fill text-5xl mb-4 block"></i>
                        <h3>おみくじを引く</h3>
                        <p class="text-xs opacity-90">心を鎮め、天命を問う</p>
                    </div>
                </button>

                <!-- 4. カウンター (ミニカード) -->
                <div class="bento-card bento-mini" style="grid-column: span 6;">
                    <div class="w-12 h-12 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center text-red-600">
                        <i class="bi bi-people-fill text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 font-bold">累計参拝者数</p>
                        <p class="text-2xl font-black font-mono" id="worshipper-counter">---</p>
                    </div>
                </div>

                <div class="bento-card bento-mini" style="grid-column: span 6;">
                    <div class="w-12 h-12 rounded-full bg-yellow-100 dark:bg-yellow-900/30 flex items-center justify-center text-yellow-600">
                        <i class="bi bi-layers-fill text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 font-bold">おみくじ発行総数</p>
                        <p class="text-2xl font-black font-mono" id="live-counter">---</p>
                    </div>
                </div>

                <!-- 5. 統計 (おみくじの轍・完全版) -->
                <div class="bento-card bento-stats">
                    <div class="flex justify-between items-center mb-2 border-b border-gray-200 dark:border-gray-700 pb-2">
                        <h3 class="font-bold flex items-center gap-2"><i class="bi bi-bar-chart-line-fill text-red-500"></i> 本日の傾向</h3>
                        <span class="text-[10px] bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded" id="stats-update-time">--:--:--</span>
                    </div>
                    
                    <!-- スクロール可能エリアとして全12種を表示 -->
                    <div class="overflow-y-auto pr-2 custom-scrollbar" style="max-height: 240px;">
                        <div id="home-history-stats" class="space-y-2">
                             <!-- 12段階 統計表示 -->
                             <div class="grid grid-cols-1 gap-1">
                                 <!-- 大吉 -->
                                 <div class="flex justify-between text-xs"><span>大吉</span><span><span id="cnt-daikichi" class="mr-2 font-mono opacity-70">0</span><span id="stat-daikichi">0.00%</span></span></div>
                                 <div class="w-full bg-gray-200 dark:bg-zinc-700 h-1.5 rounded mb-1"><div id="bar-daikichi" class="bg-yellow-400 h-1.5 rounded" style="width: 0%"></div></div>
                                 
                                 <!-- 中吉 -->
                                 <div class="flex justify-between text-xs"><span>中吉</span><span><span id="cnt-chukichi" class="mr-2 font-mono opacity-70">0</span><span id="stat-chukichi">0.00%</span></span></div>
                                 <div class="w-full bg-gray-200 dark:bg-zinc-700 h-1.5 rounded mb-1"><div id="bar-chukichi" class="bg-orange-400 h-1.5 rounded" style="width: 0%"></div></div>

                                 <!-- 小吉 -->
                                 <div class="flex justify-between text-xs"><span>小吉</span><span><span id="cnt-shokichi" class="mr-2 font-mono opacity-70">0</span><span id="stat-shokichi">0.00%</span></span></div>
                                 <div class="w-full bg-gray-200 dark:bg-zinc-700 h-1.5 rounded mb-1"><div id="bar-shokichi" class="bg-green-400 h-1.5 rounded" style="width: 0%"></div></div>

                                 <!-- 吉 -->
                                 <div class="flex justify-between text-xs"><span>吉</span><span><span id="cnt-kichi" class="mr-2 font-mono opacity-70">0</span><span id="stat-kichi">0.00%</span></span></div>
                                 <div class="w-full bg-gray-200 dark:bg-zinc-700 h-1.5 rounded mb-1"><div id="bar-kichi" class="bg-red-400 h-1.5 rounded" style="width: 0%"></div></div>

                                 <!-- 半吉 -->
                                 <div class="flex justify-between text-xs"><span>半吉</span><span><span id="cnt-hankichi" class="mr-2 font-mono opacity-70">0</span><span id="stat-hankichi">0.00%</span></span></div>
                                 <div class="w-full bg-gray-200 dark:bg-zinc-700 h-1.5 rounded mb-1"><div id="bar-hankichi" class="bg-red-300 h-1.5 rounded" style="width: 0%"></div></div>

                                 <!-- 末吉 -->
                                 <div class="flex justify-between text-xs"><span>末吉</span><span><span id="cnt-suekichi" class="mr-2 font-mono opacity-70">0</span><span id="stat-suekichi">0.00%</span></span></div>
                                 <div class="w-full bg-gray-200 dark:bg-zinc-700 h-1.5 rounded mb-1"><div id="bar-suekichi" class="bg-blue-400 h-1.5 rounded" style="width: 0%"></div></div>

                                 <!-- 末小吉 -->
                                 <div class="flex justify-between text-xs"><span>末小吉</span><span><span id="cnt-sueshokichi" class="mr-2 font-mono opacity-70">0</span><span id="stat-sueshokichi">0.00%</span></span></div>
                                 <div class="w-full bg-gray-200 dark:bg-zinc-700 h-1.5 rounded mb-1"><div id="bar-sueshokichi" class="bg-blue-300 h-1.5 rounded" style="width: 0%"></div></div>

                                 <!-- 凶 -->
                                 <div class="flex justify-between text-xs"><span>凶</span><span><span id="cnt-kyo" class="mr-2 font-mono opacity-70">0</span><span id="stat-kyo">0.00%</span></span></div>
                                 <div class="w-full bg-gray-200 dark:bg-zinc-700 h-1.5 rounded mb-1"><div id="bar-kyo" class="bg-gray-400 h-1.5 rounded" style="width: 0%"></div></div>

                                 <!-- 小凶 -->
                                 <div class="flex justify-between text-xs"><span>小凶</span><span><span id="cnt-shokyo" class="mr-2 font-mono opacity-70">0</span><span id="stat-shokyo">0.00%</span></span></div>
                                 <div class="w-full bg-gray-200 dark:bg-zinc-700 h-1.5 rounded mb-1"><div id="bar-shokyo" class="bg-gray-500 h-1.5 rounded" style="width: 0%"></div></div>

                                 <!-- 半凶 -->
                                 <div class="flex justify-between text-xs"><span>半凶</span><span><span id="cnt-hankyo" class="mr-2 font-mono opacity-70">0</span><span id="stat-hankyo">0.00%</span></span></div>
                                 <div class="w-full bg-gray-200 dark:bg-zinc-700 h-1.5 rounded mb-1">
                                     <div id="bar-hankyo" class="bg-gray-600 dark:bg-gray-400 h-1.5 rounded" style="width: 0%"></div>
                                 </div>

                                 <!-- 末凶 -->
                                 <div class="flex justify-between text-xs"><span>末凶</span><span><span id="cnt-suekyo" class="mr-2 font-mono opacity-70">0</span><span id="stat-suekyo">0.00%</span></span></div>
                                 <div class="w-full bg-gray-200 dark:bg-zinc-700 h-1.5 rounded mb-1"><div id="bar-suekyo" class="bg-gray-700 h-1.5 rounded" style="width: 0%"></div></div>

                                 <!-- 大凶 -->
                                 <div class="flex justify-between text-xs"><span>大凶</span><span><span id="cnt-daikyo" class="mr-2 font-mono opacity-70">0</span><span id="stat-daikyo">0.00%</span></span></div>
                                 <div class="w-full bg-gray-200 dark:bg-zinc-700 h-1.5 rounded mb-1"><div id="bar-daikyo" class="bg-black h-1.5 rounded" style="width: 0%"></div></div>
                             </div>
                        </div>
                        <button onclick="showView('history')" class="text-center w-full text-xs text-gray-400 mt-4 hover:text-red-500 transition border-t border-gray-100 dark:border-gray-800 pt-2">履歴一覧へ移動</button>
                    </div>
                </div>

               <!-- 6. 社務所だより (隙間修正版) -->
                <div class="bento-card bento-news">
                    <div class="flex justify-between items-center mb-2 border-b border-gray-200 dark:border-gray-700 pb-2">
                        <h3 class="font-bold flex items-center gap-2"><i class="bi bi-bell-fill text-blue-500"></i> 社務所だより</h3>
                        <button onclick="showView('news')" class="text-xs text-blue-500 hover:underline">一覧</button>
                    </div>
                    <!-- space-y-3 を space-y-0 にし、隙間をなくして境界線を追加 -->
                    <ul class="text-sm space-y-0 divide-y divide-gray-100 dark:divide-gray-800" id="home-news-list">
                        <!-- JSで自動挿入 -->
                    </ul>
                </div>

                <!-- 7. 神籤草子 (隙間修正版) -->
                <div class="bento-card bento-col">
                    <div class="flex justify-between items-center mb-2 border-b border-gray-200 dark:border-gray-700 pb-2">
                        <h3 class="font-bold flex items-center gap-2"><i class="bi bi-book-half text-green-500"></i> 神籤草子</h3>
                        <button onclick="showView('column')" class="text-xs text-green-500 hover:underline">一覧</button>
                    </div>
                    <!-- 同様に隙間を修正 -->
                    <ul class="text-sm space-y-0 divide-y divide-gray-100 dark:divide-gray-800" id="home-column-list">
                        <!-- JSで自動挿入 -->
                    </ul>
                </div>

            </div>
        </section>

        <!-- ビュー: おみくじ選択 (案内文更新版) -->
        <section id="view-draw" class="view-section relative min-h-screen w-full" style="overflow-y: auto !important;">
            
            <!-- 固定ヘッダーカード -->
            <div class="sticky top-0 z-20 px-4 pt-4">
                <div class="draw-header-card">
                    <h2 class="text-xl font-black leading-relaxed font-serif mb-2 text-gray-800 dark:text-gray-100">
                        <i class="bi bi-stars text-yellow-500"></i> 天命の授与所
                    </h2>
                    <!-- メイン案内文 -->
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-200 leading-relaxed">
                        背筋を伸ばし、深く呼吸を整えて心を静めます。<br>
                        占いたい事柄を胸の内で唱えながら、<br>
                        天命の一枚をお選びください。
                    </p>
                    <!-- 補足文 -->
                    <p class="text-[11px] text-gray-500 dark:text-gray-400 mt-3 border-t border-gray-100 dark:border-gray-800 pt-2">
                        ※特に悩みがない場合は、『今の私に必要な導きを』と念じて引いてください。
                    </p>
                </div>
            </div>
            
            <!-- おみくじプール -->
            <div id="omikuji-pool" class="omikuji-pool p-4 md:p-8"></div>
            
            <!-- 追加ボタン -->
            <div class="fixed bottom-10 left-0 w-full text-center z-50 pointer-events-none">
                <button onclick="addOmikuji()" class="btn-primary pointer-events-auto shadow-2xl transform hover:scale-105 transition py-4 px-8 rounded-full border-2 border-white/20 backdrop-blur-md">
                    <i class="bi bi-plus-lg"></i> さらに探す
                </button>
            </div>
        </section>

        <!-- ビュー: おみくじ結果 (Bento Action Grid版) -->
        <section id="view-result" class="view-section text-center">
            <div id="result-display-area" class="py-10">
                
                <!-- 画像化対象エリア -->
                <div style="display: flex; justify-content: flex-start; overflow-x: auto; -webkit-overflow-scrolling: touch; padding: 0 10px;">
                    <div id="result-capture-container">
                        <!-- 結果カード (JSで動的生成) -->
                        <div class="result-card-outer" id="result-card-outer"></div>
                    </div>
                </div>

                <!-- 注釈 -->
                <div class="mt-4 text-xs text-gray-500 dark:text-gray-400 leading-relaxed">
                    結果は必ずしもその通りになるとは限りません。<br>
                    詳細は<button onclick="showView('about'); window.scrollTo(0,0);" class="text-[var(--accent-red)] hover:underline font-bold ml-1">利用規約</button>をご確認ください。
                </div>

                <!-- アクションエリア (Bento Grid) -->
                <div class="max-w-2xl mx-auto mt-8 px-4">
                    
                    <!-- 生成ステータス表示 -->
                    <div id="gen-img-status" class="text-sm font-bold text-gray-500 mb-2 h-6"></div>
                    <div id="generated-image-container" class="hidden mb-6 p-4 bg-gray-100 dark:bg-zinc-800 rounded-xl">
                        <!-- 生成画像がここに入ります -->
                    </div>

                    <!-- 保存・戻るアクション -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <button onclick="generateResultImage()" class="action-card-btn action-primary col-span-2">
                            <i class="bi bi-download"></i>
                            <span>画像を保存する</span>
                        </button>
                        <button onclick="showView('home')" class="action-card-btn">
                            <i class="bi bi-house-door"></i>
                            <span>ホームへ</span>
                        </button>
                        <button onclick="startOmikuji()" class="action-card-btn">
                            <i class="bi bi-arrow-counterclockwise"></i>
                            <span>もう一度引く</span>
                        </button>
                    </div>

                    <!-- SNSシェアグリッド -->
                    <div class="text-left mb-2">
                        <p class="text-xs font-bold text-gray-400 ml-2">SNSでシェア（画像は手動添付）</p>
                    </div>
                    <div class="result-action-grid mt-0">
                        <button onclick="shareToX()" class="action-card-btn btn-x">
                            <i class="bi bi-twitter-x"></i>
                            <span>X (Twitter)</span>
                        </button>
                        <button onclick="shareToFB()" class="action-card-btn btn-fb">
                            <i class="bi bi-facebook"></i>
                            <span>Facebook</span>
                        </button>
                        <button onclick="shareToLine()" class="action-card-btn btn-line">
                            <i class="bi bi-line"></i>
                            <span>LINE</span>
                        </button>
                        <button onclick="shareToBluesky()" class="action-card-btn btn-bsky">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 600 530"><path d="M135.72 44.03c66.496 49.921 138.02 151.14 164.28 205.46 26.262-54.316 97.782-155.54 164.28-205.46 47.98-36.021 125.72-63.892 125.72 24.317 0 59.31-21.66 205.49-51.942 258.85-39.826 70.198-111.2 30.083-161.01-12.506 39.998 52.346 42.422 133.55-23.731 133.55-58.261 0-77.921-27.995-77.31-79.626 2.593-219.06-189.28-169.87-192.31-169.87-2.917 0-3.666-51.059-3.666-87.876 0-87.653 76.789-58.86 125.69-22.349z"/></svg>
                            <span>Bluesky</span>
                        </button>
                        <button onclick="shareToMisskey()" class="action-card-btn btn-misskey col-span-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.669 4.382c.074.225.137.458.19.697a4.67 4.67 0 0 1 .066.727c0 .193-.01.383-.028.57a3.86 3.86 0 0 1-.09.53 4.2 4.2 0 0 1-.72 1.621 3.96 3.96 0 0 1-.397.47c-.126.13-.263.25-.408.36-.146.113-.301.214-.465.304-.326.179-.675.316-1.038.406-.364.09-.74.136-1.119.136a4.7 4.7 0 0 1-1.12-.136 4.3 4.3 0 0 1-1.037-.406 4.1 4.1 0 0 1-.465-.304 3.9 3.9 0 0 1-.409-.36 4 4 0 0 1-.396-.47 4.2 4.2 0 0 1-.72-1.62 3.86 3.86 0 0 1-.09-.531 4.7 4.7 0 0 1-.028-.57c0-.246.022-.49.065-.727.054-.24.117-.472.19-.697A8 8 0 0 0 8 4.382z"/></svg>
                            <span>Misskey.io</span>
                        </button>
                    </div>
                    
                </div>
            </div>
        </section>

        
<!-- ビュー: 12星座×血液型占い (修正版) -->
        <section id="view-zodiac" class="view-section">
            <div class="max-w-5xl mx-auto">
                
                <!-- ヘッダー -->
                <div class="bento-card mb-8 flex flex-col md:flex-row items-center justify-between gap-4 bg-gradient-to-r from-gray-50 to-white dark:from-zinc-900 dark:to-black">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-black mb-2 flex items-center gap-3">
                            <span class="text-yellow-500 text-4xl"><i class="bi bi-stars"></i></span>
                            <span>最強運勢ランキング</span>
                        </h2>
                        <p class="text-sm font-bold text-gray-500 dark:text-gray-400" id="current-date-display">---</p>
                    </div>
                    <div class="text-right hidden md:block">
                        <p class="text-xs text-gray-400 font-bold uppercase tracking-widest">DAILY FORTUNE</p>
                        <p class="text-xs text-gray-400">12 Signs × 4 Blood Types</p>
                    </div>
                </div>
        
                <!-- 判定フォーム -->
                <div class="bento-card mb-10 border-l-4 border-l-red-500">
                    <h3 class="font-bold text-lg mb-4"><i class="bi bi-search"></i> あなたの順位をチェック</h3>
                    <div class="zodiac-input-grid">
                        <div style="grid-column: span 5;">
                            <select id="user-sign" class="modern-select">
    <option value="aries">♈ 牡羊座 (3/21-4/19)</option>
    <option value="taurus">♉ 牡牛座 (4/20-5/20)</option>
    <option value="gemini">♊ 双子座 (5/21-6/21)</option>
    <option value="cancer">♋ 蟹座 (6/22-7/22)</option>
    <option value="leo">♌ 獅子座 (7/23-8/22)</option>
    <option value="virgo">♍ 乙女座 (8/23-9/22)</option>
    <option value="libra">♎ 天秤座 (9/23-10/23)</option>
    <option value="scorpio">♏ 蠍座 (10/24-11/22)</option>
    <option value="sagittarius">♐ 射手座 (11/23-12/21)</option>
    <option value="capricorn">♑ 山羊座 (12/22-1/19)</option>
    <option value="aquarius">♒ 水瓶座 (1/20-2/18)</option>
    <option value="pisces">♓ 魚座 (2/19-3/20)</option>
</select>
                        </div>
                        <div style="grid-column: span 4;">
                            <select id="user-blood" class="modern-select">
                                <option value="A">A型</option>
                                <option value="B">B型</option>
                                <option value="O">O型</option>
                                <option value="AB">AB型</option>
                            </select>
                        </div>
                        <div style="grid-column: span 3;">
                            <button onclick="findMyRank()" class="modern-search-btn w-full h-full py-3 md:py-0">判定する</button>
                        </div>
                    </div>
                    <!-- 結果表示エリア -->
                    <div id="my-rank-result" class="hidden pt-6 border-t border-gray-100 dark:border-gray-800"></div>
                </div>
        
                <!-- お気に入りセクション -->
<div id="favorites-section" class="hidden mb-10">
    <div class="flex items-center justify-between mb-4 px-2">
        <!-- ★修正: (最大5件) を追加 -->
        <h3 class="text-lg font-bold text-yellow-500">
            <i class="bi bi-star-fill"></i> お気に入り <span class="text-xs text-gray-400 font-normal ml-1">(最大5件)</span>
        </h3>
        <span id="fav-status-badge" class="text-[10px] bg-gray-100 dark:bg-zinc-800 px-2 py-1 rounded"></span>
    </div>
    <div id="favorites-list" class="space-y-4"></div>
</div>
        
                <!-- 全ランキングリスト -->
                <h3 class="font-bold text-xl mb-4 px-2">本日の順位（全48通り）</h3>
                
                <!-- TOP3表示用 -->
                <div id="ranking-list" class="space-y-6"></div>
                
                <!-- 4位以下を見るボタン -->
                <div class="text-center mt-10 mb-6">
                    <button onclick="showFullRanking()" class="inline-flex items-center gap-2 text-sm font-bold px-8 py-3 rounded-full bg-gray-200 dark:bg-zinc-700 hover:bg-red-500 hover:text-white transition">
                        <span id="show-ranking-text">4位以下を見る</span>
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </div>

                <!-- 4位以下リスト (初期は hidden) -->
                <div id="full-ranking-list" class="hidden space-y-4"></div>

                <!-- ログインモーダル (修正版) -->
<div id="zodiac-login-modal" 
     class="fixed top-0 left-0 w-full h-full bg-black/60 z-[3000] hidden items-center justify-center backdrop-blur-sm" 
     onclick="closeZodiacModal(event)">
    
    <!-- カード本体: stopPropagationで親への伝播を止める -->
    <div class="themed-card p-8 rounded-xl shadow-2xl max-w-sm w-full text-center border border-gray-200 dark:border-gray-700 relative" 
         onclick="event.stopPropagation()">
        
        <!-- 閉じるボタン: nullではなくeventを渡すか、単に関数のみ呼ぶ -->
        <button onclick="closeZodiacModal(null)" 
                class="absolute top-4 right-4 text-gray-400 hover:text-red-500 w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-zinc-800 transition">
            <i class="bi bi-x-lg text-lg"></i>
        </button>
        
        <div class="mb-4 text-yellow-400 text-5xl"><i class="bi bi-star-fill"></i></div>
        <h3 class="text-xl font-bold mb-2">会員限定機能</h3>
        <p class="text-sm themed-text-sub mb-6">お気に入りは会員限定です。<br>ログインして天命を記録しましょう。</p>
        <button onclick="showView('auth'); closeZodiacModal(null);" class="btn-primary w-full justify-center py-3">
            ログイン / 登録
        </button>
    </div>
</div>
            </div>
        </section>
        
        </div>
    </div>
        
        <!-- ビュー: TENMEI Labs (動画風モダンUI版) -->
        <section id="view-lab" class="view-section max-w-4xl mx-auto">
            
            <!-- 1. 背景アニメーションレイヤー -->
            <div class="lab-modern-bg">
                <div class="lab-blob blob-1"></div>
                <div class="lab-blob blob-2"></div>
                <div class="lab-blob blob-3"></div>
                <div class="lab-blob blob-4"></div>
                <div class="lab-blob blob-5"></div>
            </div>

            <!-- 2. 装飾テキスト (背景の巨大文字) -->
            <div class="lab-vertical-deco">天命実験室</div>

            <!-- 3. コンテンツレイヤー (背景の上に表示) -->
            <div class="lab-content-relative p-6 md:p-12">
                
                <!-- ヒーローエリア (タイトル) -->
                <div class="lab-hero-area">
                   <!-- メインフラスコ -->
                    <div class="title-flask-anim mb-6 transform scale-110">
                        <svg viewBox="0 0 200 200" overflow="hidden" style="width:100%; height:100%;">
                            <defs>
                                <linearGradient id="gradUnified" x1="0%" y1="100%" x2="100%" y2="0%">
                                    <stop offset="0%" stop-color="#4facfe" />
                                    <stop offset="100%" stop-color="#8e2de2" />
                                </linearGradient>
                                <clipPath id="flaskClipMain">
                                    <path d="M80 20 L120 20 L120 70 L170 170 C175 180, 165 190, 150 190 L50 190 C35 190, 25 180, 30 170 L80 70 Z" />
                                </clipPath>
                            </defs>
                            <g class="flask-container">
                                <g clip-path="url(#flaskClipMain)">
                                    <g class="liquid-container">
                                        <rect x="-50" y="-50" width="300" height="300" fill="rgba(255,255,255,0.05)" />
                                        <path class="wave-path wave-front" d="M0 135 Q50 150 100 135 T200 135 T300 135 T400 135 V250 H0 Z" />
                                        <circle class="bubble" cx="100" cy="180" r="4" style="animation-delay:0s" />
                                        <circle class="bubble" cx="60" cy="170" r="3" style="animation-delay:1s" />
                                        <circle class="bubble" cx="140" cy="175" r="5" style="animation-delay:2s" />
                                    </g>
                                </g>
                                <path class="glass-stroke" fill="none" d="M80 20 L120 20 L120 70 L170 170 C175 180, 165 190, 150 190 L50 190 C35 190, 25 180, 30 170 L80 70 Z" />
                                <path d="M45 170 L75 80" stroke="rgba(255,255,255,0.3)" stroke-width="4" fill="none" />
                            </g>
                        </svg>
                    </div>
                    <h2 class="text-3xl md:text-5xl font-black mb-4 tracking-tight text-gray-800 dark:text-white" style="font-family: 'Shippori Mincho', serif;">
                        未来の運勢を<br>試してみる
                    </h2>
                    <p class="text-gray-600 dark:text-gray-300 font-bold text-sm md:text-base max-w-lg mx-auto leading-relaxed">
                        TENMEI Labsへようこそ。<br>ここでは開発中の実験的な機能を先行して体験できます。<br>スイッチをONにして、新しい参拝の形を探求しましょう。
                    </p>
                </div>

                <!-- ▼▼▼ 修正箇所：ぼかし対象のラッパー開始 ▼▼▼ -->
                <div id="lab-content-wrapper" class="max-w-2xl mx-auto space-y-6 pb-20">
                    
                    <!-- ラボ・グリッドコンテナ -->
                    <div id="lab-container" class="lab-grid-container">
                        
                        <!-- 1. 迎春・雅モード -->
                        <div class="lab-glass-card" onclick="TenmeiLab.openModal('newyear')">
                            <div class="lab-card-header">
                                <div class="lab-icon-box icon-bg-red"><i class="bi bi-flower1"></i></div>
                                <div class="lab-switch-wrapper" onclick="event.stopPropagation()">
                                    <label class="toggle-switch">
                                        <input type="checkbox" onchange="TenmeiLab.toggleNewYear(this)" id="switch-newyear">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="lab-card-body">
                                <h3>迎春・雅モード <span class="lab-badge badge-stable">Stable</span></h3>
                                <p class="lab-card-desc">サイト全体を紅白と金色の雅な装いに変更します。おめでたい雰囲気を演出します。</p>
                            </div>
                            <div class="lab-card-footer">詳細設定 <i class="bi bi-chevron-right"></i></div>
                        </div>

                        <!-- 2. 神速の祈り -->
                        <div class="lab-glass-card" onclick="TenmeiLab.openModal('speed')">
                            <div class="lab-card-header">
                                <div class="lab-icon-box icon-bg-blue"><i class="bi bi-lightning-charge-fill"></i></div>
                                <div class="lab-switch-wrapper" onclick="event.stopPropagation()">
                                    <label class="toggle-switch">
                                        <input type="checkbox" onchange="TenmeiLab.toggleSpeed(this)" id="switch-speed">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="lab-card-body">
                                <h3>神速の祈り <span class="lab-badge badge-beta">Beta</span></h3>
                                <p class="lab-card-desc">おみくじのカウントダウン演出を省略し、結果を最速で表示します。</p>
                            </div>
                            <div class="lab-card-footer">詳細設定 <i class="bi bi-chevron-right"></i></div>
                        </div>

                        <!-- 3. 宵闇の刻 -->
                        <div class="lab-glass-card" onclick="TenmeiLab.openModal('dark')">
                            <div class="lab-card-header">
                                <div class="lab-icon-box icon-bg-purple"><i class="bi bi-moon-stars-fill"></i></div>
                                <div class="lab-switch-wrapper" onclick="event.stopPropagation()">
                                    <label class="toggle-switch">
                                        <input type="checkbox" onchange="TenmeiLab.toggleDark(this)" id="switch-dark">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="lab-card-body">
                                <h3>宵闇の刻 <span class="lab-badge badge-stable">Stable</span></h3>
                                <p class="lab-card-desc">OS設定に関わらず、強制的にダークモードを適用し、夜の雰囲気を演出します。</p>
                            </div>
                            <div class="lab-card-footer">詳細設定 <i class="bi bi-chevron-right"></i></div>
                        </div>

                        <!-- 4. 言霊の増幅 -->
                        <div class="lab-glass-card" onclick="TenmeiLab.openModal('bigtext')">
                            <div class="lab-card-header">
                                <div class="lab-icon-box icon-bg-green"><i class="bi bi-type-h1"></i></div>
                                <div class="lab-switch-wrapper" onclick="event.stopPropagation()">
                                    <label class="toggle-switch">
                                        <input type="checkbox" onchange="TenmeiLab.toggleBigText(this)" id="switch-bigtext">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="lab-card-body">
                                <h3>言霊の増幅 <span class="lab-badge badge-beta">Beta</span></h3>
                                <p class="lab-card-desc">文字サイズを大きくし、神託の言葉をより力強く読みやすく表示します。</p>
                            </div>
                            <div class="lab-card-footer">詳細設定 <i class="bi bi-chevron-right"></i></div>
                        </div>

                        <!-- 5. 幽玄の霧 -->
                        <div class="lab-glass-card" onclick="TenmeiLab.openModal('mist')">
                            <div class="lab-card-header">
                                <div class="lab-icon-box icon-bg-gray"><i class="bi bi-cloud-haze2-fill"></i></div>
                                <div class="lab-switch-wrapper" onclick="event.stopPropagation()">
                                    <label class="toggle-switch">
                                        <input type="checkbox" onchange="TenmeiLab.toggleMist(this)" id="switch-mist">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="lab-card-body">
                                <h3>幽玄の霧 <span class="lab-badge badge-exp">Exp</span></h3>
                                <p class="lab-card-desc">画面全体に流れる霧のアニメーションを重ね、神秘的な没入感を高めます。</p>
                            </div>
                            <div class="lab-card-footer">詳細設定 <i class="bi bi-chevron-right"></i></div>
                        </div>

                        <!-- 6. 黄金の神域 -->
                        <div class="lab-glass-card" onclick="TenmeiLab.openModal('gold')">
                            <div class="lab-card-header">
                                <div class="lab-icon-box icon-bg-gold"><i class="bi bi-stars"></i></div>
                                <div class="lab-switch-wrapper" onclick="event.stopPropagation()">
                                    <label class="toggle-switch">
                                        <input type="checkbox" onchange="TenmeiLab.toggleGold(this)" id="switch-gold">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="lab-card-body">
                                <h3>黄金の神域 <span class="lab-badge badge-exp">Exp</span></h3>
                                <p class="lab-card-desc">サイトのアクセントカラーを「紅」から「黄金」へ変更し、豪華な装いにします。</p>
                            </div>
                            <div class="lab-card-footer">詳細設定 <i class="bi bi-chevron-right"></i></div>
                        </div>

                        <!-- 7. メンテナンス訓練 -->
                        <div class="lab-glass-card" onclick="checkMaintenance(true)" style="border-color: rgba(239, 68, 68, 0.4);">
                            <div class="lab-card-header">
                                <div class="lab-icon-box bg-black text-yellow-500"><i class="bi bi-cone-striped"></i></div>
                                <div class="lab-switch-wrapper">
                                    <button class="bg-gray-200 dark:bg-zinc-700 rounded-full w-12 h-6 flex items-center p-1">
                                        <i class="bi bi-play-fill text-gray-500"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="lab-card-body">
                                <h3>メンテナンス訓練 <span class="lab-badge badge-danger">Dev</span></h3>
                                <p class="lab-card-desc">強制的にメンテナンス画面を表示します。※再読み込みで復帰します。</p>
                            </div>
                            <div class="lab-card-footer text-red-500">実行する <i class="bi bi-exclamation-triangle"></i></div>
                        </div>

                    </div> <!-- /lab-grid-container -->
                </div> 
                <!-- ▲▲▲ ぼかし対象ラッパー（#lab-content-wrapper）はここで閉じる ▲▲▲ -->

                <!-- ▼▼▼ 修正箇所：ロック画面をラッパーの外に出す ▼▼▼ -->
                <!-- 非ログイン時のロック画面 -->
                <div id="lab-lock" class="lab-lock-container hidden">
                    <div class="lab-lock-card">
                        <div class="mb-4 text-6xl text-gray-300 dark:text-gray-600">
                            <i class="bi bi-lock-fill"></i>
                        </div>
                        <h3 class="text-xl font-black mb-3 text-gray-800 dark:text-white">会員限定エリア</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-8 leading-relaxed font-medium">
                            ここから先は会員様のみが入室できる<br>
                            天命実験室（Labs）です。
                        </p>
                        <button onclick="showView('auth')" class="btn-primary w-full py-3 shadow-lg font-bold text-lg">
                            ログインして入室
                        </button>
                    </div>
                </div>

                <!-- 詳細モーダル (全画面オーバーレイ) -->
                <div id="lab-modal" class="lab-modal-overlay" onclick="TenmeiLab.closeModal(event)">
                    <div class="lab-modal-card" onclick="event.stopPropagation()">
                        <button class="lab-close-btn" onclick="TenmeiLab.closeModal(null)"><i class="bi bi-x-lg"></i></button>
                        <div id="lab-modal-content">
                            <!-- JSでコンテンツ挿入 -->
                        </div>
                    </div>
                </div>
            </div> <!-- /lab-content-relative -->
        </section>

        <!-- ビュー: 都道府県別・運気ランキング -->
<section id="view-prefecture" class="view-section max-w-5xl mx-auto relative pb-20">
    <div class="text-center mb-10">
        <h2 class="text-3xl font-black mb-2 tracking-widest" style="font-family: 'Zen Old Mincho'">全国・土地の運気</h2>
        <p class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-widest">REGIONAL FORTUNE RANKING</p>
        
        <!-- 日付表示 -->
        <div class="mt-4 inline-block bg-white dark:bg-zinc-800 border border-gray-200 dark:border-gray-700 rounded-full px-6 py-2 shadow-sm">
            <p class="text-lg font-bold font-serif" id="pref-date-display">---</p>
        </div>
        
        <p class="text-sm themed-text-sub mt-4 max-w-2xl mx-auto">
            <!-- ▼ 追加箇所 ▼ -->
            <!-- 変更後 -->
            <span class="block mb-2 font-bold text-[var(--accent-red)]">日本時間 0:00 更新</span>
            <!-- ▲ 追加箇所 ▲ -->
            47都道府県の「地の利」を独自アルゴリズムで数値化。<br>
            スコアが高い土地ほど、良質なエネルギーが満ちています。
        </p>
    </div>

    <!-- 1位〜3位 表示エリア -->
    <div id="prefecture-top3" class="pref-top3-container">
        <!-- JSで自動挿入 -->
    </div>

    <!-- 4位以下 リストエリア -->
    <div class="border-t border-gray-200 dark:border-gray-700 my-8 pt-2">
        <p class="text-sm font-bold text-gray-400 mb-4 ml-2">4位以下のランキング</p>
        <div id="prefecture-list" class="pref-list-grid">
            <!-- JSで自動挿入 -->
        </div>
    </div>
</section>

        <!-- ビュー: 御守授与所 -->
<section id="view-omamori" class="view-section max-w-4xl mx-auto relative pb-20">
    <div class="text-center mb-8">
        <!-- 変更後 -->
        <h2 class="text-3xl font-black mb-2 tracking-widest text-[var(--accent-red)]" style="font-family: 'Zen Old Mincho'">デジタル御守授与所</h2>
        <p class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-widest">DIGITAL AMULET</p>
        <p class="text-sm themed-text-sub mt-4 leading-relaxed">
            あなたの願いに合わせて色と文様を選定し、<br>
            世界に一つの「デジタル御守」を授与いたします。
        </p>
    </div>

    <!-- ステップ1: 願い事選択 -->
    <div id="omamori-step-1">
        <div class="flex items-center justify-center gap-2 mb-6">
            <div class="h-px w-8 bg-gray-300 dark:bg-gray-700"></div>
            <span class="text-sm font-bold text-gray-500">願い事をお選びください</span>
            <div class="h-px w-8 bg-gray-300 dark:bg-gray-700"></div>
        </div>

        <div class="omamori-grid-container">
            <!-- 交通安全 -->
            <div class="wish-card wish-safety" onclick="OmamoriSystem.startPrayer('safety')">
                <div class="wish-icon-box"><i class="bi bi-car-front-fill"></i></div>
                <div class="wish-title">交通安全</div>
                <div class="wish-desc">道中の無事を祈る</div>
            </div>
            <!-- 健康長寿 -->
            <div class="wish-card wish-health" onclick="OmamoriSystem.startPrayer('health')">
                <div class="wish-icon-box"><i class="bi bi-bandaid-fill"></i></div>
                <div class="wish-title">健康長寿</div>
                <div class="wish-desc">健やかな毎日を</div>
            </div>
            <!-- 良縁成就 -->
            <div class="wish-card wish-love" onclick="OmamoriSystem.startPrayer('love')">
                <div class="wish-icon-box"><i class="bi bi-heart-fill"></i></div>
                <div class="wish-title">良縁成就</div>
                <div class="wish-desc">素敵な出会いを</div>
            </div>
            <!-- 金運上昇 -->
            <div class="wish-card wish-money" onclick="OmamoriSystem.startPrayer('money')">
                <div class="wish-icon-box"><i class="bi bi-currency-yen"></i></div>
                <div class="wish-title">金運上昇</div>
                <div class="wish-desc">豊かさを招く</div>
            </div>
            <!-- 学業成就 -->
            <div class="wish-card wish-study" onclick="OmamoriSystem.startPrayer('study')">
                <div class="wish-icon-box"><i class="bi bi-pen-fill"></i></div>
                <div class="wish-title">学業成就</div>
                <div class="wish-desc">合格・スキル向上</div>
            </div>
            <!-- 必勝祈願 -->
            <div class="wish-card wish-victory" onclick="OmamoriSystem.startPrayer('victory')">
                <div class="wish-icon-box"><i class="bi bi-trophy-fill"></i></div>
                <div class="wish-title">必勝祈願</div>
                <div class="wish-desc">勝負に打ち勝つ</div>
            </div>
            <!-- 厄除け -->
            <div class="wish-card wish-protect" onclick="OmamoriSystem.startPrayer('protect')">
                <div class="wish-icon-box"><i class="bi bi-shield-lock-fill"></i></div>
                <div class="wish-title">厄除け</div>
                <div class="wish-desc">災いを遠ざける</div>
            </div>
            <!-- 大願成就 -->
            <div class="wish-card wish-success" onclick="OmamoriSystem.startPrayer('success')">
                <div class="wish-icon-box"><i class="bi bi-stars"></i></div>
                <div class="wish-title">大願成就</div>
                <div class="wish-desc">大きな夢を叶える</div>
            </div>
        </div>
    </div>

    <!-- ステップ2: 祈祷中アニメーション -->
    <div id="omamori-step-2" class="hidden h-96 flex flex-col items-center justify-center">
        <div class="relative">
            <div class="prayer-light mb-8"></div>
            <div class="absolute top-0 left-0 w-full h-full animate-ping opacity-20 bg-yellow-200 rounded-full"></div>
        </div>
        <p class="text-2xl font-black animate-pulse tracking-widest mb-2" style="font-family: 'Zen Old Mincho'">祈祷中</p>
        <p class="text-sm themed-text-sub">願いを込めて織り上げております...</p>
    </div>

    <!-- ステップ3: 授与（結果） -->
    <div id="omamori-step-3" class="hidden">
        <p class="mb-6 font-bold text-lg border-b border-red-500 inline-block px-8 pb-1">授与</p>
        
        <!-- 授与ステージ（画像化対象） -->
        <div class="omamori-stage" id="omamori-capture-area">
            <div id="omamori-display"></div>
        </div>

        <div class="max-w-md mx-auto space-y-4">
            <div class="bg-gray-50 dark:bg-zinc-800 p-4 rounded text-sm text-gray-600 dark:text-gray-400 text-left">
                <i class="bi bi-info-circle mr-1"></i>
                この御守は画像として保存できます。スマートフォンの壁紙（待ち受け）に設定し、日々の守り神としてお持ち歩きください。
            </div>

            <button onclick="OmamoriSystem.saveImage()" class="btn-primary w-full justify-center py-4 text-lg shadow-lg">
                <i class="bi bi-download"></i> 御守を授かる（保存）
            </button>
            <button onclick="OmamoriSystem.reset()" class="px-6 py-3 rounded-full border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-800 transition w-full">
                <i class="bi bi-arrow-counterclockwise"></i> 別の願いを選ぶ
            </button>
        </div>
    </div>
</section>
        

   <!-- ビュー: 参拝の記録 (統計ダッシュボード) -->
<section id="view-stats" class="view-section max-w-4xl mx-auto relative pb-20">
    <div class="text-center mb-8">
        <h2 class="text-3xl font-black mb-2 tracking-widest" style="font-family: 'Zen Old Mincho'">参拝の記録</h2>
        <p class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-widest">PERSONAL STATISTICS</p>
    </div>

    <!-- コンテンツラッパー -->
    <div id="stats-content-wrapper">
        
        <!-- 1. ヒーローセクション (カード化・ホバー対応) -->
        <div class="stats-hero-grid">
            <div class="stats-hero-card hero-total stats-card-interactive" data-bg-text="参">
                <div class="stats-hero-label">総参拝数</div>
                <div class="stats-hero-value" id="hero-total-val">-</div>
            </div>
            <div class="stats-hero-card hero-daikichi stats-card-interactive" data-bg-text="吉">
                <div class="stats-hero-label">大吉獲得数</div>
                <div class="stats-hero-value" id="hero-daikichi-val">-</div>
            </div>
        </div>

        <!-- 2. インサイト (比較分析) -->
        <div id="stats-insight-area" class="stats-insight-box stats-card-interactive">
            <p class="text-center text-gray-400 text-sm">集計中...</p>
        </div>

        <!-- 3. 総参拝数の比較グラフ (独立) -->
        <div class="stats-graph-container stats-card-interactive mb-6">
            <div class="px-4 pb-2 border-b border-gray-100 dark:border-gray-700 mb-2">
                <h3 class="font-bold text-lg"><i class="bi bi-people-fill text-blue-500"></i> 参拝数比較</h3>
            </div>
            <!-- 目盛り線レイヤー -->
            <div id="grid-total" class="graph-grid-overlay"></div>
            <!-- グラフ本体 -->
            <div id="graph-total-body" class="px-4 pb-4 relative"></div>
        </div>

        <!-- 4. 運勢スペクトル (詳細グラフ) -->
        <div class="stats-graph-container stats-card-interactive">
            <div class="px-4 pb-2 border-b border-gray-100 dark:border-gray-700 mb-2 flex justify-between items-end">
                <h3 class="font-bold text-lg"><i class="bi bi-bar-chart-steps text-red-500"></i> 運勢分布</h3>
                <div class="flex gap-3 text-[10px] pb-1">
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-red-600 rounded"></span>あなた</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-gray-300 dark:bg-zinc-600 rounded"></span>平均</span>
                </div>
            </div>
            <!-- 目盛り線レイヤー -->
            <div id="grid-spectrum" class="graph-grid-overlay"></div>
            <!-- グラフ本体 -->
            <div id="stats-spectrum-list" class="px-4 pb-4 relative"></div>
        </div>

    </div>

    </div>

    <!-- 非ログイン時のロック画面 -->
    <div id="stats-lock" class="lab-lock-overlay hidden flex items-center justify-center">
        <div class="bg-white/90 dark:bg-black/80 backdrop-blur-xl p-8 rounded-2xl shadow-2xl max-w-sm w-full border border-gray-100 dark:border-gray-800 text-center mx-4">
            <i class="bi bi-person-lock text-5xl text-gray-400 mb-4 block"></i>
            <h3 class="text-xl font-bold mb-2">記録は閉じられています</h3>
            <p class="text-sm text-gray-500 mb-6 leading-relaxed">
                自分だけの参拝記録を残し、<br>運勢の傾向を分析するにはログインが必要です。
            </p>
            <button onclick="showView('auth')" class="btn-primary w-full shadow-lg">
                <i class="bi bi-person-plus-fill"></i> 記録を始める
            </button>
        </div>
    </div>
</section>

        <!-- ビュー: ログイン/登録 (Bento UI版) -->
        <section id="view-auth" class="view-section">
            <div class="max-w-4xl mx-auto mb-8 text-center">
                <h2 class="text-3xl font-black tracking-widest" style="font-family: 'Zen Old Mincho'">参拝証の発行</h2>
                <p class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-widest">AUTHENTICATION</p>
            </div>

            <!-- 1. 初期選択画面 -->
            <div id="auth-selection" class="auth-bento-grid">
                
                <!-- ログインボタン -->
                <div class="stats-card-interactive auth-action-card border-blue-200 dark:border-blue-900" onclick="startAuthFlow('login')">
                    <div class="auth-icon-circle bg-blue-100 dark:bg-blue-900/30 text-blue-600">
                        <i class="bi bi-box-arrow-in-right"></i>
                    </div>
                    <h3 class="font-bold text-xl mb-1">ログイン</h3>
                    <p class="text-xs text-gray-500">参拝証をお持ちの方</p>
                </div>

                <!-- 新規登録ボタン -->
                <div class="stats-card-interactive auth-action-card border-green-200 dark:border-green-900" onclick="startAuthFlow('register')">
                    <div class="auth-icon-circle bg-green-100 dark:bg-green-900/30 text-green-600">
                        <i class="bi bi-person-plus-fill"></i>
                    </div>
                    <h3 class="font-bold text-xl mb-1">新規登録</h3>
                    <p class="text-xs text-gray-500">初めての方はこちら</p>
                </div>

                <!-- 説明カード -->
                <div class="stats-card-interactive auth-info-card">
                    <div class="text-3xl text-yellow-500 pl-2">
                        <i class="bi bi-stars"></i>
                    </div>
                    <div class="text-left">
                        <h4 class="font-bold text-sm mb-1">会員限定の機能</h4>
                        <p class="text-xs text-gray-500 leading-relaxed">
                            アカウントを作成すると、「おみくじの轍（履歴）」の永続保存や、「TENMEI Labs」の実験機能が利用可能になります。
                        </p>
                    </div>
                </div>
            </div>

            <!-- 2. 入力フォーム (ログイン/登録共通) -->
            <div id="auth-step-1" class="hidden auth-form-container stats-card-interactive">
                <div class="flex items-center mb-6">
                    <button onclick="backToAuthSelection()" class="text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition mr-4">
                        <i class="bi bi-arrow-left text-xl"></i>
                    </button>
                    <h3 class="font-bold text-xl" id="auth-form-title">ログイン</h3>
                </div>

                <!-- ログイン用フィールド -->
                <div id="form-login-fields" class="hidden space-y-4">
                    <div>
                        <label class="profile-input-label">メールアドレス</label>
                        <input type="email" id="login-email" class="profile-input-field" placeholder="example@email.com">
                    </div>
                    <div>
                        <label class="profile-input-label">パスワード</label>
                        <input type="password" id="login-password" class="profile-input-field" placeholder="********">
                    </div>
                    <button onclick="initiateAuth('login')" class="btn-primary w-full justify-center py-3 mt-2 shadow-lg">
                        <i class="bi bi-send"></i> 認証コードを送信
                    </button>
                </div>

                <!-- 登録用フィールド -->
                <div id="form-register-fields" class="hidden space-y-4">
                    <div>
                        <label class="profile-input-label">参拝者名 (ユーザー名)</label>
                        <input type="text" id="reg-username" class="profile-input-field" placeholder="天命 太郎">
                    </div>
                    <div>
                        <label class="profile-input-label">メールアドレス</label>
                        <input type="email" id="reg-email" class="profile-input-field" placeholder="example@email.com">
                    </div>
                    <div>
                        <label class="profile-input-label">パスワード</label>
                        <input type="password" id="reg-password" class="profile-input-field" placeholder="********">
                    </div>                    
                    <button onclick="initiateAuth('register')" class="btn-primary w-full justify-center py-3 mt-2 shadow-lg">
                        <i class="bi bi-send"></i> 認証コードを送信
                    </button>
                </div>
            </div>

            <!-- 3. 認証コード入力 (モダンUI) -->
            <div id="auth-step-2" class="hidden auth-form-container stats-card-interactive text-center">
                <div class="mb-6">
                    <i class="bi bi-envelope-check text-5xl text-red-500 animate-pulse"></i>
                </div>
                <h3 class="font-bold text-lg mb-2">認証コードを入力</h3>
                <p class="text-xs text-gray-500 mb-6 leading-relaxed">
                    送信されたメールに記載されている<br>6桁の数字を入力してください。
                </p>
                
                <div class="mb-6 relative">
                    <!-- プレースホルダー削除: placeholder="" -->
                    <input type="text" id="auth-code-input" maxlength="6" 
                           class="auth-code-input-modern" 
                           placeholder="" 
                           autocomplete="one-time-code"
                           inputmode="numeric"
                           oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                    <p class="text-[10px] text-gray-400 mt-2">半角数字のみ入力可能</p>
                </div>

                <button onclick="finalizeAuth()" class="btn-primary w-full justify-center py-3 shadow-lg mb-4">
                    <i class="bi bi-check-lg"></i> 認証を完了する
                </button>
                
                <button onclick="backToAuthStep1()" class="text-xs text-gray-400 hover:text-red-500 underline">
                    入力画面に戻る
                </button>
            </div>
        </section>

        <!-- ビュー: アカウント設定 (Bento UI版) -->
        <section id="view-profile" class="view-section">
            <div class="max-w-4xl mx-auto mb-6 text-center">
                <h2 class="text-3xl font-black tracking-widest" style="font-family: 'Zen Old Mincho'">アカウント設定</h2>
                <p class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-widest">ACCOUNT SETTINGS</p>
            </div>

            <!-- JSでここにコンテンツが注入されます -->
            <div id="profile-dashboard-content"></div>
        </section>

        <!-- ビュー: おみくじの轍 (履歴) -->
<section id="view-history" class="view-section max-w-4xl mx-auto relative pb-20">
    <!-- タイトル -->
    <div class="text-center mb-8">
        <h2 class="text-3xl font-black mb-2 tracking-widest" style="font-family: 'Zen Old Mincho'">おみくじの轍</h2>
        <p class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-widest">TIMELINE OF DESTINY</p>
    </div>

    <!-- コンテンツコンテナ -->
    <div id="history-container">
        
        <!-- 1. 統計ダッシュボード -->
        <div class="history-stats-grid">
            <div class="history-stat-card stat-card-personal">
                <div class="stat-label">あなたの参拝数</div>
                <div class="stat-value text-red-600" id="personal-history-count">-</div>
            </div>
            <div class="history-stat-card stat-card-global">
                <div class="stat-label">みんなの参拝数</div>
                <div class="stat-value text-indigo-600 dark:text-indigo-400" id="global-history-count">-</div>
            </div>
        </div>

        <!-- ▼▼▼ 追加: 詳細統計＆推移グラフエリア ▼▼▼ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
            
            <!-- A. 本日の傾向 (ホームと同じもの) -->
            <div class="bento-card" style="min-height: 300px;">
                <div class="flex justify-between items-center mb-4 border-b border-gray-200 dark:border-gray-700 pb-2">
                    <h3 class="font-bold flex items-center gap-2 text-sm"><i class="bi bi-bar-chart-line-fill text-red-500"></i> 本日の傾向 (詳細)</h3>
                </div>
                <div class="overflow-y-auto pr-2 custom-scrollbar" style="height: 200px;">
                    <div class="space-y-2 text-xs">
                        <!-- 大吉 -->
                        <div><div class="flex justify-between mb-1"><span>大吉</span><span><span id="hist-cnt-daikichi" class="mr-2 opacity-70 font-mono">0</span><span id="hist-stat-daikichi">0.00%</span></span></div><div class="w-full bg-gray-100 dark:bg-zinc-700 h-1.5 rounded"><div id="hist-bar-daikichi" class="bg-yellow-400 h-1.5 rounded transition-all duration-1000" style="width: 0%"></div></div></div>
                        <!-- 中吉 -->
                        <div><div class="flex justify-between mb-1"><span>中吉</span><span><span id="hist-cnt-chukichi" class="mr-2 opacity-70 font-mono">0</span><span id="hist-stat-chukichi">0.00%</span></span></div><div class="w-full bg-gray-100 dark:bg-zinc-700 h-1.5 rounded"><div id="hist-bar-chukichi" class="bg-orange-400 h-1.5 rounded transition-all duration-1000" style="width: 0%"></div></div></div>
                        <!-- 小吉 -->
                        <div><div class="flex justify-between mb-1"><span>小吉</span><span><span id="hist-cnt-shokichi" class="mr-2 opacity-70 font-mono">0</span><span id="hist-stat-shokichi">0.00%</span></span></div><div class="w-full bg-gray-100 dark:bg-zinc-700 h-1.5 rounded"><div id="hist-bar-shokichi" class="bg-green-400 h-1.5 rounded transition-all duration-1000" style="width: 0%"></div></div></div>
                        <!-- 吉 -->
                        <div><div class="flex justify-between mb-1"><span>吉</span><span><span id="hist-cnt-kichi" class="mr-2 opacity-70 font-mono">0</span><span id="hist-stat-kichi">0.00%</span></span></div><div class="w-full bg-gray-100 dark:bg-zinc-700 h-1.5 rounded"><div id="hist-bar-kichi" class="bg-red-400 h-1.5 rounded transition-all duration-1000" style="width: 0%"></div></div></div>
                        <!-- 半吉 -->
                        <div><div class="flex justify-between mb-1"><span>半吉</span><span><span id="hist-cnt-hankichi" class="mr-2 opacity-70 font-mono">0</span><span id="hist-stat-hankichi">0.00%</span></span></div><div class="w-full bg-gray-100 dark:bg-zinc-700 h-1.5 rounded"><div id="hist-bar-hankichi" class="bg-red-300 h-1.5 rounded transition-all duration-1000" style="width: 0%"></div></div></div>
                        <!-- 末吉 -->
                        <div><div class="flex justify-between mb-1"><span>末吉</span><span><span id="hist-cnt-suekichi" class="mr-2 opacity-70 font-mono">0</span><span id="hist-stat-suekichi">0.00%</span></span></div><div class="w-full bg-gray-100 dark:bg-zinc-700 h-1.5 rounded"><div id="hist-bar-suekichi" class="bg-blue-400 h-1.5 rounded transition-all duration-1000" style="width: 0%"></div></div></div>
                        <!-- 末小吉 -->
                        <div><div class="flex justify-between mb-1"><span>末小吉</span><span><span id="hist-cnt-sueshokichi" class="mr-2 opacity-70 font-mono">0</span><span id="hist-stat-sueshokichi">0.00%</span></span></div><div class="w-full bg-gray-100 dark:bg-zinc-700 h-1.5 rounded"><div id="hist-bar-sueshokichi" class="bg-blue-300 h-1.5 rounded transition-all duration-1000" style="width: 0%"></div></div></div>
                        <!-- 凶 -->
                        <div><div class="flex justify-between mb-1"><span>凶</span><span><span id="hist-cnt-kyo" class="mr-2 opacity-70 font-mono">0</span><span id="hist-stat-kyo">0.00%</span></span></div><div class="w-full bg-gray-100 dark:bg-zinc-700 h-1.5 rounded"><div id="hist-bar-kyo" class="bg-gray-400 h-1.5 rounded transition-all duration-1000" style="width: 0%"></div></div></div>
                        <!-- 小凶 -->
                        <div><div class="flex justify-between mb-1"><span>小凶</span><span><span id="hist-cnt-shokyo" class="mr-2 opacity-70 font-mono">0</span><span id="hist-stat-shokyo">0.00%</span></span></div><div class="w-full bg-gray-100 dark:bg-zinc-700 h-1.5 rounded"><div id="hist-bar-shokyo" class="bg-gray-500 h-1.5 rounded transition-all duration-1000" style="width: 0%"></div></div></div>
                        <!-- 半凶 -->
                        <div><div class="flex justify-between mb-1"><span>半凶</span><span><span id="hist-cnt-hankyo" class="mr-2 opacity-70 font-mono">0</span><span id="hist-stat-hankyo">0.00%</span></span></div><div class="w-full bg-gray-100 dark:bg-zinc-700 h-1.5 rounded"><div id="hist-bar-hankyo" class="bg-gray-600 dark:bg-gray-400 h-1.5 rounded transition-all duration-1000" style="width: 0%"></div></div></div>
                        <!-- 末凶 -->
                        <div><div class="flex justify-between mb-1"><span>末凶</span><span><span id="hist-cnt-suekyo" class="mr-2 opacity-70 font-mono">0</span><span id="hist-stat-suekyo">0.00%</span></span></div><div class="w-full bg-gray-100 dark:bg-zinc-700 h-1.5 rounded"><div id="hist-bar-suekyo" class="bg-gray-700 h-1.5 rounded transition-all duration-1000" style="width: 0%"></div></div></div>
                        <!-- 大凶 -->
                        <div><div class="flex justify-between mb-1"><span>大凶</span><span><span id="hist-cnt-daikyo" class="mr-2 opacity-70 font-mono">0</span><span id="hist-stat-daikyo">0.00%</span></span></div><div class="w-full bg-gray-100 dark:bg-zinc-700 h-1.5 rounded"><div id="hist-bar-daikyo" class="bg-black h-1.5 rounded transition-all duration-1000" style="width: 0%"></div></div></div>
                    </div>
                </div>
            </div>

            <!-- B. リアルタイム推移グラフ (ダブル表示) -->
            <div class="bento-card relative overflow-hidden" style="grid-column: span 12; min-height: 320px;">
                <div class="flex justify-between items-center mb-4 border-b border-gray-200 dark:border-gray-700 pb-2 z-10 relative">
                    <h3 class="font-bold flex items-center gap-2 text-sm">
                        <i class="bi bi-activity text-indigo-500"></i> 
                        <span>リアルタイム推移 (1分足)</span>
                    </h3>
                    <div class="flex gap-3 text-[10px]">
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-500"></span>発行数</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span>参拝者</span>
                    </div>
                </div>
                
                <!-- 2つのグラフを並べるラッパー -->
                <div class="charts-wrapper" id="charts-container">
                    
                    <!-- 左：累計グラフ -->
                    <div class="chart-box">
                        <p class="absolute top-0 left-10 text-[10px] text-gray-400 font-bold">▼ 累計 (合計値)</p>
                        <svg id="chart-svg-total" width="100%" height="100%" viewBox="0 0 400 200" preserveAspectRatio="none" class="w-full h-full">
                            <g id="grid-total" class="text-gray-300 dark:text-zinc-700"></g>
                            <path id="line-total-issued" fill="none" stroke="#eab308" stroke-width="2" vector-effect="non-scaling-stroke" />
                            <path id="line-total-users" fill="none" stroke="#ef4444" stroke-width="2" vector-effect="non-scaling-stroke" />
                            <g id="axis-total-left"></g>
                            <g id="axis-total-right"></g>
                            <line id="hover-line-total" class="chart-hover-line" y1="0" y2="100%" />
                            <rect id="overlay-total" width="100%" height="100%" fill="transparent" style="cursor: crosshair;" />
                        </svg>
                    </div>

                    <!-- 右：変化量グラフ -->
                    <div class="chart-box">
                        <p class="absolute top-0 left-10 text-[10px] text-gray-400 font-bold">▼ 変化 (1分ごとの増加数)</p>
                        <svg id="chart-svg-delta" width="100%" height="100%" viewBox="0 0 400 200" preserveAspectRatio="none" class="w-full h-full">
                            <g id="grid-delta" class="text-gray-300 dark:text-zinc-700"></g>
                            <path id="line-delta-issued" fill="none" stroke="#eab308" stroke-width="2" vector-effect="non-scaling-stroke" />
                            <path id="line-delta-users" fill="none" stroke="#ef4444" stroke-width="2" vector-effect="non-scaling-stroke" />
                            <g id="axis-delta-left"></g>
                            <g id="axis-delta-right"></g>
                            <line id="hover-line-delta" class="chart-hover-line" y1="0" y2="100%" />
                            <rect id="overlay-delta" width="100%" height="100%" fill="transparent" style="cursor: crosshair;" />
                        </svg>
                    </div>

                </div>
                
                <!-- ローディング表示 -->
                <div id="chart-loading" class="absolute inset-0 flex items-center justify-center text-gray-400 text-xs bg-white/80 dark:bg-black/80 z-20">
                    データ収集中...
                </div>
            </div>
                
                <p class="text-[10px] text-gray-400 text-right mt-1 z-10 relative">※過去60分間の推移 (毎分更新)</p>
            </div>
        </div>
        <!-- ▲▲▲ 追加ここまで ▲▲▲ -->

        <!-- 2. コントロールバー (検索) -->
        <div class="history-control-bar">
            <div class="flex items-center gap-2 mb-1">
                <i class="bi bi-sliders text-gray-400"></i>
                <span class="text-xs font-bold text-gray-500">条件を絞り込む</span>
            </div>
            
            <div class="control-group-row">
                <select id="search-type" class="modern-filter-select flex-1" style="min-width: 120px;">
                    <option value="all">全ての運勢</option>
                    <option value="大吉">大吉</option>
                    <option value="中吉">中吉</option>
                    <option value="小吉">小吉</option>
                    <option value="吉">吉</option>
                    <option value="半吉">半吉</option>
                    <option value="末吉">末吉</option>
                    <option value="末小吉">末小吉</option>
                    <option value="凶">凶</option>
                    <option value="小凶">小凶</option>
                    <option value="半凶">半凶</option>
                    <option value="末凶">末凶</option>
                    <option value="大凶">大凶</option>
                </select>
                <input type="text" id="search-keyword" placeholder="ユーザー名で検索" class="modern-filter-input flex-[2]">
            </div>
            
            <div class="control-group-row">
                <input type="date" id="search-date-start" class="modern-filter-input flex-1">
                <span class="self-center text-gray-400">～</span>
                <input type="date" id="search-date-end" class="modern-filter-input flex-1">
                
                <button onclick="filterHistory()" class="btn-primary py-2 px-6 text-sm flex-shrink-0 shadow-md">
                    <i class="bi bi-search"></i> 検索
                </button>
                <button onclick="resetSearch()" class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition text-sm flex-shrink-0">
                    <i class="bi bi-arrow-counterclockwise"></i>
                </button>
            </div>
            
            <div class="flex justify-between items-center mt-1 px-1">
                <div class="text-xs text-gray-400" id="history-view-mode">全期間の記録</div>
                <div class="text-xs font-bold text-gray-500">
                    Hit: <span id="search-result-count" class="text-red-600 text-lg mx-1">0</span> 件
                </div>
            </div>
        </div>

        <!-- 3. タイムラインリスト -->
        <div class="bg-white dark:bg-zinc-900 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-gray-800">
            <div class="timeline-container" id="history-list">
                <!-- JSでここにアイテムが挿入されます -->
            </div>
            
            <!-- ページネーション -->
            <div id="history-pagination" class="flex justify-center items-center gap-4 mt-8 pt-6 border-t border-gray-100 dark:border-gray-800"></div>
        </div>

    </div>

    <!-- 非ログイン時のオーバーレイ -->
    <div id="history-login-overlay" class="history-overlay hidden">
        <i class="bi bi-lock-fill text-5xl text-gray-300 mb-4 block"></i>
        <h3 class="text-xl font-bold mb-2">轍を見るには会員証が必要です</h3>
        <p class="text-sm text-gray-500 mb-6 leading-relaxed">
            ログインすると、あなた自身の過去の運勢と、<br>他の参拝者の記録を閲覧・検索することができます。
        </p>
        <button onclick="showView('auth')" class="btn-primary shadow-lg">
            <i class="bi bi-person-check"></i> ログイン / 登録
        </button>
    </div>
</section>

        <!-- ビュー: 社務所だより（検索・ページ機能付き） -->
<section id="view-news" class="view-section max-w-4xl mx-auto relative pb-20">
    <div class="text-center mb-8">
        <h2 class="text-3xl font-black mb-2 tracking-widest" style="font-family: 'Zen Old Mincho'">社務所だより</h2>
        <p class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-widest">OFFICIAL NEWS</p>
    </div>
    
    <!-- 検索コントロールバー -->
    <div class="news-control-bar">
        <div class="flex items-center gap-2 mb-2">
            <i class="bi bi-search text-gray-400"></i>
            <span class="text-xs font-bold text-gray-500">記事を探す</span>
        </div>
        <input type="text" id="news-search-input" placeholder="キーワードを入力..." 
               class="modern-filter-input w-full"
               oninput="handleSearch('news', this.value)">
    </div>

    <!-- 記事グリッドリスト -->
    <div id="view-news-list" class="news-grid-container">
        <!-- JSでカードが自動挿入されます -->
    </div>

    <!-- ページネーション -->
    <div id="news-pagination" class="flex justify-center items-center gap-4 mt-8">
        <!-- JSで自動挿入 -->
    </div>
</section>

        <!-- ビュー: 神籤草子（検索・ページ機能付き） -->
<section id="view-column" class="view-section max-w-4xl mx-auto relative pb-20">
    <div class="text-center mb-8">
        <h2 class="text-3xl font-black mb-2 tracking-widest" style="font-family: 'Zen Old Mincho'">神籤草子</h2>
        <p class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-widest">SACRED COLUMNS</p>
    </div>
    
    <!-- 検索コントロールバー (ニュースと共通デザイン) -->
    <div class="news-control-bar">
        <div class="flex items-center gap-2 mb-2">
            <i class="bi bi-book text-gray-400"></i>
            <span class="text-xs font-bold text-gray-500">書架を検索</span>
        </div>
        <input type="text" id="column-search-input" placeholder="キーワードを入力..." 
               class="modern-filter-input w-full"
               oninput="handleSearch('column', this.value)">
    </div>

    <!-- コラムグリッドリスト -->
    <div id="view-column-list" class="column-grid-container">
        <!-- JSでカードが自動挿入されます -->
    </div>

    <!-- ページネーション -->
    <div id="column-pagination" class="flex justify-center items-center gap-4 mt-8">
        <!-- JSで自動挿入 -->
    </div>
</section>

        <!-- ビュー: 記事詳細 -->
        <section id="view-article-detail" class="view-section">
            <div class="max-w-3xl mx-auto mb-4">
                <button onclick="articleBack()" class="text-sm themed-text-sub hover:text-red-500">
                    <i class="bi bi-arrow-left"></i> 戻る
                </button>
            </div>
            <div id="article-detail-content" class="article-container themed-card">
                <!-- JSでコンテンツ挿入 -->
            </div>
        </section>

        
    <!-- ビュー: 当サイトについて・利用規約・詳細解説 (目次・PDF対応版) -->
        <section id="view-about" class="view-section max-w-4xl mx-auto">
            <!-- PDF化する対象エリア（カード全体） -->
            <div id="about-content-area" class="themed-card p-10 rounded shadow-lg text-justify leading-loose bg-white dark:bg-zinc-800">
                <h2 class="text-3xl font-bold mb-8 text-center border-b border-gray-300 dark:border-gray-600 pb-4">当サイトについて・利用規約・詳細解説</h2>
                
                <div class="text-right text-sm themed-text-sub mb-8">
                    制定日: 2026年1月2日<br>
                    改定日: 2026年1月25日 (第7版)<br>
                    運営・開発: nden148<br>
                    基盤技術: Cloudflare Workers / Turso (LibSQL)
                </div>

                <div id="about-toc-container" class="mb-8 p-6 bg-gray-50 dark:bg-black/20 rounded-xl border border-gray-200 dark:border-gray-700 hidden" data-html2canvas-ignore="true">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-300 dark:border-gray-600 pb-2">
                        <h3 class="font-bold text-lg m-0 p-0 border-none"><i class="bi bi-list-ul mr-2"></i>目次</h3>
                    </div>
                    <ul class="text-sm space-y-2 list-none m-0 p-0 text-gray-700 dark:text-gray-300" id="about-toc-list"></ul>
                </div>

                <p class="mb-6 font-bold text-center">
                    〜 天命乃杜は、テクノロジーで再定義された「現代の鎮守の杜」です 〜
                </p>

                <!-- 徹底比較表 -->
                <h3 class="text-xl font-bold mt-8 mb-4 border-l-4 border-red-500 pl-3">第1章 サービス性能・機能比較（完全版）</h3>
                <p class="mb-4 text-sm">
                    本表は、当サイト「天命乃杜」と、インターネット上に存在する主要な占いサービス形式（老舗Webサイト型、神社公式型、大手ポータル型、ネイティブアプリ型）の仕様を、客観的な技術指標に基づき比較したものです。特定の他社サービスを貶める意図はなく、利用者が自身のニーズに合ったサービスを選択するための判断材料として提供します。
                </p>
                <div class="overflow-x-auto mb-8">
                    <table class="comparison-table" style="font-size: 0.75rem; min-width: 900px; white-space: nowrap;">
                        <thead>
                            <tr class="bg-gray-200 dark:bg-zinc-700">
                                <th class="p-2 border border-gray-300 dark:border-gray-600" style="width: 10%;">大分類</th>
                                <th class="p-2 border border-gray-300 dark:border-gray-600" style="width: 15%;">詳細項目</th>
                                <th class="p-2 border border-gray-300 dark:border-gray-600 bg-red-100 dark:bg-red-900 text-red-900 dark:text-red-100 font-bold" style="width: 25%;">⛩️ 運勢・天命乃杜<br>(当サイト)</th>
                                <th class="p-2 border border-gray-300 dark:border-gray-600" style="width: 12%;">某老舗WebサイトA<br>(シンプル型)</th>
                                <th class="p-2 border border-gray-300 dark:border-gray-600" style="width: 12%;">某神社公式Web B<br>(儀式型)</th>
                                <th class="p-2 border border-gray-300 dark:border-gray-600" style="width: 12%;">某大手ポータルC<br>(メディア型)</th>
                                <th class="p-2 border border-gray-300 dark:border-gray-600" style="width: 14%;">有料アプリD<br>(課金型)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 1. 基本設計 -->
                            <tr><td rowspan="6" class="font-bold bg-gray-50 dark:bg-zinc-800">基本設計</td>
                                <td class="font-bold">利用料金</td>
                                <td class="highlight font-bold">完全無料</td>
                                <td>無料</td>
                                <td>無料</td>
                                <td>無料 (一部有料)</td>
                                <td>月額/都度課金</td>
                            </tr>
                            <tr>
                                <td class="font-bold">広告表示</td>
                                <td class="highlight font-bold">なし (静寂重視)</td>
                                <td>あり (追尾広告等)</td>
                                <td>なし</td>
                                <td>大量にあり</td>
                                <td>あり (無料版)</td>
                            </tr>
                            <tr>
                                <td class="font-bold">会員登録</td>
                                <td class="highlight">任意 (メール認証)</td>
                                <td>なし</td>
                                <td>なし (参拝者入力のみ)</td>
                                <td>ID登録必須</td>
                                <td>必須</td>
                            </tr>
                            <tr>
                                <td class="font-bold">更新頻度</td>
                                <td class="highlight">安定稼働 (完成済)</td>
                                <td>低 (数年放置)</td>
                                <td>低 (行事毎のみ)</td>
                                <td>高 (記事追加)</td>
                                <td>中 (バグ修正)</td>
                            </tr>
                            <tr>
                                <td class="font-bold">動作環境</td>
                                <td class="highlight">SPA (アプリ的挙動)</td>
                                <td>MPA (ページ遷移有)</td>
                                <td>MPA / Flash代替</td>
                                <td>MPA (重い)</td>
                                <td>iOS/Android</td>
                            </tr>
                            <tr>
                                <td class="font-bold">スマホ最適化</td>
                                <td class="highlight">◎ 完全レスポンシブ</td>
                                <td>△ PCレイアウト残り</td>
                                <td>○ 対応</td>
                                <td>○ 対応</td>
                                <td>◎ ネイティブ</td>
                            </tr>

                            <!-- 2. おみくじ機能 -->
                            <tr><td rowspan="7" class="font-bold bg-gray-50 dark:bg-zinc-800">おみくじ<br>体験</td>
                                <td class="font-bold">抽選ロジック</td>
                                <td class="highlight">12段階 + パラメータ</td>
                                <td>7段階 (標準)</td>
                                <td>7段階 (標準)</td>
                                <td>不明</td>
                                <td>操作の可能性有</td>
                            </tr>
                            <tr>
                                <td class="font-bold">アニメーション</td>
                                <td class="highlight">物理演算風・和風演出</td>
                                <td>なし (静止画)</td>
                                <td>箱を振る動画等</td>
                                <td>簡素</td>
                                <td>豪華エフェクト</td>
                            </tr>
                            <tr>
                                <td class="font-bold">結果の種別</td>
                                <td class="highlight">動的生成 (数億通り)</td>
                                <td>固定画像 (数十枚)</td>
                                <td>固定画像 (数十枚)</td>
                                <td>テキストDB</td>
                                <td>テキストDB</td>
                            </tr>
                            <tr>
                                <td class="font-bold">和歌・漢詩</td>
                                <td class="highlight">あり (独自解釈付)</td>
                                <td>なし</td>
                                <td>あり (本格的)</td>
                                <td>なし</td>
                                <td>一部あり</td>
                            </tr>
                            <tr>
                                <td class="font-bold">ラッキー項目</td>
                                <td class="highlight">物・色・場所・人</td>
                                <td>なし</td>
                                <td>なし</td>
                                <td>物・色</td>
                                <td>多数</td>
                            </tr>
                            <tr>
                                <td class="font-bold">願事・待人等</td>
                                <td class="highlight">7項目詳細</td>
                                <td>一言のみ</td>
                                <td>あり</td>
                                <td>あり</td>
                                <td>あり</td>
                            </tr>
                            <tr>
                                <td class="font-bold">効果音</td>
                                <td class="highlight">なし (静寂)</td>
                                <td>なし</td>
                                <td>あり (鈴・拍手等)</td>
                                <td>なし</td>
                                <td>あり</td>
                            </tr>

                            <!-- 3. データ管理 -->
                            <tr><td rowspan="6" class="font-bold bg-gray-50 dark:bg-zinc-800">データ<br>保存</td>
                                <td class="font-bold">履歴保存</td>
                                <td class="highlight font-bold">◎ 永続保存 (轍)</td>
                                <td>× 不可 (消失)</td>
                                <td>× 不可</td>
                                <td>△ Cookieのみ</td>
                                <td>○ アプリ内</td>
                            </tr>
                            <tr>
                                <td class="font-bold">クラウド同期</td>
                                <td class="highlight">◎ 可能 (Turso)</td>
                                <td>× 不可</td>
                                <td>× 不可</td>
                                <td>○ ID連携時</td>
                                <td>○ ID連携時</td>
                            </tr>
                            <tr>
                                <td class="font-bold">履歴検索</td>
                                <td class="highlight">◎ 検索・ページ機能</td>
                                <td>-</td>
                                <td>-</td>
                                <td>× なし</td>
                                <td>△ 最近のみ</td>
                            </tr>
                            <tr>
                                <td class="font-bold">結果再表示</td>
                                <td class="highlight">◎ いつでも可能</td>
                                <td>× 不可</td>
                                <td>× 不可</td>
                                <td>× 不可</td>
                                <td>○ 可能</td>
                            </tr>
                            <tr>
                                <td class="font-bold">統計閲覧</td>
                                <td class="highlight">◎ リアルタイム詳細</td>
                                <td>△ 累計のみ(不正確)</td>
                                <td>× なし</td>
                                <td>× なし</td>
                                <td>× なし</td>
                            </tr>
                            <tr>
                                <td class="font-bold">エクスポート</td>
                                <td class="highlight">画像保存 (高画質)</td>
                                <td>テキスト選択のみ</td>
                                <td>不可</td>
                                <td>スクショ推奨</td>
                                <td>スクショ推奨</td>
                            </tr>

                            <!-- 4. 複合機能 -->
                            <tr><td rowspan="7" class="font-bold bg-gray-50 dark:bg-zinc-800">12星座<br>その他</td>
                                <td class="font-bold">12星座占い</td>
                                <td class="highlight font-bold">◎ あり (血液型掛合)</td>
                                <td>× なし</td>
                                <td>× なし</td>
                                <td>◎ あり (メイン)</td>
                                <td>◎ あり</td>
                            </tr>
                            <tr>
                                <td class="font-bold">再現性(運命)</td>
                                <td class="highlight">日付シード固定</td>
                                <td>-</td>
                                <td>-</td>
                                <td>ランダム多し</td>
                                <td>固定</td>
                            </tr>
                            <tr>
                                <td class="font-bold">土地の運気</td>
                                <td class="highlight font-bold">◎ 47都道府県ランク</td>
                                <td>× なし</td>
                                <td>× なし</td>
                                <td>× なし</td>
                                <td>△ 有料機能</td>
                            </tr>
                            <tr>
                                <td class="font-bold">デジタル授与品</td>
                                <td class="highlight font-bold">◎ 御守作成 (名前入)</td>
                                <td>× なし</td>
                                <td>△ 画像のみ</td>
                                <td>× なし</td>
                                <td>× なし</td>
                            </tr>
                            <tr>
                                <td class="font-bold">カレンダー</td>
                                <td class="highlight">30日予報グラフ</td>
                                <td>-</td>
                                <td>-</td>
                                <td>簡易表示</td>
                                <td>有料</td>
                            </tr>
                            <tr>
                                <td class="font-bold">お気に入り</td>
                                <td class="highlight">あり (5件まで)</td>
                                <td>-</td>
                                <td>-</td>
                                <td>あり</td>
                                <td>あり</td>
                            </tr>
                            <tr>
                                <td class="font-bold">コラム・記事</td>
                                <td class="highlight">あり (神籤草子)</td>
                                <td>なし</td>
                                <td>由緒書き等</td>
                                <td>大量 (SEO用)</td>
                                <td>日替わり</td>
                            </tr>

                            <!-- 5. 技術仕様 -->
                            <tr><td rowspan="5" class="font-bold bg-gray-50 dark:bg-zinc-800">技術・<br>セキュリティ</td>
                                <td class="font-bold">サーバー基盤</td>
                                <td class="highlight">Cloudflare Edge</td>
                                <td>共用レンタル鯖</td>
                                <td>専用サーバー</td>
                                <td>クラウド(AWS等)</td>
                                <td>APIサーバー</td>
                            </tr>
                            <tr>
                                <td class="font-bold">認証方式</td>
                                <td class="highlight">OTPメール (GAS)</td>
                                <td>-</td>
                                <td>-</td>
                                <td>Social Login</td>
                                <td>OS依存</td>
                            </tr>
                            <tr>
                                <td class="font-bold">DB堅牢性</td>
                                <td class="highlight">Turso (Edge SQLite)</td>
                                <td>ファイル (脆弱)</td>
                                <td>保存しない</td>
                                <td>RDB</td>
                                <td>RDB / SQLite</td>
                            </tr>
                            <tr>
                                <td class="font-bold">パスワード</td>
                                <td class="highlight">SHA-256ハッシュ</td>
                                <td>-</td>
                                <td>-</td>
                                <td>暗号化</td>
                                <td>トークン</td>
                            </tr>
                            <tr>
                                <td class="font-bold">シェア画像</td>
                                <td class="highlight">html2canvas生成</td>
                                <td>なし</td>
                                <td>なし</td>
                                <td>なし</td>
                                <td>OS共有機能</td>
                            </tr>

                            <!-- 6. 拡張性 -->
                            <tr><td rowspan="4" class="font-bold bg-gray-50 dark:bg-zinc-800">拡張性・<br>UX</td>
                                <td class="font-bold">ダークモード</td>
                                <td class="highlight font-bold">完全対応 + 強制機能</td>
                                <td>非対応</td>
                                <td>非対応</td>
                                <td>一部対応</td>
                                <td>対応</td>
                            </tr>
                            <tr>
                                <td class="font-bold">表示カスタマイズ</td>
                                <td class="highlight">Labs (迎春/文字等)</td>
                                <td>不可</td>
                                <td>不可</td>
                                <td>不可</td>
                                <td>着せ替え(有料)</td>
                            </tr>
                            <tr>
                                <td class="font-bold">読込速度</td>
                                <td class="highlight">爆速 (エッジ配信)</td>
                                <td>普通〜遅い</td>
                                <td>普通</td>
                                <td>遅い (広告重)</td>
                                <td>速い</td>
                            </tr>
                            <tr>
                                <td class="font-bold">アクセシビリティ</td>
                                <td class="highlight">文字サイズ変更可</td>
                                <td>ブラウザ依存</td>
                                <td>固定</td>
                                <td>固定</td>
                                <td>OS設定依存</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h3 class="text-xl font-bold mt-8 mb-4 border-l-4 border-red-500 pl-3">第2章 当サイトの運用ポリシーと技術的背景</h3>
                <p class="mb-4">
                    「運勢・天命乃杜」は、最新のWeb技術を用いて構築された、極めて現代的かつ実験的な占いプラットフォームです。一般的な商用サイトとは異なり、開発者（nden148）が個人で設計・実装・運営を行っております。
                </p>
                
                <h4 class="font-bold mt-4 border-b border-gray-300 dark:border-gray-600 pb-1">1. 更新頻度と今後の開発方針について</h4>
                <p class="mb-4">
                    当サイトは2026年1月25日の大規模アップデートをもって、おみくじ、統計、アカウント、Labs、御守といった主要機能の基盤構築が一通り完了いたしました。現在はシステムとして安定したフェーズに移行しておりますが、これは「開発終了」を意味するものではありません。現時点で予定されている大規模な更新はございませんが、今後も新たな着想や技術的進歩があった場合には、不定期に新機能の追加や改良を行っていく方針です。基本的には安定稼働を最優先としつつ、杜は静かに進化を続けてまいります。
                </p>
                
                <h4 class="font-bold mt-4 border-b border-gray-300 dark:border-gray-600 pb-1">2. エッジデータベース「Turso」による高速応答</h4>
                <p class="mb-4">
                    当サイトは、幾多の変遷を経て、最終的に<strong>エッジ特化型データベース「Turso（SQLite互換）」</strong>を採用いたしました。
                    Tursoは、HTTPプロトコル（Pipeline）を通じて世界中のどこからでも低遅延でアクセスできる特性を持っており、Cloudflare Workersで構築された当サイトのサーバーレスアーキテクチャと最も親和性が高いシステムです。
                    これにより、物理的な距離や接続数の制限による遅延を極限まで排除し、おみくじを引いた瞬間に結果が返ってくる「神速」のレスポンスを実現しています。
                </p>

                <h4 class="font-bold mt-4 border-b border-gray-300 dark:border-gray-600 pb-1">3. 真正性への取り組みと日付更新</h4>
                <p class="mb-4">
                    占いの結果生成において、当サイトは「真正性」を重視しています。12星座×血液型占いおよび全国運気ランキングにおいては、その日の日付（日本時間 JST 0:00基準）をシード値（種）とした決定論的乱数生成アルゴリズム（Seeded Random）を採用しており、リロードを繰り返して良い結果が出るまでやり直す「リセマラ」を防止しています。これは、占いを単なるゲームではなく、その日の運命（天命）として受け入れていただくための仕様です。
                </p>

                <h3 class="text-xl font-bold mt-8 mb-4 border-l-4 border-red-500 pl-3">第3章 利用規約</h3>
                <p class="mb-2">本サービスを利用される全ての参拝者（ユーザー）は、以下の規約に同意したものとみなされます。</p>
                
                <h4 class="font-bold mt-4">第1条（サービスの性質）</h4>
                <p class="mb-2 text-sm">
                    本サービスは娯楽目的で提供されるものであり、その結果の正確性や効果を保証するものではありません。結果に基づく行動はユーザーの自己責任となります。特に「全国・土地の運気ランキング」は、独自のアルゴリズムに基づくエンターテインメントコンテンツであり、実際の気象情報や地質学的データとは無関係です。
                </p>

                <h4 class="font-bold mt-4">第2条（アカウント管理）</h4>
                <p class="mb-2 text-sm">
                    1. アカウントのパスワードはSHA-256でハッシュ化され、運営者も閲覧不可能な状態で保存されます。パスワードの紛失時はアカウントの復旧ができません。<br>
                    2. 認証メールの送信にはGoogle Apps Scriptを使用しています。認証コードの有効期限は5分間です。
                </p>

                <h4 class="font-bold mt-4">第3条（禁止事項）</h4>
                <p class="mb-2 text-sm">
                    1. 自動化ツール（Bot、スクレイピングツール等）を用いて、おみくじを大量に引く行為、またはサーバーに過度な負荷をかける行為。これに対し、システム側で1分間あたりの通信回数制限（レートリミット）を設けています。<br>
                    2. APIの脆弱性を意図的に突く行為、またはリバースエンジニアリング。<br>
                    3. 生成されたおみくじ結果画像を改竄し、事実と異なる内容（当サイトが意図しない不適切な文言等）をSNS等で流布する行為。<br>
                    4. 他者のメールアドレスを不正に使用してアカウント登録を行う行為。
                </p>

                <h3 class="text-xl font-bold mt-8 mb-4 border-l-4 border-red-500 pl-3">第4章 著作権と二次利用</h3>
                <p class="mb-4">
                    1. 本サイトを構成するプログラムコード、デザイン、文章、ロゴ、および「TENMEI Labs」等の独自機能に関する知的財産権は、運営者（nden148）に帰属します。<br>
                    2. ただし、本サイトの機能を用いて生成された<strong>「おみくじ結果画像」および「デジタル御守画像」</strong>については、ユーザー個人のSNS（X, Instagram, LINE等）での共有を目的とする限りにおいて、ユーザーはこれを自由に利用（複製、公衆送信）することができます。この際、画像に含まれるQRコードやサイトURLを削除しないことを推奨します。
                </p>

                <h3 class="text-xl font-bold mt-8 mb-4 border-l-4 border-red-500 pl-3">第5章 免責事項およびサポートの非提供</h3>
                <!-- 変更後 -->
                <p class="mb-4 text-[var(--accent-red)] font-bold border border-red-500 p-3 rounded bg-red-50 dark:bg-red-900/20">
                    【重要】お問い合わせについて
                </p>
                <p class="mb-4">
                    1. 当運営は、本サービスの提供の中断、停止、終了、利用不能、またはデータの消失（ユーザーによる退会処理や、不可抗力によるサーバー障害を含む）によってユーザーに生じた損害について、一切の責任を負いません。<br>
                    2. 「おみくじの轍（履歴）」機能は、ユーザーの利便性のために提供されるものですが、永続的なデータ保存を法的に保証するものではありません。重要な結果については、画像保存機能を用いてユーザー自身の端末に物理的に保存することを強く推奨します。<br>
                    3. 本サービスからリンクされている外部サイト（SNSシェア先等）の内容やプライバシー保護については、当運営は責任を負いません。<br>
                    4. <strong>本サービスは個人開発による実験的プロジェクトであり、専任のサポート窓口やお問い合わせフォームは一切設置しておりません。また、運営者のSNSアカウント等を通じた個別の連絡、不具合報告、機能要望への対応も、アカウント凍結等の事情により一切行うことができません。</strong><br>
                    5. 万が一、本サービスの利用により何らかの問題が生じた場合、または個人情報の取扱いに関して懸念が生じた場合は、直ちに本サービスの利用を中止し、「アカウント削除」機能を用いてご自身のデータを完全に消去する措置をとってください。これ以外の個別対応は致しかねますことを、あらかじめご了承ください。
                </p>
            </div>
        </section>

        <!-- ビュー: プライバシーポリシー (目次・PDF対応版) -->
        <section id="view-privacy" class="view-section max-w-4xl mx-auto">
            <!-- PDF化する対象エリア（カード全体） -->
            <div id="privacy-content-area" class="themed-card p-10 rounded shadow-lg text-justify leading-loose bg-white dark:bg-zinc-800">
                <h2 class="text-3xl font-bold mb-8 text-center border-b border-gray-300 dark:border-gray-600 pb-4">プライバシーポリシー</h2>
                <div class="text-right text-sm themed-text-sub mb-8">
                    制定日: 2026年1月2日<br>
                    改定日: 2026年1月25日 (第6版)<br>
                    運営者: nden148
                </div>

                <div id="privacy-toc-container" class="mb-8 p-6 bg-gray-50 dark:bg-black/20 rounded-xl border border-gray-200 dark:border-gray-700 hidden" data-html2canvas-ignore="true">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-300 dark:border-gray-600 pb-2">
                        <h3 class="font-bold text-lg m-0 p-0 border-none"><i class="bi bi-list-ul mr-2"></i>目次</h3>
                    </div>
                    <ul class="text-sm space-y-2 list-none m-0 p-0 text-gray-700 dark:text-gray-300" id="privacy-toc-list"></ul>
                </div>

                <p class="mb-6">
                    運勢・天命乃杜（以下、「当サイト」といいます。）は、当サイトが提供するウェブサービス「運勢・天命乃杜」（以下、「本サービス」といいます。）における、ユーザーの個人情報の取扱いについて、以下のとおりプライバシーポリシー（以下、「本ポリシー」といいます。）を定めます。当サイトは、個人情報の保護に関する法律（平成15年法律第57号。以下「個人情報保護法」といいます。）その他関係法令を遵守するとともに、本ポリシーに基づき、ユーザーの個人情報を適正に取り扱い、その保護に努めます。
                </p>

                <h4 class="font-bold mt-6 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第1条（定義）</h4>
                <p class="mb-4 text-sm">
                    本ポリシーにおいて使用する用語の定義は、以下のとおりとします。
                    <br>1. <strong>「個人情報」</strong>とは、個人情報保護法第2条第1項にいう「個人情報」を指すものとし、生存する個人に関する情報であって、当該情報に含まれる氏名、生年月日、住所、電話番号、連絡先、その他の記述等により特定の個人を識別できる情報（他の情報と容易に照合することができ、それにより特定の個人を識別することができることとなるものを含みます。）を指します。
                    <br>2. <strong>「履歴情報および特性情報」</strong>とは、上記に定める「個人情報」以外のものをいい、ご利用いただいたサービスや、ご覧になったページ、ユーザーが検索された検索キーワード、ご利用日時、ご利用の方法、ご利用環境、郵便番号や性別、職業、年齢、ユーザーのIPアドレス、Cookie情報、位置情報、端末の個体識別情報などを指します。
                </p>

                <h4 class="font-bold mt-6 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第2条（収集する個人情報および収集方法）</h4>
                <p class="mb-4 text-sm">
                    当サイトは、本サービスの提供にあたり、以下の情報を適法かつ公正な手段により収集します。
                </p>
                <ol class="list-decimal pl-5 mb-4 space-y-2 text-sm">
                    <li>
                        <strong>ユーザー登録時に提供いただく情報：</strong><br>
                        本サービスの会員機能（「おみくじの轍」の保存、「TENMEI Labs」の利用等）を利用するために、ユーザー登録を行っていただく際、以下の情報の提供をお願いしております。
                        <ul class="list-disc pl-4 mt-1 text-gray-600 dark:text-gray-400">
                            <li>メールアドレス（本人確認および認証コード送信のため必須）</li>
                            <li>ユーザー名（サービス内での表示用ニックネーム）</li>
                            <li>パスワード（アカウント保護のため）</li>
                        </ul>
                    </li>
                    <li>
                        <strong>サービス利用時に自動的に収集される情報：</strong><br>
                        ユーザーが本サービスを利用する際、当サイトは、インターネット技術を用いて以下の情報を自動的に収集する場合があります。
                        <ul class="list-disc pl-4 mt-1 text-gray-600 dark:text-gray-400">
                            <li>IPアドレスおよびアクセス元の国・地域情報</li>
                            <li>アクセス日時および滞在時間</li>
                            <li>利用端末の種類、OSのバージョン、ブラウザの種類（User Agent）</li>
                            <li>おみくじの抽選結果、12星座占いの設定情報（星座・血液型）、お気に入り登録状況</li>
                            <li>「全国・土地の運気ランキング」の閲覧履歴（※位置情報GPSデータは一切取得・保存いたしません）</li>
                        </ul>
                    </li>
                </ol>

                <h4 class="font-bold mt-6 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第3条（個人情報の利用目的）</h4>
                <p class="mb-4 text-sm">
                    当サイトが個人情報を収集・利用する目的は、以下のとおりです。
                </p>
                <ul class="list-disc pl-5 mb-4 space-y-1 text-sm">
                    <li>本サービスの提供・運営のため（認証システムによるログイン状態の維持、履歴データの呼び出し等）</li>
                    <li>ユーザーからのお問い合わせに対応するため（本人確認を行うことを含む）</li>
                    <li>本サービスの利用規約に違反したユーザーや、不正・不当な目的でサービスを利用しようとするユーザーを特定し、ご利用をお断りするため</li>
                    <li>ユーザーにご自身の登録情報の閲覧や変更、削除、ご利用状況の閲覧を行っていただくため</li>
                    <li>メンテナンス、重要なお知らせなど必要に応じたご連絡のため</li>
                    <li>個人を識別できない形式に加工した統計データを作成し、本サービスの改善やマーケティング資料として利用・公表するため（例：「大吉」の出現率の統計的分析など）</li>
                    <li>上記の利用目的に付随する目的</li>
                </ul>

                <h4 class="font-bold mt-6 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第4条（個人情報の安全管理措置）</h4>
                <p class="mb-4 text-sm">
                    当サイトは、取り扱う個人情報の漏洩、滅失またはき損の防止、その他の個人情報の安全管理のために、必要かつ適切な措置を講じています。
                </p>
                <p class="mb-4 text-sm">
                    <strong>1. 技術的保護措置：</strong><br>
                    当サイトは、通信経路における第三者の盗聴を防止するため、全ての通信に対してSSL/TLS（Transport Layer Security）暗号化技術を使用しています。また、ユーザーのパスワードについては、サーバー上で平文（そのままの状態）で保存することは一切なく、<strong>SHA-256アルゴリズムを用いて不可逆的なハッシュ値に変換</strong>した上でデータベースに格納しております。これにより、万が一データベースへの不正アクセスが発生した場合でも、運営者を含め第三者が元のパスワードを知ることは不可能な仕組みとなっております。
                </p>
                <p class="mb-4 text-sm">
                    <strong>2. インフラストラクチャの安全性：</strong><br>
                    本サービスのサーバーサイド処理には <strong>Cloudflare Workers</strong> を、データベースには暗号化通信をサポートする <strong>Turso (LibSQL)</strong> を採用しています。データは高度なセキュリティ対策が施された環境で分散管理され、物理的な障害や外部攻撃から保護されています。
                </p>

                <h4 class="font-bold mt-6 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第5条（外部サービスとの連携とデータ移転）</h4>
                <p class="mb-4 text-sm">
                    本サービスの一部の機能は、信頼できる第三者の外部サービスを利用して提供されています。これに伴い、必要な範囲で以下の通りデータが送信されますが、各事業者はそれぞれのプライバシーポリシーに従ってデータを管理しています。
                </p>
                <div class="mb-4 text-sm border-l-2 border-gray-300 pl-4">
                    <p class="font-bold">1. Google Apps Script (Google LLC)</p>
                    <p class="mb-1">利用目的：アカウント認証用メール（ワンタイムパスワード）の自動送信処理</p>
                    <p class="mb-1">送信される情報：メールアドレス、認証コード、ユーザー名</p>
                    <p>特記事項：当サイトのシステムは、メール送信リクエストをGoogleのサーバーに送信します。Google側でメール送信処理が完了した後、当該個人情報がGoogleスプレッドシート等のストレージに永続的に蓄積されることはありません。</p>
                </div>
                <div class="mb-4 text-sm border-l-2 border-gray-300 pl-4">
                    <p class="font-bold">2. Cloudflare (Cloudflare, Inc.)</p>
                    <p class="mb-1">利用目的：コンテンツ配信（CDN）、サーバーレスコンピューティング（Workers）</p>
                    <p>送信される情報：アクセスログ、通信リクエスト</p>
                </div>
                <div class="mb-4 text-sm border-l-2 border-gray-300 pl-4">
                    <p class="font-bold">3. Turso (ChiselStrike, Inc.)</p>
                    <p class="mb-1">利用目的：ユーザー情報、履歴データ、統計データの保管および認証管理</p>
                    <p>送信される情報：メールアドレス、パスワード（ハッシュ化済）、ユーザー名、利用履歴</p>
                    <p>特記事項：TursoはSQLite互換のエッジデータベースであり、データはLibSQL/HTTPプロトコルを通じて安全に送信・保存されます。</p>
                </div>

                <h4 class="font-bold mt-6 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第6条（個人情報の第三者提供）</h4>
                <p class="mb-4 text-sm">
                    当サイトは、次に掲げる場合を除いて、あらかじめユーザーの同意を得ることなく、第三者に個人情報を提供することはありません。ただし、個人情報保護法その他の法令で認められる場合を除きます。
                </p>
                <ul class="list-disc pl-5 mb-4 space-y-1 text-sm">
                    <li>法令に基づく場合</li>
                    <li>人の生命、身体または財産の保護のために必要がある場合であって、本人の同意を得ることが困難であるとき</li>
                    <li>公衆衛生の向上または児童の健全な育成の推進のために特に必要がある場合であって、本人の同意を得ることが困難であるとき</li>
                    <li>国の機関もしくは地方公共団体またはその委託を受けた者が法令の定める事務を遂行することに対して協力する必要がある場合であって、本人の同意を得ることにより当該事務の遂行に支障を及ぼすおそれがあるとき</li>
                    <li>予め次の事項を告知あるいは公表し、かつ当サイトが個人情報保護委員会に届出をしたとき
                        <ul class="list-disc pl-4 mt-1 text-xs">
                            <li>利用目的に第三者への提供を含むこと</li>
                            <li>第三者に提供されるデータの項目</li>
                            <li>第三者への提供の手段または方法</li>
                            <li>本人の求めに応じて個人情報の第三者への提供を停止すること</li>
                            <li>本人の求めを受け付ける方法</li>
                        </ul>
                    </li>
                </ul>

                <h4 class="font-bold mt-6 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第7条（クッキー(Cookie)およびローカルストレージ）</h4>
                <p class="mb-4 text-sm">
                    1. 当サイトでは、ユーザーの利便性向上、ログイン状態の保持、および利用状況の分析のために、クッキー（Cookie）またはブラウザのローカルストレージ（LocalStorage）機能を使用しています。これにより、ユーザーのブラウザ内に設定情報（ダークモード設定、お気に入り星座等）やセッション情報を一時的に保存します。<br>
                    2. ユーザーは、ブラウザの設定を変更することにより、Cookie等の受け入れを拒否することができます。ただし、その場合、ログイン機能や履歴保存機能など、本サービスの一部機能が正常に動作しなくなる可能性がありますので、あらかじめご了承ください。
                </p>

                <h4 class="font-bold mt-6 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第8条（個人情報の開示・訂正・削除）</h4>
                <p class="mb-4 text-sm">
                    1. ユーザーは、当サイトの「アカウント設定」画面を通じて、いつでもご自身の登録情報（ユーザー名）を閲覧および修正することができます。<br>
                    2. ユーザーは、当サイトに対し、ご自身の個人情報の削除（退会）を求めることができます。当サイトは、ユーザー本人からの請求であることを確認の上（ログイン状態での操作をもって本人確認とします）、データベースから当該ユーザーに関連する全ての個人情報（メールアドレス、パスワードハッシュ、利用履歴、お気に入り情報）を遅滞なく、かつ復元不可能な方法で削除いたします。<br>
                    3. 前項の規定にかかわらず、履歴情報および特性情報などの個人情報以外の情報については、原則として開示いたしません。
                </p>

                <h4 class="font-bold mt-6 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第9条（プライバシーポリシーの変更）</h4>
                <p class="mb-4 text-sm">
                    1. 本ポリシーの内容は、法令その他本ポリシーに別段の定めのある事項を除いて、ユーザーに通知することなく変更することができるものとします。<br>
                    2. 当サイトが別途定める場合を除いて、変更後のプライバシーポリシーは、本ウェブサイトに掲載したときから効力を生じるものとします。ユーザーは、本サービスを利用するたびに最新のプライバシーポリシーを確認するものとします。
                </p>

                <h4 class="font-bold mt-6 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第10条（免責事項）</h4>
                <p class="mb-4 text-sm">
                    当サイトからリンクやバナーなどによって他のサイトに移動された場合、移動先サイトで提供される情報、サービス等について一切の責任を負いません。また、移動先サイトにおける個人情報の取扱いについては、当該サイトのプライバシーポリシーをご確認ください。
                </p>

                <h4 class="font-bold mt-6 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第11条（お問い合わせ窓口の不存在と対処方法）</h4>
                <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded border border-red-300 dark:border-red-800 text-sm">
                    <p class="mb-2 font-bold text-red-700 dark:text-red-300">【重要：連絡先について】</p>
                    <p class="mb-4">
                        本サービスは個人開発による非営利・実験的なプロジェクトとして運営されております。現在、<strong>お問い合わせフォーム、サポート用メールアドレス、SNSアカウント等の連絡窓口は一切設置しておりません。</strong>そのため、個別の開示請求、苦情のお申し出、機能改善のご要望等をいただきましても、対応やご返信を行うことができません。
                    </p>
                    <p class="mb-2 font-bold">【対処方法】</p>
                    <p>
                        本サービスにおける個人情報の取扱い等に懸念が生じた場合、またはサービスの利用継続が困難であると判断された場合は、以下の手順によりご自身で対応をお願いいたします。
                    </p>
                    <ol class="list-decimal pl-5 mt-2 space-y-1">
                        <li>本サービスの利用を直ちに中止してください。</li>
                        <li>ログイン後の「アカウント設定」画面にある<strong>「アカウント削除」ボタン</strong>を押下してください。これにより、メールアドレスを含む全ての個人データがサーバーから物理的に削除されます。</li>
                    </ol>
                    <p class="mt-4 text-xs text-gray-500 dark:text-gray-400">
                        ※アカウント削除後のデータ復旧は一切できません。あらかじめご了承ください。
                    </p>
                </div>
            </div>
        </section>
    </main>

    <!-- カウントダウンオーバーレイ -->
    <div id="countdown-overlay">
        <div id="countdown-number">3</div>
    </div>

    <!-- 詳細モーダル (おみくじの轍用) -->
    <div id="history-detail-modal" onclick="closeHistoryDetail(event)">
        <div id="history-detail-content" onclick="event.stopPropagation()">
            <!-- ここに結果カードを複製表示 -->
        </div>
        <button onclick="closeHistoryDetail(null)" class="fixed top-5 right-5 text-white text-4xl hover:text-gray-300 z-[2100]">
            <i class="bi bi-x-circle"></i>
        </button>
    </div>

    <!-- プロフィール編集モーダル (修正版) -->
    <div id="edit-profile-modal" onclick="if(event.target === this) this.style.display='none'">
        <div class="bg-white dark:bg-zinc-900 p-6 rounded-xl w-full max-w-md mx-4 shadow-2xl border border-gray-200 dark:border-gray-700 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">プロフィール編集</h3>
                <button onclick="resetProfileEdit()" class="text-xs text-red-500 hover:underline">リセット</button>
            </div>
            
            <label class="block text-sm font-bold mb-2">アイコン</label>
            <div class="icon-select-grid" id="icon-selector">
                <!-- JSで生成 -->
            </div>

            <label class="block text-sm font-bold mb-2">アイコンの色</label>
            <div class="color-select-grid" id="color-selector">
                <!-- JSで生成 -->
            </div>

            <label class="block text-sm font-bold mb-1">称号 (Title)</label>
            <input type="text" id="edit-title" class="w-full p-2 border rounded mb-4 themed-input" placeholder="例: おみくじ愛好家">
            
            <label class="block text-sm font-bold mb-1">自己紹介 (Bio)</label>
            <textarea id="edit-bio" class="w-full p-2 border rounded mb-6 h-32 themed-input" placeholder="自己紹介を入力..."></textarea>
            
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('edit-profile-modal').style.display='none'" class="px-4 py-2 rounded border hover:bg-gray-100 dark:hover:bg-zinc-800">キャンセル</button>
                <button onclick="saveProfileChanges()" class="btn-primary px-4 py-2">保存する</button>
            </div>
        </div>
    </div>

    
<!-- フォロー/フォロワーリストモーダル -->
    <div id="follow-list-modal" onclick="if(event.target === this) this.style.display='none'" 
         style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; align-items: center; justify-content: center;">
        <div class="themed-card p-6 rounded-xl w-full max-w-md mx-4 shadow-2xl overflow-hidden flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b border-gray-200 dark:border-gray-700 pb-2">
                <h3 class="text-xl font-bold" id="follow-list-title">リスト</h3>
                <button onclick="document.getElementById('follow-list-modal').style.display='none'" class="text-gray-500 hover:text-red-500">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            
            <div id="follow-list-content" class="overflow-y-auto flex-1 space-y-2 mb-4">
                <!-- ここにユーザーリストが入る -->
            </div>

            <!-- ページネーション -->
            <div id="follow-list-pagination" class="pt-2 border-t border-gray-200 dark:border-gray-700"></div>
        </div>
    </div>

    <!-- 認証済みユーザー詳細モーダル -->
    <div id="verified-modal" onclick="if(event.target === this) this.style.display='none'" 
         style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 4000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        
        <div class="bg-white dark:bg-zinc-900 p-8 rounded-2xl w-full max-w-sm mx-4 shadow-2xl border-2 border-gray-100 dark:border-gray-700 text-center relative" onclick="event.stopPropagation()">
            
            <button onclick="document.getElementById('verified-modal').style.display='none'" class="absolute top-4 right-4 text-gray-400 hover:text-red-500">
                <i class="bi bi-x-lg"></i>
            </button>

            <!-- アイコン表示エリア -->
            <div id="verified-icon-area" class="text-6xl mb-4"></div>
            
            <h3 class="text-2xl font-black mb-2" id="verified-title"></h3>
            
            <div class="w-full h-px bg-gray-200 dark:bg-gray-700 my-4"></div>
            
            <p class="text-sm leading-relaxed text-gray-600 dark:text-gray-300 font-medium" id="verified-desc"></p>
            
            <div class="mt-6">
                <span class="text-xs text-gray-400">運勢・天命乃杜 運営事務局</span>
            </div>
        </div>
    </div>

    <!-- 認証申請モーダル -->
    <div id="verification-apply-modal" onclick="if(event.target === this) this.style.display='none'" 
         style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 5000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div class="bg-white dark:bg-zinc-900 p-6 rounded-2xl w-full max-w-md mx-4 shadow-2xl border border-gray-200 dark:border-gray-700 relative" onclick="event.stopPropagation()">
            <button onclick="document.getElementById('verification-apply-modal').style.display='none'" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="bi bi-x-lg"></i></button>
            
            <h3 class="text-xl font-black mb-4 flex items-center gap-2">
                <i class="bi bi-patch-check-fill text-blue-500"></i> 認証バッジの申請
            </h3>
            
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-4 leading-relaxed">
                天命乃杜の公式認証バッジ（ブルー）を申請します。<br>
                申請は運営事務局（黄金認証ユーザー）により厳正に審査されます。
            </p>

            <label class="block text-sm font-bold mb-2">申請の理由 / 自己アピール</label>
            <textarea id="verify-reason" class="w-full p-3 border rounded-lg mb-4 h-32 themed-input text-sm" placeholder="例：毎日欠かさず参拝しており、SNSでも積極的に広めています。公式ユーザーとして認められたいです。"></textarea>
            
            <button onclick="submitVerification()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow transition">
                審査に申し込む
            </button>
        </div>
    </div>

    <!-- 管理者用審査モーダル -->
    <div id="admin-verify-modal" onclick="if(event.target === this) this.style.display='none'" 
         style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 6000; display: none; align-items: center; justify-content: center;">
        <div class="bg-white dark:bg-zinc-900 p-6 rounded-2xl w-full max-w-lg mx-4 shadow-2xl border-2 border-yellow-500 max-h-[80vh] flex flex-col" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b border-gray-200 dark:border-gray-700 pb-2">
                <h3 class="text-xl font-black text-yellow-600"><i class="bi bi-shield-lock-fill"></i> 認証審査（管理者用）</h3>
                <button onclick="document.getElementById('admin-verify-modal').style.display='none'" class="text-gray-500"><i class="bi bi-x-lg"></i></button>
            </div>
            <div id="admin-verify-list" class="overflow-y-auto flex-1 space-y-3">
                <!-- ここに申請リストが表示される -->
            </div>
        </div>
    </div>


    <!-- JavaScript ロジック -->
    <script>
        // ==========================================
        //  設定: Cloudflare WorkerのURL
        // ==========================================
        const API_BASE = "https://aaaaa.nden14800.workers.dev";
        const SITE_URL = "https://fortune-telling-at-tenmei-no-mori-authentic-today-s-fortun.pages.dev";

        // --- XSS対策用エスケープ関数 ---
function escapeHtml(str) {
    if (!str) return '';
    return str.toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

        // ==========================================
    //  通知システム (Windows 11 Fluent Design版)
    // ==========================================
    
    window.showToast = function(message, type = 'info', title = '') {
        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            document.body.appendChild(container);
        }

        // タイトルの自動設定
        if (!title) {
            if (type === 'success') title = '完了';
            else if (type === 'warning') title = '注意';
            else if (type === 'error') title = '問題が発生しました';
            else title = 'お知らせ';
        }

        // アイコン設定
        let iconClass = 'bi-info-circle';
        if (type === 'success') iconClass = 'bi-check-circle-fill';
        if (type === 'warning') iconClass = 'bi-exclamation-triangle-fill';
        if (type === 'error') iconClass = 'bi-x-circle-fill';

        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        
        // HTML構造
        toast.innerHTML = `
            <div class="toast-icon-area"><i class="bi ${iconClass}"></i></div>
            <div class="toast-content">
                <div class="toast-title">${title}</div>
                <div class="toast-msg">${message.replace(/\n/g, '<br>')}</div>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()"><i class="bi bi-x"></i></button>
            <div class="toast-progress"></div>
        `;

        container.appendChild(toast);

        // プログレスバーのアニメーション
        const progressBar = toast.querySelector('.toast-progress');
        const duration = 5000; // 5秒
        
        progressBar.animate([
            { transform: 'scaleX(1)' },
            { transform: 'scaleX(0)' }
        ], {
            duration: duration,
            easing: 'linear',
            fill: 'forwards'
        });

        // 表示アニメーション（少し遅らせて発火）
        requestAnimationFrame(() => {
            toast.classList.add('toast-visible');
        });

        // 自動消去
        setTimeout(() => {
            toast.classList.remove('toast-visible');
            toast.addEventListener('transitionend', () => {
                if(toast.parentElement) toast.remove();
            });
        }, duration);
    };

    // 既存のalertを上書き
    window.alert = function(msg) {
        showToast(msg, 'info');
    };

       // ==========================================
    //  設定: サーバーメンテナンスモード
    // ==========================================
    const maintenanceConfig = {
        enabled: true, // true で有効化 false で無効化

        // 期間設定 (YYYY-MM-DDTHH:MM:SS)
        startTime: "2026-01-15T18:40:00", 
        endTime:   "2026-01-15T19:00:00", // 現在テスト中のため長めに設定

        title: "只今、メンテナンス中です"
    };

    // メンテナンスチェック関数 (強制表示対応版)
    // force = true を渡すと、時間や設定に関係なく画面を表示します
    function checkMaintenance(force = false) {
        // 通常チェック時のみ enabled を確認
        if (!force && !maintenanceConfig.enabled) return;

        const now = new Date();
        const start = new Date(maintenanceConfig.startTime);
        const end = new Date(maintenanceConfig.endTime);

        if (isNaN(start.getTime()) || isNaN(end.getTime())) {
            console.error("メンテナンス日時の形式エラー");
            return;
        }

        // 期間内、または強制フラグが立っている場合に実行
        if (force || (now >= start && now < end)) {
            
            // --- 日付表示ロジック ---
            const formatTime = (d) => `${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
            const formatDate = (d) => `${d.getFullYear()}年 ${d.getMonth()+1}月${d.getDate()}日`;
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            
            // 実際に表示に使う日付（強制モードならconfigの値をそのまま使う）
            const dStart = start;
            const dEnd = end;

            const isSameDay = (dStart.getFullYear() === dEnd.getFullYear()) &&
                              (dStart.getMonth() === dEnd.getMonth()) &&
                              (dStart.getDate() === dEnd.getDate());

            let dateDisplayStr = "";
            const startDay = days[dStart.getDay()];
            
            if (isSameDay) {
                dateDisplayStr = `${formatDate(dStart)}（${startDay}） ${formatTime(dStart)} ～ ${formatTime(dEnd)}`;
            } else {
                const endDay = days[dEnd.getDay()];
                dateDisplayStr = `${formatDate(dStart)}（${startDay}） ${formatTime(dStart)} ～ ${formatDate(dEnd)}（${endDay}） ${formatTime(dEnd)}`;
            }
            
            // --- 画面描画 ---
            document.body.innerHTML = `
                <div style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: #1a1a1a; color: #f0f0f0;
                    display: flex; flex-direction: column; 
                    z-index: 2147483647; font-family: 'Zen Old Mincho', serif;
                    overflow-y: auto;
                    padding: 20px; box-sizing: border-box;
                ">
                    <div style="
                        max-width: 600px; width: 100%; margin: auto;
                        display: flex; flex-direction: column; align-items: center;
                        text-align: center; padding-top: 40px; padding-bottom: 40px;
                    ">
                        <div style="font-size: 3rem; margin-bottom: 20px; color: #d4af37;">
                            <i class="bi bi-cone-striped"></i>
                        </div>
                        
                        <h1 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 30px; letter-spacing: 0.1em;">
                            ${maintenanceConfig.title}
                        </h1>
                        
                        <div style="text-align: left; width: 100%; font-size: 0.95rem; line-height: 1.8;">
                            <p style="margin-bottom: 20px;">下記の日程にて、メンテナンスを実施しております。</p>
                            
                            <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <div style="font-weight: bold; margin-bottom: 5px;">
                                    【日時】${dateDisplayStr}
                                </div>
                                <div style="font-size: 0.85rem; color: #ffadad;">
                                    ※メンテナンス時間は、延長される可能性がございます
                                </div>
                            </div>

                            <p style="margin-bottom: 10px;">
                                メンテナンス中は、運勢・天命乃杜をご利用いただけません。<br>
                                ご不便をおかけいたしますが、ご理解のほどよろしくお願いいたします。
                            </p>
                            
                            ${force ? '<p style="color:#d4af37; font-size:0.8rem; text-align:center; margin-top:20px;">※これはテスト表示です</p>' : ''}
                        </div>

                        <button onclick="location.reload()" style="
                            margin-top: 40px; padding: 10px 40px; 
                            background: #b91c1c; color: white; border: none; border-radius: 4px; 
                            cursor: pointer; font-weight: bold; font-size: 0.9rem;
                            transition: opacity 0.2s;
                        " onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                            <i class="bi bi-arrow-clockwise"></i> 再読み込み
                        </button>
                    </div>
                </div>
            `;
            
            // 強制モードのときはエラーを投げずにスクロールだけ止める（コンソールエラー回避）
            document.body.style.overflow = 'hidden';
            if(!force) {
                throw new Error("Maintenance Mode Active");
            }
        }
    }

    // 読み込み直後にチェック実行
    checkMaintenance();

        // ==========================================
    //  データ管理: 社務所だより & 神籤草子 (強制上書き版)
    // ==========================================
    
// ■ 社務所だより（ニュース）データ
    const newsData = [


        {
            id: 49,
            title: "【意匠変更】「宵闇（ダークモード）」における「紅」の統一について",
            date: "2026/1/26",
            time: "18:16",
            tag: "デザイン統一",
            tagColor: "text-red-700",
            borderColor: "border-red-600",
            desc: "サイト全体の配色を見直し、ダークモード時においても文字色を伝統的な「深紅」へ統一いたしました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日、サイトの表示設定「宵闇の刻（ダークモード）」における配色の調整を行いました。</p>

                    <h3>「紅（くれない）」の統一</h3>
                    <p>これまで、背景が暗くなるダークモードにおいては、文字の読みやすさを優先して「明るい朱色（ピンクに近い赤）」をアクセントカラーとして使用しておりました。</p>
                    <p>しかし、「魔を祓う色」としての紅の重みを損なわないよう、この度、<strong>背景の明暗に関わらず、すべてのモードでライトモードと同じ「深紅（#b91c1c）」を使用する</strong>仕様へと変更・統一いたしました。</p>

                    <h3>意匠へのこだわり</h3>
                    <p>これにより、暗い背景の中に深く沈み込むような、より重厚で厳かな赤色が浮かび上がるようになりました。以前よりも少し文字が暗く感じるかもしれませんが、これこそが当杜が本来表現したかった「伝統的な赤」の色味となります。</p>
                    <p>静寂な宵闇の中で、鈍く光る紅の美しさをお楽しみください。</p>
                </div>
            `
        },
        {
            id: 48,
            title: "【改善とご報告】「二次元コード（QR）」の鮮明化と、画像保存機能の現状について",
            date: "2026/1/26",
            time: "18:09",
            tag: "システム報告",
            tagColor: "text-gray-600",
            borderColor: "border-gray-500",
            desc: "結果画像のQRコード画質を向上させました。また、画像生成時のレイアウト微調整につきましては、技術的課題により現状維持とさせていただきます。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。運営者のnden148です。</p>
                    <p>本日、おみくじ結果画面（御神籤）における表示調整を行いました。</p>

                    <h3>1. QRコードの画質向上</h3>
                    <p>これまで、結果画面右下に表示される「二次元コード（QR）」が、画像を保存した際に滲んでしまったり、ぼやけて読み取りにくくなる場合がございました。</p>
                    <p>これに対し、生成サイズを従来の2倍以上に高め、高精細な状態で描画するよう修正を行いました。今後は、保存された画像でもくっきりと美しく表示されます。</p>

                    <h3>2. 画像保存時のレイアウトについて（お詫び）</h3>
                    <p>一方で、一部の端末において「画像を保存」した際に、画面の見た目と保存された画像でレイアウト（余白や文字の配置）が若干異なったり、崩れてしまったりする現象が確認されております。</p>
                    <p>これにつきまして、本日修正を試みましたが、Webブラウザの仕様（html2canvasの描画特性）と、多種多様なスマートフォンの画面サイズすべてに完璧に対応させることが技術的に極めて困難であるとの結論に至りました。</p>
                    <p>無理な矯正を行うことで、かえって画像が生成されなくなるリスクを避けるため、<strong>誠に遺憾ながら、画像生成機能につきましては「現状の仕様（多少のズレは許容する）」のまま運用を継続</strong>させていただきます。</p>
                    
                    <p>完全な形でお届けできず申し訳ございませんが、何卒ご容赦いただけますようお願い申し上げます。</p>
                </div>
            `
        },
        {
            id: 47,
            title: "【撤去】セキュリティ認証（Turnstile）の廃止と、参拝手順の簡略化について",
            date: "2026/1/25",
            time: "20:50",
            tag: "機能撤去",
            tagColor: "text-gray-600",
            borderColor: "border-gray-500",
            desc: "認証コード送信時に試験導入したセキュリティチェック機能を、不具合および利便性向上のため完全に撤去いたしました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日夜間、アカウント認証の安全性を高める試みとして導入いたしましたCloudflare Turnstile（「私はロボットではありません」等の確認機能）につきまして、一部の環境で通信エラーが発生し、手続きが完了できない事象が確認されました。</p>

                    <h3>撤去の経緯と判断</h3>
                    <p>より強固な守りを目指して設置した門番でしたが、内部処理の競合により、参拝者の皆様の行く手を阻む結果となってしまいました。</p>
                    <p>当杜の最も大切にすべき価値は<strong>「静寂な心で、スムーズに天命を受け取ること」</strong>にあります。複雑な認証機構によってその体験を損なうことは本末転倒であると判断し、該当機能をすべて廃止・撤去いたしました。</p>

                    <h3>今後のセキュリティについて</h3>
                    <p>現在は以前と同様、メールアドレスとパスワードの入力のみで認証が行える状態に復旧しております。目に見えるチェック機構はなくなりましたが、既存の「結界（レートリミット）」による防御にて、不正な自動アクセスは引き続き厳格に遮断してまいります。</p>

                    <p>一時的にご不便をおかけしましたことをお詫び申し上げます。今後とも、安全でありながら最も障壁の少ない参拝環境の維持に努めてまいります。</p>
                </div>
            `
        },
        {
            id: 46,
            title: "【修繕】「アカウント削除」機能における不具合修正のご報告",
            date: "2026/1/25",
            time: "18:00",
            tag: "不具合修正",
            tagColor: "text-green-600",
            borderColor: "border-green-600",
            desc: "特定条件下において、アカウント削除処理が正常に完了せずエラーとなる問題を解消いたしました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日、「アカウント設定」画面より退会（アカウント削除）を行おうとした際、処理中にエラーが発生し、削除が完了しない不具合が確認されました。</p>

                    <h3>原因と対応</h3>
                    <p>以前廃止した機能（実績バッジ）に関するデータ処理の記述がシステム内部に残存しており、存在しないデータを削除しようとしてエラーを引き起こしておりました。</p>
                    <p>現在は該当箇所の修正が完了しており、正常にアカウントおよび関連データの削除が行えることを確認しております。</p>

                    <p>「去る者は追わず、来る者は拒まず」。<br>
                    当杜は、皆様がいつでも自由に参拝を始められ、そして理由を問わず綺麗に立ち去れる場所でありたいと願っております。ご不便をおかけしましたことをお詫び申し上げます。</p>
                </div>
            `
        },
        {
            id: 45,
            title: "【修復】おみくじ処における「結界（連打制限）」の再設定について",
            date: "2026/1/25",
            time: "17:41",
            tag: "結界修復",
            tagColor: "text-red-700",
            borderColor: "border-red-600",
            desc: "おみくじを引く際の回数制限が一時的に機能していない状態でした。現在は正常に「1分間に60回」の制限が動作しております。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日実施いたしましたシステム更新の影響により、おみくじ授与所における<strong>「レート制限（連打防止の結界）」</strong>の設定が、一時的に無効化されている状態が確認されました。</p>

                    <h3>発生していた状況</h3>
                    <p>本来であれば、1分間に60回を超えておみくじを引こうとすると「天命の戒め（制限通知）」が表示され、一時的に操作がブロックされる仕様となっております。</p>
                    <p>しかし、更新時の記述漏れにより、この制限が機能せず、無制限に何度でも引ける状態となっておりました。</p>

                    <h3>対応状況</h3>
                    <p>現在は結界を張り直し、正常に<strong>「1分間に60回まで」</strong>の制限が動作することを確認しております。</p>
                    <p>この間に引かれたおみくじの結果や履歴はそのまま有効ですが、サーバー負荷分散のため、引き続き節度ある参拝にご協力いただけますと幸いです。</p>
                </div>
            `
        },
        {
            id: 44,
            title: "【復旧】TENMEI Labsの「入室結界（ロック画面）」が霧に包まれていた不具合の修正",
            date: "2026/1/25",
            time: "17:15",
            tag: "不具合修正",
            tagColor: "text-green-600",
            borderColor: "border-green-600",
            desc: "未ログイン時に表示されるLabsのロック画面が、過度なぼかし処理により視認できなくなっていた問題を解消いたしました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日午後、会員限定エリア「TENMEI Labs」の入り口において、特定の条件下で<strong>「ロック画面（入室結界）自体にぼかしフィルターがかかり、文字やボタンが判読困難になる」</strong>という表示不具合が発生しておりました。</p>

                    <h3 class="text-red-600">発生日時</h3>
                    <p class="font-bold">2026年1月25日 13:11頃 〜 17:15頃</p>

                    <h3>不具合の原因と修正</h3>
                    <p>Labs内のコンテンツを隠すための「すりガラス効果（Blurフィルター）」が、本来くっきりと表示されるべきロック画面のカードにまで及んでしまっていたことが原因でした。</p>
                    <p>これに対し、ロック画面の構造（DOM）をコンテンツの階層から物理的に分離し、<strong>「いかなる結界（フィルター）の影響も受けず、常に最前面に鮮明に表示される」</strong>よう修正を行いました。</p>

                    <p>現在は霧が晴れ、正常に入室案内が表示されております。<br>ご不便をおかけしましたことをお詫び申し上げます。</p>
                </div>
            `
        },
        {
            id: 43,
            title: "【更新】TENMEI Labsに『詳細設定』機能を実装。実験機能を自分好みに微調整可能に。",
            date: "2026/1/25",
            time: "16:20",
            tag: "新機能",
            tagColor: "text-purple-600",
            borderColor: "border-purple-600",
            desc: "TENMEI Labsの各機能を大幅強化。これまでの説明表示のみの状態から、スライダーやスイッチで数値を操作できる『詳細設定パネル』へと進化しました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。運営者のnden148です。</p>
                    <p>本日、会員限定の実験場「TENMEI Labs（天命ラボ）」において、各機能のパラメータを直接操作できる<strong>『詳細設定パネル』</strong>を実装いたしました。</p>

                    <h3>今回の進化ポイント</h3>
                    <p>これまでは、Labカードをタップしても機能の説明が表示されるだけでしたが、本日の更新により、実際に以下の項目などを細かく調整できるようになりました。</p>
                    
                    <ul class="list-disc ml-5 mb-4">
                        <li><strong>幽玄の霧：</strong> 霧の透明度（濃さ）や、流れるスピードをスライダーで自由に変更可能。</li>
                        <li><strong>言霊の増幅：</strong> 文字サイズを110%〜150%の間で、自分の読みやすい大きさに微調整可能。</li>
                        <li><strong>各機能の個別制御：</strong> パネル内から直接ON/OFFを切り替えられます。</li>
                    </ul>

                    <h3>設定の保存について</h3>
                    <p>詳細設定パネルで変更した数値は、ブラウザに自動的に保存されます。一度自分好みに整えれば、次回の参拝時もその設定が維持されます。</p>
                    
                    <p>より深く、より自分らしく「杜」の環境をカスタマイズして、特別な参拝体験をお楽しみください。</p>
                </div>
            `
        },
        {
            id: 42,
            title: "【完了】境内（UI）の大規模刷新工事が完了しました。より美しく、使いやすい「現代の杜」へ。",
            date: "2026/1/25",
            time: "14:52",
            tag: "大規模更新",
            tagColor: "text-indigo-600",
            borderColor: "border-indigo-600",
            desc: "ホーム、参拝記録、アカウント、そして授与所まで、サイト全体のデザインを「Bento Grid」スタイルへ統一・刷新いたしました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。運営者のnden148です。</p>
                    <p>本日、当サイトの開設以来最大規模となる<strong>「UI（ユーザーインターフェース）の大規模刷新」</strong>を完了いたしました。</p>
                    <p>「当サイトについて・利用規約」「プライバシーポリシー」を除く、ほぼ全ての画面において、最新のデザイントレンドである<strong>「Bento Grid（弁当箱スタイル）」</strong>を採用し、情報の見やすさと操作性を飛躍的に向上させました。</p>

                    <h3>主な改装ポイント</h3>

                    <h4>1. ホーム画面・ダッシュボード化</h4>
                    <p>必要な情報が一目でわかるよう、挨拶、おみくじ、統計、最新記事などをグリッド状に配置しました。スマートフォンでもPCでも、最適なレイアウトで参拝いただけます。</p>

                    <h4>2. 参拝の記録（統計）の視覚化</h4>
                    <p>ご自身の運勢傾向を示すグラフを、従来の「重ね合わせ表示」から「独立表示（上下配置）」へと変更しました。これにより、平均値との比較がより直感的に、正確に把握できるようになりました。また、各カードに触れると反応するインタラクティブな挙動も追加しております。</p>

                    <h4>3. 参拝証（アカウント）画面の刷新</h4>
                    <p>「ログイン/登録」および「アカウント設定」画面を、従来の質素なリスト形式から、モダンなカード形式へと一新しました。現在の会員ランクやステータスが視覚的にわかりやすくなり、操作もスムーズに行えます。</p>

                    <h4>4. 授与所（おみくじ）と結果画面の進化</h4>
                    <p>おみくじを引く「授与所」では、案内板をモダンなすりガラス風のデザインに変更し、より神聖な雰囲気を演出しました。</p>
                    <p>また、結果画面における「画像の保存」や「SNSシェア」のボタンを、従来の縦並びリストから<strong>「大きなボタンのグリッド配置」</strong>に変更いたしました。これにより、感動をそのままスムーズに共有いただけるようになりました。</p>

                    <h4>5. 全体的な統一感の向上</h4>
                    <p>12星座占い、御守授与所、各種一覧画面においても、文字の可読性やボタンの配置を見直し、サイト全体を通して「和の心」と「デジタルの快適さ」が融合するよう調整いたしました。</p>

                    <p>新しく生まれ変わった「運勢・天命乃杜」で、日々の天命を心地よくお受け取りください。<br>今後とも変わらぬご愛顧のほど、よろしくお願い申し上げます。</p>
                </div>
            `
        },
        {
            id: 41,
            title: "【重要】「参拝の記録」機能刷新と、重大な不具合に伴う全データ浄化（リセット）のご報告",
            date: "2026/1/25",
            time: "09:20",
            tag: "重要・仕様変更",
            tagColor: "text-red-700",
            borderColor: "border-red-600",
            desc: "参拝者数が異常に増加する不具合を修正しました。正確な記録を期すため、誠に遺憾ながら再度全データをリセットいたしました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。運営者のnden148です。</p>
                    <p>本日早朝より発生しておりました<strong>「参拝者台帳（記録）を開くたびに、参拝者数のカウントが不正に増え続ける」</strong>という重大なシステム不具合につきまして、根本的な修正が完了いたしました。</p>
                    <p>しかしながら、この不具合によりデータベース内の数値が修復不可能なほど乖離してしまったため、断腸の思いではございますが、<strong>再度、全てのデータを「完全リセット（浄化）」</strong>させていただきました。</p>

                    <h3 class="text-red-600">【重要】全データ削除のお詫び</h3>
                    <p>度重なるリセットとなり、参拝者の皆様が積み上げてこられた記録を消去することになってしまい、誠に申し訳ございません。</p>
                    <p>「正確でない数字を表示することは、運勢サイトとしての信頼に関わる」という判断のもと、一度すべてを白紙に戻し、正しいカウントで再出発することを選択いたしました。</p>
                    <p><strong>※大変お手数をおかけいたしますが、再度「新規登録」よりアカウントの作成をお願い申し上げます。</strong></p>

                    <h3>機能刷新：「参拝の記録」と「累計参拝者数」</h3>
                    <p>今回の修正に合わせ、プロフィール画面（参拝の記録）の仕様を以下の通り刷新いたしました。</p>
                    
                    <h4>1. 「累計参拝者数」カウンターの新設</h4>
                    <p>これまで皆様にお見せしていたのは「おみくじが引かれた総本数」のみでしたが、新たに<strong>「この杜に登録された参拝者様の人数（ユニークユーザー数）」</strong>を正確に表示するカウンターを設置いたしました。</p>
                    <p>今後は、ボタンを押すだけで増えるようなことはなく、純粋に新しい仲間が増えた時のみ数字が刻まれていきます。</p>

                    <h4>2. 記録表示のグラフィカル化</h4>
                    <p>従来の「総参拝数」と「大吉数」だけのシンプルな表示から、統計グラフを用いた詳細な記録画面へと変更いたしました。</p>
                    <p>ご自身の運勢の傾向や、全体の平均値との比較が視覚的に分かりやすくなっております。</p>

                    <p>今度こそ、強固な地盤の上で、永く続く杜の歴史を刻んでまいります。<br>新しくなった天命乃杜を、どうかこれに懲りず、よろしくお願い申し上げます。</p>
                </div>
            `
        },
        {
            id: 40,
            title: "【重要】「功徳の証（実績バッジ）」機能の完全撤去に関するお詫びとご報告",
            date: "2026/1/24",
            time: "12:35",
            tag: "機能撤去",
            tagColor: "text-red-700",
            borderColor: "border-red-600",
            desc: "表示上の不整合が解消されないため、誠に遺憾ながら実績機能を廃止いたしました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日、「参拝の記録」および「参拝者台帳」にて提供しておりました<strong>「功徳の証（実績バッジ機能）」</strong>につきまして、機能を完全に撤去（廃止）いたしましたことをご報告申し上げます。</p>

                    <h3>撤去の理由</h3>
                    <p>特定条件下において「実績を達成していないにも関わらず獲得済みと表示される」、あるいは「進捗状況が正しく反映されない」という致命的な表示不具合が繰り返し発生しておりました。</p>
                    <p>神聖な参拝の記録において、事実と異なるあやふやな情報を表示し続けることは、当杜の運営理念に反すると判断いたしました。何度も修正を試みましたが、システムの根幹に関わる問題により安定した提供が困難であるという結論に至りました。</p>

                    <h3>今後の「参拝の記録」について</h3>
                    <p>今後は、不具合の懸念がないシンプルな数値データとして、以下の記録のみを厳正に管理・表示してまいります。</p>
                    <ul class="list-disc ml-5 mb-4">
                        <li><strong>総参拝数：</strong> これまでにおみくじを引いた合計回数</li>
                        <li><strong>大吉獲得数：</strong> そのうち大吉を引き当てた回数</li>
                    </ul>
                    <p>バッジの獲得を楽しみにされていた皆様には、多大なるご迷惑とご期待外れの結果となりましたことを、深くお詫び申し上げます。</p>
                </div>
            `
        },
        {
            id: 39,
            title: "【機能変更】「連続参拝（ログインボーナス）」機能の廃止と、参拝記録の表示修正について",
            date: "2026/1/24",
            time: "11:35",
            tag: "機能変更",
            tagColor: "text-gray-600",
            borderColor: "border-gray-500",
            desc: "日数のカウントが正常に動作しない不具合が確認されたため、連続参拝機能を廃止いたしました。併せて数値の表示形式を修正しました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日、以下の機能変更および修正を行いました。</p>

                    <h3>1. 「連続参拝（ログインボーナス）」機能の廃止</h3>
                    <p>これまで提供しておりました「連続参拝日数」のカウント機能につきまして、日付更新の判定ロジックに不整合があり、毎日参拝しても日数が加算されない等の不具合が多発しておりました。</p>
                    <p>不正確なデータをお見せすることは神意に反すると判断し、誠に勝手ながら<strong>本機能（日数カウントおよびスタンプ帳）を完全に廃止（撤去）</strong>させていただきました。</p>
                    <p>今後は純粋に「総参拝数」と「大吉獲得数」の積み重ねをお楽しみください。</p>

                    <h3>2. 参拝記録の表示修正</h3>
                    <p>プロフィール画面（参拝の記録）において、以下の修正を行いました。</p>
                    <ul class="list-disc ml-5">
                        <li><strong>数値のカンマ区切り：</strong> 「1000」と表示されていた箇所を「1,000」のように見やすく修正しました。</li>
                        <li><strong>大吉数の表示：</strong> 「大吉獲得数」の表示パネルを復活させました。</li>
                        <li><strong>実績バッジの表示：</strong> 未獲得のバッジが誤って「獲得済み」と表示される不具合を修正しました。</li>
                    </ul>
                    <p>度重なる変更でご迷惑をおかけしますが、何卒ご理解のほどお願い申し上げます。</p>
                </div>
            `
        },
        {
            id: 38,
            title: "【最終報告】データベースの最終着地（Turso）と、参拝記録表示の最適化について",
            date: "2026/1/23",
            time: "23:45",
            tag: "システム・仕様",
            tagColor: "text-emerald-600",
            borderColor: "border-emerald-600",
            desc: "参拝記録の表示項目を整理し、実績バッジへの一元化を行いました。また、幾多の変遷を経て辿り着いたデータベース「Turso」と他社技術の比較を公開します。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。運営者のnden148です。</p>
                    <p>本日、参拝者の皆様により正確な情報をお届けするため、プロフィール画面（参拝の記録）の表示項目を一部変更いたしました。また、ここ数日間で目まぐるしく変化した当サイトの「心臓部（データベース）」について、最終的な技術選定の理由をご報告いたします。</p>

                    <h3>1. 「大吉獲得数」表示の統合について</h3>
                    <p>これまで「参拝の記録」画面において、数値としての「大吉獲得数」と、実績バッジとしての「大吉記録」を併記しておりましたが、システム上の集計タイミングのズレにより、両者の数字が一致しない（片方が0のままになる）現象が確認されました。</p>
                    <p>調査の結果、実績バッジ（功徳の証）側のデータが最も正確に皆様の幸運を記録できていることが判明いたしました。</p>
                    <p>そのため、混乱を招く数値だけの表示枠を撤廃し、今後は<strong>「功徳の証（バッジ）」にて大吉の獲得状況をご確認いただく</strong>仕様へと統一いたしました。皆様が引き当てた幸運は、バッジの中に確実に刻まれておりますのでご安心ください。</p>

                    <h3>2. データベース放浪の旅、その終着点「Turso」</h3>
                    <p>当サイトは、「1日10万回の書き込み」と「0.1秒以内の応答」を無料プランの範囲内で両立させるため、短期間のうちに複数のデータベース技術を渡り歩いてきました。そして今、SQLiteをベースとしたエッジデータベース<strong>「Turso（ターソ）」</strong>に定住することを決意しました。</p>
                    <p>なぜ、流行のSupabaseや、最強スペックのTiDBではなく、Tursoを選んだのか。その技術的な比較と選定理由（裏話）をここに公開いたします。</p>

                    <div class="overflow-x-auto mb-8">
                        <table class="comparison-table" style="min-width: 100%; font-size: 0.8rem;">
                            <thead class="bg-gray-100 dark:bg-zinc-700 font-bold">
                                <tr>
                                    <th class="p-2 border border-gray-300">比較項目</th>
                                    <th class="p-2 border border-gray-300 text-gray-500">Supabase (PostgreSQL)</th>
                                    <th class="p-2 border border-gray-300 text-gray-500">TiDB (MySQL互換)</th>
                                    <th class="p-2 border border-gray-300 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-800 dark:text-emerald-200 border-b-4 border-emerald-500">Turso (SQLite互換)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="p-2 border border-gray-300 font-bold">無料枠の容量</td>
                                    <td class="p-2 border border-gray-300 text-red-600">500 MB<br><span class="text-xs text-gray-400">（少し厳しい）</span></td>
                                    <td class="p-2 border border-gray-300 font-bold">5 GiB<br><span class="text-xs text-gray-400">（理想的）</span></td>
                                    <td class="p-2 border border-gray-300 font-bold text-emerald-600">5 GB<br><span class="text-xs text-gray-400">（十分な広さ）</span></td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300 font-bold">処理能力上限</td>
                                    <td class="p-2 border border-gray-300">CPU共有</td>
                                    <td class="p-2 border border-gray-300">50M RU/月</td>
                                    <td class="p-2 border border-gray-300 font-bold">読込 5億回 / 書込 1000万回</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300 font-bold">不採用の理由</td>
                                    <td class="p-2 border border-gray-300">将来的に容量不足になる懸念があったため</td>
                                    <td class="p-2 border border-gray-300 font-bold text-red-600">移行時にサイトが完全停止する致命的な不具合が発生</td>
                                    <td class="p-2 border border-gray-300 font-black text-lg text-emerald-600">◎ 採用</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <p>正直に申し上げますと、スペック上は<strong>TiDB</strong>（5GiB / 5000万リクエストユニット）が最も理想的でした。しかし、実際に移行を試みたところ、当サイトのシステムとの相性問題により、画面が一切表示されなくなる致命的な事態に陥りました。動かないことにはどうしようもありません。</p>
                    <p>一方、<strong>Supabase</strong>は安定していますが、無料枠の容量が<strong>500MB</strong>と厳しく、長く運営するには不安が残りました。</p>
                    
                    <p>最終的に採用した<strong>Turso</strong>にも、月間読み取り5億回、書き込み1000万回という制限は存在します。しかし、当サイトでは以下の4つの対策を講じることで、この制限には到底達しない堅牢な設計を実現しております。</p>

                    <h4>① フロントエンド：通信頻度の抑制（ポーリング間隔の延長）</h4>
                    <p>クライアント側（ブラウザ）からサーバーへのデータ要求頻度を大幅に下げています。具体的には、統計情報とカウンターの自動更新間隔を従来の5秒から<strong>1分（60,000ミリ秒）</strong>に変更しました。これにより、読み取り負荷を約10分の1に削減しています。</p>

                    <h4>② バックエンド：レート制限（Rate Limiting）の導入</h4>
                    <p>特定のIPアドレスからの過剰なアクセスを遮断し、データベースへの書き込み負荷を制御しています。おみくじは<strong>1分間に60回</strong>まで、認証関連は<strong>1分間に5回</strong>までという制限を設けており、これを超過した場合は処理を中断する仕組みを実装しました。</p>

                    <h4>③ データベース接続方式の最適化（HTTP API利用）</h4>
                    <p>サーバーレス環境における接続数制限を回避するため、Tursoへの接続には永続的なTCP接続ではなく、<strong>HTTP API（Pipeline）</strong>を使用しています。これにより、リクエストごとにインスタンスが立ち上がる環境でも、接続数上限に達することなく安定して処理を行えます。</p>

                    <h4>④ データベース基盤の選定（Tursoへの移行）</h4>
                    <p>前述の通り、以前使用していたCloudflare D1やSupabaseの無料枠制限（容量や書き込み制限）を回避するために、より制限の緩やかな<strong>Turso</strong>を最終的に採用しています。</p>

                    <p>この強固で軽快、そして身の丈に合った礎の上で、これからも皆様に快適な「天命」をお届けしてまいります。</p>
                </div>
            `
        },
        {
            id: 37,
            title: "【完全復旧】大規模障害のお詫びと、全データリセット及び「参拝の記録」への刷新について",
            date: "2026/1/23",
            time: "18:45",
            tag: "重要・復旧",
            tagColor: "text-red-700",
            borderColor: "border-red-600",
            desc: "昨夜より発生していた深刻なシステム障害が復旧しました。これに伴い全データをリセットし、機能を「参拝の記録」へと刷新いたしました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。運営者のnden148です。</p>
                    
                    <h3 class="text-red-600">【重要】大規模障害のお詫び</h3>
                    <p>昨夜（1月22日）より実施いたしました大規模アップデートの影響により、本日夕方までの長期間にわたり、<strong>サイトが全く動作しない、画面が表示されない、何も反応しない</strong>という、極めて深刻な障害が発生しておりました。</p>
                    <p>「運勢サイト」でありながら、おみくじすら引けないという、サイトとしてあるまじき状態（機能不全）に陥ってしまい、参拝に訪れてくださった皆様には多大なるご迷惑とご不快な思いをおかけしましたことを、深く、深くお詫び申し上げます。</p>
                    <p>現在は問題となっていたコードを根本から修正し、大規模アップデート前の「正常に動作する状態」へと完全復旧いたしました。</p>

                    <h3>1. 全データの完全リセット（浄化）について</h3>
                    <p>今回のシステム崩壊により、データベース内部に深刻な不整合と破損が生じておりました。中途半端な修復は再びの崩壊を招くと判断し、断腸の思いではございますが、<strong>「アカウント情報」「おみくじの履歴」「獲得したバッジ」を含む、全てのデータを完全にリセット（消去）</strong>させていただきました。</p>
                    <p>これまで積み上げてこられた記録を消してしまうこととなり、誠に申し訳ございません。これより先は、強固になった新しい地盤の上で、再びゼロから歴史を刻んでいただけますと幸いです。</p>
                    <p><strong>※大変お手数ですが、再度「新規登録」よりアカウントの作成をお願い申し上げます。</strong></p>

                    <h3>2. 「参拝者台帳」から「参拝の記録」へ</h3>
                    <p>復旧にあたり、機能の見直しを行いました。これまで「参拝者台帳（プロフィール）」として提供していた機能は、他者との交流よりも「自分自身の運勢と向き合うこと」に特化するため、<strong>「参拝の記録」</strong>へと名称および機能を変更いたしました。</p>
                    <ul class="list-disc ml-5 mb-4">
                        <li>ご自身の「総参拝数」「大吉獲得数」「連続参拝日数」の数値データ</li>
                        <li>獲得した「功徳の証（実績バッジ）」の一覧</li>
                    </ul>
                    <p>これらをシンプルに確認できる、静かな記録場として再定義しております。</p>

                    <p>二度とこのような「何も動かない」事態を引き起こさぬよう、今後は開発体制を抜本的に見直し、安定稼働を最優先に運営してまいります。<br>新しく生まれ変わった、そして正常に戻った天命乃杜を、どうかこれに懲りずよろしくお願い申し上げます。</p>
                </div>
            `
        },
        {
            id: 36, // 新規記事
            title: "【解禁】おみくじの「連打制限」を大幅に緩和しました。心ゆくまでお引きください。",
            date: "2026/1/22",
            time: "22:00",
            tag: "制限緩和",
            tagColor: "text-green-600",
            borderColor: "border-green-600",
            desc: "データベース基盤を「Turso」へ刷新したことに伴い、おみくじを引く際の回数制限（レートリミット）を事実上撤廃に近いレベルまで緩和いたしました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日、データベースの接続方式をHTTPネイティブな「Turso」へと移行いたしました。これにより、従来のデータベースで発生していた「接続エラー」や「書き込み遅延」の問題が根本的に解消されました。</p>

                    <h3>おみくじ制限の大幅緩和</h3>
                    <p>システムの安定性が飛躍的に向上したことを受け、これまで厳しく設定していた「おみくじの参拝制限（レートリミット）」を以下の通り緩和いたしました。</p>
                    <ul class="list-disc ml-5 mb-4">
                        <li><strong>旧仕様：</strong> 1分間に20回まで（3秒に1回）</li>
                        <li><strong>新仕様：</strong> 1分間に300回まで（1秒に5回）</li>
                    </ul>
                    <p>これにより、人間が手動で行う常識的な範囲であれば、実質的に制限を気にすることなく何度でもおみくじを引いていただけるようになりました。思う存分、納得のいく結果が出るまで天命と向き合ってください。</p>

                    <h3>セキュリティは厳格に維持</h3>
                    <p>一方で、皆様の大切なアカウントを守るための「ログイン・登録」に関する制限につきましては、防犯上の理由から<strong>「1分間に5回まで」</strong>という厳格なルールを維持しております。</p>
                    <p>もし制限にかかってしまった場合は、画面に「あと何秒で解除されるか」が正確に表示されるようになりましたので、少し深呼吸をしてお待ちいただければ幸いです。</p>
                    
                    <p>より自由で、より安全になった新しい杜を、どうぞお楽しみください。</p>
                </div>
            `
        },
        {
            id: 35, // 新規記事
            title: "【極致】宇宙最強のデータベース『TiDB（タイタン）』への到達と、真の無限について",
            date: "2026/1/22",
            time: "17:30",
            tag: "システム刷新",
            tagColor: "text-purple-600",
            borderColor: "border-purple-600",
            desc: "Supabaseの限界を超え、理論上の上限が存在しない分散型SQL「TiDB」へ完全移行しました。これにより、もはや物理的な制約は消滅しました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日、当サイトはデータベース基盤をSupabaseから、分散型SQLデータベースの頂点である<strong>「TiDB Serverless（タイタン・デービー）」</strong>へと完全移行いたしました。</p>

                    <h3>なぜSupabaseではダメだったのか</h3>
                    <p>先日導入したSupabaseは確かに強力でしたが、それでも「物理的なサーバーの箱」の中にデータが入っていることには変わりありませんでした。接続数（コネクション）の上限や、CPUの限界、そしてディスク容量の壁……。皆様の熱狂的な参拝（アクセス）が集中すれば、いつかはその箱が溢れてしまうリスクが残っていました。</p>

                    <h3>「TiDB」— それは銀河のようなデータベース</h3>
                    <p>今回採用したTiDBは、従来のデータベースとは概念が異なります。データが増えれば自動的に細胞分裂のように保存領域（TiKV）が増殖し、計算能力（TiDB）も無限に横へと広がっていきます。</p>
                    <p>そこには「1つのサーバーの限界」という概念が存在しません。ペタバイト（1000テラバイト）級のデータであろうと、秒間数百万回の書き込みであろうと、銀河が星々を飲み込むように平然と処理し続けます。</p>

                    <h3>歴代システムの性能比較表（最終版）</h3>
                    <p>当サイトが辿り着いた、データベース進化の終着点をご覧ください。</p>

                    <div class="overflow-x-auto mb-8">
                        <table class="comparison-table" style="min-width: 100%; font-size: 0.8rem;">
                            <thead class="bg-gray-100 dark:bg-zinc-700 font-bold">
                                <tr>
                                    <th class="p-2 border border-gray-300">項目</th>
                                    <th class="p-2 border border-gray-300 bg-gray-200 dark:bg-zinc-800 text-gray-500">Supabase (Postgres)</th>
                                    <th class="p-2 border border-gray-300 bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-200 border-b-4 border-purple-500">TiDB (Distributed SQL)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="p-2 border border-gray-300 font-bold">スケーラビリティ</td>
                                    <td class="p-2 border border-gray-300">垂直 (箱を大きくする限界あり)</td>
                                    <td class="p-2 border border-gray-300 font-black text-lg text-purple-700 dark:text-purple-300">水平・無限<br><span class="text-xs font-normal">※ノード自動追加で青天井</span></td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300 font-bold">同時接続数</td>
                                    <td class="p-2 border border-gray-300">プール上限あり</td>
                                    <td class="p-2 border border-gray-300 font-bold">制限なし<br><span class="text-xs font-normal">(サーバーレスアーキテクチャ)</span></td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300 font-bold">ストレージ上限</td>
                                    <td class="p-2 border border-gray-300">ディスクサイズに依存</td>
                                    <td class="p-2 border border-gray-300 font-bold">事実上の無限<br><span class="text-xs font-normal">(分散ストレージ TiKV)</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <p>この移行により、天命乃杜は「システム的な限界」という言葉から解放されました。どれだけ多くの人が同時に参拝し、どれだけ長い年月データを蓄積しても、この杜が揺らぐことは二度とありません。</p>
                    <p>真の永遠を手に入れた神域で、心ゆくまでお過ごしください。</p>
                </div>
            `
        }, 
        {
            id: 34, // 新規記事
            title: "【聖域拡張】「Supabase（無尽蔵の書庫）」への遷宮完了と、制限の完全撤廃について",
            date: "2026/1/20",
            time: "12:00",
            tag: "システム刷新",
            tagColor: "text-indigo-600",
            borderColor: "border-indigo-600",
            desc: "Cloudflare D1をも超える、真に制限のないデータベース「Supabase」へ完全移行いたしました。これにより書き込み制限という概念そのものが消滅しました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日、当サイトはさらなる安定と拡張を求め、データベース基盤を「Cloudflare D1」から、より強靭で広大な<strong>「Supabase（シュパベース）」</strong>へと完全移行（遷宮）いたしました。</p>

                    <h3>なぜ、短期間でD1から移行したのか？</h3>
                    <p>先日導入した「D1」は、旧来のKVに比べれば100倍の性能を持っていました。しかし、それでも「1日10万回」という書き込み上限（壁）が存在し、皆様の熱狂的な参拝（連打）の前では、夕方には門を閉じざるを得ないリスクが残っていました。</p>
                    <p>今回採用した「Supabase」は、PostgreSQLをベースとした世界最高峰のデータベース・プラットフォームです。この神域には、回数による書き込み制限が存在しません。</p>

                    <h3>歴代システムの性能比較表（理論値）</h3>
                    <p>当サイトが歩んできた、データベース進化の歴史と性能差をご覧ください。</p>

                    <div class="overflow-x-auto mb-8">
                        <table class="comparison-table" style="min-width: 100%; font-size: 0.8rem;">
                            <thead class="bg-gray-100 dark:bg-zinc-700 font-bold">
                                <tr>
                                    <th class="p-2 border border-gray-300">項目</th>
                                    <th class="p-2 border border-gray-300 bg-gray-200 dark:bg-zinc-800 text-gray-500">第一世代 (KV)</th>
                                    <th class="p-2 border border-gray-300 bg-blue-50 dark:bg-blue-900/10 text-blue-700 dark:text-blue-300">第二世代 (D1)</th>
                                    <th class="p-2 border border-gray-300 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-800 dark:text-indigo-200 border-b-4 border-indigo-500">新・第三世代 (Supabase)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="p-2 border border-gray-300 font-bold">1日の書込上限</td>
                                    <td class="p-2 border border-gray-300 font-mono text-red-600">1,000回</td>
                                    <td class="p-2 border border-gray-300 font-mono">100,000回</td>
                                    <td class="p-2 border border-gray-300 font-mono text-indigo-700 dark:text-indigo-300 font-black text-lg">無制限<span class="text-xs font-normal block">※容量が許す限り無限</span></td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300 font-bold">同時接続耐性</td>
                                    <td class="p-2 border border-gray-300">極めて低い</td>
                                    <td class="p-2 border border-gray-300">高い</td>
                                    <td class="p-2 border border-gray-300 font-bold">極めて高い<span class="text-xs font-normal block">(Realtime API)</span></td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300 font-bold">データ保存期間</td>
                                    <td class="p-2 border border-gray-300">不安定</td>
                                    <td class="p-2 border border-gray-300">永続的</td>
                                    <td class="p-2 border border-gray-300 font-bold">永続的 + 自動バックアップ</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300 font-bold">最大参拝数/日</td>
                                    <td class="p-2 border border-gray-300">約300人</td>
                                    <td class="p-2 border border-gray-300">約3万人</td>
                                    <td class="p-2 border border-gray-300 font-black text-lg">測定不能<span class="text-xs font-normal block">(実質無限)</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h3>これからの天命乃杜</h3>
                    <p>Supabaseへの移行により、システム上のボトルネックは完全に解消されました。「おみくじの轍」の保存も、リアルタイムの統計反映も、すべてがかつてない速度と安定性で動作します。</p>
                    <p>これからは、システムの限界を気にすることなく、心ゆくまで参拝をお楽しみください。</p>
                </div>
            `
        },
        {
            id: 33,
            title: "【重要】神域の『大遷宮（サーバー完全移行）』完了と、全データ一新のお知らせ",
            date: "2026/1/19",
            time: "17:50",
            tag: "重要・システム",
            tagColor: "text-red-700",
            borderColor: "border-red-600",
            desc: "旧来の制限を撤廃するため、データベース基盤を無制限の広大な土地（Supabase）へ移しました。これに伴い、全ての記録を「ゼロ」から再スタートいたしました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。運営者のnden148です。</p>
                    <p>本日、当サイトの心臓部であるデータベースシステムに対し、過去最大規模の<strong>「大遷宮（サーバー完全移行）」</strong>を執り行いました。</p>

                    <h3>1. 無限の器への移行（制限の撤廃）</h3>
                    <p>これまで使用していたシステム（D1）では、参拝者様の増加に伴い「読み取り制限」の壁に直面しておりました。おみくじを引くたびに読み込みが止まる（ローディングが消えない）現象や、表示が遅れる問題が発生し、皆様に多大なるストレスをおかけしておりました。</p>
                    <p>この度、それらの制限が一切ない、広大で強靭なデータベース（Supabase）へと社殿を移しました。これにより、以下の改善が実現しました。</p>
                    <ul class="list-disc ml-5 mb-4">
                        <li><strong>読み取り数制限の撤廃：</strong> どれだけ多くの方が参拝しても、システムが止まることはありません。</li>
                        <li><strong>リアルタイム更新：</strong> キャッシュ（一時保存）による待機時間を廃止しました。おみくじを引いた瞬間、カウンターや統計が即座に反映されます。</li>
                        <li><strong>連打フリーズの解消：</strong> 通信処理を根本から見直し、ボタンを何度押しても画面が固まらないよう改修しました。</li>
                    </ul>

                    <h3>2. 新たな歴史の始まり（全データリセット）</h3>
                    <p>この移行に伴い、旧システムに残っていた不整合や澱みを完全に浄化するため、<strong>累計発行本数を含む「全てのデータ」をリセットし、ゼロからの再スタート</strong>とさせていただきました。</p>
                    <p>これまで積み上げてこられた「おみくじの轍」や「実績バッジ」が消えてしまったことは誠に心苦しい限りですが、これは未来永劫、安定して杜を運営し続けるための「礎（いしずえ）」を築くために必要な儀式でした。</p>

                    <h3>3. 参拝者の皆様へのお願い</h3>
                    <p>大変お手数をおかけいたしますが、以前会員登録されていた方も含め、<strong>あらためて「新規登録」の手続き</strong>をお願い申し上げます。（同じメールアドレスが使用可能です）</p>
                    <p>今日という日が、天命乃杜の、そして皆様の新たな「始まりの日」となりますように。新しくなった神域で、心ゆくまで参拝をお楽しみください。</p>
                </div>
            `
        },
        {
            id: 32,
            title: "【改善】参拝時の「お告げ（通知）」と、神札（メール）の書式を整えました",
            date: "2026/1/18",
            time: "14:40",
            tag: "機能改善",
            tagColor: "text-green-600",
            borderColor: "border-green-600",
            desc: "混雑時の制限解除時間を正確にお伝えするように改良し、認証メールの書式を杜の雰囲気に合わせて統一いたしました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日午後、参拝者の皆様により快適に、そして心地よくお過ごしいただくため、以下の2点の改善を行いました。</p>

                    <h3>1. 「天命の戒め（制限通知）」の明細化</h3>
                    <p>熱心な参拝により「結界（レート制限）」に触れた際、これまでは単に「上限です」とお伝えするのみでしたが、神様のご意向をより正確にお伝えするよう改良いたしました。</p>
                    <p>今後は、<strong>「現在の制限ルール（例：1分間に20回まで）」</strong>と<strong>「解除までの残り時間（例：あと15秒）」</strong>が具体的に表示されます。焦らず、深呼吸をして時が満ちるのをお待ちください。</p>

                    <h3>2. 認証メール（神札）の書式統一</h3>
                    <p>ログインや登録の際にお届けしている「認証コード」のメールについて、一部の数字フォントが杜の雰囲気と異なっていた点を修正いたしました。</p>
                    <p>全体を格式高い「明朝体」で統一し、紅のラインとお札風のデザインで、デジタルの世界であっても和の心を感じていただけるよう整えました。</p>

                    <p>今後とも、細部に宿る神性を大切に運営してまいります。</p>
                </div>
            `
        },
        {
            id: 30,
            title: "【開発秘話】幻となった「参拝掲示板」機能の完全廃棄と、深夜の苦闘について",
            date: "2026/1/18",
            time: "08:45",
            tag: "機能廃棄",
            tagColor: "text-gray-600",
            borderColor: "border-gray-600",
            desc: "昨夜から開発を進めていた投稿・交流機能ですが、技術的な欠陥と理念上の理由により、実装を断念しコードを完全削除いたしました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。個人開発者のnden148です。</p>
                    <p>本日は、皆様にお詫びと、少し情けない開発裏話をご報告しなければなりません。</p>
                    
                    <h3>幻の「参拝掲示板」計画</h3>
                    <p>実は昨夜から深夜にかけて、このサイトに<strong>「X（旧Twitter）のような投稿・交流機能」</strong>を実装しようと躍起になっておりました。</p>
                    <p>「参拝者が互いに励まし合える場所を作りたい」「おみくじ結果をサイト内で共有し、拍手（リアクション）やコメントを送り合えるようにしたい」。そんな思いから、定型文を選んで奉納する機能や、それに反応するシステムをほぼ完成間近まで作り込んでおりました。</p>

                    <h3>深夜の熱狂と、朝の絶望</h3>
                    <p>深夜3時の段階では、機能は完璧に動いているように見えました。「これは行ける！」と確信し、泥のように眠りについたのですが……。</p>
                    <p>朝起きて再度コードを実行したところ、原因不明のエラーが多発。修正すればするほど新たなバグが生まれ、サイト全体の挙動まで不安定になる事態に陥りました。私の技術力不足と言われればそれまでですが、まるで「この機能は杜に相応しくない」と神様に拒絶されているかのようでした。</p>

                    <h3>「杜」の静寂を守るための決断</h3>
                    <p>また、冷静になって考え直しました。もし制限なしの投稿機能を実装すれば、この静かな杜が荒れ、誹謗中傷やスパムで溢れかえるリスクがあります。それを防ぐために「定型文のみ」という制限を設けようとしましたが、それでは本来やりたかった自由な交流とは程遠いものになってしまいます。</p>
                    <p><strong>「中途半端な機能を入れるくらいなら、ない方がいい」</strong></p>
                    <p>以前、「地図機能」を中止した際はテキスト版として復活させましたが、<strong>今回は違います。</strong>この投稿機能に関しては、別のかたちで復活させることも、裏でこっそり開発を続けることもありません。コードはすべて削除し、完全に白紙に戻しました。</p>
                    <p>「ガチで、マジで、今回はありません」</p>
                    <p>期待させてしまった（かもしれない）皆様、申し訳ございません。当面は、静かに自分と向き合う「おみくじ」と「記録」の機能に特化して運営してまいります。</p>
                </div>
            `
        },
        {
            id: 29,
            title: "【重要】神域の静寂を守るための「結界（レート制限）」設置と、無限ではない資源について",
            date: "2026/1/17",
            time: "19:00",
            tag: "システム・規律",
            tagColor: "text-red-700",
            borderColor: "border-red-600",
            desc: "データベースの強化により制限は大幅に緩和されましたが、資源は無限ではありません。公平な参拝環境を守るため、過度な連打に対する結界を設けました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日、一部の熱心な参拝者様による「高速連打参拝」が見受けられました。皆様の信仰心は大変喜ばしいものではございますが、杜（サーバー）全体の平穏と、すべての参拝者様が等しく恩恵を受けられる環境を守るため、新たな<strong>「結界（レート制限）」</strong>を設置いたしました。</p>

                    <h3>1. Cloudflare D1の「広大だが有限」な器</h3>
                    <p>先日ご報告した通り、当杜のデータベースは旧来の「Workers KV」から、最新鋭の「D1」へと移行いたしました。これにより、1日あたりの書き込み許容量は<strong>1,000回から100,000回へと、実に100倍</strong>に拡張されました。</p>
                    <p>しかし、100倍になったとはいえ、それは<strong>「無限」ではありません。</strong></p>
                    <p>もし、機械的なプログラムや過度な連打によって、お一人で短時間に数千回ものおみくじを引かれた場合、広大になったはずのD1の器もたちまち溢れかえり、他の参拝者様が参拝できなくなる（データベースがロックされる、または無料枠を超過して停止する）リスクがございます。</p>

                    <h3>2. 新たな参拝の作法（制限内容）</h3>
                    <p>そこで、本日より以下の通り、機能ごとに異なる強度の「結界」を導入いたしました。</p>
                    
                    <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded border border-red-200 dark:border-red-800 my-4">
                        <h4 class="font-bold text-red-800 dark:text-red-200 mb-2">【壱：おみくじ（参拝）の制限】</h4>
                        <ul class="list-disc ml-5 text-sm">
                            <li><strong>上限：1分間に20回まで</strong></li>
                            <li>（平均して3秒に1回程度のペースです）</li>
                        </ul>
                        <p class="text-xs mt-2 text-gray-600 dark:text-gray-400">※これを超えて引こうとされた場合、画面に「天命の戒め」という警告が表示され、しばらくの間おみくじを引くことができなくなります。</p>
                    </div>

                    <p>また、会員証（アカウント）に関わる「関所」についても、防犯上の観点から厳格な制限を設けております。</p>

                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded border border-blue-200 dark:border-blue-800 my-4">
                        <h4 class="font-bold text-blue-800 dark:text-blue-200 mb-2">【弐：関所（認証・登録）の制限】</h4>
                        <ul class="list-disc ml-5 text-sm">
                            <li><strong>認証コード送信・新規登録：1分間に5回まで</strong></li>
                            <li><strong>ログイン試行：1分間に10回まで</strong></li>
                        </ul>
                        <p class="text-xs mt-2 text-gray-600 dark:text-gray-400">※短時間に何度も門を叩く行為（総当たり攻撃やメールの大量送信）を防ぐための措置です。通常の操作であれば影響はございません。</p>
                    </div>

                    <h3>3. 心を鎮めて引くことの意義</h3>
                    <p>3秒に1回というペースは、通常の参拝（心を鎮め、願いを念じてボタンを押す）であれば、決して引っかかることのない速度です。</p>
                    <p>もしこの警告が表示されたならば、それは<strong>「心が焦っていますよ、少し深呼吸をしなさい」</strong>という神様からのメッセージだとお受け取りください。</p>
                    <p>当杜は、デジタルの世界にあっても、節度と敬意を持った「場」でありたいと願っております。何卒ご理解とご協力をお願い申し上げます。</p>
                </div>
            `
        },
        {
            id: 28,
            title: "【追記】大吉における「黄金」の輝きを、より本物に近づけるための再調整について",
            date: "2026/1/17",
            time: "15:50",
            tag: "意匠変更",
            tagColor: "text-yellow-600",
            borderColor: "border-yellow-500",
            desc: "最高位である「大吉」の地紙について、より鮮やかで深みのある山吹色と、手漉き和紙の質感を再現する調整を行いました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>先ほどご報告いたしました「純白への回帰」に続き、最高位の運勢である「大吉」の意匠につきましても、さらなる改良を行いましたことをお知らせいたします。</p>

                    <p>他の運勢を純白に統一したことで、相対的に特別感が増した「大吉」ですが、その黄金色の表現について、私の中でさらなる追求心が芽生えました。</p>
                    <p><strong>「この金は、まだ浅いのではないか」</strong></p>
                    <p>これまでの大吉は、少し淡い金色をしていました。しかし、最高位の運勢が放つべき輝きは、もっと力強く、太陽のように熱を帯びた色であるべきです。</p>
                    <p>そこで急遽、大吉の地紙（背景）に対し、再度の調整を行いました。</p>
                    
                    <h3>1. 「山吹色（やまぶきいろ）」への深化</h3>
                    <p>色味を、単なる黄色から、赤みを帯びた濃厚な<strong>「山吹色（#ffb700）」</strong>へと変更いたしました。これにより、画面から溢れ出るような豊かさと、威厳のある輝きを表現しております。</p>

                    <h3>2. 手漉き和紙の「繊維」を再現</h3>
                    <p>また、表面の質感（ザラザラ感）についても、プログラムによるノイズ処理を細かく調整し直しました。繊維の一本一本が絡み合っているかのような、深く、くっきりとした凹凸を浮かび上がらせることで、まるで本物の高級和紙を手に取っているかのような手触り（視覚的な触感）を実現いたしました。</p>

                    <p>幸運にも「大吉」を引き当てられた方は、ぜひその「紙」の質感と、目に焼き付くような黄金の輝きにもご注目ください。</p>
                </div>
            `
        },
        {
            id: 27,
            title: "【改装】「純白」への回帰と、影に潜んでいた「二重の記述（ドッペルゲンガー）」の解消について",
            date: "2026/1/17",
            time: "15:15",
            tag: "開発秘話",
            tagColor: "text-red-600",
            borderColor: "border-red-500",
            desc: "サイト背景と御神籤の地紙を「純白」へ統一し、文字色を魔除けの「紅」に改めました。また、デザイン修正を阻んでいた技術的な「怪奇現象」についてもご報告します。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日午後、サイト全体および御神籤（おみくじ）の結果画面に対し、更なる格式の向上を目指した「色彩の儀（カラー調整）」を執り行いました。また、その改修作業中に発覚した、ある「技術的なミステリー」についても併せてご報告いたします。</p>

                    <h3>1. クリーム色から「純白（#ffffff）」へ</h3>
                    <p>これまで当杜の背景や御神籤の紙には、目に優しい「クリーム色（和紙色）」を採用しておりました。しかし、神道において最も尊い色は、混じりけのない<strong>「純白」</strong>であります。</p>
                    <p>「皆様の運勢を曇りなく映し出すには、完全な白であるべきではないか？」</p>
                    <p>そうした思いから、サイト全体の背景色、および<strong>「大吉」を除くすべて（大凶を含む）</strong>の御神籤の地紙を、一切の濁りがない<strong>「真っ白（#ffffff）」</strong>へと統一いたしました。これにより、画面全体がより神聖な空気に包まれております。</p>
                    <p>※なお、「大吉」につきましては、最高位の証として引き続き<strong>「黄金の和紙（ザラザラとした質感）」</strong>の特別仕様を維持しております。</p>

                    <h3>2. 文字色は「紅」、大凶のみ「黒」</h3>
                    <p>あわせて文字色も見直しを行いました。これまでは視認性を重視した「濃い灰色」を用いておりましたが、これをすべて<strong>「紅（#b91c1c）」</strong>へと変更いたしました。紅は生命の象徴であり、魔を祓う色です。</p>
                    <p>ただし、「大凶」が出た場合のみ、自省を促すために厳格な<strong>「黒」</strong>で表示されます。紅と黒、この対比により、天命の重みをより深く感じていただけるはずです。</p>

                    <h3>3. 【開発秘話】消えない「太い線」と、二人の建築家</h3>
                    <p>今回の改装において、最も難航したのが「大吉のハンコの枠線」の調整でした。</p>
                    <p>当初の枠線（4px）はあまりに太く、大吉の品格を損ねていました。そこで「極細の1px」にするよう指示を出したのですが、何度コードを書き換えても、画面上の線は太いまま……。まるで何かの呪いがかかったかのように、変更が反映されない事態に陥りました。</p>
                    <p><strong>「なぜだ、記述は合っているはずなのに」</strong></p>
                    <p>冷や汗を流しながら設計図（CSS）の深部を調査したところ、驚愕の事実が判明しました。なんと、コードの下層部にもう一つ、全く同じ名前のスタイル定義（ドッペルゲンガー）が潜んでいたのです。</p>
                    <p>Webの世界では「後から書かれた命令が優先される」という絶対のルールがあります。上の方でいくら「細くしろ！」と叫んでも、下の方に潜んでいたもう一人の自分が「いや、太くしろ！」と命令を上書きしていたのです。</p>
                    <p>直ちにこの重複を解消（削除）し、再調整を行いました。当初試みた1pxでは線が細すぎて頼りなく、かといって元の4pxでは主張が強すぎたため、その間をとった<strong>「2px」</strong>こそが、最も品のあるハンコらしく見える絶妙な太さであると判断いたしました。現在は、スッキリとした美しい印影が皆様の運勢を彩っております。</p>
                </div>
            `
        },
        {
            id: 31,
            title: "【新機能】「参拝者台帳（プロフィール）」の公開と、功徳の証について",
            date: "2026/1/17",
            time: "13:30",
            tag: "新機能",
            tagColor: "text-blue-600",
            borderColor: "border-blue-500",
            desc: "皆様の参拝記録や獲得した実績（バッジ）を閲覧できる「参拝者台帳」を実装いたしました。自己紹介やアイコンの設定も可能です。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日お昼頃より開発を進めておりました会員限定の新機能<strong>「参拝者台帳（プロフィール機能）」</strong>が完成し、先ほど正式に公開いたしました。</p>
                    
                    <h3>参拝者台帳でできること</h3>
                    <p>サイドメニューの「参拝者台帳」ボタン、またはログイン情報のエリアから、ご自身の分身となるページにアクセスできます。</p>
                    <ul class="list-disc ml-5 mb-4">
                        <li><strong>参拝記録の閲覧：</strong> これまで引いたおみくじの総数や、大吉を引き当てた回数、連続参拝日数などが一目でわかります。</li>
                        <li><strong>功徳の証（バッジ）：</strong> 「大吉を引く」「深夜に参拝する」など、特定の条件を満たすと獲得できる「実績バッジ」が表示されます。コンプリートを目指して励んでください。</li>
                        <li><strong>個性の表現：</strong> 編集ボタンから、アイコンの絵柄や色、称号（通り名）、自己紹介文を自由に設定できます。</li>
                    </ul>

                    <h3>開発経緯</h3>
                    <p>「自分だけの記録を眺めたい」「他の参拝者がどんな運勢を引いているのか知りたい」というお声にお応えすべく、急ピッチで工事を行いました。驚くべきことに、神がかった集中力により着手から数時間でのスピード実装となりました。</p>
                    <p>今はまだシンプルな台帳ですが、将来的にはこの台帳を通じて、参拝者同士が互いの幸運を祝い合えるような仕組み（※あくまで静かな形での）も検討しております。</p>
                    <p>まずはご自身のページを整え、杜の住人としての証をお持ちください。</p>
                </div>
            `
        },
        {
            id: 26,
            title: "【改装】御神籤（おみくじ）結果画面の意匠刷新と、格式向上について",
            date: "2026/1/17",
            time: "12:35",
            tag: "デザイン刷新",
            tagColor: "text-teal-600",
            borderColor: "border-teal-500",
            desc: "皆様にお渡しする御神籤のデザインを大幅に刷新いたしました。伝統的な縦書きへの変更や、地紙（背景色）の純白化による視認性向上を行っております。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日、皆様が受け取る「御神籤（おみくじ）」の書式および意匠について、より神事としての格式を高め、かつ現代的な美しさを追求するための大規模な改装を実施いたしました。主な変更点は以下の通りです。</p>

                    <h3>1. 伝統に則った「縦書き」の採用</h3>
                    <p>本場神社の御神籤にならい、主文である「吉凶」の表示を横書きから<strong>「縦書き」</strong>へと変更いたしました。また、文字数の多い結果についても円形の印の中に美しく収まるよう、言霊の大きさを動的に調整する仕組みを導入しております。フォントについても、画像のように力強い筆致を再現いたしました。</p>

                    <h3>2. 地紙（背景色）の統一と純白化</h3>
                    <p>視認性を極限まで高めるため、特別な「大吉」を除き、すべての御神籤の背景を<strong>「純白」</strong>へと統一いたしました。</p>
                    <ul class="list-disc ml-5 mb-4">
                        <li><strong>標準および大凶：</strong> これまでのクリーム色（和紙風）や黒色の背景を廃止し、濁りのない真っ白な地紙に変更いたしました。これにより、紅や墨の文字が鮮明に浮かび上がり、どのような環境下でも神託を明確にお読みいただけます。</li>
                        <li><strong>大吉：</strong> 唯一の例外として、地紙そのものが重厚な「黄金」に輝く特別仕様を維持しております。印の縁を極細の紅線とすることで、より繊細で上品な意匠に仕上げました。</li>
                    </ul>

                    <h3>3. 運勢を象徴する印影（ハンコ）</h3>
                    <p>配色についても見直しを行い、大凶以外の文字色はすべて縁起の良い<strong>「紅」</strong>で統一いたしました。大凶のみ、自省を促す「黒」の書式となります。印影のデザインも、従来の二重線を廃止し、より本物に近い円形の印を採用しております。</p>

                    <p>新しくなった御神籤を手に、日々の道しるべとしていただければ幸いです。なお、本意匠に関する個別の修正要望や技術的なお問い合わせにつきましては、規約通り一切受け付けておりませんので、現在の杜の姿をそのまま受け入れ、お楽しみください。</p>
                </div>
            `
        },
        {
            id: 25,
            title: "【重要】データベースシステムの刷新と、それに伴う制限撤廃の詳細報告",
            date: "2026/1/16",
            time: "23:34",
            tag: "システム更新",
            tagColor: "text-indigo-600",
            borderColor: "border-indigo-500",
            desc: "データベース基盤を「Cloudflare D1」へ完全移行いたしました。KV時代の書き込み制限（1日1,000回）を突破し、神速の10万回書き込みを実現した詳細な技術比較を公開いたします。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日実施いたしましたデータベース基盤の「Cloudflare D1」への完全移行に伴い、旧来のシステム（Workers KV）と比較して、当杜の耐久性がどれほど向上したかを数値でご報告申し上げます。</p>

                    <h3>1. 基本性能と「1日の上限」比較</h3>
                    <p>Cloudflare Workersの無料枠における公式制限に基づき、正確に算出した比較表です。リセットは毎日<strong>JST 午前9:00（UTC 0:00）</strong>に行われます。</p>
                    
                    <div class="overflow-x-auto mb-8">
                        <table class="comparison-table" style="min-width: 100%; font-size: 0.8rem;">
                            <thead class="bg-gray-100 dark:bg-zinc-700 font-bold">
                                <tr>
                                    <th class="p-2 border border-gray-300">項目</th>
                                    <th class="p-2 border border-gray-300 bg-red-50 dark:bg-red-900/10 text-red-700 dark:text-red-300">旧システム (KV)</th>
                                    <th class="p-2 border border-gray-300 bg-blue-50 dark:bg-blue-900/10 text-blue-700 dark:text-blue-300">新システム (D1)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="p-2 border border-gray-300 font-bold">1日の書き込み上限</td>
                                    <td class="p-2 border border-gray-300 text-red-600 font-mono">1,000回</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-mono">100,000回 (100倍)</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300 font-bold">1日の読み取り上限</td>
                                    <td class="p-2 border border-gray-300 text-red-600 font-mono">100,000回</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-mono">5,000,000回 (50倍)</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300 font-bold">最大参拝可能数（1日）</td>
                                    <td class="p-2 border border-gray-300 font-mono">約 333 本</td>
                                    <td class="p-2 border border-gray-300 font-mono text-blue-600">約 33,333 本</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300 font-bold">認証（登録・ログイン）</td>
                                    <td class="p-2 border border-gray-300 font-mono">計 1,000 回まで</td>
                                    <td class="p-2 border border-gray-300 font-mono text-blue-600">計 100,000 回まで</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h3>2. 1タブ放置時の「読み取り負荷」詳細分析</h3>
                    <p>当杜では1分間に1回、カウンター（1行）と統計（12行）の計13行を読み取ります。負荷（0.217回/秒）は変わりませんが、制限枠の拡大により、耐用時間が飛躍的に伸びました。</p>

                    <div class="overflow-x-auto mb-8">
                        <table class="comparison-table" style="min-width: 100%; font-size: 0.8rem;">
                            <thead class="bg-gray-100 dark:bg-zinc-700 font-bold">
                                <tr>
                                    <th class="p-2 border border-gray-300" rowspan="2">経過時間</th>
                                    <th class="p-2 border border-gray-300" rowspan="2">総読取行数</th>
                                    <th class="p-2 border border-gray-300 bg-red-50 dark:bg-red-900/10" colspan="2">旧システム (KV)</th>
                                    <th class="p-2 border border-gray-300 bg-blue-50 dark:bg-blue-900/10" colspan="2">新システム (D1)</th>
                                </tr>
                                <tr>
                                    <th class="p-2 border border-gray-300">消費率</th>
                                    <th class="p-2 border border-gray-300">同時放置可能数</th>
                                    <th class="p-2 border border-gray-300">消費率</th>
                                    <th class="p-2 border border-gray-300">同時放置可能数</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="p-2 border border-gray-300 font-bold">1分間</td>
                                    <td class="p-2 border border-gray-300 font-mono">13行</td>
                                    <td class="p-2 border border-gray-300 font-mono">0.013%</td>
                                    <td class="p-2 border border-gray-300 font-mono">7,692人</td>
                                    <td class="p-2 border border-gray-300 font-mono text-blue-600">0.00026%</td>
                                    <td class="p-2 border border-gray-300 font-mono text-blue-600">384,615人</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300 font-bold">10分間</td>
                                    <td class="p-2 border border-gray-300 font-mono">130行</td>
                                    <td class="p-2 border border-gray-300 font-mono">0.13%</td>
                                    <td class="p-2 border border-gray-300 font-mono">769人</td>
                                    <td class="p-2 border border-gray-300 font-mono text-blue-600">0.0026%</td>
                                    <td class="p-2 border border-gray-300 font-mono text-blue-600">38,461人</td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300 font-bold">1時間</td>
                                    <td class="p-2 border border-gray-300 font-mono">780行</td>
                                    <td class="p-2 border border-gray-300 font-mono">0.78%</td>
                                    <td class="p-2 border border-gray-300 font-mono text-red-500">128人</td>
                                    <td class="p-2 border border-gray-300 font-mono text-blue-600">0.0156%</td>
                                    <td class="p-2 border border-gray-300 font-mono text-blue-600">6,410人</td>
                                </tr>
                                <tr class="bg-blue-50/30 dark:bg-blue-900/10">
                                    <td class="p-2 border border-gray-300 font-bold">24時間</td>
                                    <td class="p-2 border border-gray-300 font-mono">18,720行</td>
                                    <td class="p-2 border border-gray-300 font-mono text-red-600 font-bold">18.72%</td>
                                    <td class="p-2 border border-gray-300 font-mono text-red-600 font-black">5人</td>
                                    <td class="p-2 border border-gray-300 font-mono text-blue-600 font-bold">0.37%</td>
                                    <td class="p-2 border border-gray-300 font-mono text-blue-600 font-black">267人</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h3>3. 結論としての「制限撤廃」</h3>
                    <p>旧システム（KV）では、わずか5名の参拝者がページを開きっぱなしにするだけで、その日の杜の機能が停止する極めて脆い状態にありました。</p>
                    <p>新システム（D1）への移行により、同じ条件下でも<strong>最大267名</strong>の同時参拝（24時間連続放置）に耐えうる堅牢性を獲得いたしました。短時間の滞在であれば、1日に数万人規模の参拝を受け入れることが可能です。</p>
                    <p>また、以前お伝えしておりました「連打による記録の不整合」についても、D1の持つ「強整合性（トランザクション処理）」により解決しております。猛烈な連打を行っても、数字が逆転したり、記録が消失したりすることはございません。どうぞ、安心して己が天命をお受け取りください。</p>
                </div>
            `
        },
        {
            id: 24,
            title: "【技術解説】「連打参拝」における記録の整合性修正と、個人記録に関する仕様について",
            date: "2026/1/16",
            time: "21:22",
            tag: "システム解説",
            tagColor: "text-orange-600",
            borderColor: "border-orange-500",
            desc: "全体の記録数のズレを修正いたしました。一方で、個人の記録が一部欠落する現象については、連打制限を行わないため「仕様」となります。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>短時間に連続でおみくじを引く、熱心な「連打参拝」を行われた際に発生する記録のズレにつきまして、現在の対応状況と仕様をご説明いたします。</p>

                    <h3>1. 【修正完了】全体の参拝数と累計発行本数</h3>
                    <p>これまで、連打による負荷で「みんなの参拝数（全期間）」と「累計発行本数」に乖離が生じるケースがございましたが、こちらは集計ロジックを見直し、<strong>現在は双方が正しく一致するように修正を完了いたしました。</strong></p>

                    <h3>2. 【仕様】あなたの参拝数（個人履歴）について</h3>
                    <p>一方で、「あなたの参拝数」や履歴リストにつきましては、猛烈な速度で連打を行われた際、データベースへの書き込み処理が追いつかず、<strong>実際の回数よりも数字が少なく表示されたり、一部の履歴が保存されない</strong>現象が残っております。</p>
                    <p>調査の結果、この個人記録の欠落を技術的に完全に防ぐためには、皆様の祈りに「1分間に〇回まで」といった厳格な<strong>「連打制限（レートリミット）」を導入し、操作をブロックするしか方法がない</strong>ことが判明いたしました。</p>

                    <h3>3. 運営の方針：制限よりも「自由な祈り」を</h3>
                    <p>当杜といたしましては、データの数字を合わせるために、皆様の溢れ出る祈りの情熱を拒絶することは本末転倒であると考えます。</p>
                    <p>そのため、<strong>「個人の記録が多少欠落したとしても、連打制限は行わない」</strong>という方針を維持いたします。ご自身の記録が減って見える場合もございますが、それは「システムが追いつかないほどの速さで祈りを捧げた」という証（仕様）として、そのまま受け入れていただけますと幸いです。</p>
                </div>
            `
        },
        {
            id: 23,
            title: "【改装】授与所の意匠変更および「黄金の輝き」演出の追加について",
            date: "2026/1/16",
            time: "19:35",
            tag: "デザイン・作法",
            tagColor: "text-teal-600",
            borderColor: "border-teal-500",
            desc: "おみくじを選ぶ画面を一新。札のデザイン統一、黄金に輝く演出、および参拝作法の案内を刷新いたしました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日、皆様により深く、静かな心でおみくじ（天命）と向き合っていただくため、おみくじを引く画面（授与所）およびホーム画面の改装を行いました。主な変更点は以下の通りです。</p>

                    <h3>1. 札の並びと意匠の刷新</h3>
                    <p>これまで無作為に散らばっていたおみくじ札を、神社の授与所のように<strong>「整然と敷き詰める」</strong>形に変更いたしました。</p>
                    <p>また、札自体のデザインも、従来の丸みを帯びたものから、格式高い「角のある白紙に紅枠」の意匠へと変更し、上部に家紋をあしらいました。これらは職人が一枚一枚切り出した和紙のような風合いを意識しております。</p>

                    <h3>2. 「黄金」に輝く共鳴演出</h3>
                    <p>並べられた札の中から気になる一枚に触れる（カーソルを合わせる）と、<strong>札の縁が「黄金色」に輝く</strong>演出を追加いたしました。</p>
                    <p>これは、あなたの波長と天命が共鳴した瞬間を表現しています。輝きを感じながら、最も心惹かれる一枚をお選びください。</p>

                    <h3>3. 参拝作法の見直し</h3>
                    <p>おみくじを引く前の案内文を、「直感で選ぶ」という簡易なものから、<strong>「深呼吸をして心を鎮め、問いかけを念じる」</strong>という、本来あるべき参拝の作法に則った言葉へと改めました。</p>
                    <p>ただボタンを押すのではなく、画面越しであっても一度立ち止まり、己の心と対話してから引くことで、表示される結果（神託）はより深い意味を持つはずです。</p>

                    <h3>4. ホーム画面の演出強化</h3>
                    <p>トップページ（ホーム）で舞い散る紙片のデザインも、新しい札のデザインと統一いたしました。また、舞う数を大幅に増量し、杜全体に神聖な気が満ちている様子を表現しております。</p>
                    <p>新しくなった杜の雰囲気の中で、どうぞごゆっくりとお過ごしください。</p>
                </div>
            `
        },
        {
            id: 22,
            title: "【完全復旧】「おみくじの轍」等の読み込み不具合解消と、認証結界の再構築について",
            date: "2026/1/16",
            time: "16:45",
            tag: "不具合解消",
            tagColor: "text-green-600",
            borderColor: "border-green-600",
            desc: "一部の環境で発生していた「情報の取得に失敗しました」というエラーを完全に解消する、新しい認証方式を導入いたしました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日、一部の参拝者様（特にiPhoneや最新のブラウザをご利用の方）の環境で発生しておりました、<strong>「ログインしているはずなのに『情報の取得に失敗しました』と表示され、おみくじの轍（履歴）が見られない」</strong>という深刻な不具合につきまして、根本的な解決策を実装し、完全復旧いたしましたことをご報告申し上げます。</p>

                    <h3>原因：ブラウザのセキュリティ強化による「Cookieの遮断」</h3>
                    <p>調査の結果、皆様の端末を守るためのセキュリティ機能（トラッキング防止機能など）が、当サイトの会員証である「Cookie（クッキー）」を誤って「外部からの怪しい通信」と判断し、サーバーへの送信をブロックしてしまっていたことが原因と判明いたしました。</p>
                    <p>これにより、せっかくログインしていただいても、サーバー側では「会員証が見当たらない」と判断せざるを得ず、エラーが表示されておりました。</p>

                    <h3>対策：「ハイブリッド認証結界」の構築</h3>
                    <p>この問題を解決するため、認証システムを抜本的に改良いたしました。<br>従来の「Cookie」による認証に加え、新たに「認証トークン（通行手形）」を直接通信ヘッダーに載せて送る<strong>「ハイブリッド認証方式」</strong>を採用いたしました。</p>
                    <p>これにより、もしブラウザの設定でCookieが遮断されたとしても、もう一つのルートであるトークンが確実に会員証を届け、スムーズに履歴やお気に入りを表示できるようになりました。</p>

                    <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded border border-green-200 dark:border-green-800 my-4">
                        <h4 class="font-bold text-green-800 dark:text-green-200 mb-2"><i class="bi bi-check-circle-fill"></i> 参拝者の皆様へのお願い</h4>
                        <p class="text-sm">
                            システムの更新を反映させるため、大変お手数ですが<strong>一度「ログアウト」していただき、再度「ログイン」</strong>をお願いいたします。<br>
                            再ログイン時に新しい「通行手形」が発行され、以降はエラーが出なくなります。
                        </p>
                    </div>

                    <p>長らくご不便をおかけしましたことを深くお詫び申し上げます。<br>強固になり、かつ柔軟性を増した新しい杜で、安心して過去の運勢（轍）を振り返っていただければ幸いです。</p>
                </div>
            `
        },
        {
            id: 21,
            title: "【重要】神域（サーバー）の守りを固める大規模セキュリティアップデートおよび処理高速化について",
            date: "2026/1/15",
            time: "18:45",
            tag: "セキュリティ・システム",
            tagColor: "text-red-700",
            borderColor: "border-red-600",
            desc: "APIレート制限の導入、XSS脆弱性への対策、および非同期処理による応答速度の向上を実施しました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日、参拝者の皆様により安全かつ快適に、そして永く安心してご利用いただけるよう、<strong>サイトの基盤となるシステム（APIおよびフロントエンド）に対し、大規模なセキュリティ強化とパフォーマンス改修</strong>を実施いたしました。</p>
                    <p>目に見えるデザインの変更はございませんが、裏側では「杜」を守る結界がより強固なものへと張り替えられております。変更点の詳細は以下の通りです。</p>

                    <h3>1. 邪気を払う「レート制限（Rate Limiting）」の導入</h3>
                    <p>これまで当サイトのAPI（神様への通信窓口）は、多くの参拝者を受け入れるために広く開かれておりましたが、機械的なプログラムによる過剰な連続アクセス（DoS攻撃のような行為）に対して脆弱な面がございました。</p>
                    <p>今回の更新により、<strong>「同一のIPアドレスからの通信回数」</strong>に対して、以下の制限（結界）を設けさせていただきました。</p>
                    <ul class="list-disc ml-5 mb-4">
                        <li><strong>一般的な通信（おみくじ等）：</strong> 1分間に60回まで</li>
                        <li><strong>認証関連（ログイン等）：</strong> 1分間に5回まで（不正ログイン試行の防止）</li>
                    </ul>
                    <p>通常の参拝手順であればこの制限にかかることはまずございませんが、もし「アクセス頻度が高すぎます」という表示が出た場合は、少し時間を空けてから再度お試しください。</p>

                    <h3>2. 言霊の浄化（XSS脆弱性への対策）</h3>
                    <p>皆様のお名前や入力された情報（言霊）を表示する際、悪意のある特殊な文字が含まれていた場合に、予期せぬ動作を引き起こす可能性（クロスサイトスクリプティング脆弱性）が確認されました。</p>
                    <p>これに対し、画面に文字を表示する全ての箇所において、<strong>「サニタイズ（無害化）」処理</strong>を徹底いたしました。これにより、どのような文字が入力されても、ただの「文字」として安全に表示されるよう浄化されます。</p>

                    <h3>3. メンテナンス機能の「完全な施錠」</h3>
                    <p>先日導入した「メンテナンス画面」ですが、これまではあくまで「入り口に看板を立てる」だけのものであり、技術的な知識があれば裏口から侵入することが可能でした。</p>
                    <p>今回の改修により、メンテナンスモード稼働中は<strong>サーバー側で全ての通信を遮断する</strong>仕様に変更いたしました。これにより、工事中や神事の最中に予期せぬアクセスが発生し、データが破損するリスクを完全に排除しました。</p>

                    <h3>4. 「神速の祈り」の実現（非同期処理の導入）</h3>
                    <p>守りを固めるだけでなく、快適さも向上させております。<br>
                    これまで、おみくじを引いた際の「履歴の保存」や「統計データの更新」といった裏方の作業が完了するのを待ってから結果を表示していたため、わずかな待ち時間（ラグ）が発生しておりました。</p>
                    <p>今回、これらの記録作業を<strong>「非同期（waitUntil）」</strong>という技術を用いて、結果表示の裏側で並行して行うように改良しました。これにより、神様からの応答速度が向上し、よりスムーズな参拝体験が可能となりました。</p>

                    <p>私たちは、デジタルの杜であっても、皆様の個人情報や大切な運勢の結果を守ることは、神職としての務めであると考えております。<br>今後とも、盤石なセキュリティ体制のもと運営を続けてまいります。</p>
                </div>
            `
        },
        {
            id: 20,
            title: "【新機能】「デジタル御守授与所」の開設および利用規約の改定について",
            date: "2026/1/14",
            time: "20:45",
            tag: "新機能・規約",
            tagColor: "text-indigo-600",
            borderColor: "border-indigo-500",
            desc: "願いに合わせて作る「デジタル御守」機能を公開しました。併せて画像利用に関する規約を更新しました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日、サイドメニューに新たな機能<strong>「御守授与所」</strong>を開設いたしました。</p>
                    
                    <h3>デジタル御守授与所とは</h3>
                    <p>「交通安全」「良縁成就」「金運上昇」など、あなたの現在の願い事を選択していただくことで、その願いに最適な色と文様、そしてお名前（またはサイト名）が刻まれた<strong>世界に一つのデジタル御守</strong>を授与いたします。</p>
                    <p>生成された御守は画像として保存可能です。スマートフォンの壁紙（待ち受け画面）に設定するなどして、日々の守り神としてお持ち歩きください。</p>

                    <h3>利用規約の改定（画像利用について）</h3>
                    <p>新機能の公開に伴い、「当サイトについて・利用規約」の<strong>第4章（著作権と二次利用）</strong>を改定いたしました。</p>
                    <ul class="list-disc ml-5 mb-4">
                        <li><strong>改定前：</strong>おみくじ結果画像のSNSシェアは自由。</li>
                        <li><strong>改定後：</strong>おみくじ結果画像に加え、<strong>「デジタル御守画像」</strong>についても、個人のSNS等で自由に共有・利用していただいて構いません。</li>
                    </ul>
                    <p>授かった御守をInstagramやX（旧Twitter）などでシェアし、皆様の願いがより多くの天命に届くことを祈念しております。</p>
                </div>
            `
        },
        {
            id: 19,
            title: "【システム】サーバーメンテナンス機能の実装と、黄金のカラーコーンについて",
            date: "2026/1/14",
            time: "18:30",
            tag: "システム更新",
            tagColor: "text-gray-600",
            borderColor: "border-gray-500",
            desc: "安定したサービス提供のため、メンテナンス画面の表示機能を実装いたしました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日、今後の機能追加や修正作業をより安全かつ確実に行うため、<strong>「サーバーメンテナンス機能」</strong>を正式に実装いたしました。</p>
                    
                    <h3>メンテナンス画面について</h3>
                    <p>今後、システムの更新や不具合修正を行う際には、サイト全体が一時的に「メンテナンス中」の画面に切り替わります。</p>
                    <p>画面には現在の状況と、終了予定時刻が簡潔に表示されます。この画面が表示されている間は、データの整合性を守るため、おみくじや会員機能を含むすべてのサービスが一時停止となります。</p>

                    <h3>黄金のカラーコーン</h3>
                    <p>メンテナンス画面の中央には、皆様の安全を守るための「カラーコーン（パイロン）」を設置いたしました。<br>
                    通常の赤色ではなく、天命乃杜の品格に合わせた<strong>「黄金色（ゴールド）」</strong>の特別仕様となっております。滅多に見ることのない画面かもしれませんが、もし遭遇された際は「今、杜を清めている最中だな」と温かく見守っていただければ幸いです。</p>

                    <h3>本日のテスト実施について</h3>
                    <p>本日18:00頃より、本機能の動作テストを実施いたしました。一時的にアクセスできない時間帯がございましたことをお詫び申し上げますとともに、ご協力に感謝いたします。</p>
                    <p>今後とも、より快適で安定した参拝環境の構築に努めてまいります。</p>
                </div>
            `
        }, 
        {
            id: 18,
            title: "【更新】おみくじの轍におけるページ機能追加と、件数表示の不具合修正について",
            date: "2026/1/14",
            time: "10:00",
            tag: "機能追加・修正",
            tagColor: "text-blue-600",
            borderColor: "border-blue-500",
            desc: "履歴（轍）の表示パフォーマンス向上のための改修と、検索結果数の表示バグを修正しました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>昨夜（1月13日）から本日未明にかけて、以下の機能追加および不具合修正を行いました。</p>
                    
                    <h3>1. 「おみくじの轍」へのページ送り機能追加</h3>
                    <p><strong>対応日時：2026年1月13日 20:00頃</strong><br>
                    これまで「おみくじの轍（履歴）」は全件を一度に表示しておりましたが、データ件数の増加に伴い読み込みやスクロールが重くなる懸念がございました。<br>
                    そのため、1ページあたり100件ごとに分割して表示する「ページ送り（ページネーション）」機能を追加いたしました。</p>

                    <h3>2. 検索結果件数の表示不具合修正</h3>
                    <p><strong>対応日時：2026年1月13日 22:00頃</strong><br>
                    上記機能追加に伴い、履歴検索を行った際の「ヒット件数」の表示に誤りが発生しておりました。</p>
                    <p><strong>【不具合の内容】</strong><br>
                    本来であれば「条件に一致した全件数（例：500件）」を表示すべきところ、誤って「現在表示しているページの件数（例：1ページ目なら100件、最終ページなら50件など）」が表示されておりました。</p>
                    <p>現在は修正が完了しており、ページを切り替えても常に「検索条件に一致した正しい総件数」が表示されるようになっております。</p>

                    <p>ご利用の皆様にはご迷惑をおかけしましたことをお詫び申し上げます。今後ともより使いやすい杜を目指して改良を続けてまいります。</p>
                </div>
            `
        },
        {
            id: 17,
            title: "【修正】ダークモード時における「半凶」グラフの表示色を調整いたしました",
            date: "2026/1/13",
            time: "16:15",
            tag: "デザイン修正",
            tagColor: "text-gray-600",
            borderColor: "border-gray-500",
            desc: "おみくじの轍（統計）において、背景色と同化して見えなくなっていた箇所を修正しました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日、以下の表示不具合を修正いたしました。</p>
                    
                    <h3>修正内容</h3>
                    <p>ダークモード（宵闇の刻、または端末設定）にて「おみくじの轍」の統計グラフをご覧いただいた際、<strong>「半凶」のバーの色が背景のレール色（グレー）と同化し、視認できなくなっている問題</strong>を解消いたしました。</p>
                    <p>具体的には、「半凶」のバーの色をダークモード時のみ「明るめのグレー」に変更し、背景とのコントラストを確保いたしました。これにより、すべての運勢の割合を正しくご確認いただけます。</p>
                    <p>ご不便をおかけいたしましたことをお詫び申し上げます。</p>
                </div>
            `
        },
        {
            id: 16,
            title: "【改善】スマートフォンでの「おみくじ結果」の表示崩れを修正いたしました",
            date: "2026/1/6",
            time: "17:30",
            tag: "機能改善",
            tagColor: "text-teal-600",
            borderColor: "border-teal-500",
            desc: "結果カードの一部が画面外に見切れてしまう問題を解消し、横スクロールで全文を閲覧できるようにいたしました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日、スマートフォンなどの画面幅が狭い端末において、おみくじの結果カード（御神籤）の左右が画面外にはみ出し、文章の一部が途切れて読めなくなる表示上の問題を修正いたしました。</p>
                    
                    <h3>修正内容：横スクロール（スワイプ）への対応</h3>
                    <p>これまでは、はみ出した部分がシステム的に隠されてしまっており、全文を読むためには一度「画像を保存」していただく必要がございました。</p>
                    <p>本日の更新により、画面からはみ出している部分を<strong>指で左右にスワイプ（横スクロール）</strong>することで、そのままブラウザ上で閲覧できるように改善いたしました。</p>
                    <p>これにより、まるで巻物を広げるような感覚で、端に書かれた吉凶や詳細な運勢までスムーズにご確認いただけます。今後も使い心地の向上に努めてまいります。</p>
                </div>
            `
        },
        {
            id: 14,
            title: "【重要】12星座占いの未来予報（カレンダー）における実装不備と、過去の誤表示に関する深いお詫び",
            date: "2026/1/6",
            time: "15:30",
            tag: "障害報告",
            tagColor: "text-red-600",
            borderColor: "border-red-600",
            desc: "「向こう30日間のラッキーデー」の表示内容が、実際の判定ロジックに基づかない「でたらめ」な状態であったことを深くお詫び申し上げます。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日、「12星座×血液型占い」コーナーにおける「向こう30日間のラッキーデー（カレンダー機能）」につきまして、表示内容の根幹に関わる重大な不備を修正し、システムを完全刷新いたしました。</p>
                    
                    <h3>不具合の発覚経緯と、カレンダー機能が「でたらめ」であった事実</h3>
                    <p>当サイトは利用規約およびプライバシーポリシーに明記しております通り、お問い合わせ窓口やサポート体制を一切設けておりません。そのため、今回の件はユーザーの皆様からご指摘をいただいたわけではなく、私自身がサイトの動作確認を行っていた際に、表示の矛盾に気付き発覚したものです。</p>
                    <p>具体的には、<strong>「今日のランキングでは総合1位（Sランク）と判定されているにもかかわらず、カレンダーの今日の日付欄には星マーク（ラッキーデーの印）が付いていない」</strong>という致命的な不整合を確認いたしました。</p>
                    <p>調査を行いましたところ、日々のランキング（今日の運勢順位）につきましては、日付と星座に基づき正常に計算されておりましたが、その下にあるカレンダー機能に関しては、本来行うべき「未来の運勢計算」を一切行わず、ランダムな箇所に適当なアイコンを表示するだけの、いわば<strong>「でたらめ」</strong>なプログラムが動作していたことが判明いたしました。</p>
                    <p>皆様が「この日は運が良いかもしれない」とカレンダーを見て予定を立てられたり、期待を寄せられたりしたお気持ちを、このような「見せかけだけの実装」で裏切っておりましたこと、弁解の余地もございません。実際の運勢とは無関係な、適当な記号を表示させていたことを深く猛省し、心よりお詫び申し上げます。</p>

                    <h3>修正内容：全パターンの完全シミュレーション化</h3>
                    <p>今回の更新において、旧来のカレンダー生成プログラムを即刻廃棄し、ゼロからロジックを作り直しました。</p>
                    <p>新しいシステムでは、カレンダーを表示するたびに、サーバー内部で<strong>「未来30日分」×「全48通り（12星座×4血液型）」＝計1,440回分の運勢計算</strong>を、手加減なしですべて実行しております。</p>
                    <p>これにより、「その日が本当に全48通りの中で1位（または各項目の1位）であるかどうか」を厳密にシミュレーション判定することが可能となりました。今後は、「ランキングで1位なら、カレンダーにも必ず星が付く」という当たり前の整合性が完全に保たれます。処理負荷は増大しましたが、これが本来あるべき正しい姿です。</p>

                    <h3>運勢テキストの大幅な加筆と改良</h3>
                    <p>また、今回の反省を込めまして、運勢結果の文章につきましても大幅な改良を行いました。</p>
                    <p>これまでは、恋愛・金運・仕事運の記述が連続しており、どこからどこまでがどの運勢の説明なのかが判然としない構成でした。今回より、各パラグラフの冒頭に<strong>【恋愛運：第〇位】</strong>といった明確な見出しを付け、さらにそれぞれの運勢について、「なぜその順位なのか」「具体的にどう行動すれば良いのか」を詳細に記述するよう、文章量を大幅に増量いたしました。</p>
                    
                    <p>今後は二度とこのような不誠実な実装を行わず、データの真正性にこだわって運営していくことをここに誓います。この度は、皆様の信頼を損なう事態を招き、本当に申し訳ございませんでした。</p>
                </div>
            `
        },
        {
            id: 15,
            title: "【復旧】深夜から早朝にかけて発生した表示不具合およびログイン表示エラーに関するお詫びとご報告",
            date: "2026/1/6",
            time: "08:30",
            tag: "障害報告",
            tagColor: "text-red-600",
            borderColor: "border-red-600",
            desc: "サイドメニュー操作時の画面消失、および各種数値が表示されない不具合が発生しておりました。現在は復旧しております。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>以下の日時にて、サイトが正常に閲覧できない、およびログイン状態が正しく反映されない重大な不具合が発生しておりました。現在は修正対応が完了し、正常に稼働しております。</p>
                    
                    <h3 class="text-red-600">発生日時（日本時間）</h3>
                    <p class="font-bold">2026年1月5日 23:35頃 〜 2026年1月6日 08:27頃</p>

                    <h3>発生していた不具合の内容</h3>
                    <ul class="list-disc ml-5 mb-4">
                        <li><strong>画面遷移の不具合：</strong><br>サイトに最初にアクセスした際はホーム画面が表示されますが、サイドバー（左側のメニュー）のボタンを押すと、コンテンツエリアが空白になり何も表示されなくなる現象が発生していました。（薄い十字架の背景模様とサイドバーのみが表示され、中身が消えてしまう状態でした）</li>
                        <li><strong>ログイン表示の不整合：</strong><br>実際にはログイン済みであるにもかかわらず、サイドバーのアイコンやテキストが「未ログイン状態（ログイン/登録）」のままになっておりました。</li>
                        <li><strong>数値データの消失：</strong><br>ホーム画面の「累計発行本数」が「---」のまま読み込まれず、また「おみくじの轍（統計グラフ）」もすべて「0本 / 0.00%」と表示されておりました。</li>
                    </ul>

                    <h3>原因：隠し機能追加によるコード競合</h3>
                    <p>今回の障害の原因は、私がサイトに「遊び心」を加えようとして実装を試みた、以下の2つの隠し機能（イースターエッグ）のコードにありました。</p>
                    <ul class="list-disc ml-5 mb-4">
                        <li>タイトルロゴを7回連続クリックすると、隠しメッセージが表示される機能</li>
                        <li>サイドバーのLabsアイコン（フラスコ）を5回連続クリックすると、実験機能が一時的にアンロックされる機能</li>
                    </ul>
                    <p>昨夜23:35頃、これらの機能を追加した直後から、クリックイベントの監視処理がサイト全体の描画システムと競合を起こし、ページ遷移やデータ取得のプロセスを阻害し始めました。</p>

                    <h3>復旧までの経緯</h3>
                    <p>不具合発覚直後より、原因の特定と修正作業を開始いたしました。修正を試みてはデプロイを繰り返しましたが、複雑に絡み合ったエラーは容易には解消されませんでした。</p>
                    <p>深夜、解決の糸口が見えないまま時間だけが過ぎ、焦りは募るばかりでした。「このまま徹夜してでも修正を完了させるべきではないか」という葛藤もありましたが、疲労による判断力の低下がさらなる重大なミス（二次被害）を招くリスクを考慮し、断腸の思いで一時作業を中断し、休息を取るという苦渋の決断をいたしました。不具合が残ったままの状態でサイトを放置することとなり、夜間に利用された皆様には多大なるご不便をおかけしましたことを深くお詫び申し上げます。</p>
                    <p>その後、早朝より作業を再開し、冷静にコードを見直した結果、「この隠し機能のコードが存在する限り、根本的な解決は困難である」という結論に至りました。そのため、追加しようとしていた隠し機能をすべて削除し、コードを元の安定した状態に戻すことで、本日8:27に完全な復旧を確認いたしました。</p>
                    
                    <p>本当はこの機能があっても、私の技術力が及んでいれば、コードを適切に修正して共存させることができたのかもしれません。遊び心と安定性を両立できなかったことは、開発者として悔しい限りです。しかし、今の私にとっては、自身のこだわりを貫くことよりも、サイトを確実に動く状態に戻し、皆様に快適な参拝環境をお返しすることを最優先すべきだと判断いたしました。</p>
                    <p>今後は、より慎重に開発を進めてまいります。重ねてになりますが、長時間にわたりご迷惑をおかけしましたことをお詫び申し上げます。</p>
                </div>
            `
        },
        {
            id: 13,
            title: "【復活】「全国・土地の運気予報」をテキスト版として再実装いたしました",
            date: "2026/1/5",
            time: "22:28",
            tag: "新機能",
            tagColor: "text-red-600",
            borderColor: "border-red-600",
            desc: "開発中止をお伝えした土地の運気機能ですが、地図を使わない「ランキング形式」として復活させました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。個人開発者のnden148です。</p>
                    <p>先ほど、技術的な課題（外部地図機能によるエラー多発）により「全国・土地の運気予報」の開発中止をお知らせいたしました。</p>
                    <p>しかし、あのお知らせを出した後も、「技術的に地図が無理だからといって、機能そのものを諦めて良いのか？」「皆様に日々の土地のエネルギーをお伝えしたいという当初の思いはどうなるのか？」と、一人パソコンの前で自問自答を繰り返しておりました。</p>
                    <p>企業が運営するサービスであれば、リスクを避けて「中止」で終わるのが正解かもしれません。しかし、ここは私が個人で情熱を注いでいる「天命乃杜」です。<strong>「地図がダメなら、文字で伝えればいい」</strong>という結論に至りました。</p>
                    
                    <h3>新機能：都道府県別・運気ランキング</h3>
                    <p>エラーの原因となっていた地図描画を廃止し、代わりに<strong>「47都道府県の運気スコアランキング」</strong>として機能を新生させました。</p>
                    <ul class="list-disc ml-5 mb-4">
                        <li><strong>全47都道府県を網羅：</strong> 北海道から沖縄まで、一切の省略なく全ての土地の運気を計算します。</li>
                        <li><strong>日替わりスコア（100点満点）：</strong> その日の星回りと土地の相性を数値化しました。</li>
                        <li><strong>詳細な運勢テキスト：</strong> 点数に応じて、その土地で過ごす際のアドバイスや心構えを長文で記しています。</li>
                    </ul>
                    <p>見た目の派手さは地図に劣るかもしれませんが、情報の「質」とシステムの「安定性」は格段に向上しております。私の悩みと執念の結果生まれたこの機能を、ぜひサイドメニューの「全国の運気」からお試しください。</p>
                </div>
            `
        },
        {
            id: 12,
            title: "【機能追加】過去記事の検索およびページ送り機能の実装",
            date: "2026/1/5",
            time: "21:45",
            tag: "機能追加",
            tagColor: "text-teal-600",
            borderColor: "border-teal-500",
            desc: "「社務所だより」と「神籤草子」に、キーワード検索機能とページ切り替え機能を追加しました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>この度、記事数が増加しても快適に閲覧いただけるよう、「社務所だより」および「神籤草子（コラム）」の一覧画面において、以下の機能追加を行いました。</p>
                    
                    <h3>1. キーワード検索機能</h3>
                    <p>一覧画面の上部に検索ボックスを設置いたしました。「作法」「待ち人」などのキーワードを入力することで、過去の記事やコラムの中から目的の内容を瞬時に探し出すことが可能です。</p>
                    
                    <h3>2. ページ送り機能（ページネーション）</h3>
                    <p>これまでは全記事を縦に長く表示しておりましたが、読みやすさを考慮し、一定件数ごとにページを分割いたしました。</p>
                    <ul class="list-disc ml-5 mb-4">
                        <li><strong>社務所だより：</strong> 1ページにつき5件表示</li>
                        <li><strong>神籤草子：</strong> 1ページにつき6件表示</li>
                    </ul>
                    <p>画面下部の「前へ」「次へ」ボタン、およびページ番号にて快適に読み進めていただけます。</p>
                    <p>今後とも参拝者の皆様にとって心地よい場所となりますよう、サイトの改良を重ねてまいります。</p>
                </div>
            `
        },
        {
            id: 11,
            title: "【システム】サーバー負荷軽減対策と理論値データ公開（修正版）",
            date: "2026/1/5",
            time: "17:44",
            tag: "システム",
            tagColor: "text-gray-600",
            borderColor: "border-gray-800",
            desc: "Cloudflare Workers KVの更新間隔調整によるデータベース負荷の改善結果（実測値）を公開しました。",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p>
                    <p>本日、安定したサービス提供継続のため、サイトの自動更新システム（累計発行本数やおみくじの轍の更新間隔）の調整を行いました。</p>
                    
                    <h3>Cloudflare Workers KVの制限について</h3>
                    <p>当サイトのデータベースには<strong>「Cloudflare Workers KV」</strong>という技術を使用しております。このシステムには無料プランにおける利用制限があり、データの読み取り（Read）は<strong>「1日あたり10万回まで」</strong>と定められています。</p>
                    <p>この制限を超過するとサイトが閲覧できなくなる恐れがあるため、バックグラウンドでの通信頻度を見直しました。</p>

                    <h3>検証条件</h3>
                    <p>当サイトを<strong>「1つのタブで開き、バックグラウンド（他のアプリやサイトを見ている状態）で放置した際」</strong>のKV読み取り回数を計測・比較しました。</p>
                    <p>※おみくじを引くなどの操作を行うと、これに加えて都度書き込み（Write）や読み取りが発生します。</p>

                    <h3>負荷削減の成果（KV読取数比較）</h3>
                    <p>更新間隔を「5秒」から「1分」に変更した結果、アイドリング時のKVへの負荷が<strong>約10分の1</strong>に激減しました。</p>

                    <div class="overflow-x-auto mb-8">
                        <table class="comparison-table" style="min-width: 100%; font-size: 0.7rem;">
                            <thead class="bg-gray-100 dark:bg-zinc-700 font-bold">
                                <tr>
                                    <th class="p-2 border border-gray-300" rowspan="2">利用<br>時間</th>
                                    <th class="p-2 border border-gray-300 text-red-700 dark:text-red-300 bg-red-50 dark:bg-red-900/10" colspan="3">修正前 (2.0回/秒)</th>
                                    <th class="p-2 border border-gray-300 text-blue-700 dark:text-blue-300 bg-blue-50 dark:bg-blue-900/10" colspan="3">修正後 (0.217回/秒)</th>
                                </tr>
                                <tr>
                                    <th class="p-2 border border-gray-300 text-xs">消費数</th>
                                    <th class="p-2 border border-gray-300 text-xs">許容人数/日</th>
                                    <th class="p-2 border border-gray-300 text-xs">安全性</th>
                                    <th class="p-2 border border-gray-300 text-xs">消費数</th>
                                    <th class="p-2 border border-gray-300 text-xs">許容人数/日</th>
                                    <th class="p-2 border border-gray-300 text-xs">安全性</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="p-2 border border-gray-300 font-bold">1分間</td>
                                    <td class="p-2 border border-gray-300 font-mono">120回</td>
                                    <td class="p-2 border border-gray-300 font-mono font-bold">833人</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-black text-lg">
                                        <i class="bi bi-shield-check"></i> 安全
                                    </td>
                                    <td class="p-2 border border-gray-300 font-mono">約 13回</td>
                                    <td class="p-2 border border-gray-300 font-mono font-bold text-green-600">7,680人</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-black text-xl">
                                        <i class="bi bi-shield-fill-check"></i> 安全
                                    </td>
                                </tr>
                                <tr class="bg-gray-50 dark:bg-zinc-800">
                                    <td class="p-2 border border-gray-300 font-bold">10分間</td>
                                    <td class="p-2 border border-gray-300 font-mono">1,200回</td>
                                    <td class="p-2 border border-gray-300 font-mono font-bold">83人</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-black text-lg">
                                        <i class="bi bi-shield-check"></i> 安全
                                    </td>
                                    <td class="p-2 border border-gray-300 font-mono">約 130回</td>
                                    <td class="p-2 border border-gray-300 font-mono font-bold text-green-600">768人</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-black text-xl">
                                        <i class="bi bi-shield-fill-check"></i> 安全
                                    </td>
                                </tr>
                                <tr>
                                    <td class="p-2 border border-gray-300 font-bold">1時間</td>
                                    <td class="p-2 border border-gray-300 font-mono">7,200回</td>
                                    <td class="p-2 border border-gray-300 font-mono font-bold text-red-600">13人</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-black text-lg">
                                        <i class="bi bi-shield-check"></i> 安全
                                    </td>
                                    <td class="p-2 border border-gray-300 font-mono">約 781回</td>
                                    <td class="p-2 border border-gray-300 font-mono font-bold text-blue-600">128人</td>
                                    <td class="p-2 border border-gray-300 text-green-600 font-black text-xl">
                                        <i class="bi bi-shield-fill-check"></i> 安全
                                    </td>
                                </tr>
                                <tr class="bg-red-50 dark:bg-red-900/10">
                                    <td class="p-2 border border-gray-300 font-bold">24時間</td>
                                    <td class="p-2 border border-gray-300 font-mono text-red-600 font-bold">
                                        172,800回
                                    </td>
                                    <td class="p-2 border border-gray-300 font-mono font-black text-red-600 text-lg">
                                        0人
                                    </td>
                                    <td class="p-2 border border-gray-300 text-red-600 font-black text-xl">
                                        <i class="bi bi-x-octagon-fill"></i> 危険
                                    </td>
                                    <td class="p-2 border border-gray-300 font-mono text-blue-600 font-bold">
                                        約 18,749回
                                    </td>
                                    <td class="p-2 border border-gray-300 font-mono font-bold text-blue-600">
                                        5人
                                    </td>
                                    <td class="p-2 border border-gray-300 text-blue-600 font-black text-xl">
                                        <i class="bi bi-shield-lock-fill"></i> 余裕
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h3>解説</h3>
                    <p>修正前の設定（5秒更新）では、たったお一人が24時間ページを開きっぱなしにするだけで、Cloudflare Workers KVの無料枠（10万回）をすべて使い切ってしまう危険な状態でした。</p>
                    <p>今回の修正（1分更新）により、KVへの平均アクセス頻度が<strong>0.217回/秒</strong>まで低下しました。これにより、24時間開きっぱなしにしても消費量は枠の約19%に収まり、より多くの参拝者様に快適にご利用いただける設計となりました。</p>
                </div>
            `
        },
        {
            id: 9,
            title: "【修正】TENMEI Labs機能の挙動改善について",
            date: "2026/1/5",
            time: "16:05",
            tag: "機能改善",
            tagColor: "text-green-600",
            borderColor: "border-green-500",
            desc: "「宵闇の刻」および「言霊の増幅」に関する表示不具合を修正しました。",
            content: `<p>TENMEI Labs（実験室）で提供している機能について、以下の修正を行いました。</p><h3>1. 「宵闇の刻」の挙動統一</h3><p>これまで、端末（OS）の設定がダークモードの場合、サイトの一部配色が正しく切り替わらない（完全なダークモードにならない）問題が発生しておりました。</p><p>本日の更新により、OS設定でダークモードをご利用の場合でも、Labs機能「宵闇の刻」をONにした際と同様の、正しい配色（完全なダークテーマ）が適用されるよう修正・統一いたしました。</p><h3>2. 「言霊の増幅」の適用範囲拡大</h3><p>文字サイズを大きくする「言霊の増幅」モードにおいて、一部のテキストやカードのサイズが拡大されていなかった問題を修正しました。これにより、より広範囲で視認性が向上しております。</p>`
        },
        {
            id: 8,
            title: "【重要】「全国・土地の運気予報」の開発中止に関するお知らせ",
            date: "2026/1/5",
            time: "14:30",
            tag: "重要",
            tagColor: "text-red-600",
            borderColor: "border-gray-800",
            desc: "技術的な不具合により、マップ機能の開発を完全に中止いたしました。代替案もございません。",
            content: `<p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p><p>以前より「TENMEI Labs」の追加機能として検討しておりました「全国・土地の運気予報（マップ機能）」につきまして、検討の結果、開発を完全に中止することといたしました。なお、本機能につきましては別の形での実装や代替機能の提供予定もございません。</p><h3>中止の理由</h3><p>外部地図ライブラリの導入に伴うシステムの深刻な不安定化、およびプログラム上の修復困難なエラーが複数確認されました。無理な実装を強行することは、現在安定して稼働している他の機能（おみくじやLabs等）の動作を損なう致命的なリスクがあると判断いたしました。</p><h3>今後の展望</h3><p>期待をお寄せいただいた皆様には誠に申し訳ございませんが、今後は新たな地図機能の模索は行わず、既存機能の保守と品質向上にのみ注力してまいります。何卒ご理解を賜りますようお願い申し上げます。</p>`
        },
        {
            id: 10,
            title: "【更新】TENMEI LabsのUIを大幅に変更いたしました",
            date: "2026/1/5",
            time: "12:55",
            tag: "デザイン",
            tagColor: "text-indigo-600",
            borderColor: "border-indigo-500",
            desc: "実験室（Labs）の画面デザインを、より現代的で没入感のある形式に刷新しました。",
            content: `<p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p><p>会員限定機能「TENMEI Labs（天命ラボ）」のユーザーインターフェース（UI）を大幅にリニューアルいたしました。</p><h3>視覚的な没入感の向上</h3><p>従来のシンプルなリスト形式から、背景に流体アニメーション（オーロラエフェクト）を取り入れたモダンなカード型デザインへと変更いたしました。また、シンボルである「フラスコ」のアニメーションも、液体の揺らぎや波紋をよりリアルに表現したものに一新しております。</p><p>機能のON/OFFスイッチもより直感的に操作できるよう改善いたしました。新しくなった実験室の雰囲気を、ぜひお楽しみください。</p>`
        },
        {
            id: 7,
            title: "【重要】認証システムに関する不具合の修正とお詫び",
            date: "2026/1/4",
            time: "08:00",
            tag: "障害報告",
            tagColor: "text-red-600",
            borderColor: "border-red-500",
            desc: "ログインおよびアカウント管理に関する重大な不具合を修正いたしました。",
            content: `<p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。2026年1月3日頃より発生しておりました、ログイン認証システムに関する重大な不具合について、修正が完了いたしましたことをご報告申し上げます。</p><h3>修正された不具合の内容</h3><p>1. ログイン時、パスワードが一致しない状態でも認証コードが送信される問題<br>2. パスワード不一致のまま認証を完了させると、意図せずアカウントが削除される問題<br>3. 未登録のメールアドレスに対しても、ログイン認証コードが送信される問題</p><h3>原因と経緯</h3><p>本不具合は、昨日（1月3日）のシステム更新の際、運営者によるコード編集上の不注意（人為的ミス）により発生いたしました。セキュリティに関わる重要な機能において、ユーザーの皆様にご不安とご不便をおかけしましたこと、深くお詫び申し上げます。現在はバリデーションロジックを全面的に見直し、正常な挙動に復旧しております。今後、再発防止に向けてコード管理の徹底に努めてまいります。</p>`
        },
        {
            id: 6,
            title: "新機能「TENMEI Labs」を公開いたしました。",
            date: "2026/1/3",
            time: "17:01",
            tag: "お知らせ",
            tagColor: "text-purple-600",
            borderColor: "border-purple-500",
            desc: "実験的な新機能を体験できるLabsページを会員様限定で追加しました。",
            content: `<p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。</p><p>この度、当サイトの実験的な試みとして、新機能<strong>「TENMEI Labs（天命ラボ）」</strong>を公開いたしました。</p><p>Labsでは、開発中の新機能や、サイトの雰囲気を大きく変える特殊なカスタマイズ設定をいち早く体験いただくことが可能です。現在は「迎春・雅モード」や「神速の祈り」など、複数の実験的な機能を公開しております。</p><p>本機能は、会員登録（ログイン）を行っていただくことでご利用いただけます。サイドバーのフラスコアイコンより、ぜひ未知の天命体験をお楽しみください。</p><p>今後も「杜」の技術革新に努めてまいります。何卒よろしくお願い申し上げます。</p>`
        },
        {
            id: 2,
            title: "「運勢・天命乃杜」を公開いたしました。",
            date: "2026/1/2",
            time: "16:00",
            tag: "お知らせ",
            tagColor: "text-blue-600",
            borderColor: "border-blue-500",
            desc: "本サービスを正式にリリースいたしました。",
            content: `<p>平素より格別のご高配を賜り、厚く御礼申し上げます。</p><p>この度、誰でも気軽に、かつ本格的な運勢占いを楽しめるWebサイト「運勢・天命乃杜（てんめいのもり）」を正式に公開いたしました。</p><p>当サイトでは、伝統的なおみくじの要素に加え、西洋占星術と血液型診断を組み合わせた独自のアルゴリズムによる「日替わり運勢ランキング」を提供しております。また、会員登録（無料）を行っていただくことで、ご自身の運勢履歴を保存したり、全体の統計データに参加したりすることが可能です。今後もコンテンツの拡充や機能改善に努めてまいりますので、末永くご愛顧いただけますようお願い申し上げます。</p>`
        },
        {
            id: 1,
            title: "あけましておめでとうごさいます",
            date: "2026/1/1",
            time: "00:00",
            tag: "ご挨拶",
            tagColor: "text-gray-600",
            borderColor: "border-gray-500",
            desc: "謹んで新年のご祝詞を申し上げます。",
            content: `<p>謹んで新年のご祝詞を申し上げます。</p><p>旧年中はひとかたならぬご厚情を賜り、誠にありがとうございました。<br>本年も皆様に幸多き年となりますよう、天命乃杜運営一同、心よりお祈り申し上げます。</p><p>新しい年が始まり、皆様それぞれに新たな目標や願いをお持ちのことと存じます。当サイトのおみくじが、皆様の迷いを晴らし、一歩を踏み出すための道標となれば幸いです。本年も変わらぬご愛顧のほど、よろしくお願い申し上げます。</p>`
        },
        {
            id: 3,
            title: "プレオープンのお知らせ",
            date: "2025/12/25",
            time: "10:00",
            tag: "お知らせ",
            tagColor: "text-gray-600",
            borderColor: "border-gray-400",
            desc: "一部機能を先行公開いたしました。",
            content: `<p>本日より、一部機能を制限した状態でのプレオープンを開始いたしました。</p><p>現在ご利用いただけるのは、「おみくじ機能」および「12星座占い（β版）」です。正式リリース時には、履歴保存機能や会員システムが追加される予定です。</p>`
        },
        {
            id: 4,
            title: "サーバーメンテナンス完了",
            date: "2025/12/20",
            time: "18:00",
            tag: "メンテナンス",
            tagColor: "text-green-600",
            borderColor: "border-green-500",
            desc: "予定されていたメンテナンスは無事終了しました。",
            content: `<p>本日14:00より実施しておりましたサーバーメンテナンスは、予定通り18:00に完了いたしました。</p><p>今回のメンテナンスにより、データベースの応答速度が向上しております。ご協力ありがとうございました。</p>`
        },
        {
            id: 5,
            title: "サイト開設準備室より",
            date: "2025/12/10",
            time: "12:00",
            tag: "お知らせ",
            tagColor: "text-gray-600",
            borderColor: "border-gray-400",
            desc: "現在、正式公開に向けて最終調整を行っております。",
            content: `<p>「運勢・天命乃杜」の開設に向け、現在鋭意開発中です。</p><p>皆様に愛されるサイトを目指し、デザインの調整や占いロジックの検証を行っております。公開まで今しばらくお待ちください。</p>`
        }
    ];

    // ■ 神籤草子（コラム）データ
    const columnData = [

        

        {
            id: 27,
            title: "【特別クイズ】神社検定・超難問10番勝負（5択・改）",
            date: "2026/01/25",
            category: "特別クイズ",
            icon: "bi-trophy-fill",
            colorClass: "yellow",
            content: `
                <div class="article-content">
                    <p>大規模アップデート記念！今回は難易度を大幅に上げ、選択肢を「5択」に増やした特別検定を実施します。神社の歴史、建築、祭礼…あなたの知識の深さが試されます。全問正解を目指して挑戦してください。</p>
                    
                    ${[
                        {
                            q: "Q1. 日本で最も多い神社の系列（御祭神）はどれ？（約3万社あると言われています）", 
                            a: ["八幡信仰（八幡様）", "伊勢信仰（お伊勢様）", "天神信仰（天神様）", "稲荷信仰（お稲荷様）", "熊野信仰（権現様）"], 
                            c: 0, 
                            exp: "正解は『1. 八幡信仰』です。大分県の宇佐神宮を総本社とする八幡宮が最も多く、次いで伊勢信仰、天神信仰と続きます。（※稲荷信仰も非常に多いですが、屋敷神などの小祠を含めると稲荷が最多という説もありますが、登録社数では八幡が最多とされます）"
                        },
                        {
                            q: "Q2. 20年に一度、社殿を造り替える「式年遷宮」。伊勢神宮で第1回が行われたのは西暦何年？", 
                            a: ["690年（持統天皇）", "710年（元明天皇）", "794年（桓武天皇）", "1192年（後鳥羽天皇）", "1603年（後陽成天皇）"], 
                            c: 0, 
                            exp: "正解は『1. 690年』です。天武天皇が発案し、持統天皇の御代に第1回が行われました。以来、戦国時代の中断を除き1300年にわたり継承されています。"
                        },
                        {
                            q: "Q3. 次のうち、実在しない神社の「社号（格）」はどれ？", 
                            a: ["神宮（じんぐう）", "大社（たいしゃ）", "宮（ぐう）", "大宮（だいぐう）", "殿（でん）"], 
                            c: 3, 
                            exp: "正解は『4. 大宮』です。「神宮（伊勢神宮など）」「大社（出雲大社など）」「宮（天満宮など）」「社（神社）」は存在しますが、「大宮」という社号は一般的に格式としては用いられません（地名や通称としては存在します）。"
                        },
                        {
                            q: "Q4. 神社の屋根の「千木（ちぎ）」と「鰹木（かつおぎ）」。鰹木は主に何を表しているとされる？", 
                            a: ["神様の性別", "神社の格式や地位", "創建された時代", "祀られている神様の数", "特に意味はない"], 
                            c: 1, 
                            exp: "正解は『2. 神社の格式や地位』です。一般的に、鰹木の本数が多いほど格式が高いとされます。奇数が陽（男神）、偶数が陰（女神）を表すとも言われますが、例外も多いです。"
                        },
                        {
                            q: "Q5. 7月に行われる京都・八坂神社の「祇園祭」。元々は何を祈願して始まった？", 
                            a: ["五穀豊穣", "商売繁盛", "疫病退散", "戦勝祈願", "安産祈願"], 
                            c: 2, 
                            exp: "正解は『3. 疫病退散』です。貞観11年（869年）に京の都で疫病が流行した際、牛頭天王（スサノオノミコト）を祀り、病魔を鎮めようとした「御霊会（ごりょうえ）」が起源です。"
                        },
                        {
                            q: "Q6. 「二礼二拍手一礼」が基本ですが、島根県の「出雲大社」と大分県の「宇佐神宮」に共通する特殊な作法は？", 
                            a: ["二礼三拍手一礼", "二礼四拍手一礼", "三礼三拍手一礼", "四礼四拍手一礼", "拍手を打たない"], 
                            c: 1, 
                            exp: "正解は『2. 二礼四拍手一礼』です。両社とも「四拍手（しはくしゅ）」を行うのが正式な作法とされています。四は「死」ではなく「幸せ（四合わせ）」や四季を表すとされます。"
                        },
                        {
                            q: "Q7. 正月三が日に飾る「門松」。これは本来、誰のための目印？", 
                            a: ["年神様（歳神様）", "ご先祖様の霊", "福の神（七福神）", "貧乏神（追い払うため）", "郵便屋さん"], 
                            c: 0, 
                            exp: "正解は『1. 年神様』です。お正月に家にやってくる年神様が、迷わずに降りてくるための依代（よりしろ・目印）として門松を飾ります。"
                        },
                        {
                            q: "Q8. 神社本庁が定める「神棚」へのお供え（神饌）。毎日欠かさず供えるべき「三点セット」に含まれないものは？", 
                            a: ["米（こめ）", "塩（しお）", "水（みず）", "酒（さけ）", "榊（さかき）"], 
                            c: 3, 
                            exp: "正解は『4. 酒』です。基本の三点（日供）は「米・塩・水」です。お酒や榊は、毎月1日・15日やお祭りの日に供えるのが一般的です。（もちろん毎日供えても良いですが、必須とされる基本セットは米塩水です）"
                        },
                        {
                            q: "Q9. 「絵馬」の起源。かつては願い事を叶えるために、何を奉納していた？", 
                            a: ["米俵", "生きた馬（神馬）", "自分の髪の毛", "金塊", "武具（刀や弓）"], 
                            c: 1, 
                            exp: "正解は『2. 生きた馬』です。馬は神様の乗り物とされており、雨乞いや止雨の祈願に生きた馬を奉納していました。それが高価で大変なため、次第に木や紙の馬になり、現在の絵馬へと変化しました。"
                        },
                        {
                            q: "Q10. おみくじの創始者とされる「元三大師（良源）」。彼が鬼の姿になって疫病を追い払った姿を描いたお札を何という？", 
                            a: ["角大師（つのだいし）", "鬼大師（おにだいし）", "豆大師（まめだいし）", "降魔大師（ごうまだいし）", "厄除大師（やくよけだいし）"], 
                            c: 0, 
                            exp: "正解は『1. 角大師』です。骨と皮ばかりの鬼の姿（角が生えた姿）になり、疫病神を恐れさせて追い払ったという伝説から、魔除けのお札として玄関に貼る風習があります。"
                        }
                    ].map((item, i) => `
                        <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-yellow-200 dark:border-yellow-900">
                            <span class="inline-block bg-yellow-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第${i+1}問</span>
                            <h3 class="font-bold text-lg mb-4 text-yellow-800 dark:text-yellow-200">${item.q}</h3>
                            <div class="space-y-3">
                                ${item.a.map((ans, idx) => `
                                    <button onclick="handleQuiz(this, ${idx === item.c}, ${item.c})" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold text-sm">
                                        ${idx + 1}. ${ans}
                                    </button>
                                `).join('')}
                            </div>
                            <div class="hidden mt-6 pt-4 border-t border-gray-300">
                                <div class="quiz-msg text-xl font-black mb-2"></div>
                                <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                    <span class="font-bold text-yellow-600">解説：</span><br>${item.exp}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `
        },
        {
            id: 26,
            title: "【クイズ】この動物は神使？それともただの動物？（5択クイズ）",
            date: "2026/01/25",
            category: "クイズ",
            icon: "bi-question-diamond-fill",
            colorClass: "indigo",
            content: `
                <div class="article-content">
                    <p>神社には「神使（しんし）」と呼ばれる神様の使いの動物がいます。稲荷の狐などが有名ですが、中には「これは神使ではない」という動物も…。正しい知識を5択で問いかけます。</p>
                    
                    <!-- 第1問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第1問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q1. 奈良の春日大社などで有名な、神様の使いとされる動物は？</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, false, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">1. 猿（サル）</button>
                            <button onclick="handleQuiz(this, false, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">2. 兎（ウサギ）</button>
                            <button onclick="handleQuiz(this, true, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">3. 鹿（シカ）</button>
                            <button onclick="handleQuiz(this, false, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">4. 鳩（ハト）</button>
                            <button onclick="handleQuiz(this, false, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">5. 烏（カラス）</button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「3. 鹿」</strong>です。茨城県の鹿島神宮から神様（タケミカヅチノミコト）が白い鹿に乗って春日の地へやってきたという伝説から、春日大社では鹿を神使として大切に保護しています。
                            </div>
                        </div>
                    </div>

                    <!-- 第2問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第2問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q2. 次のうち、一般的に「神使」として祀られることが極めて珍しい（ほぼ無い）動物は？</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, false, 4)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">1. 鼠（ネズミ）- 大黒天</button>
                            <button onclick="handleQuiz(this, false, 4)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">2. 猪（イノシシ）- 護王神社</button>
                            <button onclick="handleQuiz(this, false, 4)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">3. 鰻（ウナギ）- 三島大社</button>
                            <button onclick="handleQuiz(this, false, 4)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">4. 蜂（ハチ）- 二子山神社</button>
                            <button onclick="handleQuiz(this, true, 4)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">5. 猫（ネコ）</button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「5. 猫」</strong>です。狐、蛇、狼、さらにはムカデや鰻までもが神使とされる中で、「猫」を神使とする神社は極めて稀です（猫神様として祀る場所はありますが、特定の神様の使いとされるケースは少ないです）。これは猫が日本に定着したのが比較的新しいためとも言われています。
                            </div>
                        </div>
                    </div>
                </div>
            `
        },
        {
            id: 25,
            title: "【季節】なぜ節分に豆を撒くのか？「魔を滅する」言霊の力",
            date: "2026/01/25",
            category: "年中行事",
            icon: "bi-calendar-check",
            colorClass: "red",
            content: `
                <div class="article-content">
                    <p>もうすぐ2月3日、節分（せつぶん）です。「鬼は外、福は内」と言いながら豆を撒くこの行事、なぜ「大豆」でなければならないのか、その理由をご存知でしょうか。</p>
                    
                    <h3>「魔」を「滅」する＝マメ</h3>
                    <p>日本語には古くから「言霊（ことだま）」の信仰があります。<br>
                    <strong>「豆（まめ）」</strong>という音は、<strong>「魔（ま）」を「滅（め）っする」</strong>に通じます。つまり、豆を鬼（邪気）にぶつけることは、魔を滅ぼす行為そのものなのです。また、「魔の目（まめ）」を射るという意味も込められています。</p>

                    <h3>炒った豆でなければならない理由</h3>
                    <p>節分で使う豆は、必ず火を通した「炒り豆（いりまめ）」でなければなりません。生の豆を使って、もし拾い忘れた豆から「芽」が出てしまったら…？<br>
                    「邪気が芽を出す」ことになり、非常に縁起が悪いとされているからです。必ず「火で炒って（魔を射って）」、二度と悪さができないように封じ込めた豆を使うのが鉄則です。</p>

                    <h3>2026年の恵方は？</h3>
                    <p>豆まきの後は恵方巻きです。2026年（丙午）の恵方は<strong>「南南東」</strong>です。<br>
                    この方角には、その年の福徳を司る「歳徳神（としとくじん）」がいらっしゃいます。無言で願い事を思い浮かべながら、一気に幸運を体に取り込みましょう。</p>
                </div>
            `
        },
        {
            id: 24,
            title: "【クイズ】意外と知らない？「狛犬」と「参道」の秘密",
            date: "2026/01/16",
            category: "クイズ",
            icon: "bi-question-diamond-fill",
            colorClass: "indigo",
            content: `
                <div class="article-content">
                    <p>神社の風景に溶け込んでいる「あれ」や「これ」。実は深い意味があることをご存知ですか？今回は配置や動作に関するクイズです。</p>
                    
                    <!-- 第1問：正解は「1番目」 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第1問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q1. 神社の入り口にいる「狛犬（こまいぬ）」。一般的に「口を開けている（阿形）」のは、向かって左右どちら？</h3>
                        
                        <div class="space-y-3">
                            <!-- 正解：1番目 (index 0) -->
                            <button onclick="handleQuiz(this, true, 0)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 向かって「右」
                            </button>
                            <!-- 不正解 -->
                            <button onclick="handleQuiz(this, false, 0)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 向かって「左」
                            </button>
                            <!-- 不正解 -->
                            <button onclick="handleQuiz(this, false, 0)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. 決まっていない（ランダム）
                            </button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「1. 向かって右」</strong>です。<br>
                                一般的に、向かって右側が口を開けた「阿形（あぎょう）」、左側が口を閉じた「吽形（うんぎょう）」です。これは日本仏教の仁王像などの影響を受けた配置とされ、「阿（始まり）」から「吽（終わり）」まで、つまり「万物」や「魔除け」を意味します。
                            </div>
                        </div>
                    </div>

                    <!-- 第2問：正解は「3番目」 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第2問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q2. 鳥居から拝殿へと続く「参道」。歩く時に避けるべきとされる「正中（せいちゅう）」とはどこのこと？</h3>
                        
                        <div class="space-y-3">
                            <!-- 不正解 -->
                            <button onclick="handleQuiz(this, false, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 参道の「左端」
                            </button>
                            <!-- 不正解 -->
                            <button onclick="handleQuiz(this, false, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 参道の「右端」
                            </button>
                            <!-- 正解：3番目 (index 2) -->
                            <button onclick="handleQuiz(this, true, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. 参道の「真ん中」
                            </button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「3. 参道の真ん中」</strong>です。<br>
                                参道の中央は「正中（せいちゅう）」と呼ばれ、神様の通り道とされています。参拝者はここを避け、左右の端を歩くのが敬意を表すマナーです。横切る際は軽く一礼（会釈）をすると良いとされています。
                            </div>
                        </div>
                    </div>

                    <!-- 第3問：正解は「2番目」 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第3問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q3. お祭りで「お神輿（みこし）」を激しく揺らすことがありますが、これにはどんな意味がある？</h3>
                        
                        <div class="space-y-3">
                            <!-- 不正解 -->
                            <button onclick="handleQuiz(this, false, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 中の神様を起こすため
                            </button>
                            <!-- 正解：2番目 (index 1) -->
                            <button onclick="handleQuiz(this, true, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 神様の霊威（パワー）を高めるため
                            </button>
                            <!-- 不正解 -->
                            <button onclick="handleQuiz(this, false, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. 担ぎ手の筋力をアピールするため
                            </button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「2. 神様の霊威を高めるため」</strong>です。<br>
                                これは「魂振り（たまふり）」と呼ばれる行為です。神様の乗り物である神輿を激しく揺らすことで、神様の魂に活力を与え、その高まった霊力で地域を浄化・活性化させようとする祈りが込められています。
                            </div>
                        </div>
                    </div>
                </div>
            `
        },
        {
            id: 23,
            title: "【クイズ】神話と歴史で紐解く！三種の神器と伊勢神宮",
            date: "2026/01/16",
            category: "クイズ",
            icon: "bi-book-half",
            colorClass: "purple",
            content: `
                <div class="article-content">
                    <p>日本の神話や最高峰の神社に関する知識クイズです。難易度は少し高めですが、知っていると参拝時の視点が変わるかもしれません。</p>
                    
                    <!-- 第1問：正解は「3番目」 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-purple-200 dark:border-purple-900">
                        <span class="inline-block bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第1問</span>
                        <h3 class="font-bold text-lg mb-4 text-purple-700 dark:text-purple-300">Q1. 天皇家に伝わる「三種の神器」。そのうち「草薙剣（くさなぎのつるぎ）」をご神体として祀っている神社は？</h3>
                        
                        <div class="space-y-3">
                            <!-- 不正解 -->
                            <button onclick="handleQuiz(this, false, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 伊勢神宮（三重県）
                            </button>
                            <!-- 不正解 -->
                            <button onclick="handleQuiz(this, false, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 明治神宮（東京都）
                            </button>
                            <!-- 正解：3番目 (index 2) -->
                            <button onclick="handleQuiz(this, true, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. 熱田神宮（愛知県）
                            </button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-purple-600">解説：</span><br>
                                正解は<strong>「3. 熱田神宮」</strong>です。<br>
                                三種の神器の所在は以下の通りとされています。<br>
                                ・八咫鏡（やたのかがみ）：伊勢神宮<br>
                                ・草薙剣（くさなぎのつるぎ）：熱田神宮<br>
                                ・八尺瓊勾玉（やさかにのまがたま）：皇居
                            </div>
                        </div>
                    </div>

                    <!-- 第2問：正解は「1番目」 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-purple-200 dark:border-purple-900">
                        <span class="inline-block bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第2問</span>
                        <h3 class="font-bold text-lg mb-4 text-purple-700 dark:text-purple-300">Q2. 伊勢神宮で社殿を新しく建て替え、神様に移っていただく最大のお祭り「式年遷宮（しきねんせんぐう）」。これは何年ごとに行われる？</h3>
                        
                        <div class="space-y-3">
                            <!-- 正解：1番目 (index 0) -->
                            <button onclick="handleQuiz(this, true, 0)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 20年ごと
                            </button>
                            <!-- 不正解 -->
                            <button onclick="handleQuiz(this, false, 0)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 50年ごと
                            </button>
                            <!-- 不正解 -->
                            <button onclick="handleQuiz(this, false, 0)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. 60年ごと
                            </button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-purple-600">解説：</span><br>
                                正解は<strong>「1. 20年ごと」</strong>です。<br>
                                持統天皇4年（690年）から約1300年にわたり続けられています（戦国時代の中断を除く）。20年ごとに全てを新しくすることで、神様の力が常に若々しく保たれる（常若・とこわか）という思想に基づいています。
                            </div>
                        </div>
                    </div>

                    <!-- 第3問：正解は「2番目」 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-purple-200 dark:border-purple-900">
                        <span class="inline-block bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第3問</span>
                        <h3 class="font-bold text-lg mb-4 text-purple-700 dark:text-purple-300">Q3. 夏越の祓（なごしのはらえ）などで設置される大きな草の輪「茅の輪（ちのわ）」。これをくぐる時の正しい回り方は？</h3>
                        
                        <div class="space-y-3">
                            <!-- 不正解 -->
                            <button onclick="handleQuiz(this, false, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 時計回りに3回まわる
                            </button>
                            <!-- 正解：2番目 (index 1) -->
                            <button onclick="handleQuiz(this, true, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 左・右・左と8の字にまわる
                            </button>
                            <!-- 不正解 -->
                            <button onclick="handleQuiz(this, false, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. 一度くぐって、後ろ向きに戻る
                            </button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-purple-600">解説：</span><br>
                                正解は<strong>「2. 左・右・左と8の字にまわる」</strong>です。<br>
                                一般的な作法は、一礼して左回り→元の位置→一礼して右回り→元の位置→一礼して左回り→そのまま参拝へ、という無限大（∞）のような8の字を描く回り方です。これを「茅の輪くぐり」と言い、半年の穢れを落とすとされています。
                            </div>
                        </div>
                    </div>
                </div>
            `
        },
        {
            id: 22,
            title: "「神社」と「お寺」の決定的違い — 参拝作法が異なる理由",
            date: "2026/01/16",
            category: "基礎知識",
            icon: "bi-building",
            colorClass: "green",
            content: `
                <div class="article-content">
                    <p>日本人は初詣には神社へ行き、お葬式はお寺で行うなど、神道と仏教を自然に共存させて暮らしています。しかし、この二つの決定的な「信仰対象」と「目的」の違いを正確に説明できるでしょうか？</p>
                    
                    <h3>1. 信仰対象の違い</h3>
                    <p><strong>神社（神道）：</strong> 日本古来の「八百万（やおよろず）の神」を祀ります。山、川、岩などの自然物や、偉人の霊などが神として崇められます。ご神体は鏡や剣などが多く、姿形が見えないのが基本です。</p>
                    <p><strong>お寺（仏教）：</strong> インド発祥の教えに基づき、「仏様（仏陀、菩薩など）」を祀ります。悟りを開いた存在であり、仏像（目に見える姿）として安置されています。</p>

                    <h3>2. 拍手（かしわで）の有無</h3>
                    <p>最も大きな違いは参拝作法です。神社では<strong>「音を立てて拍手を打つ」</strong>のが基本です。これは音霊（おとだま）によって邪気を払い、神様をお呼びするためです。</p>
                    <p>対して、お寺では<strong>「拍手は打たず、静かに合掌」</strong>します。お寺で手を叩くのはマナー違反となる場合がほとんどですので注意が必要です。</p>

                    <h3>3. 死生観の違い</h3>
                    <p>神道は「穢れ（けがれ）」を嫌い、現世での清浄や繁栄を願う「今」を重視する教えです。一方、仏教は「輪廻転生」や「解脱」など、死後の世界や魂の救済に重きを置く傾向があります。</p>
                    <p>どちらが良い悪いではなく、日本人はこの二つを「現世は神様、死後は仏様」と役割分担することで、心のバランスを保ってきたと言えるでしょう。</p>
                </div>
            `
        },
        {
            id: 21,
            title: "【検定・上級】神様と人をつなぐ「食事」と「榊」の作法",
            date: "2026/01/16",
            category: "クイズ",
            icon: "bi-patch-question-fill",
            colorClass: "indigo",
            content: `
                <div class="article-content">
                    <p>神社の儀式やお祭りに込められた深い意味を知るための、少し踏み込んだ3択クイズです。全問正解できれば、神職に近い知識をお持ちかもしれません。</p>
                    
                    <!-- 第1問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第1問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q1. 神事の終了後、お供えしていたお酒や食事を下げて、参列者で食べる行事を何という？</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, false, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 潔斎（けっさい）
                            </button>
                            <button onclick="handleQuiz(this, true, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 直会（なおらい）
                            </button>
                            <button onclick="handleQuiz(this, false, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. 祓除（ばつじょ）
                            </button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「2. 直会（なおらい）」</strong>です。<br>
                                神様にお供えした物（神饌）には神聖な力が宿るとされます。それを人が頂くことで神人一体となり、恩恵を体内に取り込む重要な儀式です。単なる食事会ではなく、神事の締めくくりとされています。
                            </div>
                        </div>
                    </div>

                    <!-- 第2問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第2問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q2. 神事で奉納する植物「榊（さかき）」について、正しい記述はどれ？</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, false, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 葉が落ちないため「栄える木」が語源である説がある
                            </button>
                            <button onclick="handleQuiz(this, false, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 神域と俗界の「境の木」が語源である説がある
                            </button>
                            <button onclick="handleQuiz(this, true, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. 上記の1と2、両方の説がある
                            </button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「3」</strong>です。<br>
                                「榊」の語源には諸説あり、常緑樹で常に青々としていることから「栄える木（栄木）」、あるいは神域との境界を示す「境の木（境木）」から転じたとする説が有力です。神様の依代（よりしろ）として最も重要な植物です。
                            </div>
                        </div>
                    </div>

                    <!-- 第3問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第3問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q3. 神社の屋根の「千木（ちぎ）」の形で見分けることができる、ある傾向とは？（※例外あり）</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, true, 0)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 先端が地面と水平なら女神、垂直なら男神
                            </button>
                            <button onclick="handleQuiz(this, false, 0)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 先端が鋭いなら武神、丸いなら農耕神
                            </button>
                            <button onclick="handleQuiz(this, false, 0)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. 本数は神様の年齢を表している
                            </button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「1」</strong>です。<br>
                                一般的な傾向として、千木の先端が地面に対して水平に切られている（内削ぎ）場合は女神、垂直に切られている（外削ぎ）場合は男神を祀っていることが多いとされています（俗説とも言われますが、伊勢神宮などの神明造ではこの傾向が見られます）。ただし、必ずしも全ての神社に当てはまるわけではありません。
                            </div>
                        </div>
                    </div>
                </div>
            `
        },
        {
            id: 20,
            title: "【由来】願いを託す「絵馬（えま）」— なぜ馬の絵を描くのか？",
            date: "2026/01/16",
            category: "歴史",
            icon: "bi-card-image",
            colorClass: "orange",
            content: `
                <div class="article-content">
                    <p>システムの改修作業に集中しており、数日ほど更新が空いてしまいました。楽しみにしてくださっていた皆様、申し訳ございません。本日よりまた、神社の知識をお届けしてまいります。</p>
                    
                    <p>さて、受験シーズンということもあり、神社には多くの「絵馬」が奉納されています。なぜ願い事を書く板に「馬」の絵が描かれているのか、その正確な由来をご存知でしょうか。</p>

                    <h3>神様の乗り物「神馬（しんめ）」</h3>
                    <p>古代日本において、馬は「神様の乗り物」として神聖視されていました。そのため、日照りや長雨などの重大な局面で神様に祈願する際は、<strong>「生きた馬」</strong>を神社に奉納する習わしがありました。</p>
                    <p>しかし、高価な馬を度々奉納することは経済的に難しく、また神社側でも世話が大変であることから、次第に「木で作った馬」や「紙に描いた馬」で代用されるようになりました。これが平安時代頃に、現在のような<strong>「板に馬の絵を描いて奉納する形式」</strong>へと定着したのが「絵馬」の起源です。</p>

                    <h3>現代における絵馬</h3>
                    <p>現在では馬の絵に限らず、その年の干支や、神社の祭神にゆかりのある動物（稲荷神社の狐など）が描かれることも一般的になりました。しかし、「神様に願いを届けるための便り」という本質は変わりません。</p>
                    <p>書く際は、「合格しますように」という願望だけでなく、「合格するために全力を尽くします」という<strong>神様への誓い（決意表明）</strong>を記すと、より一層のご加護が得られると言われています。</p>
                </div>
            `
        },
        {
            id: 19,
            title: "【検定・中級】知っていると自慢できる？神社の名称クイズ",
            date: "2026/01/12",
            category: "クイズ",
            icon: "bi-mortarboard-fill",
            colorClass: "purple",
            content: `
                <div class="article-content">
                    <p>先ほどの問題は準備運動です。ここからは少し難易度を上げて、普段目にしているけれど「名前」までは意外と知らない、そんな神社のパーツを答えていただきます。</p>
                    
                    <!-- 第1問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-purple-200 dark:border-purple-900">
                        <span class="inline-block bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第1問</span>
                        <h3 class="font-bold text-lg mb-4 text-purple-700 dark:text-purple-300">Q1. 注連縄（しめなわ）や玉串に付いている、稲妻のような形をした「白い紙」の名前は？</h3>
                        
                        <div class="space-y-4">
                            <input type="text" id="quiz-hard-1" placeholder="答えを入力..." 
                                class="w-full p-4 rounded-lg bg-gray-800 text-white text-lg font-bold border border-gray-600 focus:outline-none focus:border-purple-500 transition-colors placeholder-gray-500"
                                style="caret-color: white;">
                            
                            <button onclick="handleInputQuiz(this, ['紙垂', 'しで', 'シデ', '四手'], 1)" 
                                class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg shadow-md transition transform active:scale-95">
                                回答する
                            </button>
                        </div>

                        <div class="hidden mt-6 pt-4 border-t border-gray-300 quiz-result">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-purple-600">正解：紙垂（しで）</span><br>
                                神聖・清浄をあらわす紙です。独特のギザギザした形は「雷（稲妻）」を象徴しており、雷が多い年は豊作になることから、邪気を払い豊作を祈願する意味が込められています。
                            </div>
                        </div>
                    </div>

                    <!-- 第2問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-purple-200 dark:border-purple-900">
                        <span class="inline-block bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第2問</span>
                        <h3 class="font-bold text-lg mb-4 text-purple-700 dark:text-purple-300">Q2. 拝殿で鈴（本坪鈴）を鳴らすために垂れ下がっている、あの太い「紐（ひも）」の正式名称は？</h3>
                        
                        <div class="space-y-4">
                            <input type="text" id="quiz-hard-2" placeholder="答えを入力..." 
                                class="w-full p-4 rounded-lg bg-gray-800 text-white text-lg font-bold border border-gray-600 focus:outline-none focus:border-purple-500 transition-colors placeholder-gray-500"
                                style="caret-color: white;">
                            
                            <button onclick="handleInputQuiz(this, ['鈴緒', 'すずお', 'スズオ'], 2)" 
                                class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg shadow-md transition transform active:scale-95">
                                回答する
                            </button>
                        </div>

                        <div class="hidden mt-6 pt-4 border-t border-gray-300 quiz-result">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-purple-600">正解：鈴緒（すずお）</span><br>
                                文字通り「鈴の緒」です。紅白や五色の布をねじって作られることが多く、この緒を通じて神様と繋がる（ご縁を結ぶ）という意味合いも持っています。
                            </div>
                        </div>
                    </div>

                    <!-- 第3問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-purple-200 dark:border-purple-900">
                        <span class="inline-block bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第3問</span>
                        <h3 class="font-bold text-lg mb-4 text-purple-700 dark:text-purple-300">Q3. 神社の屋根の上に並んでいる、丸太のような部材の名前は？（ある魚に似ていることが由来）</h3>
                        
                        <div class="space-y-4">
                            <input type="text" id="quiz-hard-3" placeholder="答えを入力..." 
                                class="w-full p-4 rounded-lg bg-gray-800 text-white text-lg font-bold border border-gray-600 focus:outline-none focus:border-purple-500 transition-colors placeholder-gray-500"
                                style="caret-color: white;">
                            
                            <button onclick="handleInputQuiz(this, ['鰹木', 'かつおぎ', 'カツオギ', '勝男木', '堅魚木'], 3)" 
                                class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg shadow-md transition transform active:scale-95">
                                回答する
                            </button>
                        </div>

                        <div class="hidden mt-6 pt-4 border-t border-gray-300 quiz-result">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-purple-600">正解：鰹木（かつおぎ）</span><br>
                                屋根の棟に対して直角に並べられた装飾です。形が「鰹節（かつおぶし）」に似ていることからこの名がつきました。ちなみに、屋根の両端でクロスして突き出ている板は「千木（ちぎ）」と呼びます。
                            </div>
                        </div>
                    </div>
                </div>
            `
        },
        {
            id: 18,
            title: "【検定】神社の常識、漢字で書けますか？（入力式クイズ）",
            date: "2026/01/12",
            category: "クイズ",
            icon: "bi-pencil-square",
            colorClass: "indigo",
            content: `
                <div class="article-content">
                    <p>今回は趣向を変えて、選択肢なしの「入力式」クイズです。神社の風景にある「あの名前」、ひらがなでも正解になりますので、ぜひ挑戦してみてください。</p>
                    
                    <!-- 第1問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第1問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q1. 神域と俗界を区画する「結界」であり、神様の世界への入り口を示す門のような建造物は？</h3>
                        
                        <div class="space-y-4">
                            <input type="text" id="quiz-input-1" placeholder="答えを入力..." 
                                class="w-full p-4 rounded-lg bg-gray-800 text-white text-lg font-bold border border-gray-600 focus:outline-none focus:border-indigo-500 transition-colors placeholder-gray-500"
                                style="caret-color: white;">
                            
                            <button onclick="handleInputQuiz(this, ['鳥居', 'とりい', 'トリイ'], 1)" 
                                class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-md transition transform active:scale-95">
                                回答する
                            </button>
                        </div>

                        <div class="hidden mt-6 pt-4 border-t border-gray-300 quiz-result">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">正解：鳥居（とりい）</span><br>
                                神社の象徴とも言える鳥居。その起源には諸説ありますが、「天岩戸」伝説で鶏（常世の長鳴鳥）を鳴かせた止まり木に由来するという説や、海外の門（インドのトラナ等）が変化したという説があります。
                            </div>
                        </div>
                    </div>

                    <!-- 第2問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第2問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q2. 参拝の前に、手や口をすすいで心身を清めるために水が張ってある場所を何という？</h3>
                        
                        <div class="space-y-4">
                            <input type="text" id="quiz-input-2" placeholder="答えを入力..." 
                                class="w-full p-4 rounded-lg bg-gray-800 text-white text-lg font-bold border border-gray-600 focus:outline-none focus:border-indigo-500 transition-colors placeholder-gray-500"
                                style="caret-color: white;">
                            
                            <button onclick="handleInputQuiz(this, ['手水舎', 'てみずや', 'ちょうずや', 'てみずしゃ', 'ちょうずしゃ', '手水'], 2)" 
                                class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-md transition transform active:scale-95">
                                回答する
                            </button>
                        </div>

                        <div class="hidden mt-6 pt-4 border-t border-gray-300 quiz-result">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">正解：手水舎（てみずや／ちょうずや）</span><br>
                                読み方はどちらも正解です。かつて川や海に入って全身を清めた「禊（みそぎ）」を簡略化したもので、神様の前に立つための最も重要な作法の一つです。
                            </div>
                        </div>
                    </div>

                    <!-- 第3問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第3問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q3. 神聖な場所であることを示し、不浄なものの侵入を防ぐために張られる「縄」は？</h3>
                        
                        <div class="space-y-4">
                            <input type="text" id="quiz-input-3" placeholder="答えを入力..." 
                                class="w-full p-4 rounded-lg bg-gray-800 text-white text-lg font-bold border border-gray-600 focus:outline-none focus:border-indigo-500 transition-colors placeholder-gray-500"
                                style="caret-color: white;">
                            
                            <button onclick="handleInputQuiz(this, ['注連縄', 'しめなわ', 'しめ縄', '七五三縄', '標縄'], 3)" 
                                class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-md transition transform active:scale-95">
                                回答する
                            </button>
                        </div>

                        <div class="hidden mt-6 pt-4 border-t border-gray-300 quiz-result">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">正解：注連縄（しめなわ）</span><br>
                                「七五三縄」と書くこともあります。天岩戸から出た天照大御神が二度と戻らないように縄を張った神話が起源とされ、神様の領域（常世）と現世（うつしよ）を隔てる結界の役割を持ちます。
                            </div>
                        </div>
                    </div>
                </div>
            `
        },
        {
            id: 17,
            title: "【歳時記】大人の仲間入りと神様への報告 — 成人の日によせて",
            date: "2026/01/12",
            category: "歳時記",
            icon: "bi-flower1",
            colorClass: "pink",
            content: `
                <div class="article-content">
                    <p>前回の更新（1月6日）をもって、長らく進めていたこのサイトのシステム開発が一通り完了いたしました。そのため、少し休息を取りつつ、実は別のサイトの開発に着手しておりました。そんな事情で少し更新の間隔が空いてしまいましたが、皆様いかがお過ごしでしょうか。</p>
                    
                    <p>さて、本日<strong>1月12日は「成人の日」</strong>です。今年晴れて新成人となられた皆様、誠におめでとうございます。</p>

                    <h3>神様から見た「大人」とは？</h3>
                    <p>現代では20歳（あるいは18歳）が成人の節目ですが、かつての日本には<strong>「元服（げんぷく）」</strong>という通過儀礼がありました。数え年の12〜16歳頃に行われ、髪型や服装を改めて、神様の前で「大人の仲間入り」を誓う儀式です。</p>
                    
                    <p>これは単にお祝いをするだけでなく、<strong>「神様の守り子である『氏子（うじこ）』として、一人前の責任を負い、地域社会に貢献する」</strong>と宣言する場でもありました。</p>

                    <h3>初心に立ち返る日として</h3>
                    <p>振袖や袴、スーツといった晴れ着は、かつての「冠（かんむり）」にあたります。外見を整えることで、内面の覚悟も新たにする。それが日本の伝統的な「ハレの日」の作法です。</p>

                    <p>すでに大人になられて久しい方も、今日はご自身の成人式や若き日の志を思い出し、地元の神社へ「おかげさまで、今日も無事に過ごせています」と報告に訪れてみてはいかがでしょうか。初心に立ち返り、背筋を伸ばすことで、また新しい良い運気が巡ってくるはずです。</p>
                </div>
            `
        },
        {
            id: 16,
            title: "【クイズ】知れば参拝が楽しくなる！神社の道具・作法編",
            date: "2026/01/06",
            category: "クイズ",
            icon: "bi-question-circle-fill",
            colorClass: "indigo",
            content: `
                <div class="article-content">
                    <p>神社の境内にある「道具」や、なんとなく行っている「習慣」。それら一つ一つには、神道に基づいた深い意味や理由が存在します。今回は、知っているようで知らない参拝の常識クイズです。</p>
                    
                    <!-- 第1問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第1問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q1. 拝殿の前にある「鈴（すず）」。これを鳴らす本来の目的は？</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, false, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 神様を起こすため（来訪の合図）
                            </button>
                            <button onclick="handleQuiz(this, true, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 自分の身を清めるため（祓い）
                            </button>
                            <button onclick="handleQuiz(this, false, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. お賽銭を入れた確認のため
                            </button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「2」</strong>です。<br>
                                鈴の清らかな音色には、邪気を払い、参拝者自身の心身を清める<strong>「祓（はら）い」</strong>の力があると考えられています。神様をお呼びするという側面もありますが、主たる目的は、神様の前に立つ前に自分を清浄にすることです。
                            </div>
                        </div>
                    </div>

                    <!-- 第2問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第2問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q2. 正式参拝などで「玉串（たまぐし/榊）」を神様にお供えする際、正しい向きは？</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, true, 0)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 根元（茎）を神様に向けて置く
                            </button>
                            <button onclick="handleQuiz(this, false, 0)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 葉先を神様に向けて置く
                            </button>
                            <button onclick="handleQuiz(this, false, 0)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. 横向き（平行）に置く
                            </button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「1」</strong>です。<br>
                                受け取る時は「根元が自分側」ですが、お供えする際は、時計回りに回して<strong>「根元を神様側」</strong>に向けて台に置きます。これは神様に対して敬意を表し、根の方から神聖な力を受け取るという意味合いもあります。
                            </div>
                        </div>
                    </div>

                    <!-- 第3問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第3問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q3. 語呂合わせの「縁起」において、お賽銭で避けたほうが良いとされる硬貨は？</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, false, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 5円玉（ご縁）
                            </button>
                            <button onclick="handleQuiz(this, false, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 50円玉（五重の縁）
                            </button>
                            <button onclick="handleQuiz(this, true, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. 10円玉（遠縁）
                            </button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「3」</strong>です。<br>
                                10円玉は<strong>「遠縁（とおえん）＝縁が遠ざかる」</strong>と読めるため、縁結び祈願などでは避ける人が多いです（500円玉も「これ以上硬貨（効果）がない」とされることがあります）。ただし、これらはあくまで語呂合わせの俗信であり、神様への感謝の気持ちがあれば金額や硬貨の種類は本来問いません。
                            </div>
                        </div>
                    </div>
                </div>
            `
        },
        {
            id: 15,
            title: "拝殿の鏡が映し出すもの —「かがみ」から「が」を取ると？",
            date: "2026/01/06",
            category: "読み解き",
            icon: "bi-record-circle",
            colorClass: "green",
            content: `
                <div class="article-content">
                    <p>神社の拝殿で手を合わせる際、奥に丸い「鏡（神鏡）」が祀られているのを見たことがあるでしょうか。あれは単なる装飾ではなく、天照大御神（太陽神）の象徴であり、ご神体そのものとして扱われる極めて重要なものです。</p>
                    
                    <h3>鏡が映し出す「正体」</h3>
                    <p>鏡の前に立つと、そこには何が映るでしょうか？当然、参拝している「自分自身」の姿です。これには深い意味があります。神道には<strong>「鏡（かがみ）から、我（が）を取ると、神（かみ）になる」</strong>という有名な教えがあります。</p>

                    <h3>「我（エゴ）」を取り払う修行</h3>
                    <p>鏡に映る自分と向き合い、その中にある「我欲（エゴ、執着、見栄）」を取り払った時、人の心には本来の清らかな「神性（神様の心）」が現れるということを示しています。つまり、神社への参拝は、神様に願い事をする場であると同時に、鏡を通じて<strong>「本来の清らかな自分（神）」に立ち返るための儀式</strong>でもあるのです。</p>
                    
                    <p>おみくじを引く際も、この鏡のような心持ちで、欲を捨てて無心になることで、より正確な天命（メッセージ）を受け取ることができると言われています。</p>
                </div>
            `
        },
        {
            id: 14,
            title: "なぜ神社の鳥居や社殿は「赤（朱色）」なのか？",
            date: "2026/01/06",
            category: "雑学",
            icon: "bi-palette-fill",
            colorClass: "red",
            content: `
                <div class="article-content">
                    <p>伏見稲荷大社の千本鳥居をはじめ、多くの神社の鳥居や社殿には鮮やかな「赤（朱色）」が使われています。これには、単なるデザイン以上の「科学的」かつ「霊的」な二つの重要な理由が存在します。</p>
                    
                    <h3>科学的理由：最強の防腐剤</h3>
                    <p>古来、朱色の塗料の原料には「丹（に）」と呼ばれる<strong>水銀（硫化水銀）</strong>が含まれていました。水銀には強力な防虫・防腐作用があります。日本の神社は木造建築が基本であり、雨や湿気、シロアリから建物を守り、長い年月維持するために、当時の最高級の防腐剤である「朱」が塗られたのです。</p>

                    <h3>霊的理由：魔除けと生命の象徴</h3>
                    <p>精神的な意味において、赤は「火」や「太陽」、「血」の色であり、<strong>生命の躍動</strong>を象徴します。また、古くから赤色には<strong>「魔除け（災厄を退ける力）」</strong>があると信じられてきました。</p>
                    <p>神聖な場所（神域）に邪悪な霊や災いが入ってこないように結界を張る意味で、入口である鳥居や社殿そのものを赤く染め上げているのです。当サイトのテーマカラーに「紅」が使われているのも、この魔除けと開運の力をデジタルの杜に取り入れるためです。</p>
                </div>
            `
        },
        {
            id: 13,
            title: "【特別クイズ】目指せ参拝の達人！神社検定・超難問10番勝負",
            date: "2026/01/06",
            category: "特別クイズ",
            icon: "bi-trophy-fill",
            colorClass: "yellow",
            content: `
                <div class="article-content">
                    <p>今回は「天命乃杜」からの挑戦状です。神社の歴史、作法、おみくじの深い知識を問う全10問の検定試験。全問正解できれば、あなたは真の「参拝の達人」です！</p>
                    
                    ${[
                        {q: "Q1. 明治神宮（東京）のおみくじには、他と違って『あるもの』が書かれていません。それは何？", a: ["吉凶（大吉や凶）", "和歌", "ラッキーカラー"], c: 0, exp: "明治神宮のおみくじ『大御心（おおみごころ）』には吉凶がありません。代わりに明治天皇や昭憲皇太后が詠まれた和歌と、その解説が記されています。"},
                        {q: "Q2. 出雲大社（島根）での正式な参拝方法は？", a: ["二礼二拍手一礼", "二礼四拍手一礼", "四礼四拍手一礼"], c: 1, exp: "一般的には二拍手ですが、出雲大社（および宇佐神宮など）では古くからの伝統により『四拍手』を打つのが正式な作法です。"},
                        {q: "Q3. 神社にある『しめ縄』のルーツとされている日本神話の場面は？", a: ["天の岩戸隠れ", "ヤマタノオロチ退治", "国譲り"], c: 0, exp: "天照大御神が岩戸から出てきた際、二度と戻れないように『尻久米縄（しりくめなわ）』を張ったのが始まりとされています。"},
                        {q: "Q4. 手水舎で、最後に柄杓（ひしゃく）を立てて水を流す理由は？", a: ["残った水を捨てるため", "自分が使った柄を清めるため", "神様に感謝を示すため"], c: 1, exp: "次に使う人のために、自分が握った柄の部分を洗い流して清めるのがマナーです。"},
                        {q: "Q5. 厳島神社の海に浮かぶ大鳥居。なぜ倒れずに立っていられる？", a: ["深く埋まっているから", "重石が入って自立しているから", "魔法の力で固定されているから"], c: 1, exp: "実は埋まっているのではなく、自重（約60トン）と、屋根の部分に詰められた大量の経石（石）の重みで海底に置かれているだけなのです。"},
                        {q: "Q6. おみくじで『待ち人』が『来る、遅し』とある場合、その『人』とは誰のこと？", a: ["好きな人や恋人", "自分の人生を好転させる人", "配達員"], c: 1, exp: "恋愛相手だけでなく、良い知らせを運ぶ人や助けてくれる人など、自分の運命に重要な影響を与える人物全般を指します。"},
                        {q: "Q7. 伊勢神宮の内宮に祀られている最高位の神様は？", a: ["天照大御神", "豊受大御神", "須佐之男命"], c: 0, exp: "内宮（皇大神宮）は皇室の祖神であり、太陽にも例えられる天照大御神（あまてらすおおみかみ）を祀っています。"},
                        {q: "Q8. 狛犬の『阿（あ）』と『吽（うん）』。口を閉じているのはどっち？", a: ["阿（向かって右）", "吽（向かって左）", "両方閉じている"], c: 1, exp: "『阿』は口を開け（始まり）、『吽』は口を閉じています（終わり）。宇宙の万物の始まりと終わりを表現しています。"},
                        {q: "Q9. おみくじの『失せ物（うせもの）』が指すのは、落とした物だけ？", a: ["はい、落とし物だけです", "いいえ、失った信頼やチャンスも含む", "いいえ、未来の宝物も含む"], c: 1, exp: "物理的な落とし物だけでなく、忘れてしまった初心や、逃したチャンス、疎遠になった人間関係なども含まれます。"},
                        {q: "Q10. 最も格の高い神社の称号を『社号』と呼びますが、伊勢神宮の正式名称は？", a: ["伊勢大神宮", "神宮", "伊勢神社"], c: 1, exp: "他の神社と区別するため、単に『神宮』と呼ぶのが正式名称です。それほどまでに特別な存在とされています。"}
                    ].map((item, i) => `
                        <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-yellow-200 dark:border-yellow-900">
                            <span class="inline-block bg-yellow-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第${i+1}問</span>
                            <h3 class="font-bold text-lg mb-4 text-yellow-800 dark:text-yellow-200">${item.q}</h3>
                            <div class="space-y-3">
                                ${item.a.map((ans, idx) => `
                                    <button onclick="handleQuiz(this, ${idx === item.c}, ${item.c})" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                        ${idx + 1}. ${ans}
                                    </button>
                                `).join('')}
                            </div>
                            <div class="hidden mt-6 pt-4 border-t border-gray-300">
                                <div class="quiz-msg text-xl font-black mb-2"></div>
                                <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                    <span class="font-bold text-yellow-600">解説：</span><br>${item.exp}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `
        },
        {
            id: 12,
            title: "和歌の心を読む — おみくじの裏側に隠された真実",
            date: "2026/01/06",
            category: "読み解き",
            icon: "bi-journal-richtext",
            colorClass: "green",
            content: `
                <div class="article-content">
                    <p>おみくじを引いて、真っ先に『大吉』や『凶』の文字だけを見て一喜一憂していませんか？ 実は、おみくじにおいて最も重要で、神様からの直接のメッセージが込められているのは、その横や裏に記された『和歌』なのです。</p>
                    
                    <h3>なぜ『吉凶』より『和歌』なのか</h3>
                    <p>吉凶のランクは、あくまでその瞬間の『勢い』を示す天気予報のようなものです。一方で和歌は、あなたが直面している問題に対する具体的な『指針』を示しています。和歌は古来より言霊（ことだま）が宿るとされ、その31文字の中には、現在のあなたの心の状態を映し出す鏡のような役割があります。</p>

                    <h3>情景から読み解くアドバイス</h3>
                    <p>例えば『枯れ木に花が咲く』という情景の歌であれば、今は苦しくても必ず好転するという希望を説いています。逆に『照りつける太陽』のような歌であれば、勢いはあるが傲慢になっていないか、という戒めが含まれています。</p>

                    <h3>自分の状況に引き寄せる</h3>
                    <p>和歌を読み解くコツは、今の悩みを頭に浮かべながら、歌の中の『登場人物』や『風景』を自分に置き換えてみることです。当杜のおみくじに添えられている言葉も、この和歌の精神をベースに現代的に解釈したものです。文字の奥にある「心」を読み取ることで、おみくじは単なる占いから、人生の羅針盤へと変わるでしょう。</p>
                </div>
            `
        },
        {
            id: 11,
            title: "鳥居の向こう側 — 神域と俗界を分ける境界線",
            date: "2026/01/06",
            category: "建築",
            icon: "bi-bank",
            colorClass: "green",
            content: `
                <div class="article-content">
                    <p>神社に足を踏み入れる際、必ず通るのが『鳥居』です。単なる入り口の門だと思われがちですが、そこには深い宗教的・哲学的な意味が込められています。</p>
                    
                    <h3>結界としての役割</h3>
                    <p>鳥居は、私たちの住む現実世界（俗界）と、神様がお鎮まりになる神聖な場所（神域）を区切る『結界』の役割を果たしています。鳥居をくぐるということは、神聖な空間に入るための最初の儀式です。そのため、くぐる前に衣服を整え、軽く一礼をするのが本来の作法とされています。</p>

                    <h3>二つの大きな形式：神明と明神</h3>
                    <p>日本全国には数多くの鳥居がありますが、大きく分けて二つの系統があります。
                    一つは『神明（しんめい）系』。伊勢神宮などに代表される、直線的で素朴な構造です。
                    もう一つは『明神（みょうじん）系』。柱の上に反り増しがある笠木が乗った、装飾的な形式です。私たちが普段目にする多くの鳥居はこちらの明神系に属します。</p>

                    <h3>なぜ『鳥』の居場所なのか</h3>
                    <p>諸説ありますが、日本神話において天照大御神が岩戸に隠れた際、常世の長鳴鳥（鶏）を鳴かせて神の出現を促したという伝説に基づき、神の使いである鳥が止まる場所として作られたという説が有力です。次に参拝される際は、その鳥居がどのような形をしており、どのような素材で作られているか観察してみてください。神域への入口は、すでにそこから始まっているのです。</p>
                </div>
            `
        },
        {
            id: 10,
            title: "【クイズ】神社の「動物」にまつわる謎（全3問）",
            date: "2026/01/06",
            category: "クイズ",
            icon: "bi-question-circle-fill",
            colorClass: "indigo",
            content: `
                <div class="article-content">
                    <p>神社には「狛犬」をはじめ、さまざまな動物の像が置かれています。これらは「神使（しんし）」と呼ばれ、神様の使いとされています。今回はそんな神社の動物に関するクイズです。</p>
                    
                    <!-- 第1問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第1問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q1. 稲荷神社でおなじみの「キツネ」。彼らが口にくわえているもので、実在しない「霊力のある宝物」はどれ？</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, false, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 稲穂（いなほ）
                            </button>
                            <button onclick="handleQuiz(this, true, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 宝珠（ほうじゅ）
                            </button>
                            <button onclick="handleQuiz(this, false, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. 鍵（かぎ）
                            </button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「2」</strong>です。宝珠（ほうじゅ）は、どんな願いも叶うとされる仏教由来の宝の玉です。お稲荷様のキツネは、稲穂、鍵、巻物、そして宝珠のいずれかをくわえていることが多いですが、宝珠だけが伝説上のアイテムです。
                            </div>
                        </div>
                    </div>

                    <!-- 第2問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第2問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q2. 天満宮（菅原道真公を祀る神社）で「牛」の像が必ず置かれているのはなぜ？</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, true, 0)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 道真公が丑年生まれで、牛を慈しんだから
                            </button>
                            <button onclick="handleQuiz(this, false, 0)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 道真公が牛に乗って戦った伝説があるから
                            </button>
                            <button onclick="handleQuiz(this, false, 0)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. 牛が知恵の象徴とされていたから
                            </button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「1」</strong>です。道真公は承和12年（845年）の「乙丑（きのとうし）」の年に生まれ、亡くなったのも丑の月日であったとされています。また、道真公の遺体を運ぶ牛車が座り込んで動かなくなった場所が現在の太宰府天満宮になったという伝説から、天満宮の牛は「座り牛」の形をしています。
                            </div>
                        </div>
                    </div>

                    <!-- 第3問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第3問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q3. 春日大社（奈良）などで、神様の使いとされている動物はどれ？</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, false, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. サル
                            </button>
                            <button onclick="handleQuiz(this, false, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. ウサギ
                            </button>
                            <button onclick="handleQuiz(this, true, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. シカ
                            </button>
                        </div>
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「3」</strong>です。春日大社の創建の際、茨城県の鹿島神宮から神様が白い鹿に乗ってやってきたという伝説に基づいています。そのため、奈良のシカは古くから「神鹿（しんろく）」として手厚く保護されてきました。
                            </div>
                        </div>
                    </div>
                </div>
            `
        },
        {
            id: 9,
            title: "最強の開運日を知る—天赦日と一粒万倍日",
            date: "2026/01/06",
            category: "開運",
            icon: "bi-calendar-heart",
            colorClass: "green",
            content: `
                <div class="article-content">
                    <p>おみくじを引くときや、新しいことを始めるときに気になるのが「暦（こよみ）」の吉日です。2026年も、数ある吉日の中でも特に強力とされる日が存在します。それぞれの意味を正しく理解し、天命を味方につけましょう。</p>
                    
                    <h3>天赦日（てんしゃにち）</h3>
                    <p>日本の暦の上で「最高の吉日」とされる日です。年にわずか5回〜6回しかありません。八百万の神々が天に昇り、天がすべての罪を許すとされる日です。「この日に始めたことはすべて成功する」と言われており、結婚、入籍、開業、お財布の新調にこれ以上ない日です。</p>

                    <h3>一粒万倍日（いちりゅうまんばいび）</h3>
                    <p>「一粒の籾（もみ）が万倍にも実る稲穂になる」という意味を持つ日です。わずかなものが飛躍的に増えることを示唆するため、新しい仕事のスタートや、投資、貯金、あるいは善行を行うのに非常に良い日とされています。ただし、借金や他人との諍いも「万倍」になってしまうため、注意が必要です。</p>

                    <h3>大安（たいあん）</h3>
                    <p>六曜の中で最も有名な吉日です。「大いに安し」という意味で、一日中何事においても吉とされる日です。天赦日や一粒万倍日とこの「大安」が重なる日は、最強の開運パワーを発揮すると言われています。</p>

                    <p>当杜の「12星座占い」や「全国の運気ランキング」で良い結果が出た日が、これらの吉日と重なっていれば、それはあなたにとって特別な転機となるかもしれません。暦を意識することで、日常の何気ない選択がより豊かなものに変わっていくでしょう。</p>
                </div>
            `
        },
        {
            id: 8,
            title: "おみくじの起源—元三大師と伝統の「百籤」",
            date: "2026/01/06",
            category: "歴史",
            icon: "bi-bank",
            colorClass: "green",
            content: `
                <div class="article-content">
                    <p>現在、私たちが神社や寺で引いているおみくじの原型は、平安時代の高僧、良源（慈恵大師、通称「元三大師」）にまで遡ります。彼は比叡山延暦寺の中興の祖として知られる人物です。</p>
                    
                    <h3>元三大師百籤（がんざんだいしひゃくせん）</h3>
                    <p>江戸時代、比叡山に伝わっていたこのおみくじが、徳川家康の側近であった天海大僧正（慈眼大師）によって広められたとされています。天海が夢の中で元三大師から授かったおみくじを箱に入れ、くじ引きの形で吉凶を占ったのが「元三大師百籤」であり、これが現代の日本のおみくじのスタンダードとなりました。</p>

                    <h3>漢詩と和歌の役割</h3>
                    <p>もともとのおみくじには、五言四句の「漢詩」が記されており、その内容から運勢を読み解くものでした。明治時代以降、多くの神社で日本独自の「和歌」が採用されるようになりましたが、現在でも「浅草寺」などの古い寺院では、起源に近い漢詩形式のおみくじを引くことができます。</p>

                    <h3>なぜ「天命乃杜」は12段階なのか</h3>
                    <p>江戸時代の百籤には「大吉」「吉」「中吉」「小吉」「末吉」「末小吉」「凶」の7段階が基本でした。当杜では、この伝統的な分類をさらに細分化し、現代人の複雑な心境に寄り添うべく、古来の陰陽五行や数秘術の視点を取り入れた独自の12段階構成を採用しています。</p>
                    <p>一枚の紙に託された先人の知恵。それをデジタルという形で受け継ぐことの重みを、私たちは大切にしていきたいと考えています。</p>
                </div>
            `
        },
        {
            id: 7,
            title: "「忖度なき天命」— 当杜のおみくじ確率について",
            date: "2026/01/06",
            category: "開発秘話",
            icon: "bi-dice-5-fill",
            colorClass: "red",
            content: `
                <div class="article-content">
                    <p>いつも「運勢・天命乃杜」をご利用いただき、誠にありがとうございます。個人開発者のnden148です。</p>
                    <p>本日は、当サイトの心臓部とも言える「おみくじの当選確率」について、その設計思想を詳しくお話しさせていただきます。</p>
                    
                    <h3>12分の1の真実</h3>
                    <p>世の中の多くの占いアプリやデジタルおみくじでは、利用者に喜んでもらうために「大吉」を多く出し、「凶」を極端に減らすといった、いわゆる「確率操作（重み付け）」が行われていることが少なくありません。中には、凶を一切入れないという選択をするサービスもあります。</p>
                    <p>しかし、当サイト「天命乃杜」は、その道を選びませんでした。当杜のおみくじは、全12種類の運勢すべてが<strong>「12分の1（約8.33%）」という完全に均等な確率</strong>で抽選されています。</p>

                    <h3>「大凶」もまた、等しく大切な天命</h3>
                    <p>開発段階において、「大凶が出すぎるとユーザーが離れてしまうのではないか」という葛藤がなかったわけではありません。しかし、私は「大凶」を単なるハズレだとは考えていません。人生において、うまくいかない時期や注意すべき瞬間を正直に受け入れることは、大吉を喜ぶことと同じくらい重要です。</p>
                    <p>大吉が出る確率と、大凶が出る確率が全く同じ。この<strong>「忖度なき平等」</strong>こそが、デジタルな杜において「真実の運命」を授かるための絶対条件だと確信したのです。大吉が出たときは心から喜び、大凶が出たときは「今日は神様が本気で注意を促してくれている」と、その重みを受け止めていただきたい。それが私の願いです。</p>

                    <h3>デジタル上の厳しい修行場として</h3>
                    <p>「全国・土地の運気ランキング」を文字ベースのガチな内容に変えた際もそうでしたが、私はこのサイトを、単なる娯楽以上の「自分を見つめ直す場所」にしたいと考えています。手加減なしの確率だからこそ、引き当てた結果には本物の価値が宿ります。</p>
                    <p>明日、あなたが引くおみくじが「大吉」か「大凶」かは、私にもわかりません。それこそが「天命」なのです。これからも当杜は、あなたの運命に対してどこまでも誠実であり続けます。どうぞ、覚悟を持って（？）おみくじをお引きください。</p>
                </div>
            `
        },
        {
            id: 6,
            title: "【クイズ】おみくじの常識、意外と知らない？（全3問）",
            date: "2026/1/5",
            category: "クイズ",
            icon: "bi-question-circle-fill",
            colorClass: "indigo",
            content: `
                <div class="article-content">
                    <p>しばらく更新が空いてしまいましたが、本日は趣向を変えて「クイズ形式」で神社の豆知識をお届けします。全3問、あなたはいくつ正解できるでしょうか？</p>
                    
                    <!-- 第1問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第1問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q1. おみくじを境内の「木」に結ぶ風習。なぜ昔は特に「松の木」に結んでいたのでしょうか？</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, false, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 木の生命力をもらうため
                            </button>
                            <button onclick="handleQuiz(this, true, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 「待つ（松）」にかけて願いを待つため
                            </button>
                            <button onclick="handleQuiz(this, false, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. 悪い運気を鋭い葉で払うため
                            </button>
                        </div>

                        <!-- 解説エリア -->
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「2」</strong>です。<br>
                                江戸時代から続く日本の「言霊（ことだま）」信仰によるものです。良い結果の場合は<strong>「願い事が『待つ（松）』」</strong>ように、悪い結果の場合も<strong>「良い運気が『待つ（松）』」</strong>ように、という願いを込めて、松の木に結ぶようになったと言われています。
                            </div>
                        </div>
                    </div>

                    <!-- 第2問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第2問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q2. おみくじの「有効期限」はいつまでとされているでしょう？</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, false, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 引いてから1週間
                            </button>
                            <button onclick="handleQuiz(this, false, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 大晦日まで（12月31日）
                            </button>
                            <button onclick="handleQuiz(this, true, 2)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. 決まりはない（次に引くまで）
                            </button>
                        </div>

                        <!-- 解説エリア -->
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「3」</strong>です。<br>
                                おみくじに明確な有効期限はありません。一般的には「1年」や「願いが叶うまで」とされていますが、神様からのメッセージが必要だと感じた時が引き時であり、<strong>「次に引いた時が、前のおみくじの区切り」</strong>と考えるのが一般的です。
                            </div>
                        </div>
                    </div>

                    <!-- 第3問 -->
                    <div class="my-8 p-6 bg-gray-50 dark:bg-zinc-800 rounded-xl border-2 border-indigo-200 dark:border-indigo-900">
                        <span class="inline-block bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded mb-2">第3問</span>
                        <h3 class="font-bold text-lg mb-4 text-indigo-700 dark:text-indigo-300">Q3. 「凶」が出た場合、持ち帰るのはマナー違反？</h3>
                        
                        <div class="space-y-3">
                            <button onclick="handleQuiz(this, false, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                1. 絶対に結んで帰るべき
                            </button>
                            <button onclick="handleQuiz(this, true, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                2. 戒めとして持ち帰っても良い
                            </button>
                            <button onclick="handleQuiz(this, false, 1)" class="w-full text-left p-4 rounded-lg bg-white dark:bg-black border border-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 transition font-bold">
                                3. その場で破り捨てるべき
                            </button>
                        </div>

                        <!-- 解説エリア -->
                        <div class="hidden mt-6 pt-4 border-t border-gray-300">
                            <div class="quiz-msg text-xl font-black mb-2"></div>
                            <div class="text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                                <span class="font-bold text-indigo-600">解説：</span><br>
                                正解は<strong>「2」</strong>です。<br>
                                「凶」などの悪い結果が出た場合、境内に結んで悪い運気を浄化してもらうのが一般的ですが、<strong>「自分への戒め（アドバイス）」として持ち帰り、時々読み返すことも推奨されています。</strong><br>
                                破り捨てたり粗末に扱うのはNGですが、大切に保管する分には問題ありません。
                            </div>
                        </div>
                    </div>

                    <p class="mt-8">いかがでしたか？<br>作法を知ると、おみくじがより深いメッセージとして心に響くようになります。ぜひ次回の参拝にお役立てください。</p>
                </div>
            `
        },
        {
            id: 1,
            title: "おみくじの順番（正しい吉凶の順）",
            date: "2026/01/01",
            category: "雑学",
            icon: "bi-list-ol",
            colorClass: "green",
            content: `<div class="article-content"><p>初詣や神社参拝の際に引く「おみくじ」。結果に一喜一憂するのも楽しみの一つですが、その「順位」について正しく理解している人は意外と少ないかもしれません。実は神社やお寺によって解釈が異なる場合があるのですが、一般的に広く知られている順位と、当サイト「運勢・天命乃杜」で採用している伝統的な12段階の順位について詳しく解説します。</p><h3>一般的な7段階の順位</h3><p>多くの神社で採用されている最もポピュラーな順位は以下の通りです。<br><b>大吉 ＞ 吉 ＞ 中吉 ＞ 小吉 ＞ 末吉 ＞ 凶 ＞ 大凶</b><br>あるいは、「吉」の位置が変わり、<b>大吉 ＞ 中吉 ＞ 小吉 ＞ 吉 ＞ 末吉 ＞ 凶 ＞ 大凶</b> とする場合もあります。「吉」は「大吉」に次ぐ良い運勢とする説と、「小吉」と「末吉」の間の中庸な運勢とする説があるのです。</p><h3>当サイトの12段階詳細順位</h3><p>当サイトでは、より細かく運勢を占うため、古来からの伝統に基づいた以下の12段階を採用しています。</p><ol class="list-decimal list-inside space-y-2 ml-4 mb-6 font-bold"><li>大吉 (だいきち)：最高の運気。感謝を忘れずに。</li><li>中吉 (ちゅうきち)：大吉に次ぐ良運。</li><li>小吉 (しょうきち)：ささやかな幸せが続く。</li><li>吉 (きち)：安定した運気。</li><li>半吉 (はんきち)：吉と凶の中間。</li><li>末吉 (すえきち)：末広がりの未来がある。</li><li>末小吉 (すえしょうきち)：今は耐える時だが希望はある。</li><li>凶 (きょう)：運気が停滞気味。慎重に。</li><li>小凶 (しょうきょう)：小さなトラブルに注意。</li><li>半凶 (はんきょう)：半分は凶だが半分は吉に転じる可能性。</li><li>末凶 (すえきょう)：終わりの凶、つまり次は吉へ向かう。</li><li>大凶 (だいきょう)：最も警戒すべき運気。しかしこれ以上落ちない。</li></ol><p>しかし、最も重要なのは順位そのものではありません。おみくじの本質は、そこに書かれている「神様からの和歌や助言」にあります。大吉であっても戒めの言葉があれば気を引き締め、大凶であっても励ましの言葉があれば希望を持つことが大切です。結果に一喜一憂せず、日々の行動指針として活用してください。</p></div>`
        },
        {
            id: 2,
            title: "悪い結果が出ても実は大丈夫？",
            date: "2026/01/01",
            category: "豆知識",
            icon: "bi-cloud-sun",
            colorClass: "green",
            content: `<div class="article-content"><p>おみくじを引いて「凶」や「大凶」が出ると、誰しも気分が落ち込むものです。「今年は良いことがないのではないか」「不吉なことが起こる前兆ではないか」と不安になるかもしれません。しかし、古来より「凶」は必ずしも忌むべきものとはされてきませんでした。むしろ、考え方によっては幸運への入り口とも言えるのです。</p><h3>「凶」は運気の底、これからは上がるのみ</h3><p>陰陽道などの東洋思想では、物事は極まれば反転すると考えます。「大吉」は今が頂点であり、これからは下り坂になる可能性があるため、むしろ慎重な行動を求められます。</p><p>逆に「凶」は、今が運気の底であり、これからは上昇する一方であることを示唆しています。「禍を転じて福となす」という言葉通り、今の困難を乗り越えることで、より大きな幸運をつかむチャンスなのです。凶を引いたということは、これ以上悪くなることはない、つまり「伸びしろしかない」状態であると前向きに捉えましょう。</p><h3>結ぶか、持ち帰るか？</h3><p>悪い結果が出た場合、神社の境内にある「結び所」に結んで帰る風習が一般的です。これには「神様と縁を結ぶ」「悪い運気を神様に預けて浄化してもらう」という意味があります。</p><p>一方で、「戒めとして財布に入れて持ち歩く」という考え方もあります。自分への警告として時々読み返すことで、慎重な行動を心がけ、災いを未然に防ぐことができるからです。</p></div>`
        },
        {
            id: 3,
            title: "神社での正しい参拝マナー",
            date: "2025/12/30",
            category: "作法",
            icon: "bi-person-check-fill",
            colorClass: "green",
            content: `<div class="article-content"><p>神社は神様のお住まいです。初詣や日常の参拝で失礼のないよう、基本的な参拝マナーをおさらいしましょう。作法を知ることで、心も整い、より深い感謝の気持ちを伝えることができます。</p><h3>1. 鳥居をくぐる時</h3><p>鳥居は俗界と神域を分ける結界です。くぐる前には衣服を整え、軽く一礼（一揖）をし、帽子などは取ります。参道の中央（正中）は神様の通り道なので、避けて端を歩くのがマナーです。</p><h3>2. 手水舎での清め方</h3><p>参拝の前に、手水舎（てみずや）で身の穢れを落とします。<br>1. 右手で柄杓を持ち、水を汲んで左手を清める。<br>2. 左手に持ち替え、右手を清める。<br>3. 再び右手に持ち、左手で水を受けて口をすすぐ。<br>4. 左手を再度清め、最後に柄杓を立てて残った水で柄を洗い流す。</p><h3>3. 拝礼（二礼二拍手一礼）</h3><p>お賽銭を入れた後、鈴を鳴らし、姿勢を正します。<br>1. 深く二回お辞儀をする（二礼）。<br>2. 胸の前で両手を合わせ、右手を少し下にずらして二回拍手を打つ（二拍手）。<br>3. 指先を揃えて祈りを捧げる。<br>4. 最後にもう一度深くお辞儀をする（一礼）。</p></div>`
        },
        {
            id: 4,
            title: "「失せ物」の本当の意味",
            date: "2025/12/28",
            category: "豆知識",
            icon: "bi-search",
            colorClass: "green",
            content: `<div class="article-content"><p>おみくじの項目にある「失せ物（うせもの）」。これは単に「落とし物」や「無くした財布」のことだけを指すのではありません。人生において私たちが失ってしまうものは、物理的なモノだけではないからです。</p><h3>形あるもの、形なきもの</h3><p>失せ物には、物理的な物品だけでなく、「失った信頼」「忘れていた初心」「疎遠になった友人」「失恋した相手」「やる気」「健康」など、形のないものも含まれます。今あなたが心の中で「失ってしまった」と感じている欠落感、それこそが「失せ物」の正体かもしれません。</p><h3>言葉の意味</h3><ul class="list-disc ml-5 mb-4"><li><b>「出ず（いでず）」</b>：残念ながら戻ってこない可能性が高いです。諦めて新しいものを探すか、執着を手放すべき時です。</li><li><b>「出る」</b>：見つかります。焦らず探しましょう。</li><li><b>「高いところより出る」</b>：棚の上や、普段見ない高い場所、あるいは目上の人からの連絡で見つかるかもしれません。</li></ul></div>`
        },
        {
            id: 5,
            title: "「待ち人」は恋愛だけじゃない",
            date: "2025/12/25",
            category: "開運",
            icon: "bi-heart",
            colorClass: "green",
            content: `<div class="article-content"><p>「待ち人来ず」と出ると、恋人ができないのかとガッカリする人が多いですが、これは大きな誤解です。おみくじにおける「待ち人」の意味はもっと広く、人生全般に関わるものです。</p><h3>人生を導くキーパーソン</h3><p>おみくじにおける「待ち人」とは、「あなたの人生に良い影響を与えてくれる人」「運命を切り開くきっかけとなる人」全般を指します。それは将来の恋人や結婚相手かもしれませんし、ビジネスパートナー、あるいは人生の師となる先生、一生の親友、もしかすると赤ちゃん（妊娠）のことかもしれません。</p><h3>「来ず」の意味</h3><p>「来ず」とあっても、一生現れないこともあります。「今はまだその時ではない」「自分から動きなさい」というメッセージであることが多いのです。「音信（たより）あり」とあれば、遠くから連絡が来るでしょう。</p></div>`
        }
    ];

// 履歴ページネーション用の状態管理
let historyPageState = {
    page: 1,
    perPage: 100, // 1ページ100件
    filteredData: [] // 現在表示対象となっているデータ（検索結果含む）
};
        

    // ==========================================
    //  ページネーション＆検索機能ロジック
    // ==========================================
    
    // 状態管理 (ページ番号と検索ワード)
    const listState = {
        news: { page: 1, query: '', perPage: 5 },   // ニュースは1ページ5件
        column: { page: 1, query: '', perPage: 6 }  // コラムは1ページ6件
    };

    // 検索ハンドラ
    window.handleSearch = function(type, query) {
        listState[type].query = query.trim().toLowerCase();
        listState[type].page = 1; // 検索時は1ページ目に戻す
        if (type === 'news') renderFullNewsView();
        else renderFullColumnView();
    };

    // ページ切り替えハンドラ
    window.changePage = function(type, newPage) {
        listState[type].page = newPage;
        if (type === 'news') renderFullNewsView();
        else renderFullColumnView();
        
        // ページ上部へスクロール
        const section = document.getElementById(`view-${type}`);
        if(section) section.scrollIntoView({ behavior: 'smooth' });
    };

    // 共通: データのフィルタリングとページ切り出し
    function getPaginatedData(type, sourceData) {
        const state = listState[type];
        
        // 1. 検索フィルタ
        const filtered = sourceData.filter(item => {
            if (!state.query) return true;
            // タイトル、本文、タグなどを検索対象にする
            const searchStr = (item.title + (item.desc || '') + (item.content || '') + (item.tag || '') + (item.category || '')).toLowerCase();
            return searchStr.includes(state.query);
        });

        // 2. ページネーション計算
        const totalItems = filtered.length;
        const totalPages = Math.ceil(totalItems / state.perPage) || 1;
        
        // ページ番号の補正
        if (state.page > totalPages) state.page = totalPages;
        if (state.page < 1) state.page = 1;

        const startIndex = (state.page - 1) * state.perPage;
        const endIndex = startIndex + state.perPage;
        const slicedData = filtered.slice(startIndex, endIndex);

        return { data: slicedData, totalPages, currentPage: state.page, totalItems };
    }

    // 共通: ページネーションボタンのHTML生成 (最初・最後・ジャンプ機能付き)
function createPaginationHTML(type, current, total) {
    if (total <= 1) return ''; 

    let html = '<div class="flex flex-col items-center gap-4 w-full">';
    html += '<div class="flex items-center justify-center flex-wrap gap-2">';
    
    // 最初へ
    html += `<button onclick="changePage('${type}', 1)" 
             class="px-4 py-2 rounded border bg-white dark:bg-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-700 disabled:opacity-50 transition"
             ${current === 1 ? 'disabled' : ''}>
             <i class="bi bi-chevron-double-left"></i> 最初へ</button>`;

    // 前へ
    html += `<button onclick="changePage('${type}', ${current - 1})" 
             class="px-4 py-2 rounded border bg-white dark:bg-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-700 disabled:opacity-50 transition"
             ${current === 1 ? 'disabled' : ''}>
             <i class="bi bi-chevron-left"></i> 前へ</button>`;

    // ページ番号
    html += `<span class="font-bold font-mono mx-4">Page ${current} / ${total}</span>`;

    // 次へ
    html += `<button onclick="changePage('${type}', ${current + 1})" 
             class="px-4 py-2 rounded border bg-white dark:bg-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-700 disabled:opacity-50 transition"
             ${current === total ? 'disabled' : ''}>
             次へ <i class="bi bi-chevron-right"></i></button>`;

    // 最後へ
    html += `<button onclick="changePage('${type}', ${total})" 
             class="px-4 py-2 rounded border bg-white dark:bg-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-700 disabled:opacity-50 transition"
             ${current === total ? 'disabled' : ''}>
             最後へ <i class="bi bi-chevron-double-right"></i></button>`;

    html += '</div>';

    // ページジャンプ入力欄
    html += `
        <div class="flex items-center gap-2 text-sm themed-text-sub">
            <input type="number" id="${type}-jump-input" min="1" max="${total}" value="${current}" 
                   class="w-16 p-1 text-center border rounded themed-input appearance-none" 
                   onkeydown="if(event.key==='Enter') changePage('${type}', parseInt(this.value))">
            <span>/ ${total} ページへ</span>
            <button onclick="changePage('${type}', parseInt(document.getElementById('${type}-jump-input').value))"
                    class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:opacity-80 transition">移動</button>
        </div>
    `;

    html += '</div>';
    return html;
}

    // ==========================================
    //  描画ロジック (一覧・ホーム・詳細)
    // ==========================================


    // 1. ホーム画面のリスト (隙間修正・コンパクト版)
    window.renderHomeLists = function() {
        // 社務所だより（最新4件）
        const newsListEl = document.getElementById('home-news-list');
        if (newsListEl) {
            newsListEl.innerHTML = newsData.slice(0, 4).map(item => `
                <li class="flex justify-between items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-zinc-800 py-2 px-1 transition group" onclick="openArticle('news', ${item.id})">
                    <div class="flex items-center min-w-0 mr-2">
                        <span class="flex-shrink-0 bg-gray-100 dark:bg-zinc-700 px-1.5 py-0.5 rounded text-[10px] mr-2 ${item.tagColor || 'text-gray-600'} font-bold border border-gray-200 dark:border-gray-600">${item.tag}</span>
                        <span class="truncate group-hover:text-blue-600 transition-colors text-sm font-medium">${item.title}</span>
                    </div>
                    <span class="text-[10px] text-gray-400 flex-shrink-0 font-mono">${item.date}</span>
                </li>
            `).join('');
        }

        // 神籤草子（最新5件）
        const columnListEl = document.getElementById('home-column-list');
        if (columnListEl) {
            columnListEl.innerHTML = columnData.slice(0, 5).map(item => `
                <li class="flex justify-between items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-zinc-800 py-2 px-1 transition group" onclick="openArticle('column', ${item.id})">
                    <div class="flex items-center min-w-0 mr-2">
                        <span class="flex-shrink-0 bg-gray-100 dark:bg-zinc-700 px-1.5 py-0.5 rounded text-[10px] mr-2 text-gray-600 dark:text-gray-300 font-bold border border-gray-200 dark:border-gray-600">${item.category}</span>
                        <span class="truncate group-hover:text-green-600 transition-colors text-sm font-medium">${item.title}</span>
                    </div>
                    <span class="text-[10px] text-gray-400 flex-shrink-0 font-mono">${item.date}</span>
                </li>
            `).join('');
        }
    };

    // 2. 「社務所だより」描画関数（モダン・瓦版UI・バリエーション拡張版）
window.renderFullNewsView = function() {
    const container = document.getElementById('view-news-list');
    const pagination = document.getElementById('news-pagination');
    const titleArea = document.querySelector('#view-news h2');
    
    if (!container) return;

    const { data, totalPages, currentPage, totalItems } = getPaginatedData('news', newsData);

    // タイトル横の件数表示
    const countDisplay = listState.news.query 
        ? `<span class="text-sm font-normal ml-3 text-gray-500">Hit: ${totalItems}</span>`
        : `<span class="text-sm font-normal ml-3 text-gray-500">Total: ${newsData.length}</span>`;
    titleArea.innerHTML = `社務所だより ${countDisplay}`;

    if (totalItems === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-10 text-gray-400">
                <i class="bi bi-inbox text-4xl mb-3 opacity-50"></i>
                <p>該当する記事が見つかりませんでした。</p>
            </div>`;
        pagination.innerHTML = '';
        return;
    }

    container.innerHTML = data.map(item => {
        // タグの文字列によるスタイル分岐 (バリエーション強化)
        let tagClass = "tag-info";
        let iconClass = "icon-news-info";
        const t = item.tag; // 短縮

        if (t.includes("重要") || t.includes("障害")) {
            tagClass = "tag-important"; // 赤
            iconClass = "icon-news-alert";
        } 
        else if (t.includes("不具合") || t.includes("バグ")) {
            tagClass = "tag-important"; // 赤
            iconClass = "icon-news-bug";
        }
        else if (t.includes("メンテナンス") || t.includes("システム")) {
            tagClass = "tag-purple";    // 紫
            iconClass = "icon-news-maint";
        }
        else if (t.includes("新機能")) {
            tagClass = "tag-system";    // 黄
            iconClass = "icon-news-star";
        } 
        else if (t.includes("デザイン") || t.includes("意匠") || t.includes("改装")) {
            tagClass = "tag-teal";      // 青緑
            iconClass = "icon-news-design";
        }
        else if (t.includes("解説") || t.includes("規約") || t.includes("技術")) {
            tagClass = "tag-orange";    // 橙
            iconClass = "icon-news-book";
        }
        else if (t.includes("挨拶") || t.includes("イベント")) {
            tagClass = "tag-pink";      // ピンク
            iconClass = "icon-news-flower";
        }
        else if (t.includes("開発") || t.includes("裏話")) {
            tagClass = "tag-green";     // 緑
            iconClass = "icon-news-chat";
        }
        else if (t.includes("更新") || t.includes("機能") || t.includes("改善")) {
            tagClass = "tag-update";    // 青
            iconClass = "icon-news-update";
        }

        return `
            <article class="news-card ${iconClass}" onclick="openArticle('news', ${item.id})">
                <!-- 上部メタ情報 -->
                <div class="news-meta">
                    <span class="news-tag ${tagClass}">${item.tag}</span>
                    <span class="news-date">${item.date}</span>
                </div>
                
                <!-- コンテンツ -->
                <div>
                    <h3 class="news-title">${item.title}</h3>
                    <p class="news-desc">${item.desc || '詳細をご覧ください。'}</p>
                </div>
            </article>
        `;
    }).join('');

    pagination.innerHTML = createPaginationHTML('news', currentPage, totalPages);
};

        
// 3. 「神籤草子」描画関数（モダン・書架UI版）
window.renderFullColumnView = function() {
    const container = document.getElementById('view-column-list');
    const pagination = document.getElementById('column-pagination');
    const titleArea = document.querySelector('#view-column h2');
    
    if (!container) return;

    const { data, totalPages, currentPage, totalItems } = getPaginatedData('column', columnData);

    const countDisplay = listState.column.query 
        ? `<span class="text-sm font-normal ml-3 text-gray-500">Hit: ${totalItems}</span>`
        : `<span class="text-sm font-normal ml-3 text-gray-500">Total: ${columnData.length}</span>`;
    titleArea.innerHTML = `神籤草子 ${countDisplay}`;

    if (totalItems === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-10 text-gray-400">
                <i class="bi bi-journal-x text-4xl mb-3 opacity-50"></i>
                <p>該当するコラムが見つかりませんでした。</p>
            </div>`;
        pagination.innerHTML = '';
        return;
    }

    container.innerHTML = data.map(item => {
        // 色クラスの決定 (colorClassプロパティを利用、なければデフォルト)
        const colorKey = item.colorClass || 'indigo';
        const bgClass = `col-bg-${colorKey}`;
        const lineClass = `c-${colorKey}`;

        return `
            <article class="column-card ${lineClass}" onclick="openArticle('column', ${item.id})">
                <!-- ヘッダー (表紙イメージ) -->
                <div class="column-header ${bgClass}">
                    <i class="bi ${item.icon}"></i>
                </div>
                
                <!-- 本文エリア -->
                <div class="column-body">
                    <div class="column-category">
                        <span>${item.category}</span>
                        <i class="bi bi-bookmark-fill opacity-20"></i>
                    </div>
                    <h3 class="column-title">${item.title}</h3>
                    <div class="column-date">
                        ${item.date}
                    </div>
                </div>
            </article>
        `;
    }).join('');

    pagination.innerHTML = createPaginationHTML('column', currentPage, totalPages);
};


    // 4. 記事詳細表示
    window.openArticle = function(type, id) {
        let item;
        if (type === 'news') item = newsData.find(d => d.id === id);
        else if (type === 'column') item = columnData.find(d => d.id === id);

        if (!item) return;

        const container = document.getElementById('article-detail-content');
        if (container) {
            const headerTitleClass = (type === 'news' && item.tag === '重要') ? 'text-red-600' : '';
            container.innerHTML = `
                <div class="article-header">
                    <h2 class="article-title ${headerTitleClass}">${item.title}</h2>
                    <div class="article-meta">
                        <span>${item.date} ${item.time || ''}</span>
                        ${item.tag ? `<span class="article-tag">${item.tag}</span>` : ''}
                        ${item.category ? `<span class="article-tag">${item.category}</span>` : ''}
                    </div>
                </div>
                <div class="article-content">${item.content}</div>
            `;
            showView('article-detail');
            window.scrollTo(0, 0);
        }
    };

    // 5. クイズ機能ロジック
    window.handleQuiz = function(btn, isCorrect, correctIndex) {
        const optionsArea = btn.parentElement;
        const allBtns = optionsArea.querySelectorAll('button');
        const resultArea = optionsArea.nextElementSibling;
        const msg = resultArea.querySelector('.quiz-msg');

        allBtns.forEach(b => {
            b.disabled = true;
            b.classList.add('opacity-50', 'cursor-not-allowed');
        });

        if (isCorrect) {
            btn.classList.remove('bg-white', 'dark:bg-black', 'border-gray-300', 'opacity-50');
            btn.classList.add('bg-green-100', 'dark:bg-green-900', 'border-green-500', 'text-green-800', 'dark:text-green-100', 'ring-2', 'ring-green-500');
            btn.innerHTML = '<i class="bi bi-circle text-xl mr-2"></i> ' + btn.innerText;
            msg.innerHTML = '<span class="text-green-600"><i class="bi bi-check-circle-fill"></i> 正解！</span>';
        } else {
            btn.classList.remove('bg-white', 'dark:bg-black', 'border-gray-300', 'opacity-50');
            btn.classList.add('bg-red-100', 'dark:bg-red-900', 'border-red-500', 'text-red-800', 'dark:text-red-100');
            btn.innerHTML = '<i class="bi bi-x-lg text-xl mr-2"></i> ' + btn.innerText;
            msg.innerHTML = '<span class="text-red-600"><i class="bi bi-x-circle-fill"></i> 不正解...</span>';
            const correctBtn = allBtns[correctIndex]; 
            if(correctBtn) {
                correctBtn.classList.remove('opacity-50', 'bg-white', 'dark:bg-black', 'border-gray-300');
                correctBtn.classList.add('bg-green-50', 'dark:bg-green-900/30', 'border-green-500', 'font-black', 'text-green-700', 'dark:text-green-300');
                correctBtn.innerHTML = '<i class="bi bi-circle text-xl mr-2"></i> ' + correctBtn.innerText;
            }
        }
        resultArea.classList.remove('hidden');
    };

        // ==========================================
    //  都道府県ランキング機能 (JST 0:00更新・47種長文完全版)
    // ==========================================
    
    const prefecturesList = [
        "北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県",
        "茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県",
        "新潟県","富山県","石川県","福井県","山梨県","長野県","岐阜県",
        "静岡県","愛知県","三重県","滋賀県","京都府","大阪府","兵庫県",
        "奈良県","和歌山県","鳥取県","島根県","岡山県","広島県","山口県",
        "徳島県","香川県","愛媛県","高知県","福岡県","佐賀県","長崎県",
        "熊本県","大分県","宮崎県","鹿児島県","沖縄県"
    ];

    // ランキング生成・描画関数（ダッシュボードUI版）
window.renderPrefectureRanking = function() {
    const listContainer = document.getElementById('prefecture-list');
    const top3Container = document.getElementById('prefecture-top3');
    const dateDisplay = document.getElementById('pref-date-display');
    
    if (!listContainer || !top3Container) return;

    // 日付表示
    const dateStr = getJSTDateString(); 
    if (dateDisplay) {
        const dateParts = dateStr.split('-');
        dateDisplay.innerHTML = `${dateParts[0]}年${dateParts[1]}月${dateParts[2]}日`;
    }

    // 1. データ生成 (47都道府県計算)
    let rankingData = prefecturesList.map((pref, index) => {
        const seed = dateStr + "_" + pref;
        const rng = new SeededRandom(seed);
        const score = Math.floor(rng.next() * 52) + 49;
        
        return {
            name: pref,
            score: score,
            text: generatePrefectureText(pref, score, rng, index)
        };
    });

    // 2. ソート (高得点順)
    rankingData.sort((a, b) => b.score - a.score);

    // 3. 描画 (TOP3とそれ以外に分割)
    const top3Data = rankingData.slice(0, 3);
    const restData = rankingData.slice(3);

    // --- A. TOP3の描画 ---
    // 配列順序を [2位, 1位, 3位] の並びにして、1位を真ん中にする（PC表示時）
    // スマホ(flex-col)では上から順に表示したいので、HTML構造順は 1->2->3 にし、CSS orderで制御も可能だが
    // 今回はシンプルに 1->2->3 の順でDOM生成し、CSSで特別感を出す
    
    let top3Html = '';
    
    // 1位
    top3Html += createTopCard(top3Data[0], 1, 'crown-gold', 'top-rank-1', 'text-yellow-600');
    // 2位
    top3Html += createTopCard(top3Data[1], 2, 'crown-silver', 'top-rank-2', 'text-gray-500');
    // 3位
    top3Html += createTopCard(top3Data[2], 3, 'crown-bronze', 'top-rank-3', 'text-orange-600');

    top3Container.innerHTML = top3Html;

    // --- B. 4位以下の描画 ---
    let listHtml = '';
    restData.forEach((item, index) => {
        const rank = index + 4;
        
        // バーの色判定
        let barClass = "bar-C";
        if (item.score >= 80) barClass = "bar-A";
        else if (item.score >= 60) barClass = "bar-B";

        listHtml += `
            <div class="pref-card-normal">
                <div class="pref-normal-header">
                    <div class="flex items-center gap-3">
                        <span class="pref-rank-badge">${rank}位</span>
                        <span class="font-bold text-lg">${item.name}</span>
                    </div>
                    <span class="pref-score-sm">${item.score}</span>
                </div>
                
                <!-- スコアバー -->
                <div class="pref-bar-bg">
                    <div class="pref-bar-fill ${barClass}" style="width: ${item.score}%;"></div>
                </div>

                <p class="text-xs text-gray-500 dark:text-gray-400 leading-relaxed mt-1 text-justify">
                    ${item.text}
                </p>
            </div>
        `;
    });
    listContainer.innerHTML = listHtml;
};

// ヘルパー関数: TOP3カード生成
function createTopCard(item, rank, iconClass, rankClass, colorClass) {
    return `
        <div class="pref-card-top ${rankClass}">
            <div class="pref-crown ${iconClass}"><i class="bi bi-trophy-fill"></i></div>
            <div class="text-sm font-bold text-gray-400 mb-1">RANK ${rank}</div>
            <div class="pref-name-lg">${item.name}</div>
            <div class="pref-score-lg ${colorClass}">${item.score}</div>
            <div class="pref-text-box">
                ${item.text}
            </div>
        </div>
    `;
}

    // 文章生成ロジック (47種類の長文テンプレートからスコアに応じて選択)
    function generatePrefectureText(prefName, score, rng, index) {
        
        // --- 47種類のベース文章パターン（スコア帯ごとに分割） ---
        
        // Sランク用 (90-100点): 16パターン
        const textsS = [
            `今日の${prefName}は、あたかも天からの祝福を受けているかのような、強烈かつ清らかなエネルギーに満ち溢れています。土地自体が発光しているかのような高い波動を観測でき、この場所に身を置くすべての人に幸運をもたらすでしょう。特に${prefName}内の神社仏閣への参拝は絶大な効果を発揮します。感謝の気持ちを伝えることで、さらなる加護が得られるでしょう。自信を持って行動してください。`,
            `奇跡的な星の配置により、本日の${prefName}は国内で最も「願いが通じやすい」特異点となっています。長年の悩みが嘘のように晴れたり、思いがけない良縁に恵まれたりと、ドラマチックな展開が期待できる一日です。新しいプロジェクトの始動や、大切な人への告白など、人生の重要な決断を下すのにこれ以上ない最適なタイミングです。`,
            `まさに最強の運気です。今日の${prefName}全域において、滞っていた物事が一気に動き出す「開運の風」が吹いています。ビジネス、恋愛、健康、あらゆる面においてポジティブな結果が得られる、稀に見る吉日となるでしょう。この土地の食材を使った料理を食べることで、身体の内側から運気を取り込むことができます。地産地消を心がけてみてください。`,
            `天空のエネルギーが${prefName}の大地に降り注ぎ、住む人の潜在能力を極限まで引き出す一日です。直感が冴え渡り、迷っていた答えが自然と見つかるような感覚を覚えるでしょう。今日は迷わず自分の信じた道を進んでください。その先には、あなたが想像する以上の素晴らしい成果が待っています。`,
            `今日の${prefName}は、黄金の光に包まれたような繁栄の気が漂っています。特に金運や仕事運が絶好調で、過去の努力が形となって返ってくる収穫の時を迎えています。積極的に人と会い、情報を交換することで、さらなるチャンスが舞い込むでしょう。笑顔で過ごすことが、最強の開運アクションです。`,
            `静寂の中にも力強い鼓動を感じる、神聖な一日です。今日の${prefName}は、精神的な成長を促すエネルギーに満ちています。瞑想や読書など、静かに自分と向き合う時間を持つことで、魂が洗われるような体験ができるでしょう。今日得たインスピレーションは、今後の人生を大きく左右する重要な鍵となります。`,
            `まるで生まれ変わったかのような、新鮮で清々しい気が${prefName}を巡っています。過去の失敗や後悔を断ち切り、新たな一歩を踏み出すのに最適な「再生」の日です。新しい服をおろしたり、髪型を変えてみるのも吉。変化を恐れず、新しい自分を表現することで、運気はさらに上昇気流に乗ります。`,
            `愛と調和のエネルギーが${prefName}全土を優しく包み込んでいます。今日は対人運が最高潮で、家族や友人、パートナーとの絆が深まる素晴らしい一日となるでしょう。喧嘩をしていた人も、今日なら素直に仲直りができるはずです。大切な人に「ありがとう」と伝えるだけで、奇跡のような幸せが訪れます。`,
            `情熱と活力が湧き上がる、エネルギッシュな一日です。今日の${prefName}は、スポーツや体を動かすことに最適な「動」の運気に支配されています。汗を流すことで体内の澱みが浄化され、ポジティブな思考がみなぎってくるでしょう。困難な壁も、今のあなたなら勢いで乗り越えることができます。`,
            `知性と創造性がスパークする、クリエイティブな一日です。今日の${prefName}では、芸術的な活動や企画立案において素晴らしい成果が期待できます。美術館や博物館を訪れたり、美しい風景を眺めることで、感性が刺激され、素晴らしいアイデアが降ってくるでしょう。`,
            `今日の${prefName}は、積み重ねてきた努力が報われる「達成」のエネルギーに満ちています。試験や発表、プレゼンテーションなど、勝負事において最高の結果を残せる強運日です。周囲からの評価も高まり、自信に満ちた一日を過ごせるでしょう。胸を張って、堂々と振る舞ってください。`,
            `人と人との縁が結ばれる、出会いの気が${prefName}に集まっています。今日は家に閉じこもらず、積極的に外に出かけるべきです。偶然立ち寄った場所で、生涯の友やパートナーとなる人物と巡り会う可能性があります。直感に従って行動範囲を広げることが、幸運への近道です。`,
            `今日の${prefName}は、すべてがスムーズに流れる「順風満帆」の運気です。信号が青続きだったり、タイミングよく電車に乗れたりと、日常の些細なことでもツイていると感じる場面が多いでしょう。この流れに乗って、普段は躊躇してしまうような大きな目標に挑戦してみるのもおすすめです。`,
            `癒しと浄化の雨（または気）が、${prefName}の疲れを洗い流してくれる日です。今日は無理をせず、自分を甘やかすことで運気が回復します。温泉やスパに行ったり、美味しいものをゆっくり味わったりして、心身のメンテナンスを優先してください。明日への活力が驚くほど湧いてくるはずです。`,
            `今日の${prefName}は、天と地が繋がるようなスピリチュアルなパワーが強まっています。不思議な偶然（シンクロニシティ）が重なり、導かれるように幸運な出来事に遭遇するかもしれません。夢の中で見たことや、ふと思い浮かんだ言葉をメモしておくと、後々重要なメッセージとなるでしょう。`,
            `圧倒的なカリスマ性が宿る日です。今日の${prefName}にいるあなたは、周囲を惹きつける不思議な魅力に溢れています。リーダーシップを発揮したり、人前で話をすることで、多くの賛同や協力を得ることができるでしょう。恐れずに前に出ることで、運命の扉が開かれます。`
        ];

        // Aランク用 (70-89点): 16パターン
        const textsA = [
            `${prefName}の空には穏やかで温かい気が流れており、非常に過ごしやすい一日となりそうです。派手さはありませんが、確実な前進を感じられる安定した良運気に包まれています。${prefName}の自然豊かな場所へ足を運ぶと、心身のリフレッシュ効果が倍増します。深呼吸をして、土地のエネルギーを吸い込みましょう。`,
            `今日の${prefName}は、「調和」と「発展」のエネルギーが活性化しています。人間関係がスムーズに運び、周囲との協力体制が自然と築けるような、心地よい空気が土地全体を覆っています。友人や家族と${prefName}の名所を訪れるのが吉です。会話が弾み、絆がより一層深まる素晴らしい時間を過ごせるはずです。`,
            `活気あふれる一日です。${prefName}の土地が持つ本来のパワーが高まっており、訪れる人のやる気や好奇心を刺激してくれるでしょう。何か新しい発見があるかもしれません。買い物や散策に出かけるのに適しています。以前から欲しかったものが${prefName}のお店で見つかるなど、小さなラッキーが重なる予感です。`,
            `爽やかな風が吹き抜けるような、清々しい運気です。今日の${prefName}では、新しい知識や技術を学ぶのに最適な環境が整っています。図書館や書店に足を運んでみましょう。あなたの知的好奇心を満たす一冊との出会いが、将来の可能性を広げてくれるかもしれません。`,
            `今日の${prefName}は、コツコツと積み重ねることが吉と出る「継続」の運気です。派手な成功よりも、地道な努力が正当に評価される日となります。日々のルーティンを大切にし、丁寧な仕事を心がけることで、周囲からの信頼が厚くなるでしょう。`,
            `美味しい食事にツキがある一日です。今日の${prefName}は「食」に関するエネルギーが高まっています。地元の名産品や、旬の食材を使った料理を味わうことで、身体の底から元気が湧いてきます。親しい人を誘って食事会を開くと、楽しい話題で盛り上がること間違いなしです。`,
            `今日の${prefName}は、整理整頓に適した「清浄」の気が流れています。身の回りを片付けたり、不要なものを手放すことで、運気の通り道がクリアになります。掃除が終わった後のスッキリとした空間で過ごす時間は、何物にも代えがたい幸福感をもたらしてくれるでしょう。`,
            `懐かしい再会や、過去の縁が復活する兆しがあります。今日の${prefName}では、昔の友人や恩師に連絡を取ってみると良いでしょう。思い出話に花が咲き、忘れていた大切な気持ちを思い出すことができるはずです。過去を振り返ることが、未来へのヒントになります。`,
            `今日の${prefName}は、美意識が高まる「芸術」の日です。ファッションやインテリアにこだわってみたり、美術館でアートに触れることで、心が豊かになります。美しいものに囲まれて過ごすことで、あなた自身の魅力も磨かれ、内面から輝きが増していくでしょう。`,
            `心地よいリズムで一日が進んでいきます。今日の${prefName}は、焦らずマイペースに過ごすことが幸運の鍵です。周囲の喧騒に惑わされず、自分の時間を大切にしてください。お気に入りの音楽を聴きながら散歩をするだけで、素晴らしいアイデアが浮かんでくるかもしれません。`,
            `今日の${prefName}は、小さな親切が大きな喜びに変わる「奉仕」の運気です。困っている人に手を差し伸べたり、席を譲ったりする何気ない優しさが、巡り巡ってあなたに幸運をもたらします。${prefName}の街全体が、あなたの優しさを温かく見守っています。`,
            `未来への希望が膨らむ、明るい一日です。今日の${prefName}では、将来の計画を立てたり、夢を語り合うのに適しています。手帳に来年の目標を書き込んでみましょう。この土地の前向きなエネルギーが、あなたの夢を後押ししてくれます。`,
            `今日の${prefName}は、コミュニケーション運が良好です。SNSでの発信や、メールの返信を積極的に行うと良いでしょう。あなたの言葉が誰かの心に響き、素敵な繋がりが生まれるかもしれません。言葉選びを丁寧にすることで、さらに運気がアップします。`,
            `伝統や文化に触れると良い一日です。${prefName}にある古い街並みや史跡を訪ねてみましょう。先人たちの知恵や歴史の重みを感じることで、今の悩みがいかに小さなものか気付かされるはずです。温故知新の精神が、道を開きます。`,
            `今日の${prefName}は、バランス感覚に優れた安定した一日です。仕事とプライベート、ONとOFFの切り替えが上手くいき、充実した時間を過ごせます。どちらかに偏ることなく、中庸を心がけることで、心身ともに健康的な状態を維持できるでしょう。`,
            `予期せぬラッキーハプニングの予感です。今日の${prefName}では、ちょっとしたくじ運や懸賞運が上昇しています。宝くじ売り場を見かけたら、運試しに一枚買ってみるのも面白いかもしれません。ワクワクする気持ちが、さらなる幸運を引き寄せます。`
        ];

        // Bランク用 (49-69点): 15パターン
        const textsB = [
            `今日の${prefName}は、可もなく不可もなく、静寂に包まれたフラットな運気です。劇的な変化は望めませんが、それは逆に言えば「平穏無事」であるという証でもあります。無理に予定を詰め込まず、${prefName}のカフェや公園でゆっくりと読書などをして過ごすのがおすすめです。心の洗濯をしましょう。`,
            `嵐の前の静けさのような、落ち着いた空気が${prefName}を漂っています。外に向かってエネルギーを発散するよりも、内面を見つめ直すのに適した、静的な一日となるでしょう。家の中の掃除や整理整頓を行うと良いでしょう。${prefName}の土地の神様は、清潔な場所を好みます。足元を固める一日としてください。`,
            `エネルギーの波は安定しています。今日の${prefName}では、ルーティンワークや日常の些細な出来事を大切にすることで、運気が徐々に上向いていく傾向にあります。今日は「受け身」の姿勢が吉と出ます。${prefName}の中で起こる出来事に抗わず、流れに身を任せることで、災いを避けることができます。`,
            `少し停滞感を感じるかもしれませんが、焦りは禁物です。今日の${prefName}は「充電」の期間と割り切りましょう。無理に動くと空回りする可能性があります。早めに帰宅して、好きな映画を見たり、趣味に没頭する時間を設けることで、明日への英気を養うことができます。`,
            `今日の${prefName}は、周囲の意見に耳を傾けるべき「傾聴」の日です。自分の主張を通そうとすると摩擦が起きやすいですが、一歩引いて相手を立てることで、物事は円滑に進みます。謙虚な姿勢が、${prefName}でのあなたの評価を高めてくれるでしょう。`,
            `派手な行動は控え、慎重さが求められる一日です。今日の${prefName}では、大きな買い物や契約は避けた方が無難でしょう。石橋を叩いて渡るくらいの慎重さが、トラブルを未然に防ぎます。今日は情報収集に徹し、決断は後日に回すのが賢明です。`,
            `体調管理に気を配りたい日です。${prefName}の気候の変化や、室内の温度差に注意してください。少しでも不調を感じたら、無理をせず休息を取りましょう。身体を温める食事を摂り、十分な睡眠を確保することが、運気回復の鍵となります。`,
            `今日の${prefName}は、過去の整理に適しています。溜まっていた書類を片付けたり、スマホのデータを整理すると良いでしょう。物理的なスペースを空けることで、新しい運気が入ってくる隙間が生まれます。断捨離をするには絶好のタイミングです。`,
            `人間関係において、適度な距離感が大切な一日です。今日の${prefName}では、親しき仲にも礼儀ありを心がけましょう。馴れ合いになりすぎず、相手を尊重する態度を示すことで、無用なトラブルを避けることができます。大人の対応が求められる日です。`,
            `今日の${prefName}は、自然の力に癒やされると良いでしょう。近くの公園や川沿いを散歩するだけで、淀んだ気が浄化されます。コンクリートの建物の中に閉じこもらず、少しでも土や植物に触れる時間を作ってください。自然回帰が運を開きます。`,
            `少し孤独を感じやすい日かもしれません。しかし、それは「自立」を促すサインです。今日の${prefName}では、一人で行動することにツキがあります。一人ランチや一人旅を楽しんでみましょう。誰にも気を使わず、自分だけの時間を満喫することで、心が強くなります。`,
            `今日の${prefName}は、情報の取捨選択が重要です。噂話やフェイクニュースに惑わされないよう、確かな情報源を見極める目を持ってください。${prefName}の図書館や公的な場所で、静かに調べ物をするのが吉です。真実は静寂の中にあります。`,
            `金銭面での引き締めが必要な日です。今日の${prefName}では、衝動買いの誘惑に駆られるかもしれませんが、一度立ち止まって考えましょう。本当に必要なものかどうか自問自答することで、無駄な出費を抑えることができます。財布の紐を固くすることが、未来の豊かさに繋がります。`,
            `今日の${prefName}は、計画の見直しに適しています。進めている物事に無理がないか、一度立ち止まって点検してみましょう。修正すべき点が見つかるかもしれません。急がば回れの精神で、土台をしっかりと固める作業に時間を費やしてください。`,
            `目立たず、縁の下の力持ちに徹することで運が開ける日です。今日の${prefName}では、裏方の作業やサポート役に回るのが良いでしょう。誰かが見ていなくても、あなたの誠実な働きは必ず天に届いています。陰徳を積む一日としてください。`
        ];

        // --- 選択ロジック ---
        
        let selectedText = "";
        
        // スコアに応じて配列を選択
        let targetArray = [];
        if (score >= 90) targetArray = textsS;
        else if (score >= 70) targetArray = textsA;
        else targetArray = textsB;

        // 【重要】47都道府県それぞれに「固定のインデックス」を割り当てる
        // 配列の長さで割った余りを使うことで、ランダム性を保ちつつ
        // "北海道はこれ" "青森はこれ" といった偏りを防ぎ、かつ配列外参照も防ぐ
        // 日付が変われば rng の中身が変わるので、割り当てられる文章も変わる
        
        // index (0-46) を配列長 (15 or 16) で割った余りを使うと、
        // 47都道府県がまんべんなく異なる文章になる。
        // さらに rng.next() を加えて、日によって「どの県がどの文章になるか」をシャッフルする。
        
        const shuffleOffset = Math.floor(rng.next() * targetArray.length);
        const textIndex = (index + shuffleOffset) % targetArray.length;
        
        selectedText = targetArray[textIndex];

        // 最後に一言アドバイスを添える (共通)
        const advice = score >= 90 ? "自信を持って行動してください。" : 
                       score >= 70 ? "笑顔を絶やさず過ごしましょう。" : 
                       "焦らずマイペースを維持してください。";

        return selectedText + " " + advice;
    }

// ==========================================
    //  御守授与所システム (修正版)
    // ==========================================
    const OmamoriSystem = {
        // 願い事データ定義
        types: {
            safety:  { label: "交通安全", color: "#2e7d32", text: "#fff" }, // 緑
            health:  { label: "健康長寿", color: "#00695c", text: "#fff" },   // 深緑
            love:    { label: "良縁成就", color: "#f48fb1", text: "#fff" },   // ピンク
            money:   { label: "金運上昇", color: "#fbc02d", text: "#3e2723" }, // 金
            study:   { label: "学業成就", color: "#1565c0", text: "#fff" }, // 青
            victory: { label: "必勝祈願", color: "#d32f2f", text: "#fff" },    // 赤
            protect: { label: "厄除け",   color: "#212121", text: "#fff" },   // 黒
            success: { label: "大願成就", color: "#7b1fa2", text: "#fff" }  // 紫
        },

        // 祈祷開始
        startPrayer: function(typeKey) {
            document.getElementById('omamori-step-1').classList.add('hidden');
            document.getElementById('omamori-step-2').classList.remove('hidden');
            
            setTimeout(() => {
                this.renderOmamori(typeKey);
            }, 2500);
        },

        // リセット（別の願いを選ぶ）
        reset: function() {
            document.getElementById('omamori-step-1').classList.remove('hidden');
            document.getElementById('omamori-step-2').classList.add('hidden');
            document.getElementById('omamori-step-3').classList.add('hidden');
            document.getElementById('omamori-display').innerHTML = '';
            
            // 上部へスクロール
            const section = document.getElementById('view-omamori');
            if(section) section.scrollIntoView({behavior: 'smooth'});
        },

        // 御守の描画
        renderOmamori: function(typeKey) {
            const data = this.types[typeKey];
            const display = document.getElementById('omamori-display');
            const userName = currentState.user ? currentState.user.username : "天命乃杜";
            
            // 紐（叶結び）のSVGパス（微調整済み）
            const knotSVG = `
                <svg viewBox="0 0 120 90" fill="none" stroke="#f0f0f0" stroke-width="5" stroke-linecap="round" stroke-linejoin="round" style="width:100%; height:100%;">
                    <!-- 結び目本体 -->
                    <path d="M60 15 Q40 35 25 25 T25 50 Q35 65 60 55 Q85 65 95 50 T95 25 Q80 35 60 15 Z" fill="none" />
                    <!-- 垂れる紐 -->
                    <path d="M60 55 V 85" />
                    <!-- 中央の玉 -->
                    <circle cx="60" cy="35" r="6" fill="#f0f0f0" stroke="none" />
                </svg>
            `;

            // 背景色によるマスクの調整（保存時に四角くならないように、CSS疑似要素で角を隠す方式に変更）
            // 保存用には透明度を含む特殊なスタイルを適用
            
            // ★修正: userName を escapeHtml で無害化
        display.innerHTML = `
            <div class="omamori-body" style="background-color: ${data.color};">
                <div class="omamori-texture"></div>
                <div class="omamori-border"></div>
                <div class="omamori-knot">${knotSVG}</div>
                <div class="omamori-label" style="color: #333; font-family: 'Zen Old Mincho', serif;">
                    ${data.label}
                </div>
                <div class="omamori-name">
                    ${escapeHtml(userName)} 拝受
                </div>
            </div>
        `;

        document.getElementById('omamori-step-2').classList.add('hidden');
        document.getElementById('omamori-step-3').classList.remove('hidden');
    },

        // 画像保存（修正版）
        saveImage: function() {
            const target = document.querySelector('.omamori-body'); 
            if(!target) return;
            
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 生成中...';
            btn.disabled = true;

            // 保存前に、角を隠している疑似要素の色を「透過」にするか、
            // 背景色を一時的に透明にして、canvas側で処理させる
            // html2canvasの設定を調整して、角丸をきれいに切り抜く
            
            html2canvas(target, {
                scale: 4, // 高画質
                backgroundColor: null, // 背景透明
                useCORS: true,
                logging: false,
                // 疑似要素（角の切り欠き）が背景色と混ざらないようにする
                onclone: (clonedDoc) => {
                    const clonedBody = clonedDoc.querySelector('.omamori-body');
                    // 保存時は影を消して、きれいな形にする
                    clonedBody.style.boxShadow = 'none';
                    // 疑似要素（切り欠き）を非表示にして、純粋なborder-radiusで形を出す
                    const style = clonedDoc.createElement('style');
                    style.innerHTML = '.omamori-body::before, .omamori-body::after { display: none !important; }';
                    clonedDoc.body.appendChild(style);
                }
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `omamori_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                // 完了アラートは味気ないので削除または控えめに
                // alert("保存しました"); 
            }).catch(e => {
                console.error(e);
                alert("保存に失敗しました。");
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }
    };

        
// --- 認証付きFetchラッパー (Cookie & Header 両対応) ---
async function authFetch(url, options = {}) {
    // デフォルトヘッダー設定
    if (!options.headers) options.headers = {};
    
    // localStorageからトークンを取得してヘッダーに付与
    const token = localStorage.getItem('auth_token');
    if (token) {
        options.headers['Authorization'] = `Bearer ${token}`;
    }

    // Cookie送信用設定
    options.credentials = 'include';

    return fetch(url, options);
}

        
    // ==========================================
//  統合された初期化処理 (window.onload) - 修正版
// ==========================================
// ---------------------------------------------------------------
// 3. 初期化処理 (エラーの原因となっていた checkGoshuin を削除)
// ---------------------------------------------------------------
window.onload = async function() {
    checkMaintenance();
    initHomeAnimation();
    initZodiacSystem();
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme);

    await checkSession();

    startLiveCounter();
    fetchHistoryStats();
    setInterval(fetchHistoryStats, 60000); 
    loadFavorites();

    const url = new URL(window.location);
    if (url.searchParams.has('d')) {
        url.searchParams.delete('d');
        window.history.replaceState({}, '', url);
    }

    BoardSystem.init();

    renderHomeLists();      
    renderFullNewsView();   
    renderFullColumnView();
    
    // ★削除: if (currentState.user) { checkGoshuin(); } 
    // 定義されていない関数を呼ぶとここでスクリプトが止まり、以降の描画が行われません。
};

// ---------------------------------------------------------------
// 2. セッションチェック (エラーの原因となっていた checkGoshuin を削除)
// ---------------------------------------------------------------
async function checkSession() {
    try {
        const res = await authFetch(`${API_BASE}/api/auth/check`, {
            method: 'GET'
        });
        if (res.ok) {
            const data = await res.json();
            if (data.loggedIn) {
                currentState.user = { username: data.username, email: data.email };
                
                // ★削除: checkGoshuin(); (定義されていないためエラーになる)
                
                if (data.token) {
                    localStorage.setItem('auth_token', data.token);
                }

                updateAuthUI();
                loadLabSettings();
                loadMyStats(); // ★追加: ログイン確認直後に統計を読み込む
                console.log("Session restored");
            } else {
                currentState.user = null;
                updateAuthUI();
                loadLabSettings(); 
            }
        }
    } catch (e) {
        console.error("Session check failed", e);
        currentState.user = null;
        updateAuthUI();
    }
}

        // --- 状態管理 ---
        let currentState = {
            view: 'home',
            user: null, // { email, username, token }
            lastResult: null,
            liveCount: 0,
            authMode: 'login' // 'login' or 'register'
        };

        let favoriteList = [];
        let dailyRanking = [];
        let globalHistory = [];
        let personalHistory = [];

        // --- Lab機能の状態管理と詳細設定モーダル (コントロールパネル版) ---
const TenmeiLab = {
    // 各機能の設定定義
    details: {
        newyear: {
            title: "迎春・雅（みやび）モード",
            icon: '<i class="bi bi-flower1 text-yellow-600"></i>',
            desc: "サイト全体のテーマを「紅白」と「金」に変更します。",
            reason: "配色のコントラストが強く、長時間の閲覧は目が疲れる可能性があります。",
            bgClass: "bg-yellow-100",
            // 詳細設定項目
            configs: [
                { id: 'active', type: 'switch', label: '機能を有効にする', sub: '迎春テーマを適用します' },
                // ※CSS側での実装が複雑なため、今回はON/OFFのみとします
            ]
        },
        speed: {
            title: "神速（しんそく）の祈り",
            icon: '<i class="bi bi-lightning-charge-fill text-blue-600"></i>',
            desc: "おみくじのカウントダウン演出を省略します。",
            reason: "おみくじの情緒が損なわれるため、UXの観点から非推奨としています。",
            bgClass: "bg-blue-100",
            configs: [
                { id: 'active', type: 'switch', label: '機能を有効にする', sub: 'カウントダウンをスキップ' }
            ]
        },
        dark: {
            title: "宵闇（よいやみ）の刻",
            icon: '<i class="bi bi-moon-stars-fill text-purple-600"></i>',
            desc: "強制的にダークモードを適用します。",
            reason: "一部の古い端末で画面切り替え時にチラつきが発生する場合があります。",
            bgClass: "bg-purple-100",
            configs: [
                { id: 'active', type: 'switch', label: '機能を有効にする', sub: '常時ダークモードを適用' }
            ]
        },
        bigtext: {
            title: "言霊（ことだま）の増幅",
            icon: '<i class="bi bi-type-h1 text-green-600"></i>',
            desc: "文字サイズを大きくし、視認性を高めます。",
            reason: "画面幅によってはレイアウト崩れや文字のはみ出しが発生します。",
            bgClass: "bg-green-100",
            // ★スライダー設定を追加
            configs: [
                { id: 'active', type: 'switch', label: '機能を有効にする', sub: '文字サイズ拡大を適用' },
                { 
                    id: 'scale', type: 'range', label: '拡大率', sub: '基準サイズに対する倍率',
                    min: 110, max: 150, step: 5, unit: '%', default: 120, cssVar: '--lab-font-scale'
                }
            ]
        },
        mist: {
            title: "幽玄（ゆうげん）の霧",
            icon: '<i class="bi bi-cloud-haze2-fill text-gray-600"></i>',
            desc: "画面全体に流れる霧のアニメーションを表示します。",
            reason: "GPU負荷が高く、バッテリー消費が増加する可能性があります。",
            bgClass: "bg-gray-100",
            // ★スライダー設定を追加
            configs: [
                { id: 'active', type: 'switch', label: '機能を有効にする', sub: '霧エフェクトを表示' },
                { 
                    id: 'opacity', type: 'range', label: '霧の濃さ', sub: '画面の見やすさに影響します',
                    min: 0.1, max: 1.0, step: 0.1, unit: '', default: 0.6, cssVar: '--lab-mist-opacity'
                },
                { 
                    id: 'speed', type: 'range', label: '流れる速さ', sub: '秒数（小さいほど速い）',
                    min: 10, max: 60, step: 5, unit: 's', default: 30, cssVar: '--lab-mist-speed', inverse: true 
                }
            ]
        },
        gold: {
            title: "黄金（おうごん）の神域",
            icon: '<i class="bi bi-stars text-yellow-500"></i>',
            desc: "アクセントカラーを「黄金」に変更します。",
            reason: "白背景では文字が読みづらくなる場合があります。",
            bgClass: "bg-yellow-50",
            configs: [
                { id: 'active', type: 'switch', label: '機能を有効にする', sub: '黄金テーマを適用' }
            ]
        }
    },

    // 現在の設定値を保持するオブジェクト
    currentSettings: {},

    // 初期化（localStorageから読み込み）
    init: function() {
        const stored = localStorage.getItem('tenmei_lab_detailed_config');
        if (stored) {
            try {
                this.currentSettings = JSON.parse(stored);
            } catch(e) { this.currentSettings = {}; }
        }
        // CSS変数の適用
        this.applyAllCSS();
    },

    // 設定保存
    save: function() {
        localStorage.setItem('tenmei_lab_detailed_config', JSON.stringify(this.currentSettings));
        // ここでクラウド同期などを呼んでも良い
    },

    // 全CSS変数の適用（ロード時など）
    applyAllCSS: function() {
        const root = document.documentElement;
        Object.keys(this.details).forEach(key => {
            const configs = this.details[key].configs;
            configs.forEach(conf => {
                if (conf.cssVar) {
                    const savedVal = this.getVal(key, conf.id, conf.default);
                    // inverseフラグがある場合（秒数など）、UIとは逆のロジックが必要ならここで処理
                    // 今回はそのまま適用
                    let val = savedVal;
                    if(conf.unit) val += conf.unit;
                    root.style.setProperty(conf.cssVar, val);
                }
            });
        });
    },

    // 値の取得ヘルパー
    getVal: function(key, configId, def) {
        if (this.currentSettings[key] && this.currentSettings[key][configId] !== undefined) {
            return this.currentSettings[key][configId];
        }
        return def;
    },

    // 値の設定ヘルパー
    setVal: function(key, configId, val) {
        if (!this.currentSettings[key]) this.currentSettings[key] = {};
        this.currentSettings[key][configId] = val;
        this.save();
    },

    // スイッチ類の実処理（メインスイッチ用）
    toggleFeature: function(key, isActive) {
        // UIのメインスイッチも同期
        const mainSwitch = document.getElementById(`switch-${key}`);
        if(mainSwitch) mainSwitch.checked = isActive;

        // 既存のトグル関数を呼び出し（互換性維持）
        if(key === 'newyear') this.toggleNewYear({checked: isActive});
        if(key === 'speed') this.toggleSpeed({checked: isActive});
        if(key === 'dark') this.toggleDark({checked: isActive});
        if(key === 'bigtext') this.toggleBigText({checked: isActive});
        if(key === 'mist') this.toggleMist({checked: isActive});
        if(key === 'gold') this.toggleGold({checked: isActive});
        
        // 設定保存
        this.setVal(key, 'active', isActive);
    },

    // --- 既存のトグル関数群 (そのまま維持) ---
    toggleNewYear: (el) => {
        if(el.checked) document.body.classList.add('theme-newyear');
        else document.body.classList.remove('theme-newyear');
        saveLabSettings(); // クラウド同期
    },
    toggleSpeed: (el) => {
        window.labSpeedMode = el.checked;
        saveLabSettings();
    },
    toggleDark: (el) => {
        saveLabSettings();
        applyTheme(); 
    },
    toggleBigText: (el) => {
        if(el.checked) document.documentElement.classList.add('lab-big-text');
        else document.documentElement.classList.remove('lab-big-text');
        saveLabSettings();
    },
    toggleMist: (el) => {
        const container = document.getElementById('mist-container');
        if(!container) return;
        if(el.checked) container.classList.add('active');
        else container.classList.remove('active');
        saveLabSettings();
    },
    toggleGold: (el) => {
        if(el.checked) document.body.classList.add('theme-gold');
        else document.body.classList.remove('theme-gold');
        saveLabSettings();
    },

    // --- 詳細設定モーダルの表示 (UI構築) ---
    openModal: (key) => {
        const data = TenmeiLab.details[key];
        if(!data) return;
        
        const content = document.getElementById('lab-modal-content');
        
        // メインスイッチの状態確認
        const mainSwitch = document.getElementById(`switch-${key}`);
        const isActive = mainSwitch ? mainSwitch.checked : false;

        // 設定項目のHTML生成
        let configHtml = '';
        if (data.configs) {
            configHtml = data.configs.map(conf => {
                // 値の取得
                let currentVal = TenmeiLab.getVal(key, conf.id, conf.default);
                
                // A. スイッチの場合 (activeは特別扱い)
                if (conf.id === 'active') {
                    // メインスイッチの状態を優先
                    currentVal = isActive;
                    return `
                        <div class="lab-setting-row">
                            <div class="lab-setting-label">
                                ${conf.label}
                                <span class="lab-setting-sub">${conf.sub}</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" ${currentVal ? 'checked' : ''} 
                                    onchange="TenmeiLab.handleConfigChange('${key}', '${conf.id}', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                    `;
                }
                
                // B. スライダーの場合
                if (conf.type === 'range') {
                    return `
                        <div class="lab-setting-row">
                            <div class="lab-setting-label">
                                ${conf.label}
                                <span class="lab-setting-sub">${conf.sub}</span>
                            </div>
                            <div class="lab-slider-container">
                                <input type="range" class="lab-range-input" 
                                    min="${conf.min}" max="${conf.max}" step="${conf.step}" value="${currentVal}"
                                    oninput="TenmeiLab.handleConfigChange('${key}', '${conf.id}', this.value, '${conf.unit}', '${conf.cssVar}')">
                                <span class="lab-val-display" id="val-${key}-${conf.id}">${currentVal}${conf.unit}</span>
                            </div>
                        </div>
                    `;
                }
                return '';
            }).join('');
        }
        
        content.innerHTML = `
            <div class="flex flex-col items-center text-center">
                <!-- ヘッダー -->
                <div class="w-16 h-16 rounded-full ${data.bgClass} flex items-center justify-center text-3xl mb-4 shadow-sm">
                    ${data.icon}
                </div>
                <h3 class="text-2xl font-bold mb-2 text-gray-800 dark:text-gray-100">${data.title}</h3>
                <p class="text-sm text-gray-500 mb-6 font-bold">詳細設定パネル</p>
                
                <!-- 説明文 -->
                <div class="text-gray-600 dark:text-gray-300 text-sm text-left w-full bg-gray-50 dark:bg-zinc-800 p-4 rounded-xl border border-gray-100 dark:border-gray-700 mb-6">
                    ${data.desc}
                    <div class="mt-2 text-xs text-red-500 flex items-start gap-1">
                        <i class="bi bi-exclamation-circle-fill mt-0.5"></i>
                        <span>${data.reason}</span>
                    </div>
                </div>

                <!-- 設定コントロール (ここがメイン) -->
                <div class="w-full bg-white dark:bg-black/20 p-2 rounded-xl border border-gray-200 dark:border-gray-700 mb-6">
                    ${configHtml}
                </div>

                <div class="w-full">
                    <button onclick="TenmeiLab.closeModal(null)" class="btn-primary w-full py-3 shadow-lg">
                        <i class="bi bi-check2"></i> 設定を完了する
                    </button>
                </div>
            </div>
        `;
        const modal = document.getElementById('lab-modal');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    },

    // 設定変更時のハンドラ（リアルタイム反映）
    handleConfigChange: (key, configId, value, unit = '', cssVar = null) => {
        // 1. 値の保存
        TenmeiLab.setVal(key, configId, value);

        // 2. 数値表示の更新 (スライダーの場合)
        const displayEl = document.getElementById(`val-${key}-${configId}`);
        if(displayEl) displayEl.textContent = value + unit;

        // 3. 動作の反映
        if (configId === 'active') {
            // メインスイッチ切り替え
            TenmeiLab.toggleFeature(key, value);
        } else if (cssVar) {
            // CSS変数の更新
            const root = document.documentElement;
            root.style.setProperty(cssVar, value + unit);
        }
    },

    closeModal: (e) => {
        if (e && e.target.id !== 'lab-modal' && !e.target.classList.contains('lab-close-btn') && e.target.tagName !== 'BUTTON') return;
        document.getElementById('lab-modal').classList.remove('active');
        document.body.style.overflow = '';
    }
};

// 初期化実行 (window.onload内で呼ぶため)
TenmeiLab.init();

        // --- 追加: テーマ適用ロジック（OS設定とLab設定の統合） ---
        function applyTheme() {
            let userSettings = null;
            if (currentState.user) {
                try {
                    userSettings = JSON.parse(localStorage.getItem(`lab_settings_${currentState.user.email}`));
                } catch(e) {}
            }

            // 「宵闇の刻」がONかどうか
            const forceDark = userSettings ? userSettings.dark : false;
            
            // OSがダークモードかどうか
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            // スイッチON または (スイッチOFFかつOSがダーク) の場合に dark クラスを付与
            if (forceDark || systemDark) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }

            // スイッチの見た目同期（ログイン時のみ）
            const switchDark = document.getElementById('switch-dark');
            if(switchDark && userSettings) {
                switchDark.checked = forceDark;
            }
        }

        // ==========================================
    //  TENMEI Labs 設定同期ロジック (サーバー連携版)
    // ==========================================

    // 1. 設定を保存する関数 (クラウド+ローカル)
    async function saveLabSettings() {
        const settings = {
            newyear: document.getElementById('switch-newyear').checked,
            speed: document.getElementById('switch-speed').checked,
            dark: document.getElementById('switch-dark').checked,
            bigtext: document.getElementById('switch-bigtext').checked,
            mist: document.getElementById('switch-mist').checked,
            gold: document.getElementById('switch-gold').checked
        };

        if (currentState.user) {
            // ログイン中：サーバー(KV)と同期
            localStorage.setItem(`lab_settings_${currentState.user.email}`, JSON.stringify(settings));
            
            try {
                // ★修正: authFetchに変更
                const res = await authFetch(`${API_BASE}/api/user/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        settings: settings
                    })
                });
                if(!res.ok) throw new Error("Sync Failed");
                console.log("Labs設定をクラウドに保存しました");
            } catch (e) {
                console.error("Labs設定のクラウド同期に失敗しました", e);
            }
        } else {
            // 未ログイン：ゲスト用としてローカルのみ保存
            localStorage.setItem('lab_settings_guest', JSON.stringify(settings));
        }
    }

// 2. 設定を読み込み、UIに反映させる関数
    async function loadLabSettings() {
        let settings = null;

        if (currentState.user) {
            // ログイン中：サーバーから最新設定を取得
            try {
                // ★修正: authFetchに変更
                const res = await authFetch(`${API_BASE}/api/user/settings`, {
                    method: 'GET'
                });
                if (res.ok) {
                    const data = await res.json();
                    settings = data.settings;
                    if(settings) localStorage.setItem(`lab_settings_${currentState.user.email}`, JSON.stringify(settings));
                }
            } catch (e) {
                console.error("サーバーからの設定取得に失敗しました。ローカルデータを使用します。", e);
                const local = localStorage.getItem(`lab_settings_${currentState.user.email}`);
                if(local) settings = JSON.parse(local);
            }
        } else {
            // 未ログイン：ローカルから取得
            const local = localStorage.getItem('lab_settings_guest');
            if(local) settings = JSON.parse(local);
        }

        // --- UI（スイッチ）とクラスの反映 ---
        if (settings) {
            const swNewYear = document.getElementById('switch-newyear');
            if(swNewYear) swNewYear.checked = !!settings.newyear;
            if(settings.newyear) document.body.classList.add('theme-newyear');
            else document.body.classList.remove('theme-newyear');

            const swSpeed = document.getElementById('switch-speed');
            if(swSpeed) swSpeed.checked = !!settings.speed;
            window.labSpeedMode = !!settings.speed;

            const swBigText = document.getElementById('switch-bigtext');
            if(swBigText) swBigText.checked = !!settings.bigtext;
            if(settings.bigtext) document.documentElement.classList.add('lab-big-text');
            else document.documentElement.classList.remove('lab-big-text');

            const swMist = document.getElementById('switch-mist');
            const mistContainer = document.getElementById('mist-container');
            if(swMist) swMist.checked = !!settings.mist;
            if(settings.mist && mistContainer) mistContainer.classList.add('active');
            else if(mistContainer) mistContainer.classList.remove('active');

            const swGold = document.getElementById('switch-gold');
            if(swGold) swGold.checked = !!settings.gold;
            if(settings.gold) document.body.classList.add('theme-gold');
            else document.body.classList.remove('theme-gold');

            const swDark = document.getElementById('switch-dark');
            if(swDark) swDark.checked = !!settings.dark;
        } else {
            document.body.classList.remove('theme-newyear', 'theme-gold');
            document.documentElement.classList.remove('lab-big-text');
            const mistContainer = document.getElementById('mist-container');
            if(mistContainer) mistContainer.classList.remove('active');
            window.labSpeedMode = false;
        }

        applyTheme();
    }
        
        // --- window.onload への追加修正 ---
        window.onload = function() {
            initHomeAnimation();
            initZodiacSystem();
            
            const storedUser = localStorage.getItem('omikuji_user');
            if(storedUser) {
                try {
                    currentState.user = JSON.parse(storedUser);
                } catch(e) {
                    console.error("Auth Data Parse Error", e);
                }
            }
            updateAuthUI();
            
            // ▼▼▼ ここに追加 ▼▼▼
            TenmeiLab.init(); // 詳細設定（スライダー値など）の初期化
            // ▲▲▲ 追加ここまで ▲▲▲
            
            loadLabSettings(); // ここで applyTheme が呼ばれます

            // OSのダークモード切り替えをリアルタイム検知して反映するリスナーを追加
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                applyTheme();
            });

            // ==========================================
    //  クイズ機能用ロジック (3問対応版)
    // ==========================================
    // btn: クリックされたボタン要素
    // isCorrect: 正解かどうか (true/false)
    // correctIndex: 選択肢の中で正解のボタンは何番目か (0, 1, 2... 上から順)
    window.handleQuiz = function(btn, isCorrect, correctIndex) {
        // ボタンの親要素（選択肢コンテナ）を取得
        const optionsArea = btn.parentElement;
        // そのコンテナ内の全ボタンを取得
        const allBtns = optionsArea.querySelectorAll('button');
        // 解説エリアを取得（選択肢コンテナの次にある要素）
        const resultArea = optionsArea.nextElementSibling;
        const msg = resultArea.querySelector('.quiz-msg');

        // 全ボタン無効化（連打防止）
        allBtns.forEach(b => {
            b.disabled = true;
            b.classList.add('opacity-50', 'cursor-not-allowed');
        });

        // 判定演出
        if (isCorrect) {
            btn.classList.remove('bg-white', 'dark:bg-black', 'border-gray-300', 'opacity-50');
            btn.classList.add('bg-green-100', 'dark:bg-green-900', 'border-green-500', 'text-green-800', 'dark:text-green-100', 'ring-2', 'ring-green-500');
            
            // 丸アイコンを追加
            const originalText = btn.innerText;
            btn.innerHTML = '<i class="bi bi-circle text-xl mr-2"></i> ' + originalText;
            
            msg.innerHTML = '<span class="text-green-600"><i class="bi bi-check-circle-fill"></i> 正解！</span>';
        } else {
            btn.classList.remove('bg-white', 'dark:bg-black', 'border-gray-300', 'opacity-50');
            btn.classList.add('bg-red-100', 'dark:bg-red-900', 'border-red-500', 'text-red-800', 'dark:text-red-100');
            
            // バツアイコンを追加
            const originalText = btn.innerText;
            btn.innerHTML = '<i class="bi bi-x-lg text-xl mr-2"></i> ' + originalText;

            msg.innerHTML = '<span class="text-red-600"><i class="bi bi-x-circle-fill"></i> 不正解...</span>';
            
            // 正解のボタンを強調表示してあげる（答え合わせ）
            const correctBtn = allBtns[correctIndex]; 
            if(correctBtn) {
                correctBtn.classList.remove('opacity-50', 'bg-white', 'dark:bg-black', 'border-gray-300');
                correctBtn.classList.add('bg-green-50', 'dark:bg-green-900/30', 'border-green-500', 'font-black', 'text-green-700', 'dark:text-green-300');
                correctBtn.innerHTML = '<i class="bi bi-circle text-xl mr-2"></i> ' + correctBtn.innerText;
            }
        }

        // 解説を表示
        resultArea.classList.remove('hidden');
    };

            startLiveCounter();
            fetchHistoryStats();
            setInterval(fetchHistoryStats, 60000); 
            
            loadFavorites();

            const url = new URL(window.location);
            if (url.searchParams.has('d')) {
                url.searchParams.delete('d');
                window.history.replaceState({}, '', url);
            }
             // ▼ 今回の追加箇所 ▼
    renderHomeLists();
    renderFullNewsView();
    renderFullColumnView();
        };

        // ■ 入力式クイズの判定関数
// button: クリックされたボタン要素
// correctAnswers: 正解の文字列リスト（配列）例: ['鳥居', 'とりい']
// questionId: 問題番号（入力欄の特定に使用）
function handleInputQuiz(button, correctAnswers, questionId) {
    // 入力欄を取得
    const inputField = button.parentElement.querySelector('input');
    const userValue = inputField.value.trim(); // 空白除去
    
    // 結果表示エリアを取得
    const parent = button.closest('.my-8'); // 親コンテナを探す
    const resultArea = parent.querySelector('.quiz-result');
    const msgArea = resultArea.querySelector('.quiz-msg');
    
    // すでに回答済みなら処理しない（連打防止）
    if (!resultArea.classList.contains('hidden') && resultArea.dataset.answered === "true") {
        return;
    }

    // 正誤判定（ひらがな・カタカナ・漢字の完全一致を確認）
    // ユーザーの入力を正規化（全角・半角などを揃える処理を入れても良いが、今回は単純比較）
    const isCorrect = correctAnswers.some(ans => ans === userValue);

    // 結果表示
    resultArea.classList.remove('hidden');
    resultArea.dataset.answered = "true"; // 回答済みフラグ
    
    if (isCorrect) {
        msgArea.innerHTML = '<span class="text-green-600">正解！</span>';
        msgArea.classList.add('text-green-600');
        // 入力欄を正解色に
        inputField.classList.add('border-green-500', 'bg-green-900', 'text-green-100');
        inputField.classList.remove('bg-gray-800');
    } else {
        msgArea.innerHTML = '<span class="text-red-500">残念...</span>';
        msgArea.classList.add('text-red-500');
        // 入力欄を不正解色に
        inputField.classList.add('border-red-500', 'bg-red-900', 'text-red-100');
        inputField.classList.remove('bg-gray-800');
    }
    
    // 入力欄を無効化（書き換え防止）
    inputField.disabled = true;
    button.disabled = true;
    button.classList.add('opacity-50', 'cursor-not-allowed');
    button.innerText = '回答済み';
}

        // ローディング表示関数 (完全修正版)
// タイムアウトやクリック制限を撤廃し、純粋に表示/非表示を切り替える
function showLoading(show) {
    const overlay = document.getElementById('loading-overlay');
    if (!overlay) return;

    if (show) {
        overlay.style.display = 'flex';
        // 即座にフェードイン
        requestAnimationFrame(() => overlay.classList.add('visible'));
    } else {
        overlay.classList.remove('visible');
        // フェードアウト後に非表示
        setTimeout(() => {
            if (!overlay.classList.contains('visible')) {
                overlay.style.display = 'none';
            }
        }, 300);
    }
}

        function showView(viewId) {
            // Lab機能へのアクセス制限処理
            if(viewId === 'lab') {
                const lock = document.getElementById('lab-lock');
                const wrapper = document.getElementById('lab-content-wrapper');
                
                if(!currentState.user) {
                    lock.classList.remove('hidden');
                    wrapper.classList.add('lab-blurred');
                } else {
                    lock.classList.add('hidden');
                    wrapper.classList.remove('lab-blurred');
                }
            }

            // 画面の切り替え（フェードアニメーション）
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
                setTimeout(() => {
                    if(!el.classList.contains('active')) el.style.display = 'none';
                }, 500);
            });
            
            const target = document.getElementById(`view-${viewId}`);
            if (target) {
                target.style.display = 'block';
                void target.offsetWidth; 
                target.classList.add('active');
            }
            currentState.view = viewId;

            // --- 各ビューごとの初期化ロジック ---
            if(viewId === 'draw') {
                resetOmikujiPool();
            }
            if(viewId === 'history') {
                loadHistory();
            }
            // ▼ ここが重要：都道府県ランキングの呼び出し
            if(viewId === 'prefecture') {
                renderPrefectureRanking();
            }
            // 各ビューごとの初期化ロジック (showView関数内に追加)
        if(viewId === 'omamori') {
            document.getElementById('omamori-step-1').classList.remove('hidden');
            document.getElementById('omamori-step-2').classList.add('hidden');
            document.getElementById('omamori-step-3').classList.add('hidden');
            }
        }
        function articleBack() {
            showView('home'); 
        }

        // --- ホームアニメーション (ランダム性・多様性強化版) ---
        function initHomeAnimation() {
            const container = document.getElementById('home-anim-container');
            container.innerHTML = ''; 
            const paperCount = 70; // 枚数
            
            // 縁起の良い二字熟語リスト（大幅増量）
            const texts = [
                "天命", "御籤", "運勢", "吉凶", "祈願", "成就", "開運", "吉祥", 
                "招福", "平安", "健康", "繁栄", "飛躍", "安泰", "円満", "厄除",
                "大吉", "守護", "浄化", "良縁", "金運", "必勝", "合格", "福徳",
                "神恩", "感謝", "希望", "光明", "泰平", "至福", "瑞兆", "吉兆"
            ];
            
            for(let i=0; i<paperCount; i++) {
                const paper = document.createElement('div');
                paper.className = 'flying-paper';
                
                // 位置のランダム化
                const leftPos = Math.random() * 270;
                paper.style.left = leftPos + 'px';
                
                // ★修正: アニメーション開始時間を大幅にずらす (-15秒〜0秒)
                // これにより、ページを開いた瞬間から「すでにバラバラに飛んでいる」状態を作る
                const delay = (Math.random() * -15) + 's';
                const duration = (4 + Math.random() * 6) + 's'; // 4〜10秒で速度差をつける
                
                paper.style.animationDelay = delay;
                paper.style.animationDuration = duration;
                
                // サイズも微妙に変える
                const scale = 0.7 + Math.random() * 0.5;
                paper.style.transform = `scale(${scale})`;
                
                paper.textContent = texts[Math.floor(Math.random() * texts.length)];
                
                container.appendChild(paper);
            }
        }

        // --- ライブカウンター (API連携) ---
        function startLiveCounter() {
            const el = document.getElementById('live-counter');
            const timeEl = document.getElementById('counter-time');
            
            fetchCount();
            setInterval(fetchCount, 60000);

            async function fetchCount() {
                const now = new Date();
                timeEl.textContent = now.toLocaleTimeString();
                try {
                    const res = await fetch(`${API_BASE}/api/counter`);
                    if(res.ok) {
                        const data = await res.json();
                        // サーバーの値をそのまま表示
                        currentState.liveCount = (data.count || 0);
                        el.textContent = currentState.liveCount.toLocaleString() + "本";
                    }
                } catch(e) { console.error(e); }
            }
        }

        // 修正版 fetchHistoryStats
async function fetchHistoryStats() {
    try {
        const res = await fetch(`${API_BASE}/api/stats`);
        if(res.ok) {
            const data = await res.json();
            
            // 更新時刻
            const timeStr = data.timestamp || "--:--:--";
            const timeEl = document.getElementById('stats-update-time');
            if(timeEl) timeEl.textContent = timeStr;

            const stats = data.stats || {};
            const total = data.total || 1; 

            // ★修正: ホーム用(stat-*)と履歴用(hist-stat-*)の両方を更新するヘルパー
            const updateBoth = (key, percentage, count) => {
                const p = parseFloat(percentage).toFixed(2);
                const countStr = (count || 0).toLocaleString() + "本";
                
                // ホーム用
                const elStat = document.getElementById(`stat-${key}`);
                const elCnt = document.getElementById(`cnt-${key}`);
                const elBar = document.getElementById(`bar-${key}`);
                if(elStat) elStat.textContent = p + "%";
                if(elCnt) elCnt.textContent = countStr;
                if(elBar) elBar.style.width = p + "%";

                // 履歴画面用 (hist-プレフィックス)
                const histStat = document.getElementById(`hist-stat-${key}`);
                const histCnt = document.getElementById(`hist-cnt-${key}`);
                const histBar = document.getElementById(`hist-bar-${key}`);
                if(histStat) histStat.textContent = p + "%";
                if(histCnt) histCnt.textContent = countStr;
                if(histBar) histBar.style.width = p + "%";
            };

            const keys = [
                'daikichi', 'chukichi', 'shokichi', 'kichi', 'hankichi', 'suekichi', 'sueshokichi',
                'kyo', 'shokyo', 'hankyo', 'suekyo', 'daikyo'
            ];
            
            keys.forEach(key => {
                const count = stats[key] || 0;
                const percentage = (count / total) * 100;
                updateBoth(key, percentage, count);
            });
        }
    } catch(e) { 
        console.error("Stats update failed:", e); 
    }
}
        
        // --- おみくじロジック (画像風・敷き詰めレイアウト版) ---
        function startOmikuji() {
            showView('draw');
        }

        function resetOmikujiPool() {
            const pool = document.getElementById('omikuji-pool');
            pool.innerHTML = '';
            // 最初は画面を埋めるくらい多めに生成
            addOmikujiBatch(40, true); 
        }

        function addOmikuji() {
            addOmikujiBatch(20, false);
            // Flexboxレイアウトなので、追加すれば自動的に下に伸びる
            // 少しだけスクロールして追加されたことを気付かせる
            window.scrollBy({ top: 200, behavior: 'smooth' });
        }

        function addOmikujiBatch(count, isInitial) {
            const pool = document.getElementById('omikuji-pool');
            
            for(let i=0; i<count; i++) {
                const stick = document.createElement('div');
                stick.className = 'omikuji-stick';
                
                // デザイン構成: アイコン、メイン文字、サイト名
                // アイコンは結果画面と同じ bi-flower1 を使用
                stick.innerHTML = `
                    <div class="stick-icon"><i class="bi bi-flower1"></i></div>
                    <div class="stick-text">おみくじ</div>
                    <div class="stick-footer">天命乃杜</div>
                `;
                
                // ランダムな傾き (±6度程度で自然に)
                const rot = Math.random() * 12 - 6; 
                
                // 回転を適用
                stick.style.transform = `rotate(${rot}deg)`;
                
                // アニメーション適用 (margin-topを操作するものに変更したため、transform: rotate が消えない)
                stick.style.animation = `fadeInStickMargin 0.6s ease-out forwards ${i * 0.03}s`;
                
                stick.onclick = function() {
                    drawResult(this);
                };
                
                pool.appendChild(stick);
            }
        }

        // 12種類のおみくじ結果定義
        const omikujiResults = [
            { type: "大吉", rank: 5, poem: "枯れ果てし 枝に再び 花咲くが如し", desc: "最高の運気です。長年の努力が報われ、枯れ木に花が咲くような喜びが訪れるでしょう。しかし慢心は禁物。感謝の心を忘れずに。" },
            { type: "中吉", rank: 4, poem: "照る月を 雲が隠せど 風払うなり", desc: "一時的な迷いがあっても、すぐに晴れ間が見えます。自分の信念を貫くことで、雲を払う風のような助けが現れるはずです。" },
            { type: "小吉", rank: 3, poem: "小川の水 淀まず流るる 様を見るべし", desc: "派手さはありませんが、平穏無事な日々が続きます。日々の小さな幸せを大切にし、流れに身を任せるのが吉です。" },
            { type: "吉", rank: 4, poem: "春風に 池の氷も 解け初めて", desc: "厳しい冬が終わり、徐々に運気が上昇しています。焦らず着実に進めば、池の氷が解けるように悩みも消えていくでしょう。" },
            { type: "半吉", rank: 3, poem: "山里の 雪解け水も 川となりて", desc: "今はまだ準備段階。しかし確実に運気は開けつつあります。焦らず力を蓄え、時が来るのを待ちましょう。" },
            { type: "末吉", rank: 3, poem: "山道の 険しき坂も 一歩より", desc: "今は登り坂で苦しい時かもしれませんが、一歩一歩進めば必ず頂上に辿り着けます。忍耐力が試される時です。" },
            { type: "末小吉", rank: 2, poem: "種まけば やがて芽が出る 時を待て", desc: "結果が出るまでには時間がかかります。今は地道な努力を続ける時期。将来の大輪の花を信じて。" },
            { type: "凶", rank: 1, poem: "雨雲の 晴れ間も見えず 濡れ衣かな", desc: "誤解を受けやすく、思うようにいかない時期です。今は弁解せず、静かに嵐が過ぎるのを待つのが賢明な判断です。" },
            { type: "小凶", rank: 2, poem: "石の上にも 三年いれば 暖かき", desc: "辛抱が必要な時。すぐに結果を求めず、じっくりと腰を据えて取り組むことで道が開けます。" },
            { type: "半凶", rank: 2, poem: "嵐吹く 庭の小枝も 折れぬよう", desc: "逆風が吹くかもしれません。しかし、しなやかに対応すれば折れることはありません。柔軟な姿勢が大切です。" },
            { type: "末凶", rank: 1, poem: "夜の闇 深きほどに 暁近し", desc: "今は一番暗い時期かもしれませんが、夜明けは必ず来ます。希望を捨てずに前を向きましょう。" },
            { type: "大凶", rank: 0, poem: "嵐吹く 荒野に一人 立つが如し", desc: "八方塞がりの厳しい運勢。無理に動くと災いを招きます。身を潜め、自分を見つめ直す修行の時と心得てください。" }
        ];

        // 運勢ランク別詳細テキストデータ
        const detailTexts = {
            '願事': ["意のままに叶う", "速やかに叶う", "後に叶う", "叶うが遅し", "叶いにくし", "叶わず"],
            '恋愛': ["相思相愛なり", "良縁に恵まれる", "誠意で通じる", "迷いあり", "諦めが肝心", "縁なし"],
            '待人': ["来る 喜びあり", "来る たよりあり", "遅れるが来る", "来ず 音信あり", "来ず さわりあり", "来ず 決して来ず"],
            '商売': ["買うに吉 利あり", "利益あり", "売り買い吉", "利少なし", "損害の恐れ", "商うな 損する"],
            '旅立': ["いざ行け 大吉", "行先に利あり", "よき連れあり", "盗難に注意", "行くな 災いあり", "道中 危険あり"],
            '学問': ["安心して勉めよ", "試験に通る", "努力せよ", "困難あり", "危うし", "絶望的"],
            '病気': ["全快す", "治る 信じよ", "長引くが治る", "養生せよ", "重し 医者を選べ", "危うし 祈れ"]
        };

        // 重複排除用リスト拡張
        const luckyItemsList = [
            "古時計","香水","手鏡","文庫本","スニーカー","万年筆",
            "水晶","観葉植物","銀の指輪","ハンカチ","革靴","手帳",
            "香辛料","紅茶","コイン","鈴","扇子","万華鏡",
            "砂時計","栞","眼鏡","帽子","手袋","香木",
            "和紙","筆","インク","切手","古銭","鍵",
            "ロケット","ブローチ","スカーフ","リボン","ベルト","財布",
            "パスケース","名刺入れ","ポーチ","水筒","マグカップ","皿",
            "箸","風鈴","お守り","数珠","朱肉","印鑑"
        ];
        const luckySpotsList = [
            "図書館","カフェ","神社","海辺","高台","公園",
            "美術館","映画館","博物館","水族館","動物園","植物園",
            "本屋","雑貨屋","パン屋","花屋","駅","空港",
            "港","橋の上","川沿い","山頂","森","温泉",
            "寺院","教会","塔","城","市場","路地裏",
            "噴水広場","並木道","屋上","地下街","交差点","歩道橋",
            "ベンチ","テラス","窓際","カウンター","個室","ロビー",
            "玄関","庭","ベランダ","書斎","リビング","寝室"
        ];
        const luckyColorsList = [
            "赤","青","白","金","紫","緑",
            "黄","橙","桃","黒","銀","紺",
            "茶","灰","水色","黄緑","深紅","群青",
            "琥珀","翡翠","瑠璃","真紅","漆黒","純白",
            "桜色","藤色","山吹色","若草色","空色","茜色",
            "黄金","白銀","銅","パール","ベージュ","クリーム",
            "ワインレッド","オリーブ","ミント","ラベンダー","サーモン","コーラル",
            "ターコイズ","インディゴ","マゼンタ","シアン","ライム","レモン"
        ];
        const luckyPersonsList = [
            "旧友","年上","年下","家族","先生","初対面",
            "同僚","上司","部下","隣人","店員","旅人",
            "子供","老人","職人","芸術家","医師","看護師",
            "警察官","消防士","運転手","駅員","郵便屋","料理人",
            "美容師","作家","歌手","俳優","選手","学者",
            "社長","秘書","受付","警備員","清掃員","農家",
            "漁師","神主","住職","牧師","シスター","占い師",
            "幼馴染","親戚","恩師","先輩","後輩","ライバル"
        ];

        function getRandomUnique(list, count) {
            const shuffled = [...list].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        // --- 【追加】連打制限用の変数定義 ---
    let lastDrawTimestamp = 0;
    const DRAW_COOLDOWN_MS = 0; // 制限時間：0秒（ここはお好みで調整してください）

        function drawResult(element) {
            const overlay = document.getElementById('countdown-overlay');
            const numEl = document.getElementById('countdown-number');
            overlay.style.display = 'flex';
            
            // Lab: 神速の祈りモードならカウントダウン省略
            if(window.labSpeedMode) {
                overlay.style.display = 'none';
                showResultDetail(true);
                return;
            }
            
            let count = 3;
            numEl.textContent = count;
            
            const timer = setInterval(() => {
                count--;
                if(count > 0) {
                    numEl.textContent = count;
                } else {
                    clearInterval(timer);
                    overlay.style.display = 'none';
                    showResultDetail(true); 
                }
            }, 1000);
        }
      
// ==========================================
// 【修正版】おみくじ結果表示ロジック (番号ズレ・カウンター即時更新対応)
// ==========================================
async function showResultDetail(isNewDraw, dataOverride = null) {
    let resultData, randNum, detailsList, luckyItems, unluckyItems, timestamp, username;

    // --- A. 新規におみくじを引く場合 ---
    if (isNewDraw) {
        // カウントダウンを消してローディングを表示
        const overlay = document.getElementById('countdown-overlay');
        overlay.style.display = 'none';
        showLoading(true);

        // 1. ローカルでの抽選（仮データ作成）
        const base = omikujiResults[Math.floor(Math.random() * omikujiResults.length)];
        randNum = Math.floor(Math.random() * 100) + 1;
        timestamp = Date.now();
        username = currentState.user ? (currentState.user.username || "参拝者") : "ゲスト";

        // 詳細・ラッキー項目の生成
        const detailIndex = 5 - base.rank;
        const cats = ['願事','恋愛','待人','商売','旅立','学問','病気'];
        detailsList = cats.map(c => ({
            title: c,
            content: detailTexts[c][Math.min(detailIndex, detailTexts[c].length - 1)]
        }));

        luckyItems = {
            item: luckyItemsList[Math.floor(Math.random()*luckyItemsList.length)],
            spot: luckySpotsList[Math.floor(Math.random()*luckySpotsList.length)],
            color: luckyColorsList[Math.floor(Math.random()*luckyColorsList.length)],
            person: luckyPersonsList[Math.floor(Math.random()*luckyPersonsList.length)]
        };
        
        let ulItem, ulSpot, ulPerson;
        do { ulItem = luckyItemsList[Math.floor(Math.random()*luckyItemsList.length)]; } while(ulItem === luckyItems.item);
        do { ulSpot = luckySpotsList[Math.floor(Math.random()*luckySpotsList.length)]; } while(ulSpot === luckyItems.spot);
        do { ulPerson = luckyPersonsList[Math.floor(Math.random()*luckyPersonsList.length)]; } while(ulPerson === luckyItems.person);

        unluckyItems = { item: ulItem, spot: ulSpot, person: ulPerson };

        // 仮データセット（発行番号は一旦今のカウントを入れるが、後で上書きする）
        resultData = { 
            type: base.type, poem: base.poem, desc: base.desc,
            num: randNum, detail: detailsList,
            lucky: luckyItems, unlucky: unluckyItems,
            timestamp: timestamp, username: username,
            issue_number: currentState.liveCount // 仮
        };

        // 2. サーバー通信（ログイン時のみ）
        if(currentState.user) {
            try {
                const res = await authFetch(`${API_BASE}/api/draw`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        result: resultData.type,
                        poem: resultData.poem,
                        detail: detailsList,
                        lucky: luckyItems,
                        unlucky: unluckyItems
                    })
                });
                
                if (res.status === 429) {
                    showLoading(false);
                    const errData = await res.json();
                    showToast(errData.message, 'warning', '天命の戒め');
                    return; // 制限時は中断
                }
                
                if(res.ok) {
                    const data = await res.json();
                    if(data.success && data.count) {
                        // 【重要】サーバーから返ってきた最新の番号で上書き
                        resultData.issue_number = data.count;
                        currentState.liveCount = data.count;
                        
                        // 【修正】ホーム画面の累計カウンターを即座に更新 (リロード不要にする)
                        const counterEl = document.getElementById('live-counter');
                        if(counterEl) counterEl.textContent = Number(data.count).toLocaleString() + "本";
                        
                        // 統計データの再取得
                        fetchHistoryStats(); 
                        // 自分の記録（総参拝数・大吉数）を即座に更新
                        await loadMyStats(); 
                    }
                }
            } catch(e) { 
                console.error("Draw API Error:", e);
                // エラーでも止まらず、仮データのまま表示へ進む
            }
        } else {
            // ゲストの場合も、見かけ上のカウントを+1して即時反映させる
            currentState.liveCount++;
            resultData.issue_number = currentState.liveCount;
            const counterEl = document.getElementById('live-counter');
            if(counterEl) counterEl.textContent = currentState.liveCount.toLocaleString() + "本";
        }

        // 3. データが確定してからカードを描画
        currentState.lastResult = resultData;
        renderResultToCard('result-card-outer', resultData, true); 
        
        // 画像生成エリアのリセット
        const container = document.getElementById('generated-image-container');
        container.innerHTML = '';
        container.classList.add('hidden');
        document.getElementById('gen-img-status').textContent = "";

        // ローディング消去＆画面遷移
        showLoading(false);
        showView('result');

    } else {
        // --- B. 履歴からの表示 (既存ロジック維持) ---
        resultData = dataOverride;
        randNum = dataOverride.num || 1;
        if (Array.isArray(dataOverride.detail)) {
            detailsList = dataOverride.detail;
        } else {
            const cats = ['願事','恋愛','待人','商売','旅立','学問','病気'];
            const vals = ['叶う','良し','来る','繁盛','吉','成就','治る','遅れる','待て','控','難','危'];
            detailsList = cats.map(c => ({ title: c, content: vals[Math.floor(Math.random() * vals.length)] }));
        }
        let restoredDesc = dataOverride.desc;
        if (!restoredDesc && dataOverride.poem) {
            const original = omikujiResults.find(r => r.poem === dataOverride.poem);
            restoredDesc = original ? original.desc : "心穏やかに過ごすべし。";
        } else if (!restoredDesc) {
            restoredDesc = "心穏やかに過ごすべし。";
        }
        luckyItems = dataOverride.lucky || { item: "不明", spot: "不明", color: "不明", person: "不明" };
        unluckyItems = dataOverride.unlucky || { item: "不明", spot: "不明", person: "不明" };
        
        resultData = {
            type: dataOverride.type || dataOverride.result,
            poem: dataOverride.poem,
            desc: restoredDesc,
            num: randNum,
            detail: detailsList,
            lucky: luckyItems,
            unlucky: unluckyItems,
            timestamp: dataOverride.timestamp,
            username: dataOverride.username || "参拝者",
            issue_number: dataOverride.issue_number // 履歴に保存された番号を使用
        };
        currentState.lastResult = resultData;

        renderResultToCard('result-card-outer', resultData, true); 
        showView('result');
        const container = document.getElementById('generated-image-container');
        container.innerHTML = '';
        container.classList.add('hidden');
        document.getElementById('gen-img-status').textContent = "";
    }
}

        // updateURL は廃止（空関数にして互換性維持）
        function updateURL(resultData) {}

        function renderResultToCard(outerId, data, withFooter) {
            const outer = document.getElementById(outerId);
            outer.innerHTML = ''; 

            // クラスの適用
            outer.className = 'result-card-outer';
            if (data.type === "大吉") {
                outer.classList.add("style-daikichi");
            } else if (data.type === "大凶") {
                outer.classList.add("style-daikyo");
            } else {
                outer.classList.add("style-normal");
            }

            // 1. ロゴ・タイトル
            const headerDiv = document.createElement('div');
            headerDiv.className = 'result-logo-area';
            headerDiv.innerHTML = `
                <div class="result-kamon accent-text"><i class="bi bi-flower1"></i></div>
                <div class="result-title-text accent-text">運勢・天命乃杜</div>
            `;
            outer.appendChild(headerDiv);

            // 2. 本数カウンター (★ここを修正: 個別の発行番号があればそれを表示)
            const issueDiv = document.createElement('div');
            issueDiv.className = 'result-issue-num accent-text';
            
            // data.issue_number があればそれを使い、なければ現在のライブカウント、それもなければ0
            // ※「第〇〇番」のような表記にするため、履歴データに issue_number が保存されている必要があります
            let displayIssueNum = data.issue_number || currentState.liveCount || 0;
            
            issueDiv.textContent = `第 ${Number(displayIssueNum).toLocaleString()} 番`;
            outer.appendChild(issueDiv);

            // 3. 運勢ハンコ（縦書き・画像風）
            const circleBox = document.createElement('div');
            circleBox.className = 'result-circle-box';
            let fs = "4.2rem"; 
            
            if (data.type.length === 3) fs = "2.9rem"; 
            if (data.type.length >= 4) fs = "2.4rem";
            
            circleBox.innerHTML = `<div class="result-kanji-main" style="font-size: ${fs}; white-space: nowrap;">${data.type}</div>`;
            outer.appendChild(circleBox);

            // 4. ラベル
            const labelSub = document.createElement('div');
            labelSub.className = 'result-label-sub accent-text';
            labelSub.textContent = '運勢';
            outer.appendChild(labelSub);

            // 5. メッセージエリア
            const msgArea = document.createElement('div');
            msgArea.className = 'result-main-message-area';
            const adviceBox = document.createElement('div');
            adviceBox.className = 'result-advice-box accent-border';
            adviceBox.innerHTML = `<span class="advice-label accent-text">助言</span> <span class="accent-text">${data.desc || "心穏やかに過ごすべし。"}</span>`;
            const poemDiv = document.createElement('div');
            poemDiv.className = 'result-poem-vertical accent-text';
            poemDiv.textContent = data.poem;
            msgArea.appendChild(adviceBox);
            msgArea.appendChild(poemDiv);
            outer.appendChild(msgArea);

            // 6. 詳細項目
            const detailGrid = document.createElement('div');
            detailGrid.className = 'result-details-grid accent-border';
            if (data.detail) {
                data.detail.forEach(d => {
                    const col = document.createElement('div');
                    col.className = 'detail-column';
                    col.innerHTML = `<span class="detail-item-label accent-text">${d.title}</span> <span class="detail-item-content accent-text">${d.content}</span>`;
                    detailGrid.appendChild(col);
                });
            }
            outer.appendChild(detailGrid);

            // 7. 開運・不運エリア
            const luckyArea = document.createElement('div');
            luckyArea.className = 'lucky-area';
            const lBox = document.createElement('div');
            lBox.className = 'lucky-box accent-border';
            if (data.lucky) {
                lBox.innerHTML = `
                    <div class="lucky-title accent-text">開運</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-stars"></i></span>物：${data.lucky.item}</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-geo-alt"></i></span>所：${data.lucky.spot}</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-palette"></i></span>色：${data.lucky.color}</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-person"></i></span>人：${data.lucky.person}</div>
                `;
            }
            const uBox = document.createElement('div');
            uBox.className = 'unlucky-box accent-border';
            if (data.unlucky) {
                uBox.innerHTML = `
                    <div class="lucky-title accent-text red-text" style="color:inherit">不運・注意</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-exclamation-triangle"></i></span>物：${data.unlucky.item}</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-x-octagon"></i></span>所：${data.unlucky.spot}</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-person-x"></i></span>人：${data.unlucky.person}</div>
                `;
            }
            luckyArea.appendChild(lBox);
            luckyArea.appendChild(uBox);
            outer.appendChild(luckyArea);

           // 8. フッター情報
            if (withFooter) {
                const footer = document.createElement('div');
                footer.className = 'result-footer-info accent-border';
                const metaDiv = document.createElement('div');
                metaDiv.style.textAlign = 'left';
                const name = data.username || "参拝者";
                
                let ts = Number(data.timestamp);
                if (isNaN(ts) || ts === 0) {
                    ts = Date.now();
                }
                const date = new Date(ts);
                const dateStr = `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日 ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
                
                metaDiv.innerHTML = `
                    <div class="result-user-name accent-text">${escapeHtml(name)} 様の運勢</div>
                    <div class="result-date accent-text">参拝日: ${dateStr}</div>
                `;
                const qrDiv = document.createElement('div');
                qrDiv.className = 'result-qr-container';
                const qrTarget = document.createElement('div');
                qrDiv.appendChild(qrTarget);
                footer.appendChild(metaDiv);
                footer.appendChild(qrDiv);
                outer.appendChild(footer);
                
                setTimeout(() => {
                    // ★修正箇所: widthとheightを 60 → 128 に変更
                    // これで内部的に高画質で生成され、CSSで60pxに縮小表示されます
                    new QRCode(qrTarget, {
                        text: SITE_URL, 
                        width: 128,  // 大きく作る
                        height: 128, // 大きく作る
                        colorDark : "#000000", 
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                }, 100);
            }
        }

       // --- 履歴・おみくじの轍 (連打フリーズ完全対策版) ---
        
        // 通信管理用の変数
        let historyAbortController = null;
        let currentHistoryRequestId = 0; // 最新のリクエストIDを管理

        // 履歴読み込み関数 (根本修正版: 競合状態の解消と確実な終了処理)
async function loadHistory(page = 1) {
    const list = document.getElementById('history-list');
    const container = document.getElementById('history-container');
    const overlay = document.getElementById('history-login-overlay');
    const viewMode = document.getElementById('history-view-mode');
    
    // 未ログイン時の処理（ここは変更なし）
    if(!currentState.user) {
        if(container) container.classList.add('history-blurred');
        if(overlay) overlay.classList.remove('hidden');
        if(viewMode) viewMode.textContent = "";
        if(list) list.innerHTML = Array(5).fill('<div class="bg-gray-50 dark:bg-zinc-800 p-3 rounded mb-2 h-12 border-l-4 border-gray-300"></div>').join('');
        return;
    }

    // UI初期化
    if(container) container.classList.remove('history-blurred');
    if(overlay) overlay.classList.add('hidden');
    if(viewMode) viewMode.textContent = "全参拝者の記録 (全期間)";
    if(list) list.innerHTML = '<div class="text-center py-8"><div class="spinner-border text-red-500" role="status"></div> 読み込み中...</div>';
    
    // カウンター表示更新
    const globalCountEl = document.getElementById('global-history-count');
    if (currentState.liveCount > 0 && globalCountEl) {
        globalCountEl.textContent = currentState.liveCount.toLocaleString() + "本";
    }

    // --- 通信制御 ---
    
    // 1. 前回の通信が生きていればキャンセル
    if (historyAbortController) {
        historyAbortController.abort();
    }
    // 2. 新しいコントローラーを作成
    historyAbortController = new AbortController();
    const signal = historyAbortController.signal;

    // 3. ローディング開始
    showLoading(true);

    try {
        // パラメータ取得
        const type = document.getElementById('search-type').value;
        const keyword = document.getElementById('search-keyword').value;
        const dateStart = document.getElementById('search-date-start').value;
        const dateEnd = document.getElementById('search-date-end').value;

        const params = new URLSearchParams({
            page: page,
            type: type,
            keyword: keyword,
            dateStart: dateStart,
            dateEnd: dateEnd
        });

        // 4. 通信実行
        const res = await authFetch(`${API_BASE}/api/history/global?${params.toString()}`, {
            method: 'GET',
            signal: signal 
        });

        if(res.ok) {
            const data = await res.json();
            
            // データの反映
            const myCountEl = document.getElementById('personal-history-count');
            const searchResultCount = document.getElementById('search-result-count');
            
            if(myCountEl) myCountEl.textContent = (data.personalTotal || 0).toLocaleString() + "回";
            if(searchResultCount) searchResultCount.textContent = (data.totalItems || 0).toLocaleString();

            // 状態更新
            historyPageState.page = data.page;
            historyPageState.totalItems = data.totalItems;
            historyPageState.filteredData = data.global;

            renderHistoryList(data.global);
            renderServerPagination(data.page, data.totalItems, 100);
            
        } else {
            // サーバーエラー時
            console.error("Load failed status:", res.status);
            if(list) list.innerHTML = '<p class="text-center text-red-500 py-4">情報の取得に失敗しました。<br><button onclick="loadHistory(1)" class="mt-2 underline font-bold">再読み込み</button></p>';
        }

    } catch(e) {
        // 5. エラーハンドリング
        if (e.name === 'AbortError') {
            console.log("Fetch aborted");
            // キャンセルされた場合は何もしない（新しいリクエストが動いているため）
        } else {
            console.error("Load history error:", e);
            if(list) list.innerHTML = '<p class="text-center text-red-500 py-4">通信エラーが発生しました。<br><button onclick="loadHistory(1)" class="mt-2 underline font-bold">再読み込み</button></p>';
        }
    } finally {
        // 6. 終了処理（ここが最重要）
        // キャンセルされた場合(signal.aborted)は、新しいリクエストがすぐに始まるのでローディングを消さない
        // 正常終了またはエラー終了の場合のみローディングを消す
        if (!signal.aborted) {
            showLoading(false);
            historyAbortController = null; // コントローラーをリセット
        }
    }
}

        // 履歴リストのレンダリング関数 (タイムライン・モダンカード版)
function renderHistoryList(historyData) {
    const list = document.getElementById('history-list');
    list.innerHTML = '';
    
    // データがない場合の表示
    if(historyData.length === 0) {
        list.innerHTML = `
            <div class="flex flex-col items-center justify-center py-10 text-gray-400">
                <i class="bi bi-wind text-4xl mb-3 opacity-50"></i>
                <p>風の音しかしません...</p>
                <p class="text-xs mt-1">条件に一致する記録が見つかりませんでした。</p>
            </div>
        `;
        return;
    }

    // データのループ処理
    historyData.forEach((item, index) => {
        // 自分の記録かどうか判定
        const isMe = currentState.user && item.username === currentState.user.username;
        
        // 日付フォーマット処理
        let dateObj = new Date(Number(item.timestamp));
        let dateStr = "----/--/--";
        let timeStr = "--:--";
        if (!isNaN(dateObj.getTime())) {
            dateStr = `${dateObj.getFullYear()}.${String(dateObj.getMonth()+1).padStart(2,'0')}.${String(dateObj.getDate()).padStart(2,'0')}`;
            timeStr = `${dateObj.getHours()}:${String(dateObj.getMinutes()).padStart(2,'0')}`;
        }

        // バッジのスタイル決定（運勢によって色を変える）
        let badgeClass = "res-kyo"; // デフォルト（凶系）
        if (item.result === "大吉") {
            badgeClass = "res-daikichi"; // 大吉用（金）
        } else if (item.result.includes("吉")) {
            badgeClass = "res-kichi"; // 吉系（赤）
        } else if (item.result === "大凶") {
            badgeClass = "res-daikyo"; // 大凶用（黒）
        }

        // アニメーション遅延 (少しずつずらして表示する演出)
        const delay = index * 0.05; 

        // HTML生成 (タイムライン構造)
        // .timeline-item が全体の枠、.timeline-dot が左の点、.history-card が中身
        // クリックで詳細モーダルを表示するイベントを設定
        // JSON.stringify(item) でデータを埋め込み、シングルクォートのエスケープ処理も行う
        const html = `
            <div class="timeline-item ${isMe ? 'is-me' : ''}" style="animation-delay: ${delay}s">
                <div class="timeline-dot"></div>
                
                <div class="history-card ${isMe ? 'is-me' : ''}" onclick='showResultDetail(false, ${JSON.stringify(item).replace(/'/g, "&apos;")})'>
                    <!-- 左側: 日付とユーザー情報 -->
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs font-bold text-gray-400 tracking-wider font-mono">${dateStr}</span>
                            <span class="text-[10px] bg-gray-100 dark:bg-zinc-700 px-1.5 rounded text-gray-500">${timeStr}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold ${isMe ? 'text-[var(--accent-red)]' : 'text-gray-700 dark:text-gray-300'} text-sm truncate max-w-[120px] md:max-w-[200px]">
                                ${isMe ? '<i class="bi bi-person-fill"></i> ' : ''}${escapeHtml(item.username)}
                            </span>
                            ${isMe ? '<span class="text-[10px] border border-red-200 text-red-500 px-1 rounded">あなた</span>' : ''}
                        </div>
                    </div>

                    <!-- 右側: 結果バッジと発行番号 -->
                    <div class="flex flex-col items-end">
                        <div class="result-badge ${badgeClass}">
                            ${item.result}
                        </div>
                        <div class="text-[10px] text-gray-400 mt-1">
                            No.${Number(item.issue_number || 0).toLocaleString()}
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // リストに追加
        list.insertAdjacentHTML('beforeend', html);
    });
}

        // 検索ボタン: 1ページ目をロード
function filterHistory() {
    loadHistory(1);
}

// リセットボタン: 条件クリアして1ページ目をロード
function resetSearch() {
    document.getElementById('search-type').value = 'all';
    document.getElementById('search-keyword').value = '';
    document.getElementById('search-date-start').value = '';
    document.getElementById('search-date-end').value = '';
    loadHistory(1);
}

        // モーダル機能は使わなくなったので削除または無効化
        function openHistoryDetail(index) {
            // 廃止: 直接遷移するため
        }
        function closeHistoryDetail(e) {
            if(e && e.target.id !== 'history-detail-modal' && e.target.tagName !== 'BUTTON') return;
            document.getElementById('history-detail-modal').style.display = 'none';
        }

        // --- シェア用画像生成 (崩れ防止・完全修正版) ---
        function generateResultImage() {
            const status = document.getElementById('gen-img-status');
            status.textContent = "画像を生成中...";
            
            // ★変更点1: 親枠ではなく、カード本体を直接ターゲットにする
            const target = document.getElementById('result-card-outer');
            
            const container = document.getElementById('generated-image-container');
            container.innerHTML = '';
            container.classList.add('hidden');
            
            // ★変更点2: 強制的にページトップへ (ズレ防止の基本)
            const originalScrollPos = window.scrollY;
            window.scrollTo(0, 0);
            
            document.fonts.ready.then(() => {
                html2canvas(target, { 
                    scale: 3, // 高画質設定
                    useCORS: true, 
                    allowTaint: true,
                    backgroundColor: null, // 背景透過（カードの背景色は維持されます）
                    
                    // ★変更点3: ウィンドウ幅をPCサイズに固定してシミュレート
                    // これによりスマホでもPCと同じレイアウトで描画されます
                    windowWidth: 1280,
                    
                    // スクロール補正をリセット
                    scrollX: 0,
                    scrollY: 0,
                    
                    // クローン生成時のスタイル強制修正
                    onclone: (clonedDoc) => {
                        const clonedOuter = clonedDoc.getElementById('result-card-outer');
                        if (clonedOuter) {
                            // 幅を600pxに固定し、余白や変形を解除
                            clonedOuter.style.width = '600px';
                            clonedOuter.style.height = 'auto';
                            clonedOuter.style.minHeight = '1200px'; // 高さが縮むのを防ぐ
                            clonedOuter.style.margin = '0';
                            clonedOuter.style.transform = 'none';
                            clonedOuter.style.boxShadow = 'none'; // 余計な影を消す

                            // 大吉の背景テクスチャ(SVGノイズ)のみ削除し、色は維持
                            // ※これをしないと一部環境でクラッシュするため
                            clonedOuter.style.backgroundImage = 'none';

                            // 縦書きレイアウトの崩れ防止（フォントと行間を再指定）
                            const verticals = clonedOuter.querySelectorAll('.result-poem-vertical, .result-advice-box, .detail-column');
                            verticals.forEach(el => {
                                el.style.letterSpacing = '0.1em'; 
                                el.style.lineHeight = '1.6';
                                el.style.fontFamily = "'Zen Old Mincho', serif"; 
                            });
                        }
                    }
                }).then(canvas => {
                    status.textContent = "";
                    // スクロール位置を元に戻す
                    window.scrollTo(0, originalScrollPos);

                    container.innerHTML = '<p class="text-green-600 font-bold mb-2 text-sm"><i class="bi bi-check-circle-fill"></i> 画像の生成完了</p>';
                    
                    canvas.toBlob(blob => {
                        if (!blob) return;
                        currentState.lastImageBlob = blob;
                        const url = URL.createObjectURL(blob);
                        
                        // プレビュー画像（小さく表示）
                        const img = document.createElement('img');
                        img.src = url;
                        img.className = "mx-auto rounded border w-32 mb-3 shadow-sm"; 
                        container.appendChild(img);
                        container.classList.remove('hidden');

                        // ダウンロードボタン
                        const dlLink = document.createElement('a');
                        dlLink.href = url;
                        dlLink.download = `tenmei_omikuji_${Date.now()}.png`;
                        dlLink.className = "btn-primary text-sm inline-flex items-center gap-2 py-2 px-6";
                        dlLink.innerHTML = '<i class="bi bi-download"></i> 画像を保存';
                        container.appendChild(dlLink);
                        
                    }, 'image/png');

                }).catch(err => {
                    console.error("Image Gen Error:", err);
                    status.textContent = "画像の生成に失敗しました。";
                    status.className = "text-sm font-bold text-red-500 mb-2 h-6";
                    window.scrollTo(0, originalScrollPos);
                });
            });
        }

        // サイトルートURLを返す（生成URL廃止）
        function getShareUrl() {
            return SITE_URL;
        }

        // 全プラットフォーム共通のシェアテキスト生成（軽量・安全版）
        function generateUnifiedShareText(res) {
            const userName = res.username || "参拝者"; 
            
            // 【修正】日付の安全な変換 (NaN対策)
            // timestampが数値文字列や未定義の場合に対応
            let ts = Number(res.timestamp);
            if (isNaN(ts) || ts === 0) {
                ts = Date.now(); // データがない場合は現在時刻
            }
            const date = new Date(ts);
            const dateStr = `${date.getMonth()+1}/${date.getDate()}`;
            
            // 開運情報はシンプルに
            const luckyInfo = `開運: ${res.lucky.item} / ${res.lucky.color}`;
            
            // 投稿文組み立て (Xの文字数制限対策で短縮)
            // URL(23文字) + ハッシュタグ + 改行含めて140文字以内に収める
            return `⛩️ 天命乃杜で運試し

参拝者：${userName} 様 (${dateStr})
✨運勢：【 ${res.type} 】
📜神託：『${res.poem}』

${luckyInfo}

#天命乃杜 #おみくじ
${getShareUrl()}`;
        }

        // --- シェアアクション (アラート削除版) ---
        async function shareToX() {
            if(!currentState.lastResult) return;
            const fullText = generateUnifiedShareText(currentState.lastResult);

            // 1. Web Share API (スマホアプリ連携) トライ
            if (navigator.share && currentState.lastImageBlob) {
                try {
                    const file = new File([currentState.lastImageBlob], "tenmei_omikuji.png", { type: "image/png" });
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            text: fullText,
                            files: [file]
                        });
                        return;
                    }
                } catch (e) {
                    console.log("Web Share API failed", e);
                }
            }

            // 2. PC/フォールバック: 画像ダウンロード + 投稿画面
            if (currentState.lastImageBlob) {
                // 画像をダウンロードさせる
                const url = URL.createObjectURL(currentState.lastImageBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tenmei_omikuji_${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // 【削除】ここで alert を出していましたが、削除しました。
            }

            // Xの投稿画面を開く
            const intent = `https://twitter.com/intent/tweet?text=${encodeURIComponent(fullText)}`;
            window.open(intent, '_blank');
        }

        async function shareToFB() {
            if(!currentState.lastResult) return;
            const fullText = generateUnifiedShareText(currentState.lastResult);

            if (navigator.share && currentState.lastImageBlob) {
                try {
                    const file = new File([currentState.lastImageBlob], "omikuji.png", { type: "image/png" });
                    await navigator.share({
                        text: fullText,
                        files: [file]
                    });
                    return;
                } catch (e) {
                    console.log("Web Share API failed for FB", e);
                }
            }

            const url = getShareUrl();
            const intent = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
            window.open(intent, '_blank');
        }
        
        async function shareToLine() {
            if(!currentState.lastResult) return;
            const fullText = generateUnifiedShareText(currentState.lastResult);

             if (navigator.share && currentState.lastImageBlob) {
                try {
                    const file = new File([currentState.lastImageBlob], "omikuji.png", { type: "image/png" });
                    await navigator.share({
                        text: fullText,
                        files: [file]
                    });
                    return;
                } catch(e) {
                    console.log("Web Share API failed for LINE", e);
                }
            }

            const intent = `https://social-plugins.line.me/lineit/share?text=${encodeURIComponent(fullText)}`;
            window.open(intent, '_blank');
        }

        async function shareToBluesky() {
            if(!currentState.lastResult) return;
            const fullText = generateUnifiedShareText(currentState.lastResult);

            // 1. Web Share API (アプリ連携) トライ
            if (navigator.share && currentState.lastImageBlob) {
                try {
                    const file = new File([currentState.lastImageBlob], "tenmei_omikuji.png", { type: "image/png" });
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            text: fullText,
                            files: [file]
                        });
                        return;
                    }
                } catch (e) {
                    console.log("Web Share API failed for Bluesky", e);
                }
            }

            // 2. PC/フォールバック: 画像ダウンロード + 投稿画面
            if (currentState.lastImageBlob) {
                const url = URL.createObjectURL(currentState.lastImageBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tenmei_omikuji_${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // Blueskyの投稿画面を開く
            const intent = `https://bsky.app/intent/compose?text=${encodeURIComponent(fullText)}`;
            window.open(intent, '_blank');
        }

        async function shareToMisskey() {
            if(!currentState.lastResult) return;
            const fullText = generateUnifiedShareText(currentState.lastResult);

            // 1. Web Share API (アプリ連携) トライ
            if (navigator.share && currentState.lastImageBlob) {
                try {
                    const file = new File([currentState.lastImageBlob], "tenmei_omikuji.png", { type: "image/png" });
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            text: fullText,
                            files: [file]
                        });
                        return;
                    }
                } catch (e) {
                    console.log("Web Share API failed for Misskey", e);
                }
            }

            // 2. PC/フォールバック: 画像ダウンロード + 投稿画面
            if (currentState.lastImageBlob) {
                const url = URL.createObjectURL(currentState.lastImageBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tenmei_omikuji_${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // Misskey.ioの投稿画面を開く
            const intent = `https://misskey.io/share?text=${encodeURIComponent(fullText)}`;
            window.open(intent, '_blank');
        }

        
    // ユーザープロフィールの読み込み
    async function loadUserProfile(username) {
        showLoading(true);
        try {
            // 自分のデータかどうか判定
            const isMe = currentState.user && currentState.user.username === username;
            
            // APIからデータ取得
            const res = await fetch(`${API_BASE}/api/user/profile?username=${encodeURIComponent(username)}`);
            
            if (res.ok) {
                const data = await res.json();
                data.isMe = isMe; // 自分かどうかのフラグを付与
                renderProfilePage(data);
                showView('profile'); // プロフィールビューを表示
            } else {
                showToast("ユーザー情報の取得に失敗しました", "error");
            }
        } catch (e) {
            console.error(e);
            showToast("通信エラーが発生しました", "error");
        } finally {
            showLoading(false);
        }
    }

        async function deleteAccount() {
            if(!confirm("本当にアカウントを削除しますか？\n履歴やお気に入りデータも完全に消去されます。")) return;
            
            showLoading(true);
            try {
                // ★修正: authFetchに変更
                const res = await authFetch(`${API_BASE}/api/user/delete`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });
                
                const contentType = res.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const data = await res.json();
                    if(data.success) {
                        alert("アカウントを削除しました。ご利用ありがとうございました。");
                        logout();
                    } else {
                        alert("削除失敗: " + (data.message || data.error));
                    }
                } else {
                    const text = await res.text();
                    console.error("Delete Error:", text);
                    alert("削除処理中にエラーが発生しました。");
                }
            } catch(e) { 
                console.error(e);
                alert("通信エラーが発生しました。"); 
            }
            finally { showLoading(false); }
        }

        // --- 認証系 (Bento UI対応) ---

// 1. 最初の選択 (ログイン or 登録)
function startAuthFlow(mode) {
    document.getElementById('auth-selection').classList.add('hidden');
    document.getElementById('auth-step-1').classList.remove('hidden');
    
    currentState.authMode = mode;
    
    const loginFields = document.getElementById('form-login-fields');
    const regFields = document.getElementById('form-register-fields');
    const title = document.getElementById('auth-form-title');

    if (mode === 'login') {
        loginFields.classList.remove('hidden');
        regFields.classList.add('hidden');
        title.textContent = 'ログイン';
    } else {
        loginFields.classList.add('hidden');
        regFields.classList.remove('hidden');
        title.textContent = '新規登録';
    }
}

// 2. 選択画面に戻る
function backToAuthSelection() {
    document.getElementById('auth-step-1').classList.add('hidden');
    document.getElementById('auth-selection').classList.remove('hidden');
}

// 3. 入力画面に戻る (コード入力から戻る時)
function backToAuthStep1() {
    document.getElementById('auth-step-2').classList.add('hidden');
    document.getElementById('auth-step-1').classList.remove('hidden');
}

        // --- 認証完了 (finalizeAuth) - 修正版 ---
        async function finalizeAuth() {
            const code = document.getElementById('auth-code-input').value;
            if(!code || code.length !== 6) return alert("6桁の認証コードを入力してください");

            const mode = currentState.authMode;
            const email = document.getElementById(mode === 'login' ? 'login-email' : 'reg-email').value.trim().toLowerCase();
            const pass = document.getElementById(mode === 'login' ? 'login-password' : 'reg-password').value;
            const username = document.getElementById('reg-username').value;

            showLoading(true);
            try {
                const endpoint = (mode === 'login') ? '/api/auth/login' : '/api/auth/register';
                const body = { email, password: pass, code };
                if (mode === 'register') body.username = username;

                const res = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include', 
                    body: JSON.stringify(body)
                });
                
                const data = await res.json();
                
                // ▼▼▼ 修正: レート制限（429）の場合、天命の戒めを表示 ▼▼▼
                if (res.status === 429) {
                    showToast(data.message, 'warning', '天命の戒め');
                    return;
                }
                
                if(res.ok && data.success) {
                    if (data.token) {
                        localStorage.setItem('auth_token', data.token);
                    }
                    loginSuccess({ email, username: data.username });
                } else {
                    alert(`${mode === 'login' ? 'ログイン' : '登録'}失敗: ${data.message || data.error}`);
                }
            } catch(e) { alert("通信エラー"); }
            finally { showLoading(false); }
        }

        function backToAuthStep1() {
            document.getElementById('auth-step-2').classList.add('hidden');
            document.getElementById('auth-step-1').classList.remove('hidden');
        }

        // --- 認証完了 (finalizeAuth) - 修正版 ---
async function finalizeAuth() {
    const code = document.getElementById('auth-code-input').value;
    if(!code || code.length !== 6) return alert("6桁の認証コードを入力してください");

    const mode = currentState.authMode;
    const email = document.getElementById(mode === 'login' ? 'login-email' : 'reg-email').value.trim().toLowerCase();
    const pass = document.getElementById(mode === 'login' ? 'login-password' : 'reg-password').value;
    const username = document.getElementById('reg-username').value;

    showLoading(true);
    try {
        const endpoint = (mode === 'login') ? '/api/auth/login' : '/api/auth/register';
        const body = { email, password: pass, code };
        if (mode === 'register') body.username = username;

        // ここは通常のfetchでOK (credentials: includeは必須)
        const res = await fetch(`${API_BASE}${endpoint}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include', 
            body: JSON.stringify(body)
        });
        const data = await res.json();
        
        if(res.ok && data.success) {
            // ★追加: トークンをローカルストレージに保存 (ハイブリッド認証用)
            if (data.token) {
                localStorage.setItem('auth_token', data.token);
            }
            
            loginSuccess({ email, username: data.username });
        } else {
            alert(`${mode === 'login' ? 'ログイン' : '登録'}失敗: ${data.message || data.error}`);
        }
    } catch(e) { alert("通信エラー"); }
    finally { showLoading(false); }
}

// --- ログイン成功時 (loginSuccess) - 修正版 ---
function loginSuccess(user) {
    currentState.user = user;
    // localStorageへの保存は行わない（セキュリティ強化）
    updateAuthUI();
    loadFavorites(); 
    
    loadLabSettings().then(() => {
        if(currentState.view === 'lab') {
            showView('lab');
        }
        alert(`ようこそ、${user.username || user.email} 様！`);
        showView('home');
    });
}

// --- ログアウト (logout) - 修正版 ---
async function logout() {
    try {
        // ★修正: authFetchに変更
        await authFetch(`${API_BASE}/api/auth/logout`, {
            method: 'POST'
        });
    } catch(e) { console.error(e); }

    // ★追加: トークンを削除
    localStorage.removeItem('auth_token');
    
    // 既存のユーザー情報削除
    localStorage.removeItem('omikuji_user');
    currentState.user = null;
    
    loadLabSettings().then(() => {
        location.reload();
    });
}

        // 旧: sendAuthCode (削除せず互換性のため残すが使用しない)
        async function sendAuthCode() { initiateAuth(currentState.authMode); }
        // 旧: performLogin / performRegister (finalizeAuthに統合)

    // ==========================================
    //  認証状態のUI更新ロジック (Bento UI対応版)
    // ==========================================
    function updateAuthUI() {
        const badge = document.getElementById('fav-status-badge');
        const navBtn = document.getElementById('nav-login-btn');
        
        // ▼▼▼ Bento UI用の挨拶エリア更新処理 ▼▼▼
        const welcomeName = document.getElementById('welcome-username');
        const welcomeDate = document.getElementById('welcome-date');
        
        // 日付の更新
        if(welcomeDate) {
            const now = new Date();
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            welcomeDate.textContent = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日 (${days[now.getDay()]})`;
        }

        if (currentState.user) {
            // ログイン中
            if (navBtn) {
                navBtn.innerHTML = `<i class="bi bi-person-check-fill text-green-400"></i><span class="nav-text">会員: ${escapeHtml(currentState.user.username)}</span>`;
            }
            if (badge) {
                badge.textContent = "クラウド保存済み";
            }
            // 挨拶の名前更新
            if (welcomeName) {
                welcomeName.textContent = currentState.user.username;
            }
        } else {
            // 未ログイン
            if (navBtn) {
                navBtn.innerHTML = `<i class="bi bi-person-circle"></i><span class="nav-text">ログイン/登録</span>`;
            }
            if (badge) {
                badge.textContent = "端末に保存中";
            }
            // 挨拶の名前更新
            if (welcomeName) {
                welcomeName.textContent = "ゲスト";
            }
        }
    }

        // 3. ログイン成功時の処理 (設定を即座にクラウドから取得)
    function loginSuccess(user) {
        currentState.user = user;
        localStorage.setItem('omikuji_user', JSON.stringify(user));
        updateAuthUI();
        loadFavorites(); 
        
        // ログイン直後にサーバーから設定を読み込む（最優先）
        loadLabSettings().then(() => {
            // Lab画面のロック状態を即座に更新するためにView再描画
            if(currentState.view === 'lab') {
                showView('lab');
            }
            alert(`ようこそ、${user.username || user.email} 様！クラウド設定を同期しました。`);
            showView('home');
        });
    }

    // 4. ログアウト処理
    function logout() {
        localStorage.removeItem('omikuji_user');
        // ユーザー情報を消去し、loadLabSettingsを呼んで表示をゲスト用に戻す
        currentState.user = null;
        loadLabSettings().then(() => {
            location.reload();
        });
    }

        async function loadFavorites() {
            const badge = document.getElementById('fav-status-badge');
            
            if (currentState.user) {
                if(badge) badge.textContent = "同期中...";
                try {
                    // ★修正: authFetchに変更
                    const res = await authFetch(`${API_BASE}/api/favorites`, {
                        method: 'GET'
                    });
                    if(res.ok) {
                        const data = await res.json();
                        favoriteList = data.favorites || [];
                        if(badge) badge.textContent = "クラウド保存済み";
                    }
                } catch(e) { console.error(e); }
            } else {
                favoriteList = [];
                if(badge) badge.textContent = "";
            }
            
            renderFavorites();
        }

        // 12星座ロジック
        function initZodiacSystem() {
            const dateStr = getJSTDateString();
            const dateParts = dateStr.split('-');
            document.getElementById('current-date-display').innerHTML = `${dateParts[0]}年${dateParts[1]}月${dateParts[2]}日 <span class="text-sm font-normal ml-2 text-gray-500 dark:text-gray-400">(毎日 0:00 更新)</span>`;
            generateDailyRanking(dateStr);
            renderRanking();
        }
        
        // --- 日本時間 (JST) の日付文字列取得 (修正版) ---
        function getJSTDateString() {
            return new Date().toLocaleDateString("ja-JP", {
                timeZone: "Asia/Tokyo",
                year: "numeric",
                month: "2-digit",
                day: "2-digit"
            }).replaceAll('/', '-');
        }
        
        function getFutureDateString(baseDateStr, daysToAdd) {
            const date = new Date(baseDateStr);
            date.setDate(date.getDate() + daysToAdd);
            return date.toISOString().split('T')[0];
        }
        class SeededRandom {
            constructor(seed) {
                this.seed = 0;
                for (let i = 0; i < seed.length; i++) this.seed = (this.seed * 31 + seed.charCodeAt(i)) >>> 0;
            }
            next() {
                this.seed ^= this.seed << 13;
                this.seed ^= this.seed >> 17;
                this.seed ^= this.seed << 5;
                let x = (this.seed < 0 ? ~this.seed + 1 : this.seed);
                return (x % 100000) / 100000;
            }
        }
       // ==========================================
    //  12星座×血液型占い：データ定義
    // ==========================================
    const zodiacSigns = [
        { id: "aries", name: "牡羊座", icon: "♈" }, { id: "taurus", name: "牡牛座", icon: "♉" }, 
        { id: "gemini", name: "双子座", icon: "♊" }, { id: "cancer", name: "蟹座", icon: "♋" }, 
        { id: "leo", name: "獅子座", icon: "♌" }, { id: "virgo", name: "乙女座", icon: "♍" },
        { id: "libra", name: "天秤座", icon: "♎" }, { id: "scorpio", name: "蠍座", icon: "♏" }, 
        { id: "sagittarius", name: "射手座", icon: "♐" }, { id: "capricorn", name: "山羊座", icon: "♑" }, 
        { id: "aquarius", name: "水瓶座", icon: "♒" }, { id: "pisces", name: "魚座", icon: "♓" }
    ];
    const bloodTypes = ["A", "B", "O", "AB"];

    const zodiacItemsList = [
        "時計", "本", "水", "銀", "植物", "手帳", "香り", "靴", "音楽", "飴",
        "鏡", "ハンカチ", "帽子", "鞄", "ペン", "写真", "石", "貝殻", "鍵", "鈴",
        "リボン", "指輪", "お茶", "果物", "野菜", "パン", "手紙", "切手", "地図", "コンパス",
        "ランプ", "キャンドル", "クッション", "マグカップ", "グラス", "皿", "箸", "スプーン", "フォーク", "ナイフ",
        "石鹸", "タオル", "入浴剤", "お香", "風鈴", "扇子", "うちわ", "手袋", "マフラー", "傘"
    ];

    const zodiacColorsList = [
        "赤", "青", "緑", "黄", "白", "黒", "金", "銀", "桃", "紺",
        "橙", "紫", "茶", "灰", "水色", "黄緑", "深紅", "群青", "琥珀", "翡翠",
        "瑠璃", "真紅", "漆黒", "純白", "桜色", "藤色", "山吹色", "若草色", "空色", "茜色",
        "黄金", "白銀", "銅", "パール", "ベージュ", "クリーム", "ワインレッド", "オリーブ", "ミント", "ラベンダー",
        "サーモン", "コーラル", "ターコイズ", "インディゴ", "マゼンタ", "シアン", "ライム", "レモン", "チャコール", "カーキ"
    ];

    // --- 超長文・状況別詳細コメントデータベース ---
    const luckComments = {
        // 【総合運：導入文】順位が高いほどポジティブ、低いほど戒め
        mainIntro: {
            S: [
                "今日のあなたは、宇宙のすべての理が味方をしているかのような、圧倒的な強運の渦中にあります。星々の配置は完璧な調和を見せ、あなたの放つオーラは周囲の人々をも照らすほどに輝きを増しています。迷いや不安といった負のエネルギーは今日のあなたには一切届きません。信じられないような幸運が、向こうから歩み寄ってくるのを感じるでしょう。",
                "今、天空の星々はあなたに最大の祝福を授けています。これまでに積み重ねてきた努力が、最高の形で結実する瞬間が近づいています。まるで霧が晴れるように進むべき道が明確になり、自信に満ち溢れた足取りで未来を切り拓いていくことができるでしょう。今日は、あなたの人生における重要な転換点となる可能性を秘めた、奇跡的な一日です。"
            ],
            A: [
                "全体的な運気は非常に好調な波に乗っています。心地よい追い風があなたの背中を押し、滞っていた物事がスムーズに動き出すでしょう。周囲との協力関係も良好で、あなたが動くことでプラスの連鎖が生まれます。直感も冴え渡っているため、今日感じた『なんとなく良い予感』は、高い確率で的中することになるでしょう。",
                "今日のあなたは、非常にバランスの取れた幸運に恵まれています。心身ともにエネルギーが充満しており、何事にも前向きに取り組める活力が備わっています。星々のサポートを十分に受けられる配置にあるため、積極的に行動すればするほど、得られる果実は大きくなります。素晴らしい収穫の一日となるでしょう。"
            ],
            B: [
                "今日の運勢は、穏やかで安定した凪のような一日を指し示しています。大きな波乱はありませんが、それは平穏という名の幸運に守られている証でもあります。劇的な変化を求めるよりも、日常の中にある小さな幸せや気づきを大切にすることで、運気の底上げができる時期です。足元を固めるには最適な、地に足の着いた運気です。",
                "可もなく不可もなく、といった落ち着いた運気ですが、あなたの心の持ちよう次第で吉へと転じる柔軟なエネルギーが流れています。周囲の喧騒に惑わされず、自分のペースを守ることで、思わぬところからチャンスの芽が見つかるかもしれません。今日は「準備の日」と心得て、じっくりと自分を整えることが推奨されます。"
            ],
            C: [
                "今日のあなたは、少し慎重さが求められる星回りの中にいます。運気の流れが一時的に停滞しており、物事が思うように進まないもどかしさを感じる場面があるかもしれません。しかし、これは不運の宣告ではなく、天があなたに「休息と内省」を促しているサインです。今は無理に抗わず、静かに時を待つことが最善の策となります。",
                "全体的にエネルギーの出力が弱まっており、些細なことで疲れを感じたり、判断力が鈍りやすい傾向にあります。周囲の期待に応えようと自分を追い込むのは避けてください。今は「忍耐」の時であり、嵐が過ぎ去るのを待つことで、次に訪れる大きな運気の波に備えることができます。今日は自分自身を一番に労ってください。"
            ]
        },

        // 【恋愛・金運・仕事：詳細文】カテゴリー順位(1〜48位)に完全連動
        loveDetail: {
            high: "情愛の運気は極めて高く、運命の糸が太く結ばれる暗示があります。言葉にせずとも心が通じ合うような、魂の共鳴を感じる瞬間があるでしょう。アプローチや告白にも最適な、愛の女神の加護がある時です。",
            mid: "愛の気流は安定しています。特別な刺激はなくとも、信頼関係が深まる丁寧なやり取りが、将来の大きな実りへと繋がります。今は派手な行動より、相手の話に耳を傾ける優しさが運気を安定させます。",
            low: "今は恋愛に関して動くよりも、自分自身の魅力を磨く内省の時間とすべきです。焦って答えを出そうとすると、ボタンを掛け違える恐れがあります。一人の時間を充実させることが、結果的に次なる良縁を呼び寄せます。"
        },
        moneyDetail: {
            high: "豊かさのエネルギーが力強く循環しています。投資や買い物、あるいは将来への蓄えにおいて、非常に鋭い判断が下せる時です。思わぬ臨時収入や、価値あるものとの出会いが、あなたの財産を豊かにするでしょう。",
            mid: "収支のバランスが取れた堅実な運気です。無駄を省き、本当に必要なものに投資することで、土地の神様からの加護が得られます。派手な勝負は避け、今の資産を守りつつ育てる意識が吉と出ます。",
            low: "財運は一時的に閉じています。衝動的な支出や、うまい儲け話には十分な注意が必要です。財布の紐を固く締め、守りに徹することで難を逃れます。今は「持たざる贅沢」を楽しむ時期と心得ましょう。"
        },
        workDetail: {
            high: "知性と創造性が極限まで高まっています。あなたの発言や取り組みが周囲を動かし、不可能と思われた難題をも打破する突破口となるでしょう。評価は急上昇し、重要な役割や目標達成への大きな一歩を踏み出す、輝かしい起点となります。",
            mid: "基本に忠実であり、地道な努力を重ねることで道が開けます。派手な動きよりも、丁寧な確認作業や試験・業務への準備を徹底することが、最終的な成功への確実な近道となります。周囲との協調を大切にしてください。",
            low: "集中力が散漫になりやすく、細かなミスや見落としが重なりやすい星回りです。一人で抱え込まず、信頼できる仲間に早めに相談することで、大きなトラブルを未然に防げます。今日は無理をせず、早めの休息で英気を養いましょう。"
        },

        // 【グラフ横の短い説明】※ここでエラーが出ていたので復活させました
        loveShorts: {
            S: ["運命の出会いが期待できる最高の日", "パートナーとの愛が劇的に深まる時", "アプローチするなら今が絶好機"],
            A: ["穏やかで幸せな時間を過ごせそう", "素直な気持ちが相手に届く日", "良い出会いの兆しがあります"],
            B: ["現状維持を心がけると吉", "相手の話をよく聞くことが大切", "焦らずゆっくり関係を育んで"],
            C: ["誤解を招きやすいので言動に注意", "感情的な衝突に気をつけてください", "一人の時間を大切にするのが無難"]
        },
        moneyShorts: {
            S: ["臨時収入や昇給のチャンス到来", "投資や宝くじに強いツキあり", "欲しかったものがお得に手に入る"],
            A: ["賢い買い物ができそうな日", "将来のための自己投資は吉", "お金回りが良くスムーズな一日"],
            B: ["収支のバランスを見直すと良い", "計画的な利用を心がけて", "衝動買いは控えたほうが無難"],
            C: ["財布の紐を固く締めるべき日", "詐欺や甘い話には要注意です", "無駄遣いで後悔する可能性大"]
        },
        workShorts: {
            S: ["大きな成果を上げ高い評価を得る日", "リーダーシップを発揮し目標を達成", "新しいアイデアが次々採用されそう"],
            A: ["チームワークや共同作業が成功の鍵", "効率よく課題やタスクを消化できる", "周囲からの信頼が高まる予感です"],
            B: ["基本に忠実に取り組むと吉です", "報告・連絡・相談を大切にすべき時", "無理せず自分のペースで進めて"],
            C: ["ケアレスミスに十分注意して下さい", "確認作業を怠らないようにすべき日", "無理なスケジュールは避けて正解"]
        },

        // 【総合運：結びの文章】
        mainConclusion: {
            S: [
                "総じて、今日は何をやってもうまくいく「無敵」の一日です。感謝の心を忘れずに、この貴重な幸運を存分に味わってください。あなたの決断はすべて正解へと繋がっています。",
                "この素晴らしい運気を活かし、新しい挑戦の扉を叩いてみてください。宇宙はあなたの勇気を称え、必ずや輝かしい未来を用意してくれることでしょう。最高の吉日です。"
            ],
            A: [
                "ポジティブな姿勢を維持することで、運気はさらに盤石なものとなります。笑顔を絶やさず、周囲への感謝を伝えることで、この幸運は長く続いていくことでしょう。",
                "自信を持って一歩前へ踏み出してください。今日のあなたには、それを成し遂げる十分な力と加護が備わっています。今日という一日を大切に、充実させてください。"
            ],
            B: [
                "無理をせず、自分のペースを守ることが開運の鍵となります。リラックスできる時間を意識的に持ち、明日のためにエネルギーを蓄えてください。焦りは禁物です。",
                "着実に進むことが、最終的な成功への一番の近道です。派手な結果は出なくとも、今日のあなたの努力は必ず天に届いています。地道な歩みを止めることなく進みましょう。"
            ],
            C: [
                "今日は「自分を守る日」と割り切り、心穏やかに過ごす工夫をしてください。この経験が、あなたの魂をより深く、強く成長させてくれるはずです。明けない夜はありません。",
                "落ち込む必要はありません。運気は常に巡るものです。今日は自分自身を見つめ直す良い機会と捉え、ゆったりとした心で一日をやり過ごしましょう。明日は吉報が届きます。"
            ]
        }
    };

    // ==========================================
    //  12星座×血液型占い：計算ロジック
    // ==========================================

    function getRank(score) {
        if (score >= 90) return 'S';
        if (score >= 75) return 'A';
        if (score >= 50) return 'B';
        return 'C';
    }

    function calculateScoresForDate(dateStr) {
        let results = [];
        zodiacSigns.forEach(sign => {
            bloodTypes.forEach(blood => {
                const seed = `${dateStr}_${sign.id}_${blood}`;
                const rng = new SeededRandom(seed);
                const loveScore = Math.floor(rng.next() * 52) + 49;
                const moneyScore = Math.floor(rng.next() * 52) + 49;
                const workScore = Math.floor(rng.next() * 52) + 49;
                const totalScore = Math.floor((loveScore + moneyScore + workScore) / 3);
                results.push({
                    sign: sign, blood: blood, totalScore: totalScore,
                    love: { score: loveScore }, money: { score: moneyScore }, work: { score: workScore }
                });
            });
        });
        return results;
    }

    function initZodiacSystem() {
        const dateStr = getJSTDateString();
        const dateParts = dateStr.split('-');
        const display = document.getElementById('current-date-display');
        if (display) {
            display.innerHTML = `${dateParts[0]}年${dateParts[1]}月${dateParts[2]}日 <span class="text-sm font-normal ml-2 text-gray-500 dark:text-gray-400">(毎日 0:00 更新)</span>`;
        }
        generateDailyRanking(dateStr);
        renderRanking();
    }

    function generateDailyRanking(dateStr) {
        let scoredData = calculateScoresForDate(dateStr);
        const decoRng = new SeededRandom(dateStr + "_decoration");
        
        scoredData.sort((a, b) => b.totalScore - a.totalScore);
        scoredData.forEach((d, i) => { 
            d.rank = i + 1;
            const totalRank = getRank(d.totalScore);
            
            // 項目別順位を計算（1〜48位）
            d.love.rank = [...scoredData].sort((a,b) => b.love.score - a.love.score).findIndex(x => x === d) + 1;
            d.money.rank = [...scoredData].sort((a,b) => b.money.score - a.money.score).findIndex(x => x === d) + 1;
            d.work.rank = [...scoredData].sort((a,b) => b.work.score - a.work.score).findIndex(x => x === d) + 1;

            const lR = getRank(d.love.score);
            const mR = getRank(d.money.score);
            const wR = getRank(d.work.score);

            // 短い説明文の抽出（undefined防止）
            d.love.desc = luckComments.loveShorts[lR][Math.floor(decoRng.next() * luckComments.loveShorts[lR].length)];
            d.money.desc = luckComments.moneyShorts[mR][Math.floor(decoRng.next() * luckComments.moneyShorts[mR].length)];
            d.work.desc = luckComments.workShorts[wR][Math.floor(decoRng.next() * luckComments.workShorts[wR].length)];

            // --- 超長文の生成ロジック ---
            const intro = luckComments.mainIntro[totalRank][Math.floor(decoRng.next() * luckComments.mainIntro[totalRank].length)];
            
            const getDetailText = (rank, type) => {
                if (rank <= 10) return luckComments[`${type}Detail`].high;
                if (rank <= 38) return luckComments[`${type}Detail`].mid;
                return luckComments[`${type}Detail`].low;
            };

            const lovePara = `【恋愛運：第${d.love.rank}位】${getDetailText(d.love.rank, 'love')}`;
            const moneyPara = `【金運：第${d.money.rank}位】${getDetailText(d.money.rank, 'money')}`;
            const workPara = `【仕事・勉強運：第${d.work.rank}位】${getDetailText(d.work.rank, 'work')}`;
            
            const conclusion = luckComments.mainConclusion[totalRank][Math.floor(decoRng.next() * luckComments.mainConclusion[totalRank].length)];

            // 全てを繋げて超長文にする
            d.longDesc = `${intro}<br><br>${lovePara}<br><br>${moneyPara}<br><br>${workPara}<br><br>${conclusion}`;

            d.luckyNum = Math.floor(decoRng.next() * 9) + 1;
            d.item = zodiacItemsList[Math.floor(decoRng.next() * zodiacItemsList.length)];
            d.color = zodiacColorsList[Math.floor(decoRng.next() * zodiacColorsList.length)];
            d.calendar = calculateFutureLuck(d.sign.id, d.blood, dateStr);
        });

        dailyRanking = scoredData;
    }

    // 未来30日間の運勢予報ロジック（修正版：同点1位も全員マークする）
    function calculateFutureLuck(signId, bloodType, baseDateStr) {
        let calendarDays = [];
        for(let i=0; i<30; i++) {
            const targetDate = getFutureDateString(baseDateStr, i);
            const dayOfMonth = new Date(targetDate).getDate();
            
            // 1. その日の全48通りの運勢を計算
            let dayAllData = calculateScoresForDate(targetDate);
            
            // 2. 自分のデータを特定
            const me = dayAllData.find(d => d.sign.id === signId && d.blood === bloodType);
            
            // 3. 各項目の「最高得点」を算出
            const maxTotal = Math.max(...dayAllData.map(d => d.totalScore));
            const maxLove = Math.max(...dayAllData.map(d => d.love.score));
            const maxMoney = Math.max(...dayAllData.map(d => d.money.score));
            const maxWork = Math.max(...dayAllData.map(d => d.work.score));

            let marks = [];

            // 4. 自分の点数が最高点と同じならマークを付与（同点1位も含む）
            if (me.totalScore === maxTotal) marks.push('<i class="bi bi-star-fill text-yellow-500"></i>');
            if (me.love.score === maxLove) marks.push('<i class="bi bi-heart-fill text-pink-500"></i>');
            if (me.money.score === maxMoney) marks.push('<i class="bi bi-currency-yen text-yellow-600"></i>');
            if (me.work.score === maxWork) marks.push('<i class="bi bi-pencil-fill text-blue-500"></i>');

            calendarDays.push({ day: dayOfMonth, marks: marks });
        }
        return calendarDays;
    }

    // ==========================================
//  お気に入り切り替え機能（修正版）
// ==========================================
async function toggleFavorite(signId, bloodType) {
    // ボタンのクリックイベントがカードの開閉等に伝播しないようにする
    if(event) event.stopPropagation();

    // ユーザーチェック
    if (!currentState.user) {
        // 未ログイン時はモーダルを出す（既存の関数を使用）
        const modal = document.getElementById('zodiac-login-modal');
        if(modal) modal.style.display = 'flex'; // hiddenクラスを消すかdisplay制御
        modal.classList.remove('hidden');
        return;
    }

    // お気に入りリストにあるか確認
    const index = favoriteList.findIndex(f => f.sign === signId && f.blood === bloodType);
    
    if (index === -1) {
        // 追加 (最大5件)
        if (favoriteList.length >= 5) {
            alert("お気に入りは5件までです");
            return;
        }
        favoriteList.push({ sign: signId, blood: bloodType });
    } else {
        // 削除
        favoriteList.splice(index, 1);
    }

    // UIを即座に更新（再描画）
    renderRanking();
    
    // サーバーに保存 (非同期でバックグラウンド実行)
    try {
        await authFetch(`${API_BASE}/api/favorites`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ favorites: favoriteList })
        });
        // 保存完了後にバッジ更新
        const badge = document.getElementById('fav-status-badge');
        if(badge) badge.textContent = "保存完了";
    } catch(e) {
        console.error("Favorite save failed", e);
    }
}

// カードHTML生成関数 (文字ラベル復活版)
function createCardHTML(data) {
    // お気に入り状態チェック
    const isFav = favoriteList.some(f => f.sign === data.sign.id && f.blood === data.blood);
    
    // ランクスタイルの決定
    // 背景色はCSSで白固定にしているため、ここでは枠線用クラスのみ指定
    let cardClass = "card-rank-normal";
    let badgeClass = "badge-normal";
    
    if (data.rank === 1) { cardClass = "card-rank-1"; badgeClass = "badge-gold"; }
    else if (data.rank === 2) { cardClass = "card-rank-2"; badgeClass = "badge-silver"; }
    else if (data.rank === 3) { cardClass = "card-rank-3"; badgeClass = "badge-bronze"; }

    // スコアバーの色
    const getBarColor = (score) => {
        if(score >= 90) return "#ef4444"; // 赤
        if(score >= 70) return "#eab308"; // 黄
        return "#3b82f6"; // 青
    };

    // カレンダーHTML生成
    const calendarHTML = data.calendar.map(d => {
        const hasMark = d.marks.length > 0;
        const cellClass = hasMark ? 'has-mark' : '';
        const marksStr = d.marks.slice(0, 2).join(''); 
        
        return `
            <div class="zodiac-cal-cell ${cellClass}">
                <span class="zodiac-cal-date">${d.day}</span>
                <div class="zodiac-cal-marks">${marksStr}</div>
            </div>`;
    }).join('');

    return `
        <div class="zodiac-card-box ${cardClass}">
            <div class="zodiac-card-body">
                
                <!-- 1. 左側: ランク・星座アイコン -->
                <div class="flex flex-row md:flex-col items-center md:items-start gap-3 md:w-28 flex-shrink-0">
                    <div class="zodiac-rank-badge ${badgeClass}">${data.rank}</div>
                    <div>
                        <div class="flex items-center gap-1 mb-1">
                            <span class="text-2xl">${data.sign.icon}</span>
                            <button class="fav-star-btn ${isFav ? 'active' : ''}" 
                                    onclick="toggleFavorite('${data.sign.id}', '${data.blood}')">
                                <i class="bi bi-star${isFav ? '-fill' : ''}"></i>
                            </button>
                        </div>
                        <span class="text-lg font-black whitespace-nowrap">${data.sign.name}</span>
                        <div class="mt-1">
                            <span class="inline-block bg-gray-100 dark:bg-zinc-800 px-2 py-0.5 rounded text-xs font-bold border border-gray-200 dark:border-gray-700">
                                ${data.blood}型
                            </span>
                        </div>
                    </div>
                </div>

                <!-- 2. 中央エリア: 文章 + カレンダー(右配置) -->
                <div class="zodiac-content-middle">
                    
                    <!-- 文章エリア -->
                    <div class="zodiac-text-area">
                        <div class="flex flex-wrap items-center gap-3 text-xs font-bold text-gray-500 mb-2">
                            <span class="bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 px-2 py-1 rounded">
                                総合: ${data.totalScore}点
                            </span>
                            <span>ラッキーNo.${data.luckyNum}</span>
                            
                            <!-- ★修正: 文字ラベルを復活 -->
                            <span class="flex items-center gap-1">
                                <i class="bi bi-stars text-yellow-500"></i>
                                <span>ラッキーアイテム：${data.item}</span>
                            </span>
                            <span class="flex items-center gap-1">
                                <i class="bi bi-palette text-pink-500"></i>
                                <span>ラッキーカラー：${data.color}</span>
                            </span>
                        </div>
                        <p class="text-sm leading-6 text-justify text-gray-700 dark:text-gray-300 font-medium">
                            ${data.longDesc}
                        </p>
                    </div>

                    <!-- カレンダーエリア (右側配置・コンパクト・丸角) -->
                    <div class="zodiac-compact-calendar">
                        <h4>30日吉日予報</h4>
                        <div class="zodiac-cal-grid">
                            ${calendarHTML}
                        </div>
                    </div>
                </div>

                <!-- 3. 右端: パラメータバー -->
                <div class="w-full md:w-48 flex-shrink-0 space-y-2 pt-3 md:pt-0 border-t md:border-t-0 md:border-l border-gray-100 dark:border-gray-700 md:pl-4">
                    <div>
                        <div class="flex justify-between text-[10px] font-bold mb-0.5">
                            <span class="flex items-center gap-1"><i class="bi bi-heart-fill text-pink-500"></i> 恋愛</span>
                            <span>${data.love.score}</span>
                        </div>
                        <div style="height:4px; background:#eee; border-radius:2px; overflow:hidden;">
                            <div style="height:100%; width:${data.love.score}%; background:${getBarColor(data.love.score)};"></div>
                        </div>
                        <p class="text-[9px] text-gray-400 mt-0.5 text-right truncate">${data.love.desc}</p>
                    </div>
                    <div>
                        <div class="flex justify-between text-[10px] font-bold mb-0.5">
                            <span class="flex items-center gap-1"><i class="bi bi-currency-yen text-yellow-500"></i> 金運</span>
                            <span>${data.money.score}</span>
                        </div>
                        <div style="height:4px; background:#eee; border-radius:2px; overflow:hidden;">
                            <div style="height:100%; width:${data.money.score}%; background:${getBarColor(data.money.score)};"></div>
                        </div>
                        <p class="text-[9px] text-gray-400 mt-0.5 text-right truncate">${data.money.desc}</p>
                    </div>
                    <div>
                        <div class="flex justify-between text-[10px] font-bold mb-0.5">
                            <span class="flex items-center gap-1"><i class="bi bi-book-fill text-blue-500"></i> 仕事</span>
                            <span>${data.work.score}</span>
                        </div>
                        <div style="height:4px; background:#eee; border-radius:2px; overflow:hidden;">
                            <div style="height:100%; width:${data.work.score}%; background:${getBarColor(data.work.score)};"></div>
                        </div>
                        <p class="text-[9px] text-gray-400 mt-0.5 text-right truncate">${data.work.desc}</p>
                    </div>
                </div>

            </div>
        </div>
    `;
}

    // ランキング描画ロジックの修正 (4位以下を表示させる)
    function renderRanking() {
        const listContainer = document.getElementById('ranking-list');
        const fullListContainer = document.getElementById('full-ranking-list');
        
        if (!listContainer || !fullListContainer) return;
        
        listContainer.innerHTML = ''; 
        fullListContainer.innerHTML = '';
        
        dailyRanking.forEach((data, index) => {
            const html = createCardHTML(data);
            if (index < 3) {
                // 1~3位はメインリストへ
                listContainer.insertAdjacentHTML('beforeend', html);
            } else {
                // 4位以下は隠しリストへ
                fullListContainer.insertAdjacentHTML('beforeend', html);
            }
        });
        
        renderFavorites();
    }

    // --- 12星座用ログインモーダルを閉じる関数（完全修正版） ---
function closeZodiacModal(e) {
    // 引数 e がある場合（背景クリック時）はIDチェック
    // 引数 e が null または undefined の場合（ボタンから直接呼び出し）は強制クローズ
    if (!e || e.target.id === 'zodiac-login-modal') {
        const modal = document.getElementById('zodiac-login-modal');
        if (modal) {
            // Tailwindのhiddenクラスを追加して非表示に
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            
            // 安全のため style.display も操作
            modal.style.display = 'none';
        }
    }
}

// --- Labsのロック制御を含む showView 関数の該当部分（確認用） ---
// 既存の showView 関数内の if(viewId === 'lab') ブロックが以下のようになっているか確認してください
/*
if(viewId === 'lab') {
    const lock = document.getElementById('lab-lock');
    const wrapper = document.getElementById('lab-content-wrapper');
    
    if(!currentState.user) {
        // 未ログイン時
        if(lock) lock.classList.remove('hidden'); // ロック画面を表示
        if(wrapper) wrapper.classList.add('lab-blurred'); // コンテンツだけぼかす
    } else {
        // ログイン時
        if(lock) lock.classList.add('hidden'); // ロック画面を隠す
        if(wrapper) wrapper.classList.remove('lab-blurred'); // ぼかし解除
    }
}
*/
      
    function renderFavorites() {
        const container = document.getElementById('favorites-list');
        const section = document.getElementById('favorites-section');
        if (!container || !section) return;
        container.innerHTML = '';
        if (favoriteList.length === 0) { section.classList.add('hidden'); return; }
        section.classList.remove('hidden');
        favoriteList.forEach(fav => {
            const data = dailyRanking.find(d => d.sign.id === fav.sign && d.blood === fav.blood);
            if (data) container.innerHTML += createCardHTML(data);
        });
    }

    function renderRanking() {
        const listContainer = document.getElementById('ranking-list');
        const fullListContainer = document.getElementById('full-ranking-list');
        if (!listContainer || !fullListContainer) return;
        listContainer.innerHTML = ''; fullListContainer.innerHTML = '';
        dailyRanking.forEach((data, index) => {
            const html = createCardHTML(data);
            if (index < 3) listContainer.insertAdjacentHTML('beforeend', html);
            else fullListContainer.insertAdjacentHTML('beforeend', html);
        });
        renderFavorites();
    }

    function showFullRanking() {
        const fullList = document.getElementById('full-ranking-list');
        const txt = document.getElementById('show-ranking-text');
        if (fullList.classList.contains('hidden')) { fullList.classList.remove('hidden'); txt.textContent = "ランキングを閉じる"; }
        else { fullList.classList.add('hidden'); txt.textContent = "4位以下を見る"; }
    }

    function findMyRank() {
        const signId = document.getElementById('user-sign').value;
        const bloodId = document.getElementById('user-blood').value;
        const resultDiv = document.getElementById('my-rank-result');
        const myData = dailyRanking.find(d => d.sign.id === signId && d.blood === bloodId);
        if (myData) { resultDiv.innerHTML = createCardHTML(myData); resultDiv.classList.remove('hidden'); }
    } 

  // サーバーサイドページネーション用のボタン描画
function renderServerPagination(currentPage, totalItems, perPage) {
    const paginationEl = document.getElementById('history-pagination');
    const totalPages = Math.ceil(totalItems / perPage) || 1;

    if (totalItems === 0) {
        paginationEl.innerHTML = '';
        return;
    }

    let html = '<div class="flex flex-col items-center gap-4">';
    html += '<div class="flex items-center justify-center flex-wrap gap-2">';
    
    // 最初へボタン
    html += `<button onclick="loadHistory(1)" 
             class="px-4 py-2 rounded border bg-white dark:bg-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-700 disabled:opacity-50 transition"
             ${currentPage === 1 ? 'disabled' : ''}>
             <i class="bi bi-chevron-double-left"></i> 最初へ</button>`;

    // 前へボタン
    html += `<button onclick="loadHistory(${currentPage - 1})" 
             class="px-4 py-2 rounded border bg-white dark:bg-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-700 disabled:opacity-50 transition"
             ${currentPage === 1 ? 'disabled' : ''}>
             <i class="bi bi-chevron-left"></i> 前へ</button>`;

    // ページ番号
    html += `<span class="font-bold font-mono mx-4">Page ${currentPage} / ${totalPages}</span>`;

    // 次へボタン
    html += `<button onclick="loadHistory(${currentPage + 1})" 
             class="px-4 py-2 rounded border bg-white dark:bg-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-700 disabled:opacity-50 transition"
             ${currentPage === totalPages ? 'disabled' : ''}>
             次へ <i class="bi bi-chevron-right"></i></button>`;

    // 最後へボタン
    html += `<button onclick="loadHistory(${totalPages})" 
             class="px-4 py-2 rounded border bg-white dark:bg-zinc-800 hover:bg-gray-100 dark:hover:bg-zinc-700 disabled:opacity-50 transition"
             ${currentPage === totalPages ? 'disabled' : ''}>
             最後へ <i class="bi bi-chevron-double-right"></i></button>`;

    html += '</div>';

    // ページジャンプ入力欄
    html += `
        <div class="flex items-center gap-2 text-sm themed-text-sub">
            <input type="number" id="history-jump-input" min="1" max="${totalPages}" value="${currentPage}" 
                   class="w-16 p-1 text-center border rounded themed-input appearance-none" 
                   onkeydown="if(event.key==='Enter') loadHistory(parseInt(this.value))">
            <span>/ ${totalPages} ページへ</span>
            <button onclick="loadHistory(parseInt(document.getElementById('history-jump-input').value))"
                    class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:opacity-80 transition">移動</button>
        </div>
    `;

    html += '</div>';
    paginationEl.innerHTML = html;
}

// ページ切り替えハンドラ
function changeHistoryPage(newPage) {
    historyPageState.page = newPage;
    renderHistoryWithPagination();
    // リストの一番上へスクロール
    const listTop = document.getElementById('history-container');
    if(listTop) listTop.scrollIntoView({ behavior: 'smooth' });
}

        // --- 新規追加: 目次生成とPDFダウンロード機能 ---

    // 1. 目次生成関数
    function initTOC(viewId) {
        const contentAreaId = viewId === 'about' ? 'about-content-area' : 'privacy-content-area';
        const tocContainer = document.getElementById(`${viewId}-toc-container`);
        const tocList = document.getElementById(`${viewId}-toc-list`);
        
        if(!tocContainer || !tocList) return;

        // すでに生成済みなら何もしない（重複防止）
        if(tocList.children.length > 0) {
            tocContainer.classList.remove('hidden');
            return;
        }

        const area = document.getElementById(contentAreaId);
        // H3とH4タグを収集
        const headers = area.querySelectorAll('h3, h4');
        
        if(headers.length === 0) return;

        let tocHTML = '';
        headers.forEach((header, index) => {
            // IDがなければ付与する
            if(!header.id) {
                header.id = `${viewId}-header-${index}`;
            }

            const isH3 = header.tagName.toLowerCase() === 'h3';
            const indent = isH3 ? '' : 'ml-4';
            const icon = isH3 ? 'bi-caret-right-fill' : 'bi-dot';
            const fontSize = isH3 ? 'font-bold' : 'text-xs text-gray-600 dark:text-gray-400';

            tocHTML += `
                <li class="${indent} ${fontSize}">
                    <a href="#${header.id}" class="hover:text-red-500 hover:underline flex items-start transition" onclick="smoothScroll(event, '${header.id}')">
                        <i class="bi ${icon} mt-1 mr-1 flex-shrink-0"></i>
                        <span>${header.textContent}</span>
                    </a>
                </li>
            `;
        });

        tocList.innerHTML = tocHTML;
        tocContainer.classList.remove('hidden');
    }

    // 2. スムーズスクロール用
    function smoothScroll(e, targetId) {
        e.preventDefault();
        const target = document.getElementById(targetId);
        if(target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }


    // 既存の showView 関数を少し修正して、画面表示時に目次を生成するようにする
    const originalShowView = window.showView; // 既存の関数を退避（または直接書き換え）
    
    // ==========================================
    //  ビュー制御・参拝の記録システム (プロフィール廃止・統計特化版)
    // ==========================================

    // 画面切り替え関数 (既存のshowViewを完全に置き換えてください)
    window.showView = function(viewId) {
        // 1. まず全てのビューを非表示にする
        document.querySelectorAll('.view-section').forEach(el => {
            el.classList.remove('active');
            // フェードアウトアニメーション待ち（即時非表示でも動作はする）
            setTimeout(() => {
                if(!el.classList.contains('active')) el.style.display = 'none';
            }, 500);
        });

        // 2. ターゲットを表示
        const target = document.getElementById(`view-${viewId}`);
        if (target) {
            target.style.display = 'block';
            // リフロー強制（アニメーション用）
            void target.offsetWidth; 
            target.classList.add('active');
        }
        currentState.view = viewId;

        // --- ビューごとの固有処理 ---

        // ■ 参拝の記録 (stats) - プロフィールではなく統計のみを表示
        if(viewId === 'stats') {
            const lock = document.getElementById('stats-lock');
            const wrapper = document.getElementById('stats-content-wrapper');
            
            if(!currentState.user) {
                // 未ログイン時：ロック画面を表示 & 背景ぼかし
                if(lock) lock.classList.remove('hidden');
                if(wrapper) {
                    wrapper.classList.add('lab-blurred');
                    // データはダミー表示（ぼかしの下に見えるもの）
                    const totalEl = document.getElementById('stat-total');
                    if(totalEl) totalEl.textContent = "-";
                    
                    const daikichiEl = document.getElementById('stat-daikichi');
                    if(daikichiEl) daikichiEl.textContent = "-";
                    
                    const streakEl = document.getElementById('stat-streak');
                    if(streakEl) streakEl.textContent = "-";
                    
                    const badgeList = document.getElementById('stats-badge-list');
                    if(badgeList) badgeList.innerHTML = '<div class="col-span-full text-center text-gray-400 py-10">記録がありません</div>';
                }
            } else {
                // ログイン時：ロック解除 & データロード
                if(lock) lock.classList.add('hidden');
                if(wrapper) wrapper.classList.remove('lab-blurred');
                loadMyStats(); // 統計データを読み込み
            }
        }

        // ■ TENMEI Labs (lab)
        if(viewId === 'lab') {
            const lock = document.getElementById('lab-lock');
            const wrapper = document.getElementById('lab-content-wrapper');
            if(!currentState.user) {
                if(lock) lock.classList.remove('hidden');
                if(wrapper) wrapper.classList.add('lab-blurred');
            } else {
                if(lock) lock.classList.add('hidden');
                if(wrapper) wrapper.classList.remove('lab-blurred');
            }
        }

        // その他の初期化処理
        if(viewId === 'draw') resetOmikujiPool();
        if(viewId === 'history') loadHistory();
        if(viewId === 'prefecture') renderPrefectureRanking();
        if(viewId === 'about' || viewId === 'privacy') initTOC(viewId);
        if(viewId === 'omamori') OmamoriSystem.reset();
    };

        // プロフィールボタン（ナビゲーション）の挙動
function handleProfileClick() {
    if (currentState.user) {
        // ログイン中なら「アカウント設定画面」を描画して表示
        renderSettingsDashboard();
        showView('profile');
    } else {
        // 未ログインなら認証画面へ
        showView('auth');
    }
}

// アカウント設定ダッシュボードの描画関数
function renderSettingsDashboard() {
    const container = document.getElementById('profile-dashboard-content');
    if (!container || !currentState.user) return;

    const user = currentState.user;
    
    // メールアドレスの表示用加工
    const safeEmail = escapeHtml(user.email);
    const safeName = escapeHtml(user.username);

    // HTML生成
    container.innerHTML = `
        <div class="profile-bento-grid">
            
            <!-- 1. Identity Card (身分証) -->
            <div class="stats-card-interactive profile-card-identity p-6 rounded-2xl">
                <div class="profile-icon-ring">
                    <i class="bi bi-person-fill"></i>
                </div>
                <div class="flex-1">
                    <div class="mb-2">
                        <span class="member-rank-badge"><i class="bi bi-patch-check-fill"></i> 天命乃杜 会員</span>
                    </div>
                    <h3 class="text-2xl font-black mb-1" style="font-family: 'Zen Old Mincho'">${safeName}</h3>
                    <p class="text-sm text-gray-500 font-mono">${safeEmail}</p>
                </div>
            </div>

            <!-- 2. Status Card (クラウド同期状況) -->
            <div class="stats-card-interactive profile-card-status p-6 rounded-2xl">
                <div class="flex items-center gap-2 mb-2 text-green-600 font-bold text-sm">
                    <i class="bi bi-cloud-check-fill text-xl"></i>
                    <span>クラウド同期: 有効</span>
                </div>
                <p class="text-xs text-gray-500 leading-relaxed">
                    あなたの参拝記録、お気に入り、Labs設定は安全にクラウドへ保存されています。
                </p>
                <div class="mt-4 w-full bg-gray-100 dark:bg-zinc-800 h-2 rounded-full overflow-hidden">
                    <div class="bg-green-500 h-full w-full opacity-50"></div>
                </div>
            </div>

            <!-- 3. Edit Form (登録情報変更) -->
            <div class="stats-card-interactive profile-card-edit p-6 rounded-2xl bg-white dark:bg-zinc-900">
                <div class="flex items-center gap-2 mb-6 border-b border-gray-100 dark:border-gray-700 pb-3">
                    <i class="bi bi-pencil-square text-blue-500"></i>
                    <h4 class="font-bold text-lg">登録情報の変更</h4>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="profile-input-group">
                        <label class="profile-input-label">新しいユーザー名</label>
                        <input type="text" id="setting-new-username" class="profile-input-field" placeholder="${safeName}">
                    </div>
                    
                    <div class="profile-input-group">
                        <label class="profile-input-label">新しいパスワード</label>
                        <input type="password" id="setting-new-password" class="profile-input-field" placeholder="変更する場合のみ入力">
                    </div>
                </div>

                <div class="mt-2 text-right">
                    <button onclick="updateAccountSettings()" class="btn-primary py-2 px-6 shadow-md text-sm">
                        <i class="bi bi-save"></i> 変更を保存
                    </button>
                </div>
            </div>

            <!-- 4. Danger Zone (ログアウト・削除) -->
            <div class="stats-card-interactive profile-card-danger p-6 rounded-2xl bg-red-50 dark:bg-red-900/10 border-red-100 dark:border-red-900">
                <div class="flex items-center gap-2 mb-4 text-[var(--accent-red)]">
                    <i class="bi bi-shield-exclamation"></i>
                    <h4 class="font-bold text-sm">アカウント操作</h4>
                </div>
                
                <div class="space-y-3">
                    <button onclick="logout()" class="w-full py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-black font-bold text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-800 transition flex items-center justify-center gap-2">
                        <i class="bi bi-box-arrow-right"></i> ログアウト
                    </button>
                    
                    <button onclick="deleteAccount()" class="w-full py-3 rounded-xl border border-red-200 dark:border-red-800 bg-white dark:bg-black font-bold text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30 transition flex items-center justify-center gap-2">
                        <i class="bi bi-trash"></i> アカウント削除
                    </button>
                </div>
                
                <p class="text-[10px] text-red-500 mt-3 text-center leading-tight opacity-70">
                    ※削除したデータは復元できません。
                </p>
            </div>

        </div>
    `;
}

    // ユーザープロフィールの読み込み
    async function loadUserProfile(username) {
        showLoading(true);
        try {
            // 自分のデータかどうか判定
            const isMe = currentState.user && currentState.user.username === username;
            
            // APIからデータ取得
            const res = await fetch(`${API_BASE}/api/user/profile?username=${encodeURIComponent(username)}`);
            
            if (res.ok) {
                const data = await res.json();
                data.isMe = isMe; // 自分かどうかのフラグを付与
                renderProfilePage(data);
                showView('profile'); // プロフィールビューを表示（HTML側に id="view-profile" が必要）
            } else {
                showToast("ユーザー情報の取得に失敗しました", "error");
            }
        } catch (e) {
            console.error(e);
            showToast("通信エラーが発生しました", "error");
        } finally {
            showLoading(false);
        }
    }

    // プロフィール画面の描画
    function renderProfilePage(data) {
        const container = document.querySelector('#view-profile');
        if (!container) return;

        // ビューの中身を一度クリアして再構築
        container.innerHTML = '';

        // 1. 実績バッジのHTML生成
        let badgesHtml = '';
        if (data.badges && data.badges.length > 0) {
            badgesHtml = data.badges.map(b => {
                // 未獲得はグレーアウト
                const opacity = b.unlocked ? 'opacity-100' : 'opacity-40 grayscale';
                const bgClass = b.unlocked ? 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200' : 'bg-gray-100 dark:bg-zinc-800 border-gray-200';
                
                return `
                    <div class="flex items-center gap-3 p-3 rounded-lg border ${bgClass} ${opacity}">
                        <div class="text-2xl text-yellow-600"><i class="bi ${b.icon}"></i></div>
                        <div>
                            <div class="text-xs font-bold">${b.name}</div>
                            <div class="text-[10px] text-gray-500">${b.description}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 2. 日付フォーマット
        let joined = "----/--/--";
        if (data.joinDate) {
            const d = new Date(data.joinDate);
            if (!isNaN(d.getTime())) {
                joined = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
            }
        }

        // 3. アクションボタン（自分なら編集・ログアウト）
        let actionBtnHtml = '';
        if (data.isMe) {
            actionBtnHtml = `
                <div class="flex gap-2 mt-4 justify-center md:justify-end">
                    <button onclick="openEditProfileModal('${escapeHtml(data.bio)}', '${escapeHtml(data.title)}', '${data.icon}', '${data.color}')" 
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold text-sm hover:opacity-90 shadow-md">
                        <i class="bi bi-pencil-square"></i> プロフィール編集
                    </button>
                    <button onclick="logout()" class="px-4 py-2 bg-gray-500 text-white rounded-lg font-bold text-sm hover:opacity-90 shadow-md">
                        <i class="bi bi-box-arrow-right"></i> ログアウト
                    </button>
                </div>
            `;
        }

        // 4. アイコンの色設定
        const iconColorMap = {
            'gray': '#6b7280', 'red': '#ef4444', 'blue': '#3b82f6', 'green': '#10b981', 
            'yellow': '#eab308', 'purple': '#a855f7', 'pink': '#ec4899', 'black': '#1f2937'
        };
        const iconColor = iconColorMap[data.color] || '#6b7280';

        // 5. HTML組み立て
        const html = `
            <div class="max-w-2xl mx-auto bg-white dark:bg-zinc-900 rounded-xl shadow overflow-hidden relative mt-10">
                <!-- ヘッダー背景 -->
                <div class="h-32 bg-gradient-to-r from-gray-800 to-gray-600 relative"></div>
                
                <!-- アイコン -->
                <div class="absolute top-20 left-6 w-24 h-24 rounded-full bg-white dark:bg-zinc-900 border-4 border-white dark:border-zinc-800 flex items-center justify-center shadow-lg">
                    <div class="text-5xl" style="color: ${iconColor};">
                        <i class="bi ${data.icon || 'bi-person'}"></i>
                    </div>
                </div>

                <div class="pt-16 px-6 pb-6">
                    <div class="flex justify-between items-start flex-wrap">
                        <div>
                            <h2 class="text-2xl font-black text-gray-800 dark:text-gray-100 flex items-center gap-2">
                                ${escapeHtml(data.username)}
                            </h2>
                            <p class="text-sm text-gray-500 font-bold mt-1">
                                <span class="bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 px-2 py-0.5 rounded border border-gray-300 dark:border-gray-700">
                                    ${escapeHtml(data.title || '初詣の旅人')}
                                </span>
                                <span class="ml-2"><i class="bi bi-calendar"></i> 開始: ${joined}</span>
                            </p>
                        </div>
                        ${actionBtnHtml}
                    </div>

                    <!-- 自己紹介 -->
                    <div class="mt-6 p-4 rounded-lg bg-gray-50 dark:bg-zinc-800 border border-gray-200 dark:border-gray-700 text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                        <div style="white-space: pre-wrap;">${escapeHtml(data.bio || '自己紹介はまだありません。')}</div>
                    </div>

                    <!-- 統計情報 -->
                    <h3 class="font-bold text-lg mt-8 mb-4 border-l-4 border-red-500 pl-3">参拝記録</h3>
                    <div class="grid grid-cols-3 gap-4 text-center mb-8">
                        <div class="p-3 bg-gray-50 dark:bg-zinc-800 rounded border border-gray-200 dark:border-gray-700">
                            <div class="text-2xl font-black text-[var(--accent-red)]">${data.stats.totalDraws}</div>
                            <div class="text-xs text-gray-500">総参拝数</div>
                        </div>
                        <div class="p-3 bg-gray-50 dark:bg-zinc-800 rounded border border-gray-200 dark:border-gray-700">
                            <div class="text-2xl font-black text-yellow-600">${data.stats.daikichiCount}</div>
                            <div class="text-xs text-gray-500">大吉獲得</div>
                        </div>
                        <div class="p-3 bg-gray-50 dark:bg-zinc-800 rounded border border-gray-200 dark:border-gray-700">
                            <div class="text-2xl font-black text-purple-600">${data.stats.goshuinCount}</div>
                            <div class="text-xs text-gray-500">参拝日数</div>
                        </div>
                    </div>

                    <!-- 実績バッジ一覧 -->
                    <h3 class="font-bold text-lg mb-4 border-l-4 border-yellow-500 pl-3">功徳の証</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        ${badgesHtml}
                    </div>
                    ${badgesHtml === '' ? '<p class="text-gray-400 text-sm">まだ実績はありません</p>' : ''}
                </div>
            </div>
        `;

        container.innerHTML = html;

        // 自分の実績情報を保存（実績一覧モーダル用）
        if (data.isMe && data.badges) {
            window.myBadges = data.badges.filter(b => b.unlocked).map(b => b.id);
        }
    }

    

    // --- プロフィール編集関連 ---

    // 編集モーダルを開く
    function openEditProfileModal(bio, title, icon, color) {
        const bioInput = document.getElementById('edit-bio');
        const titleInput = document.getElementById('edit-title');
        
        if(bioInput) bioInput.value = (bio === "自己紹介はまだありません。") ? "" : bio;
        if(titleInput) titleInput.value = title;
        
        // 元のコードで定義されている変数を利用
        if (typeof selectedIcon !== 'undefined') selectedIcon = icon || 'bi-person';
        if (typeof selectedColor !== 'undefined') selectedColor = color || 'gray';
        
        renderIconSelector();
        renderColorSelector();
        
        const modal = document.getElementById('edit-profile-modal');
        if(modal) modal.style.display = 'flex';
    }

    // アイコン選択肢描画
    function renderIconSelector() {
        const container = document.getElementById('icon-selector');
        // profileIcons が定義されていない場合は処理しない（エラー回避）
        if(!container || typeof profileIcons === 'undefined') return;
        
        container.innerHTML = profileIcons.map(ic => `
            <div class="icon-option ${ic === selectedIcon ? 'selected' : ''} flex items-center justify-center text-xl cursor-pointer p-2 rounded border hover:bg-gray-100 dark:hover:bg-zinc-700 ${ic === selectedIcon ? 'border-red-500 bg-red-50 dark:bg-red-900/30' : 'border-gray-200 dark:border-gray-600'}" 
                 onclick="selectedIcon='${ic}'; renderIconSelector()">
                <i class="bi ${ic}"></i>
            </div>
        `).join('');
    }

    // 色選択肢描画
    function renderColorSelector() {
        const container = document.getElementById('color-selector');
        // profileColors が定義されていない場合は処理しない
        if(!container || typeof profileColors === 'undefined') return;
        
        const colorMap = { 'gray':'#9ca3af', 'red':'#ef4444', 'blue':'#3b82f6', 'green':'#10b981', 'yellow':'#eab308', 'purple':'#a855f7', 'pink':'#ec4899', 'black':'#1f2937' };
        
        container.innerHTML = profileColors.map(c => `
            <div class="color-option ${c === selectedColor ? 'selected' : ''} w-8 h-8 rounded-full cursor-pointer border-2 ${c === selectedColor ? 'border-gray-900 dark:border-white scale-110' : 'border-transparent'}" 
                 style="background-color: ${colorMap[c]}" 
                 onclick="selectedColor='${c}'; renderColorSelector()"></div>
        `).join('');
    }

    // 編集内容リセット
    function resetProfileEdit() {
        if(!confirm("プロフィールを初期状態に戻しますか？")) return;
        
        document.getElementById('edit-bio').value = "";
        document.getElementById('edit-title').value = "初詣の旅人";
        
        if (typeof selectedIcon !== 'undefined') selectedIcon = 'bi-person';
        if (typeof selectedColor !== 'undefined') selectedColor = 'gray';
        
        renderIconSelector();
        renderColorSelector();
    }

    // 編集内容保存
    async function saveProfileChanges() {
        const bio = document.getElementById('edit-bio').value;
        const title = document.getElementById('edit-title').value || "初詣の旅人";

        showLoading(true);
        try {
            const res = await authFetch(`${API_BASE}/api/user/update_details`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bio, title, icon: selectedIcon, color: selectedColor })
            });
            if (res.ok) {
                showToast("プロフィールを更新しました", "success");
                document.getElementById('edit-profile-modal').style.display = 'none';
                loadUserProfile(currentState.user.username); // 再読み込み
            } else {
                alert("更新に失敗しました");
            }
        } catch(e) { console.error(e); }
        finally { showLoading(false); }
    }
    
        // --- メニュー表示 ---
        function toggleProfileMenu() {
            const menu = document.getElementById('profile-menu-dropdown');
            if(menu) menu.classList.toggle('active');
            // 他をクリックしたら閉じるイベントを追加
            document.addEventListener('click', function closeMenu(e) {
                if (!e.target.closest('.profile-menu-container')) {
                    if(menu) menu.classList.remove('active');
                    document.removeEventListener('click', closeMenu);
                }
            });
        }

        // --- 認証モーダル表示 ---
        function showVerifiedModal(type, username) {
            let title = "", desc = "";
            if (type === 'gold') {
                title = "黄金の認証ユーザー";
                desc = `${username} は、この「運勢・天命乃杜」の運営者、または開発に深く関わる特別なアカウントであることを証明します。<br><br>※このバッジは運営者のみに付与されます。`;
            } else {
                title = "認証済みユーザー";
                desc = `${username} は、所定の手続きを経て本人確認が完了した、信頼できる公式アカウントであることを証明します。`;
            }
            showToast(`<div class="text-left"><h4 class="font-bold mb-1">${title}</h4><p class="text-xs">${desc}</p></div>`, 'info', '認証情報');
        }

        // --- 編集モーダルを開く ---
        function openEditProfileModal(currentBio, currentTitle) {
            document.getElementById('edit-bio').value = currentBio === "自己紹介はまだありません。" ? "" : currentBio;
            document.getElementById('edit-title').value = currentTitle;
            document.getElementById('edit-profile-modal').style.display = 'flex';
        }

        // --- プロフィール保存 ---
        async function saveProfileChanges() {
            const bio = document.getElementById('edit-bio').value;
            const title = document.getElementById('edit-title').value || "初詣の旅人";

            showLoading(true);
            try {
                const res = await authFetch(`${API_BASE}/api/user/update_details`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bio, title })
                });
                if (res.ok) {
                    showToast("プロフィールを更新しました", "success");
                    document.getElementById('edit-profile-modal').style.display = 'none';
                    // リロードして反映
                    loadUserProfile(currentState.user.username);
                } else {
                    alert("更新に失敗しました");
                }
            } catch(e) { console.error(e); }
            finally { showLoading(false); }
        }

       // --- フォロー機能 (エラー詳細表示版) ---
        async function toggleFollow(username, action) {
            if(!currentState.user) return showView('auth');
            
            showLoading(true);
            
            try {
                const res = await authFetch(`${API_BASE}/api/user/follow`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        targetUsername: username, 
                        action: action 
                    })
                });
                
                // レスポンスがJSONかどうか確認
                const contentType = res.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    const data = await res.json();
                    if(res.ok) {
                        const msg = action === 'follow' ? 'フォローしました' : 'フォローを解除しました';
                        showToast(msg, 'success');
                        await loadUserProfile(username);
                    } else {
                        alert(data.error || "操作に失敗しました");
                    }
                } else {
                    // JSONじゃないエラー（Workerがクラッシュした場合など）
                    const text = await res.text();
                    console.error("Server Error:", text);
                    alert("サーバーエラーが発生しました。\n(詳細はコンソールを確認してください)");
                }
            } catch(e) { 
                console.error(e);
                alert("通信エラーが発生しました: " + e.message); 
            } finally { 
                showLoading(false); 
            }
        }
        
        // --- 「参拝者台帳」ボタンの挙動 ---
        function openWorshipperBook() {
            showView('profile-public');
            
            if (currentState.user) {
                // ログイン中：自分のプロフィールを表示
                loadUserProfile(currentState.user.username);
            } else {
                // 未ログイン：空の検索を実行して「最近のユーザー」を表示させる
                // さらに、まだ誰も選択していない状態の画面を表示
                const container = document.getElementById('public-profile-content');
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-[500px] text-gray-500">
                        <i class="bi bi-people-fill text-6xl mb-4 text-gray-300"></i>
                        <p class="text-lg font-bold">参拝者台帳</p>
                        <p class="text-sm mt-2">上の検索バーからユーザーを探すか、<br>表示される候補から選択してください。</p>
                    </div>
                `;
                handleUserSearch(''); // おすすめユーザーを検索候補に出す
                document.querySelector('.user-search-container input').focus();
            }
        }
        
        // リストの状態管理
        let followListState = { type: 'followers', username: '', page: 1 };

        // リスト読み込み
        async function loadFollowList(type, username, page = 1) {
            followListState = { type, username, page };
            const modal = document.getElementById('follow-list-modal');
            const titleEl = document.getElementById('follow-list-title');
            const contentEl = document.getElementById('follow-list-content');
            const pagingEl = document.getElementById('follow-list-pagination');
            
            modal.style.display = 'flex';
            titleEl.textContent = type === 'followers' ? 'フォロワー' : 'フォロー中';
            contentEl.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-red-500" role="status"></div> 読み込み中...</div>';
            pagingEl.innerHTML = '';

            try {
                const res = await fetch(`${API_BASE}/api/user/follow_list?username=${encodeURIComponent(username)}&type=${type}&page=${page}`);
                if (res.ok) {
                    const data = await res.json();
                    renderFollowListContent(data);
                } else {
                    contentEl.innerHTML = '<p class="text-center text-gray-500">読み込みに失敗しました</p>';
                }
            } catch (e) {
                console.error(e);
                contentEl.innerHTML = '<p class="text-center text-gray-500">通信エラー</p>';
            }
        }

        // リスト描画
        function renderFollowListContent(data) {
            const contentEl = document.getElementById('follow-list-content');
            const pagingEl = document.getElementById('follow-list-pagination');

            if (data.users.length === 0) {
                contentEl.innerHTML = '<p class="text-center text-gray-500 py-4">ユーザーがいません</p>';
                return;
            }

            contentEl.innerHTML = data.users.map(u => `
                <div class="follow-user-item" onclick="loadUserProfile('${u.username}'); document.getElementById('follow-list-modal').style.display='none';">
                    <div class="flex items-center">
                        <i class="bi bi-person-circle text-2xl mr-3 text-gray-400"></i>
                        <span class="font-bold text-lg">${escapeHtml(u.username)}</span>
                    </div>
                    <i class="bi bi-chevron-right text-gray-400"></i>
                </div>
            `).join('');
            
            // ページネーション（既存の共通関数を使用するために、カスタムボタンを生成）
            if (data.total > data.perPage) {
                const totalPages = Math.ceil(data.total / data.perPage);
                pagingEl.innerHTML = `
                    <div class="flex justify-center gap-2 items-center">
                        <button onclick="changeFollowListPage(${data.page - 1})" class="px-3 py-1 rounded border disabled:opacity-50" ${data.page === 1 ? 'disabled' : ''}>前へ</button>
                        <span class="text-sm font-bold">${data.page} / ${totalPages}</span>
                        <button onclick="changeFollowListPage(${data.page + 1})" class="px-3 py-1 rounded border disabled:opacity-50" ${data.page === totalPages ? 'disabled' : ''}>次へ</button>
                    </div>
                `;
            } else {
                pagingEl.innerHTML = '';
            }
        }

        // リストのページ切り替え
        function changeFollowListPage(newPage) {
            loadFollowList(followListState.type, followListState.username, newPage);
        }
// アイコン・色データ
        // ▼▼▼ 修正: 運営者用アイコンや、その他使いやすそうなアイコンを追加して開放します ▼▼▼
        const profileIcons = [
            'bi-person', 'bi-flower1', 'bi-star', 'bi-heart', 
            'bi-moon-stars', 'bi-sun', 'bi-sun-fill', // ← 運営者の太陽アイコン
            'bi-tree', 'bi-cloud', 'bi-droplet', 'bi-lightning', 
            'bi-clipboard-check-fill', // ← テスト垢の点検アイコン
            'bi-gem', 'bi-fire', 'bi-snow' // ついでに宝石、火、雪も追加
        ];
        
        const profileColors = ['gray', 'red', 'blue', 'green', 'yellow', 'purple', 'pink', 'black'];
         let selectedIcon = 'bi-person';
        let selectedColor = 'gray';

        // 編集モーダルを開く
        function openEditProfileModal(bio, title, icon, color) {
            document.getElementById('edit-bio').value = bio === "自己紹介はまだありません。" ? "" : bio;
            document.getElementById('edit-title').value = title;
            
            selectedIcon = icon || 'bi-person';
            selectedColor = color || 'gray';
            
            renderIconSelector();
            renderColorSelector();
            
            document.getElementById('edit-profile-modal').style.display = 'flex';
        }

        function renderIconSelector() {
            const container = document.getElementById('icon-selector');
            container.innerHTML = profileIcons.map(ic => `
                <div class="icon-option ${ic === selectedIcon ? 'selected' : ''}" onclick="selectedIcon='${ic}'; renderIconSelector()">
                    <i class="bi ${ic}"></i>
                </div>
            `).join('');
        }

        function renderColorSelector() {
            const container = document.getElementById('color-selector');
            const colorMap = { 'gray':'#9ca3af', 'red':'#ef4444', 'blue':'#3b82f6', 'green':'#10b981', 'yellow':'#eab308', 'purple':'#a855f7', 'pink':'#ec4899', 'black':'#1f2937' };
            container.innerHTML = profileColors.map(c => `
                <div class="color-option ${c === selectedColor ? 'selected' : ''}" style="background-color: ${colorMap[c]}" onclick="selectedColor='${c}'; renderColorSelector()"></div>
            `).join('');
        }

        // リセット機能
        function resetProfileEdit() {
            if(!confirm("プロフィールを初期状態に戻しますか？")) return;
            document.getElementById('edit-bio').value = "";
            document.getElementById('edit-title').value = "初詣の旅人";
            selectedIcon = 'bi-person';
            selectedColor = 'gray';
            renderIconSelector();
            renderColorSelector();
        }

        // 保存
        async function saveProfileChanges() {
            const bio = document.getElementById('edit-bio').value;
            const title = document.getElementById('edit-title').value || "初詣の旅人";

            showLoading(true);
            try {
                const res = await authFetch(`${API_BASE}/api/user/update_details`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bio, title, icon: selectedIcon, color: selectedColor })
                });
                if (res.ok) {
                    showToast("プロフィールを更新しました", "success");
                    document.getElementById('edit-profile-modal').style.display = 'none';
                    loadUserProfile(currentState.user.username);
                } else {
                    alert("更新に失敗しました");
                }
            } catch(e) { console.error(e); }
            finally { showLoading(false); }
        }

        async function toggleBlock(username, action) {
            if(!confirm(`${username} を${action === 'block' ? 'ブロック' : 'ブロック解除'}しますか？`)) return;
            
            showLoading(true);
            try {
                const res = await authFetch(`${API_BASE}/api/user/block`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targetUsername: username, action: action })
                });
                if(res.ok) {
                    showToast(action === 'block' ? 'ブロックしました' : 'ブロックを解除しました', 'success');
                    loadUserProfile(username);
                } else {
                    alert("操作に失敗しました");
                }
            } catch(e) { console.error(e); }
            finally { showLoading(false); }
        }

        // 認証詳細モーダル（Meta風 + 申請機能付き + 高画質黄金バッジ）
        function openVerifiedModal(type, username) {
            const modal = document.getElementById('verified-modal');
            const iconArea = document.getElementById('verified-icon-area');
            const titleEl = document.getElementById('verified-title');
            const descEl = document.getElementById('verified-desc');
            const safeName = escapeHtml(username);
            
            // 自分かどうかチェック
            const isMe = currentState.user && currentState.user.username === username;

            if (type === 'gold') {
                // --- 黄金認証（高画質SVG） ---
                // アイコンエリアに巨大なSVGを表示
                iconArea.innerHTML = getGoldBadgeIcon("w-20 h-20"); // 80px四方の高解像度
                
                titleEl.textContent = "黄金認証済みユーザー";
                titleEl.className = "text-xl font-black mb-4 text-gray-900 dark:text-white";
                descEl.innerHTML = `
                    <div class="text-left text-sm leading-relaxed">
                        <strong class="block text-base mb-2 text-gray-800 dark:text-gray-200">${safeName}さんは黄金認証済みです</strong>
                        この黄金のバッジは、運勢・天命乃杜の運営者、またはシステムの開発・管理に深く携わる特別なアカウントであることを証明します。
                        <br><br>
                        <span class="text-xs text-gray-500">※金属光沢を持つこのバッジは、最高位の権限者のみに表示されます。</span>
                        ${isMe ? '<br><br><button onclick="openAdminVerifyPanel()" class="w-full py-2 bg-yellow-600 text-white font-bold rounded shadow text-sm hover:bg-yellow-700 transition">管理者：認証審査パネルを開く</button>' : ''}
                    </div>
                `;
        
            } else if (type === 'blue') {
                // ブルー（公式）
                iconArea.innerHTML = '<i class="bi bi-patch-check-fill text-blue-500"></i>';
                titleEl.textContent = "認証済みユーザー";
                titleEl.className = "text-xl font-black mb-4 text-gray-900 dark:text-white";
                descEl.innerHTML = `
                    <div class="text-left text-sm leading-relaxed">
                        <strong class="block text-base mb-2 text-gray-800 dark:text-gray-200">${safeName}さんは天命認証済みです</strong>
                        認証バッジを持つアカウントは認証済みであり、天命乃杜への特別貢献者、または著名な人物や公認アカウントである場合があります。
                    </div>
                `;
            } else {
                // バッジなし（自分が見た時だけ申請ボタンを出す）
                if (isMe) {
                    iconArea.innerHTML = '<i class="bi bi-person-circle text-gray-400"></i>';
                    titleEl.textContent = "未認証アカウント";
                    titleEl.className = "text-xl font-black mb-4 text-gray-500";
                    descEl.innerHTML = `
                        <div class="text-left text-sm leading-relaxed">
                            <strong class="block text-base mb-2 text-gray-800 dark:text-gray-200">認証バッジを取得しませんか？</strong>
                            認証バッジを持つアカウントは、信頼できる公式アカウントであることを証明します。<br>
                            <br>
                            <button onclick="document.getElementById('verification-apply-modal').style.display='flex'; document.getElementById('verified-modal').style.display='none';" 
                                class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow transition">
                                認証を開始する
                            </button>
                        </div>
                    `;
                } else {
                    return; // 他人の未認証は何も出さない
                }
            }
            
            modal.style.display = 'flex';
        }

        // --- 実績一覧表示機能 ---
        async function showAllBadgesModal() {
            const modal = document.getElementById('all-badges-modal');
            const listEl = document.getElementById('all-badges-list');
            
            modal.style.display = 'flex';
            listEl.innerHTML = '<div class="col-span-full text-center py-8"><div class="spinner-border text-yellow-500" role="status"></div> 読み込み中...</div>';

            try {
                // マスターデータを取得
                const res = await fetch(`${API_BASE}/api/badges`);
                if(res.ok) {
                    const data = await res.json();
                    const allBadges = data.badges;
                    
                    // 自分の持っているバッジID（renderProfilePageで保存したもの、なければ空）
                    const myOwnedIds = window.myBadges || [];

                    let html = '';
                    allBadges.forEach(b => {
                        const isUnlocked = myOwnedIds.includes(b.id);
                        // 未獲得ならグレーアウト
                        const opacity = isUnlocked ? 'opacity-100' : 'opacity-50 grayscale';
                        const statusIcon = isUnlocked ? '<i class="bi bi-check-circle-fill text-green-500"></i>' : '<i class="bi bi-lock-fill text-gray-400"></i>';
                        const bgClass = isUnlocked ? 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200' : 'bg-gray-100 dark:bg-zinc-800 border-gray-300';
                        
                        html += `
                            <div class="flex items-center gap-4 p-4 rounded-lg border ${bgClass} ${opacity} transition hover:opacity-100">
                                <div class="w-12 h-12 flex-shrink-0 flex items-center justify-center rounded-full bg-white dark:bg-black text-2xl text-yellow-600 shadow-sm">
                                    <i class="bi ${b.icon}"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <h4 class="font-bold text-sm">${b.name}</h4>
                                        ${statusIcon}
                                    </div>
                                    <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">${b.description}</p>
                                    <p class="text-[10px] text-gray-400 mt-1 font-mono">条件: ${b.condition_type} >= ${b.condition_value}</p>
                                </div>
                            </div>
                        `;
                    });
                    listEl.innerHTML = html;
                }
            } catch(e) {
                console.error(e);
                listEl.innerHTML = '<p class="text-center text-red-500">読み込みに失敗しました</p>';
            }
        }

        // 掲示板データの読み込み
        async function loadBoard(page = 1) {
            const list = document.getElementById('board-list');
            try {
                const res = await fetch(`${API_BASE}/api/board/list?page=${page}`);
                if(res.ok) {
                    const data = await res.json();
                    renderBoardList(data);
                }
            } catch(e) { console.error(e); }
        }

        function renderBoardList(data) {
            const container = document.getElementById('board-list');
            container.innerHTML = data.posts.map(p => {
                const date = new Date(p.created_at).toLocaleString();
                // おみくじ引用がある場合
                const omikuji = p.omikuji_result ? JSON.parse(p.omikuji_result) : null;
                const omikujiHtml = omikuji ? `<div class="bg-red-50 dark:bg-red-900/10 p-2 rounded border-l-4 border-red-500 text-sm mb-2">引用運勢: <strong>${omikuji.type}</strong></div>` : '';

                return `
                    <div class="themed-card p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-indigo-600" onclick="loadUserProfile('${p.username}')" style="cursor:pointer">@${escapeHtml(p.username)}</span>
                            <span class="text-[10px] text-gray-400">${date}</span>
                        </div>
                        ${omikujiHtml}
                        <p class="text-sm mb-4" style="white-space: pre-wrap;">${escapeHtml(p.content)}</p>
                        <div class="flex gap-4 border-t pt-3">
                            <button onclick="reactPost(${p.id}, 'like')" class="text-xs themed-text-sub hover:text-red-500">
                                <i class="bi bi-heart"></i> ${p.reaction_count || 0}
                            </button>
                            <button onclick="openCommentModal(${p.id})" class="text-xs themed-text-sub hover:text-blue-500">
                                <i class="bi bi-chat"></i> ${p.comment_count || 0}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // ページネーション描画
            renderServerPaginationForBoard(data.page, data.total, 10);
        }

        async function submitBoardPost() {
            const content = document.getElementById('board-post-input').value;
            if(!content) return;
            
            // 直近のおみくじ結果を引用するかどうか（任意）
            let omikuji_result = null;
            if (currentState.lastResult) {
                omikuji_result = JSON.stringify({ type: currentState.lastResult.type });
            }

            try {
                const res = await authFetch(`${API_BASE}/api/board/post`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ content, omikuji_result })
                });
                if(res.ok) {
                    showToast("掲示板に奉納しました", "success");
                    document.getElementById('board-post-input').value = "";
                    loadBoard(1);
                } else {
                    const data = await res.json();
                    showToast(data.message, "warning");
                }
            } catch(e) { console.error(e); }
        }

        
// ==========================================
    //  参拝掲示板システム (定型文・リアクション対応版)
    // ==========================================
    
    // 定型文データ（スパム防止のためこれのみ許可）
    const BOARD_PHRASES = {
        "挨拶": ["本日の参拝に参りました。", "おはようございます。", "今週も良い一週間になりますように。", "心を静めて、祈ります。", "皆様に幸多からんことを。"],
        "祈願": ["家内安全を祈ります。", "良縁に恵まれますように。", "試験合格！全力を尽くします。", "健康第一。平穏無事を願います。", "大願成就。夢が叶いますように。", "世界が平和でありますように。"],
        "感謝": ["神恩感謝。いつもありがとうございます。", "無事に一日を終えられました。", "良いことがありました。感謝。", "ピンチを乗り越えました。お守りください。", "すべての巡り合わせに感謝します。"],
        "おみくじ": ["大吉でした！精進します。", "凶でした...気を引き締めます。", "神託を胸に刻みます。", "待ち人、早く来て。", "意外な結果に驚いています。", "厳しいお言葉、真摯に受け止めます。"],
        "決意": ["明日から本気出します。", "迷いを断ち切りました。", "新しい一歩を踏み出します。", "自分を信じて進みます。", "過去は振り返りません。"]
    };

    const BoardSystem = {
        selectedCategory: "挨拶",
        selectedContent: null,
        attachedOmikuji: null,

        // 初期化（カテゴリボタン生成など）
        init: function() {
            const catContainer = document.getElementById('phrase-categories');
            if(!catContainer) return; // 存在しないページでのエラー防止

            catContainer.innerHTML = Object.keys(BOARD_PHRASES).map((cat, i) => `
                <button onclick="BoardSystem.selectCategory('${cat}')" 
                    class="px-4 py-1 rounded-full text-sm font-bold whitespace-nowrap transition border ${i===0 ? 'bg-red-600 text-white border-red-600' : 'bg-white dark:bg-zinc-800 text-gray-600 border-gray-300'}">
                    ${cat}
                </button>
            `).join('');
            
            this.selectCategory("挨拶");
        },

        // カテゴリ切り替え
        selectCategory: function(cat) {
            this.selectedCategory = cat;
            
            // タブの見た目更新
            const btns = document.getElementById('phrase-categories').querySelectorAll('button');
            btns.forEach(b => {
                if(b.innerText === cat) {
                    b.className = "px-4 py-1 rounded-full text-sm font-bold whitespace-nowrap transition border bg-red-600 text-white border-red-600 shadow";
                } else {
                    b.className = "px-4 py-1 rounded-full text-sm font-bold whitespace-nowrap transition border bg-white dark:bg-zinc-800 text-gray-600 border-gray-300 hover:bg-gray-100";
                }
            });

            // グリッド更新
            const grid = document.getElementById('phrase-grid');
            grid.innerHTML = BOARD_PHRASES[cat].map(text => `
                <button onclick="BoardSystem.selectPhrase('${text}')" 
                    class="text-left text-sm p-3 rounded border bg-white dark:bg-zinc-800 hover:bg-red-50 dark:hover:bg-red-900/30 transition border-gray-200 dark:border-gray-700">
                    ${text}
                </button>
            `).join('');
        },

        // 文言選択
        selectPhrase: function(text) {
            this.selectedContent = text;
            const display = document.getElementById('selected-phrase-display');
            display.textContent = text;
            display.classList.remove('text-gray-400');
            display.classList.add('text-gray-800', 'dark:text-white', 'font-bold');
            
            // 送信ボタン有効化
            const btn = document.getElementById('board-submit-btn');
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
        },

        // おみくじ結果からシェアする（画面遷移付き）
        shareResultToBoard: function() {
            if(!currentState.lastResult) return alert("結果がありません");
            
            // データをセット
            this.attachedOmikuji = {
                type: currentState.lastResult.type,
                poem: currentState.lastResult.poem
            };

            // 掲示板ビューへ移動
            showView('board');
            
            // プレビュー表示
            const preview = document.getElementById('post-omikuji-preview');
            const content = document.getElementById('post-omikuji-content');
            content.innerHTML = `【${this.attachedOmikuji.type}】 ${this.attachedOmikuji.poem}`;
            preview.classList.remove('hidden');
            
            // 「おみくじ」カテゴリを自動選択
            this.selectCategory("おみくじ");
            
            // ページ上部へ
            window.scrollTo(0, 0);
        },

        clearOmikuji: function() {
            this.attachedOmikuji = null;
            document.getElementById('post-omikuji-preview').classList.add('hidden');
        },

        // 投稿送信
        submit: async function() {
            if(!currentState.user) return showView('auth');
            if(!this.selectedContent) return;

            const btn = document.getElementById('board-submit-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 奉納中...';

            try {
                // authFetch は既存の認証付きfetch関数を使用
                const res = await authFetch(`${API_BASE}/api/board/post`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        category: this.selectedCategory,
                        content: this.selectedContent,
                        omikuji_data: this.attachedOmikuji 
                    })
                });

                if(res.ok) {
                    showToast("掲示板に奉納しました", "success");
                    this.resetForm();
                    this.load(1);
                } else {
                    const data = await res.json();
                    showToast(data.message || "奉納に失敗しました", "warning");
                }
            } catch(e) {
                console.error(e);
                alert("通信エラーが発生しました");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-send-fill"></i> 奉納する';
            }
        },

        resetForm: function() {
            this.selectedContent = null;
            this.attachedOmikuji = null;
            document.getElementById('selected-phrase-display').textContent = "（上のリストから選んでください）";
            document.getElementById('selected-phrase-display').classList.add('text-gray-400');
            document.getElementById('board-submit-btn').classList.add('opacity-50', 'cursor-not-allowed');
            document.getElementById('post-omikuji-preview').classList.add('hidden');
        },

        // タイムライン読み込み
        load: async function(page = 1) {
            const list = document.getElementById('board-list');
            if(page === 1) list.innerHTML = '<div class="text-center py-8"><div class="spinner-border text-red-500" role="status"></div> 読み込み中...</div>';

            try {
                // ハイブリッド認証用にヘッダーをつける（自分のリアクション判定のため）
                const res = await authFetch(`${API_BASE}/api/board/list?page=${page}`, { method: 'GET' });
                
                if(res.ok) {
                    const data = await res.json();
                    this.renderList(data);
                }
            } catch(e) { console.error(e); }
        },

        // 描画
        renderList: function(data) {
            const list = document.getElementById('board-list');
            const pagination = document.getElementById('board-pagination');
            
            if(data.posts.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-10">まだ奉納はありません。<br>最初の一言を奉納しましょう。</div>';
                pagination.innerHTML = '';
                return;
            }

            list.innerHTML = data.posts.map(post => {
                const date = new Date(post.created_at);
                const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
                
                // おみくじ引用
                let omikujiHtml = '';
                if(post.omikuji_data) {
                    const omi = JSON.parse(post.omikuji_data);
                    omikujiHtml = `
                        <div class="mt-2 p-2 bg-white dark:bg-black/20 border border-red-200 dark:border-red-900 rounded text-sm flex items-center gap-3">
                            <span class="font-black text-red-600 border border-red-600 px-1 rounded bg-white text-xs">運勢</span>
                            <span class="font-bold text-gray-800 dark:text-gray-200">【${omi.type}】 ${omi.poem || ''}</span>
                        </div>
                    `;
                }

                // アイコン色
                const iconColorMap = { 'gray':'#9ca3af', 'red':'#ef4444', 'blue':'#3b82f6', 'green':'#10b981', 'yellow':'#eab308', 'purple':'#a855f7', 'pink':'#ec4899', 'black':'#1f2937' };
                const iconColor = iconColorMap[post.user_color] || '#9ca3af';

                // 認証バッジ
                let verifiedBadge = '';
                if(post.user_verified === 'gold') verifiedBadge = '<i class="bi bi-patch-check-fill text-yellow-500 ml-1" title="運営"></i>';
                else if(post.user_verified === 'blue') verifiedBadge = '<i class="bi bi-patch-check-fill text-blue-500 ml-1" title="公式"></i>';

                // リアクションボタンの状態
                const heartClass = post.my_reaction ? 'bi-heart-fill text-red-500' : 'bi-heart text-gray-400';
                const countClass = post.my_reaction ? 'text-red-500' : 'text-gray-500';

                return `
                    <div class="bg-white dark:bg-zinc-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition">
                        <div class="flex items-start gap-3">
                            <!-- アイコン -->
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-xl flex-shrink-0 bg-gray-50 border" style="color:${iconColor}; border-color:${iconColor}">
                                <i class="bi ${post.user_icon || 'bi-person'}"></i>
                            </div>
                            
                            <div class="flex-1 min-w-0">
                                <!-- ヘッダー -->
                                <div class="flex justify-between items-center mb-1">
                                    <div class="flex items-center gap-1 overflow-hidden">
                                        <span class="font-bold text-sm truncate cursor-pointer hover:underline" onclick="loadUserProfile('${post.username}')">
                                            ${escapeHtml(post.username)}
                                        </span>
                                        ${verifiedBadge}
                                        <span class="text-xs text-gray-400 ml-2 whitespace-nowrap">${dateStr}</span>
                                    </div>
                                    <span class="text-[10px] bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded text-gray-500">${post.category}</span>
                                </div>

                                <!-- 本文 -->
                                <p class="text-base text-gray-800 dark:text-gray-200 leading-relaxed font-medium">
                                    ${escapeHtml(post.content)}
                                </p>

                                <!-- おみくじ引用 -->
                                ${omikujiHtml}

                                <!-- アクションバー -->
                                <div class="flex items-center gap-6 mt-3 pt-2 border-t border-gray-100 dark:border-gray-700">
                                    <button onclick="BoardSystem.react(${post.id}, this)" class="flex items-center gap-1.5 text-sm group transition ${countClass}">
                                        <div class="p-1.5 rounded-full group-hover:bg-red-50 dark:group-hover:bg-red-900/30 transition">
                                            <i class="bi ${heartClass} transition-transform group-active:scale-125"></i>
                                        </div>
                                        <span class="count">${post.reaction_count}</span>
                                        <span class="text-xs">拍手</span>
                                    </button>
                                    
                                    <!-- コメント機能は定型文方針のため「返信」ではなく「同じ話題で投稿」などに誘導も可。今回はシンプルに -->
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // ページネーション（既存の共通関数 createPaginationHTML を流用可能ならするが、ここでは専用のを簡易実装）
            if(data.total > data.perPage) {
                const totalPages = Math.ceil(data.total / data.perPage);
                pagination.innerHTML = `
                    <button onclick="BoardSystem.load(${data.page - 1})" class="px-3 py-1 border rounded disabled:opacity-50" ${data.page === 1 ? 'disabled' : ''}>前へ</button>
                    <span class="mx-2 font-bold">${data.page} / ${totalPages}</span>
                    <button onclick="BoardSystem.load(${data.page + 1})" class="px-3 py-1 border rounded disabled:opacity-50" ${data.page === totalPages ? 'disabled' : ''}>次へ</button>
                `;
            } else {
                pagination.innerHTML = "";
            }
        },

        // リアクション実行（楽観的UI更新）
        react: async function(postId, btn) {
            if(!currentState.user) return showView('auth');

            const icon = btn.querySelector('i');
            const countSpan = btn.querySelector('.count');
            let currentCount = parseInt(countSpan.innerText);
            
            // 楽観的更新
            const isLiked = icon.classList.contains('bi-heart-fill');
            if(isLiked) {
                icon.className = 'bi bi-heart text-gray-400';
                btn.classList.remove('text-red-500');
                btn.classList.add('text-gray-500');
                countSpan.innerText = Math.max(0, currentCount - 1);
            } else {
                icon.className = 'bi bi-heart-fill text-red-500';
                btn.classList.remove('text-gray-500');
                btn.classList.add('text-red-500');
                // アニメーション
                icon.animate([{transform:'scale(1)'}, {transform:'scale(1.4)'}, {transform:'scale(1)'}], {duration: 200});
                countSpan.innerText = currentCount + 1;
            }

            try {
                const res = await authFetch(`${API_BASE}/api/board/react`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ post_id: postId })
                });
                // サーバーから正しいカウントが返れば補正
                if(res.ok) {
                    const data = await res.json();
                    countSpan.innerText = data.count;
                }
            } catch(e) {
                console.error(e);
            }
        }
    };

    // 初期化実行 (window.onload内などで呼ぶ)
    // BoardSystem.init();

        // 申請送信
        async function submitVerification() {
            const reason = document.getElementById('verify-reason').value;
            if(!reason) return alert("申請理由を入力してください");

            showLoading(true);
            try {
                const res = await authFetch(`${API_BASE}/api/verification/apply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });
                const data = await res.json();
                if(res.ok) {
                    showToast("申請を受け付けました。審査をお待ちください。", "success");
                    document.getElementById('verification-apply-modal').style.display='none';
                } else {
                    alert("申請エラー: " + data.error);
                }
            } catch(e) { console.error(e); alert("通信エラー"); }
            finally { showLoading(false); }
        }

        // 管理者パネルを開く
        async function openAdminVerifyPanel() {
            const modal = document.getElementById('admin-verify-modal');
            const list = document.getElementById('admin-verify-list');
            modal.style.display = 'flex';
            list.innerHTML = '<div class="text-center"><div class="spinner-border text-yellow-500"></div></div>';

            try {
                const res = await authFetch(`${API_BASE}/api/admin/verifications`, { method: 'GET' });
                if(res.ok) {
                    const data = await res.json();
                    renderAdminRequests(data.requests);
                } else {
                    list.innerHTML = '<p class="text-red-500 text-center">権限がありません</p>';
                }
            } catch(e) { list.innerHTML = '<p class="text-red-500 text-center">エラー発生</p>'; }
        }

        // 申請リスト描画
        function renderAdminRequests(requests) {
            const list = document.getElementById('admin-verify-list');
            if(requests.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">現在、保留中の申請はありません。</p>';
                return;
            }

            list.innerHTML = requests.map(req => `
                <div class="bg-gray-50 dark:bg-zinc-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="font-bold text-lg">${escapeHtml(req.username)}</span>
                            <div class="text-xs text-gray-400">${req.user_email}</div>
                        </div>
                        <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">申請中</span>
                    </div>
                    <div class="bg-white dark:bg-black p-3 rounded text-sm text-gray-700 dark:text-gray-300 mb-3 border">
                        ${escapeHtml(req.reason)}
                    </div>
                    <div class="flex gap-2 justify-end">
                        <button onclick="decideVerification(${req.id}, 'reject')" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm">却下</button>
                        <button onclick="decideVerification(${req.id}, 'approve')" class="px-4 py-1 bg-blue-600 text-white font-bold rounded hover:bg-blue-700 text-sm">承認 (バッジ付与)</button>
                    </div>
                </div>
            `).join('');
        }

        // 審査実行
        async function decideVerification(id, decision) {
            if(!confirm(decision === 'approve' ? "このユーザーに公式バッジを付与しますか？" : "申請を却下しますか？")) return;

            showLoading(true);
            try {
                const res = await authFetch(`${API_BASE}/api/admin/decide_verification`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ request_id: id, decision })
                });
                if(res.ok) {
                    showToast(decision === 'approve' ? "承認しました" : "却下しました", "success");
                    openAdminVerifyPanel(); // リスト更新
                } else {
                    alert("処理失敗");
                }
            } catch(e) { console.error(e); }
            finally { showLoading(false); }
        }

        // アカウント情報（ユーザー名・パスワード）の更新処理
async function updateAccountSettings() {
    const newUsername = document.getElementById('setting-new-username').value.trim();
    const newPassword = document.getElementById('setting-new-password').value.trim();

    if (!newUsername && !newPassword) {
        return alert("変更する項目を入力してください");
    }

    if (!confirm("入力した内容でアカウント情報を更新しますか？")) return;

    showLoading(true);
    try {
        const res = await authFetch(`${API_BASE}/api/user/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                newUsername: newUsername || undefined, // 空なら送信しない
                newPassword: newPassword || undefined 
            })
        });

        if (res.ok) {
            const data = await res.json();
            if (data.success) {
                showToast("アカウント情報を更新しました", "success");
                
                // ユーザー名を更新した場合、ローカルの状態も更新
                if (newUsername) {
                    currentState.user.username = newUsername;
                    document.getElementById('setting-current-username').textContent = newUsername;
                    updateAuthUI(); // ナビバーの表示更新
                }
                
                // 入力欄クリア
                document.getElementById('setting-new-username').value = '';
                document.getElementById('setting-new-password').value = '';
            } else {
                alert("更新失敗: " + (data.message || data.error));
            }
        } else {
            alert("通信エラーが発生しました");
        }
    } catch (e) {
        console.error(e);
        alert("エラーが発生しました");
    } finally {
        showLoading(false);
    }
}


        async function startLiveCounter() {
    const el = document.getElementById('live-counter'); 
    const uEl = document.getElementById('worshipper-counter'); 
    const historyGlobalEl = document.getElementById('global-history-count'); 

    async function fetchCount() {
        try {
            const res = await fetch(`${API_BASE}/api/counter`);
            if(res.ok) {
                const data = await res.json();
                const countVal = Number(data.count || 0);
                const userVal = Number(data.userCount || 0);
                
                currentState.liveCount = countVal;

                if(el) el.textContent = countVal.toLocaleString() + "本";
                if(uEl) uEl.textContent = userVal.toLocaleString() + "名";
                if(historyGlobalEl) historyGlobalEl.textContent = countVal.toLocaleString() + "本";

                // ★追加: チャートの更新
                LiveChart.update(countVal, userVal);
            }
        } catch(e) { console.error(e); }
    }
    
    // 初回実行時にチャート初期化
    LiveChart.init(); 
    fetchCount();
    setInterval(fetchCount, 60000);
}

// 統計描画（修正版：独立グラフ・指定デザイン・指定文章）
async function loadMyStats() {
    if (!currentState.user) return;

    try {
        const res = await authFetch(`${API_BASE}/api/user/profile?username=${encodeURIComponent(currentState.user.username)}`, {
            method: 'GET'
        });
        
        if (res.ok) {
            const data = await res.json();
            const s = data.stats;
            
            // 平均値の計算
            let avgTotal = 0;
            if (s.averageFortunes) {
                Object.values(s.averageFortunes).forEach(v => avgTotal += v);
            }
            // ゼロ除算防止
            const avgBase = Math.max(0.1, avgTotal);
            // 小数点第1位まで
            const multiplier = (s.totalDraws / avgBase).toFixed(1);
            const avgTotalDisplay = avgTotal.toFixed(1); // "531.5" のような形式に

            // ----------------------------------------------------
            // 1. ヒーローセクション (カウントアップ)
            // ----------------------------------------------------
            const totalEl = document.getElementById('hero-total-val');
            const daikichiEl = document.getElementById('hero-daikichi-val');
            
            if(totalEl) animateValue(totalEl, 0, s.totalDraws, 1000);
            if(daikichiEl) animateValue(daikichiEl, 0, s.userFortunes['大吉'] || 0, 1000);

            // ----------------------------------------------------
            // 2. インサイトエリア (指定文章フォーマット)
            // ----------------------------------------------------
            const insightEl = document.getElementById('stats-insight-area');
            if(insightEl) {
                insightEl.innerHTML = `
                    <div class="stats-insight-text">
                        現在、この杜には <span class="font-bold">${Number(s.totalUsers || 0).toLocaleString()}</span> 名の参拝者が記録を残しています。<br>
                        あなたは平均的な参拝者と比較して 
                        <span class="stats-insight-highlight">${multiplier}倍</span> 
                        の熱意で参拝されています。<br>
                        <span class="text-xs text-gray-500 mt-1 block">
                            (あなたの総参拝数: ${s.totalDraws.toLocaleString()}回 / 全体平均: ${avgTotalDisplay}回)
                        </span>
                    </div>
                `;
            }

            // ----------------------------------------------------
            // 3. 総参拝数比較グラフ (独立枠)
            // ----------------------------------------------------
            const graphTotalBody = document.getElementById('graph-total-body');
            const gridTotal = document.getElementById('grid-total');
            
            if (graphTotalBody && gridTotal) {
                // 最大値を決定 (1.2倍くらいのマージン)
                const maxTotalVal = Math.max(s.totalDraws, avgTotal, 10) * 1.2;
                
                renderGridLines(gridTotal, maxTotalVal);
                
                // 総参拝数は「紅」で表示
                graphTotalBody.innerHTML = createDualBarRow("総回数", s.totalDraws, avgTotal, maxTotalVal, "bar-red");
            }

            // ----------------------------------------------------
            // 4. 運勢スペクトル描画 (詳細分布)
            // ----------------------------------------------------
            const listEl = document.getElementById('stats-spectrum-list');
            const gridSpectrum = document.getElementById('grid-spectrum');

            if(listEl && gridSpectrum) {
                listEl.innerHTML = '';
                const fortunes = ["大吉", "中吉", "小吉", "吉", "半吉", "末吉", "末小吉", "凶", "小凶", "半凶", "末凶", "大凶"];
                
                // 全項目の中での最大値
                const allVals = [...Object.values(s.userFortunes), ...Object.values(s.averageFortunes)];
                const maxSpecVal = Math.max(...allVals, 5) * 1.2; 

                renderGridLines(gridSpectrum, maxSpecVal);

                fortunes.forEach(f => {
                    const myVal = s.userFortunes[f] || 0;
                    const avgVal = s.averageFortunes[f] || 0;
                    
                    // 色の決定
                    let colorClass = "bar-red"; // デフォルト: 紅
                    if (f === "大吉") colorClass = "bar-gold"; // 黄金
                    else if (f === "大凶") colorClass = "bar-black"; // 黒灰

                    listEl.insertAdjacentHTML('beforeend', createDualBarRow(f, myVal, avgVal, maxSpecVal, colorClass));
                });

                // アニメーション発火
                setTimeout(() => {
                    const bars = document.querySelectorAll('.stats-bar-base');
                    bars.forEach(bar => {
                        bar.style.width = bar.dataset.width;
                    });
                }, 100);
            }
        }
    } catch (e) { console.error(e); }
}

// ヘルパー：グリッド線と数値ラベルの生成 (目安線と値)
function renderGridLines(container, maxValue) {
    container.innerHTML = '';
    const steps = [0, 0.25, 0.5, 0.75, 1];
    
    steps.forEach(p => {
        // 整数に丸めて表示
        const val = Math.floor(maxValue * p);
        const left = p * 100;
        
        container.innerHTML += `
            <div class="grid-line-item" style="left: ${left}%">
                <div class="grid-label-text">${val.toLocaleString()}</div>
            </div>
        `;
    });
}

// ヘルパー：2本のバーを上下に並べて生成する (独立表示)
function createDualBarRow(label, myVal, avgVal, maxVal, colorClass) {
    const myWidth = (myVal / maxVal) * 100;
    const avgWidth = (avgVal / maxVal) * 100;

    return `
        <div class="stats-row-dual">
            <div class="stats-label-modern">${label}</div>
            <div class="stats-bar-area-dual">
                <!-- 上段: 平均 (グレー) -->
                <div class="w-full relative h-[10px]">
                    <div class="stats-bar-base bar-avg" 
                         style="width: 0%;" 
                         data-width="${avgWidth}%"></div>
                </div>
                
                <!-- 下段: 自分 (指定色) -->
                <div class="w-full relative h-[10px]">
                    <div class="stats-bar-base ${colorClass}" 
                         style="width: 0%;" 
                         data-width="${myWidth}%"></div>
                </div>
            </div>
        </div>
    `;
}

// ヘルパー：モダンなバー行のHTML生成
function createModernBarRow(label, myVal, avgVal, maxVal) {
    // 幅(%)計算
    const myWidth = (myVal / maxVal) * 100;
    const avgWidth = (avgVal / maxVal) * 100;

    // 重なり順の制御ロジック
    // 値が「小さい」方を手前(z-index: 2)に、「大きい」方を奥(z-index: 1)にする
    // これにより、大きいバーが小さいバーを隠してしまうのを防ぐ
    let myZ = 1, avgZ = 1;
    if (myVal < avgVal) {
        myZ = 2; // 自分が小さい -> 手前
        avgZ = 1; // 平均が大きい -> 奥
    } else {
        myZ = 1; // 自分が大きい -> 奥
        avgZ = 2; // 平均が小さい -> 手前
    }

    return `
        <div class="stats-row-modern">
            <div class="stats-label-modern">${label}</div>
            <div class="stats-bar-area-modern">
                <!-- 平均バー (Gray) -->
                <div class="stats-bar-base bar-avg" 
                     style="width: 0%; z-index: ${avgZ};" 
                     data-width="${avgWidth}%"></div>
                
                <!-- 自分バー (Red) -->
                <div class="stats-bar-base bar-user" 
                     style="width: 0%; z-index: ${myZ};" 
                     data-width="${myWidth}%"></div>
            </div>
        </div>
    `;
}

// 数字カウントアップ演出ヘルパー
function animateValue(obj, start, end, duration) {
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        // イージングありで整数表示
        obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString();
        if (progress < 1) {
            window.requestAnimationFrame(step);
        } else {
            obj.innerHTML = end.toLocaleString();
        }
    };
    window.requestAnimationFrame(step);
}

// グラフの1行（2本バー）を作成するヘルパー
function createGraphRow(label, myVal, avgVal, maxVal) {
    const row = document.createElement('div');
    row.className = "flex items-center gap-2 w-full";
    const bars = [
        { val: avgVal, color: 'bg-gray-200 dark:bg-zinc-700' },
        { val: myVal, color: 'bg-red-600' }
    ];
    bars.sort((a, b) => a.val - b.val); // 多い方を下にする

    row.innerHTML = `
        <div class="w-16 text-[10px] font-bold text-gray-500 flex-shrink-0">${label}</div>
        <div class="flex-1 space-y-1">
            ${bars.map(b => `
                <div class="w-full h-1.5 bg-transparent relative">
                    <div class="h-full rounded-full bar-animate-fast ${b.color}" 
                         style="width: 0%" data-target-width="${(b.val / maxVal * 100)}%"></div>
                </div>
            `).join('')}
        </div>
        <div class="w-20 text-right text-[9px] font-mono text-gray-400 flex-shrink-0">
            ${myVal} <span class="opacity-30">/ ${avgVal.toFixed(1)}</span>
        </div>
    `;
    return row;
}

// 単体グラフ（総参拝数用）の描画
function renderSingleGraph(containerId, gridId, label, myVal, avgVal) {
    const container = document.getElementById(containerId);
    const grid = document.getElementById(gridId);
    const maxVal = Math.max(myVal, avgVal, 1);
    container.innerHTML = '';
    grid.innerHTML = '';
    renderGridLines(grid, maxVal);
    container.appendChild(createGraphRow(label, myVal, avgVal, maxVal));
}

// 目盛り線の描画
function renderGridLines(container, maxVal) {
    [0, 0.25, 0.5, 0.75, 1].forEach(p => {
        const val = Math.floor(maxVal * p);
        const left = p * 100;
        container.innerHTML += `
            <div class="grid-line" style="left: ${left}%"></div>
            <div class="grid-label" style="left: ${left}%">${val.toLocaleString()}</div>
        `;
    });
}

        // ==========================================
//  Cloudflare Turnstile 制御ロジック
// ==========================================
let turnstileLoginId = null;
let turnstileRegisterId = null;
const SITE_KEY = "0x4AAAAAACP5ArwUHoQ6FdSc"; // ★必ず書き換える

// Turnstile APIが読み込まれたら自動的に実行される関数
window.onloadTurnstileCallback = function() {
    // ログイン用のウィジェット生成
    turnstileLoginId = turnstile.render('#turnstile-login', {
        sitekey: SITE_KEY,
        theme: 'auto',
    });

    // 登録用のウィジェット生成
    turnstileRegisterId = turnstile.render('#turnstile-register', {
        sitekey: SITE_KEY,
        theme: 'auto',
    });
};

// 4. 認証コード送信 (全てのCAPTCHA/Turnstileを完全に除去した最新版)
async function initiateAuth(mode) {
    // 入力要素の取得
    const emailInputId = (mode === 'login') ? 'login-email' : 'reg-email';
    const emailEl = document.getElementById(emailInputId);
    const usernameEl = document.getElementById('reg-username');
    const passEl = document.getElementById(mode === 'login' ? 'login-password' : 'reg-password');

    // 要素が存在しない場合の安全策
    if (!emailEl || !passEl) return; 

    const email = emailEl.value.trim().toLowerCase();
    const pass = passEl.value;
    const username = usernameEl ? usernameEl.value : "";

    // 基本入力チェック
    if(!email || !pass) return alert("メールアドレスとパスワードを入力してください");
    if(mode === 'register' && !username) return alert("ユーザー名を入力してください");

    // 読み込み中表示
    showLoading(true);

    try {
        // API送信 (tokenなしの純粋なリクエスト)
        const res = await fetch(`${API_BASE}/api/auth/send`, { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                email, 
                password: pass, 
                username: mode === 'register' ? username : undefined,
                mode: mode 
            }) 
        });
        
        const data = await res.json();
        
        // レート制限（結界）のチェック
        if (res.status === 429) {
            showToast(data.message, 'warning', '天命の戒め');
            return;
        }

        if(res.ok && data.success) {
            // 成功：認証コード入力画面へ切り替え
            document.getElementById('auth-step-1').classList.add('hidden');
            document.getElementById('auth-step-2').classList.remove('hidden');
            
            const codeInput = document.getElementById('auth-code-input');
            if(codeInput) {
                codeInput.value = '';
                codeInput.focus();
            }
        } else {
            // サーバー側からのエラーを表示
            alert(`送信エラー: ${data.error || data.message || '不明なエラー'}`);
        }
    } catch(e) { 
        console.error("Auth Error:", e);
        alert("通信エラーが発生しました。インターネット接続を確認してください。"); 
    } finally { 
        // 成功・失敗に関わらず読み込み中を消す
        showLoading(false); 
    }
}
        // ==========================================
//  リアルタイム推移グラフ (Wチャート・完全版)
// ==========================================
const LiveChart = {
    data: [], // { time, issued, users, deltaIssued, deltaUsers }
    maxPoints: 60, 
    
    // 設定
    padding: { top: 20, right: 40, bottom: 20, left: 50 }, // 左右の余白確保

    init: function() {
        // ツールチップ作成
        if(!document.getElementById('chart-tooltip-el')) {
            const tt = document.createElement('div');
            tt.id = 'chart-tooltip-el';
            tt.className = 'chart-tooltip';
            document.body.appendChild(tt);
        }

        // イベントリスナー (左右のオーバーレイに対して設定)
        ['total', 'delta'].forEach(type => {
            const overlay = document.getElementById(`overlay-${type}`);
            if(overlay) {
                overlay.addEventListener('mousemove', (e) => this.handleMouseMove(e, type));
                overlay.addEventListener('mouseleave', () => this.handleMouseLeave());
                overlay.addEventListener('touchmove', (e) => this.handleMouseMove(e.touches[0], type), {passive: true});
            }
        });
        
        // ★変更: 初期化時はデータを生成せず、最初のupdateを待つ
    },

    // データの更新 (サーバーから値が来たときに呼ばれる)
    update: function(currentIssued, currentUsers) {
        if (!currentIssued || currentIssued <= 0) return;
        if (!currentUsers) currentUsers = 0;

        const now = new Date();

        // --- 初回データ生成 (過去60分を逆算) ---
        if (this.data.length === 0) {
            this.data = [];
            
            // 平均増加数（仮定）
            const avgIncIssued = 15; 
            const avgIncUsers = 0.5;
            
            // 60分前の仮想スタート値
            let simIssued = Math.max(0, currentIssued - (avgIncIssued * 60));
            let simUsers = Math.max(0, currentUsers - (avgIncUsers * 60));

            for (let i = 0; i < 60; i++) {
                const t = new Date(now.getTime() - (59 - i) * 60000);
                
                let prevIssued = simIssued;
                let prevUsers = simUsers;

                if (i === 59) {
                    simIssued = currentIssued;
                    simUsers = currentUsers;
                } else {
                    // ランダムに増やす
                    const incI = Math.floor(Math.random() * 10 + 5); 
                    const incU = Math.random() < 0.3 ? 1 : 0;
                    simIssued += incI;
                    simUsers += incU;
                    
                    // 現在値を超えないように
                    if(simIssued > currentIssued) simIssued = currentIssued;
                    if(simUsers > currentUsers) simUsers = currentUsers;
                }

                this.data.push({
                    time: t,
                    issued: Math.floor(simIssued),
                    users: Math.floor(simUsers),
                    // 差分（変化量）
                    deltaIssued: Math.max(0, Math.floor(simIssued - prevIssued)),
                    deltaUsers: Math.max(0, Math.floor(simUsers - prevUsers))
                });
            }
            
            const loader = document.getElementById('chart-loading');
            if(loader) loader.classList.add('hidden');

        } else {
            // --- 2回目以降: 差分を計算して追加 ---
            const last = this.data[this.data.length - 1];
            
            // 累計なので減らないように補正
            if (currentIssued < last.issued) currentIssued = last.issued;
            if (currentUsers < last.users) currentUsers = last.users;

            // 差分計算
            const dIssued = currentIssued - last.issued;
            const dUsers = currentUsers - last.users;

            this.data.push({
                time: now,
                issued: currentIssued,
                users: currentUsers,
                deltaIssued: dIssued,
                deltaUsers: dUsers
            });

            if (this.data.length > this.maxPoints) {
                this.data.shift();
            }
        }

        // 描画実行
        this.draw('total');
        this.draw('delta');
    },

    // 描画処理 (type: 'total' or 'delta')
    draw: function(type) {
        const svg = document.getElementById(`chart-svg-${type}`);
        if (!svg || this.data.length === 0) return;

        // SVGのサイズ（固定）
        const width = 400;
        const height = 200;
        const p = this.padding;
        const drawW = width - p.left - p.right;
        const drawH = height - p.top - p.bottom;

        // データ抽出
        const valKeyIssued = type === 'total' ? 'issued' : 'deltaIssued';
        const valKeyUsers = type === 'total' ? 'users' : 'deltaUsers';

        const issuedVals = this.data.map(d => d[valKeyIssued]);
        const usersVals = this.data.map(d => d[valKeyUsers]);

        let minIssued = Math.min(...issuedVals);
        let maxIssued = Math.max(...issuedVals);
        let minUsers = Math.min(...usersVals);
        let maxUsers = Math.max(...usersVals);

        // マージン処理 (グラフが平坦にならないように)
        if (minIssued === maxIssued) { minIssued -= 5; maxIssued += 5; }
        else {
            const margin = (maxIssued - minIssued) * 0.1;
            minIssued -= margin; maxIssued += margin;
        }
        if (minUsers === maxUsers) { minUsers -= 1; maxUsers += 1; }
        else {
            const margin = (maxUsers - minUsers) * 0.1;
            minUsers -= margin; maxUsers += margin;
        }

        // ゼロ未満にならないように（Deltaの場合）
        if (type === 'delta') {
            minIssued = Math.max(0, minIssued);
            minUsers = Math.max(0, minUsers);
        }

        // 座標変換ヘルパー
        const getX = (i) => p.left + (i / (this.data.length - 1)) * drawW;
        const getY = (val, min, max) => {
            const range = max - min || 1;
            return p.top + drawH - ((val - min) / range) * drawH;
        };

        // パス生成
        let dIssued = "", dUsers = "";
        this.data.forEach((d, i) => {
            const x = getX(i);
            const yi = getY(d[valKeyIssued], minIssued, maxIssued);
            const yu = getY(d[valKeyUsers], minUsers, maxUsers);
            const cmd = i === 0 ? "M" : "L";
            dIssued += `${cmd} ${x.toFixed(1)} ${yi.toFixed(1)}`;
            dUsers += `${cmd} ${x.toFixed(1)} ${yu.toFixed(1)}`;
        });

        document.getElementById(`line-${type}-issued`).setAttribute('d', dIssued);
        document.getElementById(`line-${type}-users`).setAttribute('d', dUsers);

        // --- 軸とグリッド ---
        const gridGroup = document.getElementById(`grid-${type}`);
        const axisLeft = document.getElementById(`axis-${type}-left`);
        const axisRight = document.getElementById(`axis-${type}-right`);
        
        let gridHtml = '';
        let leftHtml = '';
        let rightHtml = '';

        // 縦線
        for (let i = 0; i < this.data.length; i += 10) {
            const x = getX(i);
            gridHtml += `<line x1="${x}" y1="${p.top}" x2="${x}" y2="${height - p.bottom}" class="chart-grid-line" />`;
        }

        // 横線 & ラベル
        for (let i = 0; i <= 4; i++) {
            const ratio = i / 4;
            const y = p.top + drawH - (ratio * drawH);
            
            gridHtml += `<line x1="${p.left}" y1="${y}" x2="${width - p.right}" y2="${y}" class="chart-grid-line" />`;
            
            const valLeft = Math.round(minIssued + ratio * (maxIssued - minIssued));
            const valRight = Math.round(minUsers + ratio * (maxUsers - minUsers));

            leftHtml += `<text x="${p.left - 5}" y="${y + 3}" text-anchor="end" class="chart-axis-text">${valLeft.toLocaleString()}</text>`;
            rightHtml += `<text x="${width - p.right + 5}" y="${y + 3}" class="chart-axis-text-right">${valRight.toLocaleString()}</text>`;
        }

        gridGroup.innerHTML = gridHtml;
        axisLeft.innerHTML = leftHtml;
        axisRight.innerHTML = rightHtml;
    },

    // ツールチップ
    handleMouseMove: function(e, type) {
        if(this.data.length === 0) return;

        const svg = document.getElementById(`chart-svg-${type}`);
        const rect = svg.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        
        // SVG内座標系への変換 (400x200固定)
        const scaleX = 400 / rect.width;
        const svgX = mouseX * scaleX;
        
        const width = 400;
        const drawW = width - this.padding.left - this.padding.right;

        // インデックス計算
        let index = Math.round(((svgX - this.padding.left) / drawW) * (this.data.length - 1));
        index = Math.max(0, Math.min(index, this.data.length - 1));
        
        const d = this.data[index];
        const pointX = this.padding.left + (index / (this.data.length - 1)) * drawW;

        // 線の移動
        const hoverLine = document.getElementById(`hover-line-${type}`);
        if(hoverLine) {
            hoverLine.setAttribute('x1', pointX);
            hoverLine.setAttribute('x2', pointX);
            hoverLine.style.opacity = 1;
        }

        // ツールチップ内容
        const tt = document.getElementById('chart-tooltip-el');
        const timeStr = `${d.time.getHours()}:${String(d.time.getMinutes()).padStart(2,'0')}`;
        
        let labelI, valI, labelU, valU;
        
        if (type === 'total') {
            labelI = "発行総数"; valI = d.issued.toLocaleString();
            labelU = "累計参拝者"; valU = d.users.toLocaleString();
        } else {
            labelI = "発行/分"; valI = `+${d.deltaIssued}`;
            labelU = "参拝/分"; valU = `+${d.deltaUsers}`;
        }

        tt.innerHTML = `
            <div class="border-b border-gray-200 dark:border-gray-700 pb-1 mb-1 text-xs text-gray-500 font-mono">${timeStr}</div>
            <div class="flex items-center gap-2 text-yellow-600 text-xs font-bold font-mono"><span class="w-2 h-2 rounded-full bg-yellow-500"></span> ${labelI}: ${valI}</div>
            <div class="flex items-center gap-2 text-red-600 text-xs font-bold font-mono"><span class="w-2 h-2 rounded-full bg-red-500"></span> ${labelU}: ${valU}</div>
        `;

        // 位置調整 (マウスに追従)
        const offsetX = 15;
        const offsetY = 15;
        let left = e.clientX + offsetX;
        let top = e.clientY + offsetY + window.scrollY;

        if (left + tt.offsetWidth > window.innerWidth) {
            left = e.clientX - tt.offsetWidth - offsetX;
        }

        tt.style.left = left + 'px';
        tt.style.top = top + 'px';
        tt.style.opacity = 1;
    },

    handleMouseLeave: function() {
        document.querySelectorAll('.chart-hover-line').forEach(el => el.style.opacity = 0);
        const tt = document.getElementById('chart-tooltip-el');
        if(tt) tt.style.opacity = 0;
    }
};
            
    </script>
</body>
</html>
