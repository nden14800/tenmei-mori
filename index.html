<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>運勢・天命乃杜 | 本格・今日の運勢</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tailwind Config -->
    <script>
      tailwind.config = {
        darkMode: 'class',
      }
    </script>
    <!-- html2canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- フォント -->
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500;600;800&family=Zen+Old+Mincho:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root {
            /* ライトモード変数 */
            --bg-pattern: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4d4d4' fill-opacity='0.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            --bg-color: #fdfbf7;
            --text-main: #2b2b2b;
            --text-sub: #555555;
            --card-bg: #ffffff;
            --card-border: #e6e6e6;
            --accent-red: #b91c1c;
            --accent-gold: #c5a059;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.3);
            --sidebar-bg: rgba(255, 255, 255, 0.75); /* すりガラス用に透明度アップ */
            --input-bg: #ffffff;
            --omi-paper: #fffcf2; 
            --sidebar-width: 80px;
            --sidebar-width-expanded: 240px;
        }

        /* --- ダークモード変数定義 (システム検知と手動.darkを完全に一致させる) --- */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-pattern: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23444444' fill-opacity='0.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
                --bg-color: #1a1a1a;
                --text-main: #e0e0e0;
                --text-sub: #b0b0b0;
                --card-bg: #2c2c2c;
                --card-border: #444444;
                --accent-red: #ff6b6b;
                --accent-gold: #e5c07b;
                --glass-bg: rgba(30, 30, 30, 0.9);
                --glass-border: rgba(255, 255, 255, 0.1);
                --sidebar-bg: rgba(30, 30, 30, 0.75);
                --input-bg: #333333;
                --omi-paper: #fffcf2; 
            }
        }

        /* 手動切り替え (.darkクラス付与時) - システム検知時と100%同じ値を適用 */
        .dark {
            --bg-pattern: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23444444' fill-opacity='0.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") !important;
            --bg-color: #1a1a1a !important;
            --text-main: #e0e0e0 !important;
            --text-sub: #b0b0b0 !important;
            --card-bg: #2c2c2c !important;
            --card-border: #444444 !important;
            --accent-red: #ff6b6b !important;
            --accent-gold: #e5c07b !important;
            --glass-bg: rgba(30, 30, 30, 0.9) !important;
            --glass-border: rgba(255, 255, 255, 0.1) !important;
            --sidebar-bg: rgba(30, 30, 30, 0.75) !important;
            --input-bg: #333333 !important;
            --omi-paper: #fffcf2 !important; 
        }

        /* Lab: 迎春・雅モード */
        body.theme-newyear {
            --bg-color: #fffbf0;
            --bg-pattern: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23d4af37' fill-opacity='0.2'%3E%3Cpath d='M0 0h40v40H0V0zm20 20h20v20H20V20zM0 20h20v20H0V20zM20 0h20v20H20V0z'/%3E%3C/g%3E%3C/svg%3E");
            --accent-red: #e60033; /* 紅白の紅 */
            --accent-gold: #d4af37; /* 金 */
            --card-border: #d4af37;
        }
        body.theme-newyear .nav-btn {
            color: #333;
        }
        body.theme-newyear #sidebar {
            background-color: rgba(255, 252, 240, 0.85);
            border-right: 1px solid #d4af37;
        }

        body {
            font-family: 'Zen Old Mincho', 'Shippori Mincho', serif;
            background-color: var(--bg-color);
            background-image: var(--bg-pattern);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- 汎用テーマクラス --- */
        .themed-card {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-main);
        }
        .themed-text-sub { color: var(--text-sub); }
        .themed-input {
            background-color: var(--input-bg);
            color: var(--text-main);
            border: 1px solid var(--card-border);
        }

        /* --- サイドバー (すりガラス効果強化) --- */
        #sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            backdrop-filter: blur(15px); /* すりガラス効果 */
            -webkit-backdrop-filter: blur(15px);
            border-right: 1px solid var(--glass-border);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 100;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding-top: 20px;
            overflow: hidden;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }
        #sidebar:hover {
            width: var(--sidebar-width-expanded);
        }
        .nav-btn {
            width: 100%;
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--text-main);
            background: none;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
            text-decoration: none;
            height: 60px;
        }
        .nav-btn:hover {
            background-color: rgba(128,128,128,0.1);
        }
        .nav-btn i {
            font-size: 1.5rem;
            min-width: 40px;
            text-align: center;
        }
        /* サイドバー用フラスコSVGのスタイル */
        .nav-btn svg {
            min-width: 40px; /* アイコンの幅を確保 */
            width: 32px;
            height: 32px;
            margin: 0; /* 左寄せではなく中央になるようにマージン調整が必要だがflexで制御 */
            display: block;
            flex-shrink: 0;
        }

        .nav-text {
            opacity: 0;
            transform: translateX(-10px);
            transition: all 0.3s;
            font-weight: bold;
            font-family: 'Zen Old Mincho', serif;
            margin-left: 10px;
        }
        #sidebar:hover .nav-text {
            opacity: 1;
            transform: translateX(0);
        }

        /* --- メインコンテンツ --- */
        #main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
            width: calc(100% - var(--sidebar-width));
            transition: margin-left 0.3s;
        }

        /* --- 共通コンポーネント --- */
        .btn-primary {
            background-color: var(--accent-red);
            color: white;
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .btn-primary:disabled {
            background-color: #999;
            cursor: not-allowed;
            transform: none;
        }
        .btn-outline {
            background-color: transparent;
            color: var(--text-main);
            border: 2px solid var(--text-main);
            padding: 10px 25px;
            border-radius: 30px;
            font-weight: bold;
            transition: all 0.3s;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        .btn-outline:hover {
            background-color: rgba(128,128,128,0.1);
        }

        /* --- 新ローディングスピナー --- */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease; /* 滑らかなフェード */
        }
        #loading-overlay.visible {
            opacity: 1;
        }
        
        .loader-svg {
            width: 80px;
            height: 80px;
            animation: rotate 1s linear infinite;
            transform-origin: center center;
        }
        .loader-path {
            stroke: #ffffff; /* 白色の線 */
            stroke-linecap: round;
            stroke-dasharray: 89 150;
            stroke-dashoffset: 0;
        }
        @keyframes rotate {
            100% { transform: rotate(360deg); }
        }

        /* --- ホーム画面 --- */
        .home-circle-container {
            width: 300px;
            height: 300px;
            border: 2px solid var(--accent-red);
            border-radius: 50%;
            margin: 20px auto;
            position: relative;
            overflow: hidden;
            background: rgba(128,128,128,0.1);
        }
        .flying-paper {
            position: absolute;
            width: 30px;
            height: 60px;
            background: var(--omi-paper);
            border: 1px solid #ccc;
            opacity: 0;
            animation: paperFly 4s infinite linear;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            writing-mode: vertical-rl;
            color: #b91c1c;
        }
        @keyframes paperFly {
            0% { transform: translateY(350px) rotate(0deg); opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translateY(-50px) rotate(360deg); opacity: 0; }
        }

        /* --- おみくじ選択画面 --- */
        .omikuji-pool {
            position: relative;
            width: 100%;
            min-height: 100vh;
            overflow-y: visible;
            perspective: 1000px;
            padding-bottom: 200px;
        }
        .omikuji-stick {
            position: absolute;
            width: 50px;
            height: 140px;
            background-color: var(--omi-paper);
            border: 1px solid #ccc;
            box-shadow: 3px 3px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
            font-family: 'Zen Old Mincho', serif;
            writing-mode: vertical-rl;
            color: var(--accent-red);
            user-select: none;
            border-radius: 4px;
        }
        .omikuji-stick:hover {
            transform: scale(1.15) !important;
            z-index: 50;
            box-shadow: 0 15px 30px rgba(0,0,0,0.4);
            background-color: #fff;
        }
        @keyframes slideInRandom {
            from { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            to { opacity: 1; }
        }

        /* --- カウントダウン --- */
        #countdown-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 999;
            display: none;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 8rem;
            font-family: 'Zen Old Mincho', serif;
        }

        /* --- おみくじ結果カード (新デザイン修正版) --- */
        #result-capture-container {
            width: 600px;
            margin: 0 auto;
            position: relative;
        }
        .result-card-outer {
            width: 600px;
            min-height: 1200px;
            padding: 30px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            font-family: 'Zen Old Mincho', serif;
        }

        /* スタイル1: 大吉 (金・和紙) */
        .style-daikichi {
            background-color: #f3c845;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.25'/%3E%3C/svg%3E");
            border: 8px double #fff;
            color: #3e1e00;
        }
        .style-daikichi .accent-border { border-color: #3e1e00; }
        .style-daikichi .accent-text { color: #8a1c1c; }

        /* スタイル2: 大凶 (黒白・重厚) */
        .style-daikyo {
            background-color: #1a1a1a;
            border: 8px solid #333;
            color: #f0f0f0;
        }
        .style-daikyo .accent-border { border-color: #f0f0f0; }
        .style-daikyo .accent-text { color: #fff; }
        .style-daikyo .red-text { color: #fff !important; }

        /* スタイル3: その他 (標準) */
        .style-normal {
            background-color: #fffcf2;
            border: 8px double #b91c1c;
            color: #333;
        }
        .style-normal .accent-border { border-color: #b91c1c; }
        .style-normal .accent-text { color: #b91c1c; }

        .result-logo-area {
            text-align: center;
            margin-bottom: 10px;
        }
        .result-kamon {
            font-size: 3rem;
            margin-bottom: 5px;
        }
        .result-title-text {
            font-size: 1.5rem;
            font-weight: 900;
            letter-spacing: 0.3em;
        }
        .result-issue-num {
            font-size: 0.9rem;
            margin-bottom: 20px;
            font-family: monospace;
            opacity: 0.8;
        }
        
        .result-circle-box {
            width: 200px;
            height: 200px;
            border: 4px solid currentColor;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            background: rgba(255,255,255,0.1);
        }
        .result-kanji-main {
            font-size: 6rem;
            font-weight: 900;
            line-height: 1;
        }
        .result-label-sub {
            font-size: 1.2rem;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .result-main-message-area {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 40px;
            width: 100%;
            padding: 0 20px;
        }
        .result-poem-vertical {
            writing-mode: vertical-rl;
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 0.2em;
            line-height: 1.8;
            height: 350px;
        }
        .result-advice-box {
            writing-mode: vertical-rl;
            border: 2px solid currentColor;
            padding: 15px 10px;
            font-size: 1rem;
            line-height: 1.8;
            height: 350px;
        }
        .advice-label {
            font-weight: 900;
            border-bottom: 1px solid currentColor; /* 縦書きなので左線に見えるが実際は下 */
            margin-left: 10px;
            padding-bottom: 5px;
        }

        .result-details-grid {
            display: flex;
            flex-direction: row-reverse; /* 縦書きなので右から左へ */
            justify-content: center;
            gap: 15px;
            width: 100%;
            margin-bottom: 40px;
            border-top: 1px solid currentColor;
            border-bottom: 1px solid currentColor;
            padding: 20px 0;
        }
        .detail-column {
            writing-mode: vertical-rl;
            height: 250px;
            font-size: 1.1rem;
            line-height: 1.5;
        }
        .detail-item-label {
            font-weight: 900;
            margin-bottom: 10px;
            display: inline-block;
        }
        .detail-item-content {
            display: inline-block;
        }

        .lucky-area {
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            text-align: left;
        }
        .lucky-box, .unlucky-box {
            border: 1px solid currentColor;
            padding: 15px;
            border-radius: 8px;
        }
        .lucky-title { font-weight: bold; margin-bottom: 10px; border-bottom: 1px dashed currentColor; padding-bottom: 5px; }
        .lucky-row { font-size: 0.9rem; margin-bottom: 4px; display: flex; align-items: flex-start;}
        .lucky-icon { margin-right: 5px; min-width: 20px; text-align: center; }

        .result-footer-info {
            width: 100%;
            text-align: center;
            border-top: 2px solid currentColor;
            padding-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .result-user-name {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .result-date {
            font-size: 0.9rem;
        }
        .result-qr-container {
            background: #fff;
            padding: 5px;
        }

        /* 12星座カード */
        .ranking-card {
            border-radius: 16px; box-shadow: 0 4px 6px var(--shadow); padding: 20px;
            margin-bottom: 20px; transition: transform 0.2s, box-shadow 0.2s; position: relative;
        }
        .ranking-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px var(--shadow); }
        .rank-badge-lg { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.5rem; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); flex-shrink: 0; }
        .rank-1 { background: linear-gradient(135deg, #FFD700, #FDB931); border: 2px solid #fff; }
        .rank-2 { background: linear-gradient(135deg, #E0E0E0, #BDBDBD); }
        .rank-3 { background: linear-gradient(135deg, #CD7F32, #A0522D); }
        .rank-other { background-color: var(--card-border); color: var(--text-sub); font-size: 1.2rem; width: 50px; height: 50px; }
        .param-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--card-border); }
        .param-item { text-align: center; }
        .param-label { font-size: 0.75rem; color: var(--text-main); margin-bottom: 4px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 2px; flex-wrap: wrap; }
        .param-score-text { font-size: 0.9rem; font-weight: 900; color: var(--accent-red); }
        .param-value { font-size: 0.75rem; color: var(--text-sub); margin-bottom: 2px; }
        .score-bar-bg { width: 100%; height: 8px; background-color: var(--card-border); border-radius: 4px; margin-top: 4px; overflow: hidden; }
        .score-bar-fill { height: 100%; border-radius: 4px; }
        .fav-btn {
            position: absolute; top: 15px; right: 15px; background: none; border: none;
            font-size: 1.5rem; color: #ccc; cursor: pointer; transition: color 0.2s, transform 0.2s;
        }
        .fav-btn.active { color: #FFD700; transform: scale(1.1); }
        .fav-btn:hover { transform: scale(1.15); }
        .calendar-wrapper { margin-top: 15px; border-top: 1px dashed var(--card-border); padding-top: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 8px; }
        .calendar-cell { background-color: var(--bg-color); border-radius: 8px; padding: 4px 2px; text-align: center; min-height: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid var(--card-border); }
        .cal-date { font-size: 0.7rem; font-weight: bold; color: var(--text-sub); }
        .cal-mark { font-size: 0.7rem; margin-top: 2px; line-height: 1; }
        .calendar-legend { display: flex; justify-content: center; gap: 10px; margin-top: 8px; font-size: 0.7rem; color: var(--text-sub); flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 2px; }

        /* ビュー制御 */
        .view-section { display: none; opacity: 0; transition: opacity 0.5s; }
        .view-section.active { display: block; opacity: 1; }

        /* おみくじの轍 ぼかし制御 */
        .history-blurred {
            position: relative;
            filter: blur(8px);
            pointer-events: none;
            user-select: none;
            overflow: hidden;
            opacity: 0.7;
        }
        .history-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            text-align: center;
            border: 1px solid var(--card-border);
            width: 80%;
            max-width: 400px;
        }

        /* Labs ぼかし制御 */
        .lab-blurred {
            filter: blur(10px);
            pointer-events: none;
            user-select: none;
            opacity: 0.6;
            transition: all 0.5s;
        }
        .lab-lock-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
            border: 1px solid var(--card-border);
            width: 80%;
            max-width: 400px;
        }
        /* ダークモード時のロック画面 */
        @media (prefers-color-scheme: dark) {
            .lab-lock-overlay {
                background-color: rgba(30, 30, 30, 0.7);
            }
        }

        /* 詳細モーダル (削除予定だが互換性のために残す) */
        #history-detail-modal {
            display: none; 
        }

        /* 記事詳細 */
        .article-container {
            max-width: 800px; margin: 0 auto; padding: 40px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: left; line-height: 2;
        }
        .article-header { border-bottom: 2px solid var(--card-border); padding-bottom: 20px; margin-bottom: 30px; }
        .article-title { font-size: 1.8rem; font-weight: bold; margin-bottom: 10px; }
        .article-meta { color: var(--text-sub); font-size: 0.9rem; display: flex; gap: 15px; }
        .article-tag { background: rgba(128,128,128,0.2); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
        .article-content h3 { font-size: 1.4rem; font-weight: bold; margin: 30px 0 15px; border-left: 4px solid var(--accent-red); padding-left: 10px; }
        .article-content p { margin-bottom: 20px; }

        /* TENMEI Labs (新スタイル) */
        #view-lab {
            background: linear-gradient(135deg, rgba(230,240,255,0.5) 0%, rgba(255,240,245,0.5) 50%, rgba(255,250,230,0.5) 100%);
            border-radius: 20px;
            padding: 30px;
            min-height: 80vh;
        }
        /* 手動ダークモード用 */
        .dark #view-lab {
            background: linear-gradient(135deg, rgba(30,40,60,0.5) 0%, rgba(50,30,40,0.5) 50%, rgba(50,50,30,0.5) 100%);
        }
        /* OS設定ダークモード用 */
        @media (prefers-color-scheme: dark) {
            #view-lab {
                background: linear-gradient(135deg, rgba(30,40,60,0.5) 0%, rgba(50,30,40,0.5) 50%, rgba(50,50,30,0.5) 100%);
            }
        }

        .lab-card {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.5);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 20px;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        /* 手動ダークモード用 */
        .dark .lab-card {
            background-color: rgba(40, 40, 40, 0.7);
            border: 1px solid rgba(255,255,255,0.1);
        }
        /* OS設定ダークモード用 */
        @media (prefers-color-scheme: dark) {
            .lab-card {
                background-color: rgba(40, 40, 40, 0.7);
                border: 1px solid rgba(255,255,255,0.1);
            }
        }
        .lab-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: "";
            height: 16px; width: 16px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #6366f1; } /* インディゴ系に変更 */
        input:checked + .slider:before { transform: translateX(26px); }

        /* Labアイコンのアニメーション定義 (カスタムSVG) */
        .lab-icon-svg {
            width: 30px;
            height: 30px;
            display: inline-block;
        }
        .flask-gradient-def {
            --flask-color-start: #4facfe;
            --flask-color-end: #00f2fe;
        }
        .dark .flask-gradient-def {
            --flask-color-start: #8e2de2;
            --flask-color-end: #4a00e0;
        }
        
        .flask-liquid-path {
            fill: url(#flaskLiquidGradient);
            animation: liquidWave 2s infinite ease-in-out;
            transform-origin: 50% 100%;
        }
        .flask-body-path {
            stroke: currentColor;
            stroke-width: 2.5;
            fill: none;
            stroke-linecap: round; 
            stroke-linejoin: round;
        }
        /* --- Labs フラスコアニメーション修正 --- */
        .flask-bubble {
            fill: rgba(59, 130, 246, 0.6); /* ライトモード: 青色で見やすく */
            animation: bubbleRise 3s infinite ease-in;
        }
        
        /* ダークモード時は白に戻す */
        @media (prefers-color-scheme: dark) {
            .flask-bubble {
                fill: rgba(255, 255, 255, 0.6);
            }
        }
        .dark .flask-bubble {
            fill: rgba(255, 255, 255, 0.6);
        }
        .flask-group {
            animation: flaskShake 3s infinite ease-in-out; /* 揺れを強く、速く */
            transform-origin: 50% 80%;
        }
        
        /* タイトル上の大きいアニメーションフラスコ */
        .title-flask-anim {
            width: 140px;
            height: 140px;
            margin: 0 auto 10px;
        }
        .title-flask-anim .flask-body-path {
            stroke: var(--text-main);
            stroke-width: 2;
        }

        /* サイドバー用の小さいアニメーションフラスコ */
        .nav-btn .lab-icon-svg {
             width: 32px;
             height: 32px;
             margin: 0;
        }
        
        @keyframes liquidWave {
            0%, 100% { transform: scaleY(1) translateY(0) skewX(0deg); }
            25% { transform: scaleY(1.05) translateY(-2px) skewX(2deg); }
            50% { transform: scaleY(1.1) translateY(-3px) skewX(0deg); }
            75% { transform: scaleY(1.05) translateY(-2px) skewX(-2deg); }
        }
        @keyframes flaskShake {
            0%, 100% { transform: rotate(0deg); }
            15% { transform: rotate(12deg); }
            30% { transform: rotate(-10deg); }
            45% { transform: rotate(8deg); }
            60% { transform: rotate(-6deg); }
            75% { transform: rotate(3deg); }
        }
        @keyframes bubbleRise {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translateY(-40px) scale(1.2); opacity: 0; }
        }

        /* 認証コード入力欄（和風） */
        .auth-code-input-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            position: relative;
        }
        .auth-code-input {
            width: 300px;
            height: 60px;
            font-size: 2rem;
            letter-spacing: 0.8em;
            text-align: center;
            border: 3px double var(--accent-red);
            background-color: var(--omi-paper);
            color: var(--text-main);
            font-family: 'Zen Old Mincho', serif;
            border-radius: 4px;
            outline: none;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .auth-code-input:focus {
            box-shadow: 0 0 10px rgba(185, 28, 28, 0.3);
            background-color: #fff;
        }
        .auth-code-deco {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            padding: 0 10px;
            font-size: 0.8rem;
            color: var(--accent-red);
            font-weight: bold;
        }

        /* 認証初期選択画面 */
        .auth-selection-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.3s;
            border: 1px solid var(--card-border);
            background-color: var(--card-bg);
            color: var(--text-main);
        }
        .auth-selection-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            background-color: rgba(128,128,128,0.05);
        }
        .auth-selection-btn i {
            font-size: 1.5rem;
            margin-right: 15px;
        }

        /* 検索フォームスタイル */
        .search-form-container {
            padding: 15px;
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .search-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .search-input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--card-border);
            background-color: var(--input-bg);
            color: var(--text-main);
            font-size: 0.9rem;
        }

        /* 比較表のスタイル */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.9rem;
        }
        .comparison-table th, .comparison-table td {
            border: 1px solid var(--card-border);
            padding: 12px;
            text-align: center;
        }
        .comparison-table th {
            background-color: rgba(128,128,128,0.1);
            font-weight: bold;
        }
        .comparison-table td.highlight {
            background-color: rgba(185, 28, 28, 0.05);
            font-weight: bold;
            color: var(--accent-red);
        }
        .comparison-table tr:nth-child(even) {
            background-color: rgba(128,128,128,0.02);
        }

    </style>
</head>
<body>

    <!-- ローディングスピナー (SVG版) -->
    <div id="loading-overlay">
        <svg class="loader-svg" viewBox="0 0 50 50">
            <circle class="loader-path" cx="25" cy="25" r="20" fill="none" stroke-width="1.5"></circle>
        </svg>
    </div>

    <!-- サイドバー -->
    <nav id="sidebar">
        <button class="nav-btn" onclick="showView('home')">
            <i class="bi bi-house-door"></i>
            <span class="nav-text">ホーム</span>
        </button>
        <button class="nav-btn" onclick="showView('zodiac')">
            <i class="bi bi-stars"></i>
            <span class="nav-text">12星座×血液型占い</span>
        </button>
        <button class="nav-btn" onclick="showView('history')">
            <i class="bi bi-clock-history"></i>
            <span class="nav-text">おみくじの轍</span>
        </button>
        <button class="nav-btn" onclick="showView('news')">
            <i class="bi bi-bell"></i>
            <span class="nav-text">社務所だより</span>
        </button>
        <button class="nav-btn" onclick="showView('column')">
            <i class="bi bi-book"></i>
            <span class="nav-text">神籤草子</span>
        </button>
        <!-- Lab機能ボタン (カスタムSVGアニメーション) -->
        <button class="nav-btn" onclick="showView('lab')">
            <div class="lab-icon-svg">
                <svg viewBox="0 0 24 24" overflow="visible">
                    <!-- 定義: グラデーション -->
                    <defs>
                        <linearGradient id="flaskLiquidGradientSmall" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#4facfe;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#00f2fe;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <g class="flask-group">
                        <path class="flask-liquid-path" style="fill:url(#flaskLiquidGradientSmall)" d="M5 14 C7 13, 9 15, 12 14 C15 13, 17 15, 19 14 L18.5 20 C18.5 21, 18 22, 16 22 L8 22 C6 22, 5.5 21, 5.5 20 Z" />
                        <path class="flask-body-path" d="M9 2 L15 2 L15 7 L20 18 C20.5 19.5, 19 22, 16 22 L8 22 C5 22, 3.5 19.5, 4 18 L9 7 Z" />
                    </g>
                </svg>
            </div>
            <span class="nav-text">TENMEI Labs</span>
        </button>
        
        <button class="nav-btn" onclick="handleProfileClick()" id="nav-login-btn">
            <i class="bi bi-person-circle"></i>
            <span class="nav-text">ログイン/登録</span>
        </button>
        
        <div style="margin-top: auto; width: 100%;">
            <button class="nav-btn" onclick="showView('about')">
                <i class="bi bi-info-circle"></i>
                <span class="nav-text">当サイトについて</span>
            </button>
            <button class="nav-btn" onclick="showView('privacy')">
                <i class="bi bi-shield-lock"></i>
                <span class="nav-text">プライバシー</span>
            </button>
        </div>
    </nav>

    <!-- メインエリア -->
    <main id="main-content">
        
        <!-- ビュー: ホーム -->
        <section id="view-home" class="view-section active text-center max-w-4xl mx-auto">
            <h1 class="text-4xl font-black mb-2 tracking-widest" style="font-family: 'Zen Old Mincho'">運勢・天命乃杜</h1>
            <p class="text-sm font-serif mb-4 tracking-widest uppercase">FORTUNE TENMEI-NO-MORI</p>
            <p class="text-lg font-serif mb-8 themed-text-sub">天命が導く、日々の道しるべ<br>災いを避け、福を招く</p>

            <div class="home-circle-container" id="home-anim-container">
                <!-- JSで紙を生成 -->
            </div>

            <button onclick="startOmikuji()" class="btn-primary text-xl px-12 py-4 mb-8">
                <i class="bi bi-box-seam-fill"></i> おみくじを引く
            </button>

            <!-- カウンター -->
            <div id="home-counter-area" class="themed-card p-4 rounded-lg mb-2">
                <p class="text-sm themed-text-sub">累計発行本数</p>
                <div class="text-3xl font-bold font-mono text-red-700" id="live-counter">---</div>
                <p class="text-xs themed-text-sub mt-1">最終更新: <span id="counter-time">--:--:--</span> (5秒毎更新)</p>
                <p class="text-[10px] themed-text-sub mt-1">※会員様の祈りの数のみが反映されます</p>
            </div>

            <!-- ダッシュボード風グリッド -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-12 text-left">
                <!-- 轍 (統計) -->
                <div class="themed-card p-6 rounded-xl shadow-sm">
                    <h3 class="font-bold text-lg mb-2 border-b border-gray-300 dark:border-gray-600 pb-2"><i class="bi bi-balloon-heart text-red-500"></i> おみくじの轍</h3>
                    <div class="text-xs text-right mb-2 themed-text-sub">更新: <span id="stats-update-time">--:--:--</span></div>
                    
                    <div class="space-y-3 mb-4 text-sm" id="home-history-stats">
                         <!-- 12段階 統計表示 -->
                         <div class="grid grid-cols-1 gap-2">
                             <!-- 大吉 -->
                             <div class="flex justify-between text-xs"><span>大吉</span><span><span id="cnt-daikichi" class="mr-2 font-mono">0</span><span id="stat-daikichi">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-daikichi" class="bg-yellow-400 h-1.5 rounded" style="width: 0%"></div></div>
                             
                             <!-- 中吉 -->
                             <div class="flex justify-between text-xs"><span>中吉</span><span><span id="cnt-chukichi" class="mr-2 font-mono">0</span><span id="stat-chukichi">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-chukichi" class="bg-orange-400 h-1.5 rounded" style="width: 0%"></div></div>

                             <!-- 小吉 -->
                             <div class="flex justify-between text-xs"><span>小吉</span><span><span id="cnt-shokichi" class="mr-2 font-mono">0</span><span id="stat-shokichi">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-shokichi" class="bg-green-400 h-1.5 rounded" style="width: 0%"></div></div>

                             <!-- 吉 -->
                             <div class="flex justify-between text-xs"><span>吉</span><span><span id="cnt-kichi" class="mr-2 font-mono">0</span><span id="stat-kichi">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-kichi" class="bg-red-400 h-1.5 rounded" style="width: 0%"></div></div>

                             <!-- 半吉 -->
                             <div class="flex justify-between text-xs"><span>半吉</span><span><span id="cnt-hankichi" class="mr-2 font-mono">0</span><span id="stat-hankichi">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-hankichi" class="bg-red-300 h-1.5 rounded" style="width: 0%"></div></div>

                             <!-- 末吉 -->
                             <div class="flex justify-between text-xs"><span>末吉</span><span><span id="cnt-suekichi" class="mr-2 font-mono">0</span><span id="stat-suekichi">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-suekichi" class="bg-blue-400 h-1.5 rounded" style="width: 0%"></div></div>

                             <!-- 末小吉 -->
                             <div class="flex justify-between text-xs"><span>末小吉</span><span><span id="cnt-sueshokichi" class="mr-2 font-mono">0</span><span id="stat-sueshokichi">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-sueshokichi" class="bg-blue-300 h-1.5 rounded" style="width: 0%"></div></div>

                             <!-- 凶 -->
                             <div class="flex justify-between text-xs"><span>凶</span><span><span id="cnt-kyo" class="mr-2 font-mono">0</span><span id="stat-kyo">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-kyo" class="bg-gray-400 h-1.5 rounded" style="width: 0%"></div></div>

                             <!-- 小凶 -->
                             <div class="flex justify-between text-xs"><span>小凶</span><span><span id="cnt-shokyo" class="mr-2 font-mono">0</span><span id="stat-shokyo">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-shokyo" class="bg-gray-500 h-1.5 rounded" style="width: 0%"></div></div>

                             <!-- 半凶 -->
                             <div class="flex justify-between text-xs"><span>半凶</span><span><span id="cnt-hankyo" class="mr-2 font-mono">0</span><span id="stat-hankyo">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-hankyo" class="bg-gray-600 h-1.5 rounded" style="width: 0%"></div></div>

                             <!-- 末凶 -->
                             <div class="flex justify-between text-xs"><span>末凶</span><span><span id="cnt-suekyo" class="mr-2 font-mono">0</span><span id="stat-suekyo">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-suekyo" class="bg-gray-700 h-1.5 rounded" style="width: 0%"></div></div>

                             <!-- 大凶 -->
                             <div class="flex justify-between text-xs"><span>大凶</span><span><span id="cnt-daikyo" class="mr-2 font-mono">0</span><span id="stat-daikyo">0.00%</span></span></div>
                             <div class="w-full bg-gray-200 dark:bg-gray-600 h-1.5 rounded mb-1"><div id="bar-daikyo" class="bg-black h-1.5 rounded" style="width: 0%"></div></div>
                         </div>
                    </div>
                    <button onclick="showView('history')" class="text-sm text-red-600 hover:underline">おみくじの轍をもっと見る (全運勢ログ)</button>
                </div>

                <!-- お知らせ -->
                <div class="themed-card p-6 rounded-xl shadow-sm">
                    <h3 class="font-bold text-lg mb-2 border-b border-gray-300 dark:border-gray-600 pb-2"><i class="bi bi-megaphone text-blue-500"></i> 社務所だより</h3>
                    <ul class="text-sm space-y-2 mb-4">
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('news', 2)"><span class="truncate">「運勢・天命乃杜」を公開いたしました。</span><span class="themed-text-sub">2026/1/2</span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('news', 1)"><span class="truncate">あけましておめでとうごさいます</span><span class="themed-text-sub">2026/1/1</span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('news', 3)"><span class="truncate">プレオープンのお知らせ</span><span class="themed-text-sub">2025/12/25</span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('news', 4)"><span class="truncate">サーバーメンテナンス完了</span><span class="themed-text-sub">2025/12/20</span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('news', 5)"><span class="truncate">サイト開設準備室より</span><span class="themed-text-sub">2025/12/10</span></li>
                    </ul>
                    <button onclick="showView('news')" class="text-sm text-blue-600 hover:underline">社務所だよりをもっと見る</button>
                </div>

                <!-- コラム -->
                <div class="themed-card p-6 rounded-xl shadow-sm">
                    <h3 class="font-bold text-lg mb-2 border-b border-gray-300 dark:border-gray-600 pb-2"><i class="bi bi-book text-green-500"></i> 神籤草子 (コラム)</h3>
                    <ul class="text-sm space-y-2 mb-4">
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('column', 1)"><span class="truncate">おみくじの順番（正しい吉凶の順）</span><span class="themed-text-sub"><i class="bi bi-journal-text"></i></span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('column', 2)"><span class="truncate">悪い結果が出ても実は大丈夫？</span><span class="themed-text-sub"><i class="bi bi-journal-text"></i></span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('column', 3)"><span class="truncate">神社での正しい参拝マナー</span><span class="themed-text-sub"><i class="bi bi-journal-text"></i></span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('column', 4)"><span class="truncate">「失せ物」の本当の意味</span><span class="themed-text-sub"><i class="bi bi-journal-text"></i></span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('column', 5)"><span class="truncate">「待ち人」は恋愛だけじゃない</span><span class="themed-text-sub"><i class="bi bi-journal-text"></i></span></li>
                    </ul>
                    <button onclick="showView('column')" class="text-sm text-green-600 hover:underline">神籤草子をもっと見る</button>
                </div>
            </div>
        </section>

        <!-- ビュー: おみくじ選択 -->
        <section id="view-draw" class="view-section relative min-h-screen w-full overflow-hidden" style="overflow-y: auto !important;">
            <h2 class="text-center text-2xl font-bold mb-4 z-10 relative mt-10">直感で一枚お選びください</h2>
            <div id="omikuji-pool" class="omikuji-pool"></div>
            <div class="fixed bottom-10 left-0 w-full text-center z-50 pointer-events-none">
                <button onclick="addOmikuji()" class="btn-primary pointer-events-auto shadow-xl">
                    <i class="bi bi-plus-lg"></i> もっとおみくじを探す
                </button>
            </div>
        </section>

        <!-- ビュー: おみくじ結果 -->
        <section id="view-result" class="view-section text-center">
            <div id="result-display-area" class="py-10">
                <div style="display: flex; justify-content: center; overflow: hidden;">
                    <div id="result-capture-container">
                        <!-- 結果カード (JSで動的生成) -->
                        <div class="result-card-outer" id="result-card-outer"></div>
                    </div>
                </div>

                <!-- アクションボタンエリア -->
                <div class="max-w-xl mx-auto mt-8 p-4 themed-card rounded-lg shadow space-y-4">
                    <p class="font-bold">結果をシェアする</p>
                    
                    <button onclick="generateResultImage()" class="btn-outline w-full justify-center">
                        <i class="bi bi-download"></i> 画像を保存する
                    </button>
                    
                    <div id="gen-img-status" class="text-sm themed-text-sub"></div>
                    <div id="generated-image-container" class="hidden">
                        <p class="text-green-600 font-bold mb-2">画像の生成完了</p>
                        <!-- 生成画像 -->
                    </div>

                    <!-- index.html 内の view-result セクションにあるシェアボタンエリア -->

<div class="flex flex-col gap-3 mt-4">
    <!-- 追加: X用の注意書き -->
    <p class="text-xs text-red-600 dark:text-red-400 font-bold text-center border border-red-200 dark:border-red-900 bg-red-50 dark:bg-red-900/20 p-2 rounded">
        ※X(Twitter)投稿時、画像は自動添付されません。<br>
        ボタンを押すと画像が保存されますので、<br>開いた投稿画面で手動で添付してください。
    </p>

    <button onclick="shareToX()" class="bg-black text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:opacity-80">
        <i class="bi bi-twitter-x"></i> Xでシェア (画像を保存して投稿)
    </button>
    <button onclick="shareToFB()" class="bg-blue-600 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:opacity-80">
        <i class="bi bi-facebook"></i> Facebookでシェア
    </button>
    <button onclick="shareToLine()" class="bg-green-500 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:opacity-80">
        <i class="bi bi-line"></i> LINEでシェア
    </button>
</div>
                    <div class="mt-4">
                        <button onclick="showView('home')" class="text-sm underline text-gray-500">ホームに戻る</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ビュー: 12星座×血液型占い -->
        <section id="view-zodiac" class="view-section">
             <div class="text-center mb-8">
                <h2 class="text-2xl font-bold mb-2 flex items-center justify-center gap-2">
                    <i class="bi bi-trophy-fill text-yellow-500"></i> 最強運勢ランキング
                </h2>
                <p class="text-lg font-serif" id="current-date-display"></p>
            </div>
    
            <!-- お気に入りセクション -->
            <div id="favorites-section" class="hidden w-full mb-8 max-w-3xl mx-auto">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i class="bi bi-star-fill text-yellow-400"></i> お気に入り (最大5件)
                    <span id="fav-status-badge" class="text-xs ml-2 px-2 py-1 rounded bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300"></span>
                </h3>
                <div id="favorites-list" class="space-y-4"></div>
                <hr class="my-6 border-gray-300 dark:border-gray-600">
            </div>
    
            <div class="themed-card backdrop-blur-sm p-6 rounded-xl shadow-sm border mb-8 max-w-xl mx-auto">
                <h3 class="font-bold text-lg mb-4 text-center">あなたの順位をチェック</h3>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <select id="user-sign" class="p-2 border rounded-md themed-input">
                        <option value="aries">牡羊座 (3/21-4/19)</option>
                        <option value="taurus">牡牛座 (4/20-5/20)</option>
                        <option value="gemini">双子座 (5/21-6/21)</option>
                        <option value="cancer">蟹座 (6/22-7/22)</option>
                        <option value="leo">獅子座 (7/23-8/22)</option>
                        <option value="virgo">乙女座 (8/23-9/22)</option>
                        <option value="libra">天秤座 (9/23-10/23)</option>
                        <option value="scorpio">蠍座 (10/24-11/22)</option>
                        <option value="sagittarius">射手座 (11/23-12/21)</option>
                        <option value="capricorn">山羊座 (12/22-1/19)</option>
                        <option value="aquarius">水瓶座 (1/20-2/18)</option>
                        <option value="pisces">魚座 (2/19-3/20)</option>
                    </select>
                    <select id="user-blood" class="p-2 border rounded-md themed-input">
                        <option value="A">A型</option>
                        <option value="B">B型</option>
                        <option value="O">O型</option>
                        <option value="AB">AB型</option>
                    </select>
                    <button onclick="findMyRank()" class="btn-primary text-sm py-2 px-6">
                        <i class="bi bi-search"></i> 判定
                    </button>
                </div>
                <div id="my-rank-result" class="mt-6 hidden pt-4 border-t border-gray-300 dark:border-gray-600"></div>
            </div>
    
            <div id="ranking-list" class="space-y-4 max-w-3xl mx-auto"></div>
            
            <div class="text-center mt-6 mb-10">
                <button onclick="showFullRanking()" class="text-sm underline hover:opacity-80 flex items-center justify-center gap-1 mx-auto themed-text-sub">
                    <i class="bi bi-list-ol"></i> <span id="show-ranking-text">4位以下を見る</span>
                </button>
            </div>
            <div id="full-ranking-list" class="space-y-4 mt-4 hidden max-w-3xl mx-auto"></div>
        </section>

        <!-- ビュー: TENMEI Labs (新デザイン) -->
        <section id="view-lab" class="view-section max-w-3xl mx-auto relative">
            <div class="text-center mb-10 mt-4">
                <!-- タイトル上のアニメーションフラスコ (カスタムSVG) -->
                <div class="title-flask-anim">
                    <svg viewBox="0 0 24 24" overflow="visible" style="width:100%; height:100%;">
                        <defs>
                            <linearGradient id="flaskLiquidGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#818cf8;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#6366f1;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <g class="flask-group">
                            <!-- 液体 (よりリアルな波) -->
                            <path class="flask-liquid-path" d="M5 14 C7 13, 9 15, 12 14 C15 13, 17 15, 19 14 L18.5 20 C18.5 21, 18 22, 16 22 L8 22 C6 22, 5.5 21, 5.5 20 Z" />
                            <!-- 泡 -->
                            <circle class="flask-bubble" cx="10" cy="18" r="1" style="animation-delay:0s" />
                            <circle class="flask-bubble" cx="14" cy="19" r="0.8" style="animation-delay:1s" />
                            <circle class="flask-bubble" cx="12" cy="16" r="0.6" style="animation-delay:0.5s" />
                            <!-- フラスコ本体 (底丸め) -->
                            <path class="flask-body-path" d="M9 2 L15 2 L15 7 L20 18 C20.5 19.5, 19 22, 16 22 L8 22 C5 22, 3.5 19.5, 4 18 L9 7 Z" />
                        </g>
                    </svg>
                </div>
                <h2 class="text-4xl font-bold mb-2 tracking-wide" style="color: #6366f1;">
                    TENMEI Labs
                </h2>
                <p class="text-gray-600 dark:text-gray-300 font-bold">新機能を試してみる</p>
                <p class="text-sm text-gray-500 mt-2">実験中の機能に早期アクセスし、開発にご協力ください。</p>
            </div>

            <!-- ラッパー: ぼかし適用対象 -->
            <div id="lab-content-wrapper">
                <div id="lab-container">
                    <!-- 1. 迎春・雅モード -->
                    <div class="lab-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-lg text-yellow-600 dark:text-yellow-400">迎春・雅（みやび）モード</h3>
                                <p class="text-sm themed-text-sub">サイト全体の雰囲気を紅白と金色のお正月仕様に変更します。</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" onchange="TenmeiLab.toggleNewYear(this)" id="switch-newyear">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- 2. 神速の祈り -->
                    <div class="lab-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-lg text-blue-600 dark:text-blue-400">神速（しんそく）の祈り</h3>
                                <p class="text-sm themed-text-sub">おみくじのアニメーションをスキップし、結果を即座に表示します。</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" onchange="TenmeiLab.toggleSpeed(this)" id="switch-speed">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- 3. 宵闇の刻 -->
                    <div class="lab-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-lg text-purple-600 dark:text-purple-400">宵闇（よいやみ）の刻</h3>
                                <p class="text-sm themed-text-sub">OSの設定に関わらず、常にダークモードを強制適用します。</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" onchange="TenmeiLab.toggleDark(this)" id="switch-dark">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- 4. 言霊の増幅 -->
                    <div class="lab-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-lg text-green-600 dark:text-green-400">言霊（ことだま）の増幅</h3>
                                <p class="text-sm themed-text-sub">結果画面の文字サイズを大きくし、視認性を向上させます。</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" onchange="TenmeiLab.toggleBigText(this)" id="switch-bigtext">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 非ログイン時のロックオーバーレイ (ぼかしの上に表示) -->
            <div id="lab-lock" class="lab-lock-overlay hidden">
                <i class="bi bi-lock-fill text-5xl text-gray-400 mb-4 block"></i>
                <h3 class="text-xl font-bold mb-2">会員限定機能</h3>
                <p class="text-sm text-gray-500 mb-6">TENMEI Labsは会員様のみご利用いただけます。<br>ログインして実験的機能をお楽しみください。</p>
                <button onclick="showView('auth')" class="btn-primary w-full shadow-lg">ログイン / 登録</button>
            </div>
        </section>

        <!-- ビュー: ログイン/登録 (新フロー: 選択 -> 入力 -> 認証) -->
        <section id="view-auth" class="view-section max-w-md mx-auto themed-card p-8 rounded-xl shadow-lg mt-10">
            <h2 class="text-2xl font-bold mb-8 text-center">アカウント認証</h2>
            
            <!-- 初期選択画面 -->
            <div id="auth-selection">
                <div class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 text-sm text-red-700 dark:text-red-300 border border-red-200 dark:border-red-800 rounded">
                    <h4 class="font-bold mb-2"><i class="bi bi-unlock-fill mr-1"></i> 会員特典</h4>
                    <ul class="list-disc list-inside space-y-1 text-xs">
                        <li>おみくじの轍（履歴）の完全閲覧＆保存</li>
                        <li>TENMEI Labs（実験機能）の利用権</li>
                        <li>累計発行本数カウンターへの貢献</li>
                    </ul>
                </div>

                <button class="auth-selection-btn" onclick="startAuthFlow('login')">
                    <i class="bi bi-box-arrow-in-right text-blue-500"></i> ログイン
                </button>
                <button class="auth-selection-btn" onclick="startAuthFlow('register')">
                    <i class="bi bi-person-plus text-green-500"></i> 新規登録
                </button>
            </div>

            <!-- ステップ1: メール/パスワード入力 -->
            <div id="auth-step-1" class="hidden">
                <div class="flex items-center mb-6">
                    <button onclick="backToAuthSelection()" class="text-gray-500 hover:text-gray-800 mr-4">
                        <i class="bi bi-arrow-left text-xl"></i>
                    </button>
                    <h3 class="font-bold text-lg" id="auth-form-title">ログイン</h3>
                </div>

                <div id="form-login-fields" class="hidden">
                    <label class="block mb-2 font-bold text-sm">メールアドレス</label>
                    <input type="email" id="login-email" placeholder="example@email.com" class="w-full p-3 border rounded mb-4 themed-input">
                    <label class="block mb-2 font-bold text-sm">パスワード</label>
                    <input type="password" id="login-password" placeholder="********" class="w-full p-3 border rounded mb-4 themed-input">
                    <button onclick="initiateAuth('login')" class="btn-primary w-full justify-center">
                        <i class="bi bi-send"></i> 認証コードを送信
                    </button>
                </div>

                <div id="form-register-fields" class="hidden">
                    <label class="block mb-2 font-bold text-sm">ユーザー名</label>
                    <input type="text" id="reg-username" placeholder="天命 太郎" class="w-full p-3 border rounded mb-4 themed-input">
                    <label class="block mb-2 font-bold text-sm">メールアドレス</label>
                    <input type="email" id="reg-email" placeholder="example@email.com" class="w-full p-3 border rounded mb-4 themed-input">
                    <label class="block mb-2 font-bold text-sm">パスワード</label>
                    <input type="password" id="reg-password" placeholder="********" class="w-full p-3 border rounded mb-4 themed-input">
                    <button onclick="initiateAuth('register')" class="btn-primary w-full justify-center">
                        <i class="bi bi-send"></i> 認証コードを送信
                    </button>
                </div>
            </div>

            <!-- ステップ2: 認証コード入力 (和風デザイン) -->
            <div id="auth-step-2" class="hidden text-center">
                <div class="mb-4">
                    <i class="bi bi-envelope-check text-4xl text-red-500"></i>
                </div>
                <p class="mb-2 font-bold">認証コードを入力してください</p>
                <p class="text-xs text-gray-500 mb-6">メールアドレスに送信された6桁の数字を入力し、認証を完了させてください。</p>
                
                <div class="auth-code-input-container">
                    <div class="auth-code-deco">天命認証符</div>
                    <input type="text" id="auth-code-input" maxlength="6" class="auth-code-input" placeholder="123456" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                </div>

                <button onclick="finalizeAuth()" class="btn-primary w-full justify-center mb-3">
                    <i class="bi bi-check-circle-fill"></i> 認証完了
                </button>
                <button onclick="backToAuthStep1()" class="text-sm underline text-gray-500">
                    戻る
                </button>
            </div>
        </section>

        <!-- ビュー: プロフィール -->
        <section id="view-profile" class="view-section max-w-md mx-auto themed-card p-8 rounded-xl shadow-lg mt-10">
            <h2 class="text-2xl font-bold mb-6 text-center">会員情報</h2>
            
            <div class="mb-6 border-b pb-4">
                <p class="text-sm themed-text-sub">現在のユーザー名</p>
                <p class="text-xl font-bold" id="profile-current-username">---</p>
                <p class="text-sm themed-text-sub mt-2">メールアドレス</p>
                <p class="text-lg" id="profile-current-email">---</p>
            </div>

            <div class="space-y-4">
                <h3 class="font-bold border-l-4 border-red-500 pl-2">情報変更</h3>
                <div>
                    <label class="block text-sm">新しいユーザー名 (変更する場合のみ)</label>
                    <input type="text" id="profile-new-username" class="w-full p-2 border rounded themed-input">
                </div>
                <div>
                    <label class="block text-sm">新しいパスワード (変更する場合のみ)</label>
                    <input type="password" id="profile-new-password" class="w-full p-2 border rounded themed-input">
                </div>
                <button onclick="updateProfile()" class="btn-primary w-full justify-center py-2 text-sm">変更を保存</button>
            </div>

            <div class="mt-10 border-t pt-6">
                <h3 class="font-bold text-red-600 mb-2">アカウント操作</h3>
                <button onclick="logout()" class="w-full bg-gray-500 text-white py-2 rounded hover:opacity-80 mb-4">ログアウト</button>
                <button onclick="deleteAccount()" class="w-full bg-red-600 text-white py-2 rounded hover:opacity-80 text-sm">アカウント削除</button>
                <p class="text-xs text-gray-500 mt-2">※アカウントを削除しても、同じメールアドレスで再登録可能です。</p>
            </div>
        </section>

        <!-- ビュー: おみくじの轍 (履歴) -->
        <section id="view-history" class="view-section max-w-4xl mx-auto relative">
            <h2 class="text-3xl font-bold mb-6 text-center text-red-800 dark:text-red-400">おみくじの轍</h2>
            
            <div class="text-center mb-6">
                <p class="text-sm themed-text-sub">ログインすると、ご自身の履歴と皆様の参拝記録が保存されます。</p>
            </div>

            <div id="history-container" class="">
                <div class="grid grid-cols-2 gap-4 mb-4 text-center">
                    <div class="themed-card p-3 rounded">
                        <p class="text-xs themed-text-sub">あなたの参拝数 (全期間)</p>
                        <p class="text-xl font-bold" id="personal-history-count">-</p>
                    </div>
                    <div class="themed-card p-3 rounded">
                        <p class="text-xs themed-text-sub">みんなの参拝数 (全期間)</p>
                        <p class="text-xl font-bold" id="global-history-count">-</p>
                    </div>
                </div>

                <!-- 検索フォーム -->
                <div class="search-form-container">
                    <h3 class="text-sm font-bold mb-2"><i class="bi bi-search"></i> 轍を検索</h3>
                    <div class="search-input-group">
                        <select id="search-type" class="search-input">
                            <option value="all">全ての運勢</option>
                            <option value="大吉">大吉</option>
                            <option value="中吉">中吉</option>
                            <option value="小吉">小吉</option>
                            <option value="吉">吉</option>
                            <option value="半吉">半吉</option>
                            <option value="末吉">末吉</option>
                            <option value="末小吉">末小吉</option>
                            <option value="凶">凶</option>
                            <option value="小凶">小凶</option>
                            <option value="半凶">半凶</option>
                            <option value="末凶">末凶</option>
                            <option value="大凶">大凶</option>
                        </select>
                        <input type="text" id="search-keyword" placeholder="ユーザー名" class="search-input">
                        <input type="date" id="search-date-start" class="search-input">
                        <span class="self-center">〜</span>
                        <input type="date" id="search-date-end" class="search-input">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="filterHistory()" class="btn-primary text-xs py-1 px-4">検索</button>
                        <button onclick="resetSearch()" class="btn-outline text-xs py-1 px-4">リセット</button>
                    </div>
                    <div class="text-right text-xs mt-2 themed-text-sub">
                        検索結果: <span id="search-result-count" class="font-bold">0</span> 件
                    </div>
                </div>

                <div class="themed-card p-6 rounded shadow mb-6">
                    <div class="flex justify-between items-center border-b border-gray-300 dark:border-gray-600 pb-2 mb-4">
                        <h3 class="font-bold">参拝の足跡一覧</h3>
                        <div class="text-xs text-gray-500" id="history-view-mode"></div>
                    </div>
                    <div id="history-list" class="space-y-3">
                        <!-- JSで挿入 -->
                    </div>
                </div>
            </div>

            <div id="history-login-overlay" class="history-overlay hidden">
                <i class="bi bi-lock-fill text-4xl text-gray-400 mb-4 block"></i>
                <p class="text-lg font-bold mb-2">轍を見るには会員証が必要です</p>
                <p class="text-sm themed-text-sub mb-4">ログインすると、過去の結果を詳細まで振り返ることができます。</p>
                <button onclick="showView('auth')" class="btn-primary">ログイン / 登録</button>
            </div>
        </section>

        <!-- ビュー: 社務所だより -->
        <section id="view-news" class="view-section max-w-3xl mx-auto">
            <h2 class="text-2xl font-bold mb-6">社務所だより</h2>
            <div class="space-y-4">
                <article class="themed-card p-4 rounded shadow border-l-4 border-blue-500 cursor-pointer hover:opacity-80 transition" onclick="openArticle('news', 2)">
                    <div class="text-sm themed-text-sub">2026年1月2日 16:00</div>
                    <h3 class="font-bold text-lg">「運勢・天命乃杜」を公開いたしました。</h3>
                    <p class="text-sm mt-2 truncate themed-text-sub">本サービスを正式にリリースいたしました。</p>
                </article>
                <article class="themed-card p-4 rounded shadow border-l-4 border-gray-500 cursor-pointer hover:opacity-80 transition" onclick="openArticle('news', 1)">
                    <div class="text-sm themed-text-sub">2026年1月1日 0:00</div>
                    <h3 class="font-bold text-lg">あけましておめでとうごさいます</h3>
                    <p class="text-sm mt-2 truncate themed-text-sub">謹んで新年のご祝詞を申し上げます。</p>
                </article>
                <article class="themed-card p-4 rounded shadow border-l-4 border-gray-400 cursor-pointer hover:opacity-80 transition" onclick="openArticle('news', 3)">
                    <div class="text-sm themed-text-sub">2025年12月25日 10:00</div>
                    <h3 class="font-bold text-lg">プレオープンのお知らせ</h3>
                    <p class="text-sm mt-2 truncate themed-text-sub">一部機能を先行公開いたしました。</p>
                </article>
                <article class="themed-card p-4 rounded shadow border-l-4 border-green-500 cursor-pointer hover:opacity-80 transition" onclick="openArticle('news', 4)">
                    <div class="text-sm themed-text-sub">2025年12月20日 18:00</div>
                    <h3 class="font-bold text-lg">サーバーメンテナンス完了</h3>
                    <p class="text-sm mt-2 truncate themed-text-sub">予定されていたメンテナンスは無事終了しました。</p>
                </article>
                <article class="themed-card p-4 rounded shadow border-l-4 border-gray-400 cursor-pointer hover:opacity-80 transition" onclick="openArticle('news', 5)">
                    <div class="text-sm themed-text-sub">2025年12月10日 12:00</div>
                    <h3 class="font-bold text-lg">サイト開設準備室より</h3>
                    <p class="text-sm mt-2 truncate themed-text-sub">現在、正式公開に向けて最終調整を行っております。</p>
                </article>
            </div>
        </section>

        <!-- ビュー: 神籤草子 -->
        <section id="view-column" class="view-section max-w-3xl mx-auto">
            <h2 class="text-2xl font-bold mb-6">神籤草子</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <article class="themed-card rounded overflow-hidden shadow cursor-pointer hover:shadow-lg transition" onclick="openArticle('column', 1)">
                    <div class="h-32 bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-800 dark:text-green-200 font-bold">
                        <i class="bi bi-list-ol text-3xl"></i>
                    </div>
                    <div class="p-4">
                        <div class="text-xs themed-text-sub mb-1">
                            <span class="bg-gray-200 dark:bg-zinc-700 px-2 py-0.5 rounded text-[10px] mr-2">雑学</span>2026/01/01
                        </div>
                        <h3 class="font-bold">おみくじの順番（正しい吉凶の順）</h3>
                    </div>
                </article>
                <article class="themed-card rounded overflow-hidden shadow cursor-pointer hover:shadow-lg transition" onclick="openArticle('column', 2)">
                    <div class="h-32 bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-800 dark:text-green-200 font-bold">
                        <i class="bi bi-cloud-sun text-3xl"></i>
                    </div>
                    <div class="p-4">
                        <div class="text-xs themed-text-sub mb-1">
                             <span class="bg-gray-200 dark:bg-zinc-700 px-2 py-0.5 rounded text-[10px] mr-2">豆知識</span>2026/01/01
                        </div>
                        <h3 class="font-bold">悪い結果が出ても実は大丈夫？</h3>
                    </div>
                </article>
                <article class="themed-card rounded overflow-hidden shadow cursor-pointer hover:shadow-lg transition" onclick="openArticle('column', 3)">
                    <div class="h-32 bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-800 dark:text-green-200 font-bold">
                        <i class="bi bi-person-praying text-3xl"></i>
                    </div>
                    <div class="p-4">
                        <div class="text-xs themed-text-sub mb-1">
                             <span class="bg-gray-200 dark:bg-zinc-700 px-2 py-0.5 rounded text-[10px] mr-2">作法</span>2025/12/30
                        </div>
                        <h3 class="font-bold">神社での正しい参拝マナー</h3>
                    </div>
                </article>
                <article class="themed-card rounded overflow-hidden shadow cursor-pointer hover:shadow-lg transition" onclick="openArticle('column', 4)">
                    <div class="h-32 bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-800 dark:text-green-200 font-bold">
                        <i class="bi bi-search text-3xl"></i>
                    </div>
                    <div class="p-4">
                        <div class="text-xs themed-text-sub mb-1">
                             <span class="bg-gray-200 dark:bg-zinc-700 px-2 py-0.5 rounded text-[10px] mr-2">豆知識</span>2025/12/28
                        </div>
                        <h3 class="font-bold">「失せ物」の本当の意味</h3>
                    </div>
                </article>
                <article class="themed-card rounded overflow-hidden shadow cursor-pointer hover:shadow-lg transition" onclick="openArticle('column', 5)">
                    <div class="h-32 bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-800 dark:text-green-200 font-bold">
                        <i class="bi bi-heart text-3xl"></i>
                    </div>
                    <div class="p-4">
                        <div class="text-xs themed-text-sub mb-1">
                             <span class="bg-gray-200 dark:bg-zinc-700 px-2 py-0.5 rounded text-[10px] mr-2">開運</span>2025/12/25
                        </div>
                        <h3 class="font-bold">「待ち人」は恋愛だけじゃない</h3>
                    </div>
                </article>
            </div>
        </section>

        <!-- ビュー: 記事詳細 -->
        <section id="view-article-detail" class="view-section">
            <div class="max-w-3xl mx-auto mb-4">
                <button onclick="articleBack()" class="text-sm themed-text-sub hover:text-red-500">
                    <i class="bi bi-arrow-left"></i> 戻る
                </button>
            </div>
            <div id="article-detail-content" class="article-container themed-card">
                <!-- JSでコンテンツ挿入 -->
            </div>
        </section>

        <!-- ビュー: 当サイトについて・詳細 (超長文版) -->
        <section id="view-about" class="view-section max-w-4xl mx-auto themed-card p-10 rounded shadow-lg text-justify leading-loose">
            <h2 class="text-3xl font-bold mb-8 text-center border-b border-gray-300 dark:border-gray-600 pb-4">当サイトについて・利用規約・詳細解説</h2>
            <div class="text-right text-sm themed-text-sub mb-8">
                最終改定日: 2026年1月3日<br>
                運営: nden148
            </div>

            <!-- 他サイトとの比較表 (新設) -->
            <h3 class="text-xl font-bold mt-8 mb-4 border-l-4 border-red-500 pl-3">他サービスとの機能比較</h3>
            <p class="mb-4">
                「運勢・天命乃杜」は、既存の占いサイトやアプリの課題を解決し、より深く、より静謐な占い体験を提供するために設計されました。以下に、一般的なサービスとの主な違いを示します。ただし、これは他のサイトが劣っていることを示すものではありません。どのようなサービスにもそれぞれの良さ（長所）と至らぬ点（短所）があり、当サイトもまた同様です。最も大切なのは、利用者の皆様がご自身の目的や価値観に最も合致するサイトを自由に選択することだと考えています。
            </p>
            <div class="overflow-x-auto mb-8">
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>機能・特徴</th>
                            <th class="bg-red-50 dark:bg-red-900/30 text-red-800 dark:text-red-200">天命乃杜</th>
                            <th>一般的な無料占い</th>
                            <th>神社公式サイト</th>
                            <th>有料占いアプリ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>利用料金</td>
                            <td class="highlight">完全無料</td>
                            <td>無料 (広告多)</td>
                            <td>無料 (情報のみ)</td>
                            <td>月額/都度課金</td>
                        </tr>
                        <tr>
                            <td>広告表示</td>
                            <td class="highlight">なし (静寂重視)</td>
                            <td>大量に表示</td>
                            <td>なし</td>
                            <td>一部あり/なし</td>
                        </tr>
                        <tr>
                            <td>履歴の保存</td>
                            <td class="highlight">可能 (会員機能)</td>
                            <td>不可</td>
                            <td>不可</td>
                            <td>可能 (有料版等)</td>
                        </tr>
                        <tr>
                            <td>占いの種類</td>
                            <td class="highlight">おみくじ + 48種詳細順位</td>
                            <td>12星座のみ等</td>
                            <td>おみくじのみ</td>
                            <td>多様</td>
                        </tr>
                        <tr>
                            <td>デザイン・没入感</td>
                            <td class="highlight">和モダン・動的演出</td>
                            <td>テンプレート的</td>
                            <td>静的テキスト</td>
                            <td>高品質</td>
                        </tr>
                        <tr>
                            <td>特殊機能</td>
                            <td class="highlight">Labs (ダークモード等)</td>
                            <td>なし</td>
                            <td>なし</td>
                            <td>通知機能等</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3 class="text-xl font-bold mt-8 mb-4 border-l-4 border-red-500 pl-3">第1章 はじめに：当サイトの理念と目的</h3>
            <p class="mb-4">
                ようこそ、「運勢・天命乃杜（てんめいのもり）」（以下、「当サイト」といいます）へお越しくださいました。当サイトは、古来より日本に伝わる神道の伝統的な「おみくじ」の精神性と、西洋占星術および血液型性格診断という統計学的な要素を融合させ、現代を生きる人々の迷いや不安を少しでも和らげ、日々の生活における指針や活力の源となることを目的として開設された、デジタルプラットフォーム上の仮想社殿です。
            </p>
            <p class="mb-4">
                我々は、インターネットという広大な情報の海において、心の平穏と自己省察の機会を提供する「鎮守の杜」のような存在でありたいと願っています。忙しない日常の中で、ふと立ち止まり、天命に耳を傾ける時間を持つこと。それが、より豊かな人生への第一歩であると信じているからです。利用者の皆様には、以下の詳細な規約と解説を熟読し、十分に理解・同意された上で、当サイトの各機能をご利用いただけますようお願い申し上げます。
            </p>
            <p class="mb-4">
                本サービスを利用することによって、利用者は本規約に全面的に同意したものとみなされます。もし本規約に同意されない場合は、直ちに本サービスの利用を中止してください。当サイトは、利用者に事前の通知なく、本規約を変更する権利を留保します。変更後の規約は、当サイト上に掲示された時点から効力を生じるものとし、利用者が変更後に本サービスを利用し続けた場合、変更後の規約に同意したものとみなされます。
            </p>

            <h3 class="text-xl font-bold mt-8 mb-4 border-l-4 border-red-500 pl-3">第2章 おみくじ機能の仕様とアルゴリズムの透明性</h3>
            <p class="mb-4">
                当サイトで提供する「おみくじ」機能は、完全なランダム性を保証するために高度な乱数生成アルゴリズム（暗号論的擬似乱数生成器に準ずるロジック）を使用しています。おみくじを引く際のアニメーション演出では、画面上に散らばる多数の神籤札の中から、利用者が直感に基づいて一枚を選択するプロセスを採用しています。ユーザーが札をクリックした瞬間、サーバーサイド（またはクライアントサイドのセキュアなロジック）において即座に抽選が行われ、結果が確定します。これにより、作為的な操作が介入する余地を排除し、純粋な運勢診断を提供しています。
            </p>
            <p class="mb-4">
                おみくじの結果には、「大吉」「吉」「中吉」「小吉」「末吉」「凶」「大凶」などの等級が含まれます。当サイトでは特に「大吉」の場合には金色を基調とした特別なテクスチャデザインを、「大凶」の場合には黒色を基調とした厳粛なデザインを表示する仕様となっております。これは単なる視覚効果にとどまらず、利用者の心理状態に働きかけ、大吉であれば高揚感を、大凶であれば身を引き締める緊張感を与えることを意図しています。さらに、当サイト独自の12段階評価（大吉から大凶まで）を採用しており、一般的なおみくじよりも詳細な運勢判断が可能となっております。
            </p>
            <p class="mb-4">
                なお、当サイトの占いは科学的根拠に基づくものではなく、あくまでエンターテインメントおよび精神的な示唆を提供するものです。結果がいかなるものであれ、それによって生じた現実の損害や利益について、当サイトは一切の責任を負いません。占いの結果をどのように受け止め、どのように行動するかは、すべて利用者ご自身の判断に委ねられています。神託とは、それを受け取る者の心の在り方によって、その意味を大きく変えるものなのです。
            </p>

            <h3 class="text-xl font-bold mt-8 mb-4 border-l-4 border-red-500 pl-3">第3章 アカウント認証・セキュリティ・会員特典</h3>
            <p class="mb-4">
                当サイトでは、ユーザーの利便性とセキュリティを両立させるため、メールアドレス、パスワード、およびユーザー名を用いた認証システムを導入しています。新規登録時には、真正性を確認するための認証コード（OTP）がメールアドレス宛に送信されます。これにより、なりすまし登録や不正アクセスを未然に防ぐ体制を整えています。
            </p>
            <p class="mb-4">
                会員登録を行い、ログインした状態で本サービスを利用することで、以下の特別な機能（会員特典）を享受することができます。
                <br>1. **おみくじの轍（履歴）の完全閲覧権:** ご自身の過去の履歴に加え、他の参拝者様が引いたおみくじの結果（匿名化されたデータ）を「おみくじの轍」として閲覧することが可能になります。これにより、世の中の運気の流れを感じ取ることができます。
                <br>2. **詳細結果の再確認:** 履歴リストから過去の結果をクリックすることで、おみくじを引いた直後の詳細な結果画面（和歌や各項目の助言）をいつでも再表示・アニメーション再生することができます。
                <br>3. **累計発行本数への貢献:** ログインユーザーがおみくじを引いた場合のみ、サイトトップに表示される「累計発行本数」のカウンターがインクリメント（加算）されます。これは、会員様の祈りが「杜」の歴史の一部として刻まれることを意味します。
                <br>4. **クラウド同期:** お気に入り設定や履歴データがサーバー上に保存されるため、スマートフォンやPCなど、異なるデバイスからアクセスしても常に同じ環境でご利用いただけます。
            </p>
            <p class="mb-4">
                非ログイン状態（ゲストユーザー）の場合、これらの機能は制限されます。履歴は表示されず（ぼかし表示）、カウンターの数値にも影響を与えません。また、データはブラウザの「localStorage」に一時保存されるのみであり、キャッシュクリア等により消失する可能性があります。恒久的なデータの保存を希望される場合は、会員登録を強く推奨いたします。
            </p>

            <h3 class="text-xl font-bold mt-8 mb-4 border-l-4 border-red-500 pl-3">第4章 コンテンツの著作権とシェア機能</h3>
            <p class="mb-4">
                当サイトに掲載されている全てのコンテンツ（文章、画像、プログラムコード、デザイン、ロゴマーク、アルゴリズム等）の著作権は、運営者または正当な権利を有する第三者に帰属します。これらは、日本の著作権法、国際条約、およびその他の知的財産権に関する法律によって保護されています。私的な利用の範囲を超えて、これらを無断で複製、転載、改変、再配布、公衆送信することは法律で固く禁じられており、違反した場合は民事上の損害賠償請求や刑事罰の対象となる可能性があります。
            </p>
            <p class="mb-4">
                ただし、当サイトが提供する「シェア機能」を通じて生成されたおみくじ結果画像に関しては、利用者が個人のソーシャルメディア（SNS）等で共有する目的に限り、自由にご利用いただけます。この画像には当サイトのURLやQRコードが含まれており、これらを削除・隠蔽せずにそのままの状態で共有していただくことが利用の条件となります。公序良俗に反する投稿や、当サイトの名誉を毀損するような文脈での利用は禁止します。
            </p>

            <h3 class="text-xl font-bold mt-8 mb-4 border-l-4 border-red-500 pl-3">第5章 免責事項</h3>
            <p class="mb-4">
                当サイトは、本サービスの提供において万全を期しておりますが、その完全性、正確性、確実性、有用性等についてはいかなる保証も行いません。システム障害、通信回線の不具合、サーバーのダウン、第三者による不正アクセス、天災地変等により本サービスの提供が中断・遅延・停止した結果、利用者に生じたいかなる損害についても、当サイトは一切の責任を負わないものとします。また、当サイトからリンクされている外部サイトの内容やサービスについても、当サイトは関知せず、一切の責任を負いません。利用者は、自己の責任において本サービスを利用するものとします。
            </p>
        </section>

        <!-- ビュー: プライバシーポリシー (超長文版) -->
        <section id="view-privacy" class="view-section max-w-4xl mx-auto themed-card p-10 rounded shadow-lg text-justify leading-loose">
            <h2 class="text-3xl font-bold mb-6 text-center">プライバシーポリシー</h2>
            <p class="mb-4">
                nden148（以下「当運営」といいます。）は、本ウェブサイト上で提供するサービス（以下、「本サービス」といいます。）における、ユーザーの個人情報の取扱いについて、以下のとおりプライバシーポリシー（以下、「本ポリシー」といいます。）を定めます。本ポリシーは、ユーザーが本サービスを利用する際に適用され、当運営は個人情報の重要性を深く認識し、その保護の徹底を図るため、個人情報の保護に関する法律（平成15年法律第57号。以下「個人情報保護法」といいます。）等の関係法令を遵守するとともに、以下のプライバシーポリシーに従って厳重に管理いたします。
            </p>

            <h4 class="font-bold mt-4 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第1条（個人情報の定義）</h4>
            <p class="mb-4">
                本ポリシーにおいて、「個人情報」とは、個人情報保護法第2条第1項に規定される「個人情報」を指すものとします。具体的には、生存する個人に関する情報であって、当該情報に含まれる氏名、生年月日、住所、電話番号、連絡先、その他の記述等により特定の個人を識別できる情報（個人識別情報）、および容貌、指紋、声紋にかかるデータ、健康保険証の保険者番号などの当該情報単体から特定の個人を識別できる情報（個人識別符号）を指します。本サービスにおいては、ユーザー登録時に入力いただくメールアドレス、ユーザー名、パスワード（暗号化されたハッシュ値）などがこれに該当します。
            </p>

            <h4 class="font-bold mt-4 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第2条（個人情報の収集方法）</h4>
            <p class="mb-4">
                当運営は、ユーザーが利用登録をする際に、氏名（ユーザー名）、メールアドレス、パスワード等の個人情報をお尋ねすることがあります。また、ユーザーと提携先などとの間でなされたユーザーの個人情報を含む取引記録や決済に関する情報を、当運営の提携先（情報提供元、広告主、広告配信先などを含みます。以下、｢提携先｣といいます。）などから収集することがあります。
                <br>さらに、ユーザーが本サービスを利用するにあたり、端末情報、ログ情報、Cookie（クッキー）、IPアドレス、位置情報などのインフォマティブデータを自動的に取得する場合があります。これらは、サービスの品質向上、不正利用の防止、およびユーザーごとに最適化されたコンテンツを提供するために利用されます。
            </p>

            <h4 class="font-bold mt-4 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第3条（個人情報を収集・利用する目的）</h4>
            <p class="mb-4">当運営が個人情報を収集・利用する目的は、以下のとおりです。</p>
            <ul class="list-disc pl-5 mb-4 space-y-2">
                <li>本サービスの提供・運営のため（認証コードの送信、ログイン状態の維持、ユーザー設定の保存など）</li>
                <li>ユーザーからのお問い合わせに回答するため（本人確認を行うことを含む）</li>
                <li>ユーザーが利用中のサービスの新機能、更新情報、キャンペーン等及び当運営が提供する他のサービスの案内のメールを送付するため</li>
                <li>メンテナンス、重要なお知らせなど必要に応じたご連絡のため</li>
                <li>利用規約に違反したユーザーや、不正・不当な目的でサービスを利用しようとするユーザーの特定をし、ご利用をお断りするため</li>
                <li>ユーザーにご自身の登録情報の閲覧や変更、削除、ご利用状況の閲覧を行っていただくため</li>
                <li>有料サービスにおいて、ユーザーに利用料金を請求するため（将来的な実装を含む）</li>
                <li>上記の利用目的に付随する目的</li>
            </ul>

            <h4 class="font-bold mt-4 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第4条（利用目的の変更）</h4>
            <p class="mb-4">
                当運営は、利用目的が変更前と関連性を有すると合理的に認められる場合に限り、個人情報の利用目的を変更するものとします。利用目的の変更を行った場合には、変更後の目的について、当運営所定の方法により、ユーザーに通知し、または本ウェブサイト上に公表するものとします。変更後のプライバシーポリシーは、本ウェブサイトに掲載したときから効力を生じるものとします。
            </p>

            <h4 class="font-bold mt-4 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第5条（個人情報の第三者提供）</h4>
            <p class="mb-4">
                当運営は、次に掲げる場合を除いて、あらかじめユーザーの同意を得ることなく、第三者に個人情報を提供することはありません。ただし、個人情報保護法その他の法令で認められる場合を除きます。
                <br>1. 人の生命、身体または財産の保護のために必要がある場合であって、本人の同意を得ることが困難であるとき
                <br>2. 公衆衛生の向上または児童の健全な育成の推進のために特に必要がある場合であって、本人の同意を得ることが困難であるとき
                <br>3. 国の機関もしくは地方公共団体またはその委託を受けた者が法令の定める事務を遂行することに対して協力する必要がある場合であって、本人の同意を得ることにより当該事務の遂行に支障を及ぼすおそれがあるとき
                <br>4. 予め次の事項を告知あるいは公表し、かつ当運営が個人情報保護委員会に届出をしたとき
                <br>   (1) 利用目的に第三者への提供を含むこと
                <br>   (2) 第三者に提供されるデータの項目
                <br>   (3) 第三者への提供の手段または方法
                <br>   (4) 本人の求めに応じて個人情報の第三者への提供を停止すること
                <br>   (5) 本人の求めを受け付ける方法
            </p>

            <h4 class="font-bold mt-4 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第6条（個人情報の開示・訂正・削除）</h4>
            <p class="mb-4">
                当運営は、本人から個人情報の開示を求められたときは、本人に対し、遅滞なくこれを開示します。ただし、開示することにより次のいずれかに該当する場合は、その全部または一部を開示しないこともあり、開示しない決定をした場合には、その旨を遅滞なく通知します。
                <br>1. 本人または第三者の生命、身体、財産その他の権利利益を害するおそれがある場合
                <br>2. 当運営の業務の適正な実施に著しい支障を及ぼすおそれがある場合
                <br>3. その他法令に違反することとなる場合
                <br>ユーザーは、当運営の保有する自己の個人情報が誤った情報である場合には、当運営が定める手続きにより、当運営に対して個人情報の訂正、追加または削除（以下、「訂正等」といいます。）を請求することができます。当運営は、ユーザーから前項の請求を受けてその請求に応じる必要があると判断した場合には、遅滞なく、当該個人情報の訂正等を行うものとします。
            </p>

            <h4 class="font-bold mt-4 text-lg border-b border-gray-300 dark:border-gray-600 pb-1">第7条（お問い合わせ窓口）</h4>
            <p class="mb-4">
                本ポリシーに関するお問い合わせは、当サイトのお問い合わせフォーム、または運営者(nden148)までご連絡ください。当運営は、個人情報の取扱いに関する苦情や相談に対し、適切かつ迅速に対応するよう努めます。
            </p>
        </section>

    </main>

    <!-- カウントダウンオーバーレイ -->
    <div id="countdown-overlay">
        <div id="countdown-number">3</div>
    </div>

    <!-- 詳細モーダル (おみくじの轍用) -->
    <div id="history-detail-modal" onclick="closeHistoryDetail(event)">
        <div id="history-detail-content" onclick="event.stopPropagation()">
            <!-- ここに結果カードを複製表示 -->
        </div>
        <button onclick="closeHistoryDetail(null)" class="fixed top-5 right-5 text-white text-4xl hover:text-gray-300 z-[2100]">
            <i class="bi bi-x-circle"></i>
        </button>
    </div>

    <!-- JavaScript ロジック -->
    <script>
        // ==========================================
        //  設定: Cloudflare WorkerのURL
        // ==========================================
        const API_BASE = "https://aaaaa.nden14800.workers.dev";
        const SITE_URL = "https://fortune-telling-at-tenmei-no-mori-authentic-today-s-fortun.pages.dev";

        // --- 状態管理 ---
        let currentState = {
            view: 'home',
            user: null, // { email, username, token }
            lastResult: null,
            liveCount: 0,
            authMode: 'login' // 'login' or 'register'
        };

        let favoriteList = [];
        let dailyRanking = [];
        let globalHistory = [];
        let personalHistory = [];

        // --- 修正版: Lab機能の状態管理 ---
        const TenmeiLab = {
            toggleNewYear: (el) => {
                if(el.checked) document.body.classList.add('theme-newyear');
                else document.body.classList.remove('theme-newyear');
                saveLabSettings();
            },
            toggleSpeed: (el) => {
                window.labSpeedMode = el.checked;
                saveLabSettings();
            },
            toggleDark: (el) => {
                // スイッチを切り替えたら設定を保存してテーマを再適用
                saveLabSettings();
                applyTheme(); 
            },
            toggleBigText: (el) => {
                if(el.checked) document.body.style.fontSize = '120%';
                else document.body.style.fontSize = '';
                saveLabSettings();
            }
        };

        // --- 追加: テーマ適用ロジック（OS設定とLab設定の統合） ---
        function applyTheme() {
            let userSettings = null;
            if (currentState.user) {
                try {
                    userSettings = JSON.parse(localStorage.getItem(`lab_settings_${currentState.user.email}`));
                } catch(e) {}
            }

            // 「宵闇の刻」がONかどうか
            const forceDark = userSettings ? userSettings.dark : false;
            
            // OSがダークモードかどうか
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            // スイッチON または (スイッチOFFかつOSがダーク) の場合に dark クラスを付与
            if (forceDark || systemDark) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }

            // スイッチの見た目同期（ログイン時のみ）
            const switchDark = document.getElementById('switch-dark');
            if(switchDark && userSettings) {
                switchDark.checked = forceDark;
            }
        }

        // --- 修正版: 設定保存 ---
        function saveLabSettings() {
            if (currentState.user) {
                const settings = {
                    newyear: document.getElementById('switch-newyear').checked,
                    speed: document.getElementById('switch-speed').checked,
                    dark: document.getElementById('switch-dark').checked,
                    bigtext: document.getElementById('switch-bigtext').checked
                };
                localStorage.setItem(`lab_settings_${currentState.user.email}`, JSON.stringify(settings));
            }
        }

        // --- 修正版: 設定読み込み ---
        function loadLabSettings() {
            // まずテーマ以外の設定を復元
            if (currentState.user) {
                const settings = JSON.parse(localStorage.getItem(`lab_settings_${currentState.user.email}`));
                if (settings) {
                    if (settings.newyear) {
                        document.getElementById('switch-newyear').checked = true;
                        TenmeiLab.toggleNewYear(document.getElementById('switch-newyear'));
                    }
                    if (settings.speed) {
                        document.getElementById('switch-speed').checked = true;
                        TenmeiLab.toggleSpeed(document.getElementById('switch-speed'));
                    }
                    if (settings.bigtext) {
                        document.getElementById('switch-bigtext').checked = true;
                        TenmeiLab.toggleBigText(document.getElementById('switch-bigtext'));
                    }
                    // dark設定は applyTheme で処理するためここではスイッチ状態のみ復元
                    if (settings.dark) {
                        document.getElementById('switch-dark').checked = true;
                    }
                }
            } else {
                // 未ログイン時のリセット
                document.getElementById('switch-newyear').checked = false;
                document.body.classList.remove('theme-newyear');
                document.getElementById('switch-speed').checked = false;
                window.labSpeedMode = false;
                document.getElementById('switch-dark').checked = false; // スイッチはOFF
                document.getElementById('switch-bigtext').checked = false;
                document.body.style.fontSize = '';
            }
            
            // 最後にテーマを一括適用（ここでOS設定も反映されます）
            applyTheme();
        }

        // --- window.onload への追加修正 ---
        window.onload = function() {
            initHomeAnimation();
            initZodiacSystem();
            
            const storedUser = localStorage.getItem('omikuji_user');
            if(storedUser) {
                try {
                    currentState.user = JSON.parse(storedUser);
                } catch(e) {
                    console.error("Auth Data Parse Error", e);
                }
            }
            updateAuthUI();
            loadLabSettings(); // ここで applyTheme が呼ばれます

            // OSのダークモード切り替えをリアルタイム検知して反映するリスナーを追加
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                applyTheme();
            });

            startLiveCounter();
            fetchHistoryStats();
            setInterval(fetchHistoryStats, 5000); 
            
            loadFavorites();

            const url = new URL(window.location);
            if (url.searchParams.has('d')) {
                url.searchParams.delete('d');
                window.history.replaceState({}, '', url);
            }
        };

        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if(show) {
                overlay.style.display = 'flex';
                // わずかに遅らせてopacityを変更しフェードインさせる
                requestAnimationFrame(() => overlay.classList.add('visible'));
            } else {
                overlay.classList.remove('visible');
                // フェードアウト後に非表示
                setTimeout(() => {
                    if(!overlay.classList.contains('visible')) overlay.style.display = 'none';
                }, 300);
            }
        }

        function showView(viewId) {
            // Lab機能へのアクセス制限処理
            // ビュー自体は表示するが、非ログイン時はぼかしとロックをかける
            if(viewId === 'lab') {
                const lock = document.getElementById('lab-lock');
                const wrapper = document.getElementById('lab-content-wrapper');
                
                if(!currentState.user) {
                    lock.classList.remove('hidden');
                    wrapper.classList.add('lab-blurred');
                } else {
                    lock.classList.add('hidden');
                    wrapper.classList.remove('lab-blurred');
                }
            }

            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
                setTimeout(() => {
                    if(!el.classList.contains('active')) el.style.display = 'none';
                }, 500);
            });
            
            const target = document.getElementById(`view-${viewId}`);
            target.style.display = 'block';
            void target.offsetWidth; 
            target.classList.add('active');
            currentState.view = viewId;

            if(viewId === 'draw') {
                resetOmikujiPool();
            }
            if(viewId === 'history') {
                loadHistory();
            }
        }

        function articleBack() {
            showView('home'); 
        }

        // --- ホームアニメーション ---
        function initHomeAnimation() {
            const container = document.getElementById('home-anim-container');
            const paperCount = 20;
            for(let i=0; i<paperCount; i++) {
                const paper = document.createElement('div');
                paper.className = 'flying-paper';
                paper.style.left = Math.random() * 260 + 'px';
                paper.style.animationDelay = Math.random() * 4 + 's';
                paper.style.animationDuration = (3 + Math.random() * 3) + 's';
                paper.textContent = "天命乃杜";
                container.appendChild(paper);
            }
        }

        // --- ライブカウンター (API連携) ---
        function startLiveCounter() {
            const el = document.getElementById('live-counter');
            const timeEl = document.getElementById('counter-time');
            
            fetchCount();
            setInterval(fetchCount, 5000);

            async function fetchCount() {
                const now = new Date();
                timeEl.textContent = now.toLocaleTimeString();
                try {
                    const res = await fetch(`${API_BASE}/api/counter`);
                    if(res.ok) {
                        const data = await res.json();
                        // サーバーの値をそのまま表示
                        currentState.liveCount = (data.count || 0);
                        el.textContent = currentState.liveCount.toLocaleString() + "本";
                    }
                } catch(e) { console.error(e); }
            }
        }

        // --- 統計情報の取得 (12種類対応版) ---
        async function fetchHistoryStats() {
            try {
                const res = await fetch(`${API_BASE}/api/stats`);
                if(res.ok) {
                    const data = await res.json();
                    document.getElementById('stats-update-time').textContent = data.timestamp || "--:--:--";

                    const setBar = (id, percent, count) => {
                        // 要素が存在する場合のみ更新
                        const statEl = document.getElementById(`stat-${id}`);
                        if (statEl) {
                            const p = parseFloat(percent).toFixed(2);
                            statEl.textContent = p + "%";
                            document.getElementById(`cnt-${id}`).textContent = (count || 0).toLocaleString() + "本";
                            document.getElementById(`bar-${id}`).style.width = p + "%";
                        }
                    };

                    const stats = data.stats || {};
                    const counts = data.counts || {};
                    
                    // 12種類全てのキーを更新
                    const keys = [
                        'daikichi', 'chukichi', 'shokichi', 'kichi', 'hankichi', 'suekichi', 'sueshokichi',
                        'kyo', 'shokyo', 'hankyo', 'suekyo', 'daikyo'
                    ];
                    
                    keys.forEach(key => {
                        setBar(key, stats[key] || 0, counts[key] || 0);
                    });
                }
            } catch(e) { console.error(e); }
        }

        // --- おみくじロジック ---
        function startOmikuji() {
            showView('draw');
        }

        function resetOmikujiPool() {
            const pool = document.getElementById('omikuji-pool');
            pool.innerHTML = '';
            addOmikujiBatch(100, true); 
        }

        function addOmikuji() {
            addOmikujiBatch(50, false);
            const section = document.getElementById('view-draw');
            section.scrollBy({ top: 400, behavior: 'smooth' });
        }

        function addOmikujiBatch(count, isInitial) {
            const pool = document.getElementById('omikuji-pool');
            let lastBottom = 0;
            if (!isInitial && pool.childElementCount > 0) {
                lastBottom = pool.childElementCount * 25; 
            }

            for(let i=0; i<count; i++) {
                const stick = document.createElement('div');
                stick.className = 'omikuji-stick shadow-md rounded';
                stick.textContent = `天命乃杜`; 
                
                const left = Math.random() * 90 + 5; 
                let top;
                if (isInitial) {
                    top = (i * 20) + (Math.random() * 100); 
                } else {
                    top = lastBottom + (i * 20) + (Math.random() * 100);
                }
                const rot = Math.random() * 360;
                
                stick.style.left = `calc(${left}% - 25px)`;
                stick.style.top = `${top}px`;
                stick.style.transform = `rotate(${rot}deg)`;
                stick.style.animation = `slideInRandom 0.5s ease forwards ${Math.random() * 0.3}s`;
                
                stick.onclick = function() {
                    drawResult(this);
                };
                
                pool.appendChild(stick);
            }
        }

        // 12種類のおみくじ結果定義
        const omikujiResults = [
            { type: "大吉", rank: 5, poem: "枯れ果てし 枝に再び 花咲くが如し", desc: "最高の運気です。長年の努力が報われ、枯れ木に花が咲くような喜びが訪れるでしょう。しかし慢心は禁物。感謝の心を忘れずに。" },
            { type: "中吉", rank: 4, poem: "照る月を 雲が隠せど 風払うなり", desc: "一時的な迷いがあっても、すぐに晴れ間が見えます。自分の信念を貫くことで、雲を払う風のような助けが現れるはずです。" },
            { type: "小吉", rank: 3, poem: "小川の水 淀まず流るる 様を見るべし", desc: "派手さはありませんが、平穏無事な日々が続きます。日々の小さな幸せを大切にし、流れに身を任せるのが吉です。" },
            { type: "吉", rank: 4, poem: "春風に 池の氷も 解け初めて", desc: "厳しい冬が終わり、徐々に運気が上昇しています。焦らず着実に進めば、池の氷が解けるように悩みも消えていくでしょう。" },
            { type: "半吉", rank: 3, poem: "山里の 雪解け水も 川となりて", desc: "今はまだ準備段階。しかし確実に運気は開けつつあります。焦らず力を蓄え、時が来るのを待ちましょう。" },
            { type: "末吉", rank: 3, poem: "山道の 険しき坂も 一歩より", desc: "今は登り坂で苦しい時かもしれませんが、一歩一歩進めば必ず頂上に辿り着けます。忍耐力が試される時です。" },
            { type: "末小吉", rank: 2, poem: "種まけば やがて芽が出る 時を待て", desc: "結果が出るまでには時間がかかります。今は地道な努力を続ける時期。将来の大輪の花を信じて。" },
            { type: "凶", rank: 1, poem: "雨雲の 晴れ間も見えず 濡れ衣かな", desc: "誤解を受けやすく、思うようにいかない時期です。今は弁解せず、静かに嵐が過ぎるのを待つのが賢明な判断です。" },
            { type: "小凶", rank: 2, poem: "石の上にも 三年いれば 暖かき", desc: "辛抱が必要な時。すぐに結果を求めず、じっくりと腰を据えて取り組むことで道が開けます。" },
            { type: "半凶", rank: 2, poem: "嵐吹く 庭の小枝も 折れぬよう", desc: "逆風が吹くかもしれません。しかし、しなやかに対応すれば折れることはありません。柔軟な姿勢が大切です。" },
            { type: "末凶", rank: 1, poem: "夜の闇 深きほどに 暁近し", desc: "今は一番暗い時期かもしれませんが、夜明けは必ず来ます。希望を捨てずに前を向きましょう。" },
            { type: "大凶", rank: 0, poem: "嵐吹く 荒野に一人 立つが如し", desc: "八方塞がりの厳しい運勢。無理に動くと災いを招きます。身を潜め、自分を見つめ直す修行の時と心得てください。" }
        ];

        // 運勢ランク別詳細テキストデータ
        const detailTexts = {
            '願事': ["意のままに叶う", "速やかに叶う", "後に叶う", "叶うが遅し", "叶いにくし", "叶わず"],
            '恋愛': ["相思相愛なり", "良縁に恵まれる", "誠意で通じる", "迷いあり", "諦めが肝心", "縁なし"],
            '待人': ["来る 喜びあり", "来る たよりあり", "遅れるが来る", "来ず 音信あり", "来ず さわりあり", "来ず 決して来ず"],
            '商売': ["買うに吉 利あり", "利益あり", "売り買い吉", "利少なし", "損害の恐れ", "商うな 損する"],
            '旅立': ["いざ行け 大吉", "行先に利あり", "よき連れあり", "盗難に注意", "行くな 災いあり", "道中 危険あり"],
            '学問': ["安心して勉めよ", "試験に通る", "努力せよ", "困難あり", "危うし", "絶望的"],
            '病気': ["全快す", "治る 信じよ", "長引くが治る", "養生せよ", "重し 医者を選べ", "危うし 祈れ"]
        };

        // 重複排除用リスト拡張
        const luckyItemsList = [
            "古時計","香水","手鏡","文庫本","スニーカー","万年筆",
            "水晶","観葉植物","銀の指輪","ハンカチ","革靴","手帳",
            "香辛料","紅茶","コイン","鈴","扇子","万華鏡",
            "砂時計","栞","眼鏡","帽子","手袋","香木",
            "和紙","筆","インク","切手","古銭","鍵",
            "ロケット","ブローチ","スカーフ","リボン","ベルト","財布",
            "パスケース","名刺入れ","ポーチ","水筒","マグカップ","皿",
            "箸","風鈴","お守り","数珠","朱肉","印鑑"
        ];
        const luckySpotsList = [
            "図書館","カフェ","神社","海辺","高台","公園",
            "美術館","映画館","博物館","水族館","動物園","植物園",
            "本屋","雑貨屋","パン屋","花屋","駅","空港",
            "港","橋の上","川沿い","山頂","森","温泉",
            "寺院","教会","塔","城","市場","路地裏",
            "噴水広場","並木道","屋上","地下街","交差点","歩道橋",
            "ベンチ","テラス","窓際","カウンター","個室","ロビー",
            "玄関","庭","ベランダ","書斎","リビング","寝室"
        ];
        const luckyColorsList = [
            "赤","青","白","金","紫","緑",
            "黄","橙","桃","黒","銀","紺",
            "茶","灰","水色","黄緑","深紅","群青",
            "琥珀","翡翠","瑠璃","真紅","漆黒","純白",
            "桜色","藤色","山吹色","若草色","空色","茜色",
            "黄金","白銀","銅","パール","ベージュ","クリーム",
            "ワインレッド","オリーブ","ミント","ラベンダー","サーモン","コーラル",
            "ターコイズ","インディゴ","マゼンタ","シアン","ライム","レモン"
        ];
        const luckyPersonsList = [
            "旧友","年上","年下","家族","先生","初対面",
            "同僚","上司","部下","隣人","店員","旅人",
            "子供","老人","職人","芸術家","医師","看護師",
            "警察官","消防士","運転手","駅員","郵便屋","料理人",
            "美容師","作家","歌手","俳優","選手","学者",
            "社長","秘書","受付","警備員","清掃員","農家",
            "漁師","神主","住職","牧師","シスター","占い師",
            "幼馴染","親戚","恩師","先輩","後輩","ライバル"
        ];

        function getRandomUnique(list, count) {
            const shuffled = [...list].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        function drawResult(element) {
            const overlay = document.getElementById('countdown-overlay');
            const numEl = document.getElementById('countdown-number');
            overlay.style.display = 'flex';
            
            // Lab: 神速の祈りモードならカウントダウン省略
            if(window.labSpeedMode) {
                overlay.style.display = 'none';
                showResultDetail(true);
                return;
            }
            
            let count = 3;
            numEl.textContent = count;
            
            const timer = setInterval(() => {
                count--;
                if(count > 0) {
                    numEl.textContent = count;
                } else {
                    clearInterval(timer);
                    overlay.style.display = 'none';
                    showResultDetail(true); 
                }
            }, 1000);
        }

        async function showResultDetail(isNewDraw, dataOverride = null) {
            let resultData, randNum, detailsList, luckyItems, unluckyItems, timestamp, username;

            if (isNewDraw) {
                // 新規抽選
                const base = omikujiResults[Math.floor(Math.random() * omikujiResults.length)];
                randNum = Math.floor(Math.random() * 100) + 1;
                timestamp = Date.now();
                username = currentState.user ? (currentState.user.username || "参拝者") : "ゲスト";

                // 詳細項目: 運勢ランク連動ロジック
                const detailIndex = 5 - base.rank;
                const cats = ['願事','恋愛','待人','商売','旅立','学問','病気'];
                
                detailsList = cats.map(c => ({
                    title: c,
                    content: detailTexts[c][Math.min(detailIndex, detailTexts[c].length - 1)]
                }));

                // ラッキー/アンラッキー
                luckyItems = {
                    item: luckyItemsList[Math.floor(Math.random()*luckyItemsList.length)],
                    spot: luckySpotsList[Math.floor(Math.random()*luckySpotsList.length)],
                    color: luckyColorsList[Math.floor(Math.random()*luckyColorsList.length)],
                    person: luckyPersonsList[Math.floor(Math.random()*luckyPersonsList.length)]
                };
                
                let ulItem, ulSpot, ulPerson;
                do { ulItem = luckyItemsList[Math.floor(Math.random()*luckyItemsList.length)]; } while(ulItem === luckyItems.item);
                do { ulSpot = luckySpotsList[Math.floor(Math.random()*luckySpotsList.length)]; } while(ulSpot === luckyItems.spot);
                do { ulPerson = luckyPersonsList[Math.floor(Math.random()*luckyPersonsList.length)]; } while(ulPerson === luckyItems.person);

                unluckyItems = {
                    item: ulItem,
                    spot: ulSpot,
                    person: ulPerson
                };

                resultData = { 
                    type: base.type, 
                    poem: base.poem, 
                    desc: base.desc,
                    num: randNum, 
                    detail: detailsList,
                    lucky: luckyItems,
                    unlucky: unluckyItems,
                    timestamp: timestamp,
                    username: username
                };
                currentState.lastResult = resultData;

                // URL更新廃止: クリーンなURLのまま

                // ログイン時のみ保存・更新
                if(currentState.user) {
                    showLoading(true);
                    try {
                        const res = await fetch(`${API_BASE}/api/draw`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                email: currentState.user.email,
                                token: currentState.user.token,
                                result: resultData.type,
                                poem: resultData.poem,
                                detail: detailsList,
                                lucky: luckyItems,
                                unlucky: unluckyItems
                            })
                        });
                        
                        if(res.ok) {
                            const data = await res.json();
                            if(data.success && data.count) {
                                currentState.liveCount = data.count;
                                document.getElementById('live-counter').textContent = currentState.liveCount.toLocaleString() + "本";
                                fetchHistoryStats();
                            }
                        }
                    } catch(e) { console.error(e); }
                    finally { showLoading(false); }
                }

            } else {
                // 復元
                resultData = dataOverride;
                randNum = dataOverride.num || 1;
                
                // 詳細項目の復元
                if (Array.isArray(dataOverride.detail)) {
                    detailsList = dataOverride.detail;
                } else {
                    const cats = ['願事','恋愛','待人','商売','旅立','学問','病気'];
                    const vals = ['叶う','良し','来る','繁盛','吉','成就','治る','遅れる','待て','控','難','危'];
                    detailsList = cats.map(c => ({
                        title: c,
                        content: vals[Math.floor(Math.random() * vals.length)]
                    }));
                }

                // 助言の復元
                let restoredDesc = dataOverride.desc;
                if (!restoredDesc && dataOverride.poem) {
                    const original = omikujiResults.find(r => r.poem === dataOverride.poem);
                    if (original) {
                        restoredDesc = original.desc;
                    } else {
                        restoredDesc = "心穏やかに過ごすべし。";
                    }
                } else if (!restoredDesc) {
                    restoredDesc = "心穏やかに過ごすべし。";
                }

                // ラッキーアイテム等の復元
                luckyItems = dataOverride.lucky || { item: "不明", spot: "不明", color: "不明", person: "不明" };
                unluckyItems = dataOverride.unlucky || { item: "不明", spot: "不明", person: "不明" };

                timestamp = dataOverride.timestamp;
                username = dataOverride.username || "参拝者";
                
                resultData = {
                    type: dataOverride.type || dataOverride.result,
                    poem: dataOverride.poem,
                    desc: restoredDesc,
                    num: randNum,
                    detail: detailsList,
                    lucky: luckyItems,
                    unlucky: unluckyItems,
                    timestamp: timestamp,
                    username: username
                };
                currentState.lastResult = resultData;
            }

            renderResultToCard('result-card-outer', resultData, true); 
            showView('result');
            
            const container = document.getElementById('generated-image-container');
            container.innerHTML = '';
            container.classList.add('hidden');
            document.getElementById('gen-img-status').textContent = "";
        }

        // updateURL は廃止（空関数にして互換性維持）
        function updateURL(resultData) {}

        function renderResultToCard(outerId, data, withFooter) {
            const outer = document.getElementById(outerId);
            outer.innerHTML = ''; 

            // スタイル適用
            outer.className = 'result-card-outer';
            if (data.type === "大吉") outer.classList.add("style-daikichi");
            else if (data.type === "大凶") outer.classList.add("style-daikyo");
            else outer.classList.add("style-normal");

            // 1. 最上部: 家紋 + タイトル
            const headerDiv = document.createElement('div');
            headerDiv.className = 'result-logo-area';
            headerDiv.innerHTML = `
                <div class="result-kamon accent-text"><i class="bi bi-flower1"></i></div>
                <div class="result-title-text accent-text">運勢・天命乃杜</div>
            `;
            outer.appendChild(headerDiv);

            // 2. 累計発行本数 (第〇〇番の代わり)
            const issueDiv = document.createElement('div');
            issueDiv.className = 'result-issue-num';
            let issueNum = currentState.liveCount || 15118061;
            issueDiv.textContent = `累計発行本数 ${issueNum.toLocaleString()} 本`;
            outer.appendChild(issueDiv);

            // 3. 中央: 運勢結果（円）
            const circleBox = document.createElement('div');
            circleBox.className = 'result-circle-box accent-border';
            circleBox.innerHTML = `<div class="result-kanji-main accent-text">${data.type}</div>`;
            outer.appendChild(circleBox);

            // 4. 円の下: 運勢という文字
            const labelSub = document.createElement('div');
            labelSub.className = 'result-label-sub accent-text';
            labelSub.textContent = '運勢';
            outer.appendChild(labelSub);

            // 5. メインメッセージ + 助言
            const msgArea = document.createElement('div');
            msgArea.className = 'result-main-message-area';
            
            const adviceBox = document.createElement('div');
            adviceBox.className = 'result-advice-box accent-border';
            const adviceText = data.desc || "心穏やかに過ごすべし。";
            adviceBox.innerHTML = `<span class="advice-label accent-text">助言</span> <span class="accent-text">${adviceText}</span>`;
            
            const poemDiv = document.createElement('div');
            poemDiv.className = 'result-poem-vertical accent-text';
            poemDiv.textContent = data.poem;

            msgArea.appendChild(adviceBox);
            msgArea.appendChild(poemDiv);
            outer.appendChild(msgArea);

            // 6. 詳細運勢リスト (縦書き)
            const detailGrid = document.createElement('div');
            detailGrid.className = 'result-details-grid accent-border';
            
            if (data.detail) {
                data.detail.forEach(d => {
                    const col = document.createElement('div');
                    col.className = 'detail-column';
                    col.innerHTML = `<span class="detail-item-label accent-text">${d.title}</span> <span class="detail-item-content accent-text">${d.content}</span>`;
                    detailGrid.appendChild(col);
                });
            }
            outer.appendChild(detailGrid);

            // 7. 開運・不運項目
            const luckyArea = document.createElement('div');
            luckyArea.className = 'lucky-area';
            
            const lBox = document.createElement('div');
            lBox.className = 'lucky-box accent-border';
            if (data.lucky) {
                lBox.innerHTML = `
                    <div class="lucky-title accent-text">開運</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-stars"></i></span>物：${data.lucky.item}</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-geo-alt"></i></span>所：${data.lucky.spot}</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-palette"></i></span>色：${data.lucky.color}</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-person"></i></span>人：${data.lucky.person}</div>
                `;
            }
            luckyArea.appendChild(lBox);

            const uBox = document.createElement('div');
            uBox.className = 'unlucky-box accent-border';
            if (data.unlucky) {
                uBox.innerHTML = `
                    <div class="lucky-title accent-text red-text" style="color:red">不運・注意</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-exclamation-triangle"></i></span>物：${data.unlucky.item}</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-x-octagon"></i></span>所：${data.unlucky.spot}</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-person-x"></i></span>人：${data.unlucky.person}</div>
                `;
            }
            luckyArea.appendChild(uBox);
            outer.appendChild(luckyArea);

            // 8. フッター (日時・名前・QR)
            if (withFooter) {
                const footer = document.createElement('div');
                footer.className = 'result-footer-info accent-border';
                
                const metaDiv = document.createElement('div');
                metaDiv.style.textAlign = 'left';
                
                const name = data.username || "参拝者";
                const date = new Date(data.timestamp || Date.now());
                const dateStr = `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日 ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;

                metaDiv.innerHTML = `
                    <div class="result-user-name accent-text">${name} 様の運勢</div>
                    <div class="result-date accent-text">参拝日: ${dateStr}</div>
                `;

                const qrDiv = document.createElement('div');
                qrDiv.className = 'result-qr-container';
                const qrTarget = document.createElement('div');
                qrDiv.appendChild(qrTarget);
                
                footer.appendChild(metaDiv);
                footer.appendChild(qrDiv);
                outer.appendChild(footer);

                setTimeout(() => {
                    new QRCode(qrTarget, {
                        text: SITE_URL,
                        width: 60,
                        height: 60,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                }, 100);
            }
        }

        // --- 履歴・おみくじの轍 ---
        async function loadHistory() {
            const list = document.getElementById('history-list');
            const container = document.getElementById('history-container');
            const overlay = document.getElementById('history-login-overlay');
            const viewMode = document.getElementById('history-view-mode');
            const myCountEl = document.getElementById('personal-history-count');
            const globalCountEl = document.getElementById('global-history-count');

            list.innerHTML = '';

            if(!currentState.user) {
                container.classList.add('history-blurred');
                overlay.classList.remove('hidden');
                viewMode.textContent = "";
                myCountEl.textContent = "-";
                globalCountEl.textContent = "-";

                let html = '';
                for(let i=0; i<10; i++) {
                    html += `
                        <div class="bg-gray-50 dark:bg-zinc-800 p-3 rounded flex justify-between items-center border-l-4 border-gray-300">
                            <div class="flex flex-col">
                                <span class="text-xs themed-text-sub">??? 様</span>
                                <span class="text-xs text-gray-400">----/--/--</span>
                            </div>
                            <span class="font-bold text-lg">???</span>
                        </div>
                    `;
                }
                list.innerHTML = html;
                return;
            }

            container.classList.remove('history-blurred');
            overlay.classList.add('hidden');
            viewMode.textContent = "全参拝者の記録 (全期間)";
            list.innerHTML = '<p class="text-center text-sm themed-text-sub">読み込み中...</p>';
            showLoading(true);

            try {
                const res = await fetch(`${API_BASE}/api/history/global?token=${encodeURIComponent(currentState.user.token)}`);
                if(res.ok) {
                    const data = await res.json();
                    globalHistory = data.global || [];
                    personalHistory = data.personal || [];
                    
                    myCountEl.textContent = personalHistory.length + "回";
                    globalCountEl.textContent = globalHistory.length + "回";

                    // 初回レンダリング (全件)
                    renderHistoryList(globalHistory);
                    
                } else {
                    list.innerHTML = '<p class="text-center text-red-500">取得失敗</p>';
                }
            } catch(e) {
                console.error(e);
                list.innerHTML = '<p class="text-center text-red-500">通信エラー</p>';
            } finally {
                showLoading(false);
            }
        }

        // 履歴リストのレンダリング関数 (検索機能から再利用するため分離)
        function renderHistoryList(historyData) {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            
            document.getElementById('search-result-count').textContent = historyData.length;

            if(historyData.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-center">該当する履歴がありません。</p>';
                return;
            }

            historyData.forEach((item) => {
                const div = document.createElement('div');
                const isMe = item.username === currentState.user.username;
                const borderColor = item.result.includes('凶') ? 'border-gray-500' : 'border-red-500';
                const bgClass = isMe ? 'bg-red-50 dark:bg-red-900/20' : 'bg-gray-50 dark:bg-zinc-800';

                div.className = `${bgClass} p-3 rounded flex justify-between items-center border-l-4 ${borderColor} cursor-pointer hover:opacity-80 transition shadow-sm`;
                
                div.onclick = () => {
                    showResultDetail(false, item);
                }; 

                const date = new Date(item.timestamp);
                const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                div.innerHTML = `
                    <div class="flex flex-col text-left">
                        <span class="text-xs font-bold ${isMe ? 'text-red-600' : 'themed-text-sub'}">${item.username} 様</span>
                        <span class="text-xs text-gray-400">${dateStr}</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-bold text-red-700 dark:text-red-400 text-lg w-16 text-right">${item.result}</span>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // 検索ロジック
        function filterHistory() {
            const type = document.getElementById('search-type').value;
            const keyword = document.getElementById('search-keyword').value.toLowerCase();
            const dateStart = document.getElementById('search-date-start').value;
            const dateEnd = document.getElementById('search-date-end').value;

            // 検索対象は現在表示中のグローバル履歴全体とする（タブ切り替え等は実装していないため）
            // もし個人履歴だけにしたい場合は要件定義が必要だが、一旦グローバル全体から検索する仕様とする
            let targetList = globalHistory;

            const filtered = targetList.filter(item => {
                const itemDate = new Date(item.timestamp);
                
                // 運勢タイプフィルタ
                if (type !== 'all' && item.result !== type) return false;

                // キーワードフィルタ (ユーザー名)
                if (keyword && !item.username.toLowerCase().includes(keyword)) return false;

                // 日付範囲フィルタ
                if (dateStart) {
                    const start = new Date(dateStart);
                    start.setHours(0, 0, 0, 0);
                    if (itemDate < start) return false;
                }
                if (dateEnd) {
                    const end = new Date(dateEnd);
                    end.setHours(23, 59, 59, 999);
                    if (itemDate > end) return false;
                }

                return true;
            });

            renderHistoryList(filtered);
        }

        function resetSearch() {
            document.getElementById('search-type').value = 'all';
            document.getElementById('search-keyword').value = '';
            document.getElementById('search-date-start').value = '';
            document.getElementById('search-date-end').value = '';
            renderHistoryList(globalHistory);
        }

        // モーダル機能は使わなくなったので削除または無効化
        function openHistoryDetail(index) {
            // 廃止: 直接遷移するため
        }
        function closeHistoryDetail(e) {
            if(e && e.target.id !== 'history-detail-modal' && e.target.tagName !== 'BUTTON') return;
            document.getElementById('history-detail-modal').style.display = 'none';
        }

        // --- シェア用画像生成 (大吉バグ修正版) ---
        function generateResultImage() {
            const status = document.getElementById('gen-img-status');
            status.textContent = "シェア画像を生成中...フォント読み込み待機";
            
            const target = document.getElementById('result-capture-container');
            const container = document.getElementById('generated-image-container');
            container.innerHTML = '';
            container.classList.add('hidden');
            
            document.fonts.ready.then(() => {
                const originalScrollPos = window.scrollY;

                html2canvas(target, { 
                    scale: 3, 
                    useCORS: true, 
                    allowTaint: true,
                    backgroundColor: null, 
                    scrollX: 0,
                    scrollY: -window.scrollY, 
                    // ここが修正の肝です
                    onclone: (clonedDoc) => {
                        const clonedOuter = clonedDoc.getElementById('result-card-outer');
                        if (clonedOuter) {
                            // 1. 縦書きレイアウト崩れ防止ハック
                            const verticals = clonedOuter.querySelectorAll('.result-poem-vertical, .result-advice-box, .detail-column');
                            verticals.forEach(el => {
                                el.style.letterSpacing = '0.1em'; 
                                el.style.lineHeight = '1.6';
                                el.style.fontFamily = "'Zen Old Mincho', serif"; 
                            });

                            // 2. 【重要】大吉の背景SVGを削除する (これでクラッシュを防ぐ)
                            // 模様は消えますが、背景色の金色(#f3c845)は残るので見た目は金色のままです
                            clonedOuter.style.backgroundImage = 'none';

                            clonedOuter.style.height = 'auto';
                            clonedOuter.style.minHeight = '1200px'; 
                            clonedOuter.style.transform = 'none'; 
                        }
                    }
                }).then(canvas => {
                    status.textContent = "";
                    
                    container.innerHTML = '<p class="text-green-600 font-bold mb-2">画像の生成完了</p>';
                    
                    canvas.toBlob(blob => {
                        currentState.lastImageBlob = blob;
                        const url = URL.createObjectURL(blob);
                        
                        const img = document.createElement('img');
                        img.src = url;
                        img.className = "mx-auto rounded border w-32 mb-2 shadow-sm"; 
                        container.appendChild(img);
                        container.classList.remove('hidden');

                        const dlLink = document.createElement('a');
                        dlLink.href = url;
                        dlLink.download = `tenmei_omikuji_${Date.now()}.png`;
                        dlLink.className = "btn-primary text-sm mt-2 inline-block";
                        dlLink.innerHTML = '<i class="bi bi-download"></i> ダウンロード';
                        container.appendChild(dlLink);
                    }, 'image/png');

                    window.scrollTo(0, originalScrollPos);

                }).catch(err => {
                    console.error(err);
                    status.textContent = "画像の生成に失敗しました。";
                    window.scrollTo(0, originalScrollPos);
                });
            });
        }

        // サイトルートURLを返す（生成URL廃止）
        function getShareUrl() {
            return SITE_URL;
        }

        // 全プラットフォーム共通の凝縮版長文テキスト生成ロジック
        // 日本語140文字程度に収めるよう調整
        function generateUnifiedShareText(res) {
            const userName = res.username || "参拝者"; 
            const date = new Date(res.timestamp);
            const dateStr = `${date.getMonth()+1}月${date.getDate()}日`;
            
            // 開運情報は全て表示
            const luckyItems = `🗝️開運:${res.lucky.item} / ${res.lucky.color}`;
            
            // 投稿文組み立て
            return `⛩️ 運勢・天命乃杜で運試し ⛩️

参拝者：${userName}様（${dateStr}）
✨運勢：【 ${res.type} 】
📜神託：『${res.poem.substring(0, 5)}...』続きはWebで

${luckyItems}

過去の記録は「おみくじの轍」へ保存済⛩️
履歴が多ければ条件指定の検索機能で即発見🔍

#天命乃杜 #おみくじ #運勢
${getShareUrl()}`;
        }

        // --- シェアアクション (アラート削除版) ---
        async function shareToX() {
            if(!currentState.lastResult) return;
            const fullText = generateUnifiedShareText(currentState.lastResult);

            // 1. Web Share API (スマホアプリ連携) トライ
            if (navigator.share && currentState.lastImageBlob) {
                try {
                    const file = new File([currentState.lastImageBlob], "tenmei_omikuji.png", { type: "image/png" });
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            text: fullText,
                            files: [file]
                        });
                        return;
                    }
                } catch (e) {
                    console.log("Web Share API failed", e);
                }
            }

            // 2. PC/フォールバック: 画像ダウンロード + 投稿画面
            if (currentState.lastImageBlob) {
                // 画像をダウンロードさせる
                const url = URL.createObjectURL(currentState.lastImageBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tenmei_omikuji_${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // 【削除】ここで alert を出していましたが、削除しました。
            }

            // Xの投稿画面を開く
            const intent = `https://twitter.com/intent/tweet?text=${encodeURIComponent(fullText)}`;
            window.open(intent, '_blank');
        }

        async function shareToFB() {
            if(!currentState.lastResult) return;
            const fullText = generateUnifiedShareText(currentState.lastResult);

            if (navigator.share && currentState.lastImageBlob) {
                try {
                    const file = new File([currentState.lastImageBlob], "omikuji.png", { type: "image/png" });
                    await navigator.share({
                        text: fullText,
                        files: [file]
                    });
                    return;
                } catch (e) {
                    console.log("Web Share API failed for FB", e);
                }
            }

            const url = getShareUrl();
            const intent = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
            window.open(intent, '_blank');
        }
        
        async function shareToLine() {
            if(!currentState.lastResult) return;
            const fullText = generateUnifiedShareText(currentState.lastResult);

             if (navigator.share && currentState.lastImageBlob) {
                try {
                    const file = new File([currentState.lastImageBlob], "omikuji.png", { type: "image/png" });
                    await navigator.share({
                        text: fullText,
                        files: [file]
                    });
                    return;
                } catch(e) {
                    console.log("Web Share API failed for LINE", e);
                }
            }

            const intent = `https://social-plugins.line.me/lineit/share?text=${encodeURIComponent(fullText)}`;
            window.open(intent, '_blank');
        }

        // --- プロフィール機能 ---
        function handleProfileClick() {
            if(currentState.user) {
                showView('profile');
                document.getElementById('profile-current-username').textContent = currentState.user.username;
                document.getElementById('profile-current-email').textContent = currentState.user.email;
            } else {
                showView('auth');
            }
        }

        async function updateProfile() {
            const newName = document.getElementById('profile-new-username').value;
            const newPass = document.getElementById('profile-new-password').value;
            
            if(!newName && !newPass) return alert("変更内容を入力してください");
            
            showLoading(true);
            try {
                const res = await fetch(`${API_BASE}/api/user/update`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        token: currentState.user.token,
                        email: currentState.user.email,
                        newUsername: newName || undefined,
                        newPassword: newPass || undefined
                    })
                });
                const data = await res.json();
                if(data.success) {
                    alert("更新しました");
                    if(newName) currentState.user.username = newName;
                    localStorage.setItem('omikuji_user', JSON.stringify(currentState.user));
                    handleProfileClick();
                } else {
                    alert("更新失敗: " + data.error);
                }
            } catch(e) { alert("通信エラー"); }
            finally { showLoading(false); }
        }

        async function deleteAccount() {
            if(!confirm("本当にアカウントを削除しますか？\n履歴やお気に入りデータも完全に消去されます。")) return;
            
            showLoading(true);
            try {
                const res = await fetch(`${API_BASE}/api/user/delete`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        token: currentState.user.token,
                        email: currentState.user.email
                    })
                });
                
                // レスポンスがJSONかどうか確認
                const contentType = res.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const data = await res.json();
                    if(data.success) {
                        alert("アカウントを削除しました。ご利用ありがとうございました。");
                        logout();
                    } else {
                        alert("削除失敗: " + (data.message || data.error));
                    }
                } else {
                    // JSONでない場合（サーバーエラーなど）
                    const text = await res.text();
                    console.error("Delete Error:", text);
                    alert("削除処理中にエラーが発生しました。");
                }
            } catch(e) { 
                console.error(e);
                alert("通信エラーが発生しました。"); 
            }
            finally { showLoading(false); }
        }

        // --- 認証系 (新: 選択 -> 入力 -> 認証) ---
        function startAuthFlow(mode) {
            document.getElementById('auth-selection').classList.add('hidden');
            document.getElementById('auth-step-1').classList.remove('hidden');
            
            currentState.authMode = mode;
            
            const loginFields = document.getElementById('form-login-fields');
            const regFields = document.getElementById('form-register-fields');
            const title = document.getElementById('auth-form-title');

            if (mode === 'login') {
                loginFields.classList.remove('hidden');
                regFields.classList.add('hidden');
                title.textContent = 'ログイン';
            } else {
                loginFields.classList.add('hidden');
                regFields.classList.remove('hidden');
                title.textContent = '新規登録';
            }
        }

        function backToAuthSelection() {
            document.getElementById('auth-step-1').classList.add('hidden');
            document.getElementById('auth-selection').classList.remove('hidden');
        }

        async function initiateAuth(mode) {
            const emailInputId = (mode === 'login') ? 'login-email' : 'reg-email';
            const email = document.getElementById(emailInputId).value;
            const username = document.getElementById('reg-username').value;
            const pass = document.getElementById(mode === 'login' ? 'login-password' : 'reg-password').value;

            if(!email || !pass) return alert("メールアドレスとパスワードを入力してください");
            if(mode === 'register' && !username) return alert("ユーザー名を入力してください");

            // コード送信APIを叩く (脆弱性修正: パスワード検証を追加)
            showLoading(true);
            try {
                const res = await fetch(`${API_BASE}/api/auth/send`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        email, 
                        password: pass, // パスワードも送信して事前検証する
                        username: mode === 'register' ? username : undefined,
                        mode: mode 
                    }) 
                });
                const data = await res.json();
                
                if(res.ok && data.success) {
                    // ステップ2へ遷移
                    document.getElementById('auth-step-1').classList.add('hidden');
                    document.getElementById('auth-step-2').classList.remove('hidden');
                    // コード入力欄をクリアしてフォーカス
                    const codeInput = document.getElementById('auth-code-input');
                    codeInput.value = '';
                    codeInput.focus();
                } else {
                    alert(`送信エラー: ${data.error || '不明なエラー'}`);
                }
            } catch(e) { alert("通信エラー"); }
            finally { showLoading(false); }
        }

        function backToAuthStep1() {
            document.getElementById('auth-step-2').classList.add('hidden');
            document.getElementById('auth-step-1').classList.remove('hidden');
        }

        async function finalizeAuth() {
            const code = document.getElementById('auth-code-input').value;
            if(!code || code.length !== 6) return alert("6桁の認証コードを入力してください");

            const mode = currentState.authMode;
            const email = document.getElementById(mode === 'login' ? 'login-email' : 'reg-email').value;
            const pass = document.getElementById(mode === 'login' ? 'login-password' : 'reg-password').value;
            const username = document.getElementById('reg-username').value;

            showLoading(true);
            try {
                const endpoint = (mode === 'login') ? '/api/auth/login' : '/api/auth/register';
                const body = { email, password: pass, code };
                if (mode === 'register') body.username = username;

                const res = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                
                if(res.ok && data.success) {
                    loginSuccess({ email, username: data.username, token: data.token });
                } else {
                    alert(`${mode === 'login' ? 'ログイン' : '登録'}失敗: ${data.message || data.error}`);
                }
            } catch(e) { alert("通信エラー"); }
            finally { showLoading(false); }
        }

        // 旧: sendAuthCode (削除せず互換性のため残すが使用しない)
        async function sendAuthCode() { initiateAuth(currentState.authMode); }
        // 旧: performLogin / performRegister (finalizeAuthに統合)

        function loginSuccess(user) {
            currentState.user = user;
            localStorage.setItem('omikuji_user', JSON.stringify(user));
            updateAuthUI();
            loadFavorites(); 
            loadLabSettings();
            
            // Lab画面のロック状態を即座に更新するためにView再描画
            if(currentState.view === 'lab') {
                showView('lab');
            }
            
            alert(`ようこそ、${user.username || user.email} 様！`);
            showView('home');
        }

        function updateAuthUI() {
            const badge = document.getElementById('fav-status-badge');
            const navBtn = document.getElementById('nav-login-btn');
            
            if(currentState.user) {
                navBtn.innerHTML = `<i class="bi bi-person-check-fill text-green-400"></i><span class="nav-text">会員: ${currentState.user.username}</span>`;
                if(badge) badge.textContent = "クラウド保存済み";
            } else {
                navBtn.innerHTML = `<i class="bi bi-person-circle"></i><span class="nav-text">ログイン/登録</span>`;
                if(badge) badge.textContent = "端末に保存中";
            }
        }
        
        function logout() {
            localStorage.removeItem('omikuji_user');
            // ラボ設定もクリア
            if(currentState.user) localStorage.removeItem(`lab_settings_${currentState.user.email}`);
            
            currentState.user = null;
            location.reload();
        }

        // --- 記事詳細 (長文版・更新版) ---
        function openArticle(type, id) {
            const container = document.getElementById('article-detail-content');
            container.innerHTML = '';
            let html = '';
            
            if (type === 'column') {
                if (id === 1) {
                    html = `
                        <div class="article-header"><h2 class="article-title">おみくじの順番（正しい吉凶の順）</h2><div class="article-meta">2026/01/01</div></div>
                        <div class="article-content">
                            <p>初詣や神社参拝の際に引く「おみくじ」。結果に一喜一憂するのも楽しみの一つですが、その「順位」について正しく理解している人は意外と少ないかもしれません。実は神社やお寺によって解釈が異なる場合があるのですが、一般的に広く知られている順位と、当サイト「運勢・天命乃杜」で採用している伝統的な12段階の順位について詳しく解説します。</p>
                            <h3>一般的な7段階の順位</h3>
                            <p>多くの神社で採用されている最もポピュラーな順位は以下の通りです。<br><b>大吉 ＞ 吉 ＞ 中吉 ＞ 小吉 ＞ 末吉 ＞ 凶 ＞ 大凶</b><br>あるいは、「吉」の位置が変わり、<b>大吉 ＞ 中吉 ＞ 小吉 ＞ 吉 ＞ 末吉 ＞ 凶 ＞ 大凶</b> とする場合もあります。「吉」は「大吉」に次ぐ良い運勢とする説と、「小吉」と「末吉」の間の中庸な運勢とする説があるのです。</p>
                            <h3>当サイトの12段階詳細順位</h3>
                            <p>当サイトでは、より細かく運勢を占うため、古来からの伝統に基づいた以下の12段階を採用しています。</p>
                            <ol class="list-decimal list-inside space-y-2 ml-4 mb-6 font-bold">
                                <li>大吉 (だいきち)：最高の運気。感謝を忘れずに。</li>
                                <li>中吉 (ちゅうきち)：大吉に次ぐ良運。</li>
                                <li>小吉 (しょうきち)：ささやかな幸せが続く。</li>
                                <li>吉 (きち)：安定した運気。</li>
                                <li>半吉 (はんきち)：吉と凶の中間。</li>
                                <li>末吉 (すえきち)：末広がりの未来がある。</li>
                                <li>末小吉 (すえしょうきち)：今は耐える時だが希望はある。</li>
                                <li>凶 (きょう)：運気が停滞気味。慎重に。</li>
                                <li>小凶 (しょうきょう)：小さなトラブルに注意。</li>
                                <li>半凶 (はんきょう)：半分は凶だが半分は吉に転じる可能性。</li>
                                <li>末凶 (すえきょう)：終わりの凶、つまり次は吉へ向かう。</li>
                                <li>大凶 (だいきょう)：最も警戒すべき運気。しかしこれ以上落ちない。</li>
                            </ol>
                            <p>しかし、最も重要なのは順位そのものではありません。おみくじの本質は、そこに書かれている「神様からの和歌や助言」にあります。大吉であっても戒めの言葉があれば気を引き締め、大凶であっても励ましの言葉があれば希望を持つことが大切です。結果に一喜一憂せず、日々の行動指針として活用してください。</p>
                        </div>
                    `;
                } else if (id === 2) {
                    html = `
                        <div class="article-header"><h2 class="article-title">悪い結果が出ても実は大丈夫？「凶」の正しい扱い方</h2><div class="article-meta">2026/01/01</div></div>
                        <div class="article-content">
                            <p>おみくじを引いて「凶」や「大凶」が出ると、誰しも気分が落ち込むものです。「今年は良いことがないのではないか」「不吉なことが起こる前兆ではないか」と不安になるかもしれません。しかし、古来より「凶」は必ずしも忌むべきものとはされてきませんでした。むしろ、考え方によっては幸運への入り口とも言えるのです。</p>
                            <h3>「凶」は運気の底、これからは上がるのみ</h3>
                            <p>陰陽道などの東洋思想では、物事は極まれば反転すると考えます。「大吉」は今が頂点であり、これからは下り坂になる可能性があるため、むしろ慎重な行動が求められます。慢心すれば足元をすくわれる、という戒めが含まれていることが多いのです。</p>
                            <p>逆に「凶」は、今が運気の底であり、これからは上昇する一方であることを示唆しています。「禍を転じて福となす」という言葉通り、今の困難を乗り越えることで、より大きな幸運をつかむチャンスなのです。凶を引いたということは、これ以上悪くなることはない、つまり「伸びしろしかない」状態であると前向きに捉えましょう。</p>
                            <h3>結ぶか、持ち帰るか？</h3>
                            <p>悪い結果が出た場合、神社の境内にある「結び所」に結んで帰る風習が一般的です。これには「神様と縁を結ぶ」「悪い運気を神様に預けて浄化してもらう」という意味があります。利き手ではない手で結ぶことで、「困難な行いを達成した」として吉に転じさせるという修行的な意味合いも含まれています。</p>
                            <p>一方で、「戒めとして財布に入れて持ち歩く」という考え方もあります。自分への警告として時々読み返すことで、慎重な行動を心がけ、災いを未然に防ぐことができるからです。ボロボロになったら神社にお焚き上げをお願いすれば良いのです。</p>
                            <p>当サイトでは、引いたおみくじの結果は自動的に「おみくじの轍」に記録されます。これがデジタルの「結び所」です。悪い結果が出ても、ここに結んでいくことで運気は好転するでしょう。</p>
                        </div>
                    `;
                } else if (id === 3) {
                    html = `<div class="article-header"><h2 class="article-title">神社での正しい参拝マナー</h2><div class="article-meta">2025/12/30</div></div><div class="article-content"><p>神社は神様のお住まいです。初詣や日常の参拝で失礼のないよう、基本的な参拝マナーをおさらいしましょう。作法を知ることで、心も整い、より深い感謝の気持ちを伝えることができます。</p><h3>1. 鳥居をくぐる時</h3><p>鳥居は俗界と神域を分ける結界です。くぐる前には衣服を整え、軽く一礼（一揖）をし、帽子などは取ります。参道の中央（正中）は神様の通り道なので、避けて端を歩くのがマナーです。帰る際も、鳥居を出てから振り返り一礼するのが美しい作法です。</p><h3>2. 手水舎での清め方</h3><p>参拝の前に、手水舎（てみずや）で身の穢れを落とします。<br>1. 右手で柄杓を持ち、水を汲んで左手を清める。<br>2. 左手に持ち替え、右手を清める。<br>3. 再び右手に持ち、左手で水を受けて口をすすぐ（柄杓に直接口をつけない）。<br>4. 左手を再度清め、最後に柄杓を立てて残った水で柄を洗い流す。<br>これらを一杯の水で行うのが理想的です。</p><h3>3. 拝礼（二礼二拍手一礼）</h3><p>お賽銭を入れた後、鈴を鳴らし、姿勢を正します。<br>1. 深く二回お辞儀をする（二礼）。<br>2. 胸の前で両手を合わせ、右手を少し下にずらして二回拍手を打つ（二拍手）。音を立てることで邪気を払います。<br>3. 指先を揃えて祈りを捧げる。感謝の気持ちを述べ、その後に願い事を。<br>4. 最後にもう一度深くお辞儀をする（一礼）。</p><p>※出雲大社など、一部の神社では「四拍手」など作法が異なる場合がありますので、現地の案内に従ってください。</p></div>`;
                } else if (id === 4) {
                    html = `<div class="article-header"><h2 class="article-title">「失せ物」の本当の意味</h2><div class="article-meta">2025/12/28</div></div><div class="article-content"><p>おみくじの項目にある「失せ物（うせもの）」。これは単に「落とし物」や「無くした財布」のことだけを指すのではありません。人生において私たちが失ってしまうものは、物理的なモノだけではないからです。</p><h3>形あるもの、形なきもの</h3><p>失せ物には、物理的な物品だけでなく、「失った信頼」「忘れていた初心」「疎遠になった友人」「失恋した相手」「やる気」「健康」など、形のないものも含まれます。今あなたが心の中で「失ってしまった」と感じている欠落感、それこそが「失せ物」の正体かもしれません。</p><h3>言葉の意味</h3><ul class="list-disc ml-5 mb-4"><li><b>「出ず（いでず）」</b>：残念ながら戻ってこない可能性が高いです。諦めて新しいものを探すか、執着を手放すべき時です.過去にとらわれず前へ進めというメッセージです。</li><li><b>「出る」</b>：見つかります。焦らず探しましょう。</li><li><b>「高いところより出る」</b>：棚の上や、普段見ない高い場所、あるいは目上の人からの連絡で見つかるかもしれません。</li><li><b>「女（男）の知る事あり」</b>：その性別の知人が何か知っているか、持っている可能性があります。</li></ul><p>「失せ物」の欄を見る時は、今自分が「何を探しているのか」「何を失ってしまったと感じているのか」を深く問い直してみると、表面的な意味以上の深いメッセージを受け取れるかもしれません。</p></div>`;
                } else if (id === 5) {
                    html = `<div class="article-header"><h2 class="article-title">「待ち人」は恋愛だけじゃない</h2><div class="article-meta">2025/12/25</div></div><div class="article-content"><p>「待ち人来ず」と出ると、恋人ができないのかとガッカリする人が多いですが、これは大きな誤解です。おみくじにおける「待ち人」の意味はもっと広く、人生全般に関わるものです。</p><h3>人生を導くキーパーソン</h3><p>おみくじにおける「待ち人」とは、「あなたの人生に良い影響を与えてくれる人」「運命を切り開くきっかけとなる人」全般を指します。それは将来の恋人や結婚相手かもしれませんし、ビジネスパートナー、あるいは人生の師となる先生、一生の親友、もしかすると赤ちゃん（妊娠）のことかもしれません。あなたを待っている人、あるいはあなたが待つべき運命の人、すべてを含みます。</p><h3>「来ず」の意味</h3><p>「来ず」とあっても、一生現れないこともあります。「今はまだその時ではない」「自分から動きなさい」というメッセージであることが多いのです。「音信（たより）あり」とあれば、遠くから連絡が来るでしょう。「触り（さわり）あり」なら、何らかの邪魔が入るかもしれません。</p><p>待ち人は、じっと待っているだけでは現れないこともあります。自分を磨き、行動範囲を広げることで、巡り会う確率はぐっと高まります。焦らず、その時を待ちつつ、自分自身を高める努力を続けましょう。</p></div>`;
                }
            } else if (type === 'news') {
                if (id === 1) html = `<div class="article-header"><h2 class="article-title">あけましておめでとうごさいます</h2><div class="article-meta">2026/01/01</div></div><div class="article-content"><p>謹んで新年のご祝詞を申し上げます。</p><p>旧年中はひとかたならぬご厚情を賜り、誠にありがとうございました。<br>本年も皆様に幸多き年となりますよう、天命乃杜運営一同、心よりお祈り申し上げます。</p><p>新しい年が始まり、皆様それぞれに新たな目標や願いをお持ちのことと存じます。当サイトのおみくじが、皆様の迷いを晴らし、一歩を踏み出すための道標となれば幸いです。本年も変わらぬご愛顧のほど、よろしくお願い申し上げます。</p></div>`;
                else if (id === 2) html = `<div class="article-header"><h2 class="article-title">「運勢・天命乃杜」を公開いたしました。</h2><div class="article-meta">2026/01/02</div></div><div class="article-content"><p>平素より格別のご高配を賜り、厚く御礼申し上げます。</p><p>この度、誰でも気軽に、かつ本格的な運勢占いを楽しめるWebサイト「運勢・天命乃杜（てんめいのもり）」を正式に公開いたしました。</p><p>当サイトでは、伝統的なおみくじの要素に加え、西洋占星術と血液型診断を組み合わせた独自のアルゴリズムによる「日替わり運勢ランキング」を提供しております。また、会員登録（無料）を行っていただくことで、ご自身の運勢履歴を保存したり、全体の統計データに参加したりすることが可能です。今後もコンテンツの拡充や機能改善に努めてまいりますので、末永くご愛顧いただけますようお願い申し上げます。</p></div>`;
                else if (id === 3) html = `<div class="article-header"><h2 class="article-title">プレオープンのお知らせ</h2><div class="article-meta">2025/12/25</div></div><div class="article-content"><p>本日より、一部機能を制限した状態でのプレオープンを開始いたしました。</p><p>現在ご利用いただけるのは、「おみくじ機能」および「12星座占い（β版）」です。正式リリース時には、履歴保存機能や会員システムが追加される予定です。</p></div>`;
                else if (id === 4) html = `<div class="article-header"><h2 class="article-title">サーバーメンテナンス完了</h2><div class="article-meta">2025/12/20</div></div><div class="article-content"><p>本日14:00より実施しておりましたサーバーメンテナンスは、予定通り18:00に完了いたしました。</p><p>今回のメンテナンスにより、データベースの応答速度が向上しております。ご協力ありがとうございました。</p></div>`;
                else if (id === 5) html = `<div class="article-header"><h2 class="article-title">サイト開設準備室より</h2><div class="article-meta">2025/12/10</div></div><div class="article-content"><p>「運勢・天命乃杜」の開設に向け、現在鋭意開発中です。</p><p>皆様に愛されるサイトを目指し、デザインの調整や占いロジックの検証を行っております。公開まで今しばらくお待ちください。</p></div>`;
            }

            container.innerHTML = html;
            showView('article-detail');
        }

        // --- お気に入り、ランキングなど既存機能 (省略なし) ---
        async function loadFavorites() {
            const badge = document.getElementById('fav-status-badge');
            if(currentState.user) {
                if(badge) badge.textContent = "同期中...";
                try {
                    const res = await fetch(`${API_BASE}/api/favorites?email=${encodeURIComponent(currentState.user.email)}&token=${encodeURIComponent(currentState.user.token)}`);
                    if(res.ok) {
                        const data = await res.json();
                        favoriteList = data.favorites || [];
                        if(badge) badge.textContent = "クラウド保存済み";
                    }
                } catch(e) { console.error(e); }
            } else {
                const stored = localStorage.getItem('fortuneFavorites');
                if (stored) favoriteList = JSON.parse(stored);
                if(badge) badge.textContent = "端末に保存中";
            }
            renderFavorites();
        }

        // 12星座ロジック
        function initZodiacSystem() {
            const dateStr = getJSTDateString();
            const dateParts = dateStr.split('-');
            document.getElementById('current-date-display').innerHTML = `${dateParts[0]}年${dateParts[1]}月${dateParts[2]}日 <span class="text-sm font-normal ml-2 text-gray-500 dark:text-gray-400">(毎日 0:00 更新)</span>`;
            generateDailyRanking(dateStr);
            renderRanking();
        }
        
        // --- 日本時間 (JST) の日付文字列取得 (修正版) ---
        function getJSTDateString() {
            return new Date().toLocaleDateString("ja-JP", {
                timeZone: "Asia/Tokyo",
                year: "numeric",
                month: "2-digit",
                day: "2-digit"
            }).replaceAll('/', '-');
        }
        
        function getFutureDateString(baseDateStr, daysToAdd) {
            const date = new Date(baseDateStr);
            date.setDate(date.getDate() + daysToAdd);
            return date.toISOString().split('T')[0];
        }
        class SeededRandom {
            constructor(seed) {
                this.seed = 0;
                for (let i = 0; i < seed.length; i++) this.seed = (this.seed * 31 + seed.charCodeAt(i)) >>> 0;
            }
            next() {
                this.seed ^= this.seed << 13;
                this.seed ^= this.seed >> 17;
                this.seed ^= this.seed << 5;
                let x = (this.seed < 0 ? ~this.seed + 1 : this.seed);
                return (x % 100000) / 100000;
            }
        }
        const zodiacSigns = [{ id: "aries", name: "牡羊座", icon: "♈" }, { id: "taurus", name: "牡牛座", icon: "♉" }, { id: "gemini", name: "双子座", icon: "♊" },{ id: "cancer", name: "蟹座", icon: "♋" }, { id: "leo", name: "獅子座", icon: "♌" }, { id: "virgo", name: "乙女座", icon: "♍" },{ id: "libra", name: "天秤座", icon: "♎" }, { id: "scorpio", name: "蠍座", icon: "♏" }, { id: "sagittarius", name: "射手座", icon: "♐" },{ id: "capricorn", name: "山羊座", icon: "♑" }, { id: "aquarius", name: "水瓶座", icon: "♒" }, { id: "pisces", name: "魚座", icon: "♓" }];
        const bloodTypes = ["A", "B", "O", "AB"];
        
        // ラッキーアイテム等の重複排除ロジック (12星座用)
        // 48通り分のユニークな組み合わせを作るためにリストを拡張
        const zodiacItemsList = [
            "時計", "本", "水", "銀", "植物", "手帳", "香り", "靴", "音楽", "飴",
            "鏡", "ハンカチ", "帽子", "鞄", "ペン", "写真", "石", "貝殻", "鍵", "鈴",
            "リボン", "指輪", "お茶", "果物", "野菜", "パン", "手紙", "切手", "地図", "コンパス",
            "ランプ", "キャンドル", "クッション", "マグカップ", "グラス", "皿", "箸", "スプーン", "フォーク", "ナイフ",
            "石鹸", "タオル", "入浴剤", "お香", "風鈴", "扇子", "うちわ", "手袋", "マフラー", "傘"
        ];
        const zodiacColorsList = [
            "赤", "青", "緑", "黄", "白", "黒", "金", "銀", "桃", "紺",
            "橙", "紫", "茶", "灰", "水色", "黄緑", "深紅", "群青", "琥珀", "翡翠",
            "瑠璃", "真紅", "漆黒", "純白", "桜色", "藤色", "山吹色", "若草色", "空色", "茜色",
            "黄金", "白銀", "銅", "パール", "ベージュ", "クリーム", "ワインレッド", "オリーブ", "ミント", "ラベンダー",
            "サーモン", "コーラル", "ターコイズ", "インディゴ", "マゼンタ", "シアン", "ライム", "レモン", "チャコール", "カーキ"
        ];

        // 運勢コメントデータ (ランク別: S=90+, A=75+, B=50+, C=49-)
        const luckComments = {
            mainIntro: {
                S: ["今日のあなたは、宇宙のエネルギーが完璧に調和し、あらゆる幸運を引き寄せる最強の配置にあります。", "まるで星々があなたのために輝いているかのような、奇跡的な一日が始まろうとしています。", "これまでの努力が全て報われるような、素晴らしい展開が期待できる最高の一日となるでしょう。"],
                A: ["全体的な運気は非常に好調で、心地よい追い風を感じることができるでしょう。", "星々の配置があなたの背中を押し、前向きな気持ちで一日を過ごすことができます。", "直感が冴え渡り、スムーズに物事が進む、充実した一日になりそうです。"],
                B: ["今日は安定した運気で、穏やかな時間を過ごすことができるでしょう。", "大きな波乱はなく、平穏無事な一日となりそうです。日常の小さな幸せを見つけてみてください。", "可もなく不可もなくといった運勢ですが、あなたの心がけ次第で良い方向に転がります。"],
                C: ["今日は少し雲行きが怪しい一日となりそうです。慎重な行動を心がける必要があります。", "予期せぬトラブルや障害が発生しやすい星回りです。焦らず冷静に対処しましょう。", "全体的に運気が低迷しており、忍耐力が試される場面があるかもしれません。"]
            },
            mainLovePart: {
                S: ["特に恋愛運に関しては、運命的な出会いや、パートナーとの絆が劇的に深まるような出来事が待っています。素直な気持ちを伝えることで、愛の奇跡が起こるでしょう。", "愛の女神が微笑んでおり、あなたの魅力が最大限に輝く時です。意中の人との距離が一気に縮まり、甘いひとときを過ごせる可能性が高いです。"],
                C: ["恋愛面では、些細なすれ違いや誤解が生じやすいので注意が必要です。相手の言葉を遮らず、最後まで聞く余裕を持つことが、トラブル回避の鍵となります。", "感情的になりやすく、大切な人を傷つけてしまう恐れがあります。今日は自己主張を控え、相手を立てることに徹するのが賢明でしょう。"]
            },
            mainMoneyPart: {
                S: ["金運は絶好調で、思いがけない臨時収入や、将来の資産形成につながる絶好のチャンスが舞い込む予感です。直感に従って投資や買い物をすると吉と出るでしょう。", "豊かさのエネルギーが循環しており、経済的な不安が一掃されるような出来事があるかもしれません。自分への投資も大きなリターンを生むはずです。"],
                C: ["金銭面では、衝動買いや無駄遣いに十分な注意が必要です。財布の紐を固く締め、本当に必要なものかどうかを冷静に判断するよう心がけてください。", "予期せぬ出費や、甘い誘惑による損失の可能性があります。今日は大きなお金を動かすのは避け、堅実な管理に徹しましょう。"]
            },
            mainWorkPart: {
                S: ["仕事や勉学においては、あなたの才能が開花し、周囲から高い評価を得られるでしょう。難しい課題も難なくクリアでき、大きな成果を上げることができます。", "集中力が極限まで高まり、驚くべき効率でタスクをこなせる日です。新しいアイデアが次々と湧き出し、プロジェクトを成功へと導くキーパーソンになれます。"],
                C: ["仕事や勉強では、集中力が散漫になりがちで、思わぬミスを招く恐れがあります。基本に立ち返り、一つ一つの作業を丁寧に確認することが大切です。", "周囲とのコミュニケーション不足によるトラブルが懸念されます。報告・連絡・相談を怠らず、謙虚な姿勢で取り組むことで、最悪の事態は防げるでしょう。"]
            },
            mainConclusion: {
                S: ["総じて、今日は何をやってもうまくいく無敵の一日です。感謝の心を忘れずに、最高の幸運を存分に味わってください。", "この素晴らしい運気を活かし、新しいことに挑戦するのにも最適な日です。あなたの未来は明るく輝いています。"],
                A: ["ポジティブな姿勢を保つことで、運気はさらに上昇します。笑顔を絶やさず、周囲への感謝を忘れずに過ごしましょう。", "自信を持って行動すれば、きっと良い結果がついてきます。今日という一日を大切に過ごしてください。"],
                B: ["無理をせず、自分のペースを守ることが大切です。リラックスできる時間を持ち、明日のためにエネルギーを蓄えましょう。", "焦らず着実に進むことが、最終的な成功への近道です。今日は準備期間と捉え、地道な努力を続けてください。"],
                C: ["今日は「忍耐」の日と割り切り、嵐が過ぎ去るのを静かに待ちましょう。この経験が、必ずやあなたの糧となるはずです。", "落ち込む必要はありません。運気は必ず巡ります。今日は自分自身を見つめ直す良い機会と捉え、前を向いていきましょう。"]
            },
            // サブ項目用ショートメッセージ
            loveShorts: {
                S: ["運命の出会いが期待できる日", "パートナーとの愛が深まる最高の日", "アプローチするなら今がチャンス", "あなたの魅力が最高潮に達する時"],
                A: ["穏やかで幸せな時間を過ごせそう", "素直な気持ちが相手に届く日", "良い出会いの兆しあり", "楽しいデートができる予感"],
                B: ["現状維持を心がけると吉", "相手の話をよく聞くことが大切", "焦らずゆっくり関係を育んで", "友達感覚での交流がおすすめ"],
                C: ["誤解を招きやすいので言動に注意", "感情的な衝突に気をつけて", "一人の時間を大切にするのが無難", "無理なアプローチは控えて"]
            },
            moneyShorts: {
                S: ["臨時収入や昇給のチャンス到来", "投資や宝くじにツキがある日", "欲しかったものがお得に手に入る", "金運最高潮、財布が潤う予感"],
                A: ["賢い買い物ができそうな日", "将来のための自己投資は吉", "お金回りが良くスムーズな一日", "予想外のプチラッキーがあるかも"],
                B: ["収支のバランスを見直すと良い", "計画的な利用を心がけて", "衝動買いは控えたほうが無難", "堅実な節約が功を奏する日"],
                C: ["財布の紐を固く締めるべき日", "詐欺や甘い話には要注意", "無駄遣いで後悔する可能性大", "予期せぬ出費に備えて"]
            },
            workShorts: {
                S: ["大きな成果を上げて評価される日", "リーダーシップを発揮できる時", "新しいアイデアが採用されそう", "集中力抜群で作業が捗る"],
                A: ["チームワークが成功の鍵", "効率よくタスクを消化できる日", "周囲からの信頼が高まる予感", "やりがいを感じられる一日"],
                B: ["基本に忠実に取り組むと吉", "報告・連絡・相談を大切に", "無理せずマイペースに進めて", "準備や整理整頓に適した日"],
                C: ["ケアレスミスに十分注意して", "確認作業を怠らないように", "無理なスケジュールは避けて", "休息を取りつつ慎重に進めて"]
            }
        };

        function getRank(score) {
            if (score >= 90) return 'S';
            if (score >= 75) return 'A';
            if (score >= 50) return 'B';
            return 'C';
        }

        function generateDailyRanking(dateStr) {
            let combinations = [];
            zodiacSigns.forEach(sign => { bloodTypes.forEach(blood => { combinations.push({ sign, blood }); }); });
            const rng = new SeededRandom(dateStr);
            
            // 重複しないようにシャッフルリストを作成
            let shuffledItems = [];
            let shuffledColors = [];
            while(shuffledItems.length < combinations.length) shuffledItems = shuffledItems.concat(zodiacItemsList);
            while(shuffledColors.length < combinations.length) shuffledColors = shuffledColors.concat(zodiacColorsList);
            
            for (let i = shuffledItems.length - 1; i > 0; i--) {
                const j = Math.floor(rng.next() * (i + 1));
                [shuffledItems[i], shuffledItems[j]] = [shuffledItems[j], shuffledItems[i]];
            }
            for (let i = shuffledColors.length - 1; i > 0; i--) {
                const j = Math.floor(rng.next() * (i + 1));
                [shuffledColors[i], shuffledColors[j]] = [shuffledColors[j], shuffledColors[i]];
            }

            let scoredData = combinations.map((item, index) => {
                const baseScore = Math.floor(rng.next() * 60) + 40; 
                const loveScore = Math.floor(rng.next() * 60) + 40;
                const moneyScore = Math.floor(rng.next() * 60) + 40;
                const workScore = Math.floor(rng.next() * 60) + 40;
                const totalScoreRaw = (baseScore + loveScore + moneyScore + workScore) / 4;
                const totalScore = Math.min(100, Math.floor(totalScoreRaw));
                
                // ランク判定
                const totalRank = getRank(totalScore);
                const loveRank = getRank(loveScore);
                const moneyRank = getRank(moneyScore);
                const workRank = getRank(workScore);

                // ショートメッセージ生成 (ランクに応じてランダム選択)
                const loveDescList = luckComments.loveShorts[loveRank];
                const moneyDescList = luckComments.moneyShorts[moneyRank];
                const workDescList = luckComments.workShorts[workRank];

                const loveDesc = loveDescList[Math.floor(rng.next() * loveDescList.length)];
                const moneyDesc = moneyDescList[Math.floor(rng.next() * moneyDescList.length)];
                const workDesc = workDescList[Math.floor(rng.next() * workDescList.length)];

                // 長文生成ロジック
                // 1. 導入 (総合ランクベース)
                const introList = luckComments.mainIntro[totalRank];
                let longDesc = introList[Math.floor(rng.next() * introList.length)];

                // 2. 各論 (特徴的なものを挿入)
                // SランクまたはCランクのものがあれば優先的に言及する
                let specifics = [];
                
                // 恋愛について
                if (loveRank === 'S') specifics.push(luckComments.mainLovePart.S[Math.floor(rng.next() * luckComments.mainLovePart.S.length)]);
                else if (loveRank === 'C') specifics.push(luckComments.mainLovePart.C[Math.floor(rng.next() * luckComments.mainLovePart.C.length)]);
                
                // 金運について
                if (moneyRank === 'S') specifics.push(luckComments.mainMoneyPart.S[Math.floor(rng.next() * luckComments.mainMoneyPart.S.length)]);
                else if (moneyRank === 'C') specifics.push(luckComments.mainMoneyPart.C[Math.floor(rng.next() * luckComments.mainMoneyPart.C.length)]);

                // 仕事について
                if (workRank === 'S') specifics.push(luckComments.mainWorkPart.S[Math.floor(rng.next() * luckComments.mainWorkPart.S.length)]);
                else if (workRank === 'C') specifics.push(luckComments.mainWorkPart.C[Math.floor(rng.next() * luckComments.mainWorkPart.C.length)]);

                // 特徴的なものがなければ、ランダムに1つ選んで普通のコメントを入れる（今回は簡略化のため特徴的なもののみ結合）
                if (specifics.length > 0) {
                    longDesc += " " + specifics.join(" ");
                }

                // 3. 結び (総合ランクベース)
                const conclusionList = luckComments.mainConclusion[totalRank];
                longDesc += " " + conclusionList[Math.floor(rng.next() * conclusionList.length)];

                // フォールバック: 万が一生成テキストが空なら48種テキストを使う（通常ありえないが）
                if (!longDesc) longDesc = zodiacDescriptions[0];

                return {
                    sign: item.sign,
                    blood: item.blood,
                    totalScore: totalScore,
                    love: { score: loveScore, desc: loveDesc },
                    money: { score: moneyScore, desc: moneyDesc },
                    work: { score: workScore, desc: workDesc },
                    luckyNum: Math.floor(rng.next() * 9) + 1,
                    item: shuffledItems[index], 
                    color: shuffledColors[index],
                    longDesc: longDesc
                };
            });
            
            // スコア順にソートして順位を確定
            scoredData.sort((a, b) => b.totalScore - a.totalScore);
            scoredData.forEach((d, i) => { d.rank = i + 1; });

            // サブランク計算
            scoredData.forEach(d => {
                const sorted = [...scoredData].sort((a, b) => b.love.score - a.love.score);
                d.love.rank = sorted.findIndex(s => s === d) + 1;
                const sortedM = [...scoredData].sort((a, b) => b.money.score - a.money.score);
                d.money.rank = sortedM.findIndex(s => s === d) + 1;
                const sortedW = [...scoredData].sort((a, b) => b.work.score - a.work.score);
                d.work.rank = sortedW.findIndex(s => s === d) + 1;
            });
            scoredData.forEach(person => { person.calendar = calculateFutureLuck(person.sign.id, person.blood, dateStr); });
            dailyRanking = scoredData;
        }
        function calculateFutureLuck(signId, bloodType, baseDateStr) {
            let calendarDays = [];
            for(let i=0; i<30; i++) {
                const targetDate = getFutureDateString(baseDateStr, i);
                const dayOfMonth = new Date(targetDate).getDate();
                const rng = new SeededRandom(targetDate);
                let dayScores = [];
                zodiacSigns.forEach(s => {
                    bloodTypes.forEach(b => {
                        const bScore = Math.floor(rng.next() * 60) + 40;
                        const lScore = Math.floor(rng.next() * 60) + 40;
                        const mScore = Math.floor(rng.next() * 60) + 40;
                        const wScore = Math.floor(rng.next() * 60) + 40;
                        const tScore = Math.floor((bScore + lScore + mScore + wScore) / 4);
                        dayScores.push({ s: s.id, b: b, t: tScore, l: lScore, m: mScore, w: wScore });
                    });
                });
                const me = dayScores.find(d => d.s === signId && d.b === bloodType);
                let marks = [];
                if (me.t >= Math.max(...dayScores.map(d => d.t))) marks.push('<i class="bi bi-star-fill text-yellow-500"></i>');
                if (me.l >= Math.max(...dayScores.map(d => d.l))) marks.push('<i class="bi bi-heart-fill text-pink-500"></i>');
                if (me.m >= Math.max(...dayScores.map(d => d.m))) marks.push('<i class="bi bi-currency-yen text-yellow-600"></i>');
                if (me.w >= Math.max(...dayScores.map(d => d.w))) marks.push('<i class="bi bi-pencil-fill text-blue-500"></i>');
                calendarDays.push({ day: dayOfMonth, marks: marks });
            }
            return calendarDays;
        }
        function createCardHTML(data) {
            const isFav = favoriteList.some(f => f.sign === data.sign.id && f.blood === data.blood);
            const rankClass = data.rank <= 3 ? `rank-${data.rank}` : 'rank-other';
            const borderClass = data.rank <= 3 ? 'border-l-4 border-yellow-400' : '';
            const getBarColor = (score) => score > 80 ? '#ef4444' : (score > 50 ? '#eab308' : '#3b82f6');
            return `
                <div class="ranking-card ${borderClass} themed-card">
                    <button class="fav-btn ${isFav ? 'active' : ''}" onclick="toggleFavorite('${data.sign.id}', '${data.blood}')">
                        <i class="bi bi-star${isFav ? '-fill' : ''}"></i>
                    </button>
                    <div class="flex items-start">
                        <div class="rank-badge-lg ${rankClass}">${data.rank}</div>
                        <div class="ml-4 flex-grow">
                            <div class="flex items-center flex-wrap gap-2 mb-1">
                                <span class="text-3xl">${data.sign.icon}</span>
                                <span class="font-bold text-xl" style="color:var(--text-main);">${data.sign.name}</span>
                                <span class="bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded text-sm font-bold" style="color:var(--text-main);">${data.blood}型</span>
                            </div>
                            <div class="flex items-center gap-4 text-sm mt-1 mb-2" style="color: var(--text-sub);">
                                <span><i class="bi bi-hash"></i> ラッキーナンバー: <strong>${data.luckyNum}</strong></span>
                                <span><i class="bi bi-bar-chart-fill"></i> 総合: <strong>${data.totalScore}点</strong></span>
                            </div>
                            <p class="text-sm leading-relaxed mb-3 text-justify" style="color: var(--text-main); line-height:1.8;">${data.longDesc}</p>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs mb-3" style="color: var(--text-sub);">
                                <div><i class="bi bi-stars text-yellow-500"></i> ラッキーアイテム: ${data.item}</div>
                                <div><i class="bi bi-palette text-pink-500"></i> ラッキーカラー: ${data.color}</div>
                            </div>
                        </div>
                    </div>
                    <div class="param-grid">
                        <div class="param-item">
                            <div class="param-label"><i class="bi bi-heart-fill text-pink-500"></i> 恋愛 (${data.love.rank}位)</div>
                            <div class="param-score-text">${data.love.score}点</div>
                            <div class="param-value text-xs">${data.love.desc}</div>
                            <div class="score-bar-bg"><div class="score-bar-fill" style="width:${data.love.score}%; background:${getBarColor(data.love.score)};"></div></div>
                        </div>
                        <div class="param-item">
                            <div class="param-label"><i class="bi bi-currency-yen text-yellow-500"></i> 金運 (${data.money.rank}位)</div>
                            <div class="param-score-text">${data.money.score}点</div>
                            <div class="param-value text-xs">${data.money.desc}</div>
                            <div class="score-bar-bg"><div class="score-bar-fill" style="width:${data.money.score}%; background:${getBarColor(data.money.score)};"></div></div>
                        </div>
                        <div class="param-item">
                            <div class="param-label"><i class="bi bi-book-fill text-blue-500"></i> 仕事/勉強 (${data.work.rank}位)</div>
                            <div class="param-score-text">${data.work.score}点</div>
                            <div class="param-value text-xs">${data.work.desc}</div>
                            <div class="score-bar-bg"><div class="score-bar-fill" style="width:${data.work.score}%; background:${getBarColor(data.work.score)};"></div></div>
                        </div>
                    </div>
                    <div class="calendar-wrapper">
                        <p class="text-xs text-center mb-1 font-bold" style="color:var(--text-main);">向こう30日間のラッキーデー</p>
                        <div class="calendar-grid">
                            ${data.calendar.map(d => `<div class="calendar-cell"><span class="cal-date">${d.day}</span><span class="cal-mark">${d.marks.join('')}</span></div>`).join('')}
                        </div>
                        <div class="calendar-legend">
                            <span class="legend-item"><i class="bi bi-star-fill text-yellow-500"></i>総合1位</span>
                            <span class="legend-item"><i class="bi bi-heart-fill text-pink-500"></i>恋愛1位</span>
                            <span class="legend-item"><i class="bi bi-currency-yen text-yellow-600"></i>金運1位</span>
                            <span class="legend-item"><i class="bi bi-pencil-fill text-blue-500"></i>勉強1位</span>
                        </div>
                    </div>
                </div>
            `;
        }
        function toggleFavorite(signId, bloodType) {
            const existsIndex = favoriteList.findIndex(f => f.sign === signId && f.blood === bloodType);
            if (existsIndex >= 0) { favoriteList.splice(existsIndex, 1); } 
            else { if (favoriteList.length >= 5) return alert('最大5つまで'); favoriteList.push({ sign: signId, blood: bloodType }); }
            if(currentState.user) {
                fetch(`${API_BASE}/api/favorites`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email:currentState.user.email, token:currentState.user.token, favorites:favoriteList}) });
            } else { localStorage.setItem('fortuneFavorites', JSON.stringify(favoriteList)); }
            renderFavorites();
        }
        function renderFavorites() {
            const container = document.getElementById('favorites-list');
            const section = document.getElementById('favorites-section');
            container.innerHTML = '';
            if (favoriteList.length === 0) { section.classList.add('hidden'); return; }
            section.classList.remove('hidden');
            favoriteList.forEach(fav => {
                const data = dailyRanking.find(d => d.sign.id === fav.sign && d.blood === fav.blood);
                if (data) container.innerHTML += createCardHTML(data);
            });
        }
        function renderRanking() {
            const listContainer = document.getElementById('ranking-list');
            const fullListContainer = document.getElementById('full-ranking-list');
            listContainer.innerHTML = ''; fullListContainer.innerHTML = '';
            dailyRanking.forEach((data, index) => {
                const html = createCardHTML(data);
                if (index < 3) listContainer.insertAdjacentHTML('beforeend', html);
                else fullListContainer.insertAdjacentHTML('beforeend', html);
            });
        }
        function showFullRanking() {
            const fullList = document.getElementById('full-ranking-list');
            const txt = document.getElementById('show-ranking-text');
            if (fullList.classList.contains('hidden')) { fullList.classList.remove('hidden'); txt.textContent = "ランキングを閉じる"; }
            else { fullList.classList.add('hidden'); txt.textContent = "4位以下を見る"; }
        }
        function findMyRank() {
            const signId = document.getElementById('user-sign').value;
            const bloodId = document.getElementById('user-blood').value;
            const resultDiv = document.getElementById('my-rank-result');
            const myData = dailyRanking.find(d => d.sign.id === signId && d.blood === bloodId);
            if (myData) { resultDiv.innerHTML = createCardHTML(myData); resultDiv.classList.remove('hidden'); }
        }
    </script>
</body>
</html>
