<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>運勢・天命乃杜 | 本格・今日の運勢</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- フォント -->
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500;600;800&family=Zen+Old+Mincho:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root {
            /* ライトモード変数 */
            --bg-pattern: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4d4d4' fill-opacity='0.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            --bg-color: #fdfbf7;
            --text-main: #2b2b2b;
            --text-sub: #555555;
            --card-bg: #ffffff;
            --card-border: #e6e6e6;
            --accent-red: #b91c1c;
            --accent-gold: #c5a059;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.3);
            --sidebar-bg: rgba(255, 255, 255, 0.75); /* すりガラス用に透明度アップ */
            --input-bg: #ffffff;
            --omi-paper: #fffcf2; 
            --sidebar-width: 80px;
            --sidebar-width-expanded: 240px;
        }

        /* ダークモード変数 (自動検知) */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-pattern: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23444444' fill-opacity='0.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
                --bg-color: #1a1a1a;
                --text-main: #e0e0e0;
                --text-sub: #b0b0b0;
                --card-bg: #2c2c2c;
                --card-border: #444444;
                --accent-red: #ff6b6b;
                --accent-gold: #e5c07b;
                --glass-bg: rgba(30, 30, 30, 0.9);
                --glass-border: rgba(255, 255, 255, 0.1);
                --sidebar-bg: rgba(30, 30, 30, 0.75); /* すりガラス用に透明度アップ */
                --input-bg: #333333;
                --omi-paper: #fffcf2; 
            }
        }

        /* Lab: 迎春・雅モード */
        body.theme-newyear {
            --bg-color: #fffbf0;
            --bg-pattern: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23d4af37' fill-opacity='0.2'%3E%3Cpath d='M0 0h40v40H0V0zm20 20h20v20H20V20zM0 20h20v20H0V20zM20 0h20v20H20V0z'/%3E%3C/g%3E%3C/svg%3E");
            --accent-red: #e60033; /* 紅白の紅 */
            --accent-gold: #d4af37; /* 金 */
            --card-border: #d4af37;
        }
        body.theme-newyear .nav-btn {
            color: #333;
        }
        body.theme-newyear #sidebar {
            background-color: rgba(255, 252, 240, 0.85);
            border-right: 1px solid #d4af37;
        }

        body {
            font-family: 'Zen Old Mincho', 'Shippori Mincho', serif;
            background-color: var(--bg-color);
            background-image: var(--bg-pattern);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- 汎用テーマクラス --- */
        .themed-card {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-main);
        }
        .themed-text-sub { color: var(--text-sub); }
        .themed-input {
            background-color: var(--input-bg);
            color: var(--text-main);
            border: 1px solid var(--card-border);
        }

        /* --- サイドバー (すりガラス効果強化) --- */
        #sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            backdrop-filter: blur(15px); /* すりガラス効果 */
            -webkit-backdrop-filter: blur(15px);
            border-right: 1px solid var(--glass-border);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 100;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding-top: 20px;
            overflow: hidden;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }
        #sidebar:hover {
            width: var(--sidebar-width-expanded);
        }
        .nav-btn {
            width: 100%;
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--text-main);
            background: none;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
            text-decoration: none;
            height: 60px;
        }
        .nav-btn:hover {
            background-color: rgba(128,128,128,0.1);
        }
        .nav-btn i {
            font-size: 1.5rem;
            min-width: 40px;
            text-align: center;
        }
        /* サイドバー用フラスコSVGのスタイル */
        .nav-btn svg {
            min-width: 40px; /* アイコンの幅を確保 */
            width: 32px;
            height: 32px;
            margin: 0; /* 左寄せではなく中央になるようにマージン調整が必要だがflexで制御 */
            display: block;
            flex-shrink: 0;
        }

        .nav-text {
            opacity: 0;
            transform: translateX(-10px);
            transition: all 0.3s;
            font-weight: bold;
            font-family: 'Zen Old Mincho', serif;
            margin-left: 10px;
        }
        #sidebar:hover .nav-text {
            opacity: 1;
            transform: translateX(0);
        }

        /* --- メインコンテンツ --- */
        #main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
            width: calc(100% - var(--sidebar-width));
            transition: margin-left 0.3s;
        }

        /* --- 共通コンポーネント --- */
        .btn-primary {
            background-color: var(--accent-red);
            color: white;
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .btn-primary:disabled {
            background-color: #999;
            cursor: not-allowed;
            transform: none;
        }
        .btn-outline {
            background-color: transparent;
            color: var(--text-main);
            border: 2px solid var(--text-main);
            padding: 10px 25px;
            border-radius: 30px;
            font-weight: bold;
            transition: all 0.3s;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        .btn-outline:hover {
            background-color: rgba(128,128,128,0.1);
        }

        /* --- 新ローディングスピナー --- */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease; /* 滑らかなフェード */
        }
        #loading-overlay.visible {
            opacity: 1;
        }
        
        .loader-svg {
            width: 80px;
            height: 80px;
            animation: rotate 1s linear infinite;
            transform-origin: center center;
        }
        .loader-path {
            stroke: #ffffff; /* 白色の線 */
            stroke-linecap: round;
            stroke-dasharray: 89 150;
            stroke-dashoffset: 0;
        }
        @keyframes rotate {
            100% { transform: rotate(360deg); }
        }

        /* --- ホーム画面 --- */
        .home-circle-container {
            width: 300px;
            height: 300px;
            border: 2px solid var(--accent-red);
            border-radius: 50%;
            margin: 20px auto;
            position: relative;
            overflow: hidden;
            background: rgba(128,128,128,0.1);
        }
        .flying-paper {
            position: absolute;
            width: 30px;
            height: 60px;
            background: var(--omi-paper);
            border: 1px solid #ccc;
            opacity: 0;
            animation: paperFly 4s infinite linear;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            writing-mode: vertical-rl;
            color: #b91c1c;
        }
        @keyframes paperFly {
            0% { transform: translateY(350px) rotate(0deg); opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translateY(-50px) rotate(360deg); opacity: 0; }
        }

        /* --- おみくじ選択画面 --- */
        .omikuji-pool {
            position: relative;
            width: 100%;
            min-height: 100vh;
            overflow-y: visible;
            perspective: 1000px;
            padding-bottom: 200px;
        }
        .omikuji-stick {
            position: absolute;
            width: 50px;
            height: 140px;
            background-color: var(--omi-paper);
            border: 1px solid #ccc;
            box-shadow: 3px 3px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
            font-family: 'Zen Old Mincho', serif;
            writing-mode: vertical-rl;
            color: var(--accent-red);
            user-select: none;
            border-radius: 4px;
        }
        .omikuji-stick:hover {
            transform: scale(1.15) !important;
            z-index: 50;
            box-shadow: 0 15px 30px rgba(0,0,0,0.4);
            background-color: #fff;
        }
        @keyframes slideInRandom {
            from { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            to { opacity: 1; }
        }

        /* --- カウントダウン --- */
        #countdown-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 999;
            display: none;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 8rem;
            font-family: 'Zen Old Mincho', serif;
        }

        /* --- おみくじ結果カード (新デザイン修正版) --- */
        #result-capture-container {
            width: 600px;
            margin: 0 auto;
            position: relative;
        }
        .result-card-outer {
            width: 600px;
            min-height: 1200px;
            padding: 30px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            font-family: 'Zen Old Mincho', serif;
        }

        /* スタイル1: 大吉 (金・和紙) */
        .style-daikichi {
            background-color: #f3c845;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.25'/%3E%3C/svg%3E");
            border: 8px double #fff;
            color: #3e1e00;
        }
        .style-daikichi .accent-border { border-color: #3e1e00; }
        .style-daikichi .accent-text { color: #8a1c1c; }

        /* スタイル2: 大凶 (黒白・重厚) */
        .style-daikyo {
            background-color: #1a1a1a;
            border: 8px solid #333;
            color: #f0f0f0;
        }
        .style-daikyo .accent-border { border-color: #f0f0f0; }
        .style-daikyo .accent-text { color: #fff; }
        .style-daikyo .red-text { color: #fff !important; }

        /* スタイル3: その他 (標準) */
        .style-normal {
            background-color: #fffcf2;
            border: 8px double #b91c1c;
            color: #333;
        }
        .style-normal .accent-border { border-color: #b91c1c; }
        .style-normal .accent-text { color: #b91c1c; }

        .result-logo-area {
            text-align: center;
            margin-bottom: 10px;
        }
        .result-kamon {
            font-size: 3rem;
            margin-bottom: 5px;
        }
        .result-title-text {
            font-size: 1.5rem;
            font-weight: 900;
            letter-spacing: 0.3em;
        }
        .result-issue-num {
            font-size: 0.9rem;
            margin-bottom: 20px;
            font-family: monospace;
            opacity: 0.8;
        }
        
        .result-circle-box {
            width: 200px;
            height: 200px;
            border: 4px solid currentColor;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            background: rgba(255,255,255,0.1);
        }
        .result-kanji-main {
            font-size: 6rem;
            font-weight: 900;
            line-height: 1;
        }
        .result-label-sub {
            font-size: 1.2rem;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .result-main-message-area {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 40px;
            width: 100%;
            padding: 0 20px;
        }
        .result-poem-vertical {
            writing-mode: vertical-rl;
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 0.2em;
            line-height: 1.8;
            height: 350px;
        }
        .result-advice-box {
            writing-mode: vertical-rl;
            border: 2px solid currentColor;
            padding: 15px 10px;
            font-size: 1rem;
            line-height: 1.8;
            height: 350px;
        }
        .advice-label {
            font-weight: 900;
            border-bottom: 1px solid currentColor; /* 縦書きなので左線に見えるが実際は下 */
            margin-left: 10px;
            padding-bottom: 5px;
        }

        .result-details-grid {
            display: flex;
            flex-direction: row-reverse; /* 縦書きなので右から左へ */
            justify-content: center;
            gap: 15px;
            width: 100%;
            margin-bottom: 40px;
            border-top: 1px solid currentColor;
            border-bottom: 1px solid currentColor;
            padding: 20px 0;
        }
        .detail-column {
            writing-mode: vertical-rl;
            height: 250px;
            font-size: 1.1rem;
            line-height: 1.5;
        }
        .detail-item-label {
            font-weight: 900;
            margin-bottom: 10px;
            display: inline-block;
        }
        .detail-item-content {
            display: inline-block;
        }

        .lucky-area {
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            text-align: left;
        }
        .lucky-box, .unlucky-box {
            border: 1px solid currentColor;
            padding: 15px;
            border-radius: 8px;
        }
        .lucky-title { font-weight: bold; margin-bottom: 10px; border-bottom: 1px dashed currentColor; padding-bottom: 5px; }
        .lucky-row { font-size: 0.9rem; margin-bottom: 4px; display: flex; align-items: flex-start;}
        .lucky-icon { margin-right: 5px; min-width: 20px; text-align: center; }

        .result-footer-info {
            width: 100%;
            text-align: center;
            border-top: 2px solid currentColor;
            padding-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .result-user-name {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .result-date {
            font-size: 0.9rem;
        }
        .result-qr-container {
            background: #fff;
            padding: 5px;
        }

        /* 12星座カード */
        .ranking-card {
            border-radius: 16px; box-shadow: 0 4px 6px var(--shadow); padding: 20px;
            margin-bottom: 20px; transition: transform 0.2s, box-shadow 0.2s; position: relative;
        }
        .ranking-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px var(--shadow); }
        .rank-badge-lg { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.5rem; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); flex-shrink: 0; }
        .rank-1 { background: linear-gradient(135deg, #FFD700, #FDB931); border: 2px solid #fff; }
        .rank-2 { background: linear-gradient(135deg, #E0E0E0, #BDBDBD); }
        .rank-3 { background: linear-gradient(135deg, #CD7F32, #A0522D); }
        .rank-other { background-color: var(--card-border); color: var(--text-sub); font-size: 1.2rem; width: 50px; height: 50px; }
        .param-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--card-border); }
        .param-item { text-align: center; }
        .param-label { font-size: 0.75rem; color: var(--text-main); margin-bottom: 4px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 2px; flex-wrap: wrap; }
        .param-score-text { font-size: 0.9rem; font-weight: 900; color: var(--accent-red); }
        .param-value { font-size: 0.75rem; color: var(--text-sub); margin-bottom: 2px; }
        .score-bar-bg { width: 100%; height: 8px; background-color: var(--card-border); border-radius: 4px; margin-top: 4px; overflow: hidden; }
        .score-bar-fill { height: 100%; border-radius: 4px; }
        .fav-btn {
            position: absolute; top: 15px; right: 15px; background: none; border: none;
            font-size: 1.5rem; color: #ccc; cursor: pointer; transition: color 0.2s, transform 0.2s;
        }
        .fav-btn.active { color: #FFD700; transform: scale(1.1); }
        .fav-btn:hover { transform: scale(1.15); }
        .calendar-wrapper { margin-top: 15px; border-top: 1px dashed var(--card-border); padding-top: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 8px; }
        .calendar-cell { background-color: var(--bg-color); border-radius: 8px; padding: 4px 2px; text-align: center; min-height: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid var(--card-border); }
        .cal-date { font-size: 0.7rem; font-weight: bold; color: var(--text-sub); }
        .cal-mark { font-size: 0.7rem; margin-top: 2px; line-height: 1; }
        .calendar-legend { display: flex; justify-content: center; gap: 10px; margin-top: 8px; font-size: 0.7rem; color: var(--text-sub); flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 2px; }

        /* ビュー制御 */
        .view-section { display: none; opacity: 0; transition: opacity 0.5s; }
        .view-section.active { display: block; opacity: 1; }

        /* おみくじの轍 ぼかし制御 */
        .history-blurred {
            position: relative;
            filter: blur(8px);
            pointer-events: none;
            user-select: none;
            overflow: hidden;
            opacity: 0.7;
        }
        .history-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            text-align: center;
            border: 1px solid var(--card-border);
            width: 80%;
            max-width: 400px;
        }

        /* Labs ぼかし制御 */
        .lab-blurred {
            filter: blur(10px);
            pointer-events: none;
            user-select: none;
            opacity: 0.6;
            transition: all 0.5s;
        }
        .lab-lock-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
            border: 1px solid var(--card-border);
            width: 80%;
            max-width: 400px;
        }
        /* ダークモード時のロック画面 */
        @media (prefers-color-scheme: dark) {
            .lab-lock-overlay {
                background-color: rgba(30, 30, 30, 0.7);
            }
        }

        /* 詳細モーダル (削除予定だが互換性のために残す) */
        #history-detail-modal {
            display: none; 
        }

        /* 記事詳細 */
        .article-container {
            max-width: 800px; margin: 0 auto; padding: 40px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: left; line-height: 2;
        }
        .article-header { border-bottom: 2px solid var(--card-border); padding-bottom: 20px; margin-bottom: 30px; }
        .article-title { font-size: 1.8rem; font-weight: bold; margin-bottom: 10px; }
        .article-meta { color: var(--text-sub); font-size: 0.9rem; display: flex; gap: 15px; }
        .article-tag { background: rgba(128,128,128,0.2); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
        .article-content h3 { font-size: 1.4rem; font-weight: bold; margin: 30px 0 15px; border-left: 4px solid var(--accent-red); padding-left: 10px; }
        .article-content p { margin-bottom: 20px; }

        /* TENMEI Labs (新スタイル) */
        #view-lab {
            background: linear-gradient(135deg, rgba(230,240,255,0.5) 0%, rgba(255,240,245,0.5) 50%, rgba(255,250,230,0.5) 100%);
            border-radius: 20px;
            padding: 30px;
            min-height: 80vh;
        }
        .dark #view-lab {
            background: linear-gradient(135deg, rgba(30,40,60,0.5) 0%, rgba(50,30,40,0.5) 50%, rgba(50,50,30,0.5) 100%);
        }

        .lab-card {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.5);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 20px;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .dark .lab-card {
            background-color: rgba(40, 40, 40, 0.7);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .lab-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: "";
            height: 16px; width: 16px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #6366f1; } /* インディゴ系に変更 */
        input:checked + .slider:before { transform: translateX(26px); }

        /* Labアイコンのアニメーション定義 (カスタムSVG) */
        .lab-icon-svg {
            width: 30px;
            height: 30px;
            display: inline-block;
        }
        .flask-gradient-def {
            --flask-color-start: #4facfe;
            --flask-color-end: #00f2fe;
        }
        .dark .flask-gradient-def {
            --flask-color-start: #8e2de2;
            --flask-color-end: #4a00e0;
        }
        
        .flask-liquid-path {
            fill: url(#flaskLiquidGradient);
            animation: liquidWave 2s infinite ease-in-out;
            transform-origin: 50% 100%;
        }
        .flask-body-path {
            stroke: currentColor;
            stroke-width: 2.5;
            fill: none;
            stroke-linecap: round; 
            stroke-linejoin: round;
        }
        .flask-bubble {
            fill: rgba(255,255,255,0.6);
            animation: bubbleRise 3s infinite ease-in;
        }
        .flask-group {
            animation: flaskShake 3s infinite ease-in-out; /* 揺れを強く、速く */
            transform-origin: 50% 80%;
        }
        
        /* タイトル上の大きいアニメーションフラスコ */
        .title-flask-anim {
            width: 140px;
            height: 140px;
            margin: 0 auto 10px;
        }
        .title-flask-anim .flask-body-path {
            stroke: var(--text-main);
            stroke-width: 2;
        }

        /* サイドバー用の小さいアニメーションフラスコ */
        .nav-btn .lab-icon-svg {
             width: 32px;
             height: 32px;
             margin: 0;
        }
        
        @keyframes liquidWave {
            0%, 100% { transform: scaleY(1) translateY(0) skewX(0deg); }
            25% { transform: scaleY(1.05) translateY(-2px) skewX(2deg); }
            50% { transform: scaleY(1.1) translateY(-3px) skewX(0deg); }
            75% { transform: scaleY(1.05) translateY(-2px) skewX(-2deg); }
        }
        @keyframes flaskShake {
            0%, 100% { transform: rotate(0deg); }
            15% { transform: rotate(12deg); }
            30% { transform: rotate(-10deg); }
            45% { transform: rotate(8deg); }
            60% { transform: rotate(-6deg); }
            75% { transform: rotate(3deg); }
        }
        @keyframes bubbleRise {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translateY(-40px) scale(1.2); opacity: 0; }
        }

        /* 認証コード入力欄（数字のみ・枠線） */
        .auth-code-input-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        .auth-digit-input {
            width: 50px;
            height: 60px;
            font-size: 2rem;
            text-align: center;
            border: 2px solid var(--card-border);
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-main);
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .auth-digit-input:focus {
            border-color: var(--accent-red);
            box-shadow: 0 0 5px rgba(185, 28, 28, 0.3);
        }

        /* 認証初期選択画面 */
        .auth-selection-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.3s;
            border: 1px solid var(--card-border);
            background-color: var(--card-bg);
            color: var(--text-main);
        }
        .auth-selection-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            background-color: rgba(128,128,128,0.05);
        }
        .auth-selection-btn i {
            font-size: 1.5rem;
            margin-right: 15px;
        }

    </style>
</head>
<body>

    <!-- ローディングスピナー (SVG版) -->
    <div id="loading-overlay">
        <svg class="loader-svg" viewBox="0 0 50 50">
            <circle class="loader-path" cx="25" cy="25" r="20" fill="none" stroke-width="1.5"></circle>
        </svg>
    </div>

    <!-- サイドバー -->
    <nav id="sidebar">
        <button class="nav-btn" onclick="showView('home')">
            <i class="bi bi-house-door"></i>
            <span class="nav-text">ホーム</span>
        </button>
        <button class="nav-btn" onclick="showView('zodiac')">
            <i class="bi bi-stars"></i>
            <span class="nav-text">12星座×血液型占い</span>
        </button>
        <button class="nav-btn" onclick="showView('history')">
            <i class="bi bi-clock-history"></i>
            <span class="nav-text">おみくじの轍</span>
        </button>
        <button class="nav-btn" onclick="showView('news')">
            <i class="bi bi-bell"></i>
            <span class="nav-text">社務所だより</span>
        </button>
        <button class="nav-btn" onclick="showView('column')">
            <i class="bi bi-book"></i>
            <span class="nav-text">神籤草子</span>
        </button>
        <!-- Lab機能ボタン (カスタムSVGアニメーション) -->
        <button class="nav-btn" onclick="showView('lab')">
            <div class="lab-icon-svg">
                <svg viewBox="0 0 24 24" overflow="visible">
                    <!-- 定義: グラデーション -->
                    <defs>
                        <linearGradient id="flaskLiquidGradientSmall" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#4facfe;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#00f2fe;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <g class="flask-group">
                        <path class="flask-liquid-path" style="fill:url(#flaskLiquidGradientSmall)" d="M5 14 C7 13, 9 15, 12 14 C15 13, 17 15, 19 14 L18.5 20 C18.5 21, 18 22, 16 22 L8 22 C6 22, 5.5 21, 5.5 20 Z" />
                        <path class="flask-body-path" d="M9 2 L15 2 L15 7 L20 18 C20.5 19.5, 19 22, 16 22 L8 22 C5 22, 3.5 19.5, 4 18 L9 7 Z" />
                    </g>
                </svg>
            </div>
            <span class="nav-text">TENMEI Labs</span>
        </button>
        
        <button class="nav-btn" onclick="handleProfileClick()" id="nav-login-btn">
            <i class="bi bi-person-circle"></i>
            <span class="nav-text">ログイン/登録</span>
        </button>
        
        <div style="margin-top: auto; width: 100%;">
            <button class="nav-btn" onclick="showView('about')">
                <i class="bi bi-info-circle"></i>
                <span class="nav-text">当サイトについて</span>
            </button>
            <button class="nav-btn" onclick="showView('privacy')">
                <i class="bi bi-shield-lock"></i>
                <span class="nav-text">プライバシー</span>
            </button>
        </div>
    </nav>

    <!-- メインエリア -->
    <main id="main-content">
        
        <!-- ビュー: ホーム -->
        <section id="view-home" class="view-section active text-center max-w-4xl mx-auto">
            <h1 class="text-4xl font-black mb-2 tracking-widest" style="font-family: 'Zen Old Mincho'">運勢・天命乃杜</h1>
            <p class="text-sm font-serif mb-4 tracking-widest uppercase">FORTUNE TENMEI-NO-MORI</p>
            <p class="text-lg font-serif mb-8 themed-text-sub">天命が導く、日々の道しるべ<br>災いを避け、福を招く</p>

            <div class="home-circle-container" id="home-anim-container">
                <!-- JSで紙を生成 -->
            </div>

            <button onclick="startOmikuji()" class="btn-primary text-xl px-12 py-4 mb-8">
                <i class="bi bi-box-seam-fill"></i> おみくじを引く
            </button>

            <!-- カウンター -->
            <div id="home-counter-area" class="themed-card p-4 rounded-lg mb-2">
                <p class="text-sm themed-text-sub">累計発行本数</p>
                <div class="text-3xl font-bold font-mono text-red-700" id="live-counter">---</div>
                <p class="text-sm themed-text-sub mt-2">累計新規登録者数</p>
                <div class="text-xl font-bold font-mono text-blue-700" id="live-user-counter">---</div>
                <p class="text-xs themed-text-sub mt-1">最終更新: <span id="counter-time">--:--:--</span> (1秒毎更新)</p>
                <p class="text-[10px] themed-text-sub mt-1">※会員様の祈りの数のみが反映されます</p>
            </div>

            <!-- ダッシュボード風グリッド -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-12 text-left">
                <!-- 轍 (統計) -->
                <div class="themed-card p-6 rounded-xl shadow-sm">
                    <h3 class="font-bold text-lg mb-2 border-b border-gray-300 dark:border-gray-600 pb-2"><i class="bi bi-balloon-heart text-red-500"></i> おみくじの轍</h3>
                    <div class="text-xs text-right mb-2 themed-text-sub">更新: <span id="stats-update-time">--:--:--</span></div>
                    <div class="space-y-3 mb-4 text-sm" id="home-history-stats">
                         <div class="flex justify-between"><span>大吉</span><span><span id="cnt-daikichi" class="mr-2 font-mono">0</span><span id="stat-daikichi">0.00%</span></span></div>
                         <div class="w-full bg-gray-200 dark:bg-gray-600 h-2 rounded"><div id="bar-daikichi" class="bg-yellow-400 h-2 rounded" style="width: 0%"></div></div>
                         
                         <div class="flex justify-between"><span>吉</span><span><span id="cnt-kichi" class="mr-2 font-mono">0</span><span id="stat-kichi">0.00%</span></span></div>
                         <div class="w-full bg-gray-200 dark:bg-gray-600 h-2 rounded"><div id="bar-kichi" class="bg-red-400 h-2 rounded" style="width: 0%"></div></div>

                         <div class="flex justify-between"><span>中吉</span><span><span id="cnt-chukichi" class="mr-2 font-mono">0</span><span id="stat-chukichi">0.00%</span></span></div>
                         <div class="w-full bg-gray-200 dark:bg-gray-600 h-2 rounded"><div id="bar-chukichi" class="bg-orange-400 h-2 rounded" style="width: 0%"></div></div>

                         <div class="flex justify-between"><span>小吉</span><span><span id="cnt-shokichi" class="mr-2 font-mono">0</span><span id="stat-shokichi">0.00%</span></span></div>
                         <div class="w-full bg-gray-200 dark:bg-gray-600 h-2 rounded"><div id="bar-shokichi" class="bg-green-400 h-2 rounded" style="width: 0%"></div></div>
                         
                         <div class="flex justify-between"><span>末吉</span><span><span id="cnt-suekichi" class="mr-2 font-mono">0</span><span id="stat-suekichi">0.00%</span></span></div>
                         <div class="w-full bg-gray-200 dark:bg-gray-600 h-2 rounded"><div id="bar-suekichi" class="bg-blue-400 h-2 rounded" style="width: 0%"></div></div>

                         <div class="flex justify-between"><span>凶</span><span><span id="cnt-kyo" class="mr-2 font-mono">0</span><span id="stat-kyo">0.00%</span></span></div>
                         <div class="w-full bg-gray-200 dark:bg-gray-600 h-2 rounded"><div id="bar-kyo" class="bg-gray-400 h-2 rounded" style="width: 0%"></div></div>

                         <div class="flex justify-between"><span>大凶</span><span><span id="cnt-daikyo" class="mr-2 font-mono">0</span><span id="stat-daikyo">0.00%</span></span></div>
                         <div class="w-full bg-gray-200 dark:bg-gray-600 h-2 rounded"><div id="bar-daikyo" class="bg-black h-2 rounded" style="width: 0%"></div></div>
                    </div>
                    <button onclick="showView('history')" class="text-sm text-red-600 hover:underline">おみくじの轍をもっと見る (全運勢ログ)</button>
                </div>

                <!-- お知らせ -->
                <div class="themed-card p-6 rounded-xl shadow-sm">
                    <h3 class="font-bold text-lg mb-2 border-b border-gray-300 dark:border-gray-600 pb-2"><i class="bi bi-megaphone text-blue-500"></i> 社務所だより</h3>
                    <ul class="text-sm space-y-2 mb-4">
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('news', 2)"><span class="truncate">「運勢・天命乃杜」を公開いたしました。</span><span class="themed-text-sub">2026/1/2</span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('news', 1)"><span class="truncate">あけましておめでとうごさいます</span><span class="themed-text-sub">2026/1/1</span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('news', 3)"><span class="truncate">プレオープンのお知らせ</span><span class="themed-text-sub">2025/12/25</span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('news', 4)"><span class="truncate">サーバーメンテナンス完了</span><span class="themed-text-sub">2025/12/20</span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('news', 5)"><span class="truncate">サイト開設準備室より</span><span class="themed-text-sub">2025/12/10</span></li>
                    </ul>
                    <button onclick="showView('news')" class="text-sm text-blue-600 hover:underline">社務所だよりをもっと見る</button>
                </div>

                <!-- コラム -->
                <div class="themed-card p-6 rounded-xl shadow-sm">
                    <h3 class="font-bold text-lg mb-2 border-b border-gray-300 dark:border-gray-600 pb-2"><i class="bi bi-book text-green-500"></i> 神籤草子 (コラム)</h3>
                    <ul class="text-sm space-y-2 mb-4">
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('column', 1)"><span class="truncate">おみくじの順番（正しい吉凶の順）</span><span class="themed-text-sub"><i class="bi bi-journal-text"></i></span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('column', 2)"><span class="truncate">悪い結果が出ても実は大丈夫？</span><span class="themed-text-sub"><i class="bi bi-journal-text"></i></span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('column', 3)"><span class="truncate">神社での正しい参拝マナー</span><span class="themed-text-sub"><i class="bi bi-journal-text"></i></span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('column', 4)"><span class="truncate">「失せ物」の本当の意味</span><span class="themed-text-sub"><i class="bi bi-journal-text"></i></span></li>
                        <li class="flex justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-zinc-700 p-1 rounded transition" onclick="openArticle('column', 5)"><span class="truncate">「待ち人」は恋愛だけじゃない</span><span class="themed-text-sub"><i class="bi bi-journal-text"></i></span></li>
                    </ul>
                    <button onclick="showView('column')" class="text-sm text-green-600 hover:underline">神籤草子をもっと見る</button>
                </div>
            </div>
        </section>

        <!-- ビュー: おみくじ選択 -->
        <section id="view-draw" class="view-section relative min-h-screen w-full overflow-hidden" style="overflow-y: auto !important;">
            <h2 class="text-center text-2xl font-bold mb-4 z-10 relative mt-10">直感で一枚お選びください</h2>
            <div id="omikuji-pool" class="omikuji-pool"></div>
            <div class="fixed bottom-10 left-0 w-full text-center z-50 pointer-events-none">
                <button onclick="addOmikuji()" class="btn-primary pointer-events-auto shadow-xl">
                    <i class="bi bi-plus-lg"></i> もっとおみくじを探す
                </button>
            </div>
        </section>

        <!-- ビュー: おみくじ結果 -->
        <section id="view-result" class="view-section text-center">
            <div id="result-display-area" class="py-10">
                <div style="display: flex; justify-content: center; overflow: hidden;">
                    <div id="result-capture-container">
                        <!-- 結果カード (JSで動的生成) -->
                        <div class="result-card-outer" id="result-card-outer"></div>
                    </div>
                </div>

                <!-- アクションボタンエリア -->
                <div class="max-w-xl mx-auto mt-8 p-4 themed-card rounded-lg shadow space-y-4">
                    <p class="font-bold">結果をシェアする</p>
                    
                    <button onclick="generateResultImage()" class="btn-outline w-full justify-center">
                        <i class="bi bi-download"></i> 画像を保存する
                    </button>
                    
                    <div id="gen-img-status" class="text-sm themed-text-sub"></div>
                    <div id="generated-image-container" class="hidden">
                        <p class="text-green-600 font-bold mb-2">画像の生成完了</p>
                        <!-- 生成画像 -->
                    </div>

                    <div class="flex flex-col gap-3 mt-4">
                        <button onclick="shareToX()" class="bg-black text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:opacity-80">
                            <i class="bi bi-twitter-x"></i> Xでシェア (画像を添付)
                        </button>
                        <button onclick="shareToFB()" class="bg-blue-600 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:opacity-80">
                            <i class="bi bi-facebook"></i> Facebookでシェア
                        </button>
                        <button onclick="shareToLine()" class="bg-green-500 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:opacity-80">
                            <i class="bi bi-line"></i> LINEでシェア
                        </button>
                    </div>
                    <div class="mt-4">
                        <button onclick="showView('home')" class="text-sm underline text-gray-500">ホームに戻る</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ビュー: 12星座×血液型占い -->
        <section id="view-zodiac" class="view-section">
             <div class="text-center mb-8">
                <h2 class="text-2xl font-bold mb-2 flex items-center justify-center gap-2">
                    <i class="bi bi-trophy-fill text-yellow-500"></i> 最強運勢ランキング
                </h2>
                <p class="text-lg font-serif" id="current-date-display"></p>
            </div>
    
            <!-- お気に入りセクション -->
            <div id="favorites-section" class="hidden w-full mb-8 max-w-3xl mx-auto">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i class="bi bi-star-fill text-yellow-400"></i> お気に入り (最大5件)
                    <span id="fav-status-badge" class="text-xs ml-2 px-2 py-1 rounded bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300"></span>
                </h3>
                <div id="favorites-list" class="space-y-4"></div>
                <hr class="my-6 border-gray-300 dark:border-gray-600">
            </div>
    
            <div class="themed-card backdrop-blur-sm p-6 rounded-xl shadow-sm border mb-8 max-w-xl mx-auto">
                <h3 class="font-bold text-lg mb-4 text-center">あなたの順位をチェック</h3>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <select id="user-sign" class="p-2 border rounded-md themed-input">
                        <option value="aries">牡羊座 (3/21-4/19)</option>
                        <option value="taurus">牡牛座 (4/20-5/20)</option>
                        <option value="gemini">双子座 (5/21-6/21)</option>
                        <option value="cancer">蟹座 (6/22-7/22)</option>
                        <option value="leo">獅子座 (7/23-8/22)</option>
                        <option value="virgo">乙女座 (8/23-9/22)</option>
                        <option value="libra">天秤座 (9/23-10/23)</option>
                        <option value="scorpio">蠍座 (10/24-11/22)</option>
                        <option value="sagittarius">射手座 (11/23-12/21)</option>
                        <option value="capricorn">山羊座 (12/22-1/19)</option>
                        <option value="aquarius">水瓶座 (1/20-2/18)</option>
                        <option value="pisces">魚座 (2/19-3/20)</option>
                    </select>
                    <select id="user-blood" class="p-2 border rounded-md themed-input">
                        <option value="A">A型</option>
                        <option value="B">B型</option>
                        <option value="O">O型</option>
                        <option value="AB">AB型</option>
                    </select>
                    <button onclick="findMyRank()" class="btn-primary text-sm py-2 px-6">
                        <i class="bi bi-search"></i> 判定
                    </button>
                </div>
                <div id="my-rank-result" class="mt-6 hidden pt-4 border-t border-gray-300 dark:border-gray-600"></div>
            </div>
    
            <div id="ranking-list" class="space-y-4 max-w-3xl mx-auto"></div>
            
            <div class="text-center mt-6 mb-10">
                <button onclick="showFullRanking()" class="text-sm underline hover:opacity-80 flex items-center justify-center gap-1 mx-auto themed-text-sub">
                    <i class="bi bi-list-ol"></i> <span id="show-ranking-text">4位以下を見る</span>
                </button>
            </div>
            <div id="full-ranking-list" class="space-y-4 mt-4 hidden max-w-3xl mx-auto"></div>
        </section>

        <!-- ビュー: TENMEI Labs (新デザイン) -->
        <section id="view-lab" class="view-section max-w-3xl mx-auto relative">
            <div class="text-center mb-10 mt-4">
                <!-- タイトル上のアニメーションフラスコ (カスタムSVG) -->
                <div class="title-flask-anim">
                    <svg viewBox="0 0 24 24" overflow="visible" style="width:100%; height:100%;">
                        <defs>
                            <linearGradient id="flaskLiquidGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#4facfe;stop-opacity:1; animation: colorShift 5s infinite alternate;" />
                                <stop offset="100%" style="stop-color:#8e2de2;stop-opacity:1; animation: colorShift 5s infinite alternate-reverse;" />
                            </linearGradient>
                        </defs>
                        <g class="flask-group">
                            <!-- 液体 (よりリアルな波) -->
                            <path class="flask-liquid-path" d="M5 14 C7 13, 9 15, 12 14 C15 13, 17 15, 19 14 L18.5 20 C18.5 21, 18 22, 16 22 L8 22 C6 22, 5.5 21, 5.5 20 Z" />
                            <!-- 泡 -->
                            <circle class="flask-bubble" cx="10" cy="18" r="1" style="animation-delay:0s" />
                            <circle class="flask-bubble" cx="14" cy="19" r="0.8" style="animation-delay:1s" />
                            <circle class="flask-bubble" cx="12" cy="16" r="0.6" style="animation-delay:0.5s" />
                            <!-- フラスコ本体 (底丸め) -->
                            <path class="flask-body-path" d="M9 2 L15 2 L15 7 L20 18 C20.5 19.5, 19 22, 16 22 L8 22 C5 22, 3.5 19.5, 4 18 L9 7 Z" />
                        </g>
                    </svg>
                </div>
                <h2 class="text-4xl font-bold mb-2 tracking-wide" style="color: #6366f1;">
                    TENMEI Labs
                </h2>
                <p class="text-gray-600 dark:text-gray-300 font-bold">新機能を試してみる</p>
                <p class="text-sm text-gray-500 mt-2">実験中の機能に早期アクセスし、開発にご協力ください。</p>
            </div>

            <!-- ラッパー: ぼかし適用対象 -->
            <div id="lab-content-wrapper">
                <div id="lab-container">
                    <!-- 1. 迎春・雅モード -->
                    <div class="lab-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-lg text-yellow-600 dark:text-yellow-400">迎春・雅（みやび）モード</h3>
                                <p class="text-sm themed-text-sub">サイト全体の雰囲気を紅白と金色のお正月仕様に変更します。</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" onchange="TenmeiLab.toggleNewYear(this)" id="lab-toggle-newyear">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- 2. 神速の祈り -->
                    <div class="lab-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-lg text-blue-600 dark:text-blue-400">神速（しんそく）の祈り</h3>
                                <p class="text-sm themed-text-sub">おみくじのアニメーションをスキップし、結果を即座に表示します。</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" onchange="TenmeiLab.toggleSpeed(this)" id="lab-toggle-speed">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- 3. 宵闇の刻 -->
                    <div class="lab-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-lg text-purple-600 dark:text-purple-400">宵闇（よいやみ）の刻</h3>
                                <p class="text-sm themed-text-sub">OSの設定に関わらず、常にダークモードを強制適用します。</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" onchange="TenmeiLab.toggleDark(this)" id="lab-toggle-dark">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- 4. 言霊の増幅 -->
                    <div class="lab-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-lg text-green-600 dark:text-green-400">言霊（ことだま）の増幅</h3>
                                <p class="text-sm themed-text-sub">結果画面の文字サイズを大きくし、視認性を向上させます。</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" onchange="TenmeiLab.toggleBigText(this)" id="lab-toggle-bigtext">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 非ログイン時のロックオーバーレイ (ぼかしの上に表示) -->
            <div id="lab-lock" class="lab-lock-overlay hidden">
                <i class="bi bi-lock-fill text-5xl text-gray-400 mb-4 block"></i>
                <h3 class="text-xl font-bold mb-2">会員限定機能</h3>
                <p class="text-sm text-gray-500 mb-6">TENMEI Labsは会員様のみご利用いただけます。<br>ログインして実験的機能をお楽しみください。</p>
                <button onclick="showView('auth')" class="btn-primary w-full shadow-lg">ログイン / 登録</button>
            </div>
        </section>

        <!-- ビュー: ログイン/登録 (新フロー: 選択 -> 入力 -> 認証) -->
        <section id="view-auth" class="view-section max-w-md mx-auto themed-card p-8 rounded-xl shadow-lg mt-10">
            <h2 class="text-2xl font-bold mb-8 text-center">アカウント認証</h2>
            
            <!-- 初期選択画面 -->
            <div id="auth-selection">
                <div class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 text-sm text-red-700 dark:text-red-300 border border-red-200 dark:border-red-800 rounded">
                    <h4 class="font-bold mb-2"><i class="bi bi-unlock-fill mr-1"></i> 会員特典</h4>
                    <ul class="list-disc list-inside space-y-1 text-xs">
                        <li>おみくじの轍（履歴）の完全閲覧＆保存</li>
                        <li>TENMEI Labs（実験機能）の利用権</li>
                        <li>累計発行本数カウンターへの貢献</li>
                    </ul>
                </div>

                <button class="auth-selection-btn" onclick="startAuthFlow('login')">
                    <i class="bi bi-box-arrow-in-right text-blue-500"></i> ログイン
                </button>
                <button class="auth-selection-btn" onclick="startAuthFlow('register')">
                    <i class="bi bi-person-plus text-green-500"></i> 新規登録
                </button>
            </div>

            <!-- ステップ1: メール/パスワード入力 -->
            <div id="auth-step-1" class="hidden">
                <div class="flex items-center mb-6">
                    <button onclick="backToAuthSelection()" class="text-gray-500 hover:text-gray-800 mr-4">
                        <i class="bi bi-arrow-left text-xl"></i>
                    </button>
                    <h3 class="font-bold text-lg" id="auth-form-title">ログイン</h3>
                </div>

                <div id="form-login-fields" class="hidden">
                    <label class="block mb-2 font-bold text-sm">メールアドレス</label>
                    <input type="email" id="login-email" placeholder="example@email.com" class="w-full p-3 border rounded mb-4 themed-input">
                    <label class="block mb-2 font-bold text-sm">パスワード</label>
                    <input type="password" id="login-password" placeholder="********" class="w-full p-3 border rounded mb-4 themed-input">
                    <button onclick="initiateAuth('login')" class="btn-primary w-full justify-center">
                        <i class="bi bi-send"></i> 認証コードを送信
                    </button>
                </div>

                <div id="form-register-fields" class="hidden">
                    <label class="block mb-2 font-bold text-sm">ユーザー名</label>
                    <input type="text" id="reg-username" placeholder="天命 太郎" class="w-full p-3 border rounded mb-4 themed-input">
                    <label class="block mb-2 font-bold text-sm">メールアドレス</label>
                    <input type="email" id="reg-email" placeholder="example@email.com" class="w-full p-3 border rounded mb-4 themed-input">
                    <label class="block mb-2 font-bold text-sm">パスワード</label>
                    <input type="password" id="reg-password" placeholder="********" class="w-full p-3 border rounded mb-4 themed-input">
                    <button onclick="initiateAuth('register')" class="btn-primary w-full justify-center">
                        <i class="bi bi-send"></i> 認証コードを送信
                    </button>
                </div>
            </div>

            <!-- ステップ2: 認証コード入力 (数字ごとに枠) -->
            <div id="auth-step-2" class="hidden text-center">
                <div class="mb-4">
                    <i class="bi bi-envelope-check text-4xl text-red-500"></i>
                </div>
                <p class="mb-2 font-bold">認証コードを入力してください</p>
                <p class="text-xs text-gray-500 mb-6">メールアドレスに送信された6桁の数字を入力し、認証を完了させてください。</p>
                
                <div class="auth-code-input-container">
                    <input type="text" class="auth-digit-input" maxlength="1" oninput="moveToNext(this, 'digit2')" id="digit1">
                    <input type="text" class="auth-digit-input" maxlength="1" oninput="moveToNext(this, 'digit3')" id="digit2">
                    <input type="text" class="auth-digit-input" maxlength="1" oninput="moveToNext(this, 'digit4')" id="digit3">
                    <input type="text" class="auth-digit-input" maxlength="1" oninput="moveToNext(this, 'digit5')" id="digit4">
                    <input type="text" class="auth-digit-input" maxlength="1" oninput="moveToNext(this, 'digit6')" id="digit5">
                    <input type="text" class="auth-digit-input" maxlength="1" oninput="moveToNext(this, null)" id="digit6">
                </div>

                <button onclick="finalizeAuth()" class="btn-primary w-full justify-center mb-3">
                    <i class="bi bi-check-circle-fill"></i> 認証完了
                </button>
                <button onclick="backToAuthStep1()" class="text-sm underline text-gray-500">
                    戻る
                </button>
            </div>
        </section>

        <!-- ビュー: プロフィール -->
        <section id="view-profile" class="view-section max-w-md mx-auto themed-card p-8 rounded-xl shadow-lg mt-10">
            <h2 class="text-2xl font-bold mb-6 text-center">会員情報</h2>
            
            <div class="mb-6 border-b pb-4">
                <p class="text-sm themed-text-sub">現在のユーザー名</p>
                <p class="text-xl font-bold" id="profile-current-username">---</p>
                <p class="text-sm themed-text-sub mt-2">メールアドレス</p>
                <p class="text-lg" id="profile-current-email">---</p>
            </div>

            <div class="space-y-4">
                <h3 class="font-bold border-l-4 border-red-500 pl-2">情報変更</h3>
                <div>
                    <label class="block text-sm">新しいユーザー名 (変更する場合のみ)</label>
                    <input type="text" id="profile-new-username" class="w-full p-2 border rounded themed-input">
                </div>
                <div>
                    <label class="block text-sm">新しいパスワード (変更する場合のみ)</label>
                    <input type="password" id="profile-new-password" class="w-full p-2 border rounded themed-input">
                </div>
                <button onclick="updateProfile()" class="btn-primary w-full justify-center py-2 text-sm">変更を保存</button>
            </div>

            <div class="mt-10 border-t pt-6">
                <h3 class="font-bold text-red-600 mb-2">アカウント操作</h3>
                <button onclick="logout()" class="w-full bg-gray-500 text-white py-2 rounded hover:opacity-80 mb-4">ログアウト</button>
                <button onclick="deleteAccount()" class="w-full bg-red-600 text-white py-2 rounded hover:opacity-80 text-sm">アカウント削除</button>
                <p class="text-xs text-gray-500 mt-2">※アカウントを削除すると、全てのデータ（履歴、お気に入り、Lab設定等）が完全に削除されます。</p>
            </div>
        </section>

        <!-- ビュー: おみくじの轍 (履歴) -->
        <section id="view-history" class="view-section max-w-4xl mx-auto relative">
            <h2 class="text-3xl font-bold mb-6 text-center text-red-800 dark:text-red-400">おみくじの轍</h2>
            
            <div class="text-center mb-6">
                <p class="text-sm themed-text-sub">ログインすると、ご自身の履歴と皆様の参拝記録が保存されます。</p>
            </div>

            <div id="history-container" class="">
                <div class="grid grid-cols-2 gap-4 mb-4 text-center">
                    <div class="themed-card p-3 rounded">
                        <p class="text-xs themed-text-sub">あなたの参拝数 (全期間)</p>
                        <p class="text-xl font-bold" id="personal-history-count">-</p>
                    </div>
                    <div class="themed-card p-3 rounded">
                        <p class="text-xs themed-text-sub">みんなの参拝数 (全期間)</p>
                        <p class="text-xl font-bold" id="global-history-count">-</p>
                    </div>
                </div>

                <div class="themed-card p-6 rounded shadow mb-6">
                    <div class="flex justify-between items-center border-b border-gray-300 dark:border-gray-600 pb-2 mb-4">
                        <h3 class="font-bold">参拝の足跡一覧</h3>
                        <div class="text-xs text-gray-500" id="history-view-mode"></div>
                    </div>
                    <div id="history-list" class="space-y-3">
                        <!-- JSで挿入 -->
                    </div>
                </div>
            </div>

            <div id="history-login-overlay" class="history-overlay hidden">
                <i class="bi bi-lock-fill text-4xl text-gray-400 mb-4 block"></i>
                <p class="text-lg font-bold mb-2">轍を見るには会員証が必要です</p>
                <p class="text-sm themed-text-sub mb-4">ログインすると、過去の結果を詳細まで振り返ることができます。</p>
                <button onclick="showView('auth')" class="btn-primary">ログイン / 登録</button>
            </div>
        </section>

    </main>

    <!-- JavaScript ロジック -->
    <script>
        // ==========================================
        //  設定: Cloudflare WorkerのURL
        // ==========================================
        const API_BASE = "https://aaaaa.nden14800.workers.dev";
        const SITE_URL = "https://fortune-telling-at-tenmei-no-mori-authentic-today-s-fortun.pages.dev";

        // --- 状態管理 ---
        let currentState = {
            view: 'home',
            user: null, // { email, username, token, labSettings }
            lastResult: null,
            liveCount: 0,
            liveUserCount: 0,
            authMode: 'login' // 'login' or 'register'
        };

        let favoriteList = [];
        let dailyRanking = [];
        let globalHistory = [];
        let personalHistory = [];

        // Lab機能の状態管理
        const TenmeiLab = {
            saveSettings: () => {
                if(currentState.user) {
                    const settings = {
                        newyear: document.getElementById('lab-toggle-newyear').checked,
                        speed: document.getElementById('lab-toggle-speed').checked,
                        dark: document.getElementById('lab-toggle-dark').checked,
                        bigtext: document.getElementById('lab-toggle-bigtext').checked
                    };
                    currentState.user.labSettings = settings;
                    localStorage.setItem('omikuji_user', JSON.stringify(currentState.user));
                    // サーバーへの保存も実装可能だが今回はlocalStorageのみで簡易実装
                }
            },
            toggleNewYear: (el) => {
                if(!currentState.user) { el.checked = false; return; }
                if(el.checked) document.body.classList.add('theme-newyear');
                else document.body.classList.remove('theme-newyear');
                TenmeiLab.saveSettings();
            },
            toggleSpeed: (el) => {
                if(!currentState.user) { el.checked = false; return; }
                window.labSpeedMode = el.checked;
                TenmeiLab.saveSettings();
            },
            toggleDark: (el) => {
                if(!currentState.user) { el.checked = false; return; }
                if(el.checked) document.documentElement.classList.add('dark');
                else if(!window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.remove('dark');
                TenmeiLab.saveSettings();
            },
            toggleBigText: (el) => {
                if(!currentState.user) { el.checked = false; return; }
                if(el.checked) document.body.style.fontSize = '120%';
                else document.body.style.fontSize = '';
                TenmeiLab.saveSettings();
            },
            applySettings: (settings) => {
                if(!settings) return;
                const setCheck = (id, val) => {
                    const el = document.getElementById(id);
                    if(el) {
                        el.checked = val;
                        // イベント発火
                        if(id === 'lab-toggle-newyear') TenmeiLab.toggleNewYear(el);
                        if(id === 'lab-toggle-speed') TenmeiLab.toggleSpeed(el);
                        if(id === 'lab-toggle-dark') TenmeiLab.toggleDark(el);
                        if(id === 'lab-toggle-bigtext') TenmeiLab.toggleBigText(el);
                    }
                };
                setCheck('lab-toggle-newyear', settings.newyear);
                setCheck('lab-toggle-speed', settings.speed);
                setCheck('lab-toggle-dark', settings.dark);
                setCheck('lab-toggle-bigtext', settings.bigtext);
            }
        };

        // --- イニシャライズ ---
        window.onload = function() {
            initHomeAnimation();
            initZodiacSystem();
            
            const storedUser = localStorage.getItem('omikuji_user');
            if(storedUser) {
                try {
                    currentState.user = JSON.parse(storedUser);
                    if(currentState.user && currentState.user.labSettings) {
                        TenmeiLab.applySettings(currentState.user.labSettings);
                    }
                } catch(e) {
                    console.error("Auth Data Parse Error", e);
                }
            }
            updateAuthUI();

            startLiveCounter();
            fetchHistoryStats();
            setInterval(fetchHistoryStats, 1000); 
            setInterval(startLiveCounter, 1000); 
            
            loadFavorites();

            // シェアURLパラメータチェック
            const params = new URLSearchParams(window.location.search);
            const shareData = params.get('d');
            if (shareData) {
                try {
                    const decoded = JSON.parse(atob(shareData));
                    showResultDetail(false, decoded);
                } catch(e) {
                    console.error("Share data decode error", e);
                }
            }
        };

        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if(show) {
                overlay.style.display = 'flex';
                // わずかに遅らせてopacityを変更しフェードインさせる
                requestAnimationFrame(() => overlay.classList.add('visible'));
            } else {
                overlay.classList.remove('visible');
                // フェードアウト後に非表示
                setTimeout(() => {
                    if(!overlay.classList.contains('visible')) overlay.style.display = 'none';
                }, 300);
            }
        }

        function showView(viewId) {
            // Lab機能へのアクセス制限処理
            // ビュー自体は表示するが、非ログイン時はぼかしとロックをかける
            if(viewId === 'lab') {
                const lock = document.getElementById('lab-lock');
                const wrapper = document.getElementById('lab-content-wrapper');
                
                if(!currentState.user) {
                    lock.classList.remove('hidden');
                    wrapper.classList.add('lab-blurred');
                    // スイッチを無効化
                    document.querySelectorAll('.toggle-switch input').forEach(el => el.disabled = true);
                } else {
                    lock.classList.add('hidden');
                    wrapper.classList.remove('lab-blurred');
                    document.querySelectorAll('.toggle-switch input').forEach(el => el.disabled = false);
                }
            }

            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
                setTimeout(() => {
                    if(!el.classList.contains('active')) el.style.display = 'none';
                }, 500);
            });
            
            const target = document.getElementById(`view-${viewId}`);
            target.style.display = 'block';
            void target.offsetWidth; 
            target.classList.add('active');
            currentState.view = viewId;

            if(viewId === 'draw') {
                resetOmikujiPool();
            }
            if(viewId === 'history') {
                loadHistory();
            }
        }

        function articleBack() {
            showView('home'); 
        }

        // --- ホームアニメーション ---
        function initHomeAnimation() {
            const container = document.getElementById('home-anim-container');
            const paperCount = 20;
            for(let i=0; i<paperCount; i++) {
                const paper = document.createElement('div');
                paper.className = 'flying-paper';
                paper.style.left = Math.random() * 260 + 'px';
                paper.style.animationDelay = Math.random() * 4 + 's';
                paper.style.animationDuration = (3 + Math.random() * 3) + 's';
                paper.textContent = "天命乃杜";
                container.appendChild(paper);
            }
        }

        // --- ライブカウンター (API連携) ---
        function startLiveCounter() {
            const el = document.getElementById('live-counter');
            const userEl = document.getElementById('live-user-counter');
            const timeEl = document.getElementById('counter-time');
            
            const now = new Date();
            timeEl.textContent = now.toLocaleTimeString();

            fetch(`${API_BASE}/api/counter`)
                .then(res => res.json())
                .then(data => {
                    currentState.liveCount = (data.count || 0);
                    el.textContent = currentState.liveCount.toLocaleString() + "本";
                    // ユーザー数（仮実装: API側で未実装なら0）
                    currentState.liveUserCount = (data.userCount || 0);
                    userEl.textContent = currentState.liveUserCount.toLocaleString() + "人";
                })
                .catch(e => console.error(e));
        }

        // --- 統計情報の取得 ---
        async function fetchHistoryStats() {
            try {
                const res = await fetch(`${API_BASE}/api/stats`);
                if(res.ok) {
                    const data = await res.json();
                    document.getElementById('stats-update-time').textContent = data.timestamp || "--:--:--";

                    const setBar = (id, percent, count) => {
                        const p = parseFloat(percent).toFixed(2);
                        document.getElementById(`stat-${id}`).textContent = p + "%";
                        document.getElementById(`cnt-${id}`).textContent = (count || 0).toLocaleString() + "本";
                        document.getElementById(`bar-${id}`).style.width = p + "%";
                    };

                    const stats = data.stats || {};
                    const counts = data.counts || {};
                    
                    setBar('daikichi', stats.daikichi, counts.daikichi);
                    setBar('kichi', stats.kichi, counts.kichi);
                    setBar('chukichi', stats.chukichi, counts.chukichi);
                    setBar('shokichi', stats.shokichi, counts.shokichi);
                    setBar('suekichi', stats.suekichi, counts.suekichi);
                    setBar('kyo', stats.kyo, counts.kyo);
                    setBar('daikyo', stats.daikyo, counts.daikyo);
                }
            } catch(e) { console.error(e); }
        }

        // --- おみくじロジック ---
        function startOmikuji() {
            showView('draw');
        }

        function resetOmikujiPool() {
            const pool = document.getElementById('omikuji-pool');
            pool.innerHTML = '';
            addOmikujiBatch(100, true); 
        }

        function addOmikuji() {
            addOmikujiBatch(50, false);
            const section = document.getElementById('view-draw');
            section.scrollBy({ top: 400, behavior: 'smooth' });
        }

        function addOmikujiBatch(count, isInitial) {
            const pool = document.getElementById('omikuji-pool');
            let lastBottom = 0;
            if (!isInitial && pool.childElementCount > 0) {
                lastBottom = pool.childElementCount * 25; 
            }

            for(let i=0; i<count; i++) {
                const stick = document.createElement('div');
                stick.className = 'omikuji-stick shadow-md rounded';
                stick.textContent = `天命乃杜`; 
                
                const left = Math.random() * 90 + 5; 
                let top;
                if (isInitial) {
                    top = (i * 20) + (Math.random() * 100); 
                } else {
                    top = lastBottom + (i * 20) + (Math.random() * 100);
                }
                const rot = Math.random() * 360;
                
                stick.style.left = `calc(${left}% - 25px)`;
                stick.style.top = `${top}px`;
                stick.style.transform = `rotate(${rot}deg)`;
                stick.style.animation = `slideInRandom 0.5s ease forwards ${Math.random() * 0.3}s`;
                
                stick.onclick = function() {
                    drawResult(this);
                };
                
                pool.appendChild(stick);
            }
        }

        const omikujiResults = [
            { type: "大吉", poem: "枯れ果てし 枝に再び 花咲くが如し", desc: "最高の運気です。長年の努力が報われ、枯れ木に花が咲くような喜びが訪れるでしょう。しかし慢心は禁物。感謝の心を忘れずに。" },
            { type: "中吉", poem: "照る月を 雲が隠せど 風払うなり", desc: "一時的な迷いがあっても、すぐに晴れ間が見えます。自分の信念を貫くことで、雲を払う風のような助けが現れるはずです。" },
            { type: "小吉", poem: "小川の水 淀まず流るる 様を見るべし", desc: "派手さはありませんが、平穏無事な日々が続きます。日々の小さな幸せを大切にし、流れに身を任せるのが吉です。" },
            { type: "吉", poem: "春風に 池の氷も 解け初めて", desc: "厳しい冬が終わり、徐々に運気が上昇しています。焦らず着実に進めば、池の氷が解けるように悩みも消えていくでしょう。" },
            { type: "末吉", poem: "山道の 険しき坂も 一歩より", desc: "今は登り坂で苦しい時かもしれませんが、一歩一歩進めば必ず頂上に辿り着けます。忍耐力が試される時です。" },
            { type: "凶", poem: "雨雲の 晴れ間も見えず 濡れ衣かな", desc: "誤解を受けやすく、思うようにいかない時期です。今は弁解せず、静かに嵐が過ぎるのを待つのが賢明な判断です。" },
            { type: "大凶", poem: "嵐吹く 荒野に一人 立つが如し", desc: "八方塞がりの厳しい運勢。無理に動くと災いを招きます。身を潜め、自分を見つめ直す修行の時と心得てください。" }
        ];

        // 重複排除用リスト拡張 (おみくじ用) 100種以上
        const luckyItemsList = [
            "古時計","香水","手鏡","文庫本","スニーカー","万年筆","水晶","観葉植物","銀の指輪","ハンカチ",
            "革靴","手帳","香辛料","紅茶","コイン","鈴","扇子","万華鏡","砂時計","栞","眼鏡","帽子","手袋",
            "香木","和紙","筆","インク","切手","古銭","鍵","ロケット","ブローチ","スカーフ","リボン","ベルト",
            "財布","パスケース","名刺入れ","ポーチ","水筒","マグカップ","皿","箸","風鈴","お守り","数珠","朱肉",
            "印鑑","ガラス玉","竹細工","土鈴","絵馬","破魔矢","達磨","招き猫","こけし","折り鶴","手拭い",
            "足袋","草履","下駄","簪","帯留め","巾着","風呂敷","茶碗","湯呑み","急須","鉄瓶","火箸","風車",
            "独楽","凧","羽子板","カルタ","双六","ビー玉","おはじき","メンコ","竹馬","竹とんぼ","お手玉",
            "あやとり","剣玉","ヨーヨー","将棋の駒","碁石","花札","サイコロ","トランプ","チェス駒","パズル",
            "模型","フィギュア","ぬいぐるみ","オルゴール","ハーモニカ","笛","太鼓","三味線","琴","琵琶"
        ];
        const luckySpotsList = [
            "図書館","カフェ","神社","海辺","高台","公園","美術館","映画館","博物館","水族館","動物園","植物園",
            "本屋","雑貨屋","パン屋","花屋","駅","空港","港","橋の上","川沿い","山頂","森","温泉","寺院","教会",
            "塔","城","市場","路地裏","噴水広場","並木道","屋上","地下街","交差点","歩道橋","ベンチ","テラス",
            "窓際","カウンター","個室","ロビー","玄関","庭","ベランダ","書斎","リビング","寝室","台所","浴室",
            "屋根裏","地下室","物置","車庫","バス停","タクシー乗り場","駐車場","駐輪場","校庭","体育館","教室",
            "講堂","食堂","売店","保健室","職員室","図書室","音楽室","美術室","理科室","家庭科室","技術室",
            "放送室","生徒会室","部室","更衣室","プール","道場","弓道場","相撲場","テニスコート","グラウンド",
            "スタジアム","アリーナ","ホール","劇場","ライブハウス","スタジオ","ギャラリー","アトリエ","工房","研究所",
            "工場","倉庫","オフィス","会議室","応接室","社長室","休憩室","給湯室","トイレ","エレベーター"
        ];
        const luckyColorsList = [
            "赤","青","白","金","紫","緑","黄","橙","桃","黒","銀","紺","茶","灰","水色","黄緑","深紅","群青",
            "琥珀","翡翠","瑠璃","真紅","漆黒","純白","桜色","藤色","山吹色","若草色","空色","茜色","黄金",
            "白銀","銅","パール","ベージュ","クリーム","ワインレッド","オリーブ","ミント","ラベンダー","サーモン",
            "コーラル","ターコイズ","インディゴ","マゼンタ","シアン","ライム","レモン","チャコール","カーキ","セピア",
            "ブロンズ","プラチナ","ローズ","アクア","マリン","スカイ","フォレスト","リーフ","グラス","サンセット",
            "ミッドナイト","スノー","アイボリー","サンド","アース","メタル","ネオン","パステル","ビビッド","ダーク",
            "ライト","クリア","マット","グロス","メタリック","パールホワイト","シャンパンゴールド","ロイヤルブルー",
            "ベビーピンク","モスグリーン","マスタード","テラコッタ","ボルドー","キャメル","グレージュ","オフホワイト",
            "ミストグレー","アイスブルー","シェルピンク","ラベンダーアメジスト","ミントグリーン","レモンイエロー",
            "アプリコット","ピーチ","ラズベリー","ストロベリー","チョコレート","ココア","モカ"
        ];
        const luckyPersonsList = [
            "旧友","年上","年下","家族","先生","初対面","同僚","上司","部下","隣人","店員","旅人","子供","老人",
            "職人","芸術家","医師","看護師","警察官","消防士","運転手","駅員","郵便屋","料理人","美容師","作家",
            "歌手","俳優","選手","学者","社長","秘書","受付","警備員","清掃員","農家","漁師","神主","住職","牧師",
            "シスター","占い師","幼馴染","親戚","恩師","先輩","後輩","ライバル","パートナー","恋人","片思いの人",
            "元恋人","婚約者","配偶者","祖父","祖母","父","母","兄","弟","姉","妹","息子","娘","孫","叔父","叔母",
            "甥","姪","従兄弟","はとこ","義父","義母","義兄","義弟","義姉","義妹","友人","親友","悪友","知人",
            "メル友","ネッ友","フォロワー","ファン","推し","アイドル","タレント","芸人","アナウンサー","モデル",
            "声優","YouTuber","インフルエンサー","ブロガー","ライター","編集者","カメラマン","デザイナー","イラストレーター"
        ];

        function getRandomUnique(list, count) {
            // シャッフルして先頭からcount個取得
            const shuffled = [...list].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        function drawResult(element) {
            const overlay = document.getElementById('countdown-overlay');
            const numEl = document.getElementById('countdown-number');
            overlay.style.display = 'flex';
            
            // Lab: 神速の祈りモードならカウントダウン省略
            if(window.labSpeedMode) {
                overlay.style.display = 'none';
                showResultDetail(true);
                return;
            }
            
            let count = 3;
            numEl.textContent = count;
            
            const timer = setInterval(() => {
                count--;
                if(count > 0) {
                    numEl.textContent = count;
                } else {
                    clearInterval(timer);
                    overlay.style.display = 'none';
                    showResultDetail(true); 
                }
            }, 1000);
        }

        async function showResultDetail(isNewDraw, dataOverride = null) {
            let resultData, randNum, detailsList, luckyItems, unluckyItems, timestamp, username;

            if (isNewDraw) {
                // 新規抽選
                const base = omikujiResults[Math.floor(Math.random() * omikujiResults.length)];
                randNum = Math.floor(Math.random() * 100) + 1;
                timestamp = Date.now();
                username = currentState.user ? (currentState.user.username || "参拝者") : "ゲスト";

                // 詳細項目
                const cats = ['願事','恋愛','待人','商売','旅立','学問','病気'];
                const vals = ['叶う','良し','来る','繁盛','吉','成就','治る','遅れる','待て','控','難','危'];
                detailsList = cats.map(c => ({
                    title: c,
                    content: vals[Math.floor(Math.random() * vals.length)]
                }));

                // ラッキー/アンラッキー（リストからランダムに取得し重複を避ける）
                // 確実にランダムにするため毎回シャッフル
                const shuffledItems = getRandomUnique(luckyItemsList, 2);
                const shuffledSpots = getRandomUnique(luckySpotsList, 2);
                const shuffledColors = getRandomUnique(luckyColorsList, 1);
                const shuffledPersons = getRandomUnique(luckyPersonsList, 2);

                luckyItems = {
                    item: shuffledItems[0],
                    spot: shuffledSpots[0],
                    color: shuffledColors[0],
                    person: shuffledPersons[0]
                };
                
                unluckyItems = {
                    item: shuffledItems[1],
                    spot: shuffledSpots[1],
                    person: shuffledPersons[1]
                };

                resultData = { 
                    type: base.type, 
                    poem: base.poem, 
                    desc: base.desc,
                    num: randNum, 
                    detail: detailsList,
                    lucky: luckyItems,
                    unlucky: unluckyItems,
                    timestamp: timestamp,
                    username: username
                };
                currentState.lastResult = resultData;

                // URL更新 (おみくじを引いた時)
                updateURL(resultData);

                // ログイン時のみ保存・更新
                if(currentState.user) {
                    showLoading(true);
                    try {
                        const res = await fetch(`${API_BASE}/api/draw`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                email: currentState.user.email,
                                token: currentState.user.token,
                                result: resultData.type,
                                poem: resultData.poem,
                                desc: resultData.desc, // 追加: 助言も保存
                                detail: detailsList,
                                lucky: luckyItems,
                                unlucky: unluckyItems
                            })
                        });
                        
                        if(res.ok) {
                            const data = await res.json();
                            if(data.success && data.count) {
                                // サーバーからのカウント
                                currentState.liveCount = data.count;
                                document.getElementById('live-counter').textContent = currentState.liveCount.toLocaleString() + "本";
                                fetchHistoryStats();
                            }
                        }
                    } catch(e) { console.error(e); }
                    finally { showLoading(false); }
                }

            } else {
                // 復元 (履歴などから)
                resultData = dataOverride;
                randNum = dataOverride.num || 1;
                detailsList = dataOverride.detail;
                luckyItems = dataOverride.lucky;
                unluckyItems = dataOverride.unlucky;
                timestamp = dataOverride.timestamp;
                username = dataOverride.username || "参拝者";
                
                // 互換性チェック: descがない場合はtypeから復元を試みる
                if (!resultData.desc) {
                    const base = omikujiResults.find(r => r.type === resultData.type);
                    if (base) resultData.desc = base.desc;
                    else resultData.desc = "心穏やかに過ごすべし。";
                }

                currentState.lastResult = resultData;
            }

            // レンダリング (メインエリア)
            renderResultToCard('result-card-outer', resultData, true); 

            showView('result');
            
            // 画像生成コンテナリセット
            const container = document.getElementById('generated-image-container');
            container.innerHTML = '';
            container.classList.add('hidden');
            document.getElementById('gen-img-status').textContent = "";
        }

        function updateURL(resultData) {
            const json = JSON.stringify(resultData);
            const encoded = btoa(unescape(encodeURIComponent(json))); 
            const newUrl = `${window.location.pathname}?d=${encoded}`;
            window.history.pushState({ path: newUrl }, '', newUrl);
        }

        function renderResultToCard(outerId, data, withFooter) {
            const outer = document.getElementById(outerId);
            outer.innerHTML = ''; 

            // スタイル適用
            outer.className = 'result-card-outer';
            if (data.type === "大吉") outer.classList.add("style-daikichi");
            else if (data.type === "大凶") outer.classList.add("style-daikyo");
            else outer.classList.add("style-normal");

            // 1. 最上部: 家紋 + タイトル
            const headerDiv = document.createElement('div');
            headerDiv.className = 'result-logo-area';
            headerDiv.innerHTML = `
                <div class="result-kamon accent-text"><i class="bi bi-flower1"></i></div>
                <div class="result-title-text accent-text">運勢・天命乃杜</div>
            `;
            outer.appendChild(headerDiv);

            // 2. 累計発行本数 (第〇〇番の代わり)
            const issueDiv = document.createElement('div');
            issueDiv.className = 'result-issue-num';
            let issueNum = currentState.liveCount || 15118061;
            issueDiv.textContent = `累計発行本数 ${issueNum.toLocaleString()} 本`;
            outer.appendChild(issueDiv);

            // 3. 中央: 運勢結果（円）
            const circleBox = document.createElement('div');
            circleBox.className = 'result-circle-box accent-border';
            circleBox.innerHTML = `<div class="result-kanji-main accent-text">${data.type}</div>`;
            outer.appendChild(circleBox);

            // 4. 円の下: 運勢という文字
            const labelSub = document.createElement('div');
            labelSub.className = 'result-label-sub accent-text';
            labelSub.textContent = '運勢';
            outer.appendChild(labelSub);

            // 5. メインメッセージ + 助言
            const msgArea = document.createElement('div');
            msgArea.className = 'result-main-message-area';
            
            const adviceBox = document.createElement('div');
            adviceBox.className = 'result-advice-box accent-border';
            const adviceText = data.desc || "心穏やかに過ごすべし。"; // ここで確実にテキストを入れる
            adviceBox.innerHTML = `<span class="advice-label accent-text">助言</span> <span class="accent-text">${adviceText}</span>`;
            
            const poemDiv = document.createElement('div');
            poemDiv.className = 'result-poem-vertical accent-text';
            poemDiv.textContent = data.poem;

            msgArea.appendChild(adviceBox);
            msgArea.appendChild(poemDiv);
            outer.appendChild(msgArea);

            // 6. 詳細運勢リスト (縦書き)
            const detailGrid = document.createElement('div');
            detailGrid.className = 'result-details-grid accent-border';
            
            if (data.detail) {
                data.detail.forEach(d => {
                    const col = document.createElement('div');
                    col.className = 'detail-column';
                    col.innerHTML = `<span class="detail-item-label accent-text">${d.title}</span> <span class="detail-item-content accent-text">${d.content}</span>`;
                    detailGrid.appendChild(col);
                });
            }
            outer.appendChild(detailGrid);

            // 7. 開運・不運項目
            const luckyArea = document.createElement('div');
            luckyArea.className = 'lucky-area';
            
            const lBox = document.createElement('div');
            lBox.className = 'lucky-box accent-border';
            if (data.lucky) {
                lBox.innerHTML = `
                    <div class="lucky-title accent-text">開運</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-stars"></i></span>物：${data.lucky.item}</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-geo-alt"></i></span>所：${data.lucky.spot}</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-palette"></i></span>色：${data.lucky.color}</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-person"></i></span>人：${data.lucky.person}</div>
                `;
            }
            luckyArea.appendChild(lBox);

            const uBox = document.createElement('div');
            uBox.className = 'unlucky-box accent-border';
            if (data.unlucky) {
                uBox.innerHTML = `
                    <div class="lucky-title accent-text red-text" style="color:red">不運・注意</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-exclamation-triangle"></i></span>物：${data.unlucky.item}</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-x-octagon"></i></span>所：${data.unlucky.spot}</div>
                    <div class="lucky-row accent-text"><span class="lucky-icon"><i class="bi bi-person-x"></i></span>人：${data.unlucky.person}</div>
                `;
            }
            luckyArea.appendChild(uBox);
            outer.appendChild(luckyArea);

            // 8. フッター (日時・名前・QR)
            if (withFooter) {
                const footer = document.createElement('div');
                footer.className = 'result-footer-info accent-border';
                
                const metaDiv = document.createElement('div');
                metaDiv.style.textAlign = 'left';
                
                const name = data.username || "参拝者";
                const date = new Date(data.timestamp || Date.now());
                const dateStr = `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日 ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;

                metaDiv.innerHTML = `
                    <div class="result-user-name accent-text">${name} 様の運勢</div>
                    <div class="result-date accent-text">参拝日: ${dateStr}</div>
                `;

                const qrDiv = document.createElement('div');
                qrDiv.className = 'result-qr-container';
                const qrTarget = document.createElement('div');
                qrDiv.appendChild(qrTarget);
                
                footer.appendChild(metaDiv);
                footer.appendChild(qrDiv);
                outer.appendChild(footer);

                setTimeout(() => {
                    new QRCode(qrTarget, {
                        text: SITE_URL,
                        width: 60,
                        height: 60,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                }, 100);
            }
        }

        // --- 履歴・おみくじの轍 ---
        async function loadHistory() {
            const list = document.getElementById('history-list');
            const container = document.getElementById('history-container');
            const overlay = document.getElementById('history-login-overlay');
            const viewMode = document.getElementById('history-view-mode');
            const myCountEl = document.getElementById('personal-history-count');
            const globalCountEl = document.getElementById('global-history-count');

            list.innerHTML = '';

            if(!currentState.user) {
                container.classList.add('history-blurred');
                overlay.classList.remove('hidden');
                viewMode.textContent = "";
                myCountEl.textContent = "-";
                globalCountEl.textContent = "-";

                let html = '';
                for(let i=0; i<10; i++) {
                    html += `
                        <div class="bg-gray-50 dark:bg-zinc-800 p-3 rounded flex justify-between items-center border-l-4 border-gray-300">
                            <div class="flex flex-col">
                                <span class="text-xs themed-text-sub">??? 様</span>
                                <span class="text-xs text-gray-400">----/--/--</span>
                            </div>
                            <span class="font-bold text-lg">???</span>
                        </div>
                    `;
                }
                list.innerHTML = html;
                return;
            }

            container.classList.remove('history-blurred');
            overlay.classList.add('hidden');
            viewMode.textContent = "全参拝者の記録 (全期間)";
            list.innerHTML = '<p class="text-center text-sm themed-text-sub">読み込み中...</p>';
            showLoading(true);

            try {
                const res = await fetch(`${API_BASE}/api/history/global?token=${encodeURIComponent(currentState.user.token)}`);
                if(res.ok) {
                    const data = await res.json();
                    globalHistory = data.global || [];
                    personalHistory = data.personal || [];
                    
                    myCountEl.textContent = personalHistory.length + "回";
                    globalCountEl.textContent = globalHistory.length + "回";

                    list.innerHTML = '';
                    if(globalHistory.length === 0) {
                        list.innerHTML = '<p class="text-gray-400 text-center">まだ履歴がありません。</p>';
                        return;
                    }

                    globalHistory.forEach((item, index) => {
                        const div = document.createElement('div');
                        const isMe = item.username === currentState.user.username;
                        const borderColor = item.result.includes('凶') ? 'border-gray-500' : 'border-red-500';
                        const bgClass = isMe ? 'bg-red-50 dark:bg-red-900/20' : 'bg-gray-50 dark:bg-zinc-800';

                        div.className = `${bgClass} p-3 rounded flex justify-between items-center border-l-4 ${borderColor} cursor-pointer hover:opacity-80 transition shadow-sm`;
                        
                        // 修正: クリックで詳細ページ(結果画面)へ遷移
                        div.onclick = () => {
                            showResultDetail(false, item);
                            updateURL(item);
                        }; 

                        const date = new Date(item.timestamp);
                        const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                        
                        div.innerHTML = `
                            <div class="flex flex-col text-left">
                                <span class="text-xs font-bold ${isMe ? 'text-red-600' : 'themed-text-sub'}">${item.username} 様</span>
                                <span class="text-xs text-gray-400">${dateStr}</span>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="font-bold text-red-700 dark:text-red-400 text-lg w-16 text-right">${item.result}</span>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                } else {
                    list.innerHTML = '<p class="text-center text-red-500">取得失敗</p>';
                }
            } catch(e) {
                console.error(e);
                list.innerHTML = '<p class="text-center text-red-500">通信エラー</p>';
            } finally {
                showLoading(false);
            }
        }

        function closeHistoryDetail(e) {
            if(e && e.target.id !== 'history-detail-modal' && e.target.tagName !== 'BUTTON') return;
            document.getElementById('history-detail-modal').style.display = 'none';
        }

        // --- シェア用画像生成 (UI崩れ修正版) ---
        function generateResultImage() {
            const status = document.getElementById('gen-img-status');
            status.textContent = "シェア画像を生成中...フォント読み込み待機";
            
            const target = document.getElementById('result-capture-container');
            const container = document.getElementById('generated-image-container');
            container.innerHTML = '';
            container.classList.add('hidden');
            
            // フォント読み込み完了を待つ
            document.fonts.ready.then(() => {
                const originalScrollPos = window.scrollY;

                // キャプチャ設定
                html2canvas(target, { 
                    scale: 3, // 高解像度化
                    useCORS: true, 
                    allowTaint: true,
                    backgroundColor: null, 
                    scrollX: 0,
                    scrollY: -window.scrollY, 
                    onclone: (clonedDoc) => {
                        const clonedOuter = clonedDoc.getElementById('result-card-outer');
                        if (clonedOuter) {
                            // 縦書きハック: CSSで強制的に指定し直す
                            const verticals = clonedOuter.querySelectorAll('.result-poem-vertical, .result-advice-box, .detail-column');
                            verticals.forEach(el => {
                                el.style.letterSpacing = '0.1em'; 
                                el.style.lineHeight = '1.6';
                                el.style.fontFamily = "'Zen Old Mincho', serif"; 
                            });
                            clonedOuter.style.height = 'auto';
                            clonedOuter.style.minHeight = '1200px'; 
                            clonedOuter.style.transform = 'none'; 
                        }
                    }
                }).then(canvas => {
                    status.textContent = "";
                    
                    container.innerHTML = '<p class="text-green-600 font-bold mb-2">画像の生成完了</p>';
                    
                    // 生成された画像をBlob化して共有用に保持
                    canvas.toBlob(blob => {
                        currentState.lastImageBlob = blob;
                        const url = URL.createObjectURL(blob);
                        
                        const img = document.createElement('img');
                        img.src = url;
                        img.className = "mx-auto rounded border w-32 mb-2 shadow-sm"; 
                        container.appendChild(img);
                        container.classList.remove('hidden');

                        const dlLink = document.createElement('a');
                        dlLink.href = url;
                        dlLink.download = `tenmei_omikuji_${Date.now()}.png`;
                        dlLink.className = "btn-primary text-sm mt-2 inline-block";
                        dlLink.innerHTML = '<i class="bi bi-download"></i> ダウンロード';
                        container.appendChild(dlLink);
                    }, 'image/png');

                    window.scrollTo(0, originalScrollPos);

                }).catch(err => {
                    console.error(err);
                    status.textContent = "画像の生成に失敗しました。再試行してください。";
                    window.scrollTo(0, originalScrollPos);
                });
            });
        }

        function getShareUrl() {
            if(!currentState.lastResult) return SITE_URL;
            // 現在のURLパラメータを含んだURLを返す
            return window.location.href;
        }

        // --- シェアアクション (Web Share API優先) ---
        async function shareToX() {
            if(!currentState.lastResult) return;
            const res = currentState.lastResult;
            const userName = res.username || "参拝者"; 
            
            // X (Twitter) の文字数制限に合わせて短縮
            const text = `⛩️ 運勢・天命乃杜 ⛩️
${userName}様の運勢：【 ${res.type} 】

『${res.poem}』

開運：${res.lucky.item}・${res.lucky.color}

#天命乃杜 #おみくじ #運勢`;

            const url = getShareUrl();

            // Web Share API (画像添付) トライ
            if (navigator.share && currentState.lastImageBlob) {
                try {
                    const file = new File([currentState.lastImageBlob], "omikuji.png", { type: "image/png" });
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            text: text,
                            url: url, 
                            files: [file]
                        });
                        return; // 成功したら終了
                    }
                } catch (e) {
                    console.log("Web Share API failed, falling back to Intent", e);
                }
            }

            // フォールバック: Twitter Intent (画像添付不可)
            const intent = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
            window.open(intent, '_blank');
        }

        function shareToFB() {
            const url = getShareUrl();
            const intent = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
            window.open(intent, '_blank');
        }
        
        async function shareToLine() {
            const url = getShareUrl();
            const res = currentState.lastResult;
            const text = `${res.username}の運勢：${res.type}\n${url}`;
            
            // LINEもWeb Share APIを試みる
             if (navigator.share && currentState.lastImageBlob) {
                try {
                    const file = new File([currentState.lastImageBlob], "omikuji.png", { type: "image/png" });
                    await navigator.share({
                        text: text,
                        files: [file]
                    });
                    return;
                } catch(e) {}
            }

            const intent = `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
            window.open(intent, '_blank');
        }

        // --- プロフィール機能 ---
        function handleProfileClick() {
            if(currentState.user) {
                showView('profile');
                document.getElementById('profile-current-username').textContent = currentState.user.username;
                document.getElementById('profile-current-email').textContent = currentState.user.email;
            } else {
                showView('auth');
            }
        }

        async function updateProfile() {
            const newName = document.getElementById('profile-new-username').value;
            const newPass = document.getElementById('profile-new-password').value;
            
            if(!newName && !newPass) return alert("変更内容を入力してください");
            
            showLoading(true);
            try {
                const res = await fetch(`${API_BASE}/api/user/update`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        token: currentState.user.token,
                        email: currentState.user.email,
                        newUsername: newName || undefined,
                        newPassword: newPass || undefined
                    })
                });
                const data = await res.json();
                if(data.success) {
                    alert("更新しました");
                    if(newName) currentState.user.username = newName;
                    localStorage.setItem('omikuji_user', JSON.stringify(currentState.user));
                    handleProfileClick();
                } else {
                    alert("更新失敗: " + data.error);
                }
            } catch(e) { alert("通信エラー"); }
            finally { showLoading(false); }
        }

        async function deleteAccount() {
            if(!confirm("本当にアカウントを削除しますか？\n履歴やお気に入りデータも完全に消去されます。")) return;
            
            showLoading(true);
            try {
                const res = await fetch(`${API_BASE}/api/user/delete`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        token: currentState.user.token,
                        email: currentState.user.email
                    })
                });
                const data = await res.json();
                if(data.success) {
                    alert("アカウントを削除しました。ご利用ありがとうございました。");
                    logout();
                } else {
                    alert("削除失敗: " + data.error);
                }
            } catch(e) { 
                console.error(e);
                alert("通信エラーが発生しました。"); 
            }
            finally { showLoading(false); }
        }

        // --- 認証系 ---
        function startAuthFlow(mode) {
            document.getElementById('auth-selection').classList.add('hidden');
            document.getElementById('auth-step-1').classList.remove('hidden');
            
            currentState.authMode = mode;
            
            const loginFields = document.getElementById('form-login-fields');
            const regFields = document.getElementById('form-register-fields');
            const title = document.getElementById('auth-form-title');

            if (mode === 'login') {
                loginFields.classList.remove('hidden');
                regFields.classList.add('hidden');
                title.textContent = 'ログイン';
            } else {
                loginFields.classList.add('hidden');
                regFields.classList.remove('hidden');
                title.textContent = '新規登録';
            }
        }

        function backToAuthSelection() {
            document.getElementById('auth-step-1').classList.add('hidden');
            document.getElementById('auth-selection').classList.remove('hidden');
        }

        async function initiateAuth(mode) {
            const emailInputId = (mode === 'login') ? 'login-email' : 'reg-email';
            const email = document.getElementById(emailInputId).value;
            const username = document.getElementById('reg-username').value;
            const pass = document.getElementById(mode === 'login' ? 'login-password' : 'reg-password').value;

            if(!email || !pass) return alert("メールアドレスとパスワードを入力してください");
            if(mode === 'register' && !username) return alert("ユーザー名を入力してください");

            // 擬似的にコード送信APIを叩く
            showLoading(true);
            try {
                const res = await fetch(`${API_BASE}/api/auth/send`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email, username: mode === 'register' ? username : undefined }) 
                });
                const data = await res.json();
                
                if(res.ok && data.success) {
                    // ステップ2へ遷移
                    document.getElementById('auth-step-1').classList.add('hidden');
                    document.getElementById('auth-step-2').classList.remove('hidden');
                    // コード入力欄リセット
                    document.querySelectorAll('.auth-digit-input').forEach(el => el.value = '');
                    document.getElementById('digit1').focus();
                } else {
                    alert(`送信エラー: ${data.error || '不明なエラー'}`);
                }
            } catch(e) { alert("通信エラー"); }
            finally { showLoading(false); }
        }

        function backToAuthStep1() {
            document.getElementById('auth-step-2').classList.add('hidden');
            document.getElementById('auth-step-1').classList.remove('hidden');
        }

        // 入力欄移動
        function moveToNext(el, nextId) {
            if (el.value.length === 1 && nextId) {
                document.getElementById(nextId).focus();
            }
        }

        async function finalizeAuth() {
            let code = "";
            for(let i=1; i<=6; i++) {
                code += document.getElementById(`digit${i}`).value;
            }
            if(code.length !== 6) return alert("6桁の認証コードを入力してください");

            const mode = currentState.authMode;
            const email = document.getElementById(mode === 'login' ? 'login-email' : 'reg-email').value;
            const pass = document.getElementById(mode === 'login' ? 'login-password' : 'reg-password').value;
            const username = document.getElementById('reg-username').value;

            showLoading(true);
            try {
                const endpoint = (mode === 'login') ? '/api/auth/login' : '/api/auth/register';
                const body = { email, password: pass, code };
                if (mode === 'register') body.username = username;

                const res = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                
                if(res.ok && data.success) {
                    loginSuccess({ email, username: data.username, token: data.token });
                } else {
                    alert(`${mode === 'login' ? 'ログイン' : '登録'}失敗: ${data.message || data.error}`);
                }
            } catch(e) { alert("通信エラー"); }
            finally { showLoading(false); }
        }

        function loginSuccess(user) {
            currentState.user = user;
            localStorage.setItem('omikuji_user', JSON.stringify(user));
            updateAuthUI();
            loadFavorites(); 
            
            if(currentState.view === 'lab') {
                showView('lab');
            }
            
            alert(`ようこそ、${user.username || user.email} 様！`);
            showView('home');
        }

        function updateAuthUI() {
            const badge = document.getElementById('fav-status-badge');
            const navBtn = document.getElementById('nav-login-btn');
            
            if(currentState.user) {
                navBtn.innerHTML = `<i class="bi bi-person-check-fill text-green-400"></i><span class="nav-text">会員: ${currentState.user.username}</span>`;
                if(badge) badge.textContent = "クラウド保存済み";
            } else {
                navBtn.innerHTML = `<i class="bi bi-person-circle"></i><span class="nav-text">ログイン/登録</span>`;
                if(badge) badge.textContent = "端末に保存中";
            }
        }
        
        function logout() {
            localStorage.removeItem('omikuji_user');
            currentState.user = null;
            location.reload();
        }

        // 12星座ロジック (被らないように修正)
        function generateDailyRanking(dateStr) {
            let combinations = [];
            zodiacSigns.forEach(sign => { bloodTypes.forEach(blood => { combinations.push({ sign, blood }); }); });
            const rng = new SeededRandom(dateStr);
            
            // 重複しないようにシャッフルリストを作成 (48通り以上用意)
            let shuffledItems = [];
            let shuffledColors = [];
            while(shuffledItems.length < combinations.length) shuffledItems = shuffledItems.concat(zodiacItemsList);
            while(shuffledColors.length < combinations.length) shuffledColors = shuffledColors.concat(zodiacColorsList);
            
            // 完全にランダムにするため十分シャッフル
            for(let k=0; k<3; k++) { // 念入りにシャッフル
                for (let i = shuffledItems.length - 1; i > 0; i--) {
                    const j = Math.floor(rng.next() * (i + 1));
                    [shuffledItems[i], shuffledItems[j]] = [shuffledItems[j], shuffledItems[i]];
                }
                for (let i = shuffledColors.length - 1; i > 0; i--) {
                    const j = Math.floor(rng.next() * (i + 1));
                    [shuffledColors[i], shuffledColors[j]] = [shuffledColors[j], shuffledColors[i]];
                }
            }

            let scoredData = combinations.map((item, index) => {
                const baseScore = Math.floor(rng.next() * 60) + 40; 
                const loveScore = Math.floor(rng.next() * 60) + 40;
                const moneyScore = Math.floor(rng.next() * 60) + 40;
                const workScore = Math.floor(rng.next() * 60) + 40;
                const totalScoreRaw = (baseScore + loveScore + moneyScore + workScore) / 4;
                const totalScore = Math.min(100, Math.floor(totalScoreRaw));

                const p1 = descPartsStart[Math.floor(rng.next() * descPartsStart.length)];
                const p2 = descPartsSection2[Math.floor(rng.next() * descPartsSection2.length)];
                const p3 = descPartsSection3[Math.floor(rng.next() * descPartsSection3.length)];
                const p4 = descPartsEnd[Math.floor(rng.next() * descPartsEnd.length)];
                const longDesc = `${p1}${p2} ${p3}${p4}`;

                return {
                    sign: item.sign,
                    blood: item.blood,
                    totalScore: totalScore,
                    love: { score: loveScore, desc: loveShorts[Math.floor(rng.next() * loveShorts.length)] },
                    money: { score: moneyScore, desc: moneyShorts[Math.floor(rng.next() * moneyShorts.length)] },
                    work: { score: workScore, desc: workShorts[Math.floor(rng.next() * workShorts.length)] },
                    luckyNum: Math.floor(rng.next() * 9) + 1,
                    item: shuffledItems[index],
                    color: shuffledColors[index],
                    longDesc: longDesc
                };
            });
            scoredData.sort((a, b) => b.totalScore - a.totalScore);
            scoredData.forEach((d, i) => d.rank = i + 1);
            
            // 順位付け (同率処理簡易版)
            scoredData.forEach(d => {
                const sorted = [...scoredData].sort((a, b) => b.love.score - a.love.score);
                d.love.rank = sorted.findIndex(s => s === d) + 1;
                const sortedM = [...scoredData].sort((a, b) => b.money.score - a.money.score);
                d.money.rank = sortedM.findIndex(s => s === d) + 1;
                const sortedW = [...scoredData].sort((a, b) => b.work.score - a.work.score);
                d.work.rank = sortedW.findIndex(s => s === d) + 1;
            });
            scoredData.forEach(person => { person.calendar = calculateFutureLuck(person.sign.id, person.blood, dateStr); });
            dailyRanking = scoredData;
        }
        function calculateFutureLuck(signId, bloodType, baseDateStr) {
            let calendarDays = [];
            for(let i=0; i<30; i++) {
                const targetDate = getFutureDateString(baseDateStr, i);
                const dayOfMonth = new Date(targetDate).getDate();
                const rng = new SeededRandom(targetDate);
                let dayScores = [];
                zodiacSigns.forEach(s => {
                    bloodTypes.forEach(b => {
                        const bScore = Math.floor(rng.next() * 60) + 40;
                        const lScore = Math.floor(rng.next() * 60) + 40;
                        const mScore = Math.floor(rng.next() * 60) + 40;
                        const wScore = Math.floor(rng.next() * 60) + 40;
                        const tScore = Math.floor((bScore + lScore + mScore + wScore) / 4);
                        dayScores.push({ s: s.id, b: b, t: tScore, l: lScore, m: mScore, w: wScore });
                    });
                });
                const me = dayScores.find(d => d.s === signId && d.b === bloodType);
                let marks = [];
                if (me.t >= Math.max(...dayScores.map(d => d.t))) marks.push('<i class="bi bi-star-fill text-yellow-500"></i>');
                if (me.l >= Math.max(...dayScores.map(d => d.l))) marks.push('<i class="bi bi-heart-fill text-pink-500"></i>');
                if (me.m >= Math.max(...dayScores.map(d => d.m))) marks.push('<i class="bi bi-currency-yen text-yellow-600"></i>');
                if (me.w >= Math.max(...dayScores.map(d => d.w))) marks.push('<i class="bi bi-pencil-fill text-blue-500"></i>');
                calendarDays.push({ day: dayOfMonth, marks: marks });
            }
            return calendarDays;
        }
        function createCardHTML(data) {
            const isFav = favoriteList.some(f => f.sign === data.sign.id && f.blood === data.blood);
            const rankClass = data.rank <= 3 ? `rank-${data.rank}` : 'rank-other';
            const borderClass = data.rank <= 3 ? 'border-l-4 border-yellow-400' : '';
            const getBarColor = (score) => score > 80 ? '#ef4444' : (score > 50 ? '#eab308' : '#3b82f6');
            return `
                <div class="ranking-card ${borderClass} themed-card">
                    <button class="fav-btn ${isFav ? 'active' : ''}" onclick="toggleFavorite('${data.sign.id}', '${data.blood}')">
                        <i class="bi bi-star${isFav ? '-fill' : ''}"></i>
                    </button>
                    <div class="flex items-start">
                        <div class="rank-badge-lg ${rankClass}">${data.rank}</div>
                        <div class="ml-4 flex-grow">
                            <div class="flex items-center flex-wrap gap-2 mb-1">
                                <span class="text-3xl">${data.sign.icon}</span>
                                <span class="font-bold text-xl" style="color:var(--text-main);">${data.sign.name}</span>
                                <span class="bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded text-sm font-bold" style="color:var(--text-main);">${data.blood}型</span>
                            </div>
                            <div class="flex items-center gap-4 text-sm mt-1 mb-2" style="color: var(--text-sub);">
                                <span><i class="bi bi-hash"></i> ラッキーナンバー: <strong>${data.luckyNum}</strong></span>
                                <span><i class="bi bi-bar-chart-fill"></i> 総合: <strong>${data.totalScore}点</strong></span>
                            </div>
                            <p class="text-sm leading-relaxed mb-3 text-justify" style="color: var(--text-main); line-height:1.8;">${data.longDesc}</p>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs mb-3" style="color: var(--text-sub);">
                                <div><i class="bi bi-stars text-yellow-500"></i> ラッキーアイテム: ${data.item}</div>
                                <div><i class="bi bi-palette text-pink-500"></i> ラッキーカラー: ${data.color}</div>
                            </div>
                        </div>
                    </div>
                    <div class="param-grid">
                        <div class="param-item">
                            <div class="param-label"><i class="bi bi-heart-fill text-pink-500"></i> 恋愛 (${data.love.rank}位)</div>
                            <div class="param-score-text">${data.love.score}点</div>
                            <div class="param-value text-xs">${data.love.desc}</div>
                            <div class="score-bar-bg"><div class="score-bar-fill" style="width:${data.love.score}%; background:${getBarColor(data.love.score)};"></div></div>
                        </div>
                        <div class="param-item">
                            <div class="param-label"><i class="bi bi-currency-yen text-yellow-500"></i> 金運 (${data.money.rank}位)</div>
                            <div class="param-score-text">${data.money.score}点</div>
                            <div class="param-value text-xs">${data.money.desc}</div>
                            <div class="score-bar-bg"><div class="score-bar-fill" style="width:${data.money.score}%; background:${getBarColor(data.money.score)};"></div></div>
                        </div>
                        <div class="param-item">
                            <div class="param-label"><i class="bi bi-book-fill text-blue-500"></i> 仕事/勉強 (${data.work.rank}位)</div>
                            <div class="param-score-text">${data.work.score}点</div>
                            <div class="param-value text-xs">${data.work.desc}</div>
                            <div class="score-bar-bg"><div class="score-bar-fill" style="width:${data.work.score}%; background:${getBarColor(data.work.score)};"></div></div>
                        </div>
                    </div>
                    <div class="calendar-wrapper">
                        <p class="text-xs text-center mb-1 font-bold" style="color:var(--text-main);">向こう30日間のラッキーデー</p>
                        <div class="calendar-grid">
                            ${data.calendar.map(d => `<div class="calendar-cell"><span class="cal-date">${d.day}</span><span class="cal-mark">${d.marks.join('')}</span></div>`).join('')}
                        </div>
                        <div class="calendar-legend">
                            <span class="legend-item"><i class="bi bi-star-fill text-yellow-500"></i>総合1位</span>
                            <span class="legend-item"><i class="bi bi-heart-fill text-pink-500"></i>恋愛1位</span>
                            <span class="legend-item"><i class="bi bi-currency-yen text-yellow-600"></i>金運1位</span>
                            <span class="legend-item"><i class="bi bi-pencil-fill text-blue-500"></i>勉強1位</span>
                        </div>
                    </div>
                </div>
            `;
        }
        function toggleFavorite(signId, bloodType) {
            const existsIndex = favoriteList.findIndex(f => f.sign === signId && f.blood === bloodType);
            if (existsIndex >= 0) { favoriteList.splice(existsIndex, 1); } 
            else { if (favoriteList.length >= 5) return alert('最大5つまで'); favoriteList.push({ sign: signId, blood: bloodType }); }
            if(currentState.user) {
                fetch(`${API_BASE}/api/favorites`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email:currentState.user.email, token:currentState.user.token, favorites:favoriteList}) });
            } else { localStorage.setItem('fortuneFavorites', JSON.stringify(favoriteList)); }
            renderFavorites();
        }
        function renderFavorites() {
            const container = document.getElementById('favorites-list');
            const section = document.getElementById('favorites-section');
            container.innerHTML = '';
            if (favoriteList.length === 0) { section.classList.add('hidden'); return; }
            section.classList.remove('hidden');
            favoriteList.forEach(fav => {
                const data = dailyRanking.find(d => d.sign.id === fav.sign && d.blood === fav.blood);
                if (data) container.innerHTML += createCardHTML(data);
            });
        }
        function renderRanking() {
            const listContainer = document.getElementById('ranking-list');
            const fullListContainer = document.getElementById('full-ranking-list');
            listContainer.innerHTML = ''; fullListContainer.innerHTML = '';
            dailyRanking.forEach((data, index) => {
                const html = createCardHTML(data);
                if (index < 3) listContainer.insertAdjacentHTML('beforeend', html);
                else fullListContainer.insertAdjacentHTML('beforeend', html);
            });
        }
        function showFullRanking() {
            const fullList = document.getElementById('full-ranking-list');
            const txt = document.getElementById('show-ranking-text');
            if (fullList.classList.contains('hidden')) { fullList.classList.remove('hidden'); txt.textContent = "ランキングを閉じる"; }
            else { fullList.classList.add('hidden'); txt.textContent = "4位以下を見る"; }
        }
        function findMyRank() {
            const signId = document.getElementById('user-sign').value;
            const bloodId = document.getElementById('user-blood').value;
            const resultDiv = document.getElementById('my-rank-result');
            const myData = dailyRanking.find(d => d.sign.id === signId && d.blood === bloodId);
            if (myData) { resultDiv.innerHTML = createCardHTML(myData); resultDiv.classList.remove('hidden'); }
        }
    </script>
</body>
</html>
